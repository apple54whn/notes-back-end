<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>多表操作 | conanan&#39;s blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/img/favicon.ico">
    <script data-ad-client="ca-pub-7828333725993554" async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="web前端技术博客,简洁至上,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    <link rel="preload" href="/assets/css/0.styles.03260d1f.css" as="style"><link rel="preload" href="/assets/js/app.ac5e3ef4.js" as="script"><link rel="preload" href="/assets/js/2.d960b235.js" as="script"><link rel="preload" href="/assets/js/51.f4a8b763.js" as="script"><link rel="prefetch" href="/assets/js/10.949143aa.js"><link rel="prefetch" href="/assets/js/100.122fb3a2.js"><link rel="prefetch" href="/assets/js/101.88060c8d.js"><link rel="prefetch" href="/assets/js/102.06832b28.js"><link rel="prefetch" href="/assets/js/103.a0c17aef.js"><link rel="prefetch" href="/assets/js/104.b38ef641.js"><link rel="prefetch" href="/assets/js/105.603033e4.js"><link rel="prefetch" href="/assets/js/106.6b288074.js"><link rel="prefetch" href="/assets/js/107.1ffec4c0.js"><link rel="prefetch" href="/assets/js/108.c7b79afa.js"><link rel="prefetch" href="/assets/js/109.dda9fbee.js"><link rel="prefetch" href="/assets/js/11.326a1f58.js"><link rel="prefetch" href="/assets/js/110.920cbe6e.js"><link rel="prefetch" href="/assets/js/111.45bfe7f2.js"><link rel="prefetch" href="/assets/js/112.1f11c570.js"><link rel="prefetch" href="/assets/js/113.fab1cc04.js"><link rel="prefetch" href="/assets/js/114.21ea4ed6.js"><link rel="prefetch" href="/assets/js/115.96f65264.js"><link rel="prefetch" href="/assets/js/116.b324c49b.js"><link rel="prefetch" href="/assets/js/117.dc4d308c.js"><link rel="prefetch" href="/assets/js/118.8f152d6d.js"><link rel="prefetch" href="/assets/js/119.ede5fffc.js"><link rel="prefetch" href="/assets/js/12.23122444.js"><link rel="prefetch" href="/assets/js/120.044161d7.js"><link rel="prefetch" href="/assets/js/121.453c745a.js"><link rel="prefetch" href="/assets/js/122.e3b088eb.js"><link rel="prefetch" href="/assets/js/123.d5a90d16.js"><link rel="prefetch" href="/assets/js/124.7731d89c.js"><link rel="prefetch" href="/assets/js/125.e64126c4.js"><link rel="prefetch" href="/assets/js/126.e46361b1.js"><link rel="prefetch" href="/assets/js/127.067ae046.js"><link rel="prefetch" href="/assets/js/128.59df2a2f.js"><link rel="prefetch" href="/assets/js/129.a2b82230.js"><link rel="prefetch" href="/assets/js/13.6780e0cd.js"><link rel="prefetch" href="/assets/js/130.c20833b9.js"><link rel="prefetch" href="/assets/js/131.da020742.js"><link rel="prefetch" href="/assets/js/132.e20ac455.js"><link rel="prefetch" href="/assets/js/133.f114b097.js"><link rel="prefetch" href="/assets/js/134.49de9e80.js"><link rel="prefetch" href="/assets/js/135.1a24633f.js"><link rel="prefetch" href="/assets/js/136.d5853212.js"><link rel="prefetch" href="/assets/js/137.3a1020dd.js"><link rel="prefetch" href="/assets/js/138.f194f86d.js"><link rel="prefetch" href="/assets/js/139.bf8c1ca0.js"><link rel="prefetch" href="/assets/js/14.08edf279.js"><link rel="prefetch" href="/assets/js/140.c800f5e0.js"><link rel="prefetch" href="/assets/js/141.47afa8e4.js"><link rel="prefetch" href="/assets/js/142.fda2db61.js"><link rel="prefetch" href="/assets/js/143.0224a2e5.js"><link rel="prefetch" href="/assets/js/144.4126fe8d.js"><link rel="prefetch" href="/assets/js/145.9fe0839a.js"><link rel="prefetch" href="/assets/js/146.89a9e1b2.js"><link rel="prefetch" href="/assets/js/147.56419b8e.js"><link rel="prefetch" href="/assets/js/148.03d2b50f.js"><link rel="prefetch" href="/assets/js/149.c1331b6d.js"><link rel="prefetch" href="/assets/js/15.f198e5b9.js"><link rel="prefetch" href="/assets/js/16.00e51c93.js"><link rel="prefetch" href="/assets/js/17.291d3ebc.js"><link rel="prefetch" href="/assets/js/18.017a098e.js"><link rel="prefetch" href="/assets/js/19.61ae84a4.js"><link rel="prefetch" href="/assets/js/20.2fed9841.js"><link rel="prefetch" href="/assets/js/21.0540e3f5.js"><link rel="prefetch" href="/assets/js/22.65f1eb05.js"><link rel="prefetch" href="/assets/js/23.fd9e2f2e.js"><link rel="prefetch" href="/assets/js/24.199ad75b.js"><link rel="prefetch" href="/assets/js/25.005a23bb.js"><link rel="prefetch" href="/assets/js/26.46587fdd.js"><link rel="prefetch" href="/assets/js/27.eaf61373.js"><link rel="prefetch" href="/assets/js/28.12bcc1aa.js"><link rel="prefetch" href="/assets/js/29.2ee78c15.js"><link rel="prefetch" href="/assets/js/3.aae4de15.js"><link rel="prefetch" href="/assets/js/30.5a13fad2.js"><link rel="prefetch" href="/assets/js/31.d559ae93.js"><link rel="prefetch" href="/assets/js/32.d5a38545.js"><link rel="prefetch" href="/assets/js/33.484dfc49.js"><link rel="prefetch" href="/assets/js/34.1a006a06.js"><link rel="prefetch" href="/assets/js/35.12b84d1e.js"><link rel="prefetch" href="/assets/js/36.b2cd4408.js"><link rel="prefetch" href="/assets/js/37.a5859cb8.js"><link rel="prefetch" href="/assets/js/38.96209f1d.js"><link rel="prefetch" href="/assets/js/39.71d70a82.js"><link rel="prefetch" href="/assets/js/4.0e4cf147.js"><link rel="prefetch" href="/assets/js/40.a59b859c.js"><link rel="prefetch" href="/assets/js/41.ebb72a6a.js"><link rel="prefetch" href="/assets/js/42.71f99aa2.js"><link rel="prefetch" href="/assets/js/43.092ff2c9.js"><link rel="prefetch" href="/assets/js/44.d70e216f.js"><link rel="prefetch" href="/assets/js/45.afb733d1.js"><link rel="prefetch" href="/assets/js/46.86c421f9.js"><link rel="prefetch" href="/assets/js/47.6d337ef6.js"><link rel="prefetch" href="/assets/js/48.157e1f1c.js"><link rel="prefetch" href="/assets/js/49.1aed4add.js"><link rel="prefetch" href="/assets/js/5.831f36ca.js"><link rel="prefetch" href="/assets/js/50.b495cbac.js"><link rel="prefetch" href="/assets/js/52.beec293d.js"><link rel="prefetch" href="/assets/js/53.2ac4d785.js"><link rel="prefetch" href="/assets/js/54.342112cf.js"><link rel="prefetch" href="/assets/js/55.61e2bfb6.js"><link rel="prefetch" href="/assets/js/56.fa782548.js"><link rel="prefetch" href="/assets/js/57.41bc249e.js"><link rel="prefetch" href="/assets/js/58.c1d5fafb.js"><link rel="prefetch" href="/assets/js/59.4297a34f.js"><link rel="prefetch" href="/assets/js/6.54e4e793.js"><link rel="prefetch" href="/assets/js/60.634948c3.js"><link rel="prefetch" href="/assets/js/61.de4327e7.js"><link rel="prefetch" href="/assets/js/62.c6902476.js"><link rel="prefetch" href="/assets/js/63.737a0e11.js"><link rel="prefetch" href="/assets/js/64.cbe1b041.js"><link rel="prefetch" href="/assets/js/65.2df8f108.js"><link rel="prefetch" href="/assets/js/66.ee7de747.js"><link rel="prefetch" href="/assets/js/67.88edee59.js"><link rel="prefetch" href="/assets/js/68.c29f5efe.js"><link rel="prefetch" href="/assets/js/69.2fedc1f9.js"><link rel="prefetch" href="/assets/js/7.1c00f39e.js"><link rel="prefetch" href="/assets/js/70.0fe4782b.js"><link rel="prefetch" href="/assets/js/71.6c22c273.js"><link rel="prefetch" href="/assets/js/72.1fc7ddbd.js"><link rel="prefetch" href="/assets/js/73.25cb42eb.js"><link rel="prefetch" href="/assets/js/74.e922e1cc.js"><link rel="prefetch" href="/assets/js/75.f48393b6.js"><link rel="prefetch" href="/assets/js/76.72e96818.js"><link rel="prefetch" href="/assets/js/77.3df4edcb.js"><link rel="prefetch" href="/assets/js/78.73c6a652.js"><link rel="prefetch" href="/assets/js/79.22ba589c.js"><link rel="prefetch" href="/assets/js/8.b5f907d4.js"><link rel="prefetch" href="/assets/js/80.2d070db4.js"><link rel="prefetch" href="/assets/js/81.c0bc2539.js"><link rel="prefetch" href="/assets/js/82.4c6a47fa.js"><link rel="prefetch" href="/assets/js/83.a43f597f.js"><link rel="prefetch" href="/assets/js/84.8ce525d0.js"><link rel="prefetch" href="/assets/js/85.6b21aae0.js"><link rel="prefetch" href="/assets/js/86.f6ebabd9.js"><link rel="prefetch" href="/assets/js/87.9acaeb0d.js"><link rel="prefetch" href="/assets/js/88.99cdf592.js"><link rel="prefetch" href="/assets/js/89.58f63450.js"><link rel="prefetch" href="/assets/js/9.053d267f.js"><link rel="prefetch" href="/assets/js/90.1d59f40c.js"><link rel="prefetch" href="/assets/js/91.e8b2a5cd.js"><link rel="prefetch" href="/assets/js/92.b92bba74.js"><link rel="prefetch" href="/assets/js/93.688cad95.js"><link rel="prefetch" href="/assets/js/94.2c11a588.js"><link rel="prefetch" href="/assets/js/95.aa37d1df.js"><link rel="prefetch" href="/assets/js/96.fffa0e6e.js"><link rel="prefetch" href="/assets/js/97.04e9be9f.js"><link rel="prefetch" href="/assets/js/98.2672abca.js"><link rel="prefetch" href="/assets/js/99.c8de1c63.js">
    <link rel="stylesheet" href="/assets/css/0.styles.03260d1f.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/EB-logo.png" alt="conanan's blog" class="logo"> <span class="site-name can-hide">conanan's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/pages/4b56bd/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/4b56bd/" class="nav-link">Java</a></li><li class="dropdown-item"><!----> <a href="/pages/724936/" class="nav-link">Java Web</a></li><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/b18d09/" class="nav-link">Maven</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="DataBase" class="dropdown-title"><a href="/pages/74cdda/" class="link-title">DataBase</a> <span class="title" style="display:none;">DataBase</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/74cdda/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/pages/4e9f47/" class="nav-link">Redis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tool" class="dropdown-title"><a href="/pages/89d1e7/" class="link-title">Tool</a> <span class="title" style="display:none;">Tool</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/89d1e7/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/2029ba/" class="nav-link">Vim</a></li><li class="dropdown-item"><!----> <a href="/pages/2029ba/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/f2d5fb/" class="nav-link">Docker</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/xugaoyi/image_store/blog/20200103123203.jpg"> <div class="blogger-info"><h3>Evan Xu</h3> <span>前端界的小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><a href="/pages/4b56bd/" class="link-title">Java</a> <span class="title" style="display:none;">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/4b56bd/" class="nav-link">Java</a></li><li class="dropdown-item"><!----> <a href="/pages/724936/" class="nav-link">Java Web</a></li><li class="dropdown-item"><h4>工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/b18d09/" class="nav-link">Maven</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="DataBase" class="dropdown-title"><a href="/pages/74cdda/" class="link-title">DataBase</a> <span class="title" style="display:none;">DataBase</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/74cdda/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/pages/4e9f47/" class="nav-link">Redis</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tool" class="dropdown-title"><a href="/pages/89d1e7/" class="link-title">Tool</a> <span class="title" style="display:none;">Tool</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/89d1e7/" class="nav-link">Git</a></li><li class="dropdown-item"><!----> <a href="/pages/2029ba/" class="nav-link">Vim</a></li><li class="dropdown-item"><!----> <a href="/pages/2029ba/" class="nav-link">Nginx</a></li><li class="dropdown-item"><!----> <a href="/pages/f2d5fb/" class="nav-link">Docker</a></li></ul></div></div> <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Jakarta EE</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tomcat</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringMVC</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringBoot</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>SpringDataJPA</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/9e29b0/" class="sidebar-link">JPA基础</a></li><li><a href="/pages/5427c0/" class="sidebar-link">总览入门</a></li><li><a href="/pages/a40e65/" class="sidebar-link">基础操作</a></li><li><a href="/pages/26ad8c/" aria-current="page" class="active sidebar-link">多表操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/26ad8c/#一对一" class="sidebar-link">一对一</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/26ad8c/#jpa-协议-🔥" class="sidebar-link">JPA 协议 🔥</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#案例介绍" class="sidebar-link">案例介绍</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#单向关联" class="sidebar-link">单向关联</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#双向关联" class="sidebar-link">双向关联</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#onetoone-源码解读" class="sidebar-link">OneToOne 源码解读</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#mappedby-注意事项-🔥" class="sidebar-link">mappedBy 注意事项 🔥</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#cascadetype用法" class="sidebar-link">CascadeType用法</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#orphanremoval-属性用法" class="sidebar-link">orphanRemoval 属性用法</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#主键和外键都是同一个字段" class="sidebar-link">主键和外键都是同一个字段</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#onetoone-延迟加载，我们只需要-id-值" class="sidebar-link">@OneToOne 延迟加载，我们只需要 ID 值</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#onetoone-的最佳实践" class="sidebar-link">@OneToOne 的最佳实践</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#joincloumns-joincolumn" class="sidebar-link">@JoinCloumns &amp; JoinColumn</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#一对多" class="sidebar-link">一对多</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/26ad8c/#jpa-协议-🔥-2" class="sidebar-link">JPA 协议 🔥</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#案例介绍-2" class="sidebar-link">案例介绍</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#分析步骤" class="sidebar-link">分析步骤</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#onetomany-manytoone" class="sidebar-link">@OneToMany &amp; @ManyToOne</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#实战：保存" class="sidebar-link">实战：保存</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#问题分析" class="sidebar-link">问题分析</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#改进：主表放弃外键维护" class="sidebar-link">改进：主表放弃外键维护</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#实战：级联-☠️" class="sidebar-link">实战：级联 ☠️</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#最佳实践-🔥" class="sidebar-link">最佳实践 🔥</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#多对多" class="sidebar-link">多对多</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/26ad8c/#案例介绍-3" class="sidebar-link">案例介绍</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#分析步骤-2" class="sidebar-link">分析步骤</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#manytomany-实战-🔥" class="sidebar-link">@ManyToMany 实战 🔥</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#manytomany-实战：级联-☠️" class="sidebar-link">@ManyToMany 实战：级联 ☠️</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#manytoone-和-onetomany-表示-🔥" class="sidebar-link">@ManyToOne 和 @OneToMany 表示 🔥</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#多对多的最佳实践-🔥" class="sidebar-link">多对多的最佳实践 🔥</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#对象导航查询-🔥" class="sidebar-link">对象导航查询 🔥</a></li><li class="sidebar-sub-header"><a href="/pages/26ad8c/#未整理" class="sidebar-link">未整理</a></li></ul></li><li><a href="/pages/544a0d/" class="sidebar-link">审计功能</a></li><li><a href="/pages/044c3c/" class="sidebar-link">JPA示例（旧）</a></li></ul></section></li><li><a href="/pages/927e76/" class="sidebar-link">Test</a></li><li><a href="/pages/2ffe27/" class="sidebar-link">Shiro</a></li><li><a href="/pages/16f81e/" class="sidebar-link">Thymeleaf</a></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="3508773082"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-1cd794fe><div class="articleInfo" data-v-1cd794fe><ul class="breadcrumbs" data-v-1cd794fe><li data-v-1cd794fe><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-1cd794fe></a></li> <li data-v-1cd794fe><a href="/categories/?category=Java%20Web" title="分类" data-v-1cd794fe>Java Web</a></li> <li data-v-1cd794fe><a href="/categories/?category=SpringDataJPA" title="分类" data-v-1cd794fe>SpringDataJPA</a></li> <!----></ul> <div class="info" data-v-1cd794fe><div title="作者" class="author iconfont icon-touxiang" data-v-1cd794fe><a href="https://github.com/apple54whn" target="_blank" title="作者" class="beLink" data-v-1cd794fe>conanan</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-1cd794fe><a href="javascript:;" data-v-1cd794fe>2021-06-21</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">
          多表操作
        </h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
     <ins class="adsbygoogle"
          style="display:inline-block;width:100%;max-height:90px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6625304284"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="theme-vdoing-content content__default"><h1 id="多表操作"><a href="#多表操作" class="header-anchor">#</a> 多表操作</h1> <h2 id="一对一"><a href="#一对一" class="header-anchor">#</a> 一对一</h2> <h3 id="jpa-协议-🔥"><a href="#jpa-协议-🔥" class="header-anchor">#</a> JPA 协议 🔥</h3> <p><code>@OneToOne</code> 一般表示对象之间一对一的关联关系，它可以放在 field 上面，也可以放在 get/set 方法上面。</p> <ul><li>如果是配置<strong>双向关联</strong>，<strong>维护关联关系的是拥有外键的一方</strong>，而<strong>另一方必须配置 mappedBy</strong></li> <li>如果是单项关联，直接配置在<strong>拥有外键的一方</strong>即可。</li></ul> <h3 id="案例介绍"><a href="#案例介绍" class="header-anchor">#</a> 案例介绍</h3> <p>举个例子：user 表是用户的主信息，user_info 是用户的扩展信息，两者之间是一对一的关系。</p> <h3 id="单向关联"><a href="#单向关联" class="header-anchor">#</a> 单向关联</h3> <p>user_info 表里面有一个 user_id 作为关联关系的外键，如果是单项关联，我们的写法如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Id</span>
   <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy<span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>AUTO<span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> sex<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>User 实体里面什么都没变化，不需要添加 @OneToOne 注解。我们只需要在拥有外键的一方配置就可以，所以 UserInfo 的代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@ToString</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfo</span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Id</span>
   <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy<span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>AUTO<span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> ages<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> telephone<span class="token punctuation">;</span>
   <span class="token annotation punctuation">@OneToOne</span> <span class="token comment">//维护user的外键关联关系，配置一对一</span>
   <span class="token keyword">private</span> <span class="token class-name">User</span> user<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>我们看到，UserInfo 实体对象里面添加了 @OneToOne 注解，这时我们写一个测试用例跑一下看看有什么效果：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> address <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> email <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sex <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> user_info <span class="token punctuation">(</span>id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> ages <span class="token keyword">integer</span><span class="token punctuation">,</span> telephone <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user_id <span class="token keyword">bigint</span><span class="token punctuation">,</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> user_info <span class="token keyword">add</span> <span class="token keyword">constraint</span> FKn8pl63y4abe7n0ls6topbqjh2 <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token keyword">references</span> <span class="token keyword">user</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>因为我们新建了两个实体，跑任何一个 @SpringDataTest 就会看到上面有三个 sql 在执行，分别创建了两张表，而在 user_info 表上面还创建了一个外键索引。</p> <h3 id="双向关联"><a href="#双向关联" class="header-anchor">#</a> 双向关联</h3> <p>我们保持 UserInfo 不变，在 User 实体对象里面添加这一段代码即可。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@OneToOne</span><span class="token punctuation">(</span>mappedBy <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">UserInfo</span> userInfo<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>完整的 User 实体对象就会变成如下模样。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Id</span>
   <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy<span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>AUTO<span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>
   <span class="token annotation punctuation">@OneToOne</span><span class="token punctuation">(</span>mappedBy <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">UserInfo</span> userInfo<span class="token punctuation">;</span><span class="token comment">//变化之处</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> sex<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>我们跑任何一个测试用例，就会看到运行结果是一样的，还是上面三条 sql。那么我们再查看一下 @OneToOne 源码，看看其支持的配置都有哪些。</p> <h3 id="onetoone-源码解读"><a href="#onetoone-源码解读" class="header-anchor">#</a> OneToOne 源码解读</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">OneToOne</span> <span class="token punctuation">{</span>
    <span class="token comment">//表示关系目标实体，默认该注解标识的返回值的类型的类。</span>
    <span class="token class-name">Class</span> <span class="token function">targetEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token comment">//cascade 级联操作策略，就是我们常说的级联操作</span>
    <span class="token class-name">CascadeType</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">cascade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//数据获取方式EAGER(立即加载)/LAZY(延迟加载)</span>
    <span class="token class-name">FetchType</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> EAGER<span class="token punctuation">;</span>
    <span class="token comment">//是否允许为空，默认是可选的，也就表示可以为空；</span>
    <span class="token keyword">boolean</span> <span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">//关联关系被谁维护的一方对象里面的属性名字。 双向关联的时候必填</span>
    <span class="token class-name">String</span> <span class="token function">mappedBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//当被标识的字段发生删除或者置空操作之后，是否同步到关联关系的一方，即进行通过删除操作，默认flase，注意与CascadeType.REMOVE 级联删除的区别</span>
    <span class="token keyword">boolean</span> <span class="token function">orphanRemoval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="mappedby-注意事项-🔥"><a href="#mappedby-注意事项-🔥" class="header-anchor">#</a> mappedBy 注意事项 🔥</h3> <p>只有关联关系的<strong>维护方</strong>才能<strong>操作两个实体之间外键</strong>的关系。<strong>被维护方即使设置了维护方属性进行存储也不会更新外键关联</strong>。</p> <p>mappedBy 不能与 @JoinColumn 或者 @JoinTable 同时使用，因为没有意义，关联关系不在这里面维护。</p> <p>此外，<strong>mappedBy 的值</strong>是指<strong>另一方的实体里面属性的字段</strong>，而不是数据库字段，也不是实体的对象的名字。也就是维护关联关系的一方属性字段名称，<strong>或者加了 @JoinColumn / @JoinTable 注解的属性字段名称</strong>。如上面的 User 例子 user 里面 mappedBy 的值，就是 UserInfo 里面的 user 字段的名字。</p> <h3 id="cascadetype用法"><a href="#cascadetype用法" class="header-anchor">#</a> CascadeType用法</h3> <p>在 CascadeType 的用法中，CascadeType 的枚举值只有五个，分别如下：</p> <ol><li>CascadeType.PERSIST 级联新建</li> <li>CascadeType.REMOVE 级联删除</li> <li>CascadeType.REFRESH 级联刷新</li> <li>CascadeType.MERGE 级联更新</li> <li>CascadeType.ALL 四项全选</li></ol> <p>其中，默认是没有级联操作的，关系表不会产生任何影响。此外，JPA 2.0 还新增了 CascadeType.DETACH，即级联实体到 Detach 状态。</p> <p>了解了枚举值，下面我们来测试一下级联新建和级联删除。</p> <p>首先，修改 UserInfo 里面的关键代码如下，并在 @OneToOne 上面添加</p> <p><code>cascade ={CascadeType.PERSIST,CascadeType.REMOVE}</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DataJpaTest</span>
<span class="token comment">// DataJpaTest、MybatisTest 会默认使用其测试数据源替代，若要使用自己配置的，需要添加如下注解</span>
<span class="token annotation punctuation">@AutoConfigureTestDatabase</span><span class="token punctuation">(</span>replace <span class="token operator">=</span> <span class="token class-name">AutoConfigureTestDatabase<span class="token punctuation">.</span>Replace</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">One2OneTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserInfoRepository</span> userInfoRepository<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Test</span>
    <span class="token annotation punctuation">@Rollback</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testUserRelationships</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;jackxx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token string">&quot;123456@126.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserInfo</span> userInfo <span class="token operator">=</span> <span class="token class-name">UserInfo</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ages</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">telephone</span><span class="token punctuation">(</span><span class="token string">&quot;12345678&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//保存userInfo的同上也会保存User信息</span>
        userInfoRepository<span class="token punctuation">.</span><span class="token function">saveAndFlush</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//删除userInfo，同时也会级联的删除user记录</span>
        userInfoRepository<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>最后，运行一下看看效果。</p> <p><img src="/assets/img/CgqCHl9xtbmAP4vcAAEKnyVM6Ig708.f8618bfc.png" alt="img"></p> <p>上面的测试在执行了 insert 的时候，会执行两条 insert 的sql 和两条 delete 的 sql，这就体现出了 CascadeType.PERSIST 和 CascadeType.REMOVE 的作用。</p> <p>上面讲了<strong>级联删除</strong>的场景，下面我们再说一下<strong>关联关系的删除场景</strong>该怎么做。</p> <h3 id="orphanremoval-属性用法"><a href="#orphanremoval-属性用法" class="header-anchor">#</a> orphanRemoval 属性用法</h3> <p><strong>orphanRemoval 表示当关联关系被删除</strong>的时候，<strong>是否应用级联删除</strong>，默认 false。什么意思呢？测试一下你就会明白。</p> <p>首先，还沿用上面的例子，当我们删除 userInfo 的时候，把 User 置空，作如下改动。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>userInfo<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userInfoRepository<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>其次，我们再运行测试，看看效果。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>delete from user_info where id=?
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这时候你就会发现，少了一条删除 user 的 sql，说明没有进行级联删除。那我们再把 UserInfo 做一下调整。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfo</span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@OneToOne</span><span class="token punctuation">(</span>cascade <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">CascadeType</span><span class="token punctuation">.</span>PERSIST<span class="token punctuation">}</span><span class="token punctuation">,</span>orphanRemoval <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">User</span> user<span class="token punctuation">;</span>
   <span class="token comment">//....其他没变的代码省了</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后，我们把 CascadeType.Remove 删除了，不让它进行级联删除，但是我们把 orphanRemoval 设置成 true，即当关联关系变化的时候级联更新。我们看下完整的测试用例。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testUserRelationships</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;jackxx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token string">&quot;123456@126.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserInfo</span> userInfo <span class="token operator">=</span> <span class="token class-name">UserInfo</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ages</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">telephone</span><span class="token punctuation">(</span><span class="token string">&quot;12345678&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userInfoRepository<span class="token punctuation">.</span><span class="token function">saveAndFlush</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        userInfo<span class="token punctuation">.</span><span class="token function">setAges</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userInfo<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//还是通过这个设置user数据为空</span>
        userInfoRepository<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这个时候我们看一下运行结果。</p> <p><img src="/assets/img/CgqCHl9xthOAHALuAAFaT_9YXuM848.ffc9dfcd.png" alt="img"></p> <p>可以看到，结果依然是两个 inser 和两个 delete，但是中间多了一个 update。我来解释一下，因为去掉了 CascadeType.REMOVE，这个时候不会进行级联删除了。当我们把 user 对象更新成空的时候，就会执行一条 update 语句把关联关系去掉了。</p> <p>而为什么又出现了级联删除 user 呢？因为我们修改了集合关联关系，orphanRemoval 设置为 true，所以又执行了级联删除的操作。这一点你可以仔细体会一下 orphanRemoval 和 CascadeType.REMOVE 的区别。</p> <p>到这里，@OneToOne 关联关系介绍完了，接下来我们看一下日常工作常见的场景，先看场景一：主键和外键都是同一个字段的情况。</p> <h3 id="主键和外键都是同一个字段"><a href="#主键和外键都是同一个字段" class="header-anchor">#</a> 主键和外键都是同一个字段</h3> <p>我们假设 user 表是主表，user_info 的主键是 user_id，并且 user_id=user 表里面的 id，那我们应该怎么写？</p> <p>继续沿用上面的例子，User 实体不变，我们看看 UserInfo 变成什么样了。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfo</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Id</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> ages<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> telephone<span class="token punctuation">;</span>
   <span class="token annotation punctuation">@MapsId</span>
   <span class="token annotation punctuation">@OneToOne</span><span class="token punctuation">(</span>cascade <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">CascadeType</span><span class="token punctuation">.</span>PERSIST<span class="token punctuation">}</span><span class="token punctuation">,</span>orphanRemoval <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">User</span> user<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这里的做法很简单，我们直接把 userId 设置为主键，在 @OneToOne 上面添加 @MapsId 注解即可。<strong>@MapsId 注解的作用是把关联关系实体里面的 ID（默认）值 copy 到 @MapsId 标注的字段上面</strong>（这里指的是 user_id 字段）。</p> <p>接着，上面的测试用例我们跑一下，看一下效果。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> address <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> email <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sex <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> user_info <span class="token punctuation">(</span>ages <span class="token keyword">integer</span><span class="token punctuation">,</span> telephone <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user_id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> user_info <span class="token keyword">add</span> <span class="token keyword">constraint</span> FKn8pl63y4abe7n0ls6topbqjh2 <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token keyword">references</span> <span class="token keyword">user</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在启动的时候，我们直接创建了 user 表和 user_info 表，其中 user_info 的主键是 user_id，并且通过外键关联到了 user 表的 ID 字段，那么我们同时看一下 inser 的 sql，也发生了变化。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>address<span class="token punctuation">,</span> email<span class="token punctuation">,</span> name<span class="token punctuation">,</span> sex<span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> user_info <span class="token punctuation">(</span>ages<span class="token punctuation">,</span> telephone<span class="token punctuation">,</span> user_id<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>上面就是我们讲的实战场景一，主键和外键都是同一个字段。接下来我们再说一个场景，就是在查 user_info 的时候，我们只想知道 user_id 的值就行了，不需要查 user 的其他信息，具体我们应该怎么做呢？</p> <h3 id="onetoone-延迟加载，我们只需要-id-值"><a href="#onetoone-延迟加载，我们只需要-id-值" class="header-anchor">#</a> @OneToOne 延迟加载，我们只需要 ID 值</h3> <p>在 @OneToOne 延迟加载的情况下，我们假设只想查下 user_id，而不想查看 user 表其他的信息，因为当前用不到，可以有以下几种做法。</p> <p>第一种做法：还是 User 实体不变，我们改一下 UserInfo 对象，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@ToString</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfo</span><span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Id</span>
   <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy<span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>AUTO<span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">Integer</span> ages<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token class-name">String</span> telephone<span class="token punctuation">;</span>
   <span class="token annotation punctuation">@MapsId</span>
   <span class="token annotation punctuation">@OneToOne</span><span class="token punctuation">(</span>cascade <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">CascadeType</span><span class="token punctuation">.</span>PERSIST<span class="token punctuation">}</span><span class="token punctuation">,</span>orphanRemoval <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span>LAZY<span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">User</span> user<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>从上面这段代码中，可以看到做的更改如下：</p> <ul><li>id 字段我们先用原来的</li> <li>@OneToOne 上面我们添加 @MapsId 注解</li> <li>@OneToOne 里面的 fetch = FetchType.LAZY 设置延迟加载（默认）</li></ul> <p>接着，我们改造一下测试类，完整代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DataJpaTest</span>
<span class="token annotation punctuation">@TestInstance</span><span class="token punctuation">(</span><span class="token class-name">TestInstance<span class="token punctuation">.</span>Lifecycle</span><span class="token punctuation">.</span>PER_CLASS<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoRepositoryTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserInfoRepository</span> userInfoRepository<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@BeforeAll</span>
    <span class="token annotation punctuation">@Rollback</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;jackxx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token string">&quot;123456@126.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserInfo</span> userInfo <span class="token operator">=</span> <span class="token class-name">UserInfo</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ages</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">telephone</span><span class="token punctuation">(</span><span class="token string">&quot;12345678&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userInfoRepository<span class="token punctuation">.</span><span class="token function">saveAndFlush</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 测试用User关联关系操作
     *
     * @throws JsonProcessingException
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token annotation punctuation">@Rollback</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testUserRelationships</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">UserInfo</span> userInfo1 <span class="token operator">=</span> userInfoRepository<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userInfo1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userInfo1<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>然后，我们跑一下测试用例，看看测试结果。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>address<span class="token punctuation">,</span> email<span class="token punctuation">,</span> name<span class="token punctuation">,</span> sex<span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>address<span class="token punctuation">,</span> email<span class="token punctuation">,</span> name<span class="token punctuation">,</span> sex<span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>

<span class="token comment">-- 两条inser照旧，而只有一个select</span>
<span class="token keyword">select</span> userinfo0_<span class="token punctuation">.</span>user_id <span class="token keyword">as</span> user_id3_6_0_<span class="token punctuation">,</span> userinfo0_<span class="token punctuation">.</span>ages <span class="token keyword">as</span> ages1_6_0_<span class="token punctuation">,</span> userinfo0_<span class="token punctuation">.</span>telephone <span class="token keyword">as</span> telephon2_6_0_ <span class="token keyword">from</span> user_info userinfo0_ <span class="token keyword">where</span> userinfo0_<span class="token punctuation">.</span>user_id<span class="token operator">=</span>?
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>最后你会发现，打印的结果符合预期。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>UserInfo(id=1, ages=12, telephone=12345678)
1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>接下来介绍第二种做法，这种做法很简单，只要在 UserInfo 对象里面直接去掉 @OneToOne 关联关系，新增下面的字段即可。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;user_id&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这就没有关联关系了</p> <p>第三做法是利用 Hibernate，它给我们提供了一种字节码增强技术，通过编译器改变 class 解决了延迟加载问题。这种方式有点复杂，需要在编译器引入 hibernateEnhance 的相关 jar 包，以及编译器需要改变 class 文件并添加 lazy 代理来解决延迟加载。我不太推荐这种方式，因为太复杂，你知道有这回事就行了。</p> <p>以上我们掌握了这么多用法，那么最佳实践是什么？双向关联更好还是单向关联更好？根据最近几年的应用，我总结出了一些最佳实践，我们来看一下。</p> <h3 id="onetoone-的最佳实践"><a href="#onetoone-的最佳实践" class="header-anchor">#</a> @OneToOne 的最佳实践</h3> <p><strong>第一，我要说一种 Java 面向对象的设计原则：开闭原则。</strong></p> <p>即对扩展开放，对修改关闭。<strong>如果我们一直使用双向关联，两个实体的对象耦合太严重了</strong>。想象一下，随着业务的发展，User 对象可能是原始对象，<strong>围绕着 User 可能会扩展出各种关联对象</strong>。<strong>难道 User 里面每次都要修改，去添加双向关联关系吗</strong>？肯定不是，否则时间长了，对象与对象之间的关联关系就是一团乱麻。</p> <p>所以，我们<strong>尽量、甚至不要用双向关联，如果非要用关联关系的话，只用单向关联就够了</strong>。双向关联正是 JPA 的强大之处，但同时也是问题最多，最被人诟病之处。所以我们要用它的优点，而不是学会了就一定要使用。</p> <p><strong>第二，我想说 CascadeType 很强大，但是我也建议保持默认。</strong></p> <p>即没有级联更新动作，没有级联删除动作。还有 orphanRemoval 也要尽量保持默认 false，不做级联删除。因为这两个功能很强大，但是我个人觉得这违背了面向对象设计原则里面的“职责单一原则”，除非你非常非常熟悉，否则你在用的时候会时常感到惊讶——数据什么时间被更新了？数据被谁删除了？遇到这种问题查起来非常麻烦，因为是框架处理，有的时候并非预期的效果。</p> <p>一旦生产数据被莫名更新或者删除，那是一件非常糟糕的事情。因为这些级联操作会使你的方法名字没办法命名，而且它不是跟着业务逻辑变化的，而是跟着实体变化的，这就会使方法和对象的职责不单一。</p> <p><strong>第三，我想告诉你，所有用到关联关系的地方，能用 Lazy 的绝对不要用 EAGER，否则会有 SQL 性能问题，会出现不是预期的 SQL。</strong></p> <p>以上三点是我总结的避坑指南，有经验的同学这时候会有个疑问：外键约束不是不推荐使用的吗？如果我的外键字段名不是约定的怎么办？别着急，我们再看一下 @JoinColumn 注解和 @JoinColumns 注解。</p> <h3 id="joincloumns-joincolumn"><a href="#joincloumns-joincolumn" class="header-anchor">#</a> @JoinCloumns &amp; JoinColumn</h3> <p>这两个注解是集合关系，他们可以同时使用，@JoinColumn 表示单字段，@JoinCloumns 表示多个 @JoinColumn，我们来一一看一下。</p> <p>我们还是先直接看一下 @JoinColumn 源码，了解下这一注解都有哪些配置项。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">JoinColumn</span> <span class="token punctuation">{</span>
    <span class="token comment">//关键的字段名,默认注解上的字段名，在@OneToOne代表本表的外键字段名字；</span>
    <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//与name相反关联对象的字段，默认主键字段</span>
    <span class="token class-name">String</span> <span class="token function">referencedColumnName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">//外键字段是否唯一</span>
    <span class="token keyword">boolean</span> <span class="token function">unique</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">//外键字段是否允许为空</span>
    <span class="token keyword">boolean</span> <span class="token function">nullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">//是否跟随一起新增</span>
    <span class="token keyword">boolean</span> <span class="token function">insertable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">//是否跟随一起更新</span>
    <span class="token keyword">boolean</span> <span class="token function">updatable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">//JPA2.1新增，外键策略</span>
    <span class="token class-name">ForeignKey</span> <span class="token function">foreignKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token annotation punctuation">@ForeignKey</span><span class="token punctuation">(</span>PROVIDER_DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>其次，我们看一下 @ForeignKey(PROVIDER_DEFAULT) 里面枚举值有几个。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ConstraintMode</span> <span class="token punctuation">{</span>
    <span class="token comment">//创建外键约束</span>
   CONSTRAINT<span class="token punctuation">,</span>
    <span class="token comment">//不创建外键约束</span>
   NO_CONSTRAINT<span class="token punctuation">,</span>
   <span class="token comment">//采用默认行为</span>
   PROVIDER_DEFAULT
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>然后，我们看看这个注解的语法，就可以解答我们上面的两个问题。修改一下 UserInfo，如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfo</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy<span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>AUTO<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> ages<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> telephone<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@OneToOne</span><span class="token punctuation">(</span>cascade <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">CascadeType</span><span class="token punctuation">.</span>PERSIST<span class="token punctuation">}</span><span class="token punctuation">,</span>orphanRemoval <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span>LAZY<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>foreignKey <span class="token operator">=</span> <span class="token annotation punctuation">@ForeignKey</span><span class="token punctuation">(</span><span class="token class-name">ConstraintMode</span><span class="token punctuation">.</span>NO_CONSTRAINT<span class="token punctuation">)</span><span class="token punctuation">,</span>name <span class="token operator">=</span> <span class="token string">&quot;my_user_id&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">User</span> user<span class="token punctuation">;</span>
    <span class="token comment">//...其他不变</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>可以看到，我们在其中指定了字段的名字：my_user_id，并且指定 NO_CONSTRAINT 不生成外键。而测试用例不变，我们看下运行结果。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">user</span> <span class="token punctuation">(</span>id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> address <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> email <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sex <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> user_info <span class="token punctuation">(</span>id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> ages <span class="token keyword">integer</span><span class="token punctuation">,</span> telephone <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> my_user_id <span class="token keyword">bigint</span><span class="token punctuation">,</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这时我们看到 user_info 表里面新增了一个字段 my_user_id，insert 的时候也能正确 inser my_user_id 的值等于 user.id。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> user_info <span class="token punctuation">(</span>ages<span class="token punctuation">,</span> telephone<span class="token punctuation">,</span> my_user_id<span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>而 @JoinColumns 是 JoinColumns 的复数形式，就是通过两个字段进行的外键关联，这个不常用，我们看一个 demo 了解一下就好。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompanyOffice</span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@ManyToOne</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span>LAZY<span class="token punctuation">)</span>
   <span class="token annotation punctuation">@JoinColumns</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
         <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;ADDR_ID&quot;</span><span class="token punctuation">,</span> referencedColumnName<span class="token operator">=</span><span class="token string">&quot;ID&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;ADDR_ZIP&quot;</span><span class="token punctuation">,</span> referencedColumnName<span class="token operator">=</span><span class="token string">&quot;ZIP&quot;</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token keyword">private</span> <span class="token class-name">Address</span> address<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>上面的实例中，CompanyOffice 通过 ADDR_ID 和 ADDR_ZIP 两个字段对应一条 address 信息，解释了一下@JoinColumns的用法。</p> <p>如果你了解了 @OneToOne 的详细用法，后面要讲的几个注解就很好理解了，因为他们有点类似，那么我们接下来看看 @ManyToOne 和 @OneToMany 的用法。</p> <h2 id="一对多"><a href="#一对多" class="header-anchor">#</a> 一对多</h2> <h3 id="jpa-协议-🔥-2"><a href="#jpa-协议-🔥-2" class="header-anchor">#</a> JPA 协议 🔥</h3> <ul><li><strong>维护关联关系的是拥有外键的一方，而另一方必须配置 <code>mappedBy</code></strong></li></ul> <h3 id="案例介绍-2"><a href="#案例介绍-2" class="header-anchor">#</a> 案例介绍</h3> <p>客户和联系人的案例（注意，客户和联系人是属于同一公司的）</p> <ul><li>客户：买了商品的一家公司</li> <li>联系人：买了商品的这家公司的员工（可有多个）</li></ul> <p>一对多关系，一个客户可以具有多个联系人，一个联系人从属于一家公司</p> <h3 id="分析步骤"><a href="#分析步骤" class="header-anchor">#</a> 分析步骤</h3> <ol><li><p>明确表关系：一对多关系</p></li> <li><p>确定表关系（外键）</p> <ul><li><strong>主表</strong>：客户表</li> <li><strong>从表</strong>：联系人表，在从表添加<strong>外键</strong></li></ul></li> <li><p>编写实体类，再实体类中描述表关系（<strong>组合</strong>）</p> <ul><li>客户：再客户的实体类中包含一个联系人的集合</li> <li>联系人：在联系人的实体类中包含一个客户的对象</li></ul></li> <li><p>配置映射关系</p> <ul><li>使用 <strong>JPA 注解配置一对多映射关系</strong></li></ul></li></ol> <h3 id="onetomany-manytoone"><a href="#onetomany-manytoone" class="header-anchor">#</a> @OneToMany &amp; @ManyToOne</h3> <p>@ManyToOne 代表多对一的关联关系，而 @OneToMany 代表一对多，一般两个成对使用表示双向关联关系。而 JPA 协议中也是明确规定：<strong>维护关联关系的是拥有外键的一方（从表），而另一方（主表）必须配置 mappedBy</strong>。体会不到看下面的实战及问题分析即可明了。</p> <p>看下面的源码。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">ManyToOne</span> <span class="token punctuation">{</span>

    <span class="token class-name">Class</span> <span class="token function">targetEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>

    <span class="token class-name">CascadeType</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">cascade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">FetchType</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> EAGER<span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

 <span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">OneToMany</span> <span class="token punctuation">{</span>

    <span class="token class-name">Class</span> <span class="token function">targetEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token keyword">void</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>

 	<span class="token comment">//cascade 级联操作策略：(CascadeType.PERSIST、CascadeType.REMOVE、CascadeType.REFRESH、CascadeType.MERGE、CascadeType.ALL) 如果不填，默认关系表不会产生任何影响。</span>
    <span class="token class-name">CascadeType</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">cascade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">//数据获取方式EAGER(立即加载)/LAZY(延迟加载)</span>
    <span class="token class-name">FetchType</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> LAZY<span class="token punctuation">;</span>

    <span class="token comment">//关系被谁维护，单项的。注意：只有关系维护方才能操作两者的关系。</span>
    <span class="token class-name">String</span> <span class="token function">mappedBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

	<span class="token comment">//是否级联删除。和CascadeType.REMOVE的效果一样。两种配置了一个就会自动级联删除</span>
    <span class="token keyword">boolean</span> <span class="token function">orphanRemoval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>我们看到上面的字段和 @OneToOne 里面的基本一样，用法是一样的，不过需要注意以下几点：</p> <ol><li>@ManyToOne 一定是维护外键关系的一方，所以没有 mappedBy 字段；</li> <li>@ManyToOne 删除的时候一定不能把 One 的一方删除了，所以也没有 orphanRemoval 的选项；</li> <li>@ManyToOne 的 Lazy 效果和 @OneToOne 的一样，所以和上面的用法基本一致；</li> <li>@OneToMany 的 Lazy 是有效果的。</li></ol> <h3 id="实战：保存"><a href="#实战：保存" class="header-anchor">#</a> 实战：保存</h3> <p>实体类如下，目前配置了<strong>双向关联</strong>（@OneToMany、@ManyToOne），<strong>且主从表都可以维护外键（不推荐）</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{</span>


    <span class="token comment">/* 客户编号（主键）*/</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> <span class="token class-name">Id</span><span class="token punctuation">;</span>

    <span class="token comment">/* 客户名称（公司名称） */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token comment">/* 客户信息来源 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> source<span class="token punctuation">;</span>

    <span class="token comment">/* 客户所属行业 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> industry<span class="token punctuation">;</span>

    <span class="token comment">/* 客户级别 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> level<span class="token punctuation">;</span>

    <span class="token comment">/* 客户联系地址 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>

    <span class="token comment">/* 客户联系电话 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>


    <span class="token comment">// 不推荐的配置，主表没有放弃维护外键</span>
    <span class="token annotation punctuation">@OneToMany</span>
    <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;custId&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LinkMan</span><span class="token punctuation">&gt;</span></span> linkManSet<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkMan</span> <span class="token punctuation">{</span>

    <span class="token comment">/* 联系人编号(主键) */</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token comment">/* 联系人姓名 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token comment">/* 联系人性别 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> gender<span class="token punctuation">;</span>

    <span class="token comment">/* 联系人办公电话 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>

    <span class="token comment">/* 联系人手机 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mobile<span class="token punctuation">;</span>

    <span class="token comment">/* 联系人邮箱 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>

    <span class="token comment">/* 联系人职位 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> position<span class="token punctuation">;</span>

    <span class="token comment">/* 联系人备注 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> remark<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@ManyToOne</span>
    <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;cust_id&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Customer</span> customer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>测试</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DataJpaTest</span>
<span class="token comment">// DataJpaTest、MybatisTest 会默认使用其测试数据源替代，若要使用自己配置的，需要添加如下注解</span>
<span class="token annotation punctuation">@AutoConfigureTestDatabase</span><span class="token punctuation">(</span>replace <span class="token operator">=</span> <span class="token class-name">AutoConfigureTestDatabase<span class="token punctuation">.</span>Replace</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">One2ManyTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">CustomerRepository</span> customerRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LinkManRepository</span> linkManRepository<span class="token punctuation">;</span>


    <span class="token comment">/**
     * 主表放弃维护外键后该方法无法添加外键值
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token annotation punctuation">@Rollback</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">void</span> <span class="token function">testSave</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Customer</span> customer <span class="token operator">=</span> <span class="token class-name">Customer</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;腾讯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">linkManSet</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">LinkMan</span> linkMan <span class="token operator">=</span> <span class="token class-name">LinkMan</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;小马&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 双向关联，主表维护外键</span>
        customer<span class="token punctuation">.</span><span class="token function">getLinkManSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>linkMan<span class="token punctuation">)</span><span class="token punctuation">;</span>

        customerRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>customer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        linkManRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>linkMan<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 保存外键时没有直接 insert 而是2条 insert 后执行了 update！</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 推荐使用的方式
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token annotation punctuation">@Rollback</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">void</span> <span class="token function">testSave2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Customer</span> customer <span class="token operator">=</span> <span class="token class-name">Customer</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;腾讯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">LinkMan</span> linkMan <span class="token operator">=</span> <span class="token class-name">LinkMan</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;小马&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">customer</span><span class="token punctuation">(</span>customer<span class="token punctuation">)</span><span class="token comment">// 双向关联，从表维护外键</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        customerRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>customer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        linkManRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>linkMan<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 保存外键时只用了2条 update！</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h3 id="问题分析"><a href="#问题分析" class="header-anchor">#</a> 问题分析</h3> <p>testSave 自动生成的sql：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> customer <span class="token punctuation">(</span>
	id <span class="token keyword">BIGINT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
	address <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	industry <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">LEVEL</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	NAME <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	phone <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
source <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> id <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> link_man <span class="token punctuation">(</span>
	id <span class="token keyword">BIGINT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
	email <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	gender <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	mobile <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	NAME <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	phone <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	position <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	remark <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
cust_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> id <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span><span class="token punctuation">;</span>

<span class="token comment">-- 外键约束</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> link_man <span class="token keyword">add</span> <span class="token keyword">constraint</span> FKd378jah5xd7bsqjolfsop35i <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>cust_id<span class="token punctuation">)</span> <span class="token keyword">references</span> customer <span class="token punctuation">(</span>id<span class="token punctuation">)</span>

<span class="token comment">-- 保存</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> customer <span class="token punctuation">(</span>address<span class="token punctuation">,</span> industry<span class="token punctuation">,</span> <span class="token keyword">level</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> phone<span class="token punctuation">,</span> source<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> link_man <span class="token punctuation">(</span>cust_id<span class="token punctuation">,</span> email<span class="token punctuation">,</span> gender<span class="token punctuation">,</span> mobile<span class="token punctuation">,</span> name<span class="token punctuation">,</span> phone<span class="token punctuation">,</span> position<span class="token punctuation">,</span> remark<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token keyword">update</span> link_man <span class="token keyword">set</span> cust_id<span class="token operator">=</span>? <span class="token keyword">where</span> id<span class="token operator">=</span>?
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>可见，<strong>目前生成的建表语句竟然有3条</strong>，本应该只有2条！并且保存外键时<strong>没有直接 insert 而是2条 insert 后执行了 update</strong>！</p> <p>因此该方式<strong>不可取</strong>（实际生产中建表可以不用管，但是对于保存操作就不应该用这么多条语句完成！）</p> <p>testSave2 自动生成的sql：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> customer <span class="token punctuation">(</span>
	id <span class="token keyword">BIGINT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
	address <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	industry <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token keyword">LEVEL</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	NAME <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	phone <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
source <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> id <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> link_man <span class="token punctuation">(</span>
	id <span class="token keyword">BIGINT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
	email <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	gender <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	mobile <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	NAME <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	phone <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	position <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
	remark <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
cust_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> id <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">INNODB</span><span class="token punctuation">;</span>

<span class="token comment">-- 外键约束</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> link_man <span class="token keyword">add</span> <span class="token keyword">constraint</span> FKd378jah5xd7bsqjolfsop35i <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>cust_id<span class="token punctuation">)</span> <span class="token keyword">references</span> customer <span class="token punctuation">(</span>id<span class="token punctuation">)</span>

<span class="token comment">-- 保存</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> customer <span class="token punctuation">(</span>address<span class="token punctuation">,</span> industry<span class="token punctuation">,</span> <span class="token keyword">level</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> phone<span class="token punctuation">,</span> source<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> link_man <span class="token punctuation">(</span>cust_id<span class="token punctuation">,</span> email<span class="token punctuation">,</span> gender<span class="token punctuation">,</span> mobile<span class="token punctuation">,</span> name<span class="token punctuation">,</span> phone<span class="token punctuation">,</span> position<span class="token punctuation">,</span> remark<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>可见，<strong>目前生成的建表语句竟然有3条</strong>，本应该只有2条！但是保存外键时<strong>只用了2条 update</strong>！所以推荐！</p> <h3 id="改进：主表放弃外键维护"><a href="#改进：主表放弃外键维护" class="header-anchor">#</a> 改进：主表放弃外键维护</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{</span>


    <span class="token comment">/* 客户编号（主键）*/</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> <span class="token class-name">Id</span><span class="token punctuation">;</span>

    <span class="token comment">/* 客户名称（公司名称） */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token comment">/* 客户信息来源 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> source<span class="token punctuation">;</span>

    <span class="token comment">/* 客户所属行业 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> industry<span class="token punctuation">;</span>

    <span class="token comment">/* 客户级别 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> level<span class="token punctuation">;</span>

    <span class="token comment">/* 客户联系地址 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>

    <span class="token comment">/* 客户联系电话 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>



    <span class="token comment">// 主表应该放弃对外键的维护</span>
    <span class="token comment">// @OneToMany</span>
    <span class="token comment">// @JoinColumn(name = &quot;custId&quot;)</span>
    <span class="token comment">// private Set&lt;LinkMan&gt; linkManSet;</span>

    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>mappedBy <span class="token operator">=</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LinkMan</span><span class="token punctuation">&gt;</span></span> linkManSet<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>其余不变，但是注意测试方法只有testSave2可以添加外键值了！因为只有从表才能维护外键了</p> <h3 id="实战：级联-☠️"><a href="#实战：级联-☠️" class="header-anchor">#</a> 实战：级联 ☠️</h3> <p><strong>删除从表</strong>数据：可以随时任意删除</p> <p><strong>删除主表</strong>数据：</p> <ul><li><p>没有从表数据引用：随便删</p></li> <li><p>有从表数据：</p> <ul><li>在默认情况下，它会把外键字段置为null，然后删除主表数据。如果在数据库的表结构上，外键字段有非空约束，默认情况就会报错了</li> <li>如果配置了放弃维护关联关系的权利，则不能删除（与外键字段是否允许为null，没有关系）因为在删除时，它根本不会去更新从表的外键字段了</li> <li>如果还想删除，使用级联删除引用。在实际开发中，级联删除请慎用！(在一对多的情况下)</li></ul></li></ul> <p><strong>级联</strong>：操作一个对象的同时操作他的关联对象</p> <ul><li>级联操作： 1.需要<strong>区分操作主体</strong> 2.需要在操作主体的实体类上（主表或维护表），添加级联属性<code>cascade</code>（需要添加到多表映射关系的注解上）</li> <li>级联添加，案例：当我保存一个客户的同时保存联系人（在代码中只需保存客户！）</li> <li>级联删除，案例：当我删除一个客户的同时删除此客户的所有联系人，有中间表会先删除中间表（在代码中只需删除客户！）</li> <li>级联更新，略</li></ul> <p><strong>默认是不进行级联操作</strong>，需要在**操作主表配置（一般配置在主表，虽然从表也可以配置）**如下注解：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{</span>


    <span class="token comment">/* 客户编号（主键）*/</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> <span class="token class-name">Id</span><span class="token punctuation">;</span>

    <span class="token comment">/* 客户名称（公司名称） */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token comment">/* 客户信息来源 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> source<span class="token punctuation">;</span>

    <span class="token comment">/* 客户所属行业 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> industry<span class="token punctuation">;</span>

    <span class="token comment">/* 客户级别 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> level<span class="token punctuation">;</span>

    <span class="token comment">/* 客户联系地址 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> address<span class="token punctuation">;</span>

    <span class="token comment">/* 客户联系电话 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>

    <span class="token comment">// 可以单独配置级联保存、删除，还可以配置更新等操作，也可以直接配置全部</span>
    <span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>mappedBy <span class="token operator">=</span> <span class="token string">&quot;customer&quot;</span><span class="token punctuation">,</span> cascade <span class="token operator">=</span><span class="token class-name">CascadeType</span><span class="token punctuation">.</span>ALL<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LinkMan</span><span class="token punctuation">&gt;</span></span> linkManSet<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>测试</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DataJpaTest</span>
<span class="token comment">// DataJpaTest、MybatisTest 会默认使用其测试数据源替代，若要使用自己配置的，需要添加如下注解</span>
<span class="token annotation punctuation">@AutoConfigureTestDatabase</span><span class="token punctuation">(</span>replace <span class="token operator">=</span> <span class="token class-name">AutoConfigureTestDatabase<span class="token punctuation">.</span>Replace</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">One2ManyTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">CustomerRepository</span> customerRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LinkManRepository</span> linkManRepository<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 级联添加，保存一个客户的同时保存联系人
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token annotation punctuation">@Rollback</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">void</span> <span class="token function">testCascadeSave</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Customer</span> customer <span class="token operator">=</span> <span class="token class-name">Customer</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;腾讯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">linkManSet</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">LinkMan</span> linkMan <span class="token operator">=</span> <span class="token class-name">LinkMan</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;小马&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">customer</span><span class="token punctuation">(</span>customer<span class="token punctuation">)</span><span class="token comment">// 双向关联，从表维护外键（这个是维护外键的，和级联没有关系！！！）</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        customer<span class="token punctuation">.</span><span class="token function">getLinkManSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>linkMan<span class="token punctuation">)</span><span class="token punctuation">;</span>

        customerRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>customer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token comment">/**
     * 级联删除，删除一个客户的同时删除此客户的所有联系人。执行删除前记得把 ddl-auto 改为 update
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token annotation punctuation">@Rollback</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">void</span> <span class="token function">testCascadeRemove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        customerRepository<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>级联保存的sql</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>Hibernate: <span class="token keyword">insert</span> <span class="token keyword">into</span> customer <span class="token punctuation">(</span>address<span class="token punctuation">,</span> industry<span class="token punctuation">,</span> <span class="token keyword">level</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> phone<span class="token punctuation">,</span> source<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
Hibernate: <span class="token keyword">insert</span> <span class="token keyword">into</span> link_man <span class="token punctuation">(</span>cust_id<span class="token punctuation">,</span> email<span class="token punctuation">,</span> gender<span class="token punctuation">,</span> mobile<span class="token punctuation">,</span> name<span class="token punctuation">,</span> phone<span class="token punctuation">,</span> position<span class="token punctuation">,</span> remark<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>级联删除的sql</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>Hibernate: <span class="token keyword">select</span> customer0_<span class="token punctuation">.</span>id <span class="token keyword">as</span> id1_1_0_<span class="token punctuation">,</span> customer0_<span class="token punctuation">.</span>address <span class="token keyword">as</span> address2_1_0_<span class="token punctuation">,</span> customer0_<span class="token punctuation">.</span>industry <span class="token keyword">as</span> industry3_1_0_<span class="token punctuation">,</span> customer0_<span class="token punctuation">.</span><span class="token keyword">level</span> <span class="token keyword">as</span> level4_1_0_<span class="token punctuation">,</span> customer0_<span class="token punctuation">.</span>name <span class="token keyword">as</span> name5_1_0_<span class="token punctuation">,</span> customer0_<span class="token punctuation">.</span>phone <span class="token keyword">as</span> phone6_1_0_<span class="token punctuation">,</span> customer0_<span class="token punctuation">.</span>source <span class="token keyword">as</span> source7_1_0_ <span class="token keyword">from</span> customer customer0_ <span class="token keyword">where</span> customer0_<span class="token punctuation">.</span>id<span class="token operator">=</span>?
Hibernate: <span class="token keyword">select</span> linkmanset0_<span class="token punctuation">.</span>cust_id <span class="token keyword">as</span> cust_id9_2_0_<span class="token punctuation">,</span> linkmanset0_<span class="token punctuation">.</span>id <span class="token keyword">as</span> id1_2_0_<span class="token punctuation">,</span> linkmanset0_<span class="token punctuation">.</span>id <span class="token keyword">as</span> id1_2_1_<span class="token punctuation">,</span> linkmanset0_<span class="token punctuation">.</span>cust_id <span class="token keyword">as</span> cust_id9_2_1_<span class="token punctuation">,</span> linkmanset0_<span class="token punctuation">.</span>email <span class="token keyword">as</span> email2_2_1_<span class="token punctuation">,</span> linkmanset0_<span class="token punctuation">.</span>gender <span class="token keyword">as</span> gender3_2_1_<span class="token punctuation">,</span> linkmanset0_<span class="token punctuation">.</span>mobile <span class="token keyword">as</span> mobile4_2_1_<span class="token punctuation">,</span> linkmanset0_<span class="token punctuation">.</span>name <span class="token keyword">as</span> name5_2_1_<span class="token punctuation">,</span> linkmanset0_<span class="token punctuation">.</span>phone <span class="token keyword">as</span> phone6_2_1_<span class="token punctuation">,</span> linkmanset0_<span class="token punctuation">.</span>position <span class="token keyword">as</span> position7_2_1_<span class="token punctuation">,</span> linkmanset0_<span class="token punctuation">.</span>remark <span class="token keyword">as</span> remark8_2_1_ <span class="token keyword">from</span> link_man linkmanset0_ <span class="token keyword">where</span> linkmanset0_<span class="token punctuation">.</span>cust_id<span class="token operator">=</span>?
Hibernate: <span class="token keyword">delete</span> <span class="token keyword">from</span> link_man <span class="token keyword">where</span> id<span class="token operator">=</span>?
Hibernate: <span class="token keyword">delete</span> <span class="token keyword">from</span> customer <span class="token keyword">where</span> id<span class="token operator">=</span>?
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="最佳实践-🔥"><a href="#最佳实践-🔥" class="header-anchor">#</a> 最佳实践 🔥</h3> <p>配置并使用多的一方维护关联关系（外键），保存时直接对外键赋值；配置并使用一的一方维护关联关系，还会执行1条update语句（多余！）。所以 JPA 协议有规定：</p> <ul><li>若配置<strong>单向</strong>关联，关联关系的维护直接**配置在拥有外键的一方（从表）**即可。拉勾课程推荐使用单向关联，不推荐双向关联，主表查询时使用 sql查询。</li> <li>若配置<strong>双向</strong>关联，<strong>维护关联关系的是拥有外键的一方（从表）</strong>，而<strong>另一方（主表）必须配置 mappedBy 放弃外键维护</strong>；</li></ul> <p><strong>尽量避免双向关联，即只用一个注解@ManyToOne</strong>。<a href="http://www.wangzhenhua.rocks/zh-hans/java/jpa-one-to-many-many-to-one-best-practice" target="_blank" rel="noopener noreferrer">JPA中的OneToMany和ManyToOne的最佳实践<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>一切级联更新和 orphanRemoval 都保持默认规则，并且 fetch 采用 lazy 延迟加载（也是默认规则）。</p> <p>注意：<strong>放弃外键维护和级联操作没有半点关系</strong></p> <h2 id="多对多"><a href="#多对多" class="header-anchor">#</a> 多对多</h2> <h3 id="案例介绍-3"><a href="#案例介绍-3" class="header-anchor">#</a> 案例介绍</h3> <p>用户和角色（多对多关系），不用多逼逼了，就是 RBAC 模型</p> <h3 id="分析步骤-2"><a href="#分析步骤-2" class="header-anchor">#</a> 分析步骤</h3> <ol><li><p>明确表关系：一对多关系</p></li> <li><p>确定表关系（中间表）</p></li> <li><p>编写实体类，再实体类中描述表关系（<strong>组合</strong>）</p> <ul><li>用户：包含角色的集合</li> <li>角色：包含用户的集合</li></ul></li> <li><p>配置映射关系</p> <ul><li>使用 <strong>JPA 注解配置一对多映射关系</strong></li></ul></li></ol> <h3 id="manytomany-实战-🔥"><a href="#manytomany-实战-🔥" class="header-anchor">#</a> @ManyToMany 实战 🔥</h3> <p>@ManyToMany 代表多对多的关联关系，这种关联关系<strong>任何一方都可以维护关联关系</strong></p> <p>实际开发者对 @ManyToMany <strong>用得比较少</strong>，一般我们会<strong>用成对的 @ManyToOne 和 @OneToMany 代替</strong>，因为我们的中间表可能还有一些约定的公共字段，如 ID、update_time、create_time等其他字段，当然<strong>要是没有这些字段，可以使用</strong> @ManyToMany</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysUser</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@ManyToMany</span>
    <span class="token annotation punctuation">@JoinTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;sys_user_role&quot;</span><span class="token punctuation">,</span>
            joinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;user_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            inverseJoinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;role_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysRole</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysRole</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> roleId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> roleName<span class="token punctuation">;</span>

    <span class="token comment">// 放弃中间表维护权</span>
    <span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>mappedBy <span class="token operator">=</span> <span class="token string">&quot;roles&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUser</span><span class="token punctuation">&gt;</span></span> users<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SysUserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUser</span><span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">JpaSpecificationExecutor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUser</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SysRoleRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysRole</span><span class="token punctuation">,</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">JpaSpecificationExecutor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysRole</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>测试</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DataJpaTest</span>
<span class="token comment">// DataJpaTest、MybatisTest 会默认使用其测试数据源替代，若要使用自己配置的，需要添加如下注解</span>
<span class="token annotation punctuation">@AutoConfigureTestDatabase</span><span class="token punctuation">(</span>replace <span class="token operator">=</span> <span class="token class-name">AutoConfigureTestDatabase<span class="token punctuation">.</span>Replace</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Many2ManyTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SysUserRepository</span> sysUserRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SysRoleRepository</span> sysRoleRepository<span class="token punctuation">;</span>


    <span class="token comment">/**
     * 保存一个用户、一个角色
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token annotation punctuation">@Rollback</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">void</span> <span class="token function">testSave</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">SysUser</span> sysUser <span class="token operator">=</span> <span class="token class-name">SysUser</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">userName</span><span class="token punctuation">(</span><span class="token string">&quot;conanan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SysRole</span> sysRole <span class="token operator">=</span> <span class="token class-name">SysRole</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roleName</span><span class="token punctuation">(</span><span class="token string">&quot;架构师&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">users</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置用户到角色的关系，可以对中间表进行维护</span>
        sysUser<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sysRole<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置角色到用户的关系，可以对中间表进行维护</span>
        <span class="token comment">// sysRole.getUsers().add(sysUser);</span>
        <span class="token comment">// 但是不能同时维护，因为联合主键不能重复！</span>
        <span class="token comment">// 报错 Caused by: java.sql.SQLIntegrityConstraintViolationException: Duplicate entry '1-1' for key 'sys_user_role.PRIMARY'</span>
        <span class="token comment">// 放弃被选择一方（如角色）的中间表维护权即可！</span>

        sysUserRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>sysUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysRoleRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>sysRole<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>生成的sql：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> sys_user_role <span class="token punctuation">(</span>user_id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> role_id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> role_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> sys_role <span class="token punctuation">(</span>role_id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span> role_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>role_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> sys_user <span class="token punctuation">(</span>user_id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span> age <span class="token keyword">integer</span><span class="token punctuation">,</span> user_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>

<span class="token keyword">alter</span> <span class="token keyword">table</span> sys_user_role <span class="token keyword">add</span> <span class="token keyword">constraint</span> FKhh52n8vd4ny9ff4x9fb8v65qx <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>role_id<span class="token punctuation">)</span> <span class="token keyword">references</span> sys_role <span class="token punctuation">(</span>role_id<span class="token punctuation">)</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> sys_user_role <span class="token keyword">add</span> <span class="token keyword">constraint</span> FKb40xxfch70f5qnyfw8yme1n1s <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token keyword">references</span> sys_user <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>

<span class="token comment">-- 保存</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> sys_user <span class="token punctuation">(</span>age<span class="token punctuation">,</span> user_name<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> sys_role <span class="token punctuation">(</span>role_name<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> sys_user_role <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> role_id<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>可见，<strong>目前生成的建表语句竟然有5条</strong>，本应该只有3条！</p> <h3 id="manytomany-实战：级联-☠️"><a href="#manytomany-实战：级联-☠️" class="header-anchor">#</a> @ManyToMany 实战：级联 ☠️</h3> <p>配置同一对多</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@Builder</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysUser</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">GenerationType</span><span class="token punctuation">.</span>IDENTITY<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@ManyToMany</span><span class="token punctuation">(</span>cascade <span class="token operator">=</span> <span class="token class-name">CascadeType</span><span class="token punctuation">.</span>ALL<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JoinTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;sys_user_role&quot;</span><span class="token punctuation">,</span>
            joinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;user_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            inverseJoinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;role_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysRole</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>测试</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DataJpaTest</span>
<span class="token comment">// DataJpaTest、MybatisTest 会默认使用其测试数据源替代，若要使用自己配置的，需要添加如下注解</span>
<span class="token annotation punctuation">@AutoConfigureTestDatabase</span><span class="token punctuation">(</span>replace <span class="token operator">=</span> <span class="token class-name">AutoConfigureTestDatabase<span class="token punctuation">.</span>Replace</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Many2ManyTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SysUserRepository</span> sysUserRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SysRoleRepository</span> sysRoleRepository<span class="token punctuation">;</span>


    <span class="token comment">/**
     * 保存一个用户、一个角色
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token annotation punctuation">@Rollback</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">void</span> <span class="token function">testSave</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">SysUser</span> sysUser <span class="token operator">=</span> <span class="token class-name">SysUser</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">userName</span><span class="token punctuation">(</span><span class="token string">&quot;conanan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SysRole</span> sysRole <span class="token operator">=</span> <span class="token class-name">SysRole</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roleName</span><span class="token punctuation">(</span><span class="token string">&quot;架构师&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">users</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置用户到角色的关系，可以对中间表进行维护</span>
        sysUser<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sysRole<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置角色到用户的关系，可以对中间表进行维护</span>
        <span class="token comment">// sysRole.getUsers().add(sysUser);</span>
        <span class="token comment">// 但是不能同时维护，因为联合主键不能重复！</span>
        <span class="token comment">// 报错 Caused by: java.sql.SQLIntegrityConstraintViolationException: Duplicate entry '1-1' for key 'sys_user_role.PRIMARY'</span>
        <span class="token comment">// 放弃被选择一方（如角色）的中间表维护权即可！</span>

        sysUserRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>sysUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysRoleRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>sysRole<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 测试级联添加（保存一个用户同时保存用户相关角色及中间表关联信息）
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token annotation punctuation">@Rollback</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">void</span> <span class="token function">testCascadeAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">SysUser</span> sysUser <span class="token operator">=</span> <span class="token class-name">SysUser</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">userName</span><span class="token punctuation">(</span><span class="token string">&quot;conanan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysRole</span><span class="token punctuation">&gt;</span></span> byId <span class="token operator">=</span> sysRoleRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">5L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SysRole</span> sysRole <span class="token operator">=</span> <span class="token class-name">SysRole</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roleId</span><span class="token punctuation">(</span><span class="token number">5L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">users</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 配置用户到角色的关系，可以对中间表进行维护。若还配置了级联，则这里也维护了级联关系</span>
        sysUser<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>byId<span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SysRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置角色到用户的关系，可以对中间表进行维护</span>
        <span class="token comment">// sysRole.getUsers().add(sysUser);</span>
        <span class="token comment">// 但是不能同时维护，因为联合主键不能重复！</span>
        <span class="token comment">// 报错 Caused by: java.sql.SQLIntegrityConstraintViolationException: Duplicate entry '1-1' for key 'sys_user_role.PRIMARY'</span>
        <span class="token comment">// 放弃被选择一方（如角色）的中间表维护权即可！</span>

        sysUserRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>sysUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 测试级联删除（删除一个用户同时删除中间表关联信息及用户相关角色）
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token annotation punctuation">@Rollback</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">void</span> <span class="token function">testCascadeRemove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        sysUserRepository<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token number">5L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><p>保存的sql</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> sys_user_role <span class="token punctuation">(</span>user_id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> role_id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> role_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> sys_role <span class="token punctuation">(</span>role_id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span> role_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>role_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> sys_user <span class="token punctuation">(</span>user_id <span class="token keyword">bigint</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span> age <span class="token keyword">integer</span><span class="token punctuation">,</span> user_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>

<span class="token keyword">alter</span> <span class="token keyword">table</span> sys_user_role <span class="token keyword">add</span> <span class="token keyword">constraint</span> FKhh52n8vd4ny9ff4x9fb8v65qx <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>role_id<span class="token punctuation">)</span> <span class="token keyword">references</span> sys_role <span class="token punctuation">(</span>role_id<span class="token punctuation">)</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> sys_user_role <span class="token keyword">add</span> <span class="token keyword">constraint</span> FKb40xxfch70f5qnyfw8yme1n1s <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token keyword">references</span> sys_user <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>

<span class="token comment">-- 保存</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> sys_user <span class="token punctuation">(</span>age<span class="token punctuation">,</span> user_name<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> sys_role <span class="token punctuation">(</span>role_name<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> sys_user_role <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> role_id<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span>?<span class="token punctuation">,</span> ?<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>可见，<strong>目前生成的建表语句竟然有5条</strong>，本应该只有3条！其余的一模一样</p> <p>级联删除的sql</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> sysuser0_<span class="token punctuation">.</span>user_id <span class="token keyword">as</span> user_id1_5_0_<span class="token punctuation">,</span> sysuser0_<span class="token punctuation">.</span>age <span class="token keyword">as</span> age2_5_0_<span class="token punctuation">,</span> sysuser0_<span class="token punctuation">.</span>user_name <span class="token keyword">as</span> user_nam3_5_0_ <span class="token keyword">from</span> sys_user sysuser0_ <span class="token keyword">where</span> sysuser0_<span class="token punctuation">.</span>user_id<span class="token operator">=</span>?
<span class="token keyword">select</span> roles0_<span class="token punctuation">.</span>user_id <span class="token keyword">as</span> user_id1_3_0_<span class="token punctuation">,</span> roles0_<span class="token punctuation">.</span>role_id <span class="token keyword">as</span> role_id2_3_0_<span class="token punctuation">,</span> sysrole1_<span class="token punctuation">.</span>role_id <span class="token keyword">as</span> role_id1_4_1_<span class="token punctuation">,</span> sysrole1_<span class="token punctuation">.</span>role_name <span class="token keyword">as</span> role_nam2_4_1_ <span class="token keyword">from</span> sys_user_role roles0_ <span class="token keyword">inner</span> <span class="token keyword">join</span> sys_role sysrole1_ <span class="token keyword">on</span> roles0_<span class="token punctuation">.</span>role_id<span class="token operator">=</span>sysrole1_<span class="token punctuation">.</span>role_id <span class="token keyword">where</span> roles0_<span class="token punctuation">.</span>user_id<span class="token operator">=</span>?
<span class="token keyword">delete</span> <span class="token keyword">from</span> sys_user_role <span class="token keyword">where</span> user_id<span class="token operator">=</span>?
<span class="token keyword">delete</span> <span class="token keyword">from</span> sys_role <span class="token keyword">where</span> role_id<span class="token operator">=</span>?
<span class="token keyword">delete</span> <span class="token keyword">from</span> sys_user <span class="token keyword">where</span> user_id<span class="token operator">=</span>?
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>有可能删除报错！因为在删除中间表后，删除角色表时，该角色可能还被其他用户引用！</p> <h3 id="manytoone-和-onetomany-表示-🔥"><a href="#manytoone-和-onetomany-表示-🔥" class="header-anchor">#</a> @ManyToOne 和 @OneToMany 表示 🔥</h3> <p>需要新建一个中间表 @Entity 类，并在该类中维护映射关系，记得在2个主表中配置 mappedBy。此时可见，<strong>目前生成的建表语句就只有3条</strong>，非常正常！</p> <h3 id="多对多的最佳实践-🔥"><a href="#多对多的最佳实践-🔥" class="header-anchor">#</a> 多对多的最佳实践 🔥</h3> <ul><li>@ManyToMany 使用一般较少，除非没有额外字段</li> <li>上面我们介绍的 @OneToMany 的最佳实践同样适用，我为了说明方便，采用的是双向关联，而<strong>实际生产一般是在中间表对象里面做单向关联</strong>，这样会让实体之间的关联关系简单很多。</li> <li>与 @OneToMany 一样的道理，不要用级联删除和 orphanRemoval=true。默认配置即可！</li> <li>FetchType 采用默认方式：fetch = FetchType.LAZY 的方式。默认配置即可！</li></ul> <h2 id="对象导航查询-🔥"><a href="#对象导航查询-🔥" class="header-anchor">#</a> 对象导航查询 🔥</h2> <p>对象导航查询是根据已经加载的对象，导航到他的关联对象。它利用类与类之间的关系来检索对象。例如：我们通过ID查询方式查出一个客户，可以调用Customer类中的getLinkMans()方法来获取该客户的所有联系人。对象导航查询的使用要求是：两个对象之间必须存在关联关系。</p> <p>对象导航查询</p> <ul><li><strong>从一方查询多方：默认延迟加载</strong></li> <li><strong>从多方查询一方：默认立即加载</strong></li></ul> <p>可以修改配置将其改为立即加载（不推荐！），<strong>fetch配置在多表关系中主体（或一方或多方）的注解上</strong></p> <p>一对多中的例子，无需任何修改</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@DataJpaTest</span>
<span class="token comment">// DataJpaTest、MybatisTest 会默认使用其测试数据源替代，若要使用自己配置的，需要添加如下注解</span>
<span class="token annotation punctuation">@AutoConfigureTestDatabase</span><span class="token punctuation">(</span>replace <span class="token operator">=</span> <span class="token class-name">AutoConfigureTestDatabase<span class="token punctuation">.</span>Replace</span><span class="token punctuation">.</span>NONE<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjectNavigationTest</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">CustomerRepository</span> customerRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LinkManRepository</span> linkManRepository<span class="token punctuation">;</span>


    <span class="token comment">/**
     * 对象导航查询默认也是使用延迟加载，使用关联对象时才查询，仅仅.调用不会执行查询
     */</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testSelect1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Customer</span> customer <span class="token operator">=</span> customerRepository<span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LinkMan</span><span class="token punctuation">&gt;</span></span> linkManSet <span class="token operator">=</span> customer<span class="token punctuation">.</span><span class="token function">getLinkManSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>linkManSet<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 此时才查询</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>从一方查询多方：默认延迟加载</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> customer customer0_ <span class="token keyword">where</span> customer0_<span class="token punctuation">.</span>id<span class="token operator">=</span>?
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> link_man linkmanset0_ <span class="token keyword">where</span> linkmanset0_<span class="token punctuation">.</span>cust_id<span class="token operator">=</span>?
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>从多方查询一方：默认立即加载</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> 
 <span class="token comment">-- 略掉字段</span>
 <span class="token operator">*</span>
<span class="token keyword">FROM</span>
	link_man linkman0_
	<span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> customer customer1_ <span class="token keyword">ON</span> linkman0_<span class="token punctuation">.</span>cust_id <span class="token operator">=</span> customer1_<span class="token punctuation">.</span>id 
<span class="token keyword">WHERE</span>
	linkman0_<span class="token punctuation">.</span>id <span class="token operator">=</span>?
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="未整理"><a href="#未整理" class="header-anchor">#</a> 未整理</h2> <p><a href="http://www.wangzhenhua.rocks/zh-hans/java/jpa-one-to-many-many-to-one-best-practice" target="_blank" rel="noopener noreferrer">JPA中的OneToMany和ManyToOne的最佳实践<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，还有篇博客</p> <p>太复杂了，JPA 变用边写吧。。。</p></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
      <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="6620245489"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/xugaoyi/vuepress-theme-vdoing/edit/master/docs/200.Java Web/600.SpringDataJPA/404.多表操作.md" target="_blank" rel="noopener noreferrer">编辑</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021/06/21, 15:45:42</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/a40e65/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">基础操作</div></a> <a href="/pages/544a0d/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">审计功能</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/a40e65/" class="prev">基础操作</a></span> <span class="next"><a href="/pages/544a0d/">审计功能</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/7fcc72/"><div>线程生命周期</div></a> <span>07-06</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/a4ef99/"><div>线程安全理论</div></a> <span>06-24</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/890a0b/"><div>并发简史</div></a> <span>06-24</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:894072666@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/xugaoyi" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2021
    <span>Evan Xu | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><i class="close-but">×</i> <div><!-- 固定160*160px -->
      <ins class="adsbygoogle"
          style="display:inline-block;max-width:160px;max-height:160px"
          data-ad-client="ca-pub-7828333725993554"
          data-ad-slot="8377369658"></ins>
      <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.ac5e3ef4.js" defer></script><script src="/assets/js/2.d960b235.js" defer></script><script src="/assets/js/51.f4a8b763.js" defer></script>
  </body>
</html>