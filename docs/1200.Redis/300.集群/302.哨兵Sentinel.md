---
title: å“¨å…µSentinel
date: 2021-06-21 21:25:05
permalink: /pages/8584e6/
categories:
  - Redis
  - é›†ç¾¤
tags:
  - 
---
# å“¨å…µ Sentinelâ€”æ•…éšœè‡ªåŠ¨åˆ‡æ¢

## master å®•æœº

### è¡¥æ•‘æªæ–½

master å®•æœºåï¼Œæˆ‘ä»¬éœ€è¦åšå¦‚ä¸‹æ“ä½œï¼š

* å°†å®•æœºçš„ master ä¸‹çº¿
* æ‰¾ä¸€ä¸ª slave ä½œä¸º master
* é€šçŸ¥æ‰€æœ‰çš„ slave è¿æ¥æ–°çš„ master
* å¯åŠ¨æ–°çš„ master å’Œ slave
* æœ‰å¯èƒ½ä¼šå…¨é‡å¤åˆ¶ x N + éƒ¨åˆ†å¤åˆ¶ x N

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼š

* è°æ¥ç¡®è®¤ master å®•æœºäº†ï¼Œæ ‡å‡†æ˜¯ä»€ä¹ˆï¼Ÿ
* å¦‚ä½•ä»ä¼—å¤š slave ä¸­æ‰¾ä¸€ä¸ª masterï¼Œè§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿ
* ä¿®æ”¹é…ç½®åï¼ŒåŸæœ‰çš„ master æ¢å¤äº†æ€ä¹ˆç‰ˆï¼Ÿ

### å“¨å…µ

å“¨å…µï¼ˆSentinelï¼‰ æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œç”¨äºå¯¹**ä¸»ä»ç»“æ„ä¸­çš„æ¯å°æœåŠ¡å™¨**è¿›è¡Œ**ç›‘æ§**ï¼Œå½“å‡ºç°æ•…éšœæ—¶é€šè¿‡**æŠ•ç¥¨æœºåˆ¶**é€‰æ‹©æ–°çš„ master å¹¶å°†æ‰€æœ‰ slave è¿æ¥åˆ°æ–°çš„ masterã€‚

å…¶ä½œç”¨æœ‰ï¼š

* ç›‘æ§ï¼š

  ä¸æ–­çš„æ£€æŸ¥masterå’Œslaveæ˜¯å¦æ­£å¸¸è¿è¡Œã€‚ masterå­˜æ´»æ£€æµ‹ã€masterä¸slaveè¿è¡Œæƒ…å†µæ£€æµ‹ã€‚
* é€šçŸ¥ï¼ˆæé†’ï¼‰

  å½“è¢«ç›‘æ§çš„æœåŠ¡å™¨å‡ºç°é—®é¢˜æ—¶ï¼Œå‘å…¶ä»–ï¼ˆå“¨å…µé—´ï¼Œå®¢æˆ·ç«¯ï¼‰å‘é€é€šçŸ¥ã€‚
* è‡ªåŠ¨æ•…éšœè½¬ç§»

  æ–­å¼€masterä¸slaveè¿æ¥ï¼Œé€‰å–ä¸€ä¸ªslaveä½œä¸ºmasterï¼Œå°†å…¶ä»–slaveè¿æ¥åˆ°æ–°çš„masterï¼Œå¹¶å‘ŠçŸ¥å®¢æˆ·ç«¯æ–°çš„æœåŠ¡å™¨åœ°å€

æ³¨æ„ï¼š**å“¨å…µä¹Ÿæ˜¯ä¸€å°redisæœåŠ¡å™¨**ï¼Œåªæ˜¯**ä¸æä¾›æ•°æ®æœåŠ¡**ã€‚é€šå¸¸å“¨å…µé…ç½®æ•°é‡ä¸º**å•æ•°ï¼ï¼ï¼**

## é…ç½®å“¨å…µ

### ç®€ä»‹

* é…ç½®ä¸€æ‹–äºŒçš„ä¸»ä»ç»“æ„
* é…ç½®ä¸‰ä¸ªå“¨å…µï¼ˆé…ç½®ç›¸åŒï¼Œç«¯å£ä¸åŒï¼‰ã€‚å‚çœ‹ Redis ä¸­çš„ `sentinel.conf`

  ```
  cat sentinel.conf | grep -v '#' | grep -v '^$'
  ```

  ```
  port 26379
  daemonize no
  pidfile /var/run/redis-sentinel.pid
  logfile ""
  dir /tmp

  sentinel monitor mymaster 127.0.0.1 6379 2
  sentinel down-after-milliseconds mymaster 30000
  acllog-max-len 128
  sentinel parallel-syncs mymaster 1
  sentinel failover-timeout mymaster 180000
  sentinel deny-scripts-reconfig yes
  SENTINEL resolve-hostnames no
  SENTINEL announce-hostnames no
  ```

  æç¤ºï¼šå¤åˆ¶å¹¶ä¿®æ”¹æ–‡ä»¶ä¸­**ç«¯å£**æ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨ `sed` å‘½ä»¤ï¼ï¼ï¼

  ```
  sed 's/26379/26380/g' sentinel-26379.conf > sentinel-26380.conf
  ```
* å¯åŠ¨å“¨å…µ

  ```
  redis-sentinel sentinel-ç«¯å£å·.conf
  ```

### é…ç½®

ä¸Šé¢5ä¸ªå°±ä¸å¤šè¯´äº†ã€‚ä¹Ÿæ— éœ€æ”¹å˜ï¼ˆç‰¹åˆ«æ˜¯ daemonize æ— éœ€åå°è¿è¡Œï¼‰ã€‚ä¸€èˆ¬åªæ”¹ port ï¼ï¼ï¼

| é…ç½®é¡¹                                                        | èŒƒä¾‹                                            | è¯´æ˜                                                                                                        |
| ------------------------------------------------------------- | ----------------------------------------------- | ----------------------------------------------------------------------------------------------------------- |
| sentinel monitor \<master-name> \<ip> \<redis-port> \<quorum>     | sentinel monitor mymaster 127.0.0.1 6379 2      | è®¾ç½®å“¨å…µç›‘å¬çš„**ä¸»æœåŠ¡å™¨ä¿¡æ¯**ï¼Œæœ€åçš„å‚æ•°å†³å®šäº†æœ€ç»ˆ**å‚ä¸é€‰ä¸¾çš„æœåŠ¡å™¨æ•°é‡**ï¼ˆå³å¤šåŠï¼‰                      |
| sentinel down-after-milliseconds \<master-name> \<milliseconds> | sentinel down-after-milliseconds mymaster 30000 | æŒ‡å®šå“¨å…µåœ¨ç›‘æ§RedisæœåŠ¡æ—¶ï¼Œ**åˆ¤å®šmasteræœåŠ¡å™¨æŒ‚æ‰çš„æ—¶é—´å‘¨æœŸ**ï¼Œé»˜è®¤30ç§’ (30000)ï¼Œä¹Ÿæ˜¯ä¸»ä»åˆ‡æ¢çš„å¯åŠ¨æ¡ä»¶ä¹‹ä¸€ |
| sentinel parallel-syncs \<master-name> \<numreplicas>           | sentinel parallel-syncs mymaster 1              | æŒ‡å®š**åŒæ—¶è¿›è¡Œä¸»ä»çš„slaveæ•°é‡**ï¼Œæ•°å€¼è¶Šå¤§ï¼Œè¦æ±‚ç½‘ç»œèµ„æºè¶Šé«˜ï¼Œè¦æ±‚çº¦å°ï¼ŒåŒæ­¥æ—¶é—´çº¦é•¿                         |
| sentinel failover-timeout \<master-name> \<milliseconds>        | sentinel failover-timeout mymaster 180000       | æŒ‡å®šå‡ºç°æ•…éšœåï¼Œ**æ•…éšœåˆ‡æ¢çš„æœ€å¤§è¶…æ—¶æ—¶é—´**ï¼Œè¶…è¿‡è¯¥å€¼ï¼Œè®¤å®šåˆ‡æ¢å¤±è´¥ï¼Œ é»˜è®¤3åˆ†é’Ÿ                              |
| sentinel notification-script \<master-name> \<script-path>      |                                                 | æœåŠ¡å™¨æ— æ³•æ­£å¸¸è”é€šæ—¶ï¼Œè®¾å®šçš„æ‰§è¡Œè„šæœ¬ï¼Œé€šå¸¸è°ƒè¯•ä½¿ç”¨                                                          |

## å“¨å…µå·¥ä½œåŸç† ğŸ”¥

### ç›‘æ§é˜¶æ®µ

<img src="../images/image-20210326235723206.png" alt="image-20210326235723206" style="zoom: 33%;" />

ç”¨äºåŒæ­¥å„ä¸ªèŠ‚ç‚¹

* è·å–å„ä¸ªsentinelçš„çŠ¶æ€(æ˜¯å¦åœ¨çº¿)
* è·å–masterçš„çŠ¶æ€

  * masterå±æ€§ï¼šrunidã€role:master ç­‰
  * å„ä¸ªslaveçš„è¯¦ç»†ä¿¡æ¯
* è·å–æ‰€æœ‰slaveçš„çŠ¶æ€(æ ¹æ®masterä¸­çš„slaveä¿¡æ¯è·å–)

  * slaveå±æ€§ï¼šrunidã€role:slaveã€master_hostã€master_portã€offset

### é€šçŸ¥é˜¶æ®µ

![image-20210327001035164](../images/image-20210327001035164.png)

### æ•…éšœè½¬ç§»é˜¶æ®µ

ä¼— sentinel è§‚å¯Ÿå¹¶ç¡®è®¤ master æ˜¯å¦ä¸‹çº¿

![image-20210327001414792](../images/image-20210327001414792.png)

æ¨é€‰ä¸€ä¸ªä¸» sentinel

![image-20210327001656092](../images/image-20210327001656092.png)

ä¸» sentinel æ¥ä» slave ä¸­é€‰ master

![image-20210327002039853](../images/image-20210327002039853.png)

æœåŠ¡å™¨åˆ—è¡¨ä¸­æŒ‘é€‰å¤‡é€‰masterè§„åˆ™ï¼š

* å¿…é¡»æ˜¯åœ¨çº¿çš„
* pass å“åº”æ…¢çš„
* pass ä¸åŸmasteræ–­å¼€æ—¶é—´ä¹…çš„
* ä¼˜å…ˆåŸåˆ™

  * ä¼˜å…ˆçº§
  * offsetï¼Œå°çš„å°±ä¼šè¢«è®¤ä¸ºæ•°æ®ä¸å¤Ÿ
  * runidï¼Œå°çš„ä¼˜å…ˆï¼ˆè€å‘˜å·¥ï¼‰

å‘é€æŒ‡ä»¤(sentinel)ï¼š

* å‘æ–°çš„masterå‘é€slaveof no one
* å‘å…¶ä»–slaveå‘é€slaveof æ–°masterIPç«¯å£

### æ€»ç»“

* ç›‘æ§

  * åŒæ­¥ä¿¡æ¯
* é€šçŸ¥

  * ä¿æŒè”é€š
* æ•…éšœè½¬ç§»

  * å‘ç°é—®é¢˜
  * ç«é€‰è´Ÿè´£äºº
  * ä¼˜é€‰æ–°master
  * æ–°masterä¸Šä»»ï¼Œå…¶ä»–slaveåˆ‡æ¢masterï¼ŒåŸmasterä½œä¸ºslaveæ•…éšœå›å¤åè¿æ¥