---
title: hash
date: 2021-02-24 23:52:21
permalink: /pages/7edacd/
categories:
  - Redis
  - 基础
tags:
  - 
---

# hash

## string类型存储困惑

例如新浪微博大V主页显示粉丝数与微博数量。解决如下：

*   在redis中为大V用户设定用户信息，**以用户主键和属性值作为key**，后台设定定时刷新策略即可 

    ![image-20210224235606470](../images/image-20210224235606470.png)

    缺点就是**太分散了**

*   在redis中**以json格式**存储大V用户信息，定时刷新

    ![image-20210224235537410](../images/image-20210224235537410.png)

    缺点就是频繁**更新太麻烦了**

*   可以使用如下类型

    ![image-20210224235839218](../images/image-20210224235839218.png)



## hash 介绍

*   新的存储需求：对一系列存储的数据进行编组，方便管理，典型应用存储对象信息
*   需要的存储结构：一个存储空间保存多个键值对数据
*   hash 类型：**底层使用哈希表**结构实现数据存储
*   hash存储结构优化
    *   如果**field数量较少**，存储结构优化为**类数组**结构
    *   如果**field数量较多**，存储结构使用**HashMap结构**

![image-20210225000228111](../images/image-20210225000228111.png)





## hset

添加/修改数据命令：

```bash
hset key field value
```

实例

```bash
127.0.0.1:6379> hset user name conan
(integer) 1
127.0.0.1:6379> hset user age 18
(integer) 1
```





## hget / hgetall

获取数据命令：

```bash
hget key field 
hgetall key
```

实例

```bash
127.0.0.1:6379> hget user name
"conan"

127.0.0.1:6379> hgetall user
1) "name"
2) "conan"
3) "age"
4) "18"
```



## hdel / del

删除数据字段、key命令：

```bash
hdel key field1 [field2]
del key
```

实例

```bash
127.0.0.1:6379> hdel user name
(integer) 1

127.0.0.1:6379> hdel user name age
(integer) 1 --上面已经删了 name 所以这次只删了一个

127.0.0.1:6379> hgetall user
(empty array)

127.0.0.1:6379> hget user name
(nil)


-- 假设已经添加了值
127.0.0.1:6379> del user
(integer) 1

127.0.0.1:6379> hgetall user
(empty array)
```





## hmset 

添加/修改多个数据。有则改，没则加

```bash
hmset key field1 value1 field2 value2 ...
```



## hmget

获取多个数据

```bash
hmget key field1 field2 ...
```



## hlen

获取哈希表中**字段的数量**

```bash
hlen key
```



## hexists

获取哈希表中是否存在指定的字段

```bash
hexists key field
```

尽量不要用，应在业务逻辑层做判断，redis 只做数据的存改



## hkeys / hvals

获取哈希表中所有的字段名或字段值

```bash
hkeys key 
hvals key
```

实例

```bash
127.0.0.1:6379> hmset user name conan age 18
OK
127.0.0.1:6379> hkeys user
1) "name"
2) "age"
127.0.0.1:6379> hvals user
1) "conan"
2) "18"
```





## hincrby / hincrbyfloat

设置指定字段的**数值数据增加指定范围的值**

```bash
hincrby key field increment 
hincrbyfloat key field increment
```





## 注意事项

*   **hash类型下的value只能存储字符串！！！**，不允许存储其他数据类型，不存在嵌套现象。如果数据未获取到， 对应的值为(**nil**)
*   每个 hash 可以存储 23^2 - 1 个键值对
*   **hash类型十分贴近对象的数据存储形式**，并且可以**灵活添加删除对象属性**。但hash设计**初衷不是为了存储大量对象而设计**的，切记**不可滥用**，更不可以将hash作为对象列表使用
*   **hgetall 操作可以获取全部属性**，如果内部field过多，遍历整体数据效率就很会低，有**可能成为数据访问瓶颈**



## 场景—电商网站购物车设计与实现

### 业务分析

*   仅分析购物车的redis存储模型
    *   添加、浏览、更改数量、删除、清空
*   购物车于数据库间持久化同步(不讨论)
*   购物车于订单间关系(不讨论)
    *   提交购物车:读取数据生成订单
    *   商家临时价格调整:隶属于订单级别 
*   未登录用户购物车信息存储(不讨论)
    *   cookie存储
    *   手机端使用 localstorage？

![image-20210225002811887](../images/image-20210225002811887.png)



### 解决方案

*   以客户id作为key，每位客户创建一个hash存储结构存储对应的购物车信息
*   将商品编号作为field，购买数量作为value进行存储
*   添加商品:追加全新的field与value
*   浏览:遍历hash
*   更改数量:自增/自减，设置value值
*   删除商品:删除field
*   清空:删除key