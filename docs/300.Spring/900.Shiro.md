---
title: Shiro
date: 2020-12-16 01:29:04
permalink: /pages/e4aa12/
categories:
  - Spring
tags:
  - 
---
# Shiro

## åŠŸèƒ½

[å®˜æ–¹æ–‡æ¡£](https://shiro.apache.org/index.html)

Apache Shiroæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ä¸”çµæ´»çš„å¼€æºå®‰å…¨æ¡†æ¶ï¼Œå¯ä»¥å¹²å‡€åœ°å¤„ç†èº«ä»½è®¤è¯ï¼Œæˆæƒï¼Œä¼ä¸šä¼šè¯ç®¡ç†å’ŒåŠ å¯†ã€‚Apache Shiroçš„é¦–è¦ç›®æ ‡æ˜¯æ˜“äºä½¿ç”¨å’Œç†è§£ã€‚ å®‰å…¨æœ‰æ—¶å¯èƒ½éå¸¸å¤æ‚ï¼Œç”šè‡³ä¼šå¾ˆç—›è‹¦ï¼Œä½†è¿™ä¸æ˜¯å¿…é¡»çš„ã€‚ æ¡†æ¶åº”å°½å¯èƒ½æ©ç›–å¤æ‚æ€§ï¼Œå¹¶å…¬å¼€ç®€æ´ç›´è§‚çš„APIï¼Œä»¥ç®€åŒ–å¼€å‘äººå‘˜ç¡®ä¿å…¶åº”ç”¨ç¨‹åºå®‰å…¨çš„å·¥ä½œã€‚ShiroåŠŸèƒ½å¦‚ä¸‹ï¼š

![img](./images/ShiroFeatures.png)

Primary Concerns

*   **è®¤è¯**ï¼šæœ‰æ—¶ç§°ä¸ºâ€œç™»å½•â€ï¼Œè¿™æ˜¯è¯æ˜ç”¨æˆ·å°±æ˜¯ä»–ä»¬æ‰€è¯´çš„èº«ä»½çš„è¡Œä¸ºã€‚
*   **æˆæƒ**ï¼šè®¿é—®æ§åˆ¶çš„è¿‡ç¨‹ï¼Œå³ç¡®å®šâ€œè°â€æœ‰æƒè®¿é—®â€œä»€ä¹ˆâ€ã€‚
*   ä¼šè¯ç®¡ç†ï¼šå³ä½¿åœ¨éWebæˆ–EJBåº”ç”¨ç¨‹åºä¸­ï¼Œä¹Ÿå¯ä»¥ç®¡ç†ç”¨æˆ·ç‰¹å®šçš„ä¼šè¯ã€‚
*   åŠ å¯†ï¼šä½¿ç”¨å¯†ç ç®—æ³•ä¿æŒæ•°æ®å®‰å…¨ï¼ŒåŒæ—¶ä»ç„¶æ˜“äºä½¿ç”¨ã€‚

Supporting Features

*   ç½‘ç»œæ”¯æŒï¼šShiroçš„ç½‘ç»œæ”¯æŒAPIå¯å¸®åŠ©è½»æ¾ä¿æŠ¤ç½‘ç»œåº”ç”¨ç¨‹åºã€‚
*   ç¼“å­˜ï¼šç¼“å­˜æ˜¯Apache Shiro APIçš„ä¸€çº¿å…¬æ°‘ï¼Œå¯ç¡®ä¿å®‰å…¨æ“ä½œä¿æŒå¿«é€Ÿæœ‰æ•ˆã€‚æ¯”å¦‚ç”¨æˆ·ç™»å½•åï¼Œå…¶ç”¨æˆ·ä¿¡æ¯ã€æ‹¥æœ‰çš„è§’è‰²/æƒé™ä¸å¿…æ¯æ¬¡å»æŸ¥ï¼Œè¿™æ ·å¯ä»¥æé«˜æ•ˆç‡ï¼›
*   å¹¶å‘æ€§ï¼šApache Shiroçš„å¹¶å‘åŠŸèƒ½æ”¯æŒå¤šçº¿ç¨‹åº”ç”¨ç¨‹åºã€‚å³å¦‚åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¼€å¯å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œèƒ½æŠŠæƒé™è‡ªåŠ¨ä¼ æ’­è¿‡å»ï¼›
*   æµ‹è¯•ï¼šæµ‹è¯•æ”¯æŒå¯å¸®åŠ©æ‚¨ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•ï¼Œå¹¶ç¡®ä¿æ‚¨çš„ä»£ç å°†æŒ‰é¢„æœŸè¿›è¡Œä¿æŠ¤ã€‚
*   â€œ**Run As**â€ï¼šå…è®¸ç”¨æˆ·é‡‡ç”¨å…¶ä»–ç”¨æˆ·çš„èº«ä»½ï¼ˆå¦‚æœå…è®¸ï¼‰çš„åŠŸèƒ½ï¼Œæœ‰æ—¶åœ¨ç®¡ç†æ–¹æ¡ˆä¸­å¾ˆæœ‰ç”¨ã€‚
*   â€œ**Remember Me**â€ï¼šè®°ä½ç”¨æˆ·åœ¨å„ä¸ªä¼šè¯ä¸­çš„èº«ä»½ï¼Œå› æ­¤ä»–ä»¬åªéœ€è¦åœ¨å¿…è¦æ—¶ç™»å½•å³å¯ã€‚



## æ¶æ„

Apache Shiroçš„è®¾è®¡ç›®æ ‡æ˜¯é€šè¿‡ç›´è§‚ä¸”æ˜“äºä½¿ç”¨æ¥ç®€åŒ–åº”ç”¨ç¨‹åºå®‰å…¨æ€§ã€‚Shiroçš„æ ¸å¿ƒè®¾è®¡æ¨¡æ‹Ÿäº†å¤§å¤šæ•°äººå¦‚ä½•åœ¨ä¸æŸäººï¼ˆæˆ–æŸç‰©ï¼‰è¿›è¡Œäº¤äº’çš„æƒ…å†µä¸‹å¦‚ä½•è€ƒè™‘åº”ç”¨ç¨‹åºå®‰å…¨æ€§ã€‚

åœ¨æœ€é«˜æ¦‚å¿µå±‚æ¬¡ï¼ŒShiro çš„æ¶æ„æœ‰3ä¸ªä¸»è¦çš„æ¦‚å¿µï¼š`Subject`ï¼Œ`SecurityManager`å’Œ`Realms`ã€‚ä¸‹å›¾æ˜¯è¿™äº›ç»„ä»¶å¦‚ä½•äº¤äº’çš„é«˜çº§æ¦‚è¿°ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹é¢ä»‹ç»æ¯ä¸ªæ¦‚å¿µï¼š

![img](./images/ShiroBasicArchitecture.png)







### Subject ğŸ”¥

**Subject æœ¬è´¨ä¸Šæ˜¯å½“å‰æ‰§è¡Œç”¨æˆ·çš„ç‰¹å®šäºå®‰å…¨æ€§çš„â€œè§†å›¾â€**ã€‚ â€œç”¨æˆ·â€ä¸€è¯é€šå¸¸è¡¨ç¤ºä¸€ä¸ªäººï¼Œè€Œä¸»é¢˜å¯ä»¥æ˜¯ä¸€ä¸ªäººï¼Œä½†æ˜¯å®ƒä¹Ÿå¯ä»¥è¡¨ç¤ºç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œå®ˆæŠ¤ç¨‹åºå¸æˆ·ï¼Œå®šæ—¶ä»»åŠ¡æˆ–ç±»ä¼¼çš„ä¸œè¥¿ï¼ŒåŸºæœ¬ä¸Šæ˜¯**å½“å‰ä¸è¯¥è½¯ä»¶äº¤äº’çš„ä»»ä½•ä¸œè¥¿**ã€‚**Subject å®ä¾‹éƒ½ç»‘å®šåˆ°ï¼ˆå¹¶éœ€è¦ï¼‰SecurityManager**ã€‚ä¸ Subject è¿›è¡Œäº¤äº’æ—¶ï¼Œè¿™äº›äº¤äº’ä¼šè½¬æ¢ä¸ºä¸ SecurityManager çš„ç‰¹å®š Subject çš„äº¤äº’ã€‚



### SecurityManager ğŸ”¥

**SecurityManager æ˜¯ Shiro ä½“ç³»ç»“æ„çš„æ ¸å¿ƒ**ï¼Œå……å½“ä¸€ç§ä¼å½¢å¯¹è±¡ï¼Œåè°ƒå…¶å†…éƒ¨å®‰å…¨ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶ä¸€èµ·å½¢æˆä¸€ä¸ªå¯¹è±¡å›¾ã€‚ä½†æ˜¯ï¼Œä¸€æ—¦ä¸ºåº”ç”¨ç¨‹åºé…ç½®äº†SecurityManageråŠå…¶å†…éƒ¨å¯¹è±¡å›¾ï¼Œå®ƒé€šå¸¸å°±ä¼šè¢«æç½®ï¼Œåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜å‡ ä¹æŠŠæ‰€æœ‰æ—¶é—´éƒ½èŠ±åœ¨Subject APIä¸Šã€‚ç¨åæˆ‘ä»¬å°†è¯¦ç»†è®¨è®ºSecurityManagerï¼Œä½†é‡è¦çš„æ˜¯è¦è®¤è¯†åˆ°ï¼Œå½“æ‚¨ä¸ä¸»é¢˜äº¤äº’æ—¶ï¼Œå®é™…ä¸Šæ˜¯SecurityManageråœ¨å¹•åæ‰§è¡Œ**æ‰€æœ‰æ“ä½œ**ã€‚



### Realm ğŸ”¥

é¢†åŸŸå……å½“ Shiro å’Œåº”ç”¨ç¨‹åºå®‰å…¨æ•°æ®ä¹‹é—´çš„æ¡¥æ¢æˆ–è¿æ¥å™¨ã€‚å½“éœ€è¦ä¸å®‰å…¨ç›¸å…³çš„æ•°æ®(å¦‚ç”¨æˆ·å¸æˆ·)è¿›è¡Œå®é™…äº¤äº’ä»¥æ‰§è¡Œèº«ä»½éªŒè¯(ç™»å½•)å’Œæˆæƒ(è®¿é—®æ§åˆ¶)æ—¶ï¼ŒShiroä¼šä»ä¸ºåº”ç”¨ç¨‹åºé…ç½®çš„**ä¸€ä¸ªæˆ–å¤šä¸ª**é¢†åŸŸä¸­æŸ¥æ‰¾è¿™äº›å†…å®¹ã€‚

ä»è¿™ä¸ªæ„ä¹‰ä¸Šè¯´ï¼ŒRealm æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå®‰å…¨ç‰¹å®šçš„ **DAO**ï¼šå®ƒå°è£…äº†æ•°æ®æºçš„è¿æ¥ç»†èŠ‚ï¼Œå¹¶æ ¹æ®éœ€è¦å°†ç›¸å…³æ•°æ®æä¾›ç»™Shiroã€‚åœ¨é…ç½®Shiroæ—¶ï¼Œå¿…é¡»æŒ‡å®šè‡³å°‘ä¸€ä¸ªç”¨äºèº«ä»½éªŒè¯å’Œ/æˆ–æˆæƒçš„é¢†åŸŸã€‚SecurityManager **å¯ä»¥é…ç½®å¤šä¸ªåŸŸï¼Œä½†è‡³å°‘éœ€è¦ä¸€ä¸ªåŸŸ**ã€‚

Shiro æä¾›äº†å¼€ç®±å³ç”¨çš„ Realm æ¥è¿æ¥è®¸å¤šå®‰å…¨æ•°æ®æºï¼Œå¦‚LDAPã€å…³ç³»æ•°æ®åº“(JDBC)ã€æ–‡æœ¬é…ç½®æº(å¦‚INIå’Œå±æ€§æ–‡ä»¶)ç­‰ç­‰ã€‚å¦‚æœç¼ºçœé¢†åŸŸä¸èƒ½æ»¡è¶³æ‚¨çš„éœ€è¦ï¼Œæ‚¨å¯ä»¥æ’å…¥è‡ªå·±çš„åŸŸå®ç°æ¥è¡¨ç¤ºè‡ªå®šä¹‰æ•°æ®æºã€‚

::: tip

ä¸å…¶ä»–å†…éƒ¨ç»„ä»¶ä¸€æ ·ï¼Œ**SecurityManager ç®¡ç†å¦‚ä½•ä½¿ç”¨ Realm æ¥è·å–å®‰å…¨æ•°æ®å’Œèº«ä»½æ•°æ®ï¼Œå¹¶å°†å…¶è¡¨ç¤ºä¸º Subject å®ä¾‹**ã€‚

:::



### Authenticator

è®¤è¯å™¨

æ˜¯è´Ÿè´£æ‰§è¡Œå’Œå“åº”ç”¨æˆ·èº«ä»½éªŒè¯(ç™»å½•)å°è¯•çš„ç»„ä»¶ã€‚å½“ç”¨æˆ·å°è¯•ç™»å½•æ—¶ï¼ŒéªŒè¯ç¨‹åºå°†æ‰§è¡Œè¯¥é€»è¾‘ã€‚AuthenticatorçŸ¥é“å¦‚ä½•ä¸å­˜å‚¨ç›¸å…³ç”¨æˆ·/å¸æˆ·ä¿¡æ¯çš„ä¸€ä¸ªæˆ–å¤šä¸ªåŸŸè¿›è¡Œåè°ƒã€‚ä»è¿™äº›é¢†åŸŸè·å¾—çš„æ•°æ®ç”¨äºéªŒè¯ç”¨æˆ·çš„èº«ä»½ï¼Œä»¥ç¡®ä¿ç”¨æˆ·ç¡®å®æ˜¯ä»–ä»¬æ‰€è¯´çš„é‚£ä¸ªäººã€‚

èº«ä»½éªŒè¯ç­–ç•¥

å¦‚æœé…ç½®äº†å¤šä¸ªåŸŸï¼ŒAuthenticationStrategyå°†åè°ƒåŸŸä»¥ç¡®å®šèº«ä»½éªŒè¯å°è¯•æˆåŠŸæˆ–å¤±è´¥çš„æ¡ä»¶(ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªåŸŸæˆåŠŸä½†å…¶ä»–åŸŸå¤±è´¥ï¼Œé‚£ä¹ˆå°è¯•æˆåŠŸå—?)æ‰€æœ‰é¢†åŸŸå¿…é¡»æˆåŠŸå—?åªæœ‰ç¬¬ä¸€ä¸ª?)



### Authrizer

æˆæƒå™¨æ˜¯è´Ÿè´£ç¡®å®šåº”ç”¨ç¨‹åºä¸­ç”¨æˆ·è®¿é—®æ§åˆ¶çš„ç»„ä»¶ã€‚å®ƒæ˜¯æœ€ç»ˆå†³å®šç”¨æˆ·æ˜¯å¦è¢«å…è®¸åšæŸäº‹çš„æœºåˆ¶ã€‚ä¸Authenticatorä¸€æ ·ï¼Œæˆæƒå™¨ä¹ŸçŸ¥é“å¦‚ä½•ä¸å¤šä¸ªåç«¯æ•°æ®æºåè°ƒï¼Œä»¥è®¿é—®è§’è‰²å’Œæƒé™ä¿¡æ¯ã€‚æˆæƒæ–¹ä½¿ç”¨æ­¤ä¿¡æ¯å‡†ç¡®åœ°ç¡®å®šæ˜¯å¦å…è®¸ç”¨æˆ·æ‰§è¡Œç»™å®šçš„æ“ä½œã€‚



### SessionManager

SessionManagerçŸ¥é“å¦‚ä½•åˆ›å»ºå’Œç®¡ç†ç”¨æˆ·ä¼šè¯ç”Ÿå‘½å‘¨æœŸï¼Œä¸ºæ‰€æœ‰ç¯å¢ƒä¸­çš„ç”¨æˆ·æä¾›å¥å£®çš„ä¼šè¯ä½“éªŒã€‚è¿™æ˜¯å®‰å…¨æ¡†æ¶ä¸–ç•Œä¸­çš„ä¸€ä¸ªç‹¬ç‰¹ç‰¹æ€§â€”Shiroèƒ½å¤Ÿåœ¨ä»»ä½•ç¯å¢ƒä¸­æœ¬åœ°ç®¡ç†ç”¨æˆ·ä¼šè¯ï¼Œå³ä½¿æ²¡æœ‰Web/Servletæˆ–EJBå®¹å™¨å¯ç”¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒShiroå°†ä½¿ç”¨ç°æœ‰çš„ä¼šè¯æœºåˆ¶(å¦‚Servletå®¹å™¨)ï¼Œä½†å¦‚æœæ²¡æœ‰ï¼Œä¾‹å¦‚åœ¨ç‹¬ç«‹åº”ç”¨ç¨‹åºæˆ–éwebç¯å¢ƒä¸­ï¼Œå®ƒå°†ä½¿ç”¨å†…ç½®çš„ä¼ä¸šä¼šè¯ç®¡ç†æ¥æä¾›ç›¸åŒçš„ç¼–ç¨‹ä½“éªŒã€‚SessionDAOçš„å­˜åœ¨æ˜¯ä¸ºäº†å…è®¸ä½¿ç”¨ä»»ä½•æ•°æ®æºæ¥æŒä¹…åŒ–ä¼šè¯ã€‚



### SessionDAO

SessionDAOä»£è¡¨SessionManageræ‰§è¡Œä¼šè¯æŒä¹…æ€§(CRUD)æ“ä½œã€‚è¿™å…è®¸å°†ä»»ä½•æ•°æ®å­˜å‚¨æ’å…¥åˆ°ä¼šè¯ç®¡ç†åŸºç¡€è®¾æ–½ã€‚



### CacheManager

CacheManageråˆ›å»ºå’Œç®¡ç†å…¶ä»–Shiroç»„ä»¶ä½¿ç”¨çš„ç¼“å­˜å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸã€‚ç”±äºShiroå¯ä»¥è®¿é—®è®¸å¤šåç«¯æ•°æ®æºæ¥è¿›è¡Œèº«ä»½éªŒè¯ã€æˆæƒå’Œä¼šè¯ç®¡ç†ï¼Œå› æ­¤ç¼“å­˜ä¸€ç›´æ˜¯æ¡†æ¶ä¸­çš„ä¸€ä¸ªä¸€æµæ¶æ„ç‰¹æ€§ï¼Œå¯ä»¥åœ¨ä½¿ç”¨è¿™äº›æ•°æ®æºæ—¶æé«˜æ€§èƒ½ã€‚ä»»ä½•ç°ä»£çš„å¼€æºå’Œ/æˆ–ä¼ä¸šç¼“å­˜äº§å“éƒ½å¯ä»¥æ’å…¥åˆ°Shiroä¸­ï¼Œä»¥æä¾›å¿«é€Ÿå’Œé«˜æ•ˆçš„ç”¨æˆ·ä½“éªŒã€‚

ç¼“å­˜æ§åˆ¶å™¨ï¼Œæ¥ç®¡ç†å¦‚ç”¨æˆ·ã€è§’è‰²ã€æƒé™ç­‰çš„ç¼“å­˜çš„ï¼›å› ä¸ºè¿™äº›æ•°æ®åŸºæœ¬ä¸Šå¾ˆå°‘å»æ”¹å˜ï¼Œæ”¾åˆ°ç¼“å­˜ä¸­åå¯ä»¥æé«˜è®¿é—®çš„æ€§èƒ½



### Cryptography

å¯†ç å­¦æ˜¯ä¼ä¸šå®‰å…¨æ¡†æ¶çš„è‡ªç„¶è¡¥å……ã€‚Shiroçš„åŠ å¯†åŒ…åŒ…å«æ˜“äºä½¿ç”¨å’Œç†è§£çš„å¯†ç ã€æ•£åˆ—(åˆåæ‘˜è¦)å’Œä¸åŒçš„ç¼–è§£ç å™¨å®ç°çš„è¡¨ç¤ºå½¢å¼ã€‚è¿™ä¸ªåŒ…ä¸­çš„æ‰€æœ‰ç±»éƒ½ç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œéå¸¸æ˜“äºä½¿ç”¨å’Œç†è§£ã€‚ä»»ä½•ä½¿ç”¨è¿‡Javaçš„æœ¬åœ°åŠ å¯†æ”¯æŒçš„äººéƒ½çŸ¥é“ï¼Œè¦é©¯æœå®ƒæ˜¯ä¸€ç§å…·æœ‰æŒ‘æˆ˜æ€§çš„åŠ¨ç‰©ã€‚Shiroçš„crypto apiç®€åŒ–äº†å¤æ‚çš„Javaæœºåˆ¶ï¼Œä½¿æ™®é€šäººå¯ä»¥è½»æ¾åœ°ä½¿ç”¨å¯†ç æœ¯ã€‚





## æœ¯è¯­

### Authenticationâ€”è®¤è¯

èº«ä»½éªŒè¯æ˜¯éªŒè¯ä¸»ä½“èº«ä»½çš„è¿‡ç¨‹â€”â€”æœ¬è´¨ä¸Šè¯æ˜æŸäººç¡®å®æ˜¯ä»–ä»¬æ‰€è¯´çš„é‚£ä¸ªäººã€‚å½“èº«ä»½éªŒè¯å°è¯•æˆåŠŸæ—¶ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ç›¸ä¿¡è¯¥ä¸»é¢˜ä¸€å®šæ˜¯åº”ç”¨ç¨‹åºæ‰€æœŸæœ›çš„ã€‚



### Authorizationâ€”æˆæƒ

æˆæƒï¼Œä¹Ÿç§°ä¸ºè®¿é—®æ§åˆ¶ï¼Œæ˜¯å†³å®š user / Subject æ˜¯å¦è¢«å…è®¸åšæŸäº‹çš„è¿‡ç¨‹ã€‚å®ƒé€šå¸¸æ˜¯é€šè¿‡æ£€æŸ¥å’Œè§£é‡Š Subject çš„è§’è‰²å’Œæƒé™(è§ä¸‹é¢)ï¼Œç„¶åå…è®¸æˆ–æ‹’ç»è®¿é—®è¯·æ±‚çš„èµ„æºæˆ–å‡½æ•°æ¥å®Œæˆçš„ã€‚



### Cipherâ€”åŠ å¯†ç®—æ³•

åŠ å¯†ç®—æ³•æ˜¯æ‰§è¡ŒåŠ å¯†æˆ–è§£å¯†çš„ç®—æ³•ã€‚è¯¥ç®—æ³•é€šå¸¸ä¾èµ–äºä¸€æ¡åä¸ºå¯†é’¥çš„ä¿¡æ¯ã€‚è€ŒåŠ å¯†æ˜¯æ ¹æ®å¯†é’¥è€Œå˜åŒ–çš„ï¼Œæ‰€ä»¥æ²¡æœ‰å¯†é’¥çš„è§£å¯†æ˜¯éå¸¸å›°éš¾çš„ã€‚
å¯†ç æœ‰ä¸åŒçš„å˜ä½“ã€‚å—å¯†ç é€šå¸¸åœ¨å›ºå®šå¤§å°çš„ç¬¦å·å—ä¸Šå·¥ä½œï¼Œè€Œæµå¯†ç åˆ™åœ¨è¿ç»­çš„ç¬¦å·æµä¸Šå·¥ä½œã€‚å¯¹ç§°å¯†ç ä½¿ç”¨ç›¸åŒçš„å¯†é’¥è¿›è¡ŒåŠ å¯†å’Œè§£å¯†ï¼Œè€Œéå¯¹ç§°å¯†ç ä½¿ç”¨ä¸åŒçš„å¯†é’¥ã€‚å¦‚æœéå¯¹ç§°å¯†ç ä¸­çš„å¯†é’¥ä¸èƒ½ä»å¦ä¸€ä¸ªå¯†é’¥æ´¾ç”Ÿå‡ºæ¥ï¼Œåˆ™å¯ä»¥å…¬å¼€å…±äº«ä¸€ä¸ªå¯†é’¥ï¼Œä»è€Œåˆ›å»ºå…¬å…±/ç§æœ‰å¯†é’¥å¯¹ã€‚



### Credentialâ€”å‡­æ® ğŸ”¥

**å‡­æ®**æ˜¯éªŒè¯ user / Subject èº«ä»½çš„ä¸€æ®µä¿¡æ¯ã€‚åœ¨éªŒè¯è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ª(æˆ–å¤šä¸ª) Credential ä¸ Subject ä¸€èµ·æäº¤ï¼Œä»¥éªŒè¯æäº¤ Credential çš„ user / Subject å®é™…ä¸Šæ˜¯å…³è”çš„ç”¨æˆ·ã€‚å‡­è¯é€šå¸¸æ˜¯åªæœ‰ç‰¹å®š user / Subject æ‰çŸ¥é“çš„éå¸¸ç§˜å¯†çš„ä¸œè¥¿ï¼Œæ¯”å¦‚å¯†ç ã€PGPå¯†é’¥ã€ç”Ÿç‰©ç»Ÿè®¡å±æ€§æˆ–ç±»ä¼¼çš„æœºåˆ¶ã€‚
å…¶æ€æƒ³æ˜¯ï¼Œå¯¹äºä¸€ä¸ªè´Ÿè´£äººï¼Œåªæœ‰ä¸€ä¸ªäººçŸ¥é“æ­£ç¡®çš„ Credential æ¥ä¸è¯¥è´Ÿè´£äººâ€œé…å¯¹â€ã€‚å¦‚æœå½“å‰ user / Subject æä¾›äº†ä¸ç³»ç»Ÿä¸­å­˜å‚¨çš„ Credential ç›¸åŒ¹é…çš„æ­£ç¡® Credential ï¼Œé‚£ä¹ˆç³»ç»Ÿå¯ä»¥å‡å®šå¹¶ç›¸ä¿¡å½“å‰ user / Subject å°±æ˜¯ä»–ä»¬æ‰€è¯´çš„é‚£ä¸ªäººã€‚ä¿¡ä»»ç¨‹åº¦éšç€æ›´å®‰å…¨çš„å‡­æ®ç±»å‹(ä¾‹å¦‚ç”Ÿç‰©ç‰¹å¾ç­¾å>å¯†ç )çš„å¢åŠ è€Œå¢åŠ ã€‚



### Cryptographyâ€”åŠ å¯†

åŠ å¯†æ˜¯ä¸€ç§å®è·µï¼Œé€šè¿‡éšè—ä¿¡æ¯æˆ–å°†å…¶è½¬æ¢æˆæ²¡æœ‰æ„ä¹‰çš„ä¿¡æ¯ï¼Œä»è€Œé¿å…ä¸å¸Œæœ›çš„è®¿é—®ï¼Œè¿™æ ·å…¶ä»–äººå°±æ— æ³•è¯»å–ä¿¡æ¯ã€‚Shiroä¸“æ³¨äºå¯†ç å­¦çš„ä¸¤ä¸ªæ ¸å¿ƒå…ƒç´ ï¼šä½¿ç”¨å…¬é’¥æˆ–ç§é’¥åŠ å¯†æ•°æ®(å¦‚ç”µå­é‚®ä»¶)çš„å¯†ç ï¼Œä»¥åŠä¸å¯é€†åŠ å¯†æ•°æ®(å¦‚å¯†ç )çš„æ•£åˆ—(åˆåæ¶ˆæ¯æ‘˜è¦)ã€‚



### Hashâ€”å“ˆå¸Œ

å“ˆå¸Œå‡½æ•°æ˜¯è¾“å…¥æº(æœ‰æ—¶ç§°ä¸ºæ¶ˆæ¯)åˆ°ç»è¿‡ç¼–ç çš„å“ˆå¸Œå€¼(æœ‰æ—¶ç§°ä¸ºæ¶ˆæ¯æ‘˜è¦)çš„å•å‘ã€ä¸å¯é€†è½¬æ¢ã€‚å®ƒé€šå¸¸ç”¨äºå¯†ç ã€æ•°å­—æŒ‡çº¹æˆ–å…·æœ‰åº•å±‚å­—èŠ‚æ•°ç»„çš„æ•°æ®ã€‚



### Permissionâ€”æƒé™

æƒé™(è‡³å°‘æŒ‰ç…§Shiroçš„è§£é‡Š)æ˜¯æè¿°åº”ç”¨ç¨‹åºåŸå§‹åŠŸèƒ½çš„è¯­å¥ï¼Œä»…æ­¤è€Œå·²ã€‚æƒé™æ˜¯å®‰å…¨ç­–ç•¥ä¸­æœ€ä½çº§åˆ«çš„æ„é€ ã€‚å®ƒä»¬åªå®šä¹‰åº”ç”¨ç¨‹åºå¯ä»¥åšä»€ä¹ˆã€‚å®ƒä»¬æ²¡æœ‰æè¿°â€œè°â€èƒ½å¤Ÿæ‰§è¡Œè¿™äº›æ“ä½œã€‚è®¸å¯åªæ˜¯ä¸€ç§è¡Œä¸ºçš„é™ˆè¿°ï¼Œä»…æ­¤è€Œå·²ã€‚



### Principalâ€”ä¸»ä½“ ğŸ”¥

**Principal æ˜¯åº”ç”¨ç¨‹åº user ( Subject ) çš„æ ‡è¯†å±æ€§**ã€‚â€œæ ‡è¯†å±æ€§â€å¯ä»¥æ˜¯å¯¹æ‚¨çš„åº”ç”¨ç¨‹åºæœ‰æ„ä¹‰çš„ä»»ä½•å†…å®¹â€”ç”¨æˆ·åã€å§“æ°ã€ç»™å®šåç§°ã€ç¤¾ä¼šå®‰å…¨å·ç ã€ç”¨æˆ·IDç­‰ç­‰ã€‚
Shiroè¿˜å¼•ç”¨äº†æˆ‘ä»¬ç§°ä¸º Principal çš„ä¸»è¦åŸåˆ™çš„ä¸œè¥¿ã€‚ Principal æ˜¯åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­å”¯ä¸€æ ‡è¯† Subject çš„ä»»ä½• Principalã€‚ç†æƒ³çš„Principal æ˜¯åƒ RDBMS ç”¨æˆ·è¡¨ä¸»é”®é‚£æ ·çš„ç”¨æˆ·åæˆ–ç”¨æˆ·IDã€‚åœ¨**åº”ç”¨ç¨‹åºä¸­ï¼Œ user ( Subject ) åªæœ‰ä¸€ä¸ªä¸» Principal**ã€‚



### Realmâ€”é¢†åŸŸ

ç•¥



### Roleâ€”è§’è‰²

ç•¥



### Sessionâ€”ä¼šè¯

Session æ˜¯ä¸åœ¨ä¸€æ®µæ—¶é—´å†…ä¸è½¯ä»¶ç³»ç»Ÿäº¤äº’çš„å•ä¸ª user ( Subject ) ç›¸å…³è”çš„æœ‰çŠ¶æ€æ•°æ®ä¸Šä¸‹æ–‡ã€‚å½“ä¸»é¢˜ä½¿ç”¨åº”ç”¨ç¨‹åºæ—¶ï¼Œå¯ä»¥ä»ä¼šè¯ä¸­æ·»åŠ /è¯»å–/åˆ é™¤æ•°æ®ï¼Œè€Œåº”ç”¨ç¨‹åºç¨ååœ¨éœ€è¦æ—¶å¯ä»¥ä½¿ç”¨è¿™äº›æ•°æ®ã€‚ä¼šè¯åœ¨ç”¨æˆ·/ä¸»é¢˜æ³¨é”€åº”ç”¨ç¨‹åºæˆ–ç”±äºä¸æ´»åŠ¨è€Œè¶…æ—¶æ—¶ç»ˆæ­¢ã€‚
å¯¹äºé‚£äº›ç†Ÿæ‚‰HttpSessionçš„äººæ¥è¯´ï¼ŒShiroä¼šè¯å…·æœ‰ç›¸åŒçš„ç”¨é€”ï¼Œåªæ˜¯Shiroä¼šè¯å¯ä»¥åœ¨ä»»ä½•ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œå³ä½¿æ²¡æœ‰Servletå®¹å™¨æˆ–EJBå®¹å™¨å¯ç”¨ã€‚



### Subject

Subject åªæ˜¯ä¸€ä¸ªèŠ±å“¨çš„å®‰å…¨æœ¯è¯­ï¼ŒåŸºæœ¬ä¸Šæ˜¯æŒ‡åº”ç”¨ç¨‹åºç”¨æˆ·çš„ç‰¹å®šäºå®‰å…¨çš„â€œè§†å›¾â€ã€‚ä½†æ˜¯ï¼ŒSubjectå¹¶ä¸æ€»æ˜¯éœ€è¦åæ˜ äººâ€”â€”å®ƒå¯ä»¥è¡¨ç¤ºè°ƒç”¨æ‚¨çš„åº”ç”¨ç¨‹åºçš„å¤–éƒ¨è¿›ç¨‹ï¼Œæˆ–è€…å¯èƒ½è¡¨ç¤ºåœ¨ä¸€æ®µæ—¶é—´å†…é—´æ­‡æ‰§è¡ŒæŸäº›æ“ä½œçš„å®ˆæŠ¤è¿›ç¨‹ç³»ç»Ÿå¸æˆ·(ä¾‹å¦‚cronä½œä¸š)ã€‚å®ƒåŸºæœ¬ä¸Šæ˜¯ä»»ä½•å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œæ“ä½œçš„å®ä½“çš„è¡¨ç¤ºã€‚





## Authenticationâ€”è®¤è¯

![img](./images/ShiroAuthenticationSequence.png)

### è®¤è¯æµç¨‹

1.  åº”ç”¨ç¨‹åºä»£ç æ‰§è¡Œ `Subject.login` æ–¹æ³•ï¼Œä¼ é€’æ„é€ çš„ AuthenticationToken å®ä¾‹ï¼Œè¯¥å®ä¾‹è¡¨ç¤ºæœ€ç»ˆç”¨æˆ·çš„ principals å’Œ credentialsã€‚

2.  Subject å®ä¾‹ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ª DelegatingSubjectï¼ˆæˆ–å­ç±»ï¼‰è¢«åº”ç”¨å§”æ‰˜æ¥è°ƒç”¨`SecurityManager.login(token)`ï¼Œå®é™…çš„èº«ä»½éªŒè¯å·¥ä½œä»è¿™é‡Œå¼€å§‹ã€‚

3.  SecurityManager æ˜¯ä¸€ä¸ªåŸºæœ¬çš„â€œä¼å½¢â€ç»„ä»¶ï¼Œå®ƒæ¥æ”¶ä»¤ç‰Œå¹¶é€šè¿‡è°ƒç”¨`Authenticator.authenticate(token)`å°†å…¶ç®€å•åœ°å§”æ‰˜ç»™å®ƒçš„å†…éƒ¨ Authenticator å®ä¾‹ã€‚è¿™å‡ ä¹æ€»æ˜¯ä¸€ä¸ª ModularRealmAuthenticator å®ä¾‹ï¼Œå®ƒæ”¯æŒåœ¨èº«ä»½éªŒè¯æœŸé—´åè°ƒä¸€ä¸ªæˆ–å¤šä¸ª Realm å®ä¾‹ã€‚ ModularRealmAuthenticator æœ¬è´¨ä¸Šä¸ºApache Shiroæä¾›äº†ä¸€ä¸ªPAMæ ·å¼çš„èŒƒå‹(åœ¨PAMæœ¯è¯­ä¸­ï¼Œæ¯ä¸ª Realm éƒ½æ˜¯ä¸€ä¸ªâ€œæ¨¡å—â€)ã€‚

4.  å¦‚æœåªé…ç½®äº†å•ä¸ª Realmï¼Œåˆ™ç›´æ¥è°ƒç”¨å®ƒâ€”â€”åœ¨å•ä¸ªåŸŸåº”ç”¨ç¨‹åºä¸­ä¸éœ€è¦éªŒè¯ç­–ç•¥ã€‚

5.  å¦‚æœä¸ºåº”ç”¨ç¨‹åºé…ç½®äº†å¤šä¸ª Realmï¼ŒModularRealmAuthenticator å®ä¾‹å°†åˆ©ç”¨å…¶é…ç½®çš„ AuthenticationStrategy å‘èµ·å¤šåŸŸèº«ä»½éªŒè¯å°è¯•ã€‚åœ¨ä¸ºèº«ä»½éªŒè¯è°ƒç”¨é¢†åŸŸä¹‹å‰ã€æœŸé—´å’Œä¹‹åï¼Œå°†è°ƒç”¨ AuthenticationStrategy ä»¥å…è®¸å®ƒå¯¹æ¯ä¸ªé¢†åŸŸçš„ç»“æœä½œå‡ºååº”ã€‚æˆ‘ä»¬å°†å¾ˆå¿«ä»‹ç»èº«ä»½éªŒè¯ç­–ç•¥ã€‚

6.  æ¯ä¸ªå·²é…ç½®çš„ Realm éƒ½å°†è¢«æŸ¥è¯¢ï¼Œä»¥æŸ¥çœ‹å®ƒæ˜¯å¦æ”¯æŒæäº¤çš„ AuthenticationTokenã€‚å¦‚æœæ˜¯ï¼Œå°†ä½¿ç”¨æäº¤çš„ä»¤ç‰Œè°ƒç”¨æ”¯æŒåŸŸçš„`getAuthenticationInfo`æ–¹æ³•ã€‚`getAuthenticationInfo`æ–¹æ³•æœ‰æ•ˆåœ°è¡¨ç¤ºè¯¥ç‰¹å®š Realm çš„å•ä¸ªèº«ä»½è®¤è¯å°è¯•ã€‚æˆ‘ä»¬ç¨åå°†è®¨è®ºé¢†åŸŸèº«ä»½è®¤è¯è¡Œä¸ºã€‚

    

### Authenticator

å¦‚å‰æ‰€è¿°ï¼ŒShiro SecurityManagerå®ç°é»˜è®¤ä½¿ç”¨ ModularRealmAuthenticator å®ä¾‹ã€‚ModularRealmAuthenticator åŒæ ·æ”¯æŒå…·æœ‰å•ä¸ª Realm çš„åº”ç”¨ç¨‹åºå’Œå…·æœ‰å¤šä¸ª Realm çš„åº”ç”¨ç¨‹åºã€‚

åœ¨å•ä¸€ Realm åº”ç”¨ç¨‹åºä¸­ï¼ŒModularRealmAuthenticator å°†ç›´æ¥è°ƒç”¨å•ä¸€é¢†åŸŸã€‚å¦‚æœé…ç½®äº†ä¸¤ä¸ªæˆ–å¤šä¸ªåŸŸï¼Œå®ƒå°†ä½¿ç”¨AuthenticationStrategyå®ä¾‹æ¥åè°ƒå¦‚ä½•è¿›è¡Œå°è¯•ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹é¢è®¨è®ºèº«ä»½éªŒè¯ç­–ç•¥ã€‚

å¯ä»¥è‡ªå®šä¹‰è®¤è¯å™¨ï¼Œè™½ç„¶ ModularRealmAuthenticator å¯ä»¥é€‚åº”å¤§éƒ¨åˆ†éœ€æ±‚ã€‚ç•¥



### AuthenticationStrategy

å¤šä¸ª Realm æ‰ä¼šä½¿ç”¨ï¼Œè§æ–‡æ¡£ï¼Œç•¥



## QuickStart

::: tip

è¯¦ç»†ä»£ç æŸ¥çœ‹ä»“åº“

:::

### å¼•å…¥ä¾èµ–

```xml
<dependency>
  <groupId>org.apache.shiro</groupId>
  <artifactId>shiro-spring-boot-starter</artifactId>
  <version>1.5.1</version><!--å“”äº†ç‹—ï¼Œå®˜ç½‘æ–‡æ¡£ç»™çš„1.5.2-SNAPSHOTä½†æ˜¯å¹¶æ²¡æœ‰å­˜å…¥Mavenåº“é‡Œ-->
</dependency>
```

### é…ç½®

```ini
# -----------------------------------------------------------------------------
# Users and their assigned roles
#
# Each line conforms to the format defined in the
# org.apache.shiro.realm.text.TextConfigurationRealm#setUserDefinitions JavaDoc
# -----------------------------------------------------------------------------
[users]
# user 'root' with password 'secret' and the 'admin' role
root = secret, admin
# user 'guest' with the password 'guest' and the 'guest' role
guest = guest, guest
# user 'presidentskroob' with password '12345' ("That's the same combination on
# my luggage!!!" ;)), and role 'president'
presidentskroob = 12345, president
# user 'darkhelmet' with password 'ludicrousspeed' and roles 'darklord' and 'schwartz'
darkhelmet = ludicrousspeed, darklord, schwartz
# user 'lonestarr' with password 'vespa' and roles 'goodguy' and 'schwartz'
lonestarr = vespa, goodguy, schwartz

# -----------------------------------------------------------------------------
# Roles with assigned permissions
# 
# Each line conforms to the format defined in the
# org.apache.shiro.realm.text.TextConfigurationRealm#setRoleDefinitions JavaDoc
# -----------------------------------------------------------------------------
[roles]
# 'admin' role has all permissions, indicated by the wildcard '*'
admin = *
# The 'schwartz' role can do anything (*) with any lightsaber:
schwartz = lightsaber:*
# The 'goodguy' role is allowed to 'drive' (action) the winnebago (type) with
# license plate 'eagle5' (instance specific id)
goodguy = winnebago:drive:eagle5
```



### ç¤ºä¾‹

```java
public static void main(String[] args) {
  /*
   åˆ›å»ºé…ç½®äº†Shiro SecurityManagerçš„æœ€ç®€å•æ–¹æ³•, realms, users, roles å’Œ permissions ä½¿ç”¨äº†ç®€å•çš„ INI é…ç½®
   å®˜æ–¹ç»™çš„ç¤ºä¾‹ä¸­ä½¿ç”¨ IniSecurityManagerFactory æ„é€ æ¥è·å– SecurityManager çš„æ–¹å¼å·²ç»è¿‡æ—¶ï¼Œæ¨èä½¿ç”¨ Shiro çš„ Environment æ›¿ä»£
  */
  BasicIniEnvironment basicIniEnvironment = new BasicIniEnvironment("classpath:shiro.ini");
  SecurityManager securityManager = basicIniEnvironment.getSecurityManager();

  /*
   å¯¹äºè¿™ä¸ªç®€å•çš„å¿«é€Ÿå…¥é—¨ç¤ºä¾‹ï¼Œä½¿ç”¨SecurityManagerå¯ä½œä¸ºJVMå•ä¾‹è®¿é—®ã€‚å¤§å¤šæ•°åº”ç”¨ç¨‹åºä¸ä¼šè¿™æ ·åšè€Œæ˜¯ä¾èµ–äºå®ƒä»¬çš„å®¹å™¨é…ç½®æˆ– webapps çš„web.xmlã€‚
   */
  SecurityUtils.setSecurityManager(securityManager);


  /*
   è·å–å½“å‰æ‰§è¡Œçš„ç”¨æˆ·ï¼ˆå®‰å…¨é¢†åŸŸå…¬è®¤çš„å‘½å Subjectï¼‰
   ç‹¬ç«‹åº”ç”¨ç¨‹åºä¸­çš„ getSubject() è°ƒç”¨å¯èƒ½åŸºäºç‰¹å®šäºåº”ç”¨ç¨‹åºä½ç½®çš„ç”¨æˆ·æ•°æ®è¿”å› Subjectï¼Œè€Œåœ¨æœåŠ¡å™¨ç¯å¢ƒ(ä¾‹å¦‚webåº”ç”¨ç¨‹åº)ä¸­ï¼Œå®ƒåŸºäºä¸å½“å‰çº¿ç¨‹æˆ–ä¼ å…¥è¯·æ±‚ç›¸å…³çš„ç”¨æˆ·æ•°æ®è·å– Subjectã€‚
   */
  Subject currentUser = SecurityUtils.getSubject();

  /*
   ä½¿ç”¨ Session åšä¸€äº›äº‹æƒ…(ä¸éœ€è¦webæˆ–EJBå®¹å™¨!!)
   è¯¥ Session æ˜¯ä¸€ä¸ªç‰¹å®šäº Shiro çš„å®ä¾‹ï¼Œå®ƒæä¾›äº†å¸¸è§„ HttpSession æ‰€æä¾›çš„å¤§éƒ¨åˆ†å†…å®¹ï¼Œä½†ä¹Ÿæä¾›äº†ä¸€äº›é¢å¤–çš„å¥½å¤„ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆå¤§çš„åŒºåˆ«: å®ƒä¸éœ€è¦HTTPç¯å¢ƒ!
   å¦‚æœåœ¨ web åº”ç”¨ç¨‹åºä¸­éƒ¨ç½²ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šè¯å°†åŸºäº HttpSessionã€‚ä½†æ˜¯ï¼Œåœ¨é web ç¯å¢ƒä¸­ï¼Œæ¯”å¦‚è¿™ä¸ªç®€å•çš„å¿«é€Ÿå…¥é—¨ï¼ŒShiroé»˜è®¤æƒ…å†µä¸‹ä¼šè‡ªåŠ¨ä½¿ç”¨å®ƒçš„ä¼ä¸šä¼šè¯ç®¡ç†ã€‚
   è¿™æ„å‘³ç€æ‚¨å¯ä»¥åœ¨ä»»ä½•å±‚çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ç›¸åŒçš„APIï¼Œè€Œä¸ç®¡éƒ¨ç½²ç¯å¢ƒå¦‚ä½•ã€‚è¿™æ‰“å¼€äº†ä¸€ä¸ªå…¨æ–°çš„åº”ç”¨ç¨‹åºä¸–ç•Œï¼Œå› ä¸ºä»»ä½•éœ€è¦ä¼šè¯çš„åº”ç”¨ç¨‹åºéƒ½ä¸éœ€è¦å¼ºåˆ¶ä½¿ç”¨HttpSessionæˆ–EJBæœ‰çŠ¶æ€ä¼šè¯beanã€‚
   è€Œä¸”ï¼Œä»»ä½•å®¢æˆ·æœºæŠ€æœ¯ç°åœ¨éƒ½å¯ä»¥å…±äº«ä¼šè¯æ•°æ®ã€‚
   */
  Session session = currentUser.getSession();
  session.setAttribute("hello", "conanan");
  String value = (String) session.getAttribute("hello");
  if (value.equals("conanan")) {
    log.info("è·å–åˆ°æ­£ç¡®çš„å€¼! [" + value + "]");
  }

  /*
   ç™»å½•å½“å‰ç”¨æˆ·ï¼Œå¯ä»¥æ£€æŸ¥è§’è‰²å’Œæƒé™
   æˆ‘ä»¬åªèƒ½å¯¹å·²çŸ¥ç”¨æˆ·è¿›è¡Œè¿™äº›æ£€æŸ¥ã€‚ä¸Šé¢çš„ Subject å®ä¾‹è¡¨ç¤ºå½“å‰ç”¨æˆ·ï¼Œä½†æ˜¯è°æ˜¯å½“å‰ç”¨æˆ·å‘¢?å—¯ï¼Œä»–ä»¬æ˜¯åŒ¿åçš„â€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œç›´åˆ°ä»–ä»¬è‡³å°‘ç™»å½•ä¸€æ¬¡ã€‚è®©æˆ‘ä»¬è¿™æ ·åš:
   */
  if (!currentUser.isAuthenticated()) {
    UsernamePasswordToken token = new UsernamePasswordToken("lonestarr", "vespa",true);
    // token.setRememberMe(true); //ä¹Ÿå¯ä»¥åœ¨æ„é€ ä¸­ç¬¬ä¸‰ä¸ªå‚æ•°æ·»åŠ 
    try {
      // ç™»å½•å¤±è´¥éœ€æ•è·å¼‚å¸¸
      currentUser.login(token);
    } catch (UnknownAccountException uae) {
      log.info("è¯¥ç”¨æˆ·ä¸å­˜åœ¨ï¼š" + token.getPrincipal());
    } catch (IncorrectCredentialsException ice) {
      log.info(token.getPrincipal() + "è´¦å·çš„å¯†ç é”™è¯¯!");
    } catch (LockedAccountException lae) {
      log.info("è´¦å·" + token.getPrincipal() + " å·²è¢«é”.  " +
               "è¯·è”ç³»ç®¡ç†å‘˜è§£é”.");
    }
    // åœ¨è¿™é‡Œæ•è·æ›´å¤šçš„å¼‚å¸¸(å¯èƒ½æ˜¯ç‰¹å®šäºæ‚¨çš„åº”ç”¨ç¨‹åºçš„è‡ªå®šä¹‰å¼‚å¸¸?)
    // å¯å‚è€ƒhttps://shiro.apache.org/static/1.5.1/apidocs/org/apache/shiro/authc/AuthenticationException.html
    catch (AuthenticationException ae) {
      //unexpected condition?  error?
    }
  }

  /*
   ç”¨æˆ·ç™»é™†åå¯ä»¥åšå¦‚ä¸‹äº‹æƒ…ï¼šå‘Šè¯‰æˆ‘ä»¬å½“å‰ç”¨æˆ·æ˜¯è°ï¼Œè¾“å‡ºä»–çš„ identifying principalï¼ˆä¸»è¦èº«ä»½ï¼Œåœ¨è¿™ä¸ªç¤ºä¾‹ä¸­æ˜¯ usernameï¼‰
   */
  log.info("ç”¨æˆ· [" + currentUser.getPrincipal() + "] ç™»é™†æˆåŠŸ.");

  /*
   æµ‹è¯•æ˜¯å¦æœ‰è¿™ä¸ªè§’è‰²
   */
  if (currentUser.hasRole("schwartz")) {
    log.info("May the Schwartz be with you!");
  } else {
    log.info("Hello, mere mortal.");
  }

  /*
   æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°ä»–ä»¬æ˜¯å¦æœ‰æƒé™å¯¹æŸç§ç±»å‹çš„å®ä½“é‡‡å–è¡ŒåŠ¨:
   */
  if (currentUser.isPermitted("lightsaber:wield")) {
    log.info("You may use a lightsaber ring.  Use it wisely.");
  } else {
    log.info("Sorry, lightsaber rings are for schwartz masters only.");
  }

  /*
   æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸€ä¸ªéå¸¸å¼ºå¤§çš„å®ä¾‹çº§æƒé™æ£€æŸ¥â€”â€”æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦æœ‰èƒ½åŠ›è®¿é—®æŸä¸ªç±»å‹çš„ç‰¹å®šå®ä¾‹:
   */
  if (currentUser.isPermitted("winnebago:drive:eagle5")) {
    log.info("You are permitted to 'drive' the winnebago with license plate (id) 'eagle5'.  " + "Here are the keys - have fun!");
  } else {
    log.info("Sorry, you aren't allowed to drive the 'eagle5' winnebago!");
  }

  /*
   é€€å‡ºã€‚åˆ é™¤æ‰€æœ‰æ ‡è¯†ä¿¡æ¯å¹¶ä½¿å…¶ä¼šè¯æ— æ•ˆã€‚
   å› ä¸º remember æ ‡ç¤ºé€šå¸¸ä½¿ç”¨cookieè¡¨ç¤ºï¼Œå®šå‘åˆ°ç™»é™†é¡µé¢ï¼Œè®¾ç½®åŒåcookieä¸”maxAgeä¸º0
   */
  currentUser.logout();

  System.exit(0);
}
```

æ‰§è¡Œåçš„æ—¥å¿—

```
a.s.s.m.AbstractValidatingSessionManager : Enabling session validation scheduler...
t.c.s.ShiroQuickstartApplication         : è·å–åˆ°æ­£ç¡®çš„å€¼! [conanan]
t.c.s.ShiroQuickstartApplication         : ç”¨æˆ· [lonestarr] ç™»é™†æˆåŠŸ.
t.c.s.ShiroQuickstartApplication         : May the Schwartz be with you!
t.c.s.ShiroQuickstartApplication         : You may use a lightsaber ring.  Use it wisely.
t.c.s.ShiroQuickstartApplication         : You are permitted to 'drive' the winnebago with license plate (id) 'eagle5'.  Here are the keys - have fun!
```





## Web åº”ç”¨ç¨‹åº

::: tip æ–‡æ¡£&åšå®¢

é›†æˆ Shiro åˆ° SpringBoot çš„[å®˜æ–¹æ–‡æ¡£](https://shiro.apache.org/spring-boot.html)ã€‚è¿˜æ˜¯ç”¨è°·æ­Œæœå‡ºæ¥çš„ï¼Œå®˜æ–¹æ–‡æ¡£æ²¡æ‰¾åˆ°å…¥å£ï¼ŒğŸ‘´ä½›äº†ã€‚[GitHub](https://github.com/apache/shiro) çš„ samples ä¹Ÿæœ‰è¯¦ç»†ä»£ç ã€‚è¿™ç¯‡[åšå®¢](https://developer.okta.com/blog/2017/07/13/apache-shiro-spring-boot)ä¹Ÿä¸é”™ã€‚

:::

Shiro å¯¹ Spring webåº”ç”¨ç¨‹åºæä¾›äº†ä¸€æµçš„æ”¯æŒã€‚åœ¨ web åº”ç”¨ç¨‹åºä¸­ï¼Œæ‰€æœ‰å¯è®¿é—® Shiro çš„ web è¯·æ±‚éƒ½å¿…é¡»ç»è¿‡ä¸€ä¸ª**ä¸» Shiro è¿‡æ»¤å™¨**ã€‚è¿™ä¸ªè¿‡æ»¤å™¨æœ¬èº«éå¸¸å¼ºå¤§ï¼Œå…è®¸åŸºäºä»»ä½• URL è·¯å¾„è¡¨è¾¾å¼æ‰§è¡Œ**è‡ªå®šä¹‰è¿‡æ»¤å™¨é“¾**ã€‚

### å¼•å…¥ä¾èµ–

```xml
<dependency>
  <groupId>org.apache.shiro</groupId>
  <artifactId>shiro-spring-boot-web-starter</artifactId>
  <version>1.5.1</version><!--å“”äº†ç‹—ï¼Œå®˜ç½‘æ–‡æ¡£ç»™çš„1.5.2-SNAPSHOTä½†æ˜¯å¹¶æ²¡æœ‰å­˜å…¥Mavenåº“é‡Œ-->
</dependency>
```

-   Maven: org.apache.shiro:shiro-cache:1.5.1
-   Maven: org.apache.shiro:shiro-config-core:1.5.1
-   Maven: org.apache.shiro:shiro-config-ogdl:1.5.1
-   Maven: org.apache.shiro:shiro-core:1.5.1
-   Maven: org.apache.shiro:shiro-crypto-cipher:1.5.1
-   Maven: org.apache.shiro:shiro-crypto-core:1.5.1
-   Maven: org.apache.shiro:shiro-crypto-hash:1.5.1
-   Maven: org.apache.shiro:shiro-event:1.5.1
-   Maven: org.apache.shiro:shiro-lang:1.5.1
-   Maven: org.apache.shiro:shiro-spring:1.5.1
-   Maven: org.apache.shiro:shiro-web:1.5.1
-   Maven: org.apache.shiro:shiro-spring-boot-starter:1.5.1



### æä¾› Realm å®ç°

**å…·ä½“Realmå®ç°éœ€è¦é‡å†™ä¸€ä¸ªç±»ï¼Œä¸”éœ€å°†å…¶Beanæ”¾å…¥é…ç½®ç±»ä¸­**

```java
/**
 * AuthorizingRealm ç»§æ‰¿äº†é¡¶çº§æŠ½è±¡ç±» AuthenticatingRealmï¼ˆä»…ç”¨äºç™»é™†è®¤è¯ï¼‰
 */
public class UserRealm extends AuthorizingRealm {

    /**
     * è®¤è¯
     *
     */
    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {
        System.out.println("è®¤è¯ï¼Œè¯¦ç»†è§è®¤è¯æ­¥éª¤");

        return null;
    }

    /**
     * æˆæƒ
     */
    @Override
    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) {
        System.out.println("æˆæƒ");
        return null;
    }


}
```

å¦‚æœæœªå®šä¹‰`Realm` beanï¼Œåˆ™é»˜è®¤æƒ…å†µä¸‹ï¼Œ`ShiroAutoConfiguration`å°†æä¾›`IniRealm`å®ç°ï¼Œè¯¥å®ç°æœŸæœ›åœ¨`src/main/resources`æˆ–`src/main/resources/META-INF`ä¸­æ‰¾åˆ°`shiro.ini`æ–‡ä»¶ã€‚



### ShiroFilterChainDefinition

**å¯å†™åœ¨ä¸€ä¸ªé…ç½®ç±»ä¸­**

å®ƒå°†æŠŠä»»ä½•åº”ç”¨ç¨‹åºç‰¹å®šçš„è·¯å¾„**æ˜ å°„åˆ°ç»™å®šçš„è¿‡æ»¤å™¨**ï¼Œä»¥å…è®¸**ä¸åŒçš„è·¯å¾„ä¸åŒçº§åˆ«çš„è®¿é—®**ã€‚

```java
@Bean
public ShiroFilterChainDefinition shiroFilterChainDefinition() {
    DefaultShiroFilterChainDefinition chainDefinition = new DefaultShiroFilterChainDefinition();
    
    // logged in users with the 'admin' role
    chainDefinition.addPathDefinition("/admin/**", "authc, roles[admin]");
    
    // logged in users with the 'document:read' permission
    chainDefinition.addPathDefinition("/docs/**", "authc, perms[document:read]");
    
    // all other paths require a logged in user
    chainDefinition.addPathDefinition("/**", "authc");
    return chainDefinition;
}
```

å¦‚æœæˆ‘ä»¬ä¸å®šä¹‰ä¸€ä¸ªShiroFilterChainDefinition beanï¼Œé‚£ä¹ˆæ¡†æ¶å°†ä¿æŠ¤æ‰€æœ‰è·¯å¾„å¹¶å°†ç™»å½•URLè®¾ç½®ä¸ºlogin.jspã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘application.yml ä¸­æ·»åŠ ä»¥ä¸‹æ¡ç›®æ¥æ›´æ”¹è¿™ä¸ªé»˜è®¤çš„ç™»å½•URLå’Œå…¶ä»–é»˜è®¤å€¼

```yaml
shiro:
  loginUrl: /login.html
  successUrl: /index.html
  unauthorizedUrl: /login.html
```





### Shiro æ³¨è§£

åœ¨ç‹¬ç«‹åº”ç”¨ç¨‹åºå’Œ web åº”ç”¨ç¨‹åºä¸­ï¼Œå¯ä»¥ Shiro çš„æ³¨é‡Šç”¨äºå®‰å…¨æ£€æŸ¥ï¼Œæ›¿ä»£`ShiroFilterChainDefinition`ï¼Œä¾‹å¦‚ï¼Œ`@RequiresRoles`ã€`@requirespermission`ç­‰ï¼Œè¿™äº›æ³¨é‡Šåœ¨ä¸Šè¿°ä¸¤ä¸ªå¯åŠ¨ç¨‹åºä¸­éƒ½æ˜¯è‡ªåŠ¨å¯ç”¨çš„ã€‚åªéœ€æ³¨é‡Šæ‚¨çš„æ–¹æ³•ä»¥ä¾¿ä½¿ç”¨å®ƒä»¬ã€‚

```java
@RequiresPermissions("document:read")
public void readDocument() {
    // ...
}
```

Shiro æ³¨è§£å®Œå…¨æ”¯æŒåœ¨`@Controller`ç±»ä¸­ä½¿ç”¨

```java
@Controller
public class AccountInfoController {

    @RequiresRoles("admin")
    @RequestMapping("/admin/config")
    public String adminConfig(Model model) {
        return "view";
    }
}
```

`ShiroFilterChainDefinition` beanä»ç„¶éœ€è¦è‡³å°‘ä¸€ä¸ªå®šä¹‰æ‰èƒ½å·¥ä½œï¼ŒäºŒé€‰ä¸€ï¼šè¦ä¹ˆé…ç½®æ‰€æœ‰è·¯å¾„ä¸ºå¯é€šè¿‡`anon`è¿‡æ»¤å™¨è®¿é—®ï¼Œè¦ä¹ˆé…ç½®ä¸€ä¸ªè¿‡æ»¤å™¨ä¸ºå…è®¸æ¨¡å¼ï¼Œä¾‹å¦‚`authcBasic[per]`ã€‚

```java
@Bean
public ShiroFilterChainDefinition shiroFilterChainDefinition() {
    DefaultShiroFilterChainDefinition chainDefinition = new DefaultShiroFilterChainDefinition();
    // logged in users with the 'admin' role
    chainDefinition.addPathDefinition("/admin/**", "authc, roles[admin]");
    
    // logged in users with the 'document:read' permission
    chainDefinition.addPathDefinition("/docs/**", "authc, perms[document:read]");
    
    // all other paths require a logged in user
    chainDefinition.addPathDefinition("/**", "authc");
    return chainDefinition;
}
```





## ç‹¬ç«‹åº”ç”¨ç¨‹åºâ€”â˜ ï¸

### å¼•å…¥ä¾èµ–

```xml
<dependency>
  <groupId>org.apache.shiro</groupId>
  <artifactId>shiro-spring-boot-starter</artifactId>
  <version>1.5.1</version><!--å“”äº†ç‹—ï¼Œå®˜ç½‘æ–‡æ¡£ç»™çš„1.5.2-SNAPSHOTä½†æ˜¯å¹¶æ²¡æœ‰å­˜å…¥Mavenåº“é‡Œ-->
</dependency>
```



### è‡ªå®šä¹‰ Realm ç±»

ä½¿ç”¨`shiro-spring-boot-starter`å‰©ä¸‹çš„æƒŸä¸€å·¥ä½œå°±æ˜¯é…ç½®ä¸€ä¸ªRealm

```java
@Bean
public Realm realm() {
  // ...
}
```

è®¾ç½®Shiroçš„æœ€ç®€å•çš„æ–¹æ³•ï¼Œè¿™æ ·æ‰€æœ‰çš„`SecurityUtils.*`æ–¹æ³•åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½èƒ½å·¥ä½œï¼Œå°±æ˜¯ä½¿`SecurityManager` beanæˆä¸ºä¸€ä¸ªé™æ€å•ä¾‹ã€‚ä¸è¦åœ¨webåº”ç”¨ç¨‹åºä¸­è¿™æ ·åšâ€”â€”è¯·å‚é˜…ä¸Šé¢çš„webåº”ç”¨ç¨‹åºéƒ¨åˆ†ã€‚

```java
@Autowired
private SecurityManager securityManager;
    
 @PostConstruct
 private void initStaticSecurityManager() {
     SecurityUtils.setSecurityManager(securityManager);
 }
```

å…¶ä»–è‡ªå·±çœ‹æ–‡æ¡£





## è¿‡æ»¤å™¨

æŸ¥çœ‹`org.apache.shiro.web.filter.mgt.DefaultFilter`è¯¥æšä¸¾

```java
public enum DefaultFilter {

  anon(AnonymousFilter.class),
  authc(FormAuthenticationFilter.class),
  authcBasic(BasicHttpAuthenticationFilter.class),
  authcBearer(BearerHttpAuthenticationFilter.class),
  logout(LogoutFilter.class),
  noSessionCreation(NoSessionCreationFilter.class),
  perms(PermissionsAuthorizationFilter.class),
  port(PortFilter.class),
  rest(HttpMethodPermissionFilter.class),
  roles(RolesAuthorizationFilter.class),
  ssl(SslFilter.class),
  user(UserFilter.class);
  // ...
}
```

### anon ğŸ”¥

**æ— éœ€æ‰§è¡Œä»»ä½•ç±»å‹çš„å®‰å…¨æ€§æ£€æŸ¥å³å¯ç›´æ¥è®¿é—®è·¯å¾„çš„ç­›é€‰å™¨ã€‚**

æ­¤è¿‡æ»¤å™¨ä¸»è¦åœ¨**æ’é™¤ç­–ç•¥**ä¸­æœ‰ç”¨ï¼Œåœ¨è¯¥ç­–ç•¥ä¸­ï¼Œæ‚¨å·²å®šä¹‰äº†urlæ¨¡å¼ä»¥è¦æ±‚ä¸€å®šçš„å®‰å…¨çº§åˆ«ï¼Œä½†ä¹Ÿè®¸è¯¥æ¨¡å¼ä¸­ä»…URLçš„å­é›†åº”å…è®¸ä»»ä½•è®¿é—®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æœ‰ç½‘ç«™çš„ä»…ç”¨æˆ·éƒ¨åˆ†ï¼Œåˆ™å¯èƒ½éœ€è¦è¦æ±‚è¯¥éƒ¨åˆ†ä¸­çš„ä»»ä½•URLè®¿é—®éƒ½å¿…é¡»æ¥è‡ªç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ã€‚

è¿™æ˜¯IniShiroFilteré…ç½®

```
[urls] 
/user/** = authc
```

ä½†æ˜¯ï¼Œå¦‚æœæ‚¨å¸Œæœ›`/user/signup/**`å¯¹ä»»ä½•äººéƒ½å¯ç”¨ï¼Œåˆ™å¿…é¡»æ’é™¤è¯¥è·¯å¾„ï¼Œå› ä¸ºå®ƒæ˜¯ä¸Šè¿°IniShiroFilteré…ç½®çš„è·¯å¾„çš„å­é›†ã€‚

```
/user/signup/** = anon
/user/** = authc
```





### authc ğŸ”¥

è¦æ±‚**å¯¹è¯·æ±‚ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯**ä»¥ä½¿è¯·æ±‚ç»§ç»­ï¼Œå¦‚æœæœªé€šè¿‡ï¼Œåˆ™é€šè¿‡å°†ç”¨æˆ·é‡å®šå‘åˆ°æ‚¨é…ç½®çš„`loginUrl`æ¥å¼ºåˆ¶ç”¨æˆ·ç™»å½•ã€‚

æ­¤è¿‡æ»¤å™¨æ„é€ ä¸€ä¸ªUsernamePasswordTokenï¼Œå…¶ä¸­åŒ…å«åœ¨usernameï¼Œpasswordå’ŒRememberMeè¯·æ±‚å‚æ•°ä¸­æ‰¾åˆ°çš„å€¼ã€‚
ç„¶åï¼Œå®ƒè°ƒç”¨Subject.loginï¼ˆusernamePasswordTokenï¼‰ï¼Œæœ‰æ•ˆåœ°è‡ªåŠ¨æ‰§è¡Œç™»å½•å°è¯•ã€‚
è¯·æ³¨æ„ï¼Œä»…å½“isLoginSubmissionï¼ˆrequestï¼Œresponseï¼‰ä¸ºtrueæ—¶ï¼Œæ‰ä¼šå°è¯•ç™»å½•ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå½“è¯·æ±‚æ˜¯é’ˆå¯¹loginUrlä¸”ä¸ºPOSTè¯·æ±‚æ—¶ï¼Œæ‰ä¼šå°è¯•ç™»å½•ã€‚


å¦‚æœç™»å½•å¤±è´¥ï¼Œåˆ™å°†åœ¨AuthenticationKeyå±æ€§é¡¹ä¸‹å°†å¾—åˆ°çš„AuthenticationExceptionå®Œå…¨é™å®šçš„ç±»åè®¾ç½®ä¸ºè¯·æ±‚å±æ€§ã€‚
è¯¥FQCNå¯ç”¨ä½œi18né”®æˆ–æŸ¥æ‰¾æœºåˆ¶ï¼Œä»¥å‘ç”¨æˆ·è§£é‡Šå…¶ç™»å½•å°è¯•å¤±è´¥çš„åŸå› ï¼ˆä¾‹å¦‚ï¼Œæ— å¸æˆ·ï¼Œå¯†ç é”™è¯¯ç­‰ï¼‰ã€‚

å¦‚æœæ‚¨å¸Œæœ›å¤„ç†èº«ä»½éªŒè¯éªŒè¯å¹¶ä½¿ç”¨è‡ªå·±çš„ä»£ç ç™»å½•ï¼Œè¯·è€ƒè™‘æ”¹ç”¨PassThruAuthenticationFilterï¼Œå®ƒå…è®¸å¯¹loginUrlçš„è¯·æ±‚ç›´æ¥ä¼ é€’åˆ°åº”ç”¨ç¨‹åºçš„ä»£ç ã€‚



### perms ğŸ”¥

å¦‚æœå½“å‰ç”¨æˆ·å…·æœ‰æ˜ å°„å€¼æŒ‡å®šçš„æƒé™ï¼Œåˆ™å…è®¸è®¿é—®çš„è¿‡æ»¤å™¨ï¼›å¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šæ‰€æœ‰æƒé™ï¼Œåˆ™æ‹’ç»è®¿é—®çš„è¿‡æ»¤å™¨ã€‚æ¨èï¼



### roles

å¦‚æœå½“å‰ç”¨æˆ·å…·æœ‰æ˜ å°„å€¼æŒ‡å®šçš„è§’è‰²ï¼Œåˆ™å…è®¸è®¿é—®çš„è¿‡æ»¤å™¨ï¼›å¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šæ‰€æœ‰è§’è‰²ï¼Œåˆ™æ‹’ç»è®¿é—®çš„è¿‡æ»¤å™¨ã€‚ä½†ä¸æ¨èï¼



### logout ğŸ”¥

ç®€å•è¿‡æ»¤å™¨ï¼Œæ¥æ”¶åˆ°è¯·æ±‚åï¼Œå°†ç«‹å³æ³¨é”€å½“å‰æ­£åœ¨æ‰§è¡Œçš„ `Subject`ï¼Œç„¶åå°†å…¶é‡å®šå‘åˆ°å·²é…ç½®çš„ `redirectUrl`ã€‚



### rest ğŸ”¥

ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå®ƒå°†HTTPè¯·æ±‚çš„æ–¹æ³•ï¼ˆä¾‹å¦‚GETï¼ŒPOSTç­‰ï¼‰è½¬æ¢ä¸ºç›¸åº”çš„åŠ¨ä½œï¼ˆåŠ¨è¯ï¼‰ï¼Œå¹¶ä½¿ç”¨è¯¥åŠ¨è¯æ¥æ„é€ å°†è¢«æ£€æŸ¥ä»¥ç¡®å®šè®¿é—®æƒé™çš„æƒé™ã€‚æä¾›æ­¤è¿‡æ»¤å™¨ä¸»è¦æ˜¯ä¸ºäº†æ”¯æŒRESTç¯å¢ƒï¼Œåœ¨è¯¥ç¯å¢ƒä¸­ï¼Œè¯·æ±‚çš„ç±»å‹ï¼ˆæ–¹æ³•ï¼‰è½¬æ¢ä¸ºå¯¹ä¸€ä¸ªæˆ–å¤šä¸ªèµ„æºæ‰§è¡Œçš„æ“ä½œã€‚æ­¤èŒƒä¾‹ä¸Shiroçš„ä½¿ç”¨æƒé™è¿›è¡Œè®¿é—®æ§åˆ¶çš„æ¦‚å¿µå¾ˆå¥½åœ°é…åˆä½¿ç”¨ï¼Œå¯ä»¥è½»æ¾åœ°æ‰§è¡Œæƒé™æ£€æŸ¥ã€‚

è¯¥è¿‡æ»¤å™¨çš„åŠŸèƒ½å¦‚ä¸‹ï¼š

1.  å‘ç°ä¼ å…¥çš„HTTPè¯·æ±‚çš„æ–¹æ³•ï¼ˆGETï¼ŒPOSTï¼ŒPUTï¼ŒDELETEç­‰ï¼‰ã€‚

2.  è¯¥æ–¹æ³•è¢«ç¿»è¯‘æˆæ›´â€œæ˜“äºåº”ç”¨â€çš„åŠ¨è¯ï¼Œä¾‹å¦‚â€œåˆ›å»ºâ€ï¼Œâ€œç¼–è¾‘â€ï¼Œâ€œåˆ é™¤â€ç­‰ã€‚

3.  è¯¥åŠ¨è¯å°†é™„åŠ åˆ°å½“å‰åŒ¹é…è·¯å¾„çš„ä»»ä½•å·²é…ç½®æƒé™ã€‚

4.  å¦‚æœå½“å‰çš„Subjectè¢«å…è®¸æ‰§è¡Œå·²è§£å†³çš„æ“ä½œï¼Œåˆ™å…è®¸è¯·æ±‚ç»§ç»­ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœå®šä¹‰äº†ä»¥ä¸‹è¿‡æ»¤å™¨é“¾ï¼Œâ€œrestâ€æ˜¯èµ‹äºˆè¯¥ç±»çš„è¿‡æ»¤å™¨å®ä¾‹çš„åç§°ï¼š

```
/user/** = rest[user]
```

ç„¶åï¼Œå¯¹`/user/1234`çš„ HTTP GETè¯·æ±‚å°†è½¬æ¢ä¸ºæ„é€ çš„æƒé™`user:read`ï¼ˆGET æ˜ å°„åˆ° read æ“ä½œï¼‰å¹¶æ‰§è¡Œæƒé™æ£€æŸ¥`Subject.isPermitted("user:read")`ä»¥ä¾¿å…è®¸è¯·æ±‚ç»§ç»­ã€‚

åŒæ ·ï¼Œåˆ°`/user`çš„HTTP POSTä¼šè½¬æ¢ä¸ºæ„é€ çš„æƒé™`user:create`ï¼ˆPOST æ˜ å°„åˆ° create æ“ä½œï¼‰å¹¶æ‰§è¡Œæƒé™æ£€æŸ¥`Subject.isPermitted("user:create")`ä»¥ä¾¿å…è®¸è¯·æ±‚ç»§ç»­ã€‚

ä»¥ä¸‹ä¸ºæ˜ å°„æ–¹æ³•ï¼š

| HTTP Method | Mapped Action | Example Permission | Runtime Check |
| ----------- | ------------- | ------------------ | ------------- |
| head        | read          | perm1              | perm1:read    |
| get         | read          | perm2              | perm2:read    |
| put         | update        | perm3              | perm3:update  |
| post        | create        | perm4              | perm4:create  |
| delete      | delete        | perm5              | perm5:delete  |
| mkcol       | create        | perm6              | perm6:create  |
| options     | read          | perm7              | perm7:read    |
| trace       | read          | perm8              | perm8:read    |



### user

å¦‚æœè®¿é—®è€…æ˜¯å·²çŸ¥ç”¨æˆ·ï¼ˆå®šä¹‰ä¸ºå…·æœ‰å·²çŸ¥ principalï¼‰ï¼Œåˆ™å…è®¸è®¿é—®èµ„æºçš„è¿‡æ»¤å™¨ã€‚è¿™æ„å‘³ç€å°†å…è®¸é€šè¿‡â€œ**è®°ä½æˆ‘**â€åŠŸèƒ½é€šè¿‡èº«ä»½éªŒè¯æˆ–è®°ä½çš„ä»»ä½•ç”¨æˆ·è®¿é—®æ­¤è¿‡æ»¤å™¨ã€‚å¦‚æœè®¿é—®è€…ä¸æ˜¯å·²çŸ¥ç”¨æˆ·ï¼Œé‚£ä¹ˆä»–ä»¬å°†è¢«é‡å®šå‘åˆ° `loginUrl`



### authcBasic ğŸ”¥

è¦æ±‚å¯¹è¯·æ±‚ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ä»¥ä½¿è¯·æ±‚ç»§ç»­ï¼Œå¦åˆ™ï¼Œè¦æ±‚ç”¨æˆ·é€šè¿‡ç‰¹å®šäºHTTP Basicåè®®çš„è´¨è¯¢ç™»å½•ã€‚æˆåŠŸç™»å½•åï¼Œå…è®¸ä»–ä»¬ç»§ç»­è®¿é—®è¯·æ±‚çš„èµ„æº/ URLã€‚


æ­¤å®ç°æ˜¯RFC 2617ä¸­åŸºæœ¬HTTPèº«ä»½éªŒè¯è§„èŒƒçš„â€œclean roomâ€ Javaå®ç°ã€‚


åŸºæœ¬èº«ä»½éªŒè¯åŠŸèƒ½å¦‚ä¸‹ï¼š

1.  è¦æ±‚æä¾›éœ€è¦èº«ä»½éªŒè¯çš„èµ„æºã€‚

2.  æœåŠ¡å™¨ä»¥401å“åº”çŠ¶æ€ç­”å¤ï¼Œè®¾ç½®WWW-Authenticateæ ‡å¤´ï¼Œå¹¶é€šçŸ¥ç”¨æˆ·è¾“å…¥èµ„æºéœ€è¦è®¤è¯çš„é¡µé¢å†…å®¹ã€‚

3.  ä»æœåŠ¡å™¨æ”¶åˆ°æ­¤WWW-Authenticateè´¨è¯¢åï¼Œå®¢æˆ·ç«¯å°†é‡‡ç”¨ç”¨æˆ·åå’Œå¯†ç ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºä»¥ä¸‹æ ¼å¼ï¼š`username:password`

4.  ç„¶åï¼Œæ­¤ä»¤ç‰Œä»¥base 64ç¼–ç ã€‚

5.  ç„¶åï¼Œå®¢æˆ·ç«¯ä½¿ç”¨ä»¥ä¸‹ header å‘é€å¯¹åŒä¸€èµ„æºçš„å¦ä¸€ä¸ªè¯·æ±‚ï¼š

    ```
    Authorization: Basic
    Base64_encoded_username_and_password
    ```

ä»…å½“å‘å‡ºè¯·æ±‚çš„ä¸»é¢˜æœªé€šè¿‡èº«ä»½éªŒè¯æ—¶ï¼Œæ‰ä¼šè°ƒç”¨onAccessDeniedï¼ˆServletRequestï¼ŒServletResponseï¼‰æ–¹æ³•



### authcBearer

è¦æ±‚å¯¹è¯·æ±‚ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ä»¥ä½¿è¯·æ±‚ç»§ç»­ï¼Œå¦åˆ™ï¼Œè¦æ±‚ç”¨æˆ·é€šè¿‡ç‰¹å®šäºHTTP Beareråè®®çš„è´¨è¯¢ç™»å½•ã€‚
æˆåŠŸç™»å½•åï¼Œå…è®¸ä»–ä»¬ç»§ç»­è®¿é—®è¯·æ±‚çš„èµ„æº/ URLã€‚



### noSessionCreation

ä¸€ä¸ªPathMatchingFilterï¼Œå®ƒå°†åœ¨è¯·æ±‚æœŸé—´ç¦æ­¢åˆ›å»ºæ–°çš„ä¼šè¯ã€‚è¿™æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„è¿‡æ»¤å™¨ï¼Œå¯ä»¥æ”¾ç½®åœ¨ä»»ä½•è¿‡æ»¤å™¨é“¾çš„å‰é¢ï¼Œè¿™äº›è¿‡æ»¤å™¨é“¾å¯èƒ½ä¼šå¯¼è‡´RESTï¼ŒSOAPæˆ–å…¶ä»–ä¸æ‰“ç®—å‚ä¸ä¼šè¯çš„æœåŠ¡è°ƒç”¨ã€‚


æ­¤ç­›é€‰å™¨å¯ç”¨ä»¥ä¸‹è¡Œä¸ºï¼š

1.  å¦‚æœåœ¨è°ƒç”¨æ­¤è¿‡æ»¤å™¨æ—¶æŸä¸ªSubjectè¿˜æ²¡æœ‰Sessionï¼Œåˆ™æ­¤è¿‡æ»¤å™¨å°†æœ‰æ•ˆåœ°ç¦ç”¨å¯¹subject.getSessionï¼ˆï¼‰å’Œsubject.getSessionï¼ˆtrueï¼‰çš„æ‰€æœ‰è°ƒç”¨ã€‚å¦‚æœåœ¨è¯·æ±‚æœŸé—´è°ƒç”¨äº†ä»»ä½•ä¸€ä¸ªï¼Œåˆ™å°†å¼•å‘å¼‚å¸¸ã€‚

2.  ä½†æ˜¯ï¼Œå¦‚æœ Subject åœ¨è°ƒç”¨æ­¤è¿‡æ»¤å™¨ä¹‹å‰å·²ç»å…·æœ‰å…³è”çš„ä¼šè¯ï¼Œè¦ä¹ˆæ˜¯å› ä¸ºå®ƒæ˜¯åœ¨åº”ç”¨ç¨‹åºçš„å¦ä¸€éƒ¨åˆ†ä¸­åˆ›å»ºçš„ï¼Œè¦ä¹ˆæ˜¯åœ¨åˆ›å»ºçš„é“¾ä¸­æ›´é«˜çš„è¿‡æ»¤å™¨ï¼Œåˆ™æ­¤è¿‡æ»¤å™¨æ— æ•ˆã€‚

æœ€åï¼Œå¯¹subject.getSessionï¼ˆfalseï¼‰çš„è°ƒç”¨å°†ä¸å—å½±å“ï¼Œå¹¶ä¸”åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½å¯ä»¥åœ¨ä¸å—åˆ°å½±å“çš„æƒ…å†µä¸‹è¿›è¡Œè°ƒç”¨ã€‚



### port

è¦æ±‚è¯·æ±‚ä½äºç‰¹å®šç«¯å£ä¸Šçš„è¿‡æ»¤å™¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™é‡å®šå‘åˆ°è¯¥ç«¯å£ä¸Šçš„ç›¸åŒURLã€‚

ç¤ºä¾‹é…ç½®

```
[filters]
port.port = 80
```

```
[urls]
/some/path/** = port
# override for just this path:
/another/path/** = port[8080]
```



### ssl

è¦æ±‚é€šè¿‡SSLè¿›è¡Œè¯·æ±‚çš„è¿‡æ»¤å™¨ã€‚å¦‚æœåœ¨å·²é…ç½®çš„æœåŠ¡å™¨ç«¯å£å’Œ`request.isSecure()`ä¸Šæ”¶åˆ°è¯·æ±‚ï¼Œåˆ™å…è®¸è®¿é—®ã€‚
å¦‚æœä»»ä¸€æ¡ä»¶ä¸ºå‡ï¼Œåˆ™è¿‡æ»¤å™¨é“¾å°†ä¸ä¼šç»§ç»­ã€‚ç«¯å£å±æ€§é»˜è®¤ä¸º443ï¼Œå¹¶ä¸”è¿˜ä¿è¯è¯·æ±‚æ–¹æ¡ˆå§‹ç»ˆä¸ºâ€œ httpsâ€ï¼ˆç«¯å£80é™¤å¤–ï¼Œç«¯å£80ä¿ç•™äº†â€œ httpâ€æ–¹æ¡ˆï¼‰ã€‚

ç¤ºä¾‹é…ç½®

```
[urls]
/secure/path/** = ssl
```





## Tag

å‚è€ƒ[æ–‡æ¡£](https://shiro.apache.org/web.html#Web-JSP%2FGSPTagLibrary)ï¼Œä»‹ç»çš„å¾ˆè¯¦ç»†







## Caching

å¯ç”¨ç¼“å­˜åªéœ€æä¾› `CacheManager` bean

```java
@Bean
protected CacheManager cacheManager() {
    return new MemoryConstrainedCacheManager();
}
```





## Configuration Properties

| Key                                               | Default Value | Description                                                  |
| :------------------------------------------------ | :------------ | :----------------------------------------------------------- |
| shiro.enabled                                     | `true`        | Enables Shiroâ€™s Spring module                                |
| shiro.web.enabled                                 | `true`        | Enables Shiroâ€™s Spring web module                            |
| shiro.annotations.enabled                         | `true`        | Enables Spring support for Shiroâ€™s annotations               |
| shiro.sessionManager.deleteInvalidSessions        | `true`        | Remove invalid session from session storage                  |
| shiro.sessionManager.sessionIdCookieEnabled       | `true`        | Enable session ID to cookie, for session tracking            |
| shiro.sessionManager.sessionIdUrlRewritingEnabled | `true`        | Enable session URL rewriting support                         |
| shiro.userNativeSessionManager                    | `false`       | If enabled Shiro will manage the HTTP sessions instead of the container |
| shiro.sessionManager.cookie.name                  | `JSESSIONID`  | Session cookie name                                          |
| **shiro.sessionManager.cookie.maxAge**            | `-1`          | Session cookie max age                                       |
| **shiro.sessionManager.cookie.domain**            | null          | Session cookie domain                                        |
| **shiro.sessionManager.cookie.path**              | null          | Session cookie path                                          |
| shiro.sessionManager.cookie.secure                | `false`       | Session cookie secure flag                                   |
| **shiro.rememberMeManager.cookie.name**           | `rememberMe`  | RememberMe cookie name                                       |
| **shiro.rememberMeManager.cookie.maxAge**         | one year      | RememberMe cookie max age                                    |
| **shiro.rememberMeManager.cookie.domain**         | null          | RememberMe cookie domain                                     |
| **shiro.rememberMeManager.cookie.path**           | null          | RememberMe cookie path                                       |
| **shiro.rememberMeManager.cookie.secure**         | `false`       | RememberMe cookie secure flag                                |
| **shiro.loginUrl**                                | `/login.jsp`  | Login URL used when unauthenticated users are redirected to login page |
| **shiro.successUrl**                              | `/`           | Default landing page after a user logs in (if alternative cannot be found in the current session) |
| **shiro.unauthorizedUrl**                         | null          | Page to redirect user to if they are unauthorized (403 page) |