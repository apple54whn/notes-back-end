---
title: SpringDataJPA æŸ¥è¯¢
date: 2020-12-23 23:52:19
permalink: /pages/433412/
categories:
  - Spring
  - SpringDataJPA
tags:
  - 
---



# SpringDataJPA æŸ¥è¯¢

## ç¯å¢ƒå‡†å¤‡

### Maven æˆ– Gradle é¡¹ç›®

ä¸å¤šé€¼é€¼äº†ï¼ŒIDEA ç›´æ¥åˆ›å»ºå³å¯ã€‚é€‰æ‹© spring-boot-starter-data-jpaã€mysql-connector-javaï¼Œå…¶ä½™æ ¹æ®éœ€è¦é€‰æ‹©

```gradle
plugins {
	id 'org.springframework.boot' version '2.4.1'
	id 'io.spring.dependency-management' version '1.0.10.RELEASE'
	id 'java'
}
```





### application.yml

```yml
server:
  port: 10000
spring:
  datasource:
    url: jdbc:mysql:///demo?characterEncoding=utf-8&serverTimezone=GMT%2B8
    username: root
    password: w111111
  jpa:
    show-sql: true # æ˜¾ç¤ºsql
    #generate-ddl: true # è‡ªåŠ¨ç”Ÿæˆè¡¨ï¼Œæœ‰åˆ™ä¸ç”Ÿæˆï¼ˆç”Ÿäº§ä¸­ä¸æ¨èï¼Œæµ‹è¯•hibernateä¸­å¯ä»¥ç”¨spring.jpa.hibernateå®ƒçš„é…ç½®ï¼‰
    properties: # jpa å®ç°æ¡†æ¶ç‰¹æœ‰çš„å±æ€§é…ç½®
      hibernate: # å¦‚ hibernate
        format_sql: false
    hibernate:
      #è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“è¡¨ï¼Œæ³¨æ„ï¼Œå­—æ®µçš„å¢åˆ ä¸ä¼šè§¦å‘ï¼
      #create: ç¨‹åºè¿è¡Œæ—¶åˆ›å»ºæ•°æ®åº“è¡¨ï¼ˆå¦‚æœæœ‰è¡¨ï¼Œå…ˆåˆ é™¤è¡¨å†åˆ›å»ºï¼‰
      #update: ç¨‹åºè¿è¡Œæ—¶åˆ›å»ºè¡¨ï¼ˆå¦‚æœæœ‰è¡¨ï¼Œä¸ä¼šåˆ›å»ºè¡¨ï¼Œæ³¨æ„ä¿®æ”¹å­—æ®µä¹Ÿä¸ä¼šé‡æ–°ç”Ÿæˆè¡¨ï¼‰
      #create-drop: ä¸€èˆ¬ç”¨åœ¨æµ‹è¯•, ä¼šè¯å®Œæˆåæ¸…ç©ºè¡¨
      #none: é»˜è®¤å€¼ï¼Œä¸ä¼šåˆ›å»ºè¡¨ï¼Œåç»­ä¼šç½®ä¸º none
      ddl-auto: create
```



### Entity

```java
@Getter
@Setter
@ToString
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity // å‘Šè¯‰ JPA è¿™æ˜¯ä¸€ä¸ªå®ä½“ç±»
@Table(name = "article")//@Tableå»ºç«‹äº†å®ä½“ç±»å’Œæ•°æ®è¡¨çš„å…³ç³»ï¼ŒnameæŒ‡å‘è¡¨åã€‚å½“ç±»åå’Œæ•°æ®è¡¨çš„åä¸€è‡´æ—¶ï¼Œæ­¤æ³¨è§£å¯çœç•¥
public class Article {

    //æ ‡è¯†è¿™æ˜¯ä¸»é”®å­—æ®µ
    @Id
    //æŒ‡å®šä¸»é”®ç”Ÿæˆç­–ç•¥ï¼ŒGenerationType.IDENTITYå°±æ˜¯å¯¹åº”åˆ°mysqlä¸­çš„æ•°æ®è‡ªå¢ç­–ç•¥
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long aid;

    //ä½¿ç”¨@Columnæ˜ å°„ç±»çš„å±æ€§å’Œæ•°æ®è¡¨çš„å­—æ®µå…³ç³»ï¼ŒnameæŒ‡å®šè¡¨ä¸­çš„å­—æ®µåã€‚å½“ç±»çš„å±æ€§åå’Œæ•°æ®è¡¨çš„å­—æ®µåä¸€è‡´æ—¶ï¼Œæ­¤æ³¨è§£å¯çœç•¥
    @Column(name = "author")
    private String author;

    private String title;

    private LocalDateTime createTime;
}
```





### Repository

æ³¨æ„ï¼šJpaSpecificationExecutor åœ¨åŠ¨æ€æŸ¥è¯¢ä¸­ä¼šç”¨åˆ°

```java
public interface UserRepository extends JpaRepository<User, Long>, JpaSpecificationExecutor<Article> {
}
```



## JPA æ¥å£é»˜è®¤å¢åˆ æ”¹æŸ¥ ğŸ”¥

```java
@DataJpaTest
// DataJpaTestã€MybatisTest ä¼šé»˜è®¤ä½¿ç”¨å…¶æµ‹è¯•æ•°æ®æºæ›¿ä»£ï¼Œè‹¥è¦ä½¿ç”¨è‡ªå·±é…ç½®çš„ï¼Œéœ€è¦æ·»åŠ å¦‚ä¸‹æ³¨è§£
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
public class ArticleRepositoryTest {

    @Autowired
    private ArticleRepository articleRepository;


    @Test
    // @Test å•å…ƒæµ‹è¯•é»˜è®¤æµ‹è¯•å®Œä¼šå›æ»šï¼Œå¯ä»¥é…ç½®å¦‚ä¸‹æ³¨è§£æ¥é˜²æ­¢å›æ»š
    @Rollback(false)
    void testSave() {
        Article article = Article.builder().title("ç‰›é€¼").author("ç”·å“¥").createTime(LocalDateTime.now()).build();
        // save çš„ entity ä¸­è‹¥ id ä¸º nullï¼Œåˆ™persistï¼Œå¦åˆ™æ‰§è¡Œmergeï¼ˆæºç ä¸­ä¼šè¿›è¡Œidæ˜¯å¦ä¸ºnullç­‰åˆ¤æ–­ï¼‰
        Article save = articleRepository.save(article);
        Assertions.assertNotNull(save);
    }


    @Test
    // @Test å•å…ƒæµ‹è¯•é»˜è®¤æµ‹è¯•å®Œä¼šå›æ»šï¼Œå¯ä»¥é…ç½®å¦‚ä¸‹æ³¨è§£æ¥é˜²æ­¢å›æ»š
    @Rollback(false)
    void testUpdate() {
        Article article = Article.builder().aid(2L).author("ç”·ç¥").build();
        // save çš„ entity ä¸­è‹¥ id ä¸º nullï¼Œåˆ™persistï¼Œå¦åˆ™æ‰§è¡Œmergeï¼ˆæºç ä¸­ä¼šè¿›è¡Œidæ˜¯å¦ä¸ºnullç­‰åˆ¤æ–­ï¼‰
        // æ³¨æ„ï¼Œå®ä½“ç±»ä¸­å½“å‰ä¸ºnullçš„å­—æ®µä¹Ÿä¼šè¢«æ›´æ–°ä¸ºnullï¼Œå¯ä»¥é…ç½®æ›´æ”¹è¯¥ç­–ç•¥ï¼ŒDynamicUpdateç­–ç•¥
        Article save = articleRepository.save(article);
        Assertions.assertNotNull(save);
    }


    @Test
    // @Test å•å…ƒæµ‹è¯•é»˜è®¤æµ‹è¯•å®Œä¼šå›æ»šï¼Œå¯ä»¥é…ç½®å¦‚ä¸‹æ³¨è§£æ¥é˜²æ­¢å›æ»š
    @Rollback(false)
    void testDelete() {
        Article article = Article.builder().aid(3L).author("ç”·ç¥").build();
        articleRepository.deleteById(2L);// æ ¹æ®idæŸ¥è¯¢ååˆ é™¤

        articleRepository.delete(article);// æ ¹æ®entityä¸­idæŸ¥è¯¢ååˆ é™¤

        ArrayList<Article> articles = new ArrayList<>();
        articles.add(Article.builder().aid(3L).author("ç”·ç¥").build());

        articleRepository.deleteAll(articles);

        articleRepository.deleteInBatch(articles);// ä¼˜åŒ–åçš„ï¼Œç»§æ‰¿ JpaRepository

        articleRepository.deleteAll();

        articleRepository.deleteAllInBatch();// ä¼˜åŒ–åçš„ï¼Œç»§æ‰¿ JpaRepository
    }



    @Test
    public void testFind() {
        // æ ¹æ®id/idsæŸ¥è¯¢
        Optional<Article> articleOptional = articleRepository.findById(5L);
        Assertions.assertNotNull(articleOptional.orElse(null));

        ArrayList<Long> articleIds = new ArrayList<>();
        articleIds.add(1L);
        articleRepository.findAllById(articleIds);

        // æ˜¯å¦å­˜åœ¨
        boolean b1 = articleRepository.existsById(5L);// åº•å±‚æ ¹æ®æ•°é‡æ˜¯å¦ == 1
        boolean b2 = articleRepository.exists(Example.of(Article.builder().author("ç”·ç¥").build()));


        // å•ä¸ªæ¡ä»¶æŸ¥è¯¢
        Optional<Article> one = articleRepository.findOne(Example.of(Article.builder().author("ç”·ç¥").build()));

        // å¤šä¸ªæ¡ä»¶æŸ¥è¯¢ï¼Œå¯åˆ†é¡µã€æ’åº
        articleRepository.findAll(Example.of(Article.builder().author("ç”·å“¥").build()));


        // ç»Ÿè®¡
        long count1 = articleRepository.count();
        long count2 = articleRepository.count(Example.of(Article.builder().author("ç”·ç¥").build()));

    }

    /**
     * ç«‹å³åŠ è½½
     */
    @Test
    void testFindOne() {
        Optional<Article> articleOptional = articleRepository.findOne(Example.of(Article.builder().aid(6L).build()));
        Assertions.assertNotNull(articleOptional.orElse(null));
    }

    /**
     * å»¶è¿ŸåŠ è½½ï¼ˆæ‡’åŠ è½½ï¼‰ï¼Œåº•å±‚è°ƒç”¨getReferenceï¼Œä½¿ç”¨çš„æ—¶å€™æ‰æŸ¥è¯¢æ•°æ®åº“ã€‚ä¸€èˆ¬ä½¿ç”¨è¿™ä¸ªï¼ˆåºåˆ—åŒ–æ—¶å¯èƒ½æŠ¥é”™ï¼Ÿï¼‰
     * IDEAéœ€è¦å»æ‰Debugä¸­å‡ ä¸ªé€‰é¡¹æ‰å¯ä»¥çœ‹åˆ°
     */
    @Test
    void testGetOne() {
        Article article = articleRepository.getOne(6L);
        Assertions.assertNotNull(article);
    }
}
```





## DQMâ€”æ–¹æ³•å å•è¡¨æŸ¥è¯¢ã€åˆ é™¤ ğŸ”¥

### ç®€ä»‹ã€äº†è§£ã€‘

Spring Data JPA çš„æœ€å¤§ç‰¹è‰²æ˜¯åˆ©ç”¨**æ–¹æ³•åå®šä¹‰æŸ¥è¯¢æ–¹æ³•**ï¼ˆDefining Query Methodsï¼‰æ¥åš CRUD æ“ä½œã€‚è¿˜èƒ½ç»Ÿä¸€æ–¹æ³•åçš„è¯­ä¹‰ã€å‘½åè§„èŒƒã€‚DQM æ˜¯**å¯¹ JPQL æ›´æ·±å±‚æ¬¡å°è£…ï¼Ÿ**ã€‚DQM è¯­æ³•å…±æœ‰ 2 ç§ï¼š

*   @Query æ‰‹åŠ¨åœ¨æ–¹æ³•ä¸Šå®šä¹‰

*   ç›´æ¥é€šè¿‡æ–¹æ³•åå°±å¯ä»¥å®ç°ï¼ˆæœ¬èŠ‚é‡ç‚¹ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼‰ğŸ”¥

    ä¼šæ ¹æ®**å…ˆåé¡ºåº**ä¼ å‚ï¼ï¼åç§°æ— æ‰€è°“å…·ä½“çš„å…³é”®å­—

```java
public interface ArticleRepository extends JpaRepository<Article, Long> {

    Article findByAuthorAndTitle(String author, String title);

    // è¿”å› stream
    Stream<Article> streamByAuthorAndTitleLike(String author, String title);

    // find ä¹Ÿå¯ä»¥ç›´æ¥è¿”å› stream
    Stream<Article> findByAuthorAndTitleLike(String author, String title);

}
```

```java
@DataJpaTest
// DataJpaTestã€MybatisTest ä¼šé»˜è®¤ä½¿ç”¨å…¶æµ‹è¯•æ•°æ®æºæ›¿ä»£ï¼Œè‹¥è¦ä½¿ç”¨è‡ªå·±é…ç½®çš„ï¼Œéœ€è¦æ·»åŠ å¦‚ä¸‹æ³¨è§£
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
public class ArticleMethodRepositoryTest {

    @Autowired
    private ArticleRepository articleRepository;


    @Test
    void testFindByAuthorAndTitle() {
        Article article = articleRepository.findByAuthorAndTitle("ç”·å“¥", "ç‰›é€¼");
        Assertions.assertNotNull(article);
    }


    @Test
    void testFindByAuthorAndTitleLike() {
        // è¿”å› stream
        Stream<Article> articleStream1 = articleRepository.streamByAuthorAndTitleLike("ç”·å“¥", "ç‰›%");
        articleStream1.forEach(System.out::println);
        System.out.println("-------------");

        Stream<Article> articleStream2 = articleRepository.streamByAuthorAndTitleLike("ç”·å“¥", "ç‰›_");
        articleStream2.forEach(System.out::println);
        System.out.println("-------------");

        Stream<Article> articleStream3 = articleRepository.findByAuthorAndTitleLike("ç”·å“¥", "ç‰›%");
        articleStream3.forEach(System.out::println);


    }
}
```



### é€‰æ‹©æ€§æš´éœ²æ–¹æ³•ã€æŒæ¡ã€‘

æ–¹æ³•ååªéœ€ç»§æ‰¿ Repository æ¥å£æˆ–å…¶å­ç±»æ¥å£å³å¯ä½¿ç”¨ï¼Œå› ä¸ºæœ€ç»ˆçš„å®ç°ç±»éƒ½æ˜¯ SimpleJpaRepositoryã€‚ä¹Ÿå¯ä»¥æ ¹æ®æ­¤åŸç†æ¥**é€‰æ‹©æ€§æš´éœ²æ–¹æ³•**ã€‚

```java
@NoRepositoryBean
interface MyBaseRepository<T, ID extends Serializable> extends Repository<T, ID> {
    T findOne(ID id); 
    T save(T entity);
}

interface UserRepository extends MyBaseRepository<User, Long> {
     User findByEmailAddress(String emailAddress);
}
```

è¿™æ ·åœ¨ Service å±‚å°±åªæœ‰ findOneã€saveã€findByEmailAddress è¿™ 3 ä¸ªæ–¹æ³•å¯ä»¥è°ƒç”¨ï¼Œä¸ä¼šæœ‰æ›´å¤šæ–¹æ³•äº†ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ SimpleJpaRepository é‡Œé¢ä»»æ„å·²ç»å®ç°çš„æ–¹æ³•åšé€‰æ‹©æ€§æš´éœ²ã€‚



### æ–¹æ³•çš„æŸ¥è¯¢ç­–ç•¥è®¾ç½® ã€â˜ ï¸ã€‘

ç›®å‰åœ¨å®é™…ç”Ÿäº§ä¸­è¿˜æ²¡æœ‰é‡åˆ°è¦ä¿®æ”¹é»˜è®¤ç­–ç•¥çš„æƒ…å†µã€‚è¿™ä¸¤ç§æ–¹å¼åˆ‡æ¢è§„åˆ™å³**æ–¹æ³•çš„æŸ¥è¯¢ç­–ç•¥è®¾ç½®**å¯ä»¥é€šè¿‡ @EnableJpaRepositories æ³¨è§£æ¥é…ç½®æ–¹æ³•çš„æŸ¥è¯¢ç­–ç•¥

```java
@EnableJpaRepositories(queryLookupStrategy= QueryLookupStrategy.Key.CREATE_IF_NOT_FOUND)
// æ”¾åœ¨é…ç½®ç±»ä¸Šå³å¯ï¼Œå¦‚@SpringBootApplication
```

å…¶ä¸­ï¼ŒQueryLookupStrategy.Key çš„å€¼å…± 3 ä¸ªï¼Œå…·ä½“å¦‚ä¸‹ï¼š

-   **Create**ï¼šç›´æ¥æ ¹æ®æ–¹æ³•åè¿›è¡Œåˆ›å»ºï¼Œè§„åˆ™æ˜¯æ ¹æ®æ–¹æ³•åç§°çš„æ„é€ è¿›è¡Œå°è¯•ï¼Œä¸€èˆ¬çš„æ–¹æ³•æ˜¯ä»æ–¹æ³•åä¸­åˆ é™¤ç»™å®šçš„ä¸€ç»„å·²çŸ¥å‰ç¼€ï¼Œå¹¶è§£æè¯¥æ–¹æ³•çš„å…¶ä½™éƒ¨åˆ†ã€‚å¦‚æœæ–¹æ³•åä¸ç¬¦åˆè§„åˆ™ï¼Œå¯åŠ¨çš„æ—¶å€™ä¼šæŠ¥å¼‚å¸¸ï¼Œè¿™ç§æƒ…å†µå¯ä»¥ç†è§£ä¸ºï¼Œå³ä½¿é…ç½®äº† @Query ä¹Ÿæ˜¯æ²¡æœ‰ç”¨çš„ã€‚
-   **USE_DECLARED_QUERY**ï¼šå£°æ˜æ–¹å¼åˆ›å»ºï¼Œå¯åŠ¨çš„æ—¶å€™ä¼šå°è¯•æ‰¾åˆ°ä¸€ä¸ªå£°æ˜çš„æŸ¥è¯¢ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å°†æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œå¯ä»¥ç†è§£ä¸ºå¿…é¡»é…ç½® @Queryã€‚
-   **CREATE_IF_NOT_FOUND**ï¼šè¿™ä¸ªæ˜¯**é»˜è®¤**çš„ï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œå¯ä»¥ç†è§£ä¸ºè¿™æ˜¯ä»¥ä¸Š 2 ç§æ–¹å¼çš„å…¼å®¹ç‰ˆã€‚å…ˆç”¨å£°æ˜æ–¹å¼ï¼ˆ@Queryï¼‰è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸æ–¹æ³•ç›¸åŒ¹é…çš„æŸ¥è¯¢ï¼Œé‚£ç”¨ Create çš„æ–¹æ³•ååˆ›å»ºè§„åˆ™åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢ï¼›è¿™ä¸¤è€…éƒ½ä¸æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œå¯åŠ¨å°±ä¼šæŠ¥é”™ã€‚



### DQM è¯­æ³•ã€æŒæ¡ã€‘

è¯­æ³•ï¼šå¸¦æŸ¥è¯¢åŠŸèƒ½çš„æ–¹æ³•åç”±**æŸ¥è¯¢ç­–ç•¥ï¼ˆå…³é”®å­—ï¼‰**+ **æŸ¥è¯¢å­—æ®µ** + ä¸€äº›**é™åˆ¶æ€§æ¡ä»¶**ç»„æˆã€‚å¦‚ä¸‹ï¼š

```java
interface PersonRepository extends Repository<User, Long> {

    // and çš„æŸ¥è¯¢å…³ç³»
    List<User> findByEmailAddressAndLastname(EmailAddress emailAddress, String lastname);

    // åŒ…å« distinct å»é‡ï¼Œor çš„ sql è¯­æ³•
    List<User> findDistinctPeopleByLastnameOrFirstname(String lastname, String firstname);

    // æ ¹æ® lastname å­—æ®µæŸ¥è¯¢å¿½ç•¥å¤§å°å†™
    List<User> findByLastnameIgnoreCase(String lastname);

    // æ ¹æ® lastname å’Œ firstname æŸ¥è¯¢ equal å¹¶ä¸”å¿½ç•¥å¤§å°å†™
    List<User> findByLastnameAndFirstnameAllIgnoreCase(String lastname, String firstname); 

    // å¯¹æŸ¥è¯¢ç»“æœæ ¹æ® lastname æ’åºï¼Œæ­£åº
    List<User> findByLastnameOrderByFirstnameAsc(String lastname);

    // å¯¹æŸ¥è¯¢ç»“æœæ ¹æ® lastname æ’åºï¼Œå€’åº
    List<User> findByLastnameOrderByFirstnameDesc(String lastname);

}

```

ä¸‹é¢è¡¨æ ¼æ˜¯ä¸€ä¸ªæˆ‘ä»¬åœ¨ä¸Šé¢ DQM æ–¹æ³•è¯­æ³•é‡Œå¸¸ç”¨çš„å…³é”®å­—åˆ—è¡¨

| **Keyword**       | **Sample**                               | **JPQL**                                                     |
| ----------------- | ---------------------------------------- | ------------------------------------------------------------ |
| And               | findByLastnameAndFirstname               | â€¦ where x.lastname = ?1 and x.firstname = ?2                 |
| Or                | findByLastnameOrFirstname                | â€¦ where x.lastname = ?1 or x.firstname = ?2                  |
| Is,Equals         | findByFirstnameIs, findByFirstnameEquals | â€¦ where x.firstname = ?1                                     |
| Between           | findByStartDateBetween                   | â€¦ where x.startDate between ?1 and ?2                        |
| LessThan          | findByAgeLessThan                        | â€¦ where x.age < ?1                                           |
| LessThanEqual     | findByAgeLessThanEqual                   | â€¦ where x.age â‡ ?1                                           |
| GreaterThan       | findByAgeGreaterThan                     | â€¦ where x.age > ?1                                           |
| GreaterThanEqual  | findByAgeGreaterThanEqual                | â€¦ where x.age >= ?1                                          |
| After             | findByStartDateAfter                     | â€¦ where x.startDate > ?1                                     |
| Before            | findByStartDateBefore                    | â€¦ where x.startDate < ?1                                     |
| IsNull            | findByAgeIsNull                          | â€¦ where x.age is null                                        |
| IsNotNull,NotNull | findByAge(Is)NotNull                     | â€¦ where x.age not null                                       |
| Like              | findByFirstnameLike                      | â€¦ where x.firstname like ?1                                  |
| NotLike           | findByFirstnameNotLike                   | â€¦ where x.firstname not like ?1                              |
| StartingWith      | findByFirstnameStartingWith              | â€¦ where x.firstname like ?1 (parameter bound with appended %) |
| EndingWith        | findByFirstnameEndingWith                | â€¦ where x.firstname like ?1 (parameter bound with prepended %) |
| Containing        | findByFirstnameContaining                | â€¦ where x.firstname like ?1 (parameter bound wrapped in %)   |
| OrderBy           | findByAgeOrderByLastnameDesc             | â€¦ where x.age = ?1 order by x.lastname desc                  |
| Not               | findByLastnameNot                        | â€¦ where x.lastname <> ?1                                     |
| In                | findByAgeIn(Collection ages)             | â€¦ where x.age in ?1                                          |
| NotIn             | findByAgeNotIn(Collection age)           | â€¦ where x.age not in ?1                                      |
| TRUE              | findByActiveTrue()                       | â€¦ where x.active = true                                      |
| FALSE             | findByActiveFalse()                      | â€¦ where x.active = false                                     |
| IgnoreCase        | findByFirstnameIgnoreCase                | â€¦ where UPPER(x.firstame) = UPPER(?1)                        |

ç»¼ä¸Šï¼Œæ€»ç»“ 3 ç‚¹ç»éªŒï¼š

-   æ–¹æ³•åçš„è¡¨è¾¾å¼é€šå¸¸æ˜¯å®ä½“å±æ€§è¿æ¥è¿ç®—ç¬¦çš„ç»„åˆï¼Œå¦‚ Andã€orã€Betweenã€LessThanã€GreaterThanã€Like ç­‰å±æ€§è¿æ¥è¿ç®—è¡¨è¾¾å¼ï¼Œä¸åŒçš„æ•°æ®åº“ï¼ˆNoSQLã€MySQLï¼‰å¯èƒ½äº§ç”Ÿçš„æ•ˆæœä¸ä¸€æ ·ï¼Œå¦‚æœé‡åˆ°é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å¼€ SQL æ—¥å¿—è§‚å¯Ÿã€‚
-   **IgnoreCase å¯ä»¥é’ˆå¯¹å•ä¸ªå±æ€§**ï¼ˆå¦‚ findByLastnameIgnoreCase(â€¦)ï¼‰ï¼Œ**ä¹Ÿå¯ä»¥é’ˆå¯¹æŸ¥è¯¢æ¡ä»¶é‡Œé¢æ‰€æœ‰çš„å®ä½“**å±æ€§å¿½ç•¥å¤§å°å†™ï¼ˆæ‰€æœ‰å±æ€§å¿…é¡»åœ¨ String æƒ…å†µä¸‹ï¼Œå¦‚ findByLastnameAndFirstnameAllIgnoreCase(â€¦)ï¼‰ã€‚
-   OrderBy å¯ä»¥åœ¨æŸäº›å±æ€§çš„æ’åºä¸Šæä¾›æ–¹å‘ï¼ˆAsc æˆ– Descï¼‰ï¼Œç§°ä¸º**é™æ€æ’åº**ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸€ä¸ªæ–¹ä¾¿çš„**å‚æ•° Sort å®ç°æŒ‡å®šå­—æ®µçš„åŠ¨æ€æ’åº**çš„æŸ¥è¯¢æ–¹æ³•ï¼ˆå¦‚ repository.findAll(Sort.by(Sort.Direction.ASC, "myField"))ï¼‰ã€‚

ä¸Šé¢çš„è¡¨æ ¼è™½ç„¶å¤§å¤šæ˜¯ find å¼€å¤´çš„æ–¹æ³•ï¼Œé™¤æ­¤ä¹‹å¤–ï¼ŒJPA è¿˜æ”¯æŒreadã€getã€queryã€**stream**ã€**count**ã€**exists**ã€**delete**ã€**remove**ç­‰å‰ç¼€ï¼Œå¦‚å­—é¢æ„æ€ä¸€æ ·ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ countã€deleteã€remove çš„ä¾‹å­ï¼Œå…¶ä»–å‰ç¼€å¯ä»¥ä¸¾ä¸€åä¸‰

```java
interface UserRepository extends CrudRepository<User, Long> {

    long countByLastname(String lastname);//æŸ¥è¯¢æ€»æ•°

    long deleteByLastname(String lastname);//æ ¹æ®ä¸€ä¸ªå­—æ®µè¿›è¡Œåˆ é™¤æ“ä½œï¼Œå¹¶è¿”å›åˆ é™¤è¡Œæ•°

    List<User> removeByLastname(String lastname);//æ ¹æ®Lastnameåˆ é™¤ä¸€å †User,å¹¶è¿”å›åˆ é™¤çš„User

}

```

æœ‰çš„æ—¶å€™éšç€ç‰ˆæœ¬çš„æ›´æ–°ï¼Œä¹Ÿä¼šæœ‰æ›´å¤šçš„è¯­æ³•æ”¯æŒï¼Œæˆ–è€…ä¸åŒçš„ç‰ˆæœ¬è¯­æ³•å¯èƒ½ä¹Ÿä¸ä¸€æ ·ï¼Œæˆ‘ä»¬é€šè¿‡æºç æ¥çœ‹ä¸€ä¸‹ä¸Šé¢è¯´çš„å‡ ç§è¯­æ³•

org.springframework.data.repository.query.parser.PartTree æŸ¥çœ‹ç›¸å…³æºç çš„é€»è¾‘å’Œå¤„ç†æ–¹æ³•ã€‚å…³é”®æºç å¦‚ä¸‹ï¼š

![image-20201221231903631](../images/image-20201221231903631.png)

![image-20201221231925371](../images/image-20201221231925371.png)

æ ¹æ®æºç æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ†æå‡ºæ¥ï¼Œquery method åŒ…å«å…¶ä»–çš„è¡¨è¾¾å¼ï¼Œæ¯”å¦‚ findã€countã€deleteã€exist ç­‰å…³é”®å­—åœ¨ by ä¹‹å‰é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…

![image-20201221231937909](../images/image-20201221231937909.png)

![image-20201221231947226](../images/image-20201221231947226.png)

ç”±æ­¤å¯çŸ¥ï¼Œæˆ‘ä»¬æ–¹æ³•ä¸­çš„å…³é”®å­—ä¸æ˜¯ä¹±å¡«çš„ï¼Œæ˜¯æšä¸¾å¸®æˆ‘ä»¬å®šä¹‰å¥½çš„ã€‚æšä¸¾ç±» Type æºç æ ¼å¼åŒ–åå¦‚ä¸‹ï¼š

```java
public static enum Type {

    BETWEEN(2, new String[]{"IsBetween", "Between"}),

    IS_NOT_NULL(0, new String[]{"IsNotNull", "NotNull"}),

    IS_NULL(0, new String[]{"IsNull", "Null"}),

    LESS_THAN(new String[]{"IsLessThan", "LessThan"}),

    LESS_THAN_EQUAL(new String[]{"IsLessThanEqual", "LessThanEqual"}),

    GREATER_THAN(new String[]{"IsGreaterThan", "GreaterThan"}),

    GREATER_THAN_EQUAL(new String[]{"IsGreaterThanEqual", "GreaterThanEqual"}),

    BEFORE(new String[]{"IsBefore", "Before"}),

    AFTER(new String[]{"IsAfter", "After"}),

    NOT_LIKE(new String[]{"IsNotLike", "NotLike"}),

    LIKE(new String[]{"IsLike", "Like"}),

    STARTING_WITH(new String[]{"IsStartingWith", "StartingWith", "StartsWith"}),

    ENDING_WITH(new String[]{"IsEndingWith", "EndingWith", "EndsWith"}),

    IS_NOT_EMPTY(0, new String[]{"IsNotEmpty", "NotEmpty"}),

    IS_EMPTY(0, new String[]{"IsEmpty", "Empty"}),

    NOT_CONTAINING(new String[]{"IsNotContaining", "NotContaining", "NotContains"}),

    CONTAINING(new String[]{"IsContaining", "Containing", "Contains"}),

    NOT_IN(new String[]{"IsNotIn", "NotIn"}),

    IN(new String[]{"IsIn", "In"}),

    NEAR(new String[]{"IsNear", "Near"}),

    WITHIN(new String[]{"IsWithin", "Within"}),

    REGEX(new String[]{"MatchesRegex", "Matches", "Regex"}),

    EXISTS(0, new String[]{"Exists"}),

    TRUE(0, new String[]{"IsTrue", "True"}),

    FALSE(0, new String[]{"IsFalse", "False"}),

    NEGATING_SIMPLE_PROPERTY(new String[]{"IsNot", "Not"}),

    SIMPLE_PROPERTY(new String[]{"Is", "Equals"});

    //....
}

```

çœ‹æºç å°±å¯ä»¥çŸ¥é“æ¡†æ¶æ”¯æŒäº†å“ªäº›é€»è¾‘å…³é”®å­—ï¼Œæ¯”å¦‚ NotInã€Likeã€Inã€Exists ç­‰ï¼Œæœ‰çš„æ—¶å€™æ¯”æŸ¥æ–‡æ¡£å’Œåšå®¢éƒ½å‡†ç¡®ã€è¿˜å¿«





### ç‰¹å®šç±»å‹çš„å‚æ•°ï¼šSort Pageableã€æŒæ¡ã€‘

Sort æºç ï¼ˆSpring Boot 2.4.1 ç‰ˆæœ¬æ¨èç”¨å¦‚ä¸‹æ–¹å¼ï¼Œæ„é€ æ–¹æ³•éƒ½å·²ç»ç§æœ‰äº†ï¼‰

```java
/**
	 * Creates a new {@link Sort} for the given {@link Order}s.
	 *
	 * @param orders must not be {@literal null}.
	 * @return
	 */
public static Sort by(Order... orders) {

    Assert.notNull(orders, "Orders must not be null!");

    return new Sort(Arrays.asList(orders));
}
```

Pageable åœ¨æŸ¥è¯¢çš„æ—¶å€™å¯ä»¥å®ç°**åˆ†é¡µ**æ•ˆæœå’Œ**åŠ¨æ€æ’åº**åŒé‡æ•ˆæœ

ä¸‹é¢ä»£ç å®šä¹‰äº†æ ¹æ® Lastname æŸ¥è¯¢ User çš„åˆ†é¡µå’Œæ’åºçš„å®ä¾‹ï¼Œæ­¤æ®µä»£ç æ˜¯åœ¨ UserRepository æ¥å£é‡Œé¢å®šä¹‰çš„æ–¹æ³•

```java
public interface UserRepository extends JpaRepository<User, Long> {
    //æ ¹æ®åˆ†é¡µå‚æ•°æŸ¥è¯¢Userï¼Œè¿”å›ä¸€ä¸ªå¸¦åˆ†é¡µç»“æœçš„Page(ä¸‹ä¸€è¯¾æ—¶è¯¦è§£)å¯¹è±¡ï¼ˆæ–¹æ³•ä¸€ï¼‰
    Page<User> findByLastname(String lastname, Pageable pageable);

    //æˆ‘ä»¬æ ¹æ®åˆ†é¡µå‚æ•°è¿”å›ä¸€ä¸ªSliceçš„userç»“æœï¼ˆæ–¹æ³•äºŒï¼‰
    Slice<User> findByLastname(String lastname, Pageable pageable);

    //æ ¹æ®æ’åºç»“æœè¿”å›ä¸€ä¸ªListï¼ˆæ–¹æ³•ä¸‰ï¼‰
    List<User> findByLastname(String lastname, Sort sort);

    //æ ¹æ®åˆ†é¡µå‚æ•°è¿”å›ä¸€ä¸ªListå¯¹è±¡ï¼ˆæ–¹æ³•å››ï¼‰
    List<User> findByLastname(String lastname, Pageable pageable);

}
```

ã€æŒæ¡ã€‘**æ–¹æ³•ä¸€**ï¼šå…è®¸å°† org.springframework.data.domain.Pageable å®ä¾‹ä¼ é€’ç»™æŸ¥è¯¢æ–¹æ³•ï¼Œå°†åˆ†é¡µå‚æ•°æ·»åŠ åˆ°é™æ€å®šä¹‰çš„æŸ¥è¯¢ä¸­ï¼Œé€šè¿‡ Page è¿”å›çš„ç»“æœå¾—çŸ¥å¯ç”¨çš„å…ƒç´ å’Œé¡µé¢çš„æ€»æ•°ã€‚è¿™ç§åˆ†é¡µæŸ¥è¯¢æ–¹æ³•å¯èƒ½æ˜¯**æ˜‚è´µ**çš„ï¼ˆä¼šé»˜è®¤æ‰§è¡Œä¸€æ¡ **count** çš„ SQL è¯­å¥ï¼‰ï¼Œæ‰€ä»¥ç”¨çš„æ—¶å€™è¦è€ƒè™‘ä¸€ä¸‹ä½¿ç”¨åœºæ™¯ï¼ˆ**æ•°æ®é‡å°çš„é¡¹ç›®å¯ä»¥å°è¯•**ï¼‰ã€‚

ã€æŒæ¡ã€‘**æ–¹æ³•äºŒ**ï¼šè¿”å›ç»“æœæ˜¯ Sliceï¼Œå› ä¸ºåªçŸ¥é“æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ª Slice å¯ç”¨ï¼Œè€Œä¸çŸ¥é“ countï¼Œæ‰€ä»¥å½“æŸ¥è¯¢è¾ƒå¤§çš„ç»“æœé›†æ—¶ï¼ŒåªçŸ¥é“æ•°æ®æ˜¯è¶³å¤Ÿçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨åœ¨ä¸šåŠ¡åœºæ™¯ä¸­æ—¶**ä¸ç”¨å…³å¿ƒä¸€å…±æœ‰å¤šå°‘é¡µ**ã€‚

ã€æŒæ¡ã€‘**æ–¹æ³•ä¸‰**ï¼šå¦‚æœ**åªéœ€è¦æ’åº**ï¼Œéœ€åœ¨ org.springframework.data.domain.Sort å‚æ•°ä¸­æ·»åŠ ä¸€ä¸ªå‚æ•°ï¼Œæ­£å¦‚ä¸Šé¢çœ‹åˆ°çš„ï¼Œåªéœ€è¿”å›ä¸€ä¸ª List ä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ã€‚

ã€æŒæ¡ã€‘**æ–¹æ³•å››**ï¼š**æ’åºé€‰é¡¹ä¹Ÿé€šè¿‡ Pageable å®ä¾‹å¤„ç†**ï¼Œ**è¿”å› List** ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒPage å°†ä¸ä¼šåˆ›å»ºæ„å»ºå®é™…å®ä¾‹æ‰€éœ€çš„é™„åŠ å…ƒæ•°æ®ï¼ˆå³ä¸éœ€è¦è®¡ç®—å’ŒæŸ¥è¯¢åˆ†é¡µç›¸å…³æ•°æ®ï¼‰ï¼Œè€Œä»…ä»…ç”¨æ¥åšé™åˆ¶æŸ¥è¯¢ç»™å®šèŒƒå›´çš„å®ä½“ã€‚

é‚£ä¹ˆå¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æºç ï¼Œä¹Ÿå°±æ˜¯ Pageable çš„å®ç°ç±»

![image-20201221232003048](../images/image-20201221232003048.png)

ç”±æ­¤å¯çŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ PageRequest é‡Œé¢æä¾›çš„å‡ ä¸ª of é™æ€æ–¹æ³•ï¼ˆå¤šæ€ï¼‰ï¼Œåˆ†åˆ«æ„å»ºé¡µç ã€é¡µé¢å¤§å°ã€æ’åºç­‰ã€‚ç¤ºä¾‹ï¼š

```java
public interface UserRepository extends JpaRepository<User, Long> {

    //æŸ¥è¯¢useré‡Œé¢çš„lastname=jkçš„ç¬¬ä¸€é¡µï¼Œæ¯é¡µå¤§å°æ˜¯20æ¡ï¼›å¹¶ä¼šè¿”å›ä¸€å…±æœ‰å¤šå°‘é¡µçš„ä¿¡æ¯
    Page<User> users = userRepository.findByLastname("jk",PageRequest.of(1, 20));

    //æŸ¥è¯¢useré‡Œé¢çš„lastname=jkçš„ç¬¬ä¸€é¡µçš„20æ¡æ•°æ®ï¼Œä¸çŸ¥é“ä¸€å…±å¤šå°‘æ¡
    Slice<User>Â users = userRepository.findByLastname("jk",PageRequest.of(1, 20));

    //æŸ¥è¯¢å‡ºæ¥æ‰€æœ‰çš„useré‡Œé¢çš„lastname=jkçš„Useræ•°æ®ï¼Œå¹¶æŒ‰ç…§nameæ­£åºè¿”å›List
    List<User>Â users =Â userRepository.findByLastname("jk",Sort.by(Sort.Order.asc("name")))

        //æŒ‰ç…§createdAtå€’åºï¼ŒæŸ¥è¯¢å‰ä¸€ç™¾æ¡Useræ•°æ®
        List<User>Â users =Â userRepository
        .findByLastname("jk",PageRequest.of(0, 100, Sort.Direction.DESC, "createdAt"));
}
```



### é™åˆ¶æŸ¥è¯¢ç»“æœ First å’Œ Topã€æŒæ¡ã€‘

æœ‰çš„æ—¶å€™æˆ‘ä»¬æƒ³ç›´æ¥æŸ¥è¯¢å‰å‡ æ¡æ•°æ®ï¼Œä¹Ÿä¸éœ€è¦åŠ¨æ€æ’åºï¼Œé‚£ä¹ˆå°±å¯ä»¥ç®€å•åœ°åœ¨æ–¹æ³•åå­—ä¸­ä½¿ç”¨ First å’Œ Top å…³é”®å­—ï¼Œæ¥é™åˆ¶è¿”å›æ¡æ•°

```java
public interface UserRepository extends JpaRepository<User, Long> {

    User findFirstByOrderByLastnameAsc();

    User findTopByOrderByAgeDesc();

    List<User> findDistinctUserTop3ByLastname(String lastname, Pageable pageable);

    List<User> findFirst10ByLastname(String lastname, Sort sort);

    List<User> findTop10ByLastname(String lastname, Pageable pageable);

}
```

å…¶ä¸­ï¼š

-   æŸ¥è¯¢æ–¹æ³•åœ¨ä½¿ç”¨ First æˆ– Top æ—¶ï¼Œæ•°å€¼å¯ä»¥è¿½åŠ åˆ° First æˆ– Top åé¢ï¼ŒæŒ‡å®šè¿”å›æœ€å¤§ç»“æœçš„å¤§å°ï¼›
-   å¦‚æœæ•°å­—è¢«çœç•¥ï¼Œåˆ™å‡è®¾ç»“æœå¤§å°ä¸º 1ï¼›
-   é™åˆ¶è¡¨è¾¾å¼ä¹Ÿæ”¯æŒ Distinct å…³é”®å­—ï¼›
-   æ”¯æŒå°†ç»“æœåŒ…è£…åˆ° Optional ä¸­ï¼ˆä¸‹ä¸€è¯¾æ—¶è¯¦è§£ï¼‰ã€‚
-   å¦‚æœå°† Pageable ä½œä¸ºå‚æ•°ï¼Œä»¥ Top å’Œ First åé¢çš„æ•°å­—ä¸ºå‡†ï¼Œå³åˆ†é¡µå°†åœ¨é™åˆ¶ç»“æœä¸­åº”ç”¨ã€‚



### @NonNullã€@NonNullApiã€@Nullableã€äº†è§£ã€‘

ä» Spring Data 2.0 å¼€å§‹ï¼ŒJPA æ–°å¢äº†[@NonNull](https://docs.spring.io/spring/docs/5.2.8.RELEASE/javadoc-api/org/springframework/lang/NonNull.html) [@NonNullApi](https://docs.spring.io/spring/docs/5.2.8.RELEASE/javadoc-api/org/springframework/lang/NonNullApi.html) [@Nullable](https://docs.spring.io/spring/docs/5.2.8.RELEASE/javadoc-api/org/springframework/lang/Nullable.html)ï¼Œæ˜¯å¯¹ null çš„å‚æ•°å’Œè¿”å›ç»“æœåšçš„æ”¯æŒã€‚

-   **@NonNullApi**ï¼šåœ¨åŒ…çº§åˆ«ç”¨äºå£°æ˜å‚æ•°ï¼Œä»¥åŠè¿”å›å€¼çš„é»˜è®¤è¡Œä¸ºæ˜¯ä¸æ¥å—æˆ–äº§ç”Ÿç©ºå€¼çš„ã€‚
-   **@NonNull**ï¼šç”¨äºä¸èƒ½ä¸ºç©ºçš„å‚æ•°æˆ–è¿”å›å€¼ï¼ˆåœ¨ @NonNullApi é€‚ç”¨çš„å‚æ•°å’Œè¿”å›å€¼ä¸Šä¸éœ€è¦ï¼‰ã€‚
-   **@Nullable**ï¼šç”¨äºå¯ä»¥ä¸ºç©ºçš„å‚æ•°æˆ–è¿”å›å€¼ã€‚

æˆ‘åœ¨è‡ªå·±çš„ Repository æ‰€åœ¨ package çš„ package-info.java ç±»é‡Œé¢åšå¦‚ä¸‹å£°æ˜ï¼š

```java
@org.springframework.lang.NonNullApi

package com.myrespository;

```

myrespository ä¸‹é¢çš„ UserRepository å®ç°å¦‚ä¸‹ï¼š

```java
package com.myrespository;                                                       

import org.springframework.lang.Nullable;

interface UserRepository extends Repository<User, Long> {

  User getByEmailAddress(EmailAddress emailAddress); 

}
```

è¿™ä¸ªæ—¶å€™å½“ emailAddress å‚æ•°ä¸º null çš„æ—¶å€™å°±ä¼šæŠ›å¼‚å¸¸ï¼Œå½“è¿”å›ç»“æœä¸º null çš„æ—¶å€™ä¹Ÿä¼šæŠ›å¼‚å¸¸ã€‚å› ä¸ºæˆ‘ä»¬åœ¨package çš„ package-info.javaé‡Œé¢æŒ‡å®šäº†NonNullApiï¼Œæ‰€æœ‰è¿”å›ç»“æœå’Œå‚æ•°ä¸èƒ½ä¸º Null

```java
@Nullable
User findByEmailAddress(@Nullable EmailAddress emailAdress);//å½“æˆ‘ä»¬æ·»åŠ @Nullable æ³¨è§£ä¹‹åï¼Œå‚æ•°å’Œè¿”å›ç»“æœè¿™ä¸ªæ—¶å€™å°±éƒ½ä¼šå…è®¸ä¸º null äº†ï¼›          

Optional<User> findOptionalByEmailAddress(EmailAddress emailAddress); //è¿”å›ç»“æœå…è®¸ä¸º null,å‚æ•°ä¸å…è®¸ä¸º null çš„æƒ…å†µ

```







### æ€è€ƒï¼šService å±‚å°è£…ã€äº†è§£ã€‘

Spring Data Common é‡Œé¢çš„ repository åŸºç±»ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥åº”ç”¨æ¨å¹¿åˆ° service å±‚ï¼Ÿç±»ä¼¼ Mybatis Plusã€‚çœ‹ä¸‹é¢çš„å®æˆ˜ä¾‹å­ï¼š

```java
public interface BaseService<T, ID> {

    Class<T> getDomainClass();

    <S extends T> S save(S entity);

    <S extends T> List<S> saveAll(Iterable<S> entities);

    void delete(T entity);

    void deleteById(ID id);

    void deleteAll();

    void deleteAll(Iterable<? extends T> entities);

    void deleteInBatch(Iterable<T> entities);

    void deleteAllInBatch();

    T getOne(ID id);

    <S extends T> Optional<S> findOne(Example<S> example);

    Optional<T> findById(ID id);

    List<T> findAll();

    List<T> findAll(Sort sort);

    Page<T> findAll(Pageable pageable);

    <S extends T> List<S> findAll(Example<S> example);

    <S extends T> List<S> findAll(Example<S> example, Sort sort);

    <S extends T> Page<S> findAll(Example<S> example, Pageable pageable);

    List<T> findAllById(Iterable<ID> ids);

    long count();

    <S extends T> long count(Example<S> example);

    <S extends T> boolean exists(Example<S> example);

    boolean existsById(ID id);

    void flush();

    <S extends T> S saveAndFlush(S entity);

}

```

æ¨¡ä»¿JpaRepositoryæ¥å£ä¹Ÿè‡ªå®šä¹‰äº†ä¸€ä¸ªè‡ªå·±çš„BaseServiceï¼Œå£°æ˜äº†å¸¸ç”¨çš„CRUDæ“ä½œï¼Œä¸Šé¢çš„ä»£ç æ˜¯**ç”Ÿäº§ä»£ç **ï¼Œå¯ä»¥ä½œä¸ºå‚è€ƒã€‚å½“ç„¶äº†æˆ‘ä»¬ä¹Ÿå¯ä»¥å»ºç«‹è‡ªå·±çš„ PagingAndSortingServiceã€ComplexityServiceã€SampleService ç­‰æ¥åˆ’åˆ†ä¸åŒçš„ serviceæ¥å£ï¼Œä¾›ä¸åŒç›®çš„ Service å­ç±»ç»§æ‰¿

å†æ¥æ¨¡ä»¿ä¸€ä¸ª SimpleJpaRepositoryï¼Œæ¥å®ç°è‡ªå·±çš„ BaseService çš„å®ç°ç±»ã€‚

```java
public class BaseServiceImpl<T, ID, R extends JpaRepository<T, ID>> implements BaseService<T, ID> {
    private static final Map<Class, Class> DOMAIN_CLASS_CACHE = new ConcurrentHashMap<>();
    private final R repository;
    public BaseServiceImpl(R repository) {
        this.repository = repository;
    }
    @Override
    public Class<T> getDomainClass() {
        Class thisClass = getClass();
        Class<T> domainClass = DOMAIN_CLASS_CACHE.get(thisClass);
        if (Objects.isNull(domainClass)) {
            domainClass = GenericsUtils.getGenericClass(thisClass, 0);
            DOMAIN_CLASS_CACHE.putIfAbsent(thisClass, domainClass);
        }
        return domainClass;
    }
    protected R getRepository() {
        return repository;
    }
    @Override
    public <S extends T> S save(S entity) {
        return repository.save(entity);
    }
    @Override
    public <S extends T> List<S> saveAll(Iterable<S> entities) {
        return repository.saveAll(entities);
    }
    @Override
    public void delete(T entity) {
        repository.delete(entity);
    }
    @Override
    public void deleteById(ID id) {
        repository.deleteById(id);
    }
    @Override
    public void deleteAll() {
        repository.deleteAll();
    }
    @Override
    public void deleteAll(Iterable<? extends T> entities) {
        repository.deleteAll(entities);
    }
    @Override
    public void deleteInBatch(Iterable<T> entities) {
        repository.deleteInBatch(entities);
    }
    @Override
    public void deleteAllInBatch() {
        repository.deleteAllInBatch();
    }
    @Override
    public T getOne(ID id) {
        return repository.getOne(id);
    }
    @Override
    public <S extends T> Optional<S> findOne(Example<S> example) {
        return repository.findOne(example);
    }
    @Override
    public Optional<T> findById(ID id) {
        return repository.findById(id);
    }
    @Override
    public List<T> findAll() {
        return repository.findAll();
    }
    @Override
    public List<T> findAll(Sort sort) {
        return repository.findAll(sort);
    }
    @Override
    public Page<T> findAll(Pageable pageable) {
        return repository.findAll(pageable);
    }
    @Override
    public <S extends T> List<S> findAll(Example<S> example) {
        return repository.findAll(example);
    }
    @Override
    public <S extends T> List<S> findAll(Example<S> example, Sort sort) {
        return repository.findAll(example, sort);
    }
    @Override
    public <S extends T> Page<S> findAll(Example<S> example, Pageable pageable) {
        return repository.findAll(example, pageable);
    }
    @Override
    public List<T> findAllById(Iterable<ID> ids) {
        return repository.findAllById(ids);
    }
    @Override
    public long count() {
        return repository.count();
    }
    @Override
    public <S extends T> long count(Example<S> example) {
        return repository.count(example);
    }
    @Override
    public <S extends T> boolean exists(Example<S> example) {
        return repository.exists(example);
    }
    @Override
    public boolean existsById(ID id) {
        return repository.existsById(id);
    }
    @Override
    public void flush() {
        repository.flush();
    }
    @Override
    public <S extends T> S saveAndFlush(S entity) {
        return repository.saveAndFlush(entity);
    }
}
```

ä»¥ä¸Šä»£ç å°±æ˜¯ BaseService å¸¸ç”¨çš„ CURL å®ç°ä»£ç ï¼Œæˆ‘ä»¬è¿™é‡Œé¢å¤§éƒ¨åˆ†ä¹Ÿæ˜¯ç›´æ¥è°ƒç”¨ Repository æä¾›çš„æ–¹æ³•ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ç»§æ‰¿ BaseServiceImpl çš„æ—¶å€™éœ€è¦ä¼ é€’è‡ªå·±çš„ Repositoryï¼Œå¦‚ä¸‹é¢å®ä¾‹ä»£ç ï¼š

```java
@Service
public class UserServiceImpl extends BaseServiceImpl<User, Long, UserRepository> implements UserService {
    public UserServiceImpl(UserRepository repository) {
        super(repository);
    }
    // .....
}
```







## åˆ©ç”¨ Repository ä¸­çš„æ–¹æ³•è¿”å›å€¼ ğŸ”¥

### è¿”å›ç±»å‹æ€»è§ˆã€äº†è§£ã€‘

è¿™ä¸€è¯¾æ—¶æˆ‘ä»¬æ¥çœ‹ä¸‹Repository æ”¯æŒçš„è¿”å›ç»“æœæœ‰å“ªäº›ï¼Œä»¥åŠ DTO ç±»å‹çš„è¿”å›ç»“æœå¦‚ä½•è‡ªå®šä¹‰ï¼Œåœ¨å®é™…å·¥ä½œåœºæ™¯ä¸­æˆ‘ä»¬å¦‚ä½•åšã€‚

ä¹‹å‰å·²ç»ä»‹ç»è¿‡äº† Repository çš„æ¥å£ï¼Œé‚£ä¹ˆç°åœ¨æ¥çœ‹ä¸€ä¸‹è¿™äº›æ¥å£æ”¯æŒçš„è¿”å›ç»“æœæœ‰å“ªäº›ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º

![image-20201221232021715](../images/image-20201221232021715.png)

æ‰“å¼€ SimpleJpaRepository ç›´æ¥çœ‹å®ƒçš„ Structure å°±å¯ä»¥çŸ¥é“ï¼Œå®ƒå®ç°çš„æ–¹æ³•ï¼Œä»¥åŠçˆ¶ç±»æ¥å£çš„æ–¹æ³•å’Œè¿”å›ç±»å‹åŒ…æ‹¬ï¼šOptionalã€Iterableã€Listã€Pageã€Longã€Booleanã€Entity å¯¹è±¡ç­‰ï¼Œè€Œå®é™…ä¸Šæ”¯æŒçš„è¿”å›ç±»å‹è¿˜è¦å¤šä¸€äº›ã€‚



### Streamableã€äº†è§£ã€‘

ç”±äº Repository é‡Œé¢æ”¯æŒ Iterableï¼Œæ‰€ä»¥å…¶å® java æ ‡å‡†çš„ Listã€Set éƒ½å¯ä»¥ä½œä¸ºè¿”å›ç»“æœï¼Œå¹¶ä¸”ä¹Ÿä¼šæ”¯æŒå…¶å­ç±»ï¼ŒSpring Data é‡Œé¢å®šä¹‰äº†ä¸€ä¸ªç‰¹æ®Šçš„å­ç±» Streamableï¼ŒStreamable å¯ä»¥æ›¿ä»£ Iterable æˆ–ä»»ä½•é›†åˆç±»å‹ã€‚å®ƒè¿˜æä¾›äº†æ–¹ä¾¿çš„æ–¹æ³•æ¥è®¿é—® Streamï¼Œå¯ä»¥ç›´æ¥åœ¨å…ƒç´ ä¸Šè¿›è¡Œ â€¦.filter(â€¦) å’Œ â€¦.map(â€¦) æ“ä½œï¼Œå¹¶å°† Streamable è¿æ¥åˆ°å…¶ä»–å…ƒç´ ã€‚æˆ‘ä»¬çœ‹ä¸ªå…³äº UserRepository ç›´æ¥ç»§æ‰¿ JpaRepository çš„ä¾‹å­ã€‚

````java
public interface UserRepository extends JpaRepository<User,Long> {

}
````

```java
@DataJpaTest
// DataJpaTestã€MybatisTest ä¼šé»˜è®¤ä½¿ç”¨å…¶æµ‹è¯•æ•°æ®æºæ›¿ä»£ï¼Œè‹¥è¦ä½¿ç”¨è‡ªå·±é…ç½®çš„ï¼Œéœ€è¦æ·»åŠ å¦‚ä¸‹æ³¨è§£
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
public class RepositoryTest {

    @Autowired
    private UserRepository userRepository;


    @Test
    void test() {
        User user = userRepository.save(User.builder()
                                        .name("jackxx")
                                        .email("123456@126.com")
                                        .sex("man")
                                        .address("shanghai")
                                        .build());
        Assert.assertNotNull(user);

        Streamable<User> userStreamable = userRepository.findAll(PageRequest.of(0,10)).and(User
                 .builder()
                 .name("jack222")
                 .build());

        userStreamable.forEach(System.out::println);
    }
}
```

ç„¶åæˆ‘ä»¬å°±ä¼šå¾—åˆ°å¦‚ä¸‹è¾“å‡ºï¼š

```
User(id=1, name=jackxx, email=123456@126.com, sex=man, address=shanghai)
User(id=null, name=jack222, email=null, sex=null, address=null)
```

è¿™ä¸ªä¾‹å­ Streamable`<User>` userStreamableï¼Œå®ç°äº† Streamable çš„è¿”å›ç»“æœï¼Œå¦‚æœæƒ³è‡ªå®šä¹‰æ–¹æ³•ï¼Œå¯ä»¥è¿›è¡Œå¦‚ä¸‹æ“ä½œã€‚

å®˜æ–¹ç»™æˆ‘ä»¬æä¾›äº†è‡ªå®šä¹‰ Streamable çš„æ–¹æ³•ï¼Œä¸è¿‡åœ¨å®é™…å·¥ä½œä¸­å¾ˆå°‘å‡ºç°è¦è‡ªå®šä¹‰ä¿è¯ç»“æœç±»çš„æƒ…å†µï¼Œåœ¨è¿™é‡Œæˆ‘ç®€å•ä»‹ç»ä¸€ä¸‹æ–¹æ³•ï¼Œçœ‹å¦‚ä¸‹ä¾‹å­ï¼š

```java
class Product { // (1)
    MonetaryAmount getPrice() {
        //..
    }
}

@RequiredArgConstructor(staticName = "of")
class Products implements Streamable<Product> { //(2)
    private Streamable<Product> streamable;
    public MonetaryAmount getTotal() { //(3)
        return streamable.stream() 
            .map(Priced::getPrice)
            .reduce(Money.of(0), MonetaryAmount::add);
    }
}

interface ProductRepository implements Repository<Product, Long> {
    Products findAllByDescriptionContaining(String text); //(4)
}
```

ä»¥ä¸Šå››ä¸ªæ­¥éª¤ä»‹ç»äº†è‡ªå®šä¹‰ Streamable çš„æ–¹æ³•ï¼Œåˆ†åˆ«ä¸ºï¼š

ï¼ˆ1ï¼‰Product å®ä½“ï¼Œå…¬å¼€ API ä»¥è®¿é—®äº§å“ä»·æ ¼ã€‚

ï¼ˆ2ï¼‰Streamable`<Product>` çš„åŒ…è£…ç±»å‹å¯ä»¥é€šè¿‡ Products.of(â€¦) æ„é€ ï¼ˆé€šè¿‡ Lombok æ³¨è§£åˆ›å»ºçš„å·¥å‚æ–¹æ³•ï¼‰ã€‚

ï¼ˆ3ï¼‰åŒ…è£…å™¨ç±»å‹åœ¨ Streamable`<Product>` ä¸Šå…¬å¼€äº†è®¡ç®—æ–°å€¼çš„å…¶ä»– APIã€‚

ï¼ˆ4ï¼‰å¯ä»¥å°†åŒ…è£…å™¨ç±»å‹ç›´æ¥ç”¨ä½œæŸ¥è¯¢æ–¹æ³•è¿”å›ç±»å‹ã€‚æ— é¡»è¿”å› Stremable`<Product>` å¹¶å°†å…¶æ‰‹åŠ¨åŒ…è£…åœ¨å­˜å‚¨åº“ Client ç«¯ä¸­ã€‚

é€šè¿‡ä»¥ä¸Šä¾‹å­ä½ å°±å¯ä»¥åšåˆ°è‡ªå®šä¹‰ Streamableï¼Œå…¶åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯å®ç°Streamableæ¥å£ï¼Œè‡ªå·±å®šä¹‰è‡ªå·±çš„å®ç°ç±»å³å¯ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹ä¸‹æºç  QueryExecutionResultHandler é‡Œé¢æ˜¯å¦æœ‰ Streamable å­ç±»çš„åˆ¤æ–­ï¼Œæ¥æ”¯æŒè‡ªå®šä¹‰ Streamableï¼Œå…³é”®æºç å¦‚ä¸‹ï¼š

![image-20201221232035672](../images/image-20201221232035672.png)

é€šè¿‡æºç ä½ ä¼šå‘ç° Streamable ä¸ºä»€ä¹ˆç”Ÿæ•ˆï¼Œä¸‹é¢æ¥çœ‹çœ‹å¸¸è§çš„é›†åˆç±»çš„è¿”å›å®ç°ã€‚



### List/Stream/Page/Sliceã€æŒæ¡ã€‘

åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¦‚ä½•è¿”å› List/Stream/Page/Slice å‘¢ï¼Ÿ

æ–°å»ºæˆ‘ä»¬çš„ UserRepositoryï¼š

```java
public interface UserRepository extends JpaRepository<User,Long> {
   //è‡ªå®šä¹‰ä¸€ä¸ªæŸ¥è¯¢æ–¹æ³•ï¼Œè¿”å›Streamå¯¹è±¡ï¼Œå¹¶ä¸”æœ‰åˆ†é¡µå±æ€§
    @Query("select u from User u")
    Stream<User> findAllByCustomQueryAndStream(Pageable pageable);
    //æµ‹è¯•Sliceçš„è¿”å›ç»“æœ
    @Query("select u from User u")
    Slice<User> findAllByCustomQueryAndSlice(Pageable pageable);
}
```

æµ‹è¯•ç”¨ä¾‹ç±»

```java
@DataJpaTest
public class UserRepositoryTest {
    @Autowired
    private UserRepository userRepository;
    @Test
    public void testSaveUser() throws JsonProcessingException {
        //æˆ‘ä»¬æ–°å¢7æ¡æ•°æ®æ–¹ä¾¿æµ‹è¯•åˆ†é¡µç»“æœ
        userRepository.save(User.builder()
                            .name("jack1").email("12356@126.com").sex("man").address("shanghai").build());
        userRepository.save(User.builder()
                            .name("jack2").email("12456@126.com").sex("man").address("shanghai").build());
        userRepository.save(User.builder()
                            .name("jack3").email("12456@126.com").sex("man").address("shanghai").build());
        userRepository.save(User.builder()
                            .name("jack4").email("12356@126.com").sex("man").address("shanghai").build());
        userRepository.save(User.builder()
                            .name("jack5").email("12356@126.com").sex("man").address("shanghai").build());
        userRepository.save(User.builder()
                            .name("jack6").email("12346@126.com").sex("man").address("shanghai").build());
        userRepository.save(User.builder()
                            .name("jack7").email("12346@126.com").sex("man").address("shanghai").build());
        
        //æˆ‘ä»¬åˆ©ç”¨ObjectMapperå°†æˆ‘ä»¬çš„è¿”å›ç»“æœJson to String
        ObjectMapper objectMapper = new ObjectMapper();
        //è¿”å›Streamç±»å‹ç»“æœï¼ˆ1ï¼‰
        Stream<User> userStream = userRepository.findAllByCustomQueryAndStream(PageRequest.of(1,3));
        userStream.forEach(System.out::println);
        //è¿”å›åˆ†é¡µæ•°æ®ï¼ˆ2ï¼‰
        Page<User> userPage = userRepository.findAll(PageRequest.of(0,3));
        System.out.println(objectMapper.writeValueAsString(userPage));
        //è¿”å›Sliceç»“æœï¼ˆ3ï¼‰
        Slice<User> userSlice = userRepository.findAllByCustomQueryAndSlice(PageRequest.of(0,3));
        System.out.println(objectMapper.writeValueAsString(userSlice));
        //è¿”å›Listç»“æœï¼ˆ4ï¼‰
        List<User> userList = userRepository.findAllById(Lists.newArrayList(1L,2L));
        System.out.println(objectMapper.writeValueAsString(userList));
    }
}
```

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆ†åˆ«çœ‹ä¸‹å››ç§æµ‹è¯•ç»“æœï¼š

**ç¬¬ä¸€ç§ï¼šé€šè¿‡**Stream`<User>`**å–ç¬¬äºŒé¡µçš„æ•°æ®ï¼Œå¾—åˆ°ç»“æœå¦‚ä¸‹ï¼š**

```
User(id=4, name=jack4, email=123456@126.com, sex=man, address=shanghai)
User(id=5, name=jack5, email=123456@126.com, sex=man, address=shanghai)
User(id=6, name=jack6, email=123456@126.com, sex=man, address=shanghai)
```

Spring Data çš„æ”¯æŒå¯ä»¥é€šè¿‡ä½¿ç”¨ Java 8 Stream ä½œä¸ºè¿”å›ç±»å‹æ¥é€æ­¥å¤„ç†æŸ¥è¯¢æ–¹æ³•çš„ç»“æœã€‚**éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæµçš„å…³é—­é—®é¢˜**ï¼Œtry catch æ˜¯ä¸€ç§å¸¸ç”¨çš„å…³é—­æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
Stream<User> stream;
try {
   stream = repository.findAllByCustomQueryAndStream()
   stream.forEach(â€¦);
} catch (Exception e) {
   e.printStackTrace();
} finally {
   if (stream!=null){
      stream.close();
   }
}
```

**ç¬¬äºŒç§ï¼šè¿”å› Page`<User>` çš„åˆ†é¡µæ•°æ®ç»“æœï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š**

```json
{
   "content":[
      {
         "id":1,
         "name":"jack1",
         "email":"123456@126.com",
         "sex":"man",
         "address":"shanghai"
      },
      {
         "id":2,
         "name":"jack2",
         "email":"123456@126.com",
         "sex":"man",
         "address":"shanghai"
      },
      {
         "id":3,
         "name":"jack3",
         "email":"123456@126.com",
         "sex":"man",
         "address":"shanghai"
      }
   ],
   "pageable":{
      "sort":{
         "sorted":false,
         "unsorted":true,
         "empty":true
      },
      "pageNumber":0,//å½“å‰é¡µç 
      "pageSize":3,//é¡µç å¤§å°
      "offset":0,//åç§»é‡
      "paged":true,//æ˜¯å¦åˆ†é¡µäº†
      "unpaged":false
   },
   "totalPages":3,//ä¸€å…±æœ‰å¤šå°‘é¡µ
   "last":false,//æ˜¯å¦æ˜¯åˆ°æœ€å
   "totalElements":7,//ä¸€å…±å¤šå°‘è°ƒæ•°
   "numberOfElements":3,//å½“å‰æ•°æ®ä¸‹æ ‡
   "sort":{
      "sorted":false,
      "unsorted":true,
      "empty":true
   },
   "size":3, // å½“å‰contentå¤§å°
   "number":0,// å½“å‰é¡µé¢ç çš„ç´¢å¼•
   "first":true,// æ˜¯å¦æ˜¯ç¬¬ä¸€é¡µ
   "empty":false//æ˜¯å¦æœ‰æ•°æ®
}
```

è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Page`<User>` è¿”å›äº†ç¬¬ä¸€ä¸ªé¡µçš„æ•°æ®ï¼Œå¹¶ä¸”å‘Šè¯‰æˆ‘ä»¬ä¸€å…±æœ‰ä¸‰ä¸ªéƒ¨åˆ†çš„æ•°æ®ï¼š

-   **content**ï¼šæ•°æ®çš„å†…å®¹ï¼Œç°åœ¨æŒ‡ User çš„ List 3 æ¡ã€‚
-   **pageable**ï¼šåˆ†é¡µæ•°æ®ï¼ŒåŒ…æ‹¬æ’åºå­—æ®µæ˜¯ä»€ä¹ˆåŠå…¶æ–¹å‘ã€å½“å‰æ˜¯ç¬¬å‡ é¡µã€ä¸€å…±å¤šå°‘é¡µã€æ˜¯å¦æ˜¯æœ€åä¸€æ¡ç­‰ã€‚
-   **å½“å‰æ•°æ®çš„æè¿°**ï¼šâ€œsizeâ€ï¼š3ï¼Œå½“å‰ content å¤§å°ï¼›â€œnumberâ€ï¼š0ï¼Œå½“å‰é¡µé¢ç çš„ç´¢å¼•ï¼› â€œfirstâ€ï¼štrueï¼Œæ˜¯å¦æ˜¯ç¬¬ä¸€é¡µï¼›â€œemptyâ€ï¼šfalseï¼Œæ˜¯å¦æ²¡æœ‰æ•°æ®ã€‚

é€šè¿‡è¿™ä¸‰éƒ¨åˆ†æ•°æ®æˆ‘ä»¬å¯ä»¥çŸ¥é“è¦æŸ¥æ•°çš„åˆ†é¡µä¿¡æ¯ã€‚

**ç¬¬ä¸‰ç§ï¼šè¿”å› Slice`<User>` ç»“æœï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š**

```json
{
   "content":[
      {
         "id":4,
         "name":"jack4",
         "email":"123456@126.com",
         "sex":"man",
         "address":"shanghai"
      },
      {
         "id":5,
         "name":"jack5",
         "email":"123456@126.com",
         "sex":"man",
         "address":"shanghai"
      },
      {
         "id":6,
         "name":"jack6",
         "email":"123456@126.com",
         "sex":"man",
         "address":"shanghai"
      }
   ],
   "pageable":{
      "sort":{
         "sorted":false,
         "unsorted":true,
         "empty":true
      },
      "pageNumber":1,
      "pageSize":3,
      "offset":3,
      "paged":true,
      "unpaged":false
   },
   "numberOfElements":3,
   "sort":{
      "sorted":false,
      "unsorted":true,
      "empty":true
   },
   "size":3,
   "number":1,
   "first":false,
   "last":false,
   "empty":false
}
```

è¿™æ—¶æˆ‘ä»¬å‘ç°ä¸Šé¢çš„ Page è¿”å›ç»“æœå°‘äº†ï¼Œé‚£ä¹ˆä¸€å…±æœ‰å¤šå°‘æ¡ç»“æœã€å¤šå°‘é¡µçš„æ•°æ®å‘¢ï¼Ÿæˆ‘ä»¬å†æ¯”è¾ƒä¸€ä¸‹ç¬¬äºŒç§å’Œç¬¬ä¸‰ç§æµ‹è¯•ç»“æœçš„æ‰§è¡Œ SQLï¼š

ç¬¬äºŒç§æ‰§è¡Œçš„æ˜¯æ™®é€šçš„åˆ†é¡µæŸ¥è¯¢ SQLï¼š

```sql
-- æŸ¥è¯¢åˆ†é¡µæ•°æ®
select user0_.id as id1_0_, user0_.address as address2_0_, user0_.email as email3_0_, user0_.name as name4_0_, user0_.sex as sex5_0_ from user user0_ limit ?
-- è®¡ç®—åˆ†é¡µæ•°æ®
select count(user0_.id) as col_0_0_ from user user0_
```

ç¬¬ä¸‰ç§æ‰§è¡Œçš„ SQL å¦‚ä¸‹ï¼š

```sql
select user0_.id as id1_0_, user0_.address as address2_0_, user0_.email as email3_0_, user0_.name as name4_0_, user0_.sex as sex5_0_ from user user0_ limit ? offset ?
```

é€šè¿‡å¯¹æ¯”å¯ä»¥çœ‹å‡ºï¼ŒåªæŸ¥è¯¢åç§»é‡ï¼Œä¸è®¡ç®—åˆ†é¡µæ•°æ®ï¼Œè¿™å°±æ˜¯ Page å’Œ Slice çš„ä¸»è¦åŒºåˆ«

**ç¬¬å››ç§ï¼šè¿”å› List`<User>` ç»“æœå¦‚ä¸‹ï¼š**

```json
[
    {
    "id":1,
    "name":"jack1",
    "email":"123456@126.com",
    "sex":"man",
    "address":"shanghai"
},
 {
     "id":2,
     "name":"jack2",
     "email":"123456@126.com",
     "sex":"man",
     "address":"shanghai"
 }
]
```

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆç®€å•åœ°æŸ¥è¯¢å‡ºæ¥ ID=1 å’Œ ID=2 çš„æ•°æ®ï¼Œæ²¡æœ‰åˆ†é¡µä¿¡æ¯ã€‚

ä¸Šé¢å››ç§æ–¹æ³•ä»‹ç»äº†å¸¸è§çš„å¤šæ¡æ•°æ®è¿”å›ç»“æœçš„å½¢å¼ï¼Œå•æ¡çš„æˆ‘å°±ä¸å¤šä»‹ç»äº†ï¼Œç›¸ä¿¡ä½ ä¸€çœ‹å°±æ‡‚ï¼Œæ— éå°±æ˜¯å¯¹ JDK8 çš„ Optional çš„æ”¯æŒã€‚æ¯”å¦‚æ”¯æŒäº† Null çš„ä¼˜é›…åˆ¤æ–­ï¼Œå†ä¸€ä¸ªå°±æ˜¯æ”¯æŒç›´æ¥è¿”å› Entityï¼Œæˆ–è€…ä¸€äº›å­˜åœ¨ / ä¸å­˜åœ¨çš„ Boolean çš„ç»“æœå’Œä¸€äº› count æ¡æ•°çš„è¿”å›ç»“æœè€Œå·²ã€‚



### å¯¹ Feature/CompletableFuture å¼‚æ­¥è¿”å›ç»“æœçš„æ”¯æŒ

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Spring çš„å¼‚æ­¥æ–¹æ³•æ‰§è¡ŒRepositoryæŸ¥è¯¢ï¼Œè¿™æ„å‘³ç€æ–¹æ³•å°†åœ¨è°ƒç”¨æ—¶ç«‹å³è¿”å›ï¼Œå¹¶ä¸”å®é™…çš„æŸ¥è¯¢æ‰§è¡Œå°†å‘ç”Ÿåœ¨å·²æäº¤ç»™ Spring TaskExecutor çš„ä»»åŠ¡ä¸­ï¼Œæ¯”è¾ƒé€‚åˆå®šæ—¶ä»»åŠ¡çš„å®é™…åœºæ™¯ã€‚å¼‚æ­¥ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œç›´æ¥åŠ @Async æ³¨è§£å³å¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
@Async
Future<User> findByFirstname(String firstname); (1)
@Async
CompletableFuture<User> findOneByFirstname(String firstname); (2)
@Async
ListenableFuture<User> findOneByLastname(String lastname);(3)
```

ä¸Šè¿°ä¸‰ä¸ªå¼‚æ­¥æ–¹æ³•çš„è¿”å›ç»“æœï¼Œåˆ†åˆ«åšå¦‚ä¸‹è§£é‡Šï¼š

-   ç¬¬ä¸€å¤„ï¼šä½¿ç”¨ java.util.concurrent.Future çš„è¿”å›ç±»å‹ï¼›
-   ç¬¬äºŒå¤„ï¼šä½¿ç”¨ java.util.concurrent.CompletableFuture ä½œä¸ºè¿”å›ç±»å‹ï¼›
-   ç¬¬ä¸‰å¤„ï¼šä½¿ç”¨ org.springframework.util.concurrent.ListenableFuture ä½œä¸ºè¿”å›ç±»å‹ã€‚

ä»¥ä¸Šæ˜¯å¯¹ @Async çš„æ”¯æŒï¼Œå…³äºå®é™…ä½¿ç”¨éœ€è¦æ³¨æ„ä»¥ä¸‹ä¸‰ç‚¹å†…å®¹ï¼š

-   åœ¨å®é™…å·¥ä½œä¸­ï¼Œç›´æ¥åœ¨ Repository è¿™ä¸€å±‚ä½¿ç”¨å¼‚æ­¥æ–¹æ³•çš„åœºæ™¯ä¸å¤šï¼Œä¸€èˆ¬éƒ½æ˜¯æŠŠå¼‚æ­¥æ³¨è§£æ”¾åœ¨ Service çš„æ–¹æ³•ä¸Šé¢ï¼Œè¿™æ ·çš„è¯ï¼Œå¯ä»¥æœ‰ä¸€äº›é¢å¤–é€»è¾‘ï¼Œå¦‚å‘çŸ­ä¿¡ã€å‘é‚®ä»¶ã€å‘æ¶ˆæ¯ç­‰é…åˆä½¿ç”¨ï¼›
-   ä½¿ç”¨å¼‚æ­¥çš„æ—¶å€™ä¸€å®šè¦é…ç½®çº¿ç¨‹æ± ï¼Œè¿™ç‚¹åˆ‡è®°ï¼Œå¦åˆ™â€œæ­»â€å¾—ä¼šå¾ˆéš¾çœ‹ï¼›
-   ä¸‡ä¸€å¤±è´¥æˆ‘ä»¬ä¼šæ€ä¹ˆå¤„ç†ï¼Ÿå…³äºäº‹åŠ¡æ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿè¿™ç§éœ€è¦é‡ç‚¹è€ƒè™‘çš„ï¼Œæˆ‘å°†ä¼šåœ¨ 14 è¯¾æ—¶ï¼ˆä¹è§‚é”æœºåˆ¶å’Œé‡è¯•æœºåˆ¶åœ¨å®æˆ˜ä¸­åº”è¯¥æ€ä¹ˆç”¨?ï¼‰ä¸­è¯¦ç»†ä»‹ç»ã€‚

æ¥ä¸‹æ¥çœ‹çœ‹ Repository å¯¹Reactive æ˜¯å¦‚ä½•æ”¯æŒçš„ã€‚





### å¯¹ Reactive æ”¯æŒ flux ä¸ Mono

å¯èƒ½æœ‰åŒå­¦ä¼šé—®ï¼Œçœ‹åˆ°Spring Data Commoné‡Œé¢å¯¹Reactè¿˜æ˜¯æœ‰æ”¯æŒçš„ï¼Œé‚£ä¸ºä»€ä¹ˆåœ¨JpaRespositoryé‡Œé¢æ²¡çœ‹åˆ°æœ‰å“åº”çš„è¿”å›ç»“æœæ”¯æŒå‘¢ï¼Ÿå…¶å®Commoné‡Œé¢æä¾›çš„åªæ˜¯æ¥å£ï¼Œè€ŒJPAé‡Œé¢æ²¡æœ‰åšç›¸å…³çš„Reactive çš„å®ç°ï¼Œä½†æ˜¯æœ¬èº«Spring Data Commoné‡Œé¢å¯¹ Reactive æ˜¯æ”¯æŒçš„ã€‚

ä¸‹é¢æˆ‘ä»¬åœ¨ gradle é‡Œé¢å¼•ç”¨ä¸€ä¸ªSpring Data Commonçš„å­æ¨¡å—implementation 'org.springframework.boot:spring-boot-starter-data-mongodb' æ¥åŠ è½½ä¾èµ–ï¼Œè¿™æ—¶å€™æˆ‘ä»¬æ‰“å¼€ Repository çœ‹ Hierarchy å°±å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå¤šäº†ä¸€ä¸ª Mongo çš„ Repsitory çš„å®ç°ï¼Œå¤©ç„¶åœ°æ”¯æŒç€ Reactive è¿™æ¡çº¿ã€‚

![img](../images/Ciqc1F9rC-uAWLY5AASQJuG5If0280.png)



ç›¸ä¿¡åˆ°è¿™é‡Œä½ èƒ½æ„Ÿå—åˆ° Spring Data Common çš„å¼ºå¤§æ”¯æŒï¼Œå¯¹ Repository æ¥å£çš„ä¸åŒå®ç°ä¹Ÿæœ‰äº†ä¸€å®šçš„è®¤è¯†ã€‚å¯¹äºä»¥ä¸Šè®²è¿°çš„è¿”å›ç»“æœï¼Œä½ å¯ä»¥è‡ªå·±æµ‹è¯•ä¸€ä¸‹åŠ ä»¥ç†è§£å¹¶è¿ç”¨ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬è¿›è¡Œä¸€ä¸ªæ€»ç»“ã€‚



### è¿”å›ç»“æœæ”¯æŒæ€»ç»“

ä¸‹é¢æ‰“å¼€ ResultProcessor ç±»çš„æºç çœ‹ä¸€ä¸‹æ”¯æŒçš„ç±»å‹æœ‰å“ªäº›ã€‚

![img](../images/CgqCHl9rC7uAOiNSAAGT0qXVLyY891.png)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡º processResult çš„æ—¶å€™åˆ†åˆ«å¯¹ PageQueryã€Streamã€Reactiv æœ‰äº†å„è‡ªçš„åˆ¤æ–­ï¼Œæˆ‘ä»¬ debug åˆ°è¿™é‡Œçš„æ—¶å€™æ¥çœ‹ä¸€ä¸‹ convertï¼Œè¿›å…¥åˆ°ç±»é‡Œé¢ã€‚

![img](../images/Ciqc1F9rC_-AOhtnAALvuoaT4mw230.png)

å¯ä»¥çœ‹åˆ° QueryExecutorConverters é‡Œé¢å¯¹ JDK8ã€Guavaã€vavr ä¹Ÿåšäº†å„ç§æ”¯æŒï¼Œå¦‚æœä½ æœ‰å…´è¶£å¯ä»¥è¯¾åå»ä»”ç»†çœ‹çœ‹æºç ã€‚

è¿™é‡Œæˆ‘ä»¬å…ˆç”¨è¡¨æ ¼æ€»ç»“ä¸€ä¸‹è¿”å›å€¼ï¼Œä¸‹è¡¨åˆ—å‡ºäº† Spring Data JPA Query Method æœºåˆ¶æ”¯æŒçš„æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼š

![img](../images/Ciqc1F9rDAiARh9tAAQVFWlht1s532.png)





### æœ€å¸¸è§çš„ DTO è¿”å›ç»“æœçš„æ”¯æŒæ–¹æ³•æœ‰å“ªäº›ã€æŒæ¡ã€‘

ä¸Šé¢æˆ‘ä»¬è®²è§£äº† Repository ä¸åŒçš„è¿”å›ç±»å‹ï¼Œä¸‹é¢æˆ‘ä»¬ç€é‡è¯´ä¸€ä¸‹é™¤äº† Entityï¼Œè¿˜èƒ½è¿”å›å“ªäº› POJO å‘¢ï¼Ÿæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸ªæ¦‚å¿µï¼š**Projections**ã€‚

#### Projections çš„æ¦‚å¿µ ã€æŒæ¡ã€‘

Spring JPA å¯¹ Projections æ‰©å±•çš„æ”¯æŒï¼Œæˆ‘ä¸ªäººè§‰å¾—è¿™æ˜¯ä¸ªéå¸¸å¥½çš„ä¸œè¥¿ï¼Œä»å­—é¢æ„æ€ä¸Šç†è§£å°±æ˜¯æ˜ å°„ï¼ŒæŒ‡çš„æ˜¯å’Œ DB çš„æŸ¥è¯¢ç»“æœçš„å­—æ®µæ˜ å°„å…³ç³»ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿”å›çš„å­—æ®µå’Œ DB çš„æŸ¥è¯¢ç»“æœçš„å­—æ®µæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼›ä½†æœ‰çš„æ—¶å€™ï¼Œéœ€è¦è¿”å›ä¸€äº›æŒ‡å®šçš„å­—æ®µï¼Œæˆ–è€…è¿”å›ä¸€äº›å¤åˆå‹çš„å­—æ®µï¼Œè€Œä¸éœ€è¦å…¨éƒ¨è¿”å›ã€‚

åŸæ¥æˆ‘ä»¬çš„åšæ³•æ˜¯è‡ªå·±å†™å„ç§ entity åˆ° view çš„å„ç§ convert çš„è½¬åŒ–é€»è¾‘ï¼Œè€Œ Spring Data æ­£æ˜¯è€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ï¼Œå…è®¸å¯¹ä¸“ç”¨è¿”å›ç±»å‹è¿›è¡Œå»ºæ¨¡ï¼Œæœ‰é€‰æ‹©åœ°è¿”å›åŒä¸€ä¸ªå®ä½“çš„ä¸åŒè§†å›¾å¯¹è±¡ã€‚

ä¸‹é¢è¿˜ä»¥æˆ‘ä»¬çš„ User æŸ¥è¯¢å¯¹è±¡ä¸ºä¾‹ï¼Œçœ‹çœ‹æ€ä¹ˆè‡ªå®šä¹‰è¿”å› DTOï¼š

```java
@Entity
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class User {
   @Id
   @GeneratedValue(strategy= GenerationType.AUTO)
   private Long id;
   private String name;
   private String email;
   private String sex;
   private String address;
}
```

çœ‹ä¸Šé¢çš„åŸå§‹ User å®ä½“ä»£ç ï¼Œå¦‚æœæˆ‘ä»¬åªæƒ³è¿”å› User å¯¹è±¡é‡Œé¢çš„ name å’Œ emailï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿä¸‹é¢æˆ‘ä»¬ä»‹ç»ä¸‰ç§æ–¹æ³•ã€‚



#### ç¬¬ä¸€ç§æ–¹æ³•ï¼šæ–°å»ºä¸€å¼ è¡¨çš„ä¸åŒ Entity

é¦–å…ˆï¼Œæˆ‘ä»¬æ–°å¢ä¸€ä¸ªEntityç±»ï¼šé€šè¿‡ @Table æŒ‡å‘åŒä¸€å¼ è¡¨ï¼Œè¿™å¼ è¡¨å’Œ User å®ä¾‹é‡Œé¢çš„è¡¨ä¸€æ ·éƒ½æ˜¯ userï¼Œå®Œæ•´å†…å®¹å¦‚ä¸‹ï¼š

```java
@Entity
@Table(name = "user")
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class UserOnlyNameEmailEntity {
   @Id
   @GeneratedValue(strategy= GenerationType.AUTO)
   private Long id;
   private String name;
   private String email;
}
```

ç„¶åï¼Œæ–°å¢ä¸€ä¸ª UserOnlyNameEmailEntityRepositoryï¼Œåšå•ç‹¬çš„æŸ¥è¯¢ï¼š

```java
public interface UserOnlyNameEmailEntityRepository extends JpaRepository<UserOnlyNameEmailEntity,Long> {
}
```

æœ€åï¼Œæˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹é‡Œé¢çš„å†™æ³•å¦‚ä¸‹ï¼š

```java
@Test
public void testProjections() {
  userRepository.save(User.builder().id(1L).name("jack12").email("123456@126.com").sex("man").address("shanghai").build());
    List<User> users= userRepository.findAll();
    System.out.println(users);
    UserOnlyNameEmailEntity uName = userOnlyNameEmailEntityRepository.getOne(1L);
    System.out.println(uName);
}
```

æˆ‘ä»¬çœ‹ä¸€ä¸‹è¾“å‡ºç»“æœï¼š

```
Hibernate: insert into user (address, email, name, sex, id) values (?, ?, ?, ?, ?)
Hibernate: select user0_.id as id1_0_, user0_.address as address2_0_, user0_.email as email3_0_, user0_.name as name4_0_, user0_.sex as sex5_0_ from user user0_
[User(id=1, name=jack12, email=123456@126.com, sex=man, address=shanghai)]
Hibernate: select useronlyna0_.id as id1_0_0_, useronlyna0_.email as email3_0_0_, useronlyna0_.name as name4_0_0_ from user useronlyna0_ where useronlyna0_.id=?
UserOnlyNameEmailEntity(id=1, name=jack12, email=123456@126.com)
```

ä¸Šè¿°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œå½“åœ¨ user è¡¨é‡Œé¢æ’å…¥äº†ä¸€æ¡æ•°æ®ï¼Œè€Œ userRepository å’Œ userOnlyNameEmailEntityRepository æŸ¥è¯¢çš„éƒ½æ˜¯åŒä¸€å¼ è¡¨ userï¼Œè¿™ç§æ–¹å¼çš„å¥½å¤„æ˜¯ç®€å•ã€æ–¹ä¾¿ï¼Œå¾ˆå®¹æ˜“å¯ä»¥æƒ³åˆ°ï¼›ç¼ºç‚¹å°±æ˜¯é€šè¿‡ä¸¤ä¸ªå®ä½“éƒ½å¯ä»¥è¿›è¡Œ update æ“ä½œï¼Œå¦‚æœåŒä¸€ä¸ªé¡¹ç›®é‡Œé¢è¿™ç§å®ä½“æ¯”è¾ƒå¤šï¼Œåˆ°æ—¶å€™å°±å®¹æ˜“ä¸çŸ¥é“æ˜¯è°æ›´æ–°çš„ï¼Œä»è€Œå¯¼è‡´å‡º bug ä¸å¥½æŸ¥è¯¢ï¼Œå®ä½“èŒè´£åˆ’åˆ†ä¸æ˜ç¡®ã€‚æˆ‘ä»¬æ¥çœ‹ç¬¬äºŒç§è¿”å› DTO çš„åšæ³•ã€‚



#### ç¬¬äºŒç§æ–¹æ³•ï¼šç›´æ¥å®šä¹‰ä¸€ä¸ª UserOnlyNameEmailDto

é¦–å…ˆï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª DTO ç±»æ¥è¿”å›æˆ‘ä»¬æƒ³è¦çš„å­—æ®µï¼Œå®ƒæ˜¯ UserOnlyNameEmailDtoï¼Œç”¨æ¥æ¥æ”¶ nameã€email ä¸¤ä¸ªå­—æ®µçš„å€¼ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

```java
@Data
@Builder
@AllArgsConstructor
public class UserOnlyNameEmailDto {
    private String name,email;
}
```

å…¶æ¬¡ï¼Œåœ¨ UserRepository é‡Œé¢åšå¦‚ä¸‹ç”¨æ³•ï¼š

```java
public interface UserRepository extends JpaRepository<User,Long> {
    //æµ‹è¯•åªè¿”å›nameå’Œemailçš„DTO
    UserOnlyNameEmailDto findByEmail(String email);
}
```

ç„¶åï¼Œæµ‹è¯•ç”¨ä¾‹é‡Œé¢å†™æ³•å¦‚ä¸‹ï¼š

```java
@Test
public void testProjections() {
    userRepository.save(User.builder()
                        .id(1L).name("jack12").email("123456@126.com").sex("man").address("shanghai").build());
    UserOnlyNameEmailDto userOnlyNameEmailDto =  userRepository.findByEmail("123456@126.com");
    System.out.println(userOnlyNameEmailDto);
}
```

æœ€åï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š

```
Hibernate: select user0_.name as col_0_0_, user0_.email as col_1_0_ from user user0_ where user0_.email=?
UserOnlyNameEmailDto(name=jack12, email=123456@126.com)
```

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å»çœ‹æºç çš„è¯ï¼Œçœ‹å…³é”®çš„ PreferredConstructorDiscoverer ç±»æ—¶ä¼šå‘ç°ï¼ŒUserDTO é‡Œé¢åªèƒ½æœ‰ä¸€ä¸ªå…¨å‚æ•°æ„é€ æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![img](../images/CgqCHl9rDDKAPKAIAASfIaP3unE060.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒConstructor é€‰æ‹©çš„æ—¶å€™ä¼šå¸®æˆ‘ä»¬åšæ„é€ å‚æ•°çš„é€‰æ‹©ï¼Œå¦‚æœ DTO é‡Œé¢æœ‰å¤šä¸ªæ„é€ æ–¹æ³•ï¼Œå°±ä¼šæŠ¥è½¬åŒ–é”™è¯¯çš„å¼‚å¸¸ï¼Œè¿™ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå¼‚å¸¸æ˜¯è¿™æ ·çš„ï¼š

```
No converter found capable of converting from type [com.example.jpa.example1.User] to type [com.example.jpa.example1.UserOnlyNameEmailDto
```

æ‰€ä»¥è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹å°±æ˜¯è¿”å›çš„ç»“æœä¸éœ€è¦æ˜¯ä¸ªå®ä½“å¯¹è±¡ï¼Œå¯¹ DB ä¸èƒ½è¿›è¡Œé™¤äº†æŸ¥è¯¢ä¹‹å¤–çš„ä»»ä½•æ“ä½œï¼›ç¼ºç‚¹å°±æ˜¯æœ‰ set æ–¹æ³•è¿˜å¯ä»¥æ”¹å˜é‡Œé¢çš„å€¼ï¼Œæ„é€ æ–¹æ³•ä¸èƒ½æ›´æ”¹ï¼Œå¿…é¡»å…¨å‚æ•°ï¼Œè¿™æ ·å¦‚æœæ˜¯ä¸ç†Ÿæ‚‰ JPA çš„æ–°äººæ“ä½œçš„æ—¶å€™å¾ˆå®¹æ˜“å¼•å‘ Bugã€‚



#### ç¬¬ä¸‰ç§æ–¹æ³•ï¼šè¿”å›ç»“æœæ˜¯ä¸€ä¸ª POJO çš„æ¥å£ã€æŒæ¡ã€‘

æˆ‘ä»¬å†æ¥å­¦ä¹ ä¸€ç§è¿”å›ä¸åŒå­—æ®µçš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼ä¸ä¸Šé¢ä¸¤ç§çš„åŒºåˆ«æ˜¯åªéœ€è¦å®šä¹‰æ¥å£ï¼Œå®ƒçš„å¥½å¤„æ˜¯åªè¯»ï¼Œä¸éœ€è¦æ·»åŠ æ„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬ä½¿ç”¨èµ·æ¥éå¸¸çµæ´»ï¼Œä¸€èˆ¬å¾ˆéš¾äº§ç”Ÿ Bugï¼Œé‚£ä¹ˆå®ƒæ€ä¹ˆå®ç°å‘¢ï¼Ÿ

é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ª UserOnlyName çš„æ¥å£ï¼š

```java
public interface UserOnlyName {
    String getName();
    String getEmail();
}
```

å…¶æ¬¡ï¼Œæˆ‘ä»¬çš„ UserRepository å†™æ³•å¦‚ä¸‹ï¼š

```java
public interface UserRepository extends JpaRepository<User,Long> {
    /**
     * æ¥å£çš„æ–¹å¼è¿”å›DTO
     * @param address
     * @return
     */
    UserOnlyName findByAddress(String address);
}
```

ç„¶åï¼Œæµ‹è¯•ç”¨ä¾‹çš„å†™æ³•å¦‚ä¸‹ï¼š

```java
@Test
public void testProjections() {
    userRepository.save(User.builder()
                        .name("jack12").email("123456@126.com").sex("man").address("shanghai").build());
    UserOnlyName userOnlyName = userRepository.findByAddress("shanghai");
    System.out.println(userOnlyName);
}
```

æœ€åï¼Œæˆ‘ä»¬çš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

```
Hibernate: select user0_.name as col_0_0_, user0_.email as col_1_0_ from user user0_ where user0_.address=?
org.springframework.data.jpa.repository.query.AbstractJpaQuery$TupleConverter$TupleBackedMap@1d369521
```

è¿™ä¸ªæ—¶å€™ä¼šå‘ç°æˆ‘ä»¬çš„ userOnlyName æ¥å£æˆäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œé‡Œé¢é€šè¿‡ Map çš„æ ¼å¼åŒ…å«äº†æˆ‘ä»¬çš„è¦è¿”å›å­—æ®µçš„å€¼ï¼ˆå¦‚ï¼šnameã€emailï¼‰ï¼Œæˆ‘ä»¬ç”¨çš„æ—¶å€™ç›´æ¥è°ƒç”¨æ¥å£é‡Œé¢çš„æ–¹æ³•å³å¯ï¼Œå¦‚ userOnlyName.getName() å³å¯ï¼›è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯æ¥å£ä¸ºåªè¯»ï¼Œå¹¶ä¸”è¯­ä¹‰æ›´æ¸…æ™°ï¼Œæ‰€ä»¥è¿™ç§æ˜¯æˆ‘æ¯”è¾ƒæ¨èçš„åšæ³•ã€‚

å…¶ä¸­æºç æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæˆ‘æ¥è¯´ä¸€ä¸ªç±»ï¼Œä½ å¯ä»¥é€šè¿‡ debugï¼Œçœ‹ä¸€ä¸‹æœ€ç»ˆ DTO å’Œæ¥å£è½¬åŒ–æ‰§è¡Œçš„ query æœ‰ä»€ä¹ˆä¸åŒï¼Œçœ‹ä¸‹å›¾ä¸­è€å¸ˆ debug æ˜¾ç¤ºçš„ Query è¯­å¥çš„ä½ç½®ï¼š

![img](../images/CgqCHl9rDD6AWKs9AAE8kGFOxmo130.png)

å›¾ä¸€ï¼šæ˜¯è¿”å› DTO æ¥å£å½¢å¼çš„ query ç”Ÿæˆçš„ JPQLã€‚

![img](../images/CgqCHl9rDEWAdoxmAARwd1XSUzo704.png)

å›¾äºŒï¼šæ˜¯è¿”å› DTO ç±»çš„æ—¶å€™ QueryStructure ç”Ÿæˆçš„ JPQL è¯­å¥ã€‚

ä¸¤ç§æœ€å¤§çš„åŒºåˆ«æ˜¯ DTO ç±»éœ€è¦æ„é€ æ–¹æ³• new ä¸€ä¸ªå¯¹è±¡å‡ºæ¥ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ç¬¬äºŒç§æ–¹æ³•é‡Œé¢éœ€è¦æ³¨æ„çš„ DTO æ„é€ å‡½æ•°çš„é—®é¢˜ï¼›è€Œé€šè¿‡å›¾ä¸€æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¥å£ç›´æ¥é€šè¿‡ as åˆ«åï¼Œæ˜ å°„æˆ hashmap å³å¯ï¼Œéå¸¸çµæ´»ã€‚



#### ç¬¬å››ç§æ–¹æ³•ï¼š@Query

ä»¥ä¸Šå°±æ˜¯è¿”å› DTO çš„å‡ ç§å¸¸è§çš„æ–¹æ³•äº†ï¼Œä½ åœ¨å®é™…åº”ç”¨æ—¶ï¼Œè¦ä¸æ–­ debug å’Œä»”ç»†ä½“ä¼šã€‚å½“ç„¶é™¤äº†è¿™äº›å¤–ï¼Œè¿˜æœ‰ @Query æ³¨è§£ä¹Ÿæ˜¯å¯ä»¥åšåˆ°







## DQMâ€”JPQL @Query å¢åˆ æ”¹æŸ¥ ğŸ”¥

JPQLï¼ˆJava Persistence Query Languageï¼‰ã€‚åŸºäºé¦–æ¬¡åœ¨EJB2.0ä¸­å¼•å…¥çš„EJBæŸ¥è¯¢è¯­è¨€(EJB QL)ï¼ŒJavaæŒä¹…åŒ–æŸ¥è¯¢è¯­è¨€(JPQL)æ˜¯ä¸€ç§å¯ç§»æ¤çš„æŸ¥è¯¢è¯­è¨€ï¼Œæ—¨åœ¨ä»¥é¢å‘å¯¹è±¡è¡¨è¾¾å¼è¯­è¨€çš„è¡¨è¾¾å¼ï¼Œå°†SQLè¯­æ³•å’Œç®€å•æŸ¥è¯¢è¯­ä¹‰ç»‘å®šåœ¨ä¸€èµ·ï¼Œä½¿ç”¨è¿™ç§è¯­è¨€ç¼–å†™çš„æŸ¥è¯¢æ˜¯å¯ç§»æ¤çš„ï¼Œå¯ä»¥è¢«ç¼–è¯‘æˆæ‰€æœ‰ä¸»æµæ•°æ®åº“æœåŠ¡å™¨ä¸Šçš„SQLã€‚é¿å…äº†ç¨‹åºä¸æ•°æ®åº“ SQL è¯­å¥è€¦åˆä¸¥é‡ï¼Œæ¯”è¾ƒé€‚åˆè·¨æ•°æ®æºçš„åœºæ™¯ï¼ˆä¸€ä¼šå„¿ MySQLï¼Œä¸€ä¼šå„¿ Oracle ç­‰ï¼‰

å…¶ç‰¹å¾ä¸åŸç”ŸSQLè¯­å¥ç±»ä¼¼ï¼Œå¹¶ä¸”å®Œå…¨**é¢å‘å¯¹è±¡**ï¼Œé€šè¿‡**ç±»å**å’Œ**å±æ€§**è®¿é—®ï¼Œè€Œ**ä¸æ˜¯è¡¨åå’Œè¡¨ä¸­å­—æ®µ**ã€‚ä¸æ”¯æŒ`SELECT *`ï¼Œä½†æ˜¯æ”¯æŒ`COUNT(*)`ã€‚**å•è¡¨å¤šè¡¨éƒ½æ”¯æŒ**ï¼

ä½¿ç”¨å¦‚ä¸‹ï¼š

*   ç‰¹æœ‰çš„æŸ¥è¯¢ï¼šéœ€è¦åœ¨ Repository æ¥å£ä¸Šé…ç½®æ–¹æ³•
*   åœ¨é…ç½®çš„æ–¹æ³•ä¸Šï¼Œä½¿ç”¨`@Query`æ³¨è§£çš„å½¢å¼é…ç½®JPQLè¯­å¥



```java
public interface ArticleRepository extends JpaRepository<Article, Long> {
    
    /**
     * ?1 ä»£è¡¨å‚æ•°çš„å ä½ç¬¦ï¼Œå…¶ä¸­1ä»£è¡¨å¯¹åº”æ–¹æ³•ä¸­çš„å‚æ•°ç´¢å¼•ï¼ˆå‚æ•°ç´¢å¼•ä»1å¼€å§‹ï¼‰
     */
    @Query("from Article where author = ?1 and title = ?2")
    Article jpqlFindByAuthorAndTitle(String author, String title);

    
    
    /**
     * ?1 ä»£è¡¨å‚æ•°çš„å ä½ç¬¦ï¼Œå…¶ä¸­1ä»£è¡¨å¯¹åº”æ–¹æ³•ä¸­çš„å‚æ•°ç´¢å¼•ï¼ˆå‚æ•°ç´¢å¼•ä»1å¼€å§‹ï¼‰
     */
    @Query("update Article set author = ?1 where aid = ?2")
    @Modifying// ä»£è¡¨ä¿®æ”¹æ“ä½œï¼ˆupdateã€deleteã€insert éƒ½å¯ä»¥ï¼‰
    void updateAuthorById(String author, Long aid);

    /**
     * ä¸æŒ‡å®šåˆ™æŒ‰ç…§æ–¹æ³•ä¸­å‚æ•°ä½ç½®å¯¹åº”ã€‚â€œ:å‚æ•°åç§°â€œ ä¹Ÿå¯ä»¥å½“åšå ä½ç¬¦
     */
    @Query("update Article set author = :author where aid = :aid")
    @Modifying// ä»£è¡¨ä¿®æ”¹æ“ä½œï¼ˆupdateã€deleteã€insert éƒ½å¯ä»¥ï¼‰
    void updateAuthorById2(String author, Long aid);
}
```

```java
@DataJpaTest
// DataJpaTestã€MybatisTest ä¼šé»˜è®¤ä½¿ç”¨å…¶æµ‹è¯•æ•°æ®æºæ›¿ä»£ï¼Œè‹¥è¦ä½¿ç”¨è‡ªå·±é…ç½®çš„ï¼Œéœ€è¦æ·»åŠ å¦‚ä¸‹æ³¨è§£
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
public class ArticleJpqlRepositoryTest {

    @Autowired
    private ArticleRepository articleRepository;


    @Test
    void testJpqlFindByAuthorAndTitle() {
        Article article = articleRepository.jpqlFindByAuthorAndTitle("ç”·ç¥", "ç‰›é€¼");
        Assertions.assertNotNull(article);
    }


    // @Test å•å…ƒæµ‹è¯•é»˜è®¤æµ‹è¯•å®Œä¼šå›æ»šï¼Œå¯ä»¥é…ç½®å¦‚ä¸‹æ³¨è§£æ¥é˜²æ­¢å›æ»š
    @Test
    @Rollback(false)
    void testUpdateAuthorById() {
        articleRepository.updateAuthorById("ç”·ç¥1", 5L);
    }

    // @Test å•å…ƒæµ‹è¯•é»˜è®¤æµ‹è¯•å®Œä¼šå›æ»šï¼Œå¯ä»¥é…ç½®å¦‚ä¸‹æ³¨è§£æ¥é˜²æ­¢å›æ»š
    @Test
    @Rollback(false)
    void testUpdateAuthorById2() {
        articleRepository.updateAuthorById2("ç”·ç¥2", 6L);
    }
}
```





### å¿«é€Ÿä½“éªŒ @Query çš„æ–¹æ³•

å¼€å§‹ä¹‹å‰ï¼Œé¦–å…ˆæ¥çœ‹ä¸€ä¸ª Demoï¼Œæ²¿ç”¨æˆ‘ä»¬ä¹‹å‰çš„ä¾‹å­ï¼Œæ–°å¢ä¸€ä¸ª @Query çš„æ–¹æ³•ï¼Œå¿«é€Ÿä½“éªŒä¸€ä¸‹ @Query çš„ä½¿ç”¨æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public interface UserDtoRepository extends JpaRepository<User,Long> {
   //é€šè¿‡queryæ³¨è§£æ ¹æ®nameæŸ¥è¯¢userä¿¡æ¯
   @Query("From User where name=:name")
   User findByQuery(@Param("name") String nameParam);
}
```

ç„¶åï¼Œæˆ‘ä»¬æ–°å¢ä¸€ä¸ªæµ‹è¯•ç±»ï¼š

```java
@DataJpaTest
// DataJpaTestã€MybatisTest ä¼šé»˜è®¤ä½¿ç”¨å…¶æµ‹è¯•æ•°æ®æºæ›¿ä»£ï¼Œè‹¥è¦ä½¿ç”¨è‡ªå·±é…ç½®çš„ï¼Œéœ€è¦æ·»åŠ å¦‚ä¸‹æ³¨è§£
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
public class UserRepositoryQueryTest {
   @Autowired
   private UserDtoRepository userDtoRepository;
   @Test
   public void testQueryAnnotation() {
//æ–°å¢ä¸€æ¡æ•°æ®æ–¹ä¾¿æµ‹è¯•      userDtoRepository.save(User.builder().name("jackxx").email("123456@126.com").sex("man").address("shanghai").build());
      //è°ƒç”¨ä¸Šé¢çš„æ–¹æ³•æŸ¥çœ‹ç»“æœ
      User user2 = userDtoRepository.findByQuery("jack");
      System.out.println(user2);
   }
}
```

æœ€åï¼Œçœ‹åˆ°è¿è¡Œçš„ç»“æœå¦‚ä¸‹ï¼š

```
Hibernate: insert into user (address, email, name, sex, version, id) values (?, ?, ?, ?, ?, ?)
Hibernate: select user0_.id as id1_0_, user0_.address as address2_0_, user0_.email as email3_0_, user0_.name as name4_0_, user0_.sex as sex5_0_, user0_.version as version6_0_ from user user0_ where user0_.name=?
User(id=1, name=jack, email=123456@126.com, version=0, sex=man, address=shanghai)
```

é€šè¿‡ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬å‘ç°ï¼Œè¿™æ¬¡ä¸æ˜¯é€šè¿‡æ–¹æ³•åæ¥ç”ŸæˆæŸ¥è¯¢è¯­æ³•ï¼Œè€Œæ˜¯ @Query æ³¨è§£åœ¨å…¶ä¸­èµ·äº†ä½œç”¨ï¼Œä½¿ "From User where name=:name"JPQL ç”Ÿæ•ˆäº†ã€‚é‚£ä¹ˆå®ƒçš„å®ç°åŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡æºç æ¥çœ‹ä¸€ä¸‹ã€‚



### JpaQueryLookupStrategy å…³é”®æºç å‰–æ

æˆ‘ä»¬åœ¨ 03 è¯¾æ—¶å·²ç»ä»‹ç»è¿‡ QueryLookupStrategy çš„ç­–ç•¥å€¼æœ‰å“ªäº›ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸‹æºç æ˜¯å¦‚ä½•èµ·ä½œç”¨çš„ã€‚

æˆ‘ä»¬å…ˆæ‰“å¼€ QueryExecutorMethodInterceptor ç±»ï¼Œæ‰¾åˆ°å¦‚ä¸‹ä»£ç ï¼š

![img](../images/CgqCHl9rKUmAaHv0AAHfhSZLnCM314.png)

å†è¿è¡Œä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹ï¼Œè¿™æ—¶å€™åœ¨è¿™é‡Œè®¾ç½®ä¸€ä¸ªæ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°é»˜è®¤çš„ç­–ç•¥æ˜¯CreateIfNotFoundï¼Œä¹Ÿå°±æ˜¯å¦‚æœæœ‰@Queryæ³¨è§£ï¼Œé‚£ä¹ˆä»¥@Queryçš„æ³¨è§£å†…å®¹ä¸ºå‡†ï¼Œå¯ä»¥å¿½ç•¥æ–¹æ³•åã€‚

æˆ‘ä»¬ç»§ç»­å¾€åé¢çœ‹ï¼Œè¿›å…¥åˆ° lookupStrategy.resolveQuery é‡Œé¢ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![img](../images/Ciqc1F9rKU-AKQ5bAAWmeacWTAQ768.png)

é€šè¿‡ä¸Šå›¾çš„æ–­ç‚¹å’Œçº¢æ¡†ä¹‹å¤„ï¼Œæˆ‘ä»¬ä¹Ÿå‘ç°äº†ï¼ŒSpring Data JPA è¿™ä¸ªåœ°æ–¹ä½¿ç”¨äº†ç­–ç•¥ã€æ¨¡å¼ï¼Œå½“æˆ‘ä»¬è‡ªå·±å†™ç­–ç•¥æ¨¡å¼çš„æ—¶å€™ä¹Ÿå¯ä»¥è¿›è¡Œå‚è€ƒã€‚

é‚£ä¹ˆæ¥ç€å¾€ä¸‹ debugï¼Œè¿›å…¥åˆ° resolveQuery æ–¹æ³•é‡Œé¢ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](../images/Ciqc1F9rKVaARZk-AAYrhMro5y4100.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å›¾ä¸­ â‘ å¤„ï¼Œå¦‚æœ Query æ³¨è§£æ‰¾åˆ°äº†ï¼Œå°±ä¸ä¼šèµ°åˆ° â‘¡ å¤„äº†ï¼ˆå³æˆ‘ä»¬ç¬¬ 03 è¯¾æ—¶ä¸­è®²çš„ Defined Query Method è¯­æ³•ï¼‰ã€‚

è¿™æ—¶æˆ‘ä»¬ç‚¹å¼€ Query é‡Œé¢çš„ Query å±æ€§çš„å€¼çœ‹ä¸€ä¸‹ï¼Œä½ ä¼šå‘ç°è¿™é‡ŒåŒæ—¶ç”Ÿæˆäº†ä¸¤ä¸ª SQLï¼šä¸€ä¸ªæ˜¯æŸ¥è¯¢æ€»æ•°çš„ Query å®šä¹‰ï¼Œå¦ä¸€ä¸ªæ˜¯æŸ¥è¯¢ç»“æœ Query å®šä¹‰ã€‚

åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»åŸºæœ¬æ˜ç™½äº†ï¼Œå¦‚æœæƒ³çœ‹çœ‹ Query å…·ä½“æ˜¯æ€ä¹ˆç”Ÿæˆçš„ã€ä¸Šé¢çš„ @Param æ³¨è§£æ˜¯æ€ä¹ˆç”Ÿæ•ˆçš„ï¼Œå¯ä»¥åœ¨ä¸Šé¢çš„å›¾ â‘  å¤„ debug ç»§ç»­å¾€é‡Œé¢çœ‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![img](../images/Ciqc1F9rKV2AMpasAAE0Zjc3fRw672.png)

æˆ‘ä»¬ç»§ç»­ä¸€è·¯ debug å°±å¯ä»¥çœ‹åˆ°æ€ä¹ˆé€šè¿‡ @Query å»ç”Ÿæˆ SQL äº†ï¼Œè¿™ä¸ªä¸æ˜¯æœ¬èŠ‚çš„é‡ç‚¹ï¼Œæˆ‘åœ¨è¿™é‡Œå°±ç®€å•å¸¦è¿‡äº†ï¼Œä½ æœ‰å…´è¶£å¯ä»¥è‡ªå·±å» debug çœ‹ä¸€ä¸‹ã€‚

é‚£ä¹ˆåŸç†æˆ‘ä»¬æŒæ¡äº†ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹ @Query ç»™æˆ‘ä»¬æä¾›äº†å“ªäº›è¯­æ³•å§ï¼Œå…ˆçœ‹ä¸‹åŸºæœ¬ç”¨æ³•ã€‚



### @Query çš„åŸºæœ¬ä»‹ç»ã€äº†è§£ã€‘

```java
public @interface Query {
   /**
    * æŒ‡å®šJPQLçš„æŸ¥è¯¢è¯­å¥ã€‚ï¼ˆnativeQuery=trueçš„æ—¶å€™ï¼Œæ˜¯åŸç”Ÿçš„Sqlè¯­å¥ï¼‰
	*/
   String value() default "";
   /**
	* æŒ‡å®šcountçš„JPQLè¯­å¥ï¼Œå¦‚æœä¸æŒ‡å®šå°†æ ¹æ®queryè‡ªåŠ¨ç”Ÿæˆã€‚
    * ï¼ˆå¦‚æœå½“nativeQuery=trueçš„æ—¶å€™ï¼ŒæŒ‡çš„æ˜¯åŸç”Ÿçš„Sqlè¯­å¥ï¼‰
    */
   String countQuery() default "";
   /**
    * æ ¹æ®å“ªä¸ªå­—æ®µæ¥countï¼Œä¸€èˆ¬é»˜è®¤å³å¯ã€‚
	*/
   String countProjection() default "";
   /**
    * é»˜è®¤æ˜¯falseï¼Œè¡¨ç¤ºvalueé‡Œé¢æ˜¯ä¸æ˜¯åŸç”Ÿçš„sqlè¯­å¥
	*/
   boolean nativeQuery() default false;
   /**
    * å¯ä»¥æŒ‡å®šä¸€ä¸ªqueryçš„åå­—ï¼Œå¿…é¡»å”¯ä¸€çš„ã€‚
	* å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤çš„ç”Ÿæˆè§„åˆ™æ˜¯ï¼š
    * {$domainClass}.${queryMethodName}
    */
   String name() default "";
   /*
    * å¯ä»¥æŒ‡å®šä¸€ä¸ªcountçš„queryçš„åå­—ï¼Œå¿…é¡»å”¯ä¸€çš„ã€‚
	* å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤çš„ç”Ÿæˆè§„åˆ™æ˜¯ï¼š
    * {$domainClass}.${queryMethodName}.count
    */
   String countName() default "";
}
```

æ‰€ä»¥åˆ°è¿™é‡Œä½ ä¼šå‘ç°ï¼Œ @Query ç”¨æ³•æ˜¯ä½¿ç”¨ JPQL ä¸ºå®ä½“åˆ›å»ºå£°æ˜å¼æŸ¥è¯¢æ–¹æ³•ã€‚æˆ‘ä»¬ä¸€èˆ¬åªéœ€è¦å…³å¿ƒ @Query é‡Œé¢çš„ value å’Œ nativeQueryã€countQuery çš„å€¼å³å¯ï¼Œå› ä¸ºå…¶ä»–çš„ä¸å¸¸ç”¨ã€‚

ä½¿ç”¨å£°æ˜å¼ JPQL æŸ¥è¯¢æœ‰ä¸ªå¥½å¤„ï¼Œå°±æ˜¯å¯åŠ¨çš„æ—¶å€™å°±çŸ¥é“ä½ çš„è¯­æ³•æ­£ç¡®ä¸æ­£ç¡®ã€‚é‚£ä¹ˆæˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹ JPQL è¯­æ³•ã€‚

#### JPQL çš„è¯­æ³•

æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æŸ¥è¯¢çš„è¯­æ³•ç»“æ„ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
SELECT ... FROM ...
[WHERE ...]
[GROUP BY ... [HAVING ...]]
[ORDER BY ...]
```

ä½ ä¼šå‘ç°å®ƒçš„è¯­æ³•ç»“æ„æœ‰ç‚¹ç±»ä¼¼æˆ‘ä»¬ SQLï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ JPQL FROM åé¢è·Ÿçš„æ˜¯å¯¹è±¡ï¼Œè€Œ SQL é‡Œé¢çš„å­—æ®µå¯¹åº”çš„æ˜¯å¯¹è±¡é‡Œé¢çš„å±æ€§å­—æ®µã€‚

åŒç†æˆ‘ä»¬çœ‹ä¸€ä¸‹ update å’Œ delete çš„è¯­æ³•ç»“æ„ï¼š

```
DELETE FROM ... [WHERE ...]
UPDATE ... SET ... [WHERE ...]
```

å…¶ä¸­â€œ...â€çœç•¥çš„éƒ¨åˆ†æ˜¯å®ä½“å¯¹è±¡åå­—å’Œå®ä½“å¯¹è±¡é‡Œé¢çš„å­—æ®µåå­—ï¼Œè€Œå…¶ä¸­ç±»ä¼¼ SQL ä¸€æ ·åŒ…å«çš„è¯­æ³•å…³é”®å­—æœ‰ï¼šSELECT FROM WHERE UPDATE DELETE JOIN OUTER INNER LEFT GROUP BY HAVING FETCH DISTINCT OBJECT NULL TRUE FALSE NOT AND OR BETWEEN LIKE IN AS UNKNOWN EMPTY MEMBER OF IS AVG MAX MIN SUM COUNT ORDER BY ASC DESC MOD UPPER LOWER TRIM POSITION CHARACTER_LENGTH CHAR_LENGTH BIT_LENGTH CURRENT_TIME CURRENT_DATE CURRENT_TIMESTAMP NEW EXISTS ALL ANY SOME è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬å°±ä¸ä¸€ä¸€ä»‹ç»äº†ã€‚

è¿™ä¸ªè¯­æ³•ç”¨èµ·æ¥ä¸å¤æ‚ï¼Œé‡åˆ°é—®é¢˜æ—¶ï¼Œç®€å•æƒ³ä¸€ä¸‹ SQL å°±å¯ä»¥çŸ¥é“äº†ï¼Œæˆ‘æ¨èä¸€ä¸ª Oracle çš„æ–‡æ¡£åœ°å€ï¼šhttps://docs.oracle.com/html/E13946_04/ejb3_langref.htmlï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡æŸ¥çœ‹è¿™ä¸ªæ–‡æ¡£ï¼Œæ‰¾åˆ°è§£å†³é—®é¢˜çš„åŠæ³•ã€‚

é‚£ä¹ˆ JPQL çš„è¯­æ³•ä½ å·²ç»å¤§æ¦‚äº†è§£äº†ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹ @Query æ€ä¹ˆä½¿ç”¨ã€‚







### @Query ç”¨æ³•æ¡ˆä¾‹ã€æŒæ¡ã€‘

æˆ‘ä»¬é€šè¿‡å‡ ä¸ªæ¡ˆä¾‹æ¥äº†è§£ä¸€ä¸‹ @Query çš„ç”¨æ³•ï¼Œä½ å°±å¯ä»¥çŸ¥é“ @Query æ€ä¹ˆä½¿ç”¨ã€æ€ä¹ˆä¼ é€’å‚æ•°ã€æ€ä¹ˆåˆ†é¡µç­‰ã€‚

**æ¡ˆä¾‹ 1ï¼š** è¦åœ¨ Repository çš„æŸ¥è¯¢æ–¹æ³•ä¸Šå£°æ˜ä¸€ä¸ªæ³¨è§£ï¼Œè¿™é‡Œå°±æ˜¯ @Query æ³¨è§£æ ‡æ³¨çš„åœ°æ–¹ã€‚

```java
public interface UserRepository extends JpaRepository<User, Long>{
  @Query("select u from User u where u.emailAddress = ?1")
  User findByEmailAddress(String emailAddress);
}
```

**æ¡ˆä¾‹ 2ï¼š** LIKE æŸ¥è¯¢ï¼Œæ³¨æ„ firstname ä¸ä¼šè‡ªåŠ¨åŠ ä¸Šâ€œ%â€å…³é”®å­—ã€‚

```java
public interface UserRepository extends JpaRepository<User, Long> {
  @Query("select u from User u where u.firstname like %?1")
  List<User> findByFirstnameEndsWith(String firstname);
}
```

**æ¡ˆä¾‹ 3ï¼š** ç›´æ¥ç”¨åŸå§‹ SQLï¼ŒnativeQuery = true å³å¯ã€‚

```java
public interface UserRepository extends JpaRepository<User, Long> {
  @Query(value = "SELECT * FROM USERS WHERE EMAIL_ADDRESS = ?1", nativeQuery = true)
  User findByEmailAddress(String emailAddress);
}
```

æ³¨æ„ï¼šnativeQuery ä¸æ”¯æŒç›´æ¥ Sort çš„å‚æ•°æŸ¥è¯¢ã€‚

**æ¡ˆä¾‹ 4ï¼š** ä¸‹é¢æ˜¯****nativeQuery çš„æ’åºé”™è¯¯çš„å†™æ³•ï¼Œä¼šå¯¼è‡´æ— æ³•å¯åŠ¨ã€‚

```java
public interface UserRepository extends JpaRepository<User, Long> {
    @Query(value = "select * from user_info where first_name=?1",nativeQuery = true)
    List<UserInfoEntity> findByFirstName(String firstName,Sort sort);
}
```

**æ¡ˆä¾‹ 5ï¼š** nativeQuery æ’åºçš„æ­£ç¡®å†™æ³•ã€‚

```java
@Query(value = "select * from user_info where first_name=?1 order by ?2",nativeQuery = true)
List<UserInfoEntity> findByFirstName(String firstName,String sort);

//è°ƒç”¨çš„åœ°æ–¹å†™æ³•last_nameæ˜¯æ•°æ®é‡Œé¢çš„å­—æ®µåï¼Œä¸æ˜¯å¯¹è±¡çš„å­—æ®µå
repository.findByFirstName("jackzhang","last_name");
```

é€šè¿‡ä¸Šé¢å‡ ä¸ªæ¡ˆä¾‹ï¼Œæˆ‘ä»¬çœ‹åˆ°äº† @Query çš„å‡ ç§ç”¨æ³•ï¼Œä½ å°±ä¼šæ˜ç™½æ’åºã€å‚æ•°ã€ä½¿ç”¨æ–¹æ³•ã€LIKEã€åŸå§‹ SQL æ€ä¹ˆå†™ã€‚ä¸‹é¢ç»§ç»­é€šè¿‡æ¡ˆä¾‹æ¥çœ‹ä¸‹ @Query çš„æ’åºã€‚







### @Query çš„æ’åº

@Queryä¸­åœ¨ç”¨JPQLçš„æ—¶å€™ï¼Œæƒ³è¦å®ç°æ’åºï¼Œæ–¹æ³•ä¸Šç›´æ¥ç”¨ PageRequest æˆ–è€… Sort å‚æ•°éƒ½å¯ä»¥åšåˆ°ã€‚

åœ¨æ’åºå®ä¾‹ä¸­ï¼Œå®é™…ä½¿ç”¨çš„å±æ€§éœ€è¦ä¸å®ä½“æ¨¡å‹é‡Œé¢çš„å­—æ®µç›¸åŒ¹é…ï¼Œè¿™æ„å‘³ç€å®ƒä»¬éœ€è¦è§£æä¸ºæŸ¥è¯¢ä¸­ä½¿ç”¨çš„å±æ€§æˆ–åˆ«åã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¾‹å­ï¼Œè¿™æ˜¯ä¸€ä¸ª`state_field_path_expression JPQL`çš„å®šä¹‰ï¼Œå¹¶ä¸” Sort çš„å¯¹è±¡æ”¯æŒä¸€äº›ç‰¹å®šçš„å‡½æ•°ã€‚

**æ¡ˆä¾‹ 6ï¼š** Sort and JpaSort çš„ä½¿ç”¨ï¼Œå®ƒå¯ä»¥è¿›è¡Œæ’åºã€‚

```java
public interface UserRepository extends JpaRepository<User, Long> {
    @Query("select u from User u where u.lastname like ?1%")
    List<User> findByAndSort(String lastname, Sort sort);
    @Query("select u.id, LENGTH(u.firstname) as fn_len from User u where u.lastname like ?1%")
    List<Object[]> findByAsArrayAndSort(String lastname, Sort sort);
}

//è°ƒç”¨æ–¹çš„å†™æ³•ï¼Œå¦‚ä¸‹ï¼š
repo.findByAndSort("lannister", new Sort("firstname"));
repo.findByAndSort("stark", new Sort("LENGTH(firstname)"));
repo.findByAndSort("targaryen", JpaSort.unsafe("LENGTH(firstname)"));
repo.findByAsArrayAndSort("bolton", new Sort("fn_len"));
```



### @Query çš„åˆ†é¡µ

@Query çš„åˆ†é¡µåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œåˆ†åˆ«ä¸º JPQL çš„æ’åºå’Œ nativeQuery çš„æ’åºã€‚çœ‹ä¸‹é¢çš„æ¡ˆä¾‹ã€‚

**æ¡ˆä¾‹ 7**ï¼šç›´æ¥ç”¨ Page å¯¹è±¡æ¥å—æ¥å£ï¼Œå‚æ•°ç›´æ¥ç”¨ Pageable çš„å®ç°ç±»å³å¯ã€‚

```java
public interface UserRepository extends JpaRepository<User, Long> {
  @Query(value = "select u from User u where u.lastname = ?1")
  Page<User> findByLastname(String lastname, Pageable pageable);
}

//è°ƒç”¨è€…çš„å†™æ³•
repository.findByFirstName("jackzhang",new PageRequest(1,10));
```

**æ¡ˆä¾‹ 8ï¼š**@Query å¯¹åŸç”Ÿ SQL çš„åˆ†é¡µæ”¯æŒï¼Œå¹¶ä¸æ˜¯ç‰¹åˆ«å‹å¥½ï¼Œå› ä¸ºè¿™ç§å†™æ³•æ¯”è¾ƒâ€œéª‡å®¢â€ï¼Œå¯èƒ½éšç€ç‰ˆæœ¬çš„ä¸åŒä¼šæœ‰æ‰€å˜åŒ–ã€‚æˆ‘ä»¬ä»¥ MySQL ä¸ºä¾‹ã€‚

```java
public interface UserRepository extends JpaRepository<UserInfoEntity, Integer>, JpaSpecificationExecutor<UserInfoEntity> {
   @Query(value = "select * from user_info where first_name=?1 /* #pageable# */",
         countQuery = "select count(*) from user_info where first_name=?1",
         nativeQuery = true)
   Page<UserInfoEntity> findByFirstName(String firstName, Pageable pageable);
}

//è°ƒç”¨è€…çš„å†™æ³•
return userRepository.findByFirstName("jackzhang",new PageRequest(1,10, Sort.Direction.DESC,"last_name"));
//æ‰“å°å‡ºæ¥çš„sql
select  *   from  user_info  where  first_name=? /* #pageable# */  order by  last_name desc limit ?, ?
```

**è¿™é‡Œéœ€è¦æ³¨æ„ï¼šè¿™ä¸ªæ³¨é‡Š /\* #pageable# \*/ å¿…é¡»æœ‰ã€‚**
å¦å¤–ï¼Œéšç€ç‰ˆæœ¬çš„å˜åŒ–ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰å¯èƒ½ä¼šè¿›è¡Œä¼˜åŒ–ã€‚æ­¤å¤–è¿˜æœ‰ä¸€ç§å®ç°æ–¹æ³•ï¼Œå°±æ˜¯è‡ªå·±å†™ä¸¤ä¸ªæŸ¥è¯¢æ–¹æ³•ï¼Œè‡ªå·±æ‰‹åŠ¨åˆ†é¡µã€‚

å…³äº @Query çš„ç”¨æ³•ï¼Œè¿˜æœ‰ä¸€ä¸ªéœ€è¦äº†è§£çš„å†…å®¹ï¼Œå°±æ˜¯ @ Param ç”¨æ³•ã€‚



### @Param ç”¨æ³•

@Param æ³¨è§£æŒ‡å®šæ–¹æ³•å‚æ•°çš„å…·ä½“åç§°ï¼Œé€šè¿‡ç»‘å®šçš„å‚æ•°åå­—æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ï¼Œè¿™æ ·ä¸éœ€è¦å…³å¿ƒå‚æ•°çš„é¡ºåºã€‚**æˆ‘æ¯”è¾ƒæ¨èè¿™ç§åšæ³•ï¼Œå› ä¸ºå®ƒæ¯”è¾ƒåˆ©äºä»£ç é‡æ„**ã€‚å¦‚æœä¸ç”¨ @Param ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå‚æ•°æ˜¯æœ‰åºçš„ï¼Œè¿™ä½¿å¾—æŸ¥è¯¢æ–¹æ³•å¯¹å‚æ•°ä½ç½®çš„é‡æ„å®¹æ˜“å‡ºé”™ã€‚æˆ‘ä»¬çœ‹ä¸ªæ¡ˆä¾‹ã€‚

**æ¡ˆä¾‹ 9**ï¼šæ ¹æ® firstname å’Œ lastname å‚æ•°æŸ¥è¯¢ user å¯¹è±¡ã€‚

```java
public interface UserRepository extends JpaRepository<User, Long> {
  @Query("select u from User u where u.firstname = :firstname or u.lastname = :lastname")
  User findByLastnameOrFirstname(@Param("lastname") String lastname,
                                 @Param("firstname") String firstname);
}
```

**æ¡ˆä¾‹ 10ï¼š** æ ¹æ®å‚æ•°è¿›è¡ŒæŸ¥è¯¢ï¼Œ**top 10 å‰é¢è¯´çš„â€œquery methodâ€å…³é”®å­—ç…§æ ·æœ‰ç”¨**ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public interface UserRepository extends JpaRepository<User, Long> {
    @Query("select u from User u where u.firstname = :firstname or u.lastname = :lastname")
    User findTop10ByLastnameOrFirstname(@Param("lastname") String lastname,
                                        @Param("firstname") String firstname);
}
```

**è¿™é‡Œè¯´ä¸‹æˆ‘çš„ç»éªŒä¹‹è°ˆï¼šä½ åœ¨é€šè¿‡ @Query å®šä¹‰è‡ªå·±çš„æŸ¥è¯¢æ–¹æ³•æ—¶ï¼Œæˆ‘å»ºè®®ä¹Ÿç”¨ Spring Data JPA çš„ name query çš„å‘½åæ–¹æ³•ï¼Œè¿™æ ·ä¸‹æ¥é£æ ¼å°±æ¯”è¾ƒç»Ÿä¸€äº†ã€‚**
ä¸Šé¢æˆ‘ä»‹ç»äº† @Query çš„åŸºæœ¬ç”¨æ³•ï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸‹ @Query åœ¨æˆ‘ä»¬çš„å®é™…åº”ç”¨ä¸­æœ€å—æ¬¢è¿çš„ä¸¤å¤„åœºæ™¯ã€‚



### @Query ä¹‹ Projections åº”ç”¨è¿”å›æŒ‡å®š DTOã€æŒæ¡ã€‘

æˆ‘ä»¬åœ¨ä¹‹å‰çš„ä¾‹å­çš„åŸºç¡€ä¸Šæ–°å¢ä¸€å¼ è¡¨ UserExtendï¼Œé‡Œé¢åŒ…å«èº«ä»½è¯ã€å­¦å·ã€å¹´é¾„ç­‰ä¿¡æ¯ï¼Œæœ€ç»ˆæˆ‘ä»¬çš„å®ä½“å˜æˆå¦‚ä¸‹æ¨¡æ ·ï¼š

```java
@Entity
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class UserExtend { //ç”¨æˆ·æ‰©å±•ä¿¡æ¯è¡¨
   @Id
   @GeneratedValue(strategy= GenerationType.AUTO)
   private Long id;
   private Long userId;
   private String idCard;
   private Integer ages;
   private String studentNumber;
}
```

```java
@Entity
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class User { //ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¡¨
   @Id
   @GeneratedValue(strategy= GenerationType.AUTO)
   private Long id;
   private String name;
   private String email;
   @Version
   private Long version;
   private String sex;
   private String address;
}
```

å¦‚æœæˆ‘ä»¬æƒ³å®šä¹‰ä¸€ä¸ª DTO å¯¹è±¡ï¼Œé‡Œé¢åªè¦ nameã€emailã€idCardï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™ç§åœºæ™¯éå¸¸å¸¸è§ï¼Œä½†å¥½å¤šäººä½¿ç”¨çš„éƒ½ä¸æ˜¯æœ€ä½³å®è·µï¼Œæˆ‘åœ¨è¿™é‡Œä»‹ç»å‡ ç§æ–¹å¼åšä¸€ä¸‹å¯¹æ¯”ã€‚

#### åˆšå­¦ JPA çš„æ—¶å€™åˆ«æ‰‹åˆ«è„šçš„å†™æ³•

```java
public interface UserDtoRepository extends JpaRepository<User,Long> {
   /**
    * æŸ¥è¯¢ç”¨æˆ·è¡¨é‡Œé¢çš„nameã€emailå’ŒUserExtendè¡¨é‡Œé¢çš„idCard
    * @param id
    * @return
    */
   @Query("select u.name,u.email,e.idCard from User u,UserExtend e where u.id= e.userId and u.id=:id")
   List<Object[]> findByUserId(@Param("id") Long id);
}
```

æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„æµ‹è¯•ç”¨ä¾‹æ¥å–ä¸Šé¢ findByUserId æ–¹æ³•è¿”å›çš„æ•°æ®ç»„ç»“æœå€¼ï¼Œå†å¡åˆ° DTO é‡Œé¢ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
@Test
public void testQueryAnnotation() {
    //æ–°å¢ä¸€æ¡ç”¨æˆ·æ•°æ®  userDtoRepository.save(User.builder().name("jack").email("123456@126.com").sex("man").address("shanghai").build());
    //å†æ–°å¢ä¸€æ¡å’Œç”¨æˆ·ä¸€å¯¹ä¸€çš„UserExtendæ•°æ®  userExtendRepository.save(UserExtend.builder().userId(1L).idCard("shengfengzhenghao").ages(18).studentNumber("xuehao001").build());
    //æŸ¥è¯¢æˆ‘ä»¬æƒ³è¦çš„ç»“æœ
    List<Object[]> userArray = userDtoRepository.findByUserId(1L);
    System.out.println(String.valueOf(userArray.get(0)[0])+String.valueOf(userArray.get(0)[1]));
    UserDto userDto = UserDto.builder().name(String.valueOf(userArray.get(0)[0])).build();
    System.out.println(userDto);
}
```

å…¶å®ç»éªŒçš„ä¸°å¯Œçš„â€œè€å¸æœºâ€ä¸€çœ‹å°±çŸ¥é“è¿™è‚¯å®šä¸æ˜¯æœ€ä½³å®è·µï¼Œè¿™å¤šéº»çƒ¦å‘€ï¼Œè‚¯å®šä¼šæœ‰æ›´ä¼˜è§£ã€‚é‚£ä¹ˆæˆ‘ä»¬å†å¯¹æ­¤ç¨åŠ æ”¹é€ ï¼Œç”¨ UserDto æ¥æ”¶è¿”å›ç»“æœã€‚



#### åˆ©ç”¨ class UserDto è·å–æˆ‘ä»¬æƒ³è¦çš„ç»“æœ

é¦–å…ˆï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª UserDto ç±»çš„å†…å®¹ã€‚

```java
@Data
@Builder
@AllArgsConstructor
public class UserDto {
    private String name,email,idCard;
}
```

å…¶æ¬¡ï¼Œæˆ‘ä»¬çœ‹ä¸‹åˆ©ç”¨ @Query åœ¨ Repository é‡Œé¢æ€ä¹ˆå†™ã€‚

```java
public interface UserDtoRepository extends JpaRepository<User, Long> {
    @Query("select new com.example.jpa.example1.UserDto(CONCAT(u.name,'JK123'),u.email,e.idCard) from User u,UserExtend e where u.id= e.userId and u.id=:id")
    UserDto findByUserDtoId(@Param("id") Long id);
}
```

æˆ‘ä»¬åˆ©ç”¨ JPQLï¼Œnew äº†ä¸€ä¸ª UserDtoï¼›å†é€šè¿‡æ„é€ æ–¹æ³•ï¼Œæ¥æ”¶æŸ¥è¯¢ç»“æœã€‚å…¶ä¸­ä½ ä¼šå‘ç°ï¼Œæˆ‘ä»¬ç”¨ CONCAT çš„å…³é”®å­—åšäº†ä¸€ä¸ªå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œè¿™æ—¶æœ‰çš„åŒå­¦å°±ä¼šé—®äº†ï¼Œè¿™ç§æ–¹æ³•æ”¯æŒçš„å…³é”®å­—æœ‰å“ªäº›å‘¢ï¼Ÿ

ä½ å¯ä»¥æŸ¥çœ‹JPQLçš„ Oracal æ–‡æ¡£ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æºç æ¥çœ‹æ”¯æŒçš„å…³é”®å­—æœ‰å“ªäº›ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬æ‰“å¼€ ParameterizedFunctionExpression ä¼šå‘ç° Hibernate æ”¯æŒçš„å…³é”®å­—æœ‰è¿™ä¹ˆå¤šï¼Œéƒ½æ˜¯ MySQL æ•°æ®åº“çš„æŸ¥è¯¢å…³é”®å­—ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€è§£é‡Šäº†ã€‚

![img](../images/CgqCHl9rKZeAHUEyAAGh83E9Xs4928.png)

ç„¶åï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼Œè°ƒç”¨ä¸Šé¢çš„æ–¹æ³•æµ‹è¯•ä¸€ä¸‹ã€‚

```java
@Test
public void testQueryAnnotationDto() {
    userDtoRepository.save(User.builder()
                           .name("jack").email("123456@126.com").sex("man").address("shanghai").build());
    userExtendRepository.save(UserExtend
                              .builder()
                              .userId(1L)
                              .idCard("shengfengzhenghao")
                              .ages(18)
                              .studentNumber("xuehao001")
                              .build());
    UserDto userDto = userDtoRepository.findByUserDtoId(1L);
    System.out.println(userDto);
}
```

æœ€åï¼Œæˆ‘ä»¬è¿è¡Œä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼Œç»“æœå¦‚ä¸‹ã€‚è¿™æ—¶ä½ ä¼šå‘ç°ï¼Œæˆ‘ä»¬æŒ‰ç…§é¢„æœŸæ“ä½œå¾—åˆ°äº† UserDto çš„ç»“æœã€‚

```
Hibernate: insert into user (address, email, name, sex, version, id) values (?, ?, ?, ?, ?, ?)
Hibernate: insert into user_extend (ages, id_card, student_number, user_id, id) values (?, ?, ?, ?, ?)
Hibernate: select (user0_.name||'JK123') as col_0_0_, user0_.email as col_1_0_, userextend1_.id_card as col_2_0_ from user user0_ cross join user_extend userextend1_ where user0_.id=userextend1_.user_id and user0_.id=?
UserDto(name=jackJK123, email=123456@126.com, idCard=shengfengzhenghao)
```

é‚£ä¹ˆè¿˜æœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿç­”æ¡ˆæ˜¯æœ‰ï¼Œä¸‹é¢æˆ‘ä»¬åˆ©ç”¨ UserDto æ¥å£æ¥å®ç°ä¸€ä¸‹ã€‚

#### åˆ©ç”¨ UserDto æ¥å£è·å¾—æˆ‘ä»¬æƒ³è¦çš„ç»“æœ

é¦–å…ˆï¼Œæ–°å¢ä¸€ä¸ª UserSimpleDto æ¥å£æ¥å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ nameã€emailã€idCard ä¿¡æ¯ã€‚

```java
public interface UserSimpleDto {
   String getName();
   String getEmail();
   String getIdCard();
}
```

å…¶æ¬¡ï¼Œåœ¨ UserDtoRepository é‡Œé¢æ–°å¢ä¸€ä¸ªæ–¹æ³•ï¼Œè¿”å›ç»“æœæ˜¯ UserSimpleDto æ¥å£ã€‚

```java
public interface UserDtoRepository extends JpaRepository<User, Long> {
    //åˆ©ç”¨æ¥å£DTOè·å¾—è¿”å›ç»“æœï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æ¯ä¸ªå­—æ®µéœ€è¦aså’Œæ¥å£é‡Œé¢çš„getæ–¹æ³•åå­—ä¿æŒä¸€æ ·
    @Query("select CONCAT(u.name,'JK123') as name,UPPER(u.email) as email ,e.idCard as idCard from User u,UserExtend e where u.id= e.userId and u.id=:id")
    UserSimpleDto findByUserSimpleDtoId(@Param("id") Long id);
}
```

ç„¶åï¼Œæµ‹è¯•ç”¨ä¾‹å†™æ³•å¦‚ä¸‹ã€‚

```java
@Test
public void testQueryAnnotationDto() {
    userDtoRepository.save(User.builder()
                           .name("jack").email("123456@126.com").sex("man").address("shanghai").build());
    userExtendRepository.save(UserExtend.builder()
                              .userId(1L)
                              .idCard("shengfengzhenghao").ages(18).studentNumber("xuehao001").build());
    UserSimpleDto userDto = userDtoRepository.findByUserSimpleDtoId(1L);
    System.out.println(userDto);  System.out.println(userDto.getName()+":"+userDto.getEmail()+":"+userDto.getIdCard());
}
```

æœ€åï¼Œæˆ‘ä»¬æ‰§è¡Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœã€‚

```
org.springframework.data.jpa.repository.query.AbstractJpaQuery$TupleConverter$TupleBackedMap@373c28e5
jackJK123:123456@126.COM:shengfengzhenghao
```

æˆ‘ä»¬å‘ç°ï¼Œæ¯”èµ· DTO æˆ‘ä»¬ä¸éœ€è¦ new äº†ï¼Œå¹¶ä¸”æ¥å£åªèƒ½è¯»ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿”å›çš„ç»“æœ DTO çš„èŒè´£å°±æ›´å•ä¸€äº†ï¼Œåªç”¨æ¥æŸ¥è¯¢ã€‚

**æ¥å£çš„æ–¹å¼æ˜¯æˆ‘æ¯”è¾ƒæ¨èçš„åšæ³•ï¼Œå› ä¸ºå®ƒæ˜¯åªè¯»çš„ï¼Œå¯¹æ„é€ æ–¹æ³•æ²¡æœ‰è¦æ±‚ï¼Œè¿”å›çš„å®é™…æ˜¯ HashMapã€‚å¹¶ä¸”æ”¯æŒè¿”å›åµŒå¥—çš„å¯¹è±¡**

è¿”å›ç»“æœä»‹ç»å®Œäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸‹ä¸€ä¸ªæœ€å¸¸è§çš„é—®é¢˜ï¼šå¦‚ä½•ç”¨ @Query æ³¨è§£å®ç°åŠ¨æ€æŸ¥è¯¢ï¼Ÿ



### @Query åŠ¨æ€æŸ¥è¯¢è§£å†³æ–¹æ³•ã€æŒæ¡ã€‘

æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼Œæ¥äº†è§£ä¸€ä¸‹å¦‚ä½•å®ç° @Query çš„åŠ¨æ€å‚æ•°æŸ¥è¯¢ã€‚

é¦–å…ˆï¼Œæ–°å¢ä¸€ä¸ª UserOnlyName æ¥å£ï¼ŒåªæŸ¥è¯¢ User é‡Œé¢çš„ name å’Œ email å­—æ®µã€‚

```java
//è·å¾—è¿”å›ç»“æœ
public interface UserOnlyName {
    String getName();
    String getEmail();
}
```

å…¶æ¬¡ï¼Œåœ¨æˆ‘ä»¬çš„ UserDtoRepository é‡Œé¢æ–°å¢ä¸¤ä¸ªæ–¹æ³•ï¼šä¸€ä¸ªæ˜¯åˆ©ç”¨ JPQL å®ç°åŠ¨æ€æŸ¥è¯¢ï¼Œä¸€ä¸ªæ˜¯åˆ©ç”¨åŸå§‹ SQL å®ç°åŠ¨æ€æŸ¥è¯¢ã€‚

```java
public interface UserDtoRepository extends JpaRepository<User, Long> {
    /**
    * åˆ©ç”¨JQPlåŠ¨æ€æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    * @param name
    * @param email
    * @return UserSimpleDtoæ¥å£
    */
    @Query("select u.name as name,u.email as email from User u where (:name is null or u.name =:name) and (:email is null or u.email =:email)")
    UserOnlyName findByUser(@Param("name") String name,@Param("email") String email);
    /**
    * åˆ©ç”¨åŸå§‹sqlåŠ¨æ€æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    * @param user
    * @return
    */
    @Query(value = "select u.name as name,u.email as email from user u where (:#{#user.name} is null or u.name =:#{#user.name}) and (:#{#user.email} is null or u.email =:#{#user.email})",nativeQuery = true)
    UserOnlyName findByUser(@Param("user") User user);
}
```

ç„¶åï¼Œæˆ‘ä»¬æ–°å¢ä¸€ä¸ªæµ‹è¯•ç±»ï¼Œæµ‹è¯•ä¸€ä¸‹ä¸Šé¢æ–¹æ³•çš„ç»“æœã€‚

```java
@Test
public void testQueryDinamicDto() {
   userDtoRepository.save(User.builder()
                          .name("jack").email("123456@126.com").sex("man").address("shanghai").build());
   UserOnlyName userDto = userDtoRepository.findByUser("jack", null);
   System.out.println(userDto.getName() + ":" + userDto.getEmail());
   UserOnlyName userDto2 = userDtoRepository.findByUser(User.builder().email("123456@126.com").build());
   System.out.println(userDto2.getName() + ":" + userDto2.getEmail());
}
```

æœ€åï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ã€‚

```
Hibernate: insert into user (address, email, name, sex, version, id) values (?, ?, ?, ?, ?, ?)
 : binding parameter [1] as [VARCHAR] - [shanghai]
 : binding parameter [2] as [VARCHAR] - [123456@126.com]
 : binding parameter [3] as [VARCHAR] - [jack]
 : binding parameter [4] as [VARCHAR] - [man]
 : binding parameter [5] as [BIGINT] - [0]
 : binding parameter [6] as [BIGINT] - [1]
Hibernate: select user0_.name as col_0_0_, user0_.email as col_1_0_ from user user0_ where (? is null or user0_.name=?) and (? is null or user0_.email=?)
 : binding parameter [1] as [VARCHAR] - [jack]
 : binding parameter [2] as [VARCHAR] - [jack]
 : binding parameter [3] as [VARCHAR] - [null]
 : binding parameter [4] as [VARCHAR] - [null]
jack:123456@126.com
Hibernate: select u.name as name,u.email as email from user u where (? is null or u.name =?) and (? is null or u.email =?)
 : binding parameter [1] as [VARBINARY] - [null]
 : binding parameter [2] as [VARBINARY] - [null]
 : binding parameter [3] as [VARCHAR] - [123456@126.com]
 : binding parameter [4] as [VARCHAR] - [123456@126.com]
jack:123456@126.com
```

æ³¨æ„ï¼šå…¶ä¸­æˆ‘ä»¬æ‰“å°äº†ä¸€ä¸‹ SQL ä¼ å…¥çš„å‚æ•°ï¼Œæ˜¯ä¸ºäº†è®©æˆ‘ä»¬æ›´æ¸…æ¥šå‚æ•°éƒ½ä¼ å…¥äº†ä»€ä¹ˆå€¼ã€‚
ä¸Šé¢çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬åˆ†åˆ«é‡‡ç”¨äº† JPQL çš„åŠ¨æ€å‚æ•°å’Œ SPEL çš„è¡¨è¾¾å¼æ–¹å¼è·å–å‚æ•°ï¼ˆè¿™ä¸ªæˆ‘ä»¬åœ¨ç¬¬ 26 è¯¾æ—¶â€œSpEL è§£å†³äº†å“ªäº›é—®é¢˜â€ä¸­å†è¯¦ç»†ä»‹ç»ï¼‰ã€‚

é€šè¿‡ä¸Šé¢çš„å®ä¾‹å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œæˆ‘ä»¬é‡‡ç”¨äº† :email is null or s.email = :email è¿™ç§æ–¹å¼æ¥å®ç°åŠ¨æ€æŸ¥è¯¢çš„æ•ˆæœï¼Œå®é™…å·¥ä½œä¸­ä¹Ÿå¯ä»¥æ¼”å˜å¾—å¾ˆå¤æ‚ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸ªå®é™…å·¥ä½œä¸­å¤æ‚ä¸€ç‚¹çš„ä¾‹å­ã€‚

**é€šè¿‡åŸå§‹ sqlï¼Œæ ¹æ®åŠ¨æ€æ¡ä»¶ room å…³è” room_record æ¥è·å– room_record çš„ç»“æœã€‚**

![img](../images/CgqCHl9rKauAfQmmAAHMquqHBVg909.png)

**é€šè¿‡ JPQL åŠ¨æ€å‚æ•°æŸ¥è¯¢ RoomRecordï¼Œå¦‚ä¸‹å›¾ï¼š**

![img](../images/Ciqc1F9rKbGAT_6FAAL_YUkV6AQ306.png)

è¿™ä¸¤ä¸ªä¾‹å­å°±æ˜¯æ¯”è¾ƒå¤æ‚çš„åŠ¨æ€æŸ¥è¯¢çš„æ¡ˆä¾‹ï¼Œå’Œä¸Šé¢çš„ç®€å•åŠ¨æ€æŸ¥è¯¢è¯­æ³•æ˜¯ä¸€æ ·çš„ï¼Œä½ ä»”ç»†çœ‹ä¸€ä¸‹å°±ä¼šæ˜ç™½ï¼Œå¹¶ä¸”å¯ä»¥è½»æ¾åº”ç”¨åˆ°å·¥ä½œä¸­è¿›è¡ŒåŠ¨æ€æŸ¥è¯¢ã€‚



### æ€»ç»“

åˆ°æ­¤ï¼Œ@Query çš„å¸¸è§ç”¨æ³•ï¼Œå°±å·²ç»è®²å®Œäº†ã€‚æˆ‘ä»¬é€šè¿‡åŸºæœ¬è¯­æ³•ï¼Œåˆ†æäº†ä¸€äº›åŸç†ï¼Œè®²è§£äº†å¸¸è§çš„ DTO å’ŒåŠ¨æ€å‚æ•°çš„å®ç°æ–¹æ³•ï¼Œè¯¦ç»†æŒæ¡äº† @Query çš„ç”¨æ³•ã€‚

é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ä½ å¯èƒ½ä¼šé—®äº†ï¼Œæˆ‘ä»¬çŸ¥é“å®šä¹‰æ–¹æ³•åå¯ä»¥è·å¾—æƒ³è¦çš„ç»“æœï¼Œ@Query æ³¨è§£äº¦å¯ä»¥è·å¾—æƒ³è¦çš„ç»“æœï¼ŒnativeQuery ä¹Ÿå¯ä»¥è·å¾—æƒ³è¦çš„ç»“æœï¼Œé‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•åšé€‰æ‹©å‘¢ï¼Ÿ**ä¸‹é¢æˆ‘ä»ä¸ªäººç»éªŒä¸­æ€»ç»“äº†ä¸€äº›è§‚ç‚¹ï¼Œåˆ†äº«ç»™ä½ ã€‚**

1.  èƒ½ç”¨æ–¹æ³•åè¡¨ç¤ºçš„ï¼Œå°½é‡ç”¨æ–¹æ³•åè¡¨ç¤ºï¼Œå› ä¸ºè¿™æ ·è¯­ä¹‰æ¸…æ™°ã€ç®€å•å¿«é€Ÿï¼ŒåŸºæœ¬ä¸Šåªè¦ç¼–è¯‘é€šè¿‡ï¼Œä¸€å®šä¸ä¼šæœ‰é—®é¢˜ï¼›
2.  èƒ½ç”¨ @Query é‡Œé¢çš„ JPQL è¡¨ç¤ºçš„ï¼Œå°±ç”¨ JPQLï¼Œè¿™æ ·ä¸ SQL æ— å…³ï¼Œä¸‡ä¸€å“ªå¤©æ¢æ•°æ®åº“äº†ï¼ŒåŸºæœ¬ä¸Šä»£ç ä¸ç”¨æ”¹å˜ï¼›
3.  æœ€åå®åœ¨æ²¡æœ‰åŠæ³•äº†ï¼Œå¯ä»¥é€‰æ‹© nativeQuery å†™åŸå§‹ SQLï¼Œç‰¹åˆ«æ˜¯ä¸€å¼€å§‹ä» MyBatis è½¬è¿‡æ¥çš„åŒå­¦ï¼Œé€‰æ‹©å†™ SQL ä¼šæ›´å®¹æ˜“ä¸€äº›ã€‚

å¥½çš„æ¶æ„å¸ˆå†™ä»£ç æ—¶æŠ¥é”™çš„é¡ºåºæ˜¯ï¼šç¼–è¯‘ < å¯åŠ¨ < è¿è¡Œï¼Œå³è¶Šæ—©å‘ç°é”™è¯¯è¶Šå¥½ã€‚





## SQL å¢åˆ æ”¹æŸ¥ ğŸ”¥

ä½¿ç”¨å¦‚ä¸‹ï¼š

*   ç‰¹æœ‰çš„æŸ¥è¯¢ï¼šéœ€è¦åœ¨ Repository æ¥å£ä¸Šé…ç½®æ–¹æ³•
*   åœ¨é…ç½®çš„æ–¹æ³•ä¸Šï¼Œä½¿ç”¨`@Query`æ³¨è§£çš„å½¢å¼é…ç½®SQLè¯­å¥ï¼Œè¿˜éœ€è®¾ç½®`nativeQuery`å±æ€§

```java
public interface ArticleRepository extends JpaRepository<Article, Long> {
   
    /**
     * ?1 ä»£è¡¨å‚æ•°çš„å ä½ç¬¦ï¼Œå…¶ä¸­1ä»£è¡¨å¯¹åº”æ–¹æ³•ä¸­çš„å‚æ•°ç´¢å¼•ï¼ˆå‚æ•°ç´¢å¼•ä»1å¼€å§‹ï¼‰
     */
    @Query(value = "select * from article where author = ?1 and title = ?2", nativeQuery = true)
    Article sqlFindByAuthorAndTitle(String author, String title);

    /**
     * ä¸æŒ‡å®šåˆ™æŒ‰ç…§æ–¹æ³•ä¸­å‚æ•°ä½ç½®å¯¹åº”ã€‚â€œ:å‚æ•°åç§°â€œ ä¹Ÿå¯ä»¥å½“åšå ä½ç¬¦
     */
    @Query(value = "select * from article where author = :author and title = :title", nativeQuery = true)
    List<Article> sqlFindByAuthorAndTitle2(String author, String title);

}
```

```java
@DataJpaTest
// DataJpaTestã€MybatisTest ä¼šé»˜è®¤ä½¿ç”¨å…¶æµ‹è¯•æ•°æ®æºæ›¿ä»£ï¼Œè‹¥è¦ä½¿ç”¨è‡ªå·±é…ç½®çš„ï¼Œéœ€è¦æ·»åŠ å¦‚ä¸‹æ³¨è§£
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
public class ArticleSqlRepositoryTest {

    @Autowired
    private ArticleRepository articleRepository;


    @Test
    void testSqlFindByAuthorAndTitle() {
        Article article = articleRepository.sqlFindByAuthorAndTitle("ç”·ç¥1", "ç‰›é€¼");
        Assertions.assertNotNull(article);
    }


    @Test
    void testSqlFindByAuthorAndTitle2() {
        List<Article> articles = articleRepository.sqlFindByAuthorAndTitle2("ç”·ç¥2", "ç‰›é€¼");
        System.out.println(articles);
    }

}
```









## Specification åŠ¨æ€æŸ¥è¯¢ ğŸ”¥

åº”è¯¥åœ¨**å†™æ¡†æ¶æ—¶ä½¿ç”¨ï¼Œå…¶ä½™åº”è¯¥ä½¿ç”¨@Queryå†™JPQL**

Spring Data JPAä¸­å¯ä»¥é€šè¿‡`JpaSpecificationExecutor`æ¥å£æŸ¥è¯¢ã€‚ç›¸æ¯”JPQLï¼Œå…¶ä¼˜åŠ¿æ˜¯ç±»å‹å®‰å…¨ï¼Œæ›´åŠ çš„é¢å‘å¯¹è±¡ã€‚

![image-20201220132454832](../images/image-20201220132454832.png)

-   `T findOne(Specification<T> spec);` æŸ¥è¯¢å•ä¸ªå¯¹è±¡ 
-   `List<T> findAll(Specification<T> spec);` æŸ¥è¯¢åˆ—è¡¨ 
-   `Page<T> findAll(Specification<T> spec, Pageable pageable);` 
    -   Pageableï¼šåˆ†é¡µå‚æ•°ï¼ŒåŒ…æ‹¬æ’åº
    -   è¿”å›å€¼ï¼šSpring Data JPAæä¾›çš„åˆ†é¡µ Bean
-   `List<T> findAll(Specification<T> spec, Sort sort);`æ’åºæŸ¥è¯¢
-   `long count(Specification<T> spec);`ç»Ÿè®¡æŸ¥è¯¢

å¯¹äº`JpaSpecificationExecutor`ï¼Œè¿™ä¸ªæ¥å£åŸºæœ¬æ˜¯å›´ç»•ç€`Specification`æ¥å£æ¥å®šä¹‰çš„ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•çš„ç†è§£ä¸ºï¼Œ`Specification`**æ„é€ çš„å°±æ˜¯æŸ¥è¯¢æ¡ä»¶**ã€‚

![image-20201220132537598](../images/image-20201220132537598.png)

```java
/**
  *	root	ï¼šRootæ¥å£ï¼Œä»£è¡¨æŸ¥è¯¢çš„æ ¹å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡rootè·å–å®ä½“ä¸­çš„å±æ€§
  *	query	ï¼šä»£è¡¨ä¸€ä¸ªé¡¶å±‚æŸ¥è¯¢å¯¹è±¡ï¼Œç”¨æ¥è‡ªå®šä¹‰æŸ¥è¯¢ï¼ˆç”¨çš„å°‘ï¼Œä½†æ˜¯å¾ˆå¼ºå¤§ï¼‰
  *	cb		ï¼šç”¨æ¥æ„å»ºæŸ¥è¯¢ï¼Œæ­¤å¯¹è±¡é‡Œæœ‰å¾ˆå¤šæ¡ä»¶æ–¹æ³•
  **/
public Predicate toPredicate(Root<T> root, CriteriaQuery<?> query, CriteriaBuilder cb);
```

ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```java
public interface ArticleRepository extends JpaRepository<Article, Long>, JpaSpecificationExecutor<Article> {}
```

ä¸»è¦æ˜¯ç»§æ‰¿ JpaSpecificationExecutor æ¥å£

```java
/**
 * 1.å®ç°Specificationæ¥å£ï¼ˆæä¾›æ³›å‹ï¼šæŸ¥è¯¢çš„å¯¹è±¡ç±»å‹ï¼‰
 * 2.å®ç°toPredicateæ–¹æ³•ï¼ˆæ„é€ æŸ¥è¯¢æ¡ä»¶ï¼‰
 * 3.éœ€è¦å€ŸåŠ©æ–¹æ³•å‚æ•°ä¸­çš„ä¸¤ä¸ªå‚æ•°ï¼ˆ
 *  rootï¼šè·å–éœ€è¦æŸ¥è¯¢çš„å¯¹è±¡å±æ€§ï¼ˆä¸æ˜¯æ•°æ®åº“ä¸­å­—æ®µåï¼ï¼ï¼‰
 *  CriteriaBuilderï¼šæ„é€ æŸ¥è¯¢æ¡ä»¶çš„ï¼Œå†…éƒ¨å°è£…äº†å¾ˆå¤šçš„æŸ¥è¯¢æ¡ä»¶ï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼Œç²¾å‡†åŒ¹é…ï¼‰
 **/
@DataJpaTest
// DataJpaTestã€MybatisTest ä¼šé»˜è®¤ä½¿ç”¨å…¶æµ‹è¯•æ•°æ®æºæ›¿ä»£ï¼Œè‹¥è¦ä½¿ç”¨è‡ªå·±é…ç½®çš„ï¼Œéœ€è¦æ·»åŠ å¦‚ä¸‹æ³¨è§£
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
public class SpecificationTest {

    @Autowired
    private ArticleRepository articleRepository;

    @Autowired
    private LinkManRepository linkManRepository;


    /**
     * å•æ¡ä»¶æŸ¥è¯¢ï¼Œæ ¹æ®ä½œè€…æŸ¥è¯¢æ–‡ç« ï¼ˆequalï¼‰
     */
    @Test
    void spec1() {

        Specification<Article> spec = (root, query, criteriaBuilder) -> {
            //1.è·å–æ¯”è¾ƒçš„å±æ€§
            Path<Object> author = root.get("author");
            //2.æ„é€ æŸ¥è¯¢æ¡ä»¶
            //ç¬¬1ä¸ªå‚æ•°ä¸ºæ¯”è¾ƒçš„å±æ€§ï¼ˆPathå¯¹è±¡ï¼‰ï¼›ç¬¬2ä¸ªå‚æ•°ä¸ºè¦æ¯”è¾ƒçš„å€¼
            return criteriaBuilder.equal(author, "ç”·å“¥");
        };

        List<Article> articles = articleRepository.findAll(spec);
        articles.forEach(System.out::println);
    }


    /**
     * å¤šæ¡ä»¶æŸ¥è¯¢ï¼Œæ ¹æ®authorå’ŒtitleæŸ¥è¯¢æ–‡ç« ï¼ˆequalï¼Œandï¼‰
     */
    @Test
    void spec2() {

        Specification<Article> spec = (root, query, criteriaBuilder) -> {
            //1.è·å–æ¯”è¾ƒçš„å±æ€§
            Path<Object> author = root.get("author");
            Path<Object> title = root.get("title");
            //2.æ„é€ æŸ¥è¯¢æ¡ä»¶
            Predicate predicate1 = criteriaBuilder.equal(author, "ç”·å“¥");
            Predicate predicate2 = criteriaBuilder.equal(title, "ç‰›é€¼");
            //3.æ¡ä»¶é—´å…³ç³»
            return criteriaBuilder.and(predicate1, predicate2);
        };
        List<Article> articles = articleRepository.findAll(spec);
        articles.forEach(System.out::println);
    }


    /**
     * æ™®é€šæŸ¥è¯¢ï¼›æ’åºæŸ¥è¯¢ï¼›åˆ†é¡µæŸ¥è¯¢ï¼Œæ ¹æ®å®¢æˆ·åæ¨¡ç³ŠåŒ¹é…æŸ¥è¯¢å®¢æˆ·åˆ—è¡¨ï¼ˆlikeï¼‰ï¼›
     *  equal: ç›´æ¥çš„åˆ°pathå¯¹è±¡ï¼ˆå±æ€§ï¼‰ï¼Œç„¶åè¿›è¡Œæ¯”è¾ƒå³å¯
     *  gt,lt,ge,le,like: å¾—åˆ°Pathå¯¹è±¡ï¼Œæ ¹æ®PathæŒ‡å®šæ¯”è¾ƒçš„å‚æ•°ç±»å‹ï¼ˆå­—ç¬¦ä¸²ã€æ•°å­—ç­‰ï¼‰ï¼Œå†å»è¿›è¡Œæ¯”è¾ƒ
     */
    @Test
    void spec3() {
        Specification<Article> spec = (root, query, criteriaBuilder) -> {
            //1.è·å–æ¯”è¾ƒçš„å±æ€§
            Expression<String> author = root.get("author").as(String.class);
            //2.æ„é€ æŸ¥è¯¢æ¡ä»¶
            //3.æ¡ä»¶é—´å…³ç³»
            return criteriaBuilder.like(author, "ç”·å“¥%");
        };

        // æ¨¡ç³ŠæŸ¥è¯¢
        List<Article> articles1 = articleRepository.findAll(spec);
        articles1.forEach(System.out::println);
        System.out.println("==================");



        // æ’åºæŸ¥è¯¢
        Sort Sorts = Sort.by(Sort.Order.desc("createTime"), Sort.Order.asc("aid"));
        List<Article> articles2 = articleRepository.findAll(spec, Sorts);
        articles2.forEach(System.out::println);
        System.out.println("==================");


        // åˆ†é¡µæŸ¥è¯¢
        Sort Sorts2 = Sort.by(Sort.Order.desc("createTime"), Sort.Order.asc("aid"));
        Pageable pageable = PageRequest.of(0, 5, Sorts2);// é¡µç ï¼ˆä»0å¼€å§‹ï¼‰ï¼Œæ¯é¡µæ˜¾ç¤ºæ¡æ•°
        Page<Article> page = articleRepository.findAll(spec, pageable);
        System.out.println("æ€»è®°å½•æ•°:" + page.getTotalElements());
        System.out.println("æ€»é¡µæ•°:" + page.getTotalPages());
        System.out.println("åˆ†é¡µæŸ¥è¯¢çš„æ•°æ®:" + page.getContent());
        System.out.println("==================");
    }


    /**
     * Specificationçš„å¤šè¡¨æŸ¥è¯¢
     */
    @Test
    public void testFind() {
        Specification<LinkMan> specification = (root, criteriaQuery, criteriaBuilder) ->  {
            //Joinä»£è¡¨é“¾æ¥æŸ¥è¯¢ï¼Œé€šè¿‡rootå¯¹è±¡è·å–
            //åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå…³è”å¯¹è±¡çš„å±æ€§åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºè¿æ¥æŸ¥è¯¢çš„æ–¹å¼ï¼ˆinnerï¼Œleftï¼Œrightï¼‰
            //JoinType.LEFT : å·¦å¤–è¿æ¥,JoinType.INNERï¼šå†…è¿æ¥,JoinType.RIGHTï¼šå³å¤–è¿æ¥
            Join<LinkMan, Customer> join = root.join("customer",JoinType.INNER);
            return criteriaBuilder.like(join.get("custName").as(String.class),"ä¼ æ™ºæ’­å®¢1");
        };

        List<LinkMan> list = linkManRepository.findAll(specification);
        for (LinkMan linkMan : list) {
            System.out.println(linkMan);
        }
    }
}
```

æ–¹æ³•å¯¹åº”å…³ç³»

| æ–¹æ³•åç§°                    | Sqlå¯¹åº”å…³ç³»          |
| --------------------------- | -------------------- |
| equle                       | filed = value        |
| gtï¼ˆgreaterThan ï¼‰          | filed > value        |
| ltï¼ˆlessThan ï¼‰             | filed < value        |
| geï¼ˆgreaterThanOrEqualTo ï¼‰ | filed >= value       |
| leï¼ˆ lessThanOrEqualToï¼‰    | filed <= value       |
| notEqule                    | filed != value       |
| like                        | filed like value     |
| notLike                     | filed not like value |

