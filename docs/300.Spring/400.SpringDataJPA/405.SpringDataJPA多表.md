---
title: SpringDataJPA å¤šè¡¨
date: 2020-12-23 23:56:17
permalink: /pages/8c3319/
categories:
  - Spring
  - SpringDataJPA
tags:
  - 
---



# SpringDataJPA å¤šè¡¨

## JPA åè®®è§„å®š

@OneToOne ä¸€èˆ¬è¡¨ç¤ºå¯¹è±¡ä¹‹é—´ä¸€å¯¹ä¸€çš„å…³è”å…³ç³»ï¼Œå®ƒå¯ä»¥æ”¾åœ¨ field ä¸Šé¢ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨ get/set æ–¹æ³•ä¸Šé¢ã€‚

*   å¦‚æœæ˜¯é…ç½®åŒå‘å…³è”ï¼Œç»´æŠ¤å…³è”å…³ç³»çš„æ˜¯æ‹¥æœ‰å¤–é”®çš„ä¸€æ–¹ï¼Œè€Œå¦ä¸€æ–¹å¿…é¡»é…ç½® mappedBy
*   å¦‚æœæ˜¯å•é¡¹å…³è”ï¼Œç›´æ¥é…ç½®åœ¨æ‹¥æœ‰å¤–é”®çš„ä¸€æ–¹å³å¯ã€‚







## ä¸€å¯¹ä¸€

### æ¡ˆä¾‹ä»‹ç»

ä¸¾ä¸ªä¾‹å­ï¼šuser è¡¨æ˜¯ç”¨æˆ·çš„ä¸»ä¿¡æ¯ï¼Œuser_info æ˜¯ç”¨æˆ·çš„æ‰©å±•ä¿¡æ¯ï¼Œä¸¤è€…ä¹‹é—´æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚



### å•å‘å…³è”

user_info è¡¨é‡Œé¢æœ‰ä¸€ä¸ª user_id ä½œä¸ºå…³è”å…³ç³»çš„å¤–é”®ï¼Œå¦‚æœæ˜¯å•é¡¹å…³è”ï¼Œæˆ‘ä»¬çš„å†™æ³•å¦‚ä¸‹ï¼š

```java
@Entity
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class User {
   @Id
   @GeneratedValue(strategy= GenerationType.AUTO)
   private Long id;
   private String name;
   private String email;
   private String sex;
   private String address;
}
```

User å®ä½“é‡Œé¢ä»€ä¹ˆéƒ½æ²¡å˜åŒ–ï¼Œä¸éœ€è¦æ·»åŠ  @OneToOne æ³¨è§£ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨æ‹¥æœ‰å¤–é”®çš„ä¸€æ–¹é…ç½®å°±å¯ä»¥ï¼Œæ‰€ä»¥ UserInfo çš„ä»£ç å¦‚ä¸‹ï¼š

```java
@Entity
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
@ToString(exclude = "user")
public class UserInfo {
   @Id
   @GeneratedValue(strategy= GenerationType.AUTO)
   private Long id;
   private Integer ages;
   private String telephone;
   @OneToOne //ç»´æŠ¤userçš„å¤–é”®å…³è”å…³ç³»ï¼Œé…ç½®ä¸€å¯¹ä¸€
   private User user;
}
```

æˆ‘ä»¬çœ‹åˆ°ï¼ŒUserInfo å®ä½“å¯¹è±¡é‡Œé¢æ·»åŠ äº† @OneToOne æ³¨è§£ï¼Œè¿™æ—¶æˆ‘ä»¬å†™ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹è·‘ä¸€ä¸‹çœ‹çœ‹æœ‰ä»€ä¹ˆæ•ˆæœï¼š

```sql
create table user (id bigint not null, address varchar(255), email varchar(255), name varchar(255), sex varchar(255), primary key (id))
create table user_info (id bigint not null, ages integer, telephone varchar(255), user_id bigint, primary key (id))
alter table user_info add constraint FKn8pl63y4abe7n0ls6topbqjh2 foreign key (user_id) references user
```

å› ä¸ºæˆ‘ä»¬æ–°å»ºäº†ä¸¤ä¸ªå®ä½“ï¼Œè·‘ä»»ä½•ä¸€ä¸ª @SpringDataTest å°±ä¼šçœ‹åˆ°ä¸Šé¢æœ‰ä¸‰ä¸ª sql åœ¨æ‰§è¡Œï¼Œåˆ†åˆ«åˆ›å»ºäº†ä¸¤å¼ è¡¨ï¼Œè€Œåœ¨ user_info è¡¨ä¸Šé¢è¿˜åˆ›å»ºäº†ä¸€ä¸ªå¤–é”®ç´¢å¼•ã€‚





### åŒå‘å…³è”

æˆ‘ä»¬ä¿æŒ UserInfo ä¸å˜ï¼Œåœ¨ User å®ä½“å¯¹è±¡é‡Œé¢æ·»åŠ è¿™ä¸€æ®µä»£ç å³å¯ã€‚

```java
@OneToOne(mappedBy = "user")
private UserInfo userInfo;
```

å®Œæ•´çš„ User å®ä½“å¯¹è±¡å°±ä¼šå˜æˆå¦‚ä¸‹æ¨¡æ ·ã€‚

```java
@Entity
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class User {
   @Id
   @GeneratedValue(strategy= GenerationType.AUTO)
   private Long id;
   private String name;
   private String email;
   @OneToOne(mappedBy = "user")
   private UserInfo userInfo;//å˜åŒ–ä¹‹å¤„
   private String sex;
   private String address;
}
```

æˆ‘ä»¬è·‘ä»»ä½•ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå°±ä¼šçœ‹åˆ°è¿è¡Œç»“æœæ˜¯ä¸€æ ·çš„ï¼Œè¿˜æ˜¯ä¸Šé¢ä¸‰æ¡ sqlã€‚é‚£ä¹ˆæˆ‘ä»¬å†æŸ¥çœ‹ä¸€ä¸‹ @OneToOne æºç ï¼Œçœ‹çœ‹å…¶æ”¯æŒçš„é…ç½®éƒ½æœ‰å“ªäº›ã€‚





### OneToOne æºç è§£è¯»

```java
public @interface OneToOne {
    //è¡¨ç¤ºå…³ç³»ç›®æ ‡å®ä½“ï¼Œé»˜è®¤è¯¥æ³¨è§£æ ‡è¯†çš„è¿”å›å€¼çš„ç±»å‹çš„ç±»ã€‚
    Class targetEntity() default void.class;
    //cascade çº§è”æ“ä½œç­–ç•¥ï¼Œå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„çº§è”æ“ä½œ
    CascadeType[] cascade() default {};
    //æ•°æ®è·å–æ–¹å¼EAGER(ç«‹å³åŠ è½½)/LAZY(å»¶è¿ŸåŠ è½½)
    FetchType fetch() default EAGER;
    //æ˜¯å¦å…è®¸ä¸ºç©ºï¼Œé»˜è®¤æ˜¯å¯é€‰çš„ï¼Œä¹Ÿå°±è¡¨ç¤ºå¯ä»¥ä¸ºç©ºï¼›
    boolean optional() default true;
    //å…³è”å…³ç³»è¢«è°ç»´æŠ¤çš„ä¸€æ–¹å¯¹è±¡é‡Œé¢çš„å±æ€§åå­—ã€‚ åŒå‘å…³è”çš„æ—¶å€™å¿…å¡«
    String mappedBy() default "";
    //å½“è¢«æ ‡è¯†çš„å­—æ®µå‘ç”Ÿåˆ é™¤æˆ–è€…ç½®ç©ºæ“ä½œä¹‹åï¼Œæ˜¯å¦åŒæ­¥åˆ°å…³è”å…³ç³»çš„ä¸€æ–¹ï¼Œå³è¿›è¡Œé€šè¿‡åˆ é™¤æ“ä½œï¼Œé»˜è®¤flaseï¼Œæ³¨æ„ä¸CascadeType.REMOVE çº§è”åˆ é™¤çš„åŒºåˆ«
    boolean orphanRemoval() default false;
}
```





### mappedBy æ³¨æ„äº‹é¡¹ ğŸ”¥

åªæœ‰å…³è”å…³ç³»çš„**ç»´æŠ¤æ–¹**æ‰èƒ½**æ“ä½œä¸¤ä¸ªå®ä½“ä¹‹é—´å¤–é”®**çš„å…³ç³»ã€‚**è¢«ç»´æŠ¤æ–¹å³ä½¿è®¾ç½®äº†ç»´æŠ¤æ–¹å±æ€§è¿›è¡Œå­˜å‚¨ä¹Ÿä¸ä¼šæ›´æ–°å¤–é”®å…³è”**ã€‚

mappedBy ä¸èƒ½ä¸ @JoinColumn æˆ–è€… @JoinTable åŒæ—¶ä½¿ç”¨ï¼Œå› ä¸ºæ²¡æœ‰æ„ä¹‰ï¼Œå…³è”å…³ç³»ä¸åœ¨è¿™é‡Œé¢ç»´æŠ¤ã€‚

æ­¤å¤–ï¼Œ**mappedBy çš„å€¼**æ˜¯æŒ‡**å¦ä¸€æ–¹çš„å®ä½“é‡Œé¢å±æ€§çš„å­—æ®µ**ï¼Œè€Œä¸æ˜¯æ•°æ®åº“å­—æ®µï¼Œä¹Ÿä¸æ˜¯å®ä½“çš„å¯¹è±¡çš„åå­—ã€‚ä¹Ÿå°±æ˜¯ç»´æŠ¤å…³è”å…³ç³»çš„ä¸€æ–¹å±æ€§å­—æ®µåç§°ï¼Œ**æˆ–è€…åŠ äº† @JoinColumn / @JoinTable æ³¨è§£çš„å±æ€§å­—æ®µåç§°**ã€‚å¦‚ä¸Šé¢çš„ User ä¾‹å­ user é‡Œé¢ mappedBy çš„å€¼ï¼Œå°±æ˜¯ UserInfo é‡Œé¢çš„ user å­—æ®µçš„åå­—ã€‚



### CascadeTypeç”¨æ³•

åœ¨ CascadeType çš„ç”¨æ³•ä¸­ï¼ŒCascadeType çš„æšä¸¾å€¼åªæœ‰äº”ä¸ªï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š

1.  CascadeType.PERSIST çº§è”æ–°å»º
2.  CascadeType.REMOVE çº§è”åˆ é™¤
3.  CascadeType.REFRESH çº§è”åˆ·æ–°
4.  CascadeType.MERGE çº§è”æ›´æ–°
5.  CascadeType.ALL å››é¡¹å…¨é€‰

å…¶ä¸­ï¼Œé»˜è®¤æ˜¯æ²¡æœ‰çº§è”æ“ä½œçš„ï¼Œå…³ç³»è¡¨ä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“ã€‚æ­¤å¤–ï¼ŒJPA 2.0 è¿˜æ–°å¢äº† CascadeType.DETACHï¼Œå³çº§è”å®ä½“åˆ° Detach çŠ¶æ€ã€‚

äº†è§£äº†æšä¸¾å€¼ï¼Œä¸‹é¢æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹çº§è”æ–°å»ºå’Œçº§è”åˆ é™¤ã€‚

é¦–å…ˆï¼Œä¿®æ”¹ UserInfo é‡Œé¢çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼Œå¹¶åœ¨ @OneToOne ä¸Šé¢æ·»åŠ 

`cascade ={CascadeType.PERSIST,CascadeType.REMOVE}`

```java
@DataJpaTest
// DataJpaTestã€MybatisTest ä¼šé»˜è®¤ä½¿ç”¨å…¶æµ‹è¯•æ•°æ®æºæ›¿ä»£ï¼Œè‹¥è¦ä½¿ç”¨è‡ªå·±é…ç½®çš„ï¼Œéœ€è¦æ·»åŠ å¦‚ä¸‹æ³¨è§£
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
public class One2OneTest {

    @Autowired
    private UserInfoRepository userInfoRepository;


    @Test
    @Rollback(false)
    public void testUserRelationships() throws JsonProcessingException {
        User user = User.builder().name("jackxx").email("123456@126.com").build();
        UserInfo userInfo = UserInfo.builder().ages(12).user(user).telephone("12345678").build();
        //ä¿å­˜userInfoçš„åŒä¸Šä¹Ÿä¼šä¿å­˜Userä¿¡æ¯
        userInfoRepository.saveAndFlush(userInfo);
        //åˆ é™¤userInfoï¼ŒåŒæ—¶ä¹Ÿä¼šçº§è”çš„åˆ é™¤userè®°å½•
        userInfoRepository.delete(userInfo);
    }
}
```

æœ€åï¼Œè¿è¡Œä¸€ä¸‹çœ‹çœ‹æ•ˆæœã€‚

![img](../images/CgqCHl9xtbmAP4vcAAEKnyVM6Ig708.png)

ä¸Šé¢çš„æµ‹è¯•åœ¨æ‰§è¡Œäº† insert çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œä¸¤æ¡ insert çš„sql å’Œä¸¤æ¡ delete çš„ sqlï¼Œè¿™å°±ä½“ç°å‡ºäº† CascadeType.PERSIST å’Œ CascadeType.REMOVE çš„ä½œç”¨ã€‚

ä¸Šé¢è®²äº†**çº§è”åˆ é™¤**çš„åœºæ™¯ï¼Œä¸‹é¢æˆ‘ä»¬å†è¯´ä¸€ä¸‹**å…³è”å…³ç³»çš„åˆ é™¤åœºæ™¯**è¯¥æ€ä¹ˆåšã€‚



### orphanRemoval å±æ€§ç”¨æ³•

**orphanRemoval è¡¨ç¤ºå½“å…³è”å…³ç³»è¢«åˆ é™¤**çš„æ—¶å€™ï¼Œ**æ˜¯å¦åº”ç”¨çº§è”åˆ é™¤**ï¼Œé»˜è®¤ falseã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæµ‹è¯•ä¸€ä¸‹ä½ å°±ä¼šæ˜ç™½ã€‚

é¦–å…ˆï¼Œè¿˜æ²¿ç”¨ä¸Šé¢çš„ä¾‹å­ï¼Œå½“æˆ‘ä»¬åˆ é™¤ userInfo çš„æ—¶å€™ï¼ŒæŠŠ User ç½®ç©ºï¼Œä½œå¦‚ä¸‹æ”¹åŠ¨ã€‚

```java
userInfo.setUser(null);
userInfoRepository.delete(userInfo);
```

å…¶æ¬¡ï¼Œæˆ‘ä»¬å†è¿è¡Œæµ‹è¯•ï¼Œçœ‹çœ‹æ•ˆæœã€‚

```
delete from user_info where id=?
```

è¿™æ—¶å€™ä½ å°±ä¼šå‘ç°ï¼Œå°‘äº†ä¸€æ¡åˆ é™¤ user çš„ sqlï¼Œè¯´æ˜æ²¡æœ‰è¿›è¡Œçº§è”åˆ é™¤ã€‚é‚£æˆ‘ä»¬å†æŠŠ UserInfo åšä¸€ä¸‹è°ƒæ•´ã€‚

```java
public class UserInfo {
   @OneToOne(cascade = {CascadeType.PERSIST},orphanRemoval = true)
   private User user;
   //....å…¶ä»–æ²¡å˜çš„ä»£ç çœäº†
}
```

ç„¶åï¼Œæˆ‘ä»¬æŠŠ CascadeType.Remove åˆ é™¤äº†ï¼Œä¸è®©å®ƒè¿›è¡Œçº§è”åˆ é™¤ï¼Œä½†æ˜¯æˆ‘ä»¬æŠŠ orphanRemoval è®¾ç½®æˆ trueï¼Œå³å½“å…³è”å…³ç³»å˜åŒ–çš„æ—¶å€™çº§è”æ›´æ–°ã€‚æˆ‘ä»¬çœ‹ä¸‹å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ã€‚

```java
    @Test
    public void testUserRelationships() throws JsonProcessingException {
        User user = User.builder().name("jackxx").email("123456@126.com").build();
        UserInfo userInfo = UserInfo.builder().ages(12).user(user).telephone("12345678").build();
        userInfoRepository.saveAndFlush(userInfo);
        userInfo.setAges(13);
        userInfo.setUser(null);//è¿˜æ˜¯é€šè¿‡è¿™ä¸ªè®¾ç½®useræ•°æ®ä¸ºç©º
        userInfoRepository.delete(userInfo);
}
```

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿è¡Œç»“æœã€‚

![img](../images/CgqCHl9xthOAHALuAAFaT_9YXuM848.png)

å¯ä»¥çœ‹åˆ°ï¼Œç»“æœä¾ç„¶æ˜¯ä¸¤ä¸ª inser å’Œä¸¤ä¸ª deleteï¼Œä½†æ˜¯ä¸­é—´å¤šäº†ä¸€ä¸ª updateã€‚æˆ‘æ¥è§£é‡Šä¸€ä¸‹ï¼Œå› ä¸ºå»æ‰äº† CascadeType.REMOVEï¼Œè¿™ä¸ªæ—¶å€™ä¸ä¼šè¿›è¡Œçº§è”åˆ é™¤äº†ã€‚å½“æˆ‘ä»¬æŠŠ user å¯¹è±¡æ›´æ–°æˆç©ºçš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œä¸€æ¡ update è¯­å¥æŠŠå…³è”å…³ç³»å»æ‰äº†ã€‚

è€Œä¸ºä»€ä¹ˆåˆå‡ºç°äº†çº§è”åˆ é™¤ user å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬ä¿®æ”¹äº†é›†åˆå…³è”å…³ç³»ï¼ŒorphanRemoval è®¾ç½®ä¸º trueï¼Œæ‰€ä»¥åˆæ‰§è¡Œäº†çº§è”åˆ é™¤çš„æ“ä½œã€‚è¿™ä¸€ç‚¹ä½ å¯ä»¥ä»”ç»†ä½“ä¼šä¸€ä¸‹ orphanRemoval å’Œ CascadeType.REMOVE çš„åŒºåˆ«ã€‚

åˆ°è¿™é‡Œï¼Œ@OneToOne å…³è”å…³ç³»ä»‹ç»å®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹æ—¥å¸¸å·¥ä½œå¸¸è§çš„åœºæ™¯ï¼Œå…ˆçœ‹åœºæ™¯ä¸€ï¼šä¸»é”®å’Œå¤–é”®éƒ½æ˜¯åŒä¸€ä¸ªå­—æ®µçš„æƒ…å†µã€‚



### ä¸»é”®å’Œå¤–é”®éƒ½æ˜¯åŒä¸€ä¸ªå­—æ®µ

æˆ‘ä»¬å‡è®¾ user è¡¨æ˜¯ä¸»è¡¨ï¼Œuser_info çš„ä¸»é”®æ˜¯ user_idï¼Œå¹¶ä¸” user_id=user è¡¨é‡Œé¢çš„ idï¼Œé‚£æˆ‘ä»¬åº”è¯¥æ€ä¹ˆå†™ï¼Ÿ

ç»§ç»­æ²¿ç”¨ä¸Šé¢çš„ä¾‹å­ï¼ŒUser å®ä½“ä¸å˜ï¼Œæˆ‘ä»¬çœ‹çœ‹ UserInfo å˜æˆä»€ä¹ˆæ ·äº†ã€‚

```java
public class UserInfo implements Serializable {
   @Id
   private Long userId;
   private Integer ages;
   private String telephone;
   @MapsId
   @OneToOne(cascade = {CascadeType.PERSIST},orphanRemoval = true)
   private User user;
}
```

è¿™é‡Œçš„åšæ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥æŠŠ userId è®¾ç½®ä¸ºä¸»é”®ï¼Œåœ¨ @OneToOne ä¸Šé¢æ·»åŠ  @MapsId æ³¨è§£å³å¯ã€‚**@MapsId æ³¨è§£çš„ä½œç”¨æ˜¯æŠŠå…³è”å…³ç³»å®ä½“é‡Œé¢çš„ IDï¼ˆé»˜è®¤ï¼‰å€¼ copy åˆ° @MapsId æ ‡æ³¨çš„å­—æ®µä¸Šé¢**ï¼ˆè¿™é‡ŒæŒ‡çš„æ˜¯ user_id å­—æ®µï¼‰ã€‚

æ¥ç€ï¼Œä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹æˆ‘ä»¬è·‘ä¸€ä¸‹ï¼Œçœ‹ä¸€ä¸‹æ•ˆæœã€‚

```sql
create table user (id bigint not null, address varchar(255), email varchar(255), name varchar(255), sex varchar(255), primary key (id))
create table user_info (ages integer, telephone varchar(255), user_id bigint not null, primary key (user_id))
alter table user_info add constraint FKn8pl63y4abe7n0ls6topbqjh2 foreign key (user_id) references user
```

åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç›´æ¥åˆ›å»ºäº† user è¡¨å’Œ user_info è¡¨ï¼Œå…¶ä¸­ user_info çš„ä¸»é”®æ˜¯ user_idï¼Œå¹¶ä¸”é€šè¿‡å¤–é”®å…³è”åˆ°äº† user è¡¨çš„ ID å­—æ®µï¼Œé‚£ä¹ˆæˆ‘ä»¬åŒæ—¶çœ‹ä¸€ä¸‹ inser çš„ sqlï¼Œä¹Ÿå‘ç”Ÿäº†å˜åŒ–ã€‚

```sql
insert into user (address, email, name, sex, id) values (?, ?, ?, ?, ?)
insert into user_info (ages, telephone, user_id) values (?, ?, ?)
```

ä¸Šé¢å°±æ˜¯æˆ‘ä»¬è®²çš„å®æˆ˜åœºæ™¯ä¸€ï¼Œä¸»é”®å’Œå¤–é”®éƒ½æ˜¯åŒä¸€ä¸ªå­—æ®µã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å†è¯´ä¸€ä¸ªåœºæ™¯ï¼Œå°±æ˜¯åœ¨æŸ¥ user_info çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªæƒ³çŸ¥é“ user_id çš„å€¼å°±è¡Œäº†ï¼Œä¸éœ€è¦æŸ¥ user çš„å…¶ä»–ä¿¡æ¯ï¼Œå…·ä½“æˆ‘ä»¬åº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ



### @OneToOne å»¶è¿ŸåŠ è½½ï¼Œæˆ‘ä»¬åªéœ€è¦ ID å€¼

åœ¨ @OneToOne å»¶è¿ŸåŠ è½½çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å‡è®¾åªæƒ³æŸ¥ä¸‹ user_idï¼Œè€Œä¸æƒ³æŸ¥çœ‹ user è¡¨å…¶ä»–çš„ä¿¡æ¯ï¼Œå› ä¸ºå½“å‰ç”¨ä¸åˆ°ï¼Œå¯ä»¥æœ‰ä»¥ä¸‹å‡ ç§åšæ³•ã€‚

ç¬¬ä¸€ç§åšæ³•ï¼šè¿˜æ˜¯ User å®ä½“ä¸å˜ï¼Œæˆ‘ä»¬æ”¹ä¸€ä¸‹ UserInfo å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
@Entity
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
@ToString(exclude = "user")
public class UserInfo{
   @Id
   @GeneratedValue(strategy= GenerationType.AUTO)
   private Long id;
   private Integer ages;
   private String telephone;
   @MapsId
   @OneToOne(cascade = {CascadeType.PERSIST},orphanRemoval = true,fetch = FetchType.LAZY)
   private User user;
}
```

ä»ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°åšçš„æ›´æ”¹å¦‚ä¸‹ï¼š

-   id å­—æ®µæˆ‘ä»¬å…ˆç”¨åŸæ¥çš„
-   @OneToOne ä¸Šé¢æˆ‘ä»¬æ·»åŠ  @MapsId æ³¨è§£
-   @OneToOne é‡Œé¢çš„ fetch = FetchType.LAZY è®¾ç½®å»¶è¿ŸåŠ è½½ï¼ˆé»˜è®¤ï¼‰

æ¥ç€ï¼Œæˆ‘ä»¬æ”¹é€ ä¸€ä¸‹æµ‹è¯•ç±»ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

```java
@DataJpaTest
@TestInstance(TestInstance.Lifecycle.PER_CLASS)
public class UserInfoRepositoryTest {
    @Autowired
    private UserInfoRepository userInfoRepository;
    @BeforeAll
    @Rollback(false)
    @Transactional
    void init() {
        User user = User.builder().name("jackxx").email("123456@126.com").build();
        UserInfo userInfo = UserInfo.builder().ages(12).user(user).telephone("12345678").build();
        userInfoRepository.saveAndFlush(userInfo);
    }
    /**
     * æµ‹è¯•ç”¨Userå…³è”å…³ç³»æ“ä½œ
     *
     * @throws JsonProcessingException
     */
    @Test
    @Rollback(false)
    public void testUserRelationships() throws JsonProcessingException {
        UserInfo userInfo1 = userInfoRepository.getOne(1L);
        System.out.println(userInfo1);
        System.out.println(userInfo1.getUser().getId());
}
```

ç„¶åï¼Œæˆ‘ä»¬è·‘ä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼Œçœ‹çœ‹æµ‹è¯•ç»“æœã€‚

```sql
insert into user (address, email, name, sex, id) values (?, ?, ?, ?, ?)
insert into user (address, email, name, sex, id) values (?, ?, ?, ?, ?)

-- ä¸¤æ¡inserç…§æ—§ï¼Œè€Œåªæœ‰ä¸€ä¸ªselect
select userinfo0_.user_id as user_id3_6_0_, userinfo0_.ages as ages1_6_0_, userinfo0_.telephone as telephon2_6_0_ from user_info userinfo0_ where userinfo0_.user_id=?
```

æœ€åä½ ä¼šå‘ç°ï¼Œæ‰“å°çš„ç»“æœç¬¦åˆé¢„æœŸã€‚

```
UserInfo(id=1, ages=12, telephone=12345678)
1
```

æ¥ä¸‹æ¥ä»‹ç»ç¬¬äºŒç§åšæ³•ï¼Œè¿™ç§åšæ³•å¾ˆç®€å•ï¼Œåªè¦åœ¨ UserInfo å¯¹è±¡é‡Œé¢ç›´æ¥å»æ‰ @OneToOne å…³è”å…³ç³»ï¼Œæ–°å¢ä¸‹é¢çš„å­—æ®µå³å¯ã€‚

```java
@Column(name = "user_id")
private Long userId;
```

è¿™å°±æ²¡æœ‰å…³è”å…³ç³»äº†



ç¬¬ä¸‰åšæ³•æ˜¯åˆ©ç”¨ Hibernateï¼Œå®ƒç»™æˆ‘ä»¬æä¾›äº†ä¸€ç§å­—èŠ‚ç å¢å¼ºæŠ€æœ¯ï¼Œé€šè¿‡ç¼–è¯‘å™¨æ”¹å˜ class è§£å†³äº†å»¶è¿ŸåŠ è½½é—®é¢˜ã€‚è¿™ç§æ–¹å¼æœ‰ç‚¹å¤æ‚ï¼Œéœ€è¦åœ¨ç¼–è¯‘å™¨å¼•å…¥ hibernateEnhance çš„ç›¸å…³ jar åŒ…ï¼Œä»¥åŠç¼–è¯‘å™¨éœ€è¦æ”¹å˜ class æ–‡ä»¶å¹¶æ·»åŠ  lazy ä»£ç†æ¥è§£å†³å»¶è¿ŸåŠ è½½ã€‚æˆ‘ä¸å¤ªæ¨èè¿™ç§æ–¹å¼ï¼Œå› ä¸ºå¤ªå¤æ‚ï¼Œä½ çŸ¥é“æœ‰è¿™å›äº‹å°±è¡Œäº†ã€‚

ä»¥ä¸Šæˆ‘ä»¬æŒæ¡äº†è¿™ä¹ˆå¤šç”¨æ³•ï¼Œé‚£ä¹ˆæœ€ä½³å®è·µæ˜¯ä»€ä¹ˆï¼ŸåŒå‘å…³è”æ›´å¥½è¿˜æ˜¯å•å‘å…³è”æ›´å¥½ï¼Ÿæ ¹æ®æœ€è¿‘å‡ å¹´çš„åº”ç”¨ï¼Œæˆ‘æ€»ç»“å‡ºäº†ä¸€äº›æœ€ä½³å®è·µï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ã€‚



### @OneToOne çš„æœ€ä½³å®è·µ

**ç¬¬ä¸€ï¼Œæˆ‘è¦è¯´ä¸€ç§ Java é¢å‘å¯¹è±¡çš„è®¾è®¡åŸåˆ™ï¼šå¼€é—­åŸåˆ™ã€‚**

å³å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚**å¦‚æœæˆ‘ä»¬ä¸€ç›´ä½¿ç”¨åŒå‘å…³è”ï¼Œä¸¤ä¸ªå®ä½“çš„å¯¹è±¡è€¦åˆå¤ªä¸¥é‡äº†**ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œéšç€ä¸šåŠ¡çš„å‘å±•ï¼ŒUser å¯¹è±¡å¯èƒ½æ˜¯åŸå§‹å¯¹è±¡ï¼Œ**å›´ç»•ç€ User å¯èƒ½ä¼šæ‰©å±•å‡ºå„ç§å…³è”å¯¹è±¡**ã€‚**éš¾é“ User é‡Œé¢æ¯æ¬¡éƒ½è¦ä¿®æ”¹ï¼Œå»æ·»åŠ åŒå‘å…³è”å…³ç³»å—**ï¼Ÿè‚¯å®šä¸æ˜¯ï¼Œå¦åˆ™æ—¶é—´é•¿äº†ï¼Œå¯¹è±¡ä¸å¯¹è±¡ä¹‹é—´çš„å…³è”å…³ç³»å°±æ˜¯ä¸€å›¢ä¹±éº»ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬**å°½é‡ã€ç”šè‡³ä¸è¦ç”¨åŒå‘å…³è”ï¼Œå¦‚æœéè¦ç”¨å…³è”å…³ç³»çš„è¯ï¼Œåªç”¨å•å‘å…³è”å°±å¤Ÿäº†**ã€‚åŒå‘å…³è”æ­£æ˜¯ JPA çš„å¼ºå¤§ä¹‹å¤„ï¼Œä½†åŒæ—¶ä¹Ÿæ˜¯é—®é¢˜æœ€å¤šï¼Œæœ€è¢«äººè¯Ÿç—…ä¹‹å¤„ã€‚æ‰€ä»¥æˆ‘ä»¬è¦ç”¨å®ƒçš„ä¼˜ç‚¹ï¼Œè€Œä¸æ˜¯å­¦ä¼šäº†å°±ä¸€å®šè¦ä½¿ç”¨ã€‚

**ç¬¬äºŒï¼Œæˆ‘æƒ³è¯´ CascadeType å¾ˆå¼ºå¤§ï¼Œä½†æ˜¯æˆ‘ä¹Ÿå»ºè®®ä¿æŒé»˜è®¤ã€‚**

å³æ²¡æœ‰çº§è”æ›´æ–°åŠ¨ä½œï¼Œæ²¡æœ‰çº§è”åˆ é™¤åŠ¨ä½œã€‚è¿˜æœ‰ orphanRemoval ä¹Ÿè¦å°½é‡ä¿æŒé»˜è®¤ falseï¼Œä¸åšçº§è”åˆ é™¤ã€‚å› ä¸ºè¿™ä¸¤ä¸ªåŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œä½†æ˜¯æˆ‘ä¸ªäººè§‰å¾—è¿™è¿èƒŒäº†é¢å‘å¯¹è±¡è®¾è®¡åŸåˆ™é‡Œé¢çš„â€œèŒè´£å•ä¸€åŸåˆ™â€ï¼Œé™¤éä½ éå¸¸éå¸¸ç†Ÿæ‚‰ï¼Œå¦åˆ™ä½ åœ¨ç”¨çš„æ—¶å€™ä¼šæ—¶å¸¸æ„Ÿåˆ°æƒŠè®¶â€”â€”æ•°æ®ä»€ä¹ˆæ—¶é—´è¢«æ›´æ–°äº†ï¼Ÿæ•°æ®è¢«è°åˆ é™¤äº†ï¼Ÿé‡åˆ°è¿™ç§é—®é¢˜æŸ¥èµ·æ¥éå¸¸éº»çƒ¦ï¼Œå› ä¸ºæ˜¯æ¡†æ¶å¤„ç†ï¼Œæœ‰çš„æ—¶å€™å¹¶éé¢„æœŸçš„æ•ˆæœã€‚

ä¸€æ—¦ç”Ÿäº§æ•°æ®è¢«è«åæ›´æ–°æˆ–è€…åˆ é™¤ï¼Œé‚£æ˜¯ä¸€ä»¶éå¸¸ç³Ÿç³•çš„äº‹æƒ…ã€‚å› ä¸ºè¿™äº›çº§è”æ“ä½œä¼šä½¿ä½ çš„æ–¹æ³•åå­—æ²¡åŠæ³•å‘½åï¼Œè€Œä¸”å®ƒä¸æ˜¯è·Ÿç€ä¸šåŠ¡é€»è¾‘å˜åŒ–çš„ï¼Œè€Œæ˜¯è·Ÿç€å®ä½“å˜åŒ–çš„ï¼Œè¿™å°±ä¼šä½¿æ–¹æ³•å’Œå¯¹è±¡çš„èŒè´£ä¸å•ä¸€ã€‚

**ç¬¬ä¸‰ï¼Œæˆ‘æƒ³å‘Šè¯‰ä½ ï¼Œæ‰€æœ‰ç”¨åˆ°å…³è”å…³ç³»çš„åœ°æ–¹ï¼Œèƒ½ç”¨ Lazy çš„ç»å¯¹ä¸è¦ç”¨ EAGERï¼Œå¦åˆ™ä¼šæœ‰ SQL æ€§èƒ½é—®é¢˜ï¼Œä¼šå‡ºç°ä¸æ˜¯é¢„æœŸçš„ SQLã€‚**

ä»¥ä¸Šä¸‰ç‚¹æ˜¯æˆ‘æ€»ç»“çš„é¿å‘æŒ‡å—ï¼Œæœ‰ç»éªŒçš„åŒå­¦è¿™æ—¶å€™ä¼šæœ‰ä¸ªç–‘é—®ï¼šå¤–é”®çº¦æŸä¸æ˜¯ä¸æ¨èä½¿ç”¨çš„å—ï¼Ÿå¦‚æœæˆ‘çš„å¤–é”®å­—æ®µåä¸æ˜¯çº¦å®šçš„æ€ä¹ˆåŠï¼Ÿåˆ«ç€æ€¥ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹ @JoinColumn æ³¨è§£å’Œ @JoinColumns æ³¨è§£ã€‚



### @JoinCloumns & JoinColumn

è¿™ä¸¤ä¸ªæ³¨è§£æ˜¯é›†åˆå…³ç³»ï¼Œä»–ä»¬å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼Œ@JoinColumn è¡¨ç¤ºå•å­—æ®µï¼Œ@JoinCloumns è¡¨ç¤ºå¤šä¸ª @JoinColumnï¼Œæˆ‘ä»¬æ¥ä¸€ä¸€çœ‹ä¸€ä¸‹ã€‚

æˆ‘ä»¬è¿˜æ˜¯å…ˆç›´æ¥çœ‹ä¸€ä¸‹ @JoinColumn æºç ï¼Œäº†è§£ä¸‹è¿™ä¸€æ³¨è§£éƒ½æœ‰å“ªäº›é…ç½®é¡¹ã€‚

```java
public @interface JoinColumn {
    //å…³é”®çš„å­—æ®µå,é»˜è®¤æ³¨è§£ä¸Šçš„å­—æ®µåï¼Œåœ¨@OneToOneä»£è¡¨æœ¬è¡¨çš„å¤–é”®å­—æ®µåå­—ï¼›
    String name() default "";
    //ä¸nameç›¸åå…³è”å¯¹è±¡çš„å­—æ®µï¼Œé»˜è®¤ä¸»é”®å­—æ®µ
    String referencedColumnName() default "";
    //å¤–é”®å­—æ®µæ˜¯å¦å”¯ä¸€
    boolean unique() default false;
    //å¤–é”®å­—æ®µæ˜¯å¦å…è®¸ä¸ºç©º
    boolean nullable() default true;
    //æ˜¯å¦è·Ÿéšä¸€èµ·æ–°å¢
    boolean insertable() default true;
    //æ˜¯å¦è·Ÿéšä¸€èµ·æ›´æ–°
    boolean updatable() default true;
    //JPA2.1æ–°å¢ï¼Œå¤–é”®ç­–ç•¥
    ForeignKey foreignKey() default @ForeignKey(PROVIDER_DEFAULT);
}
```

å…¶æ¬¡ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ @ForeignKey(PROVIDER_DEFAULT) é‡Œé¢æšä¸¾å€¼æœ‰å‡ ä¸ªã€‚

```java
public enum ConstraintMode {
    //åˆ›å»ºå¤–é”®çº¦æŸ
   CONSTRAINT,
    //ä¸åˆ›å»ºå¤–é”®çº¦æŸ
   NO_CONSTRAINT,
   //é‡‡ç”¨é»˜è®¤è¡Œä¸º
   PROVIDER_DEFAULT
}
```

ç„¶åï¼Œæˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªæ³¨è§£çš„è¯­æ³•ï¼Œå°±å¯ä»¥è§£ç­”æˆ‘ä»¬ä¸Šé¢çš„ä¸¤ä¸ªé—®é¢˜ã€‚ä¿®æ”¹ä¸€ä¸‹ UserInfoï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public class UserInfo{
    @Id
    @GeneratedValue(strategy= GenerationType.AUTO)
    private Long id;
    private Integer ages;
    private String telephone;
    @OneToOne(cascade = {CascadeType.PERSIST},orphanRemoval = true,fetch = FetchType.LAZY)
    @JoinColumn(foreignKey = @ForeignKey(ConstraintMode.NO_CONSTRAINT),name = "my_user_id")
    private User user;
    //...å…¶ä»–ä¸å˜
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨å…¶ä¸­æŒ‡å®šäº†å­—æ®µçš„åå­—ï¼šmy_user_idï¼Œå¹¶ä¸”æŒ‡å®š NO_CONSTRAINT ä¸ç”Ÿæˆå¤–é”®ã€‚è€Œæµ‹è¯•ç”¨ä¾‹ä¸å˜ï¼Œæˆ‘ä»¬çœ‹ä¸‹è¿è¡Œç»“æœã€‚

```sql
create table user (id bigint not null, address varchar(255), email varchar(255), name varchar(255), sex varchar(255), primary key (id))
create table user_info (id bigint not null, ages integer, telephone varchar(255), my_user_id bigint, primary key (id))
```

è¿™æ—¶æˆ‘ä»¬çœ‹åˆ° user_info è¡¨é‡Œé¢æ–°å¢äº†ä¸€ä¸ªå­—æ®µ my_user_idï¼Œinsert çš„æ—¶å€™ä¹Ÿèƒ½æ­£ç¡® inser my_user_id çš„å€¼ç­‰äº user.idã€‚

```sql
insert into user_info (ages, telephone, my_user_id, id) values (?, ?, ?, ?)
```

è€Œ @JoinColumns æ˜¯ JoinColumns çš„å¤æ•°å½¢å¼ï¼Œå°±æ˜¯é€šè¿‡ä¸¤ä¸ªå­—æ®µè¿›è¡Œçš„å¤–é”®å…³è”ï¼Œè¿™ä¸ªä¸å¸¸ç”¨ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸ª demo äº†è§£ä¸€ä¸‹å°±å¥½ã€‚

```java
@Entity
public class CompanyOffice {
   @ManyToOne(fetch = FetchType.LAZY)
   @JoinColumns({
         @JoinColumn(name="ADDR_ID", referencedColumnName="ID"),
         @JoinColumn(name="ADDR_ZIP", referencedColumnName="ZIP")
   })
   private Address address;
}
```

ä¸Šé¢çš„å®ä¾‹ä¸­ï¼ŒCompanyOffice é€šè¿‡ ADDR_ID å’Œ ADDR_ZIP ä¸¤ä¸ªå­—æ®µå¯¹åº”ä¸€æ¡ address ä¿¡æ¯ï¼Œè§£é‡Šäº†ä¸€ä¸‹@JoinColumnsçš„ç”¨æ³•ã€‚

å¦‚æœä½ äº†è§£äº† @OneToOne çš„è¯¦ç»†ç”¨æ³•ï¼Œåé¢è¦è®²çš„å‡ ä¸ªæ³¨è§£å°±å¾ˆå¥½ç†è§£äº†ï¼Œå› ä¸ºä»–ä»¬æœ‰ç‚¹ç±»ä¼¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹ @ManyToOne å’Œ @OneToMany çš„ç”¨æ³•ã€‚







## ä¸€å¯¹å¤š

### JPA åè®®

*   ç»´æŠ¤å…³è”å…³ç³»çš„æ˜¯æ‹¥æœ‰å¤–é”®çš„ä¸€æ–¹ï¼Œè€Œå¦ä¸€æ–¹å¿…é¡»é…ç½® mappedBy





### æ¡ˆä¾‹ä»‹ç»

å®¢æˆ·å’Œè”ç³»äººçš„æ¡ˆä¾‹ï¼ˆæ³¨æ„ï¼Œå®¢æˆ·å’Œè”ç³»äººæ˜¯å±äºåŒä¸€å…¬å¸çš„ï¼‰

-   å®¢æˆ·ï¼šä¹°äº†å•†å“çš„ä¸€å®¶å…¬å¸
-   è”ç³»äººï¼šä¹°äº†å•†å“çš„è¿™å®¶å…¬å¸çš„å‘˜å·¥ï¼ˆå¯æœ‰å¤šä¸ªï¼‰

ä¸€å¯¹å¤šå…³ç³»ï¼Œä¸€ä¸ªå®¢æˆ·å¯ä»¥å…·æœ‰å¤šä¸ªè”ç³»äººï¼Œä¸€ä¸ªè”ç³»äººä»å±äºä¸€å®¶å…¬å¸



### åˆ†ææ­¥éª¤

1.  æ˜ç¡®è¡¨å…³ç³»ï¼šä¸€å¯¹å¤šå…³ç³»
2.  ç¡®å®šè¡¨å…³ç³»ï¼ˆå¤–é”®ï¼‰
    -   **ä¸»è¡¨**ï¼šå®¢æˆ·è¡¨
    -   **ä»è¡¨**ï¼šè”ç³»äººè¡¨ï¼Œåœ¨ä»è¡¨æ·»åŠ **å¤–é”®**
3.  ç¼–å†™å®ä½“ç±»ï¼Œå†å®ä½“ç±»ä¸­æè¿°è¡¨å…³ç³»ï¼ˆ**ç»„åˆ**ï¼‰
    -   å®¢æˆ·ï¼šå†å®¢æˆ·çš„å®ä½“ç±»ä¸­åŒ…å«ä¸€ä¸ªè”ç³»äººçš„é›†åˆ
    -   è”ç³»äººï¼šåœ¨è”ç³»äººçš„å®ä½“ç±»ä¸­åŒ…å«ä¸€ä¸ªå®¢æˆ·çš„å¯¹è±¡
4.  é…ç½®æ˜ å°„å…³ç³»
    -   ä½¿ç”¨ **JPA æ³¨è§£é…ç½®ä¸€å¯¹å¤šæ˜ å°„å…³ç³»**



### @OneToMany & @ManyToOne

@ManyToOne ä»£è¡¨å¤šå¯¹ä¸€çš„å…³è”å…³ç³»ï¼Œè€Œ @OneToMany ä»£è¡¨ä¸€å¯¹å¤šï¼Œä¸€èˆ¬ä¸¤ä¸ªæˆå¯¹ä½¿ç”¨è¡¨ç¤ºåŒå‘å…³è”å…³ç³»ã€‚è€Œ JPA åè®®ä¸­ä¹Ÿæ˜¯æ˜ç¡®è§„å®šï¼š**ç»´æŠ¤å…³è”å…³ç³»çš„æ˜¯æ‹¥æœ‰å¤–é”®çš„ä¸€æ–¹ï¼ˆä»è¡¨ï¼‰ï¼Œè€Œå¦ä¸€æ–¹ï¼ˆä¸»è¡¨ï¼‰å¿…é¡»é…ç½® mappedBy**ã€‚ä½“ä¼šä¸åˆ°çœ‹ä¸‹é¢çš„å®æˆ˜åŠé—®é¢˜åˆ†æå³å¯æ˜äº†ã€‚

çœ‹ä¸‹é¢çš„æºç ã€‚

```java
public @interface ManyToOne {

    Class targetEntity() default void.class;

    CascadeType[] cascade() default {};

    FetchType fetch() default EAGER;

    boolean optional() default true;

}

 public @interface OneToMany {

    Class targetEntity() default void.class;

 	//cascade çº§è”æ“ä½œç­–ç•¥ï¼š(CascadeType.PERSISTã€CascadeType.REMOVEã€CascadeType.REFRESHã€CascadeType.MERGEã€CascadeType.ALL) å¦‚æœä¸å¡«ï¼Œé»˜è®¤å…³ç³»è¡¨ä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“ã€‚
    CascadeType[] cascade() default {};

	//æ•°æ®è·å–æ–¹å¼EAGER(ç«‹å³åŠ è½½)/LAZY(å»¶è¿ŸåŠ è½½)
    FetchType fetch() default LAZY;

    //å…³ç³»è¢«è°ç»´æŠ¤ï¼Œå•é¡¹çš„ã€‚æ³¨æ„ï¼šåªæœ‰å…³ç³»ç»´æŠ¤æ–¹æ‰èƒ½æ“ä½œä¸¤è€…çš„å…³ç³»ã€‚
    String mappedBy() default "";

	//æ˜¯å¦çº§è”åˆ é™¤ã€‚å’ŒCascadeType.REMOVEçš„æ•ˆæœä¸€æ ·ã€‚ä¸¤ç§é…ç½®äº†ä¸€ä¸ªå°±ä¼šè‡ªåŠ¨çº§è”åˆ é™¤
    boolean orphanRemoval() default false;

}
```

æˆ‘ä»¬çœ‹åˆ°ä¸Šé¢çš„å­—æ®µå’Œ @OneToOne é‡Œé¢çš„åŸºæœ¬ä¸€æ ·ï¼Œç”¨æ³•æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

1.  @ManyToOne ä¸€å®šæ˜¯ç»´æŠ¤å¤–é”®å…³ç³»çš„ä¸€æ–¹ï¼Œæ‰€ä»¥æ²¡æœ‰ mappedBy å­—æ®µï¼›
2.  @ManyToOne åˆ é™¤çš„æ—¶å€™ä¸€å®šä¸èƒ½æŠŠ One çš„ä¸€æ–¹åˆ é™¤äº†ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰ orphanRemoval çš„é€‰é¡¹ï¼›
3.  @ManyToOne çš„ Lazy æ•ˆæœå’Œ @OneToOne çš„ä¸€æ ·ï¼Œæ‰€ä»¥å’Œä¸Šé¢çš„ç”¨æ³•åŸºæœ¬ä¸€è‡´ï¼›
4.  @OneToMany çš„ Lazy æ˜¯æœ‰æ•ˆæœçš„ã€‚



### å®æˆ˜ï¼šä¿å­˜

å®ä½“ç±»å¦‚ä¸‹ï¼Œç›®å‰é…ç½®äº†**åŒå‘å…³è”**ï¼ˆ@OneToManyã€@ManyToOneï¼‰ï¼Œ**ä¸”ä¸»ä»è¡¨éƒ½å¯ä»¥ç»´æŠ¤å¤–é”®ï¼ˆä¸æ¨èï¼‰**

```java
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Entity
public class Customer {


    /* å®¢æˆ·ç¼–å·ï¼ˆä¸»é”®ï¼‰*/
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long Id;

    /* å®¢æˆ·åç§°ï¼ˆå…¬å¸åç§°ï¼‰ */
    private String name;

    /* å®¢æˆ·ä¿¡æ¯æ¥æº */
    private String source;

    /* å®¢æˆ·æ‰€å±è¡Œä¸š */
    private String industry;

    /* å®¢æˆ·çº§åˆ« */
    private String level;

    /* å®¢æˆ·è”ç³»åœ°å€ */
    private String address;

    /* å®¢æˆ·è”ç³»ç”µè¯ */
    private String phone;


    // ä¸æ¨èçš„é…ç½®ï¼Œä¸»è¡¨æ²¡æœ‰æ”¾å¼ƒç»´æŠ¤å¤–é”®
    @OneToMany
    @JoinColumn(name = "custId")
    private Set<LinkMan> linkManSet;
}
```

```java
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Entity
public class LinkMan {

    /* è”ç³»äººç¼–å·(ä¸»é”®) */
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    /* è”ç³»äººå§“å */
    private String name;

    /* è”ç³»äººæ€§åˆ« */
    private String gender;

    /* è”ç³»äººåŠå…¬ç”µè¯ */
    private String phone;

    /* è”ç³»äººæ‰‹æœº */
    private String mobile;

    /* è”ç³»äººé‚®ç®± */
    private String email;

    /* è”ç³»äººèŒä½ */
    private String position;

    /* è”ç³»äººå¤‡æ³¨ */
    private String remark;


    @ManyToOne
    @JoinColumn(name = "cust_id")
    private Customer customer;
}
```

æµ‹è¯•

```java
@DataJpaTest
// DataJpaTestã€MybatisTest ä¼šé»˜è®¤ä½¿ç”¨å…¶æµ‹è¯•æ•°æ®æºæ›¿ä»£ï¼Œè‹¥è¦ä½¿ç”¨è‡ªå·±é…ç½®çš„ï¼Œéœ€è¦æ·»åŠ å¦‚ä¸‹æ³¨è§£
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
public class One2ManyTest {

    @Autowired
    private CustomerRepository customerRepository;

    @Autowired
    private LinkManRepository linkManRepository;


    /**
     * ä¸»è¡¨æ”¾å¼ƒç»´æŠ¤å¤–é”®åè¯¥æ–¹æ³•æ— æ³•æ·»åŠ å¤–é”®å€¼
     */
    @Test
    @Rollback(false)
    @Transactional
    void testSave() {
        Customer customer = Customer.builder().name("è…¾è®¯").linkManSet(new HashSet<>()).build();

        LinkMan linkMan = LinkMan.builder().name("å°é©¬").build();

        // åŒå‘å…³è”ï¼Œä¸»è¡¨ç»´æŠ¤å¤–é”®
        customer.getLinkManSet().add(linkMan);

        customerRepository.save(customer);
        linkManRepository.save(linkMan);
        // ä¿å­˜å¤–é”®æ—¶æ²¡æœ‰ç›´æ¥ insert è€Œæ˜¯2æ¡ insert åæ‰§è¡Œäº† updateï¼

    }

    /**
     * æ¨èä½¿ç”¨çš„æ–¹å¼
     */
    @Test
    @Rollback(false)
    @Transactional
    void testSave2() {
        Customer customer = Customer.builder().name("è…¾è®¯").build();

        LinkMan linkMan = LinkMan.builder()
                .name("å°é©¬")
                .customer(customer)// åŒå‘å…³è”ï¼Œä»è¡¨ç»´æŠ¤å¤–é”®
                .build();

        customerRepository.save(customer);
        linkManRepository.save(linkMan);
        // ä¿å­˜å¤–é”®æ—¶åªç”¨äº†2æ¡ updateï¼

    }

}
```



### é—®é¢˜åˆ†æ

testSave è‡ªåŠ¨ç”Ÿæˆçš„sqlï¼š

```sql
CREATE TABLE customer (
	id BIGINT NOT NULL auto_increment,
	address VARCHAR ( 255 ),
	industry VARCHAR ( 255 ),
	LEVEL VARCHAR ( 255 ),
	NAME VARCHAR ( 255 ),
	phone VARCHAR ( 255 ),
source VARCHAR ( 255 ),
PRIMARY KEY ( id )) ENGINE = INNODB;

CREATE TABLE link_man (
	id BIGINT NOT NULL auto_increment,
	email VARCHAR ( 255 ),
	gender VARCHAR ( 255 ),
	mobile VARCHAR ( 255 ),
	NAME VARCHAR ( 255 ),
	phone VARCHAR ( 255 ),
	position VARCHAR ( 255 ),
	remark VARCHAR ( 255 ),
cust_id BIGINT,
PRIMARY KEY ( id )) ENGINE = INNODB;

-- å¤–é”®çº¦æŸ
alter table link_man add constraint FKd378jah5xd7bsqjolfsop35i foreign key (cust_id) references customer (id)

-- ä¿å­˜
insert into customer (address, industry, level, name, phone, source) values (?, ?, ?, ?, ?, ?)
insert into link_man (cust_id, email, gender, mobile, name, phone, position, remark) values (?, ?, ?, ?, ?, ?, ?, ?)
update link_man set cust_id=? where id=?
```

å¯è§ï¼Œ**ç›®å‰ç”Ÿæˆçš„å»ºè¡¨è¯­å¥ç«Ÿç„¶æœ‰3æ¡**ï¼Œæœ¬åº”è¯¥åªæœ‰2æ¡ï¼å¹¶ä¸”ä¿å­˜å¤–é”®æ—¶**æ²¡æœ‰ç›´æ¥ insert è€Œæ˜¯2æ¡ insert åæ‰§è¡Œäº† update**ï¼

å› æ­¤è¯¥æ–¹å¼**ä¸å¯å–**ï¼ˆå®é™…ç”Ÿäº§ä¸­å»ºè¡¨å¯ä»¥ä¸ç”¨ç®¡ï¼Œä½†æ˜¯å¯¹äºä¿å­˜æ“ä½œå°±ä¸åº”è¯¥ç”¨è¿™ä¹ˆå¤šæ¡è¯­å¥å®Œæˆï¼ï¼‰

testSave2 è‡ªåŠ¨ç”Ÿæˆçš„sqlï¼š

```sql
CREATE TABLE customer (
	id BIGINT NOT NULL auto_increment,
	address VARCHAR ( 255 ),
	industry VARCHAR ( 255 ),
	LEVEL VARCHAR ( 255 ),
	NAME VARCHAR ( 255 ),
	phone VARCHAR ( 255 ),
source VARCHAR ( 255 ),
PRIMARY KEY ( id )) ENGINE = INNODB;

CREATE TABLE link_man (
	id BIGINT NOT NULL auto_increment,
	email VARCHAR ( 255 ),
	gender VARCHAR ( 255 ),
	mobile VARCHAR ( 255 ),
	NAME VARCHAR ( 255 ),
	phone VARCHAR ( 255 ),
	position VARCHAR ( 255 ),
	remark VARCHAR ( 255 ),
cust_id BIGINT,
PRIMARY KEY ( id )) ENGINE = INNODB;

-- å¤–é”®çº¦æŸ
alter table link_man add constraint FKd378jah5xd7bsqjolfsop35i foreign key (cust_id) references customer (id)

-- ä¿å­˜
insert into customer (address, industry, level, name, phone, source) values (?, ?, ?, ?, ?, ?)
insert into link_man (cust_id, email, gender, mobile, name, phone, position, remark) values (?, ?, ?, ?, ?, ?, ?, ?)
```

å¯è§ï¼Œ**ç›®å‰ç”Ÿæˆçš„å»ºè¡¨è¯­å¥ç«Ÿç„¶æœ‰3æ¡**ï¼Œæœ¬åº”è¯¥åªæœ‰2æ¡ï¼ä½†æ˜¯ä¿å­˜å¤–é”®æ—¶**åªç”¨äº†2æ¡ update**ï¼æ‰€ä»¥æ¨èï¼





### æ”¹è¿›ï¼šä¸»è¡¨æ”¾å¼ƒå¤–é”®ç»´æŠ¤

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Entity
public class Customer {


    /* å®¢æˆ·ç¼–å·ï¼ˆä¸»é”®ï¼‰*/
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long Id;

    /* å®¢æˆ·åç§°ï¼ˆå…¬å¸åç§°ï¼‰ */
    private String name;

    /* å®¢æˆ·ä¿¡æ¯æ¥æº */
    private String source;

    /* å®¢æˆ·æ‰€å±è¡Œä¸š */
    private String industry;

    /* å®¢æˆ·çº§åˆ« */
    private String level;

    /* å®¢æˆ·è”ç³»åœ°å€ */
    private String address;

    /* å®¢æˆ·è”ç³»ç”µè¯ */
    private String phone;



    // ä¸»è¡¨åº”è¯¥æ”¾å¼ƒå¯¹å¤–é”®çš„ç»´æŠ¤
    // @OneToMany
    // @JoinColumn(name = "custId")
    // private Set<LinkMan> linkManSet;

    @OneToMany(mappedBy = "customer")
    private Set<LinkMan> linkManSet;
}
```

å…¶ä½™ä¸å˜ï¼Œä½†æ˜¯æ³¨æ„æµ‹è¯•æ–¹æ³•åªæœ‰testSave2å¯ä»¥æ·»åŠ å¤–é”®å€¼äº†ï¼å› ä¸ºåªæœ‰ä»è¡¨æ‰èƒ½ç»´æŠ¤å¤–é”®äº†





### å®æˆ˜ï¼šçº§è” â˜ ï¸

**åˆ é™¤ä»è¡¨**æ•°æ®ï¼šå¯ä»¥éšæ—¶ä»»æ„åˆ é™¤

**åˆ é™¤ä¸»è¡¨**æ•°æ®ï¼š

-   æ²¡æœ‰ä»è¡¨æ•°æ®å¼•ç”¨ï¼šéšä¾¿åˆ 
-   æœ‰ä»è¡¨æ•°æ®ï¼š
    -   åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¼šæŠŠå¤–é”®å­—æ®µç½®ä¸ºnullï¼Œç„¶ååˆ é™¤ä¸»è¡¨æ•°æ®ã€‚å¦‚æœåœ¨æ•°æ®åº“çš„è¡¨ç»“æ„ä¸Šï¼Œå¤–é”®å­—æ®µæœ‰éç©ºçº¦æŸï¼Œé»˜è®¤æƒ…å†µå°±ä¼šæŠ¥é”™äº†
    -   å¦‚æœé…ç½®äº†æ”¾å¼ƒç»´æŠ¤å…³è”å…³ç³»çš„æƒåˆ©ï¼Œåˆ™ä¸èƒ½åˆ é™¤ï¼ˆä¸å¤–é”®å­—æ®µæ˜¯å¦å…è®¸ä¸ºnullï¼Œæ²¡æœ‰å…³ç³»ï¼‰å› ä¸ºåœ¨åˆ é™¤æ—¶ï¼Œå®ƒæ ¹æœ¬ä¸ä¼šå»æ›´æ–°ä»è¡¨çš„å¤–é”®å­—æ®µäº†
    -   å¦‚æœè¿˜æƒ³åˆ é™¤ï¼Œä½¿ç”¨çº§è”åˆ é™¤å¼•ç”¨ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œçº§è”åˆ é™¤è¯·æ…ç”¨ï¼(åœ¨ä¸€å¯¹å¤šçš„æƒ…å†µä¸‹)

**çº§è”**ï¼šæ“ä½œä¸€ä¸ªå¯¹è±¡çš„åŒæ—¶æ“ä½œä»–çš„å…³è”å¯¹è±¡

-   çº§è”æ“ä½œï¼š 1.éœ€è¦**åŒºåˆ†æ“ä½œä¸»ä½“** 2.éœ€è¦åœ¨æ“ä½œä¸»ä½“çš„å®ä½“ç±»ä¸Šï¼ˆä¸»è¡¨æˆ–ç»´æŠ¤è¡¨ï¼‰ï¼Œæ·»åŠ çº§è”å±æ€§`cascade`ï¼ˆéœ€è¦æ·»åŠ åˆ°å¤šè¡¨æ˜ å°„å…³ç³»çš„æ³¨è§£ä¸Šï¼‰
-   çº§è”æ·»åŠ ï¼Œæ¡ˆä¾‹ï¼šå½“æˆ‘ä¿å­˜ä¸€ä¸ªå®¢æˆ·çš„åŒæ—¶ä¿å­˜è”ç³»äººï¼ˆåœ¨ä»£ç ä¸­åªéœ€ä¿å­˜å®¢æˆ·ï¼ï¼‰
-   çº§è”åˆ é™¤ï¼Œæ¡ˆä¾‹ï¼šå½“æˆ‘åˆ é™¤ä¸€ä¸ªå®¢æˆ·çš„åŒæ—¶åˆ é™¤æ­¤å®¢æˆ·çš„æ‰€æœ‰è”ç³»äººï¼Œæœ‰ä¸­é—´è¡¨ä¼šå…ˆåˆ é™¤ä¸­é—´è¡¨ï¼ˆåœ¨ä»£ç ä¸­åªéœ€åˆ é™¤å®¢æˆ·ï¼ï¼‰
-   çº§è”æ›´æ–°ï¼Œç•¥



**é»˜è®¤æ˜¯ä¸è¿›è¡Œçº§è”æ“ä½œ**ï¼Œéœ€è¦åœ¨**æ“ä½œä¸»è¡¨é…ç½®ï¼ˆä¸€èˆ¬é…ç½®åœ¨ä¸»è¡¨ï¼Œè™½ç„¶ä»è¡¨ä¹Ÿå¯ä»¥é…ç½®ï¼‰**å¦‚ä¸‹æ³¨è§£ï¼š

```java
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Entity
public class Customer {


    /* å®¢æˆ·ç¼–å·ï¼ˆä¸»é”®ï¼‰*/
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long Id;

    /* å®¢æˆ·åç§°ï¼ˆå…¬å¸åç§°ï¼‰ */
    private String name;

    /* å®¢æˆ·ä¿¡æ¯æ¥æº */
    private String source;

    /* å®¢æˆ·æ‰€å±è¡Œä¸š */
    private String industry;

    /* å®¢æˆ·çº§åˆ« */
    private String level;

    /* å®¢æˆ·è”ç³»åœ°å€ */
    private String address;

    /* å®¢æˆ·è”ç³»ç”µè¯ */
    private String phone;

    // å¯ä»¥å•ç‹¬é…ç½®çº§è”ä¿å­˜ã€åˆ é™¤ï¼Œè¿˜å¯ä»¥é…ç½®æ›´æ–°ç­‰æ“ä½œï¼Œä¹Ÿå¯ä»¥ç›´æ¥é…ç½®å…¨éƒ¨
    @OneToMany(mappedBy = "customer", cascade =CascadeType.ALL)
    private Set<LinkMan> linkManSet;
}
```

æµ‹è¯•

```java
@DataJpaTest
// DataJpaTestã€MybatisTest ä¼šé»˜è®¤ä½¿ç”¨å…¶æµ‹è¯•æ•°æ®æºæ›¿ä»£ï¼Œè‹¥è¦ä½¿ç”¨è‡ªå·±é…ç½®çš„ï¼Œéœ€è¦æ·»åŠ å¦‚ä¸‹æ³¨è§£
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
public class One2ManyTest {

    @Autowired
    private CustomerRepository customerRepository;

    @Autowired
    private LinkManRepository linkManRepository;

    /**
     * çº§è”æ·»åŠ ï¼Œä¿å­˜ä¸€ä¸ªå®¢æˆ·çš„åŒæ—¶ä¿å­˜è”ç³»äºº
     */
    @Test
    @Rollback(false)
    @Transactional
    void testCascadeSave() {
        Customer customer = Customer.builder().name("è…¾è®¯").linkManSet(new HashSet<>()).build();

        LinkMan linkMan = LinkMan.builder()
                .name("å°é©¬")
                .customer(customer)// åŒå‘å…³è”ï¼Œä»è¡¨ç»´æŠ¤å¤–é”®ï¼ˆè¿™ä¸ªæ˜¯ç»´æŠ¤å¤–é”®çš„ï¼Œå’Œçº§è”æ²¡æœ‰å…³ç³»ï¼ï¼ï¼ï¼‰
                .build();

        customer.getLinkManSet().add(linkMan);

        customerRepository.save(customer);
    }
    
    /**
     * çº§è”åˆ é™¤ï¼Œåˆ é™¤ä¸€ä¸ªå®¢æˆ·çš„åŒæ—¶åˆ é™¤æ­¤å®¢æˆ·çš„æ‰€æœ‰è”ç³»äººã€‚æ‰§è¡Œåˆ é™¤å‰è®°å¾—æŠŠ ddl-auto æ”¹ä¸º update
     */
    @Test
    @Rollback(false)
    @Transactional
    void testCascadeRemove() {
        customerRepository.deleteById(1L);
    }

}
```

çº§è”ä¿å­˜çš„sql

```sql
Hibernate: insert into customer (address, industry, level, name, phone, source) values (?, ?, ?, ?, ?, ?)
Hibernate: insert into link_man (cust_id, email, gender, mobile, name, phone, position, remark) values (?, ?, ?, ?, ?, ?, ?, ?)
```

çº§è”åˆ é™¤çš„sql

```sql
Hibernate: select customer0_.id as id1_1_0_, customer0_.address as address2_1_0_, customer0_.industry as industry3_1_0_, customer0_.level as level4_1_0_, customer0_.name as name5_1_0_, customer0_.phone as phone6_1_0_, customer0_.source as source7_1_0_ from customer customer0_ where customer0_.id=?
Hibernate: select linkmanset0_.cust_id as cust_id9_2_0_, linkmanset0_.id as id1_2_0_, linkmanset0_.id as id1_2_1_, linkmanset0_.cust_id as cust_id9_2_1_, linkmanset0_.email as email2_2_1_, linkmanset0_.gender as gender3_2_1_, linkmanset0_.mobile as mobile4_2_1_, linkmanset0_.name as name5_2_1_, linkmanset0_.phone as phone6_2_1_, linkmanset0_.position as position7_2_1_, linkmanset0_.remark as remark8_2_1_ from link_man linkmanset0_ where linkmanset0_.cust_id=?
Hibernate: delete from link_man where id=?
Hibernate: delete from customer where id=?
```









### æœ€ä½³å®è·µ ğŸ”¥

é…ç½®å¹¶ä½¿ç”¨å¤šçš„ä¸€æ–¹ç»´æŠ¤å…³è”å…³ç³»ï¼ˆå¤–é”®ï¼‰ï¼Œä¿å­˜æ—¶ç›´æ¥å¯¹å¤–é”®èµ‹å€¼ï¼›é…ç½®å¹¶ä½¿ç”¨ä¸€çš„ä¸€æ–¹ç»´æŠ¤å…³è”å…³ç³»ï¼Œè¿˜ä¼šæ‰§è¡Œ1æ¡updateè¯­å¥ï¼ˆå¤šä½™ï¼ï¼‰ã€‚æ‰€ä»¥ JPA åè®®æœ‰è§„å®šï¼š

-   è‹¥é…ç½®**å•å‘**å…³è”ï¼Œå…³è”å…³ç³»çš„ç»´æŠ¤ç›´æ¥**é…ç½®åœ¨æ‹¥æœ‰å¤–é”®çš„ä¸€æ–¹ï¼ˆä»è¡¨ï¼‰**å³å¯ã€‚æ‹‰å‹¾è¯¾ç¨‹æ¨èä½¿ç”¨å•å‘å…³è”ï¼Œä¸æ¨èåŒå‘å…³è”ï¼Œä¸»è¡¨æŸ¥è¯¢æ—¶ä½¿ç”¨ sqlæŸ¥è¯¢ã€‚
-   è‹¥é…ç½®**åŒå‘**å…³è”ï¼Œ**ç»´æŠ¤å…³è”å…³ç³»çš„æ˜¯æ‹¥æœ‰å¤–é”®çš„ä¸€æ–¹ï¼ˆä»è¡¨ï¼‰**ï¼Œè€Œ**å¦ä¸€æ–¹ï¼ˆä¸»è¡¨ï¼‰å¿…é¡»é…ç½® mappedBy æ”¾å¼ƒå¤–é”®ç»´æŠ¤**ï¼›

**å°½é‡é¿å…åŒå‘å…³è”ï¼Œå³åªç”¨ä¸€ä¸ªæ³¨è§£@ManyToOne**ã€‚[JPAä¸­çš„OneToManyå’ŒManyToOneçš„æœ€ä½³å®è·µ](http://www.wangzhenhua.rocks/zh-hans/java/jpa-one-to-many-many-to-one-best-practice)

ä¸€åˆ‡çº§è”æ›´æ–°å’Œ orphanRemoval éƒ½ä¿æŒé»˜è®¤è§„åˆ™ï¼Œå¹¶ä¸” fetch é‡‡ç”¨ lazy å»¶è¿ŸåŠ è½½ï¼ˆä¹Ÿæ˜¯é»˜è®¤è§„åˆ™ï¼‰ã€‚

æ³¨æ„ï¼š**æ”¾å¼ƒå¤–é”®ç»´æŠ¤å’Œçº§è”æ“ä½œæ²¡æœ‰åŠç‚¹å…³ç³»**





## å¤šå¯¹å¤š

### æ¡ˆä¾‹ä»‹ç»

ç”¨æˆ·å’Œè§’è‰²ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰ï¼Œä¸ç”¨å¤šé€¼é€¼äº†ï¼Œå°±æ˜¯ RBAC æ¨¡å‹



### åˆ†ææ­¥éª¤

1.  æ˜ç¡®è¡¨å…³ç³»ï¼šä¸€å¯¹å¤šå…³ç³»
2.  ç¡®å®šè¡¨å…³ç³»ï¼ˆä¸­é—´è¡¨ï¼‰
3.  ç¼–å†™å®ä½“ç±»ï¼Œå†å®ä½“ç±»ä¸­æè¿°è¡¨å…³ç³»ï¼ˆ**ç»„åˆ**ï¼‰
    -   ç”¨æˆ·ï¼šåŒ…å«è§’è‰²çš„é›†åˆ
    -   è§’è‰²ï¼šåŒ…å«ç”¨æˆ·çš„é›†åˆ
4.  é…ç½®æ˜ å°„å…³ç³»
    -   ä½¿ç”¨ **JPA æ³¨è§£é…ç½®ä¸€å¯¹å¤šæ˜ å°„å…³ç³»**



### @ManyToMany





### å®æˆ˜ï¼šä¿å­˜ã€æ”¾å¼ƒå¤–é”®ç»´æŠ¤

```java
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Entity
public class SysUser {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long userId;
    private String userName;
    private Integer age;


    @ManyToMany
    @JoinTable(name = "sys_user_role",
            joinColumns = @JoinColumn(name = "user_id"),
            inverseJoinColumns = @JoinColumn(name = "role_id"))
    private Set<SysRole> roles;
}
```

```java
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Entity
public class SysRole {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long roleId;
    private String roleName;

    // æ”¾å¼ƒä¸­é—´è¡¨ç»´æŠ¤æƒ
    @ManyToMany(mappedBy = "roles")
    private Set<SysUser> users;
}
```

```java
public interface SysUserRepository extends JpaRepository<SysUser,Long>, JpaSpecificationExecutor<SysUser> {
}
```

```java
public interface SysRoleRepository extends JpaRepository<SysRole,Long>, JpaSpecificationExecutor<SysRole> {
}
```

æµ‹è¯•

```java
@DataJpaTest
// DataJpaTestã€MybatisTest ä¼šé»˜è®¤ä½¿ç”¨å…¶æµ‹è¯•æ•°æ®æºæ›¿ä»£ï¼Œè‹¥è¦ä½¿ç”¨è‡ªå·±é…ç½®çš„ï¼Œéœ€è¦æ·»åŠ å¦‚ä¸‹æ³¨è§£
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
public class Many2ManyTest {

    @Autowired
    private SysUserRepository sysUserRepository;

    @Autowired
    private SysRoleRepository sysRoleRepository;


    /**
     * ä¿å­˜ä¸€ä¸ªç”¨æˆ·ã€ä¸€ä¸ªè§’è‰²
     */
    @Test
    @Rollback(false)
    @Transactional
    void testSave() {

        SysUser sysUser = SysUser.builder().userName("conanan").roles(new HashSet<>()).build();

        SysRole sysRole = SysRole.builder().roleName("æ¶æ„å¸ˆ").users(new HashSet<>()).build();

        // é…ç½®ç”¨æˆ·åˆ°è§’è‰²çš„å…³ç³»ï¼Œå¯ä»¥å¯¹ä¸­é—´è¡¨è¿›è¡Œç»´æŠ¤
        sysUser.getRoles().add(sysRole);
        // é…ç½®è§’è‰²åˆ°ç”¨æˆ·çš„å…³ç³»ï¼Œå¯ä»¥å¯¹ä¸­é—´è¡¨è¿›è¡Œç»´æŠ¤
        // sysRole.getUsers().add(sysUser);
        // ä½†æ˜¯ä¸èƒ½åŒæ—¶ç»´æŠ¤ï¼Œå› ä¸ºè”åˆä¸»é”®ä¸èƒ½é‡å¤ï¼
        // æŠ¥é”™ Caused by: java.sql.SQLIntegrityConstraintViolationException: Duplicate entry '1-1' for key 'sys_user_role.PRIMARY'
        // æ”¾å¼ƒè¢«é€‰æ‹©ä¸€æ–¹ï¼ˆå¦‚è§’è‰²ï¼‰çš„ä¸­é—´è¡¨ç»´æŠ¤æƒå³å¯ï¼

        sysUserRepository.save(sysUser);
        sysRoleRepository.save(sysRole);
    }
}
```

ç”Ÿæˆçš„sqlï¼š

```sql
create table sys_user_role (user_id bigint not null, role_id bigint not null, primary key (user_id, role_id)) engine=InnoDB
create table sys_role (role_id bigint not null auto_increment, role_name varchar(255), primary key (role_id)) engine=InnoDB
create table sys_user (user_id bigint not null auto_increment, age integer, user_name varchar(255), primary key (user_id)) engine=InnoDB

alter table sys_user_role add constraint FKhh52n8vd4ny9ff4x9fb8v65qx foreign key (role_id) references sys_role (role_id)
alter table sys_user_role add constraint FKb40xxfch70f5qnyfw8yme1n1s foreign key (user_id) references sys_user (user_id)

-- ä¿å­˜
insert into sys_user (age, user_name) values (?, ?)
insert into sys_role (role_name) values (?)
insert into sys_user_role (user_id, role_id) values (?, ?)
```

å¯è§ï¼Œ**ç›®å‰ç”Ÿæˆçš„å»ºè¡¨è¯­å¥ç«Ÿç„¶æœ‰5æ¡**ï¼Œæœ¬åº”è¯¥åªæœ‰3æ¡ï¼



### å®æˆ˜ï¼šçº§è” â˜ ï¸

é…ç½®åŒä¸€å¯¹å¤š

```java
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Entity
public class SysUser {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long userId;
    private String userName;
    private Integer age;


    @ManyToMany(cascade = CascadeType.ALL)
    @JoinTable(name = "sys_user_role",
            joinColumns = @JoinColumn(name = "user_id"),
            inverseJoinColumns = @JoinColumn(name = "role_id"))
    private Set<SysRole> roles;
}
```

æµ‹è¯•

```java
@DataJpaTest
// DataJpaTestã€MybatisTest ä¼šé»˜è®¤ä½¿ç”¨å…¶æµ‹è¯•æ•°æ®æºæ›¿ä»£ï¼Œè‹¥è¦ä½¿ç”¨è‡ªå·±é…ç½®çš„ï¼Œéœ€è¦æ·»åŠ å¦‚ä¸‹æ³¨è§£
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
public class Many2ManyTest {

    @Autowired
    private SysUserRepository sysUserRepository;

    @Autowired
    private SysRoleRepository sysRoleRepository;


    /**
     * ä¿å­˜ä¸€ä¸ªç”¨æˆ·ã€ä¸€ä¸ªè§’è‰²
     */
    @Test
    @Rollback(false)
    @Transactional
    void testSave() {

        SysUser sysUser = SysUser.builder().userName("conanan").roles(new HashSet<>()).build();

        SysRole sysRole = SysRole.builder().roleName("æ¶æ„å¸ˆ").users(new HashSet<>()).build();

        // é…ç½®ç”¨æˆ·åˆ°è§’è‰²çš„å…³ç³»ï¼Œå¯ä»¥å¯¹ä¸­é—´è¡¨è¿›è¡Œç»´æŠ¤
        sysUser.getRoles().add(sysRole);
        // é…ç½®è§’è‰²åˆ°ç”¨æˆ·çš„å…³ç³»ï¼Œå¯ä»¥å¯¹ä¸­é—´è¡¨è¿›è¡Œç»´æŠ¤
        // sysRole.getUsers().add(sysUser);
        // ä½†æ˜¯ä¸èƒ½åŒæ—¶ç»´æŠ¤ï¼Œå› ä¸ºè”åˆä¸»é”®ä¸èƒ½é‡å¤ï¼
        // æŠ¥é”™ Caused by: java.sql.SQLIntegrityConstraintViolationException: Duplicate entry '1-1' for key 'sys_user_role.PRIMARY'
        // æ”¾å¼ƒè¢«é€‰æ‹©ä¸€æ–¹ï¼ˆå¦‚è§’è‰²ï¼‰çš„ä¸­é—´è¡¨ç»´æŠ¤æƒå³å¯ï¼

        sysUserRepository.save(sysUser);
        sysRoleRepository.save(sysRole);
    }


    /**
     * æµ‹è¯•çº§è”æ·»åŠ ï¼ˆä¿å­˜ä¸€ä¸ªç”¨æˆ·åŒæ—¶ä¿å­˜ç”¨æˆ·ç›¸å…³è§’è‰²åŠä¸­é—´è¡¨å…³è”ä¿¡æ¯ï¼‰
     */
    @Test
    @Rollback(false)
    @Transactional
    void testCascadeAdd() {

        SysUser sysUser = SysUser.builder().userName("conanan").roles(new HashSet<>()).build();


        Optional<SysRole> byId = sysRoleRepository.findById(5L);

        SysRole sysRole = SysRole.builder().roleId(5L).users(new HashSet<>()).build();

        // é…ç½®ç”¨æˆ·åˆ°è§’è‰²çš„å…³ç³»ï¼Œå¯ä»¥å¯¹ä¸­é—´è¡¨è¿›è¡Œç»´æŠ¤ã€‚è‹¥è¿˜é…ç½®äº†çº§è”ï¼Œåˆ™è¿™é‡Œä¹Ÿç»´æŠ¤äº†çº§è”å…³ç³»
        sysUser.getRoles().add(byId.orElse(new SysRole()));
        // é…ç½®è§’è‰²åˆ°ç”¨æˆ·çš„å…³ç³»ï¼Œå¯ä»¥å¯¹ä¸­é—´è¡¨è¿›è¡Œç»´æŠ¤
        // sysRole.getUsers().add(sysUser);
        // ä½†æ˜¯ä¸èƒ½åŒæ—¶ç»´æŠ¤ï¼Œå› ä¸ºè”åˆä¸»é”®ä¸èƒ½é‡å¤ï¼
        // æŠ¥é”™ Caused by: java.sql.SQLIntegrityConstraintViolationException: Duplicate entry '1-1' for key 'sys_user_role.PRIMARY'
        // æ”¾å¼ƒè¢«é€‰æ‹©ä¸€æ–¹ï¼ˆå¦‚è§’è‰²ï¼‰çš„ä¸­é—´è¡¨ç»´æŠ¤æƒå³å¯ï¼

        sysUserRepository.save(sysUser);
    }

    /**
     * æµ‹è¯•çº§è”åˆ é™¤ï¼ˆåˆ é™¤ä¸€ä¸ªç”¨æˆ·åŒæ—¶åˆ é™¤ä¸­é—´è¡¨å…³è”ä¿¡æ¯åŠç”¨æˆ·ç›¸å…³è§’è‰²ï¼‰
     */
    @Test
    @Rollback(false)
    @Transactional
    void testCascadeRemove() {

        sysUserRepository.deleteById(5L);
    }
}
```

ä¿å­˜çš„sql

```sql
create table sys_user_role (user_id bigint not null, role_id bigint not null, primary key (user_id, role_id)) engine=InnoDB
create table sys_role (role_id bigint not null auto_increment, role_name varchar(255), primary key (role_id)) engine=InnoDB
create table sys_user (user_id bigint not null auto_increment, age integer, user_name varchar(255), primary key (user_id)) engine=InnoDB

alter table sys_user_role add constraint FKhh52n8vd4ny9ff4x9fb8v65qx foreign key (role_id) references sys_role (role_id)
alter table sys_user_role add constraint FKb40xxfch70f5qnyfw8yme1n1s foreign key (user_id) references sys_user (user_id)

-- ä¿å­˜
insert into sys_user (age, user_name) values (?, ?)
insert into sys_role (role_name) values (?)
insert into sys_user_role (user_id, role_id) values (?, ?)
```

å¯è§ï¼Œ**ç›®å‰ç”Ÿæˆçš„å»ºè¡¨è¯­å¥ç«Ÿç„¶æœ‰5æ¡**ï¼Œæœ¬åº”è¯¥åªæœ‰3æ¡ï¼å…¶ä½™çš„ä¸€æ¨¡ä¸€æ ·

çº§è”åˆ é™¤çš„sql

```sql
select sysuser0_.user_id as user_id1_5_0_, sysuser0_.age as age2_5_0_, sysuser0_.user_name as user_nam3_5_0_ from sys_user sysuser0_ where sysuser0_.user_id=?
select roles0_.user_id as user_id1_3_0_, roles0_.role_id as role_id2_3_0_, sysrole1_.role_id as role_id1_4_1_, sysrole1_.role_name as role_nam2_4_1_ from sys_user_role roles0_ inner join sys_role sysrole1_ on roles0_.role_id=sysrole1_.role_id where roles0_.user_id=?
delete from sys_user_role where user_id=?
delete from sys_role where role_id=?
delete from sys_user where user_id=?
```

æœ‰å¯èƒ½åˆ é™¤æŠ¥é”™ï¼å› ä¸ºåœ¨åˆ é™¤ä¸­é—´è¡¨åï¼Œåˆ é™¤è§’è‰²è¡¨æ—¶ï¼Œè¯¥è§’è‰²å¯èƒ½è¿˜è¢«å…¶ä»–ç”¨æˆ·å¼•ç”¨ï¼



## å¯¹è±¡å¯¼èˆªæŸ¥è¯¢ ğŸ”¥

å¯¹è±¡å¯¼èˆªæŸ¥è¯¢æ˜¯æ ¹æ®å·²ç»åŠ è½½çš„å¯¹è±¡ï¼Œå¯¼èˆªåˆ°ä»–çš„å…³è”å¯¹è±¡ã€‚å®ƒåˆ©ç”¨ç±»ä¸ç±»ä¹‹é—´çš„å…³ç³»æ¥æ£€ç´¢å¯¹è±¡ã€‚ä¾‹å¦‚ï¼šæˆ‘ä»¬é€šè¿‡IDæŸ¥è¯¢æ–¹å¼æŸ¥å‡ºä¸€ä¸ªå®¢æˆ·ï¼Œå¯ä»¥è°ƒç”¨Customerç±»ä¸­çš„getLinkMans()æ–¹æ³•æ¥è·å–è¯¥å®¢æˆ·çš„æ‰€æœ‰è”ç³»äººã€‚å¯¹è±¡å¯¼èˆªæŸ¥è¯¢çš„ä½¿ç”¨è¦æ±‚æ˜¯ï¼šä¸¤ä¸ªå¯¹è±¡ä¹‹é—´å¿…é¡»å­˜åœ¨å…³è”å…³ç³»ã€‚

å¯¹è±¡å¯¼èˆªæŸ¥è¯¢

-   **ä»ä¸€æ–¹æŸ¥è¯¢å¤šæ–¹ï¼šé»˜è®¤å»¶è¿ŸåŠ è½½**
-   **ä»å¤šæ–¹æŸ¥è¯¢ä¸€æ–¹ï¼šé»˜è®¤ç«‹å³åŠ è½½**

å¯ä»¥ä¿®æ”¹é…ç½®å°†å…¶æ”¹ä¸ºç«‹å³åŠ è½½ï¼ˆä¸æ¨èï¼ï¼‰ï¼Œ**fetché…ç½®åœ¨å¤šè¡¨å…³ç³»ä¸­ä¸»ä½“ï¼ˆæˆ–ä¸€æ–¹æˆ–å¤šæ–¹ï¼‰çš„æ³¨è§£ä¸Š**

ä¸€å¯¹å¤šä¸­çš„ä¾‹å­ï¼Œæ— éœ€ä»»ä½•ä¿®æ”¹

```java
@DataJpaTest
// DataJpaTestã€MybatisTest ä¼šé»˜è®¤ä½¿ç”¨å…¶æµ‹è¯•æ•°æ®æºæ›¿ä»£ï¼Œè‹¥è¦ä½¿ç”¨è‡ªå·±é…ç½®çš„ï¼Œéœ€è¦æ·»åŠ å¦‚ä¸‹æ³¨è§£
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
public class ObjectNavigationTest {

    @Autowired
    private CustomerRepository customerRepository;

    @Autowired
    private LinkManRepository linkManRepository;


    /**
     * å¯¹è±¡å¯¼èˆªæŸ¥è¯¢é»˜è®¤ä¹Ÿæ˜¯ä½¿ç”¨å»¶è¿ŸåŠ è½½ï¼Œä½¿ç”¨å…³è”å¯¹è±¡æ—¶æ‰æŸ¥è¯¢ï¼Œä»…ä»….è°ƒç”¨ä¸ä¼šæ‰§è¡ŒæŸ¥è¯¢
     */
    @Test
    void testSelect1() {
        Customer customer = customerRepository.getOne(1L);
        Set<LinkMan> linkManSet = customer.getLinkManSet();
        System.out.println(linkManSet);// æ­¤æ—¶æ‰æŸ¥è¯¢
    }
}
```

ä»ä¸€æ–¹æŸ¥è¯¢å¤šæ–¹ï¼šé»˜è®¤å»¶è¿ŸåŠ è½½

```sql
select * from customer customer0_ where customer0_.id=?
select * from link_man linkmanset0_ where linkmanset0_.cust_id=?
```

ä»å¤šæ–¹æŸ¥è¯¢ä¸€æ–¹ï¼šé»˜è®¤ç«‹å³åŠ è½½

```sql
SELECT 
 -- ç•¥æ‰å­—æ®µ
 *
FROM
	link_man linkman0_
	LEFT OUTER JOIN customer customer1_ ON linkman0_.cust_id = customer1_.id 
WHERE
	linkman0_.id =?
```





## æœªæ•´ç†

[JPAä¸­çš„OneToManyå’ŒManyToOneçš„æœ€ä½³å®è·µ](http://www.wangzhenhua.rocks/zh-hans/java/jpa-one-to-many-many-to-one-best-practice)ï¼Œè¿˜æœ‰ç¯‡åšå®¢



å¤ªå¤æ‚äº†ï¼ŒJPA å˜ç”¨è¾¹å†™å§ã€‚ã€‚ã€‚

