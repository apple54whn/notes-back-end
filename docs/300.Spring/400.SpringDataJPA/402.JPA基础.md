---
title: JPAçš„API
date: 2020-12-16 01:28:30
permalink: /pages/6849aa/
categories:
  - Spring
  - SpringDataJPA
tags:
  -
---

# JPA åŸºç¡€

## JPA ç¯å¢ƒå‡†å¤‡

### ç›®æ ‡

å®ç°åŠŸèƒ½æ˜¯æ­å»º JPA ç¯å¢ƒï¼Œå¹¶å®ç°ä¸€æ¡æ•°æ®çš„å¢åˆ æ”¹æŸ¥

### å‡†å¤‡æ•°æ®åº“ç¯å¢ƒ

```sql
-- å‡†å¤‡æ•°æ®åº“ï¼Œåˆ›å»ºä¸€å¼ æ–‡ç« è¡¨å¤‡ç”¨
CREATE TABLE `article` (
    `aid` INT ( 11 ) NOT NULL auto_increment COMMENT 'ä¸»é”®',
    `author` VARCHAR ( 255 ) DEFAULT NULL COMMENT 'ä½œè€…',
    `title` VARCHAR ( 255 ) DEFAULT NULL COMMENT 'æ ‡é¢˜',
    `createTime` datetime DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
    PRIMARY KEY ( `aid` )
);
```

### åˆ›å»º Maven å·¥ç¨‹

```xml
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>8.0.19</version>
</dependency>

<!--åŒ…æ‹¬ hibernate-core-->
<dependency>
    <groupId>org.hibernate</groupId>
    <artifactId>hibernate-entitymanager</artifactId>
    <version>5.4.25.Final</version>
</dependency>


<!--<dependency>-->
<!--    <groupId>log4j</groupId>-->
<!--    <artifactId>log4j</artifactId>-->
<!--    <version>1.2.17</version>-->
<!--</dependency>-->


<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
    <version>1.18.12</version>
</dependency>

<dependency>
    <groupId>org.junit.jupiter</groupId>
    <artifactId>junit-jupiter</artifactId>
    <version>5.6.2</version>
    <scope>test</scope>
</dependency>
```

å…¶ä½™çš„ JDK 8 ä¹‹ç±»çš„å‚è€ƒ Maven ç¬”è®°ï¼

### JPA çš„æ ¸å¿ƒé…ç½®æ–‡ä»¶

åœ¨ Maven å·¥ç¨‹çš„`resources`è·¯å¾„ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`META-INF`çš„æ–‡ä»¶å¤¹ï¼Œåœ¨æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º`persistence.xml`çš„é…ç½®æ–‡ä»¶ã€‚æ³¨æ„ï¼š`META-INF`æ–‡ä»¶å¤¹åç§°ä¸èƒ½ä¿®æ”¹ï¼Œ`persistence.xml`æ–‡ä»¶åç§°ä¸èƒ½æ”¹ã€‚

```xml
<?xml version="1.0" encoding="UTF-8"?>
<persistence xmlns="http://java.sun.com/xml/ns/persistence"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://java.sun.com/xml/ns/persistence
             http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"
             version="2.0">

    <!--æŒä¹…åŒ–å•å…ƒï¼Œå¯é…ç½®å¤šä¸ª
       name æŒä¹…åŒ–å•å…ƒçš„åç§° å”¯ä¸€
       transaction-type  äº‹åŠ¡ç±»å‹
            RESOURCE_LOCAL  æœ¬åœ°äº‹åŠ¡
            JTA   åˆ†å¸ƒå¼äº‹åŠ¡
    -->
    <persistence-unit name="jpa01" transaction-type="RESOURCE_LOCAL">

        <!--é…ç½® JPA è§„èŒƒçš„æœåŠ¡æä¾›å•†,å½“é¡¹ç›®ä¸­ä¾èµ–çš„åªæœ‰ä¸€ä¸ªJPAçš„å®ç°æ—¶ï¼ˆå¦‚ Hibernateï¼‰,æ­¤é€‰é¡¹å¯çœç•¥-->
        <provider>org.hibernate.jpa.HibernatePersistenceProvider</provider>

        <!--æŒ‡å®šå®ä½“ç±»,æ­¤é€‰é¡¹å¯çœç•¥-->
        <class>top.conanan.domain.Article</class>

        <properties>
            <!--è·Ÿæ•°æ®åº“ç›¸å…³çš„ä¿¡æ¯ é©±åŠ¨ url ç”¨æˆ·å å¯†ç ã€‚å¯ä» AvailableSettings ç±»ä¸­æ‰¾åˆ°nameçš„å€¼-->
            <property name="javax.persistence.jdbc.driver" value="com.mysql.cj.jdbc.Driver"/>
            <property name="javax.persistence.jdbc.url" value="jdbc:mysql:///demo?serverTimezone=GMT%2B8"/>
            <property name="javax.persistence.jdbc.user" value="root"/>
            <property name="javax.persistence.jdbc.password" value="w111111"/>

            <!--jpaçš„æ ¸å¿ƒé…ç½®ä¸­å…¼å®¹hibernateçš„é…ç½®ï¼ˆåªèƒ½ Hibernate ä½¿ç”¨ï¼‰-->
            <!--æ˜¯å¦æ˜¾ç¤ºSQL-->
            <property name="hibernate.show_sql" value="true"/>
            <!--æ˜¯å¦æ ¼å¼åŒ–æ˜¾ç¤ºçš„SQL-->
            <property name="hibernate.format_sql" value="true"/>
            <!--
                è‡ªåŠ¨å»ºè¡¨
                    update  å¦‚æœæ•°æ®åº“å­˜åœ¨æ•°æ®è¡¨,å°±ä½¿ç”¨;ä¸å­˜åœ¨,å°±åˆ›å»º
                    create  ä¸ç®¡æ•°æ®åº“æœ‰æ²¡æœ‰æ•°æ®è¡¨,æ¯æ¬¡SQLè¯·æ±‚éƒ½ä¼šé‡æ–°å»ºè¡¨
            -->
            <property name="hibernate.hbm2ddl.auto" value="update"/>
        </properties>
    </persistence-unit>
</persistence>

```

### é…ç½®å®ä½“ç±»ä¸è¡¨çš„æ˜ å°„å…³ç³»

```java
@Getter
@Setter
@ToString
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity // å‘Šè¯‰ JPA è¿™æ˜¯ä¸€ä¸ªå®ä½“ç±»ï¼Œéœ€è¦æŠŠå®ƒè·Ÿæ•°æ®åº“ä¸­çš„è¡¨åšæ˜ å°„
@Table(name = "article")//@Tableå»ºç«‹äº†å®ä½“ç±»å’Œæ•°æ®è¡¨çš„å…³ç³»ï¼ŒnameæŒ‡å‘è¡¨åã€‚å½“ç±»åå’Œæ•°æ®è¡¨çš„åä¸€è‡´æ—¶ï¼Œæ­¤æ³¨è§£å¯çœç•¥
public class Article {

    @Id//æ ‡è¯†è¿™æ˜¯ä¸»é”®å­—æ®µ
    //æŒ‡å®šä¸»é”®ç”Ÿæˆç­–ç•¥ï¼ŒGenerationType.IDENTITYå°±æ˜¯å¯¹åº”åˆ°mysqlä¸­çš„æ•°æ®è‡ªå¢ç­–ç•¥
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long aid;

    //ä½¿ç”¨@Columnæ˜ å°„ç±»çš„å±æ€§å’Œæ•°æ®è¡¨çš„å­—æ®µå…³ç³»  nameæŒ‡å®šè¡¨ä¸­çš„å­—æ®µå
    //å½“ç±»çš„å±æ€§åå’Œæ•°æ®è¡¨çš„å­—æ®µåä¸€è‡´æ—¶ï¼Œæ­¤æ³¨è§£å¯çœç•¥
    @Column(name = "author")
    private String author;

    private String title;

    private LocalDateTime createTime;
}
```

### å·¥å…·ç±» ğŸ”¥

```java
public final class JpaUtil {
    // JPAçš„å®ä½“ç®¡ç†å™¨å·¥å‚ï¼šç›¸å½“äºHibernateçš„SessionFactoryã€‚å·¥å‚ç±»çš„åˆ›å»ºååˆ†æ¶ˆè€—èµ„æºï¼Œä¸€èˆ¬åœ¨é¡¹ç›®ä¸­é…ç½®ä¸ºå•ä¾‹
    private static final EntityManagerFactory em;
    // ä½¿ç”¨é™æ€ä»£ç å—èµ‹å€¼
    static {
        // æ³¨æ„ï¼šè¯¥æ–¹æ³•å‚æ•°å¿…é¡»å’Œpersistence.xmlä¸­persistence-unitæ ‡ç­¾nameå±æ€§å–å€¼ä¸€è‡´
        em = Persistence.createEntityManagerFactory("jpa01");
    }

    /**
     * ä½¿ç”¨ç®¡ç†å™¨å·¥å‚ç”Ÿäº§ä¸€ä¸ªç®¡ç†å™¨å¯¹è±¡
     */
    public static EntityManager getEntityManager() {
        return em.createEntityManager();
    }
}
```



## JPA å¢åˆ æ”¹æŸ¥ ğŸ”¥

```java
/**
 * Jpaçš„æ“ä½œæ­¥éª¤
 * 1.åŠ è½½é…ç½®æ–‡ä»¶åˆ›å»ºå·¥å‚ï¼ˆå®ä½“ç®¡ç†å™¨å·¥å‚ï¼‰å¯¹è±¡ EntityManagerFactory
 * 2.é€šè¿‡å®ä½“ç®¡ç†å™¨å·¥å‚è·å–å®ä½“ç®¡ç†å™¨ EntityManager
 * 3.è·å–äº‹åŠ¡å¯¹è±¡ï¼Œå¼€å¯äº‹åŠ¡ EntityTransaction
 * 4.å®Œæˆå¢åˆ æ”¹æŸ¥æ“ä½œï¼ˆæŸ¥è¯¢ä¸éœ€è¦äº‹åŠ¡ï¼‰
 * 5.æäº¤äº‹åŠ¡ï¼ˆå›æ»šäº‹åŠ¡ï¼‰
 * 6.é‡Šæ”¾ EntityManager èµ„æº
 */
class TestJpa {

    private EntityManager entityManager;
    private EntityTransaction transaction;

    @BeforeEach
    void init() {
        //é€šè¿‡å·¥å…·ç±»è·å–EntityManagerå¯¹è±¡
        entityManager = JpaUtil.getEntityManager();
        //è·å–äº‹åŠ¡å¯¹è±¡ï¼Œæ ¹æ®éœ€è¦è°ƒç”¨ transaction.begin() å¼€å¯äº‹åŠ¡
        transaction = entityManager.getTransaction();
    }

    @AfterEach
    void destroy() {
        //é‡Šæ”¾èµ„æºï¼Œå·¥å‚å¯¹è±¡ä¸ç”¨é‡Šæ”¾ï¼Œå…¶ä»–æ–¹æ³•è¿˜éœ€è¦ä½¿ç”¨
        entityManager.close();
    }


    @Test
    void testPersist() {

        // åˆ›å»ºå¯¹è±¡
        Article article = Article.builder().author("ç”·å“¥").title("æµ‹è¯•æ–‡ç« ").createTime(LocalDateTime.now()).build();
        try {
            // å¼€å¯äº‹åŠ¡
            transaction.begin();
            // ä¿å­˜
            entityManager.persist(article);
            // æäº¤äº‹åŠ¡
            transaction.commit();
        } catch (Exception e) {
            e.printStackTrace();
            transaction.rollback();
        }
    }


    /**
     * findä¸ºç«‹å³åŠ è½½
     */
    @Test
    void testFind() {
        // ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè¦å°è£…çš„å¯¹è±¡çš„å­—èŠ‚ç ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºä¸»é”®
        Article article = entityManager.find(Article.class, 1L);
        System.out.println(article);
    }

    /**
     * getReferenceä¸ºå»¶è¿ŸåŠ è½½ï¼ˆæ‡’åŠ è½½ï¼‰ï¼Œä½¿ç”¨çš„æ—¶å€™æ‰æŸ¥è¯¢æ•°æ®åº“ã€‚ä¸€èˆ¬ä½¿ç”¨è¿™ä¸ªï¼ˆåºåˆ—åŒ–æ—¶å¯èƒ½æŠ¥é”™ï¼Ÿï¼‰
     * IDEAéœ€è¦å»æ‰Debugä¸­å‡ ä¸ªé€‰é¡¹æ‰å¯ä»¥çœ‹åˆ°
     */
    @Test
    void testReference() {
        Article article = entityManager.getReference(Article.class, 1L);
        System.out.println(article);
    }

    @Test
    void testMerge() {
        Article article = entityManager.find(Article.class, 3L);
        article.setAuthor("ç”·ç¥");
        try {
            // å¼€å¯äº‹åŠ¡
            transaction.begin();
            // æ›´æ–°ï¼ˆæ³¨æ„ï¼Œå®ä½“ç±»ä¸­å½“å‰ä¸ºnullçš„å­—æ®µä¹Ÿä¼šè¢«æ›´æ–°ä¸ºnullï¼Œå¯ä»¥é…ç½®æ›´æ”¹è¯¥ç­–ç•¥ï¼‰
            entityManager.merge(article);
            // æäº¤äº‹åŠ¡
            transaction.commit();
        } catch (Exception e) {
            e.printStackTrace();
            transaction.rollback();
        }
    }

    @Test
    void testRemove() {
        Article article = entityManager.find(Article.class, 3L);
        try {
            // å¼€å¯äº‹åŠ¡
            transaction.begin();
            // åˆ é™¤
            entityManager.remove(article);
            // æäº¤äº‹åŠ¡
            transaction.commit();
        } catch (Exception e) {
            e.printStackTrace();
            transaction.rollback();
        }
    }
}
```











## JPQL å¢åˆ æ”¹æŸ¥ ğŸ”¥

æ­¤å¤„ç¤ºä¾‹åªæ¼”ç¤ºæŸ¥è¯¢

JPQLï¼ˆJava Persistence Query Languageï¼‰ã€‚åŸºäºé¦–æ¬¡åœ¨EJB2.0ä¸­å¼•å…¥çš„EJBæŸ¥è¯¢è¯­è¨€(EJB QL)ï¼ŒJavaæŒä¹…åŒ–æŸ¥è¯¢è¯­è¨€(JPQL)æ˜¯ä¸€ç§å¯ç§»æ¤çš„æŸ¥è¯¢è¯­è¨€ï¼Œæ—¨åœ¨ä»¥é¢å‘å¯¹è±¡è¡¨è¾¾å¼è¯­è¨€çš„è¡¨è¾¾å¼ï¼Œå°†SQLè¯­æ³•å’Œç®€å•æŸ¥è¯¢è¯­ä¹‰ç»‘å®šåœ¨ä¸€èµ·ï¼Œä½¿ç”¨è¿™ç§è¯­è¨€ç¼–å†™çš„æŸ¥è¯¢æ˜¯å¯ç§»æ¤çš„ï¼Œå¯ä»¥è¢«ç¼–è¯‘æˆæ‰€æœ‰ä¸»æµæ•°æ®åº“æœåŠ¡å™¨ä¸Šçš„SQLã€‚é¿å…äº†ç¨‹åºä¸æ•°æ®åº“ SQL è¯­å¥è€¦åˆä¸¥é‡ï¼Œæ¯”è¾ƒé€‚åˆè·¨æ•°æ®æºçš„åœºæ™¯ï¼ˆä¸€ä¼šå„¿ MySQLï¼Œä¸€ä¼šå„¿ Oracle ç­‰ï¼‰

å…¶ç‰¹å¾ä¸åŸç”ŸSQLè¯­å¥ç±»ä¼¼ï¼Œå¹¶ä¸”å®Œå…¨**é¢å‘å¯¹è±¡**ï¼Œé€šè¿‡**ç±»å**å’Œ**å±æ€§**è®¿é—®ï¼Œè€Œ**ä¸æ˜¯è¡¨åå’Œè¡¨ä¸­å­—æ®µ**ã€‚ä¸æ”¯æŒ`SELECT *`ï¼Œä½†æ˜¯æ”¯æŒ`COUNT(*)`

```java
/**
 * Jpaçš„æ“ä½œæ­¥éª¤
 * 1.åŠ è½½é…ç½®æ–‡ä»¶åˆ›å»ºå·¥å‚ï¼ˆå®ä½“ç®¡ç†å™¨å·¥å‚ï¼‰å¯¹è±¡ EntityManagerFactory
 * 2.é€šè¿‡å®ä½“ç®¡ç†å™¨å·¥å‚è·å–å®ä½“ç®¡ç†å™¨ EntityManager
 * 3.è·å–äº‹åŠ¡å¯¹è±¡ï¼Œå¼€å¯äº‹åŠ¡ EntityTransaction
 * 4.å®Œæˆå¢åˆ æ”¹æŸ¥æ“ä½œï¼ˆæŸ¥è¯¢ä¸éœ€è¦äº‹åŠ¡ï¼‰
 * 5.æäº¤äº‹åŠ¡ï¼ˆå›æ»šäº‹åŠ¡ï¼‰
 * 6.é‡Šæ”¾ EntityManager èµ„æº
 */
class TestJpql {

    private EntityManager entityManager;
    private EntityTransaction transaction;

    @BeforeEach
    void init() {
        //é€šè¿‡å·¥å…·ç±»è·å–EntityManagerå¯¹è±¡
        entityManager = JpaUtil.getEntityManager();
        //è·å–äº‹åŠ¡å¯¹è±¡ï¼Œæ ¹æ®éœ€è¦è°ƒç”¨ transaction.begin() å¼€å¯äº‹åŠ¡
        transaction = entityManager.getTransaction();
    }

    @AfterEach
    void destroy() {
        //é‡Šæ”¾èµ„æºï¼Œå·¥å‚å¯¹è±¡ä¸ç”¨é‡Šæ”¾ï¼Œå…¶ä»–æ–¹æ³•è¿˜éœ€è¦ä½¿ç”¨
        entityManager.close();
    }


    /**
     * æŸ¥æ‰¾æ‰€æœ‰
     */
    @Test
    void testFindAll() {
        String jpql = "from Article";//ä¹Ÿå¯ä»¥çœç•¥æ‰å…¨é™å®šç±»åï¼Œåªå†™ç±»å
        //åˆ›å»ºQueryæŸ¥è¯¢å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ‰æ˜¯æ‰§è¡Œjpqlçš„å¯¹è±¡
        TypedQuery<Article> query = entityManager.createQuery(jpql, Article.class);
        List<Article> articles = query.getResultList();
        articles.forEach(System.out::println);
    }

    /**
     * æ’åºæŸ¥è¯¢ï¼ˆæ ¹æ®IDå€’åºæŸ¥è¯¢æ‰€æœ‰æ–‡ç« ï¼‰
     */
    @Test
    void testOrder() {
        String jpql = "from Article order by aid desc";//ä¹Ÿå¯ä»¥çœç•¥æ‰å…¨é™å®šç±»åï¼Œåªå†™ç±»åã€‚è¿™é‡Œçš„aidä¹Ÿå¯ä»¥å†™idï¼Œå› ä¸ºæ˜¯@Idæ³¨è§£äº†
        //åˆ›å»ºQueryæŸ¥è¯¢å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ‰æ˜¯æ‰§è¡Œjpqlçš„å¯¹è±¡
        TypedQuery<Article> query = entityManager.createQuery(jpql, Article.class);

        List<Article> articles = query.getResultList();
        articles.forEach(System.out::println);
    }

    /**
     * ç»Ÿè®¡æŸ¥è¯¢
     */
    @Test
    void testCount() {
        String jpql = "select count(id) from Article ";//ä¹Ÿå¯ä»¥çœç•¥æ‰å…¨é™å®šç±»åï¼Œåªå†™ç±»å
        //åˆ›å»ºQueryæŸ¥è¯¢å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ‰æ˜¯æ‰§è¡Œjpqlçš„å¯¹è±¡
        TypedQuery<Long> query = entityManager.createQuery(jpql, Long.class);
        Long count = query.getSingleResult();
        System.out.println(count);
    }

    /**
     * åˆ†é¡µæŸ¥è¯¢
     */
    @Test
    void testPage() {
        String jpql = "from Article ";//ä¹Ÿå¯ä»¥çœç•¥æ‰å…¨é™å®šç±»åï¼Œåªå†™ç±»å
        //åˆ›å»ºQueryæŸ¥è¯¢å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ‰æ˜¯æ‰§è¡Œjpqlçš„å¯¹è±¡
        TypedQuery<Article> query = entityManager.createQuery(jpql, Article.class);
        query.setFirstResult(0);//èµ·å§‹ç´¢å¼•
        query.setMaxResults(5);//æ¯é¡µæŸ¥è¯¢æ¡æ•°
        List<Article> articles = query.getResultList();//æ­¤å¤„ä¸ºæŸ¥è¯¢å‰5æ¡
        articles.forEach(System.out::println);
    }

    /**
     * æ¡ä»¶æŸ¥è¯¢
     */
    @Test
    void testCondition() {
        String jpql = "from Article where author like ?2";//ä¹Ÿå¯ä»¥çœç•¥æ‰å…¨é™å®šç±»åï¼Œåªå†™ç±»å
        //åˆ›å»ºQueryæŸ¥è¯¢å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ‰æ˜¯æ‰§è¡Œjpqlçš„å¯¹è±¡
        TypedQuery<Article> query = entityManager.createQuery(jpql, Article.class);
        query.setParameter(2, "å¥³%");//ç¬¬1ä¸ªå‚æ•°ï¼šå ä½ç¬¦ç´¢å¼•ä½ç½®ï¼Œæ ¹æ®?nå†™å³å¯ï¼›ç¬¬2ä¸ªå‚æ•°ï¼šå€¼
        List<Article> articles = query.getResultList();
        articles.forEach(System.out::println);
    }
}
```





## æ³¨æ„

### find ä¸ getReference åŒºåˆ«

*   findï¼š**ç«‹å³åŠ è½½**ã€‚debugæ‰§è¡Œå‘ç°è°ƒç”¨æ–¹æ³•åå°±ä¼šå‘é€sqlæŸ¥è¯¢æ•°æ®åº“ï¼Œä¸”æŸ¥è¯¢å¾—åˆ°çš„å¯¹è±¡å°±æ˜¯è¯¥**å¯¹è±¡æœ¬èº«**

*   getReferenceï¼š**å»¶è¿ŸåŠ è½½ï¼ˆæ‡’åŠ è½½ï¼‰**ã€‚debugæ‰§è¡Œå‘ç°è°ƒç”¨æ–¹æ³•å**ä¸ä¼šç«‹å³æŸ¥è¯¢æ•°æ®åº“**ï¼Œåªä¼šåœ¨**ä½¿ç”¨è¯¥å¯¹è±¡æ—¶æ‰å‘é€sqlæŸ¥è¯¢æ•°æ®åº“**ï¼Œå¹¶ä¸”æŸ¥è¯¢**å¾—åˆ°çš„å¯¹è±¡æ˜¯åŠ¨æ€ä»£ç†ç”Ÿæˆçš„**å¯¹è±¡ï¼

æ³¨æ„ï¼ŒIDEAæ¯”è¾ƒæ™ºèƒ½ï¼Œè°ƒç”¨æ–¹æ³•ådebugä¼šæ˜¾ç¤ºå€¼ï¼Œæ‰€ä»¥ä¼šç«‹å³å‘é€sqlã€‚å¯ä»¥ä¿®æ”¹è®¾ç½®ä¸­çš„ Debugger - Data Views - Java ä¸­çš„é…ç½®ï¼Œå»æ‰æ‰€æœ‰é€‰é¡¹åŸºæœ¬å°±å¯ä»¥äº†





## JPA é‡è¦ API ä»‹ç»

### Persistence

`Persistence`å¯¹è±¡ä¸»è¦ä½œç”¨æ˜¯ç”¨äº**è·å–**`EntityManagerFactory`å¯¹è±¡çš„ ã€‚é€šè¿‡è°ƒç”¨è¯¥ç±»çš„`createEntityManagerFactory()`é™æ€æ–¹æ³•ï¼Œæ ¹æ®é…ç½®æ–‡ä»¶ä¸­**æŒä¹…åŒ–å•å…ƒåç§°**åˆ›å»º`EntityManagerFactory`ã€‚



### EntityManagerFactory ğŸ”¥

`EntityManagerFactory` æ¥å£ä¸»è¦ç”¨`createEntityManager()`æ¥åˆ›å»º `EntityManager` å®ä¾‹ï¼Œç”±äºå®ƒæ˜¯ä¸€ä¸ª**çº¿ç¨‹å®‰å…¨**çš„å¯¹è±¡ï¼ˆå³å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªè¯¥å¯¹è±¡ä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼‰

å…¶å†…éƒ¨ç»´æŠ¤äº†å¾ˆå¤šå†…å®¹ï¼š

*   æ•°æ®åº“ä¿¡æ¯
*   ç¼“å­˜ä¿¡æ¯
*   æ‰€æœ‰çš„å®ä½“ç®¡ç†å™¨å¯¹è±¡

å› æ­¤åˆ›å»º`EntityManagerFactory` æå…¶**æµªè´¹èµ„æº**ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ JPA ç¼–ç¨‹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹å…¶åˆ›å»ºè¿›è¡Œä¼˜åŒ–ï¼ˆå®ƒæ˜¯**çº¿ç¨‹å®‰å…¨**çš„ï¼‰ï¼Œåªéœ€è¦åšåˆ°**ä¸€ä¸ªå·¥ç¨‹åªå­˜åœ¨ä¸€ä¸ª`EntityManagerFactory` ï¼Œå³åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºå¥½**



### EntityManager ğŸ”¥

åœ¨ JPA è§„èŒƒä¸­, `EntityManager`æ˜¯**å®ŒæˆæŒä¹…åŒ–æ“ä½œçš„æ ¸å¿ƒå¯¹è±¡**ã€‚å®ä½“ç±»ä½œä¸ºæ™®é€š Java å¯¹è±¡ï¼Œåªæœ‰åœ¨è°ƒç”¨`EntityManager`å°†å…¶æŒä¹…åŒ–åæ‰ä¼šå˜æˆæŒä¹…åŒ–å¯¹è±¡ã€‚**EntityManager å¯¹è±¡åœ¨ä¸€ç»„å®ä½“ç±»ä¸åº•å±‚æ•°æ®æºä¹‹é—´è¿›è¡Œ O/R æ˜ å°„çš„ç®¡ç†**ã€‚å®ƒå¯ä»¥ç”¨æ¥ç®¡ç†å’Œæ›´æ–° Entity Bean, æ ¹æ¤ä¸»é”®æŸ¥æ‰¾ Entity Bean, è¿˜å¯ä»¥é€šè¿‡ JPQL è¯­å¥æŸ¥è¯¢å®ä½“ç­‰ã€‚

å…¶å†…éƒ¨ç»´æŠ¤äº†

æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨`EntityManager`çš„æ–¹æ³•å®Œæˆ**è·å–äº‹åŠ¡**ï¼Œä»¥åŠ**æŒä¹…åŒ–æ•°æ®åº“**çš„æ“ä½œ

- `getTransaction` : è·å–äº‹åŠ¡å¯¹è±¡
- `persist` ï¼š ä¿å­˜æ“ä½œ
- `find/getReference` ï¼š æ ¹æ® id æŸ¥è¯¢
- `merge` ï¼š æ›´æ–°æ“ä½œ
- `remove` ï¼š åˆ é™¤æ“ä½œ



### EntityTransaction

åœ¨ JPA è§„èŒƒä¸­ EntityTransaction æ˜¯**å®Œæˆäº‹åŠ¡æ“ä½œçš„æ ¸å¿ƒå¯¹è±¡**ï¼Œå¯¹äº EntityTransaction åœ¨æˆ‘ä»¬çš„ Java ä»£ç ä¸­æ‰¿æ¥çš„åŠŸèƒ½æ¯”è¾ƒç®€å•

- `begin`ï¼šå¼€å¯äº‹åŠ¡
- `commit`ï¼šæäº¤äº‹åŠ¡
- `rollback`ï¼šå›æ»šäº‹åŠ¡





## JPA å¸¸ç”¨æ³¨è§£

### @Entity

ä½œç”¨ï¼šæŒ‡å®šå½“å‰ç±»æ˜¯**å®ä½“ç±»**ã€‚



### @Table

ä½œç”¨ï¼šæŒ‡å®š**å®ä½“ç±»å’Œè¡¨ä¹‹é—´çš„å¯¹åº”å…³ç³»**ã€‚

å±æ€§ï¼š

-   `name`ï¼šæŒ‡å®šæ•°æ®åº“**è¡¨çš„åç§°**ï¼Œä¸æŒ‡å®šåˆ™ä¸ºç±»åé¦–å­—æ¯å°å†™



### @Id

ä½œç”¨ï¼šæŒ‡å®šå½“å‰å­—æ®µæ˜¯**ä¸»é”®**ã€‚



### @GeneratedValue

ä½œç”¨ï¼šæŒ‡å®š**ä¸»é”®çš„ç”Ÿæˆç­–ç•¥**ã€‚

å±æ€§ï¼š

-   `strategy`ï¼šæŒ‡å®šä¸»é”®ç”Ÿæˆç­–ç•¥ã€‚JPAæä¾›çš„å››ç§æ ‡å‡†ç”¨æ³•ä¸º`TABLE`,`SEQUENCE`,`IDENTITY`,`AUTO`ã€‚

`strategy` å€¼ä»‹ç»ï¼š

-   `IDENTITY`ï¼šä¸»é”®ç”±æ•°æ®åº“**è‡ªåŠ¨ç”Ÿæˆ**ï¼ˆä¸»è¦æ˜¯è‡ªåŠ¨å¢é•¿å‹ï¼Œå¿…é¡»æ•°æ®åº“åº•å±‚æ”¯æŒï¼Œå¦‚MySQLï¼‰

    ```java
    @Id  
    @GeneratedValue(strategy = GenerationType.IDENTITY) 
    private Long custId;
    ```

-   **`SEQUENCE`**ï¼šæ ¹æ®åº•å±‚æ•°æ®åº“çš„**åºåˆ—**æ¥ç”Ÿæˆä¸»é”®ï¼Œæ¡ä»¶æ˜¯æ•°æ®åº“æ”¯æŒåºåˆ—ï¼Œå¦‚Oracleã€‚

    ```java
    @Id  
    @GeneratedValue(strategy = GenerationType.SEQUENCE,generator="payablemoney_seq")  
    @SequenceGenerator(name="payablemoney_seq", sequenceName="seq_payment")  
    private Long custId;
    ```

    ```java
    //@SequenceGeneratoræºç ä¸­çš„å®šä¹‰
    @Target({TYPE, METHOD, FIELD})   
    @Retention(RUNTIME)  
    public @interface SequenceGenerator {  
        //è¡¨ç¤ºè¯¥è¡¨ä¸»é”®ç”Ÿæˆç­–ç•¥çš„åç§°ï¼Œå®ƒè¢«å¼•ç”¨åœ¨@GeneratedValueä¸­è®¾ç½®çš„â€œgeneratorâ€å€¼ä¸­
        String name();  
        //å±æ€§è¡¨ç¤ºç”Ÿæˆç­–ç•¥ç”¨åˆ°çš„æ•°æ®åº“åºåˆ—åç§°ã€‚
        String sequenceName() default "";  
        //è¡¨ç¤ºä¸»é”®åˆè¯†å€¼ï¼Œé»˜è®¤ä¸º0
        int initialValue() default 0;  
        //è¡¨ç¤ºæ¯æ¬¡ä¸»é”®å€¼å¢åŠ çš„å¤§å°ï¼Œä¾‹å¦‚è®¾ç½®1ï¼Œåˆ™è¡¨ç¤ºæ¯æ¬¡æ’å…¥æ–°è®°å½•åè‡ªåŠ¨åŠ 1ï¼Œé»˜è®¤ä¸º50
        int allocationSize() default 50;  
    }
    ```

-   `TABLE`ï¼šä½¿ç”¨ä¸€ä¸ªç‰¹å®šçš„æ•°æ®åº“è¡¨æ ¼æ¥ä¿å­˜ä¸»é”®ï¼ˆå¥½éº»çƒ¦ã€‚ã€‚ã€‚ï¼‰

    ```java
    @Id  
    @GeneratedValue(strategy = GenerationType.TABLE, generator="payablemoney_gen")  
    @TableGenerator(name = "pk_gen",  
                    table="tb_generator",  
                    pkColumnName="gen_name",  
                    valueColumnName="gen_value",  
                    pkColumnValue="PAYABLEMOENY_PK",  
                    allocationSize=1  
                   ) 
    private Long custId;
    ```

    ```java
    //@TableGeneratorçš„å®šä¹‰ï¼š
    @Target({TYPE, METHOD, FIELD})   
    @Retention(RUNTIME)  
    public @interface TableGenerator {  
        //è¡¨ç¤ºè¯¥è¡¨ä¸»é”®ç”Ÿæˆç­–ç•¥çš„åç§°ï¼Œå®ƒè¢«å¼•ç”¨åœ¨@GeneratedValueä¸­è®¾ç½®çš„â€œgeneratorâ€å€¼ä¸­
        String name();  
        //è¡¨ç¤ºè¡¨ç”Ÿæˆç­–ç•¥æ‰€æŒä¹…åŒ–çš„è¡¨åï¼Œä¾‹å¦‚ï¼Œè¿™é‡Œè¡¨ä½¿ç”¨çš„æ˜¯æ•°æ®åº“ä¸­çš„â€œtb_generatorâ€ã€‚
        String table() default "";  
        //catalogå’Œschemaå…·ä½“æŒ‡å®šè¡¨æ‰€åœ¨çš„ç›®å½•åæˆ–æ˜¯æ•°æ®åº“å
        String catalog() default "";  
        String schema() default "";  
        //å±æ€§çš„å€¼è¡¨ç¤ºåœ¨æŒä¹…åŒ–è¡¨ä¸­ï¼Œè¯¥ä¸»é”®ç”Ÿæˆç­–ç•¥æ‰€å¯¹åº”é”®å€¼çš„åç§°ã€‚ä¾‹å¦‚åœ¨â€œtb_generatorâ€ä¸­å°†â€œgen_nameâ€ä½œä¸ºä¸»é”®çš„é”®å€¼
        String pkColumnName() default "";  
        //å±æ€§çš„å€¼è¡¨ç¤ºåœ¨æŒä¹…åŒ–è¡¨ä¸­ï¼Œè¯¥ä¸»é”®å½“å‰æ‰€ç”Ÿæˆçš„å€¼ï¼Œå®ƒçš„å€¼å°†ä¼šéšç€æ¯æ¬¡åˆ›å»ºç´¯åŠ ã€‚ä¾‹å¦‚ï¼Œåœ¨â€œtb_generatorâ€ä¸­å°†â€œgen_valueâ€ä½œä¸ºä¸»é”®çš„å€¼ 
        String valueColumnName() default "";  
        //å±æ€§çš„å€¼è¡¨ç¤ºåœ¨æŒä¹…åŒ–è¡¨ä¸­ï¼Œè¯¥ç”Ÿæˆç­–ç•¥æ‰€å¯¹åº”çš„ä¸»é”®ã€‚ä¾‹å¦‚åœ¨â€œtb_generatorâ€è¡¨ä¸­ï¼Œå°†â€œgen_nameâ€çš„å€¼ä¸ºâ€œCUSTOMER_PKâ€ã€‚ 
        String pkColumnValue() default "";  
        //è¡¨ç¤ºä¸»é”®åˆè¯†å€¼ï¼Œé»˜è®¤ä¸º0ã€‚ 
        int initialValue() default 0;  
        //è¡¨ç¤ºæ¯æ¬¡ä¸»é”®å€¼å¢åŠ çš„å¤§å°ï¼Œä¾‹å¦‚è®¾ç½®æˆ1ï¼Œåˆ™è¡¨ç¤ºæ¯æ¬¡åˆ›å»ºæ–°è®°å½•åè‡ªåŠ¨åŠ 1ï¼Œé»˜è®¤ä¸º50ã€‚
        int allocationSize() default 50;  
        UniqueConstraint[] uniqueConstraints() default {};  
    } 
    /*==================================================================*/
    //è¿™é‡Œåº”ç”¨è¡¨tb_generatorï¼Œå®šä¹‰ä¸º ï¼š
    CREATE TABLE  tb_generator (  
        id NUMBER NOT NULL,  
        gen_name VARCHAR2(255) NOT NULL,  
        gen_value NUMBER NOT NULL,  
        PRIMARY KEY(id)  
    )
    ```

-   `AUTO`ï¼šä¸»é”®ç”±ç¨‹åºè‡ªåŠ¨æ§åˆ¶ï¼Œå¦‚æ•°æ®åº“ï¼Œç¯å¢ƒç­‰ï¼ˆæµ‹è¯•äº†ä¸‹MySQLä½¿ç”¨çš„æ˜¯TABLEï¼‰

    ```java
    @Id  
    @GeneratedValue(strategy = GenerationType.AUTO)  
    private Long custId;
    ```





### @Column

ä½œç”¨ï¼šæŒ‡å®šå®ä½“ç±»å±æ€§å’Œæ•°æ®åº“è¡¨ä¹‹é—´çš„å¯¹åº”å…³ç³»

å±æ€§ï¼š

-   `name`ï¼šæŒ‡å®šæ•°æ®åº“è¡¨çš„åˆ—åç§°ã€‚ä¸æŒ‡å®šåˆ™ä¸ºå±æ€§å
-   `unique`ï¼šæ˜¯å¦å”¯ä¸€
-   `nullable`ï¼šæ˜¯å¦å¯ä»¥ä¸ºç©º
-   `inserttable`ï¼šæ˜¯å¦å¯ä»¥æ’å…¥
-   `updateable`ï¼šæ˜¯å¦å¯ä»¥æ›´æ–°
-   `columnDefinition`: å®šä¹‰å»ºè¡¨æ—¶åˆ›å»ºæ­¤åˆ—çš„DDL
-   `secondaryTable`: ä»è¡¨åã€‚å¦‚æœæ­¤åˆ—ä¸å»ºåœ¨ä¸»è¡¨ä¸Šï¼ˆé»˜è®¤å»ºåœ¨ä¸»è¡¨ï¼‰ï¼Œè¯¥å±æ€§å®šä¹‰è¯¥åˆ—æ‰€åœ¨ä»è¡¨çš„åå­—æ­å»ºå¼€å‘ç¯å¢ƒğŸ”¥





