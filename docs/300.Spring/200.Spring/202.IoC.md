---
title: 2 IoC
date: 2020-12-16 01:25:37
permalink: /pages/ded8b8/
categories:
  - Spring
  - Spring
tags:
  - 
---
# IoC

## é—®é¢˜â€”ç¨‹åºé—´è€¦åˆ

- åœ¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼Œè€¦åˆæŒ‡çš„å°±æ˜¯å°±æ˜¯**å¯¹è±¡ä¹‹é—´çš„ä¾èµ–æ€§**ã€‚å¯¹è±¡ä¹‹é—´çš„è€¦åˆè¶Šé«˜ï¼Œç»´æŠ¤æˆæœ¬è¶Šé«˜ã€‚å› æ­¤å¯¹è±¡çš„è®¾è®¡åº”ä½¿ç±»å’Œæ„ä»¶ä¹‹é—´çš„è€¦åˆæœ€å°ã€‚è½¯ä»¶è®¾è®¡ä¸­é€šå¸¸ç”¨è€¦åˆåº¦å’Œå†…èšåº¦ä½œä¸ºè¡¡é‡æ¨¡å—ç‹¬ç«‹ç¨‹åº¦çš„æ ‡å‡†ã€‚**åˆ’åˆ†æ¨¡å—çš„ä¸€ä¸ªå‡†åˆ™**å°±æ˜¯**é«˜å†…èšä½è€¦åˆ**ã€‚

- **Bean**ï¼šè®¡ç®—æœºè‹±è¯­ä¸­ï¼Œæœ‰**å¯é‡ç”¨ç»„ä»¶**çš„å«ä¹‰

    JavaBeanï¼šç”¨**Javaè¯­è¨€ç¼–å†™çš„å¯é‡ç”¨ç»„ä»¶**ã€‚JavaBean>å®ä½“ç±»

- å®é™…å¼€å‘ä¸­ï¼Œåº”åšåˆ°ï¼š**ç¼–è¯‘æœŸä¸ä¾èµ–ï¼Œè¿è¡Œæ—¶æ‰ä¾èµ–ï¼ˆæƒ³åˆ°å¤šæ€äº†å§ï¼Œåªæ˜¯ç±»ä¼¼ï¼‰**

- **è§£è€¦çš„æ€è·¯ï¼ˆå·¥å‚æ¨¡å¼ï¼‰**ï¼š

    1. **è¯»å–é…ç½®æ–‡ä»¶çš„key**è·å–è¦åˆ›å»ºå¯¹è±¡çš„**å…¨é™å®šç±»åvalue**ï¼›
    2. ä½¿ç”¨**åå°„åˆ›å»ºå¯¹è±¡**ï¼Œé¿å…ä½¿ç”¨newå…³é”®å­—ï¼›
    3. å®šä¹‰ä¸€ä¸ªmap**å®¹å™¨**ï¼Œåœ¨é™æ€ä»£ç å—ä¸­åˆ›å»ºæ‰€æœ‰å¯¹è±¡å¹¶å­˜æ”¾ã€‚è·å–å¯¹è±¡æ—¶ç›´æ¥è¿”å›å¯¹åº”keyçš„valueï¼Œæ˜¯å•ä¾‹çš„



## OCPâ€”å¼€é—­åŸåˆ™

### awkward ç‰ˆ

```java
/**
 * é’å†ˆå½±
 */
public class Camille {

    public void q(){
        System.out.println("Camille Q");
    }

    public void w(){
        System.out.println("Camille W");
    }

    public void e(){
        System.out.println("Camille E");
    }

    public void r(){
        System.out.println("Camille R");
    }
}
```

```java
/**
 * é»›å®‰å¨œ
 */
public class Diana {

    public void q(){
        System.out.println("Diana Q");
    }

    public void w(){
        System.out.println("Diana W");
    }

    public void e(){
        System.out.println("Diana E");
    }

    public void r(){
        System.out.println("Diana R");
    }
}
```

```java
public class Main {

    public static void main(String[] args) {
        String heroName = getPlayerInput();
        switch (heroName){
            case "Diana":
                Diana diana = new Diana();
                diana.r();
                break;
            case "Irilia":
                Irilia irilia = new Irilia();
                irilia.r();
                break;
            case "Camille":
                Camille camille = new Camille();
                camille.r();
                break;
            default:
                break;
        }
      	// æ¯æ¬¡æ ¹æ®ç”¨æˆ·è¾“å…¥ new æ–°å¯¹è±¡ï¼Œå¹¶ç”¨è¯¥å¯¹è±¡è°ƒç”¨æŠ€èƒ½æ–¹æ³•
    }

    private static String getPlayerInput(){
        System.out.print("Enter a hero's name: ");
        Scanner scanner = new Scanner(System.in);
        return scanner.nextLine();
    }
}
```



### abstraction ç‰ˆ

```java
public interface ISkill {

    void q();

    void w();

    void e();

    void r();
}
```

```java
/**
 * é’å†ˆå½±
 */
public class Camille implements ISkill {

    public void q(){
        System.out.println("Camille Q");
    }

    public void w(){
        System.out.println("Camille W");
    }

    public void e(){
        System.out.println("Camille E");
    }

    public void r(){
        System.out.println("Camille R");
    }
}
```

```java
/**
 * é»›å®‰å¨œ
 */
public class Diana implements ISkill {

    public void q(){
        System.out.println("Diana Q");
    }

    public void w(){
        System.out.println("Diana W");
    }

    public void e(){
        System.out.println("Diana E");
    }

    public void r(){
        System.out.println("Diana R");
    }
}
```

```java
public class Main {

    public static void main(String[] args) {
        String heroName = getPlayerInput();
        ISkill iSkill;
        // å¯¹è±¡å®ä¾‹åŒ–
        switch (heroName){
            case "Diana":
                iSkill = new Diana();
                break;
            case "Irilia":
                iSkill = new Irilia();
                break;
            case "Camille":
                iSkill = new Camille();
                break;
            default:
                throw new RuntimeException();
        }
        // é¢å‘å¯¹è±¡ï¼šå®ä¾‹åŒ–å¯¹è±¡ï¼Œè°ƒç”¨æ–¹æ³•ï¼ˆå®Œæˆä¸šåŠ¡é€»è¾‘ï¼‰
        // å•çº¯çš„ Interface åªèƒ½ç»Ÿä¸€æ–¹æ³•çš„è°ƒç”¨ï¼Œä¸èƒ½ç»Ÿä¸€å¯¹è±¡çš„å®ä¾‹åŒ–ã€‚å³å¤šæ€å¥½å¤„ï¼šè¿è¡Œæ—¶ç¡®å®šè¦è°ƒç”¨çš„æ–¹æ³•
        iSkill.r();

    }

    private static String getPlayerInput(){
        System.out.print("Enter a hero's name: ");
        Scanner scanner = new Scanner(System.in);
        return scanner.nextLine();
    }
}
```



### factory ç‰ˆ

```java
public interface ISkill {

    void q();

    void w();

    void e();

    void r();
}
```

```java
/**
 * é’å†ˆå½±
 */
public class Camille implements ISkill {

    public void q(){
        System.out.println("Camille Q");
    }

    public void w(){
        System.out.println("Camille W");
    }

    public void e(){
        System.out.println("Camille E");
    }

    public void r(){
        System.out.println("Camille R");
    }
}
```

```java
/**
 * é»›å®‰å¨œ
 */
public class Diana implements ISkill {

    public void q(){
        System.out.println("Diana Q");
    }

    public void w(){
        System.out.println("Diana W");
    }

    public void e(){
        System.out.println("Diana E");
    }

    public void r(){
        System.out.println("Diana R");
    }
}
```

```java
public class HeroFactory {

    public static ISkill getHero(String heroName){

        ISkill iSkill;
        // å¯¹è±¡å®ä¾‹åŒ–
        switch (heroName){
            case "Diana":
                iSkill = new Diana();
                break;
            case "Irilia":
                iSkill = new Irilia();
                break;
            case "Camille":
                iSkill = new Camille();
                break;
            default:
                throw new RuntimeException();
        }
        return iSkill;
    }
}
```

```java
public class Main {

    public static void main(String[] args) {
        String heroName = getPlayerInput();
        // HeroFactory å¦‚ä½•æ¶ˆé™¤ï¼Ÿ
        // æ­¤æ—¶æ˜¯é™æ€è°ƒç”¨ï¼Œåœ¨å·¥å‚ç±»ä¸­å®ä¾‹åŒ–æ—¶è¿˜æ˜¯ new æ“ä½œï¼Œå¹¶ä¸”å¼ºè€¦åˆäº†ï¼Œæ–°å¢æ—¶è¿˜éœ€ä¿®æ”¹å·¥å‚ç±»
        ISkill iSkill = HeroFactory.getHero(heroName);
        iSkill.r();

    }

    private static String getPlayerInput(){
        System.out.print("Enter a hero's name: ");
        Scanner scanner = new Scanner(System.in);
        return scanner.nextLine();
    }
}
```



### reflect ç‰ˆ

```java
public interface ISkill {

    void q();

    void w();

    void e();

    void r();
}
```

```java
/**
 * é’å†ˆå½±
 */
public class Camille implements ISkill {

    public void q(){
        System.out.println("Camille Q");
    }

    public void w(){
        System.out.println("Camille W");
    }

    public void e(){
        System.out.println("Camille E");
    }

    public void r(){
        System.out.println("Camille R");
    }
}
```

```java
/**
 * é»›å®‰å¨œ
 */
public class Diana implements ISkill {

    public void q(){
        System.out.println("Diana Q");
    }

    public void w(){
        System.out.println("Diana W");
    }

    public void e(){
        System.out.println("Diana E");
    }

    public void r(){
        System.out.println("Diana R");
    }
}
```

```java
public class HeroFactory {

    public static ISkill getHero(Class<? extends ISkill> clazz) throws IllegalAccessException, InstantiationException, NoSuchMethodException, InvocationTargetException {

        // å¯¹è±¡å®ä¾‹åŒ–
        Constructor<? extends ISkill> constructor = clazz.getDeclaredConstructor();
        return constructor.newInstance();
    }
}
```

```java
public class Main {

    public static void main(String[] args) throws 
      InstantiationException, 
  IllegalAccessException, 
  NoSuchMethodException, 
  InvocationTargetException {
        ISkill hero = HeroFactory.getHero(Irilia.class);
        hero.r();
    }
}
```







## æ¥å£ + å·¥å‚å®ç° OCP ğŸ”¥

é¢å‘å¯¹è±¡ï¼šå®ä¾‹åŒ–å¯¹è±¡ï¼Œè°ƒç”¨æ–¹æ³•ï¼ˆå®Œæˆä¸šåŠ¡é€»è¾‘ï¼‰

* å•çº¯çš„ Interface åªèƒ½**ç»Ÿä¸€æ–¹æ³•çš„è°ƒç”¨**ï¼Œ**ä¸èƒ½ç»Ÿä¸€å¯¹è±¡çš„å®ä¾‹åŒ–**ã€‚å³å¤šæ€å¥½å¤„ï¼šè¿è¡Œæ—¶ç¡®å®šè¦è°ƒç”¨çš„æ–¹æ³•

* åªæœ‰ä¸€æ®µä»£ç ä¸­æ²¡æœ‰ new å‡ºç°ï¼Œæ‰èƒ½ä¿æŒä»£ç çš„ç›¸å¯¹ç¨³å®šï¼Œæ‰èƒ½é€æ­¥å®ç° OCPã€‚ä½†æ˜¯ä»£ç ä¸­æ€»ä¼šå­˜åœ¨ä¸ç¨³å®šï¼Œéœ€è¦**éš”ç¦»è¿™äº›ä¸ç¨³å®šå› ç´ ï¼ˆé‡‡ç”¨é…ç½®ç±»ã€é…ç½®æ–‡ä»¶ç­‰æ–¹å¼ï¼‰**ï¼Œ**ä¿è¯å…¶ä»–çš„ä»£ç æ˜¯ç¨³å®šçš„**ã€‚å³å¯¹è±¡çš„å®ä¾‹åŒ–åº”è¯¥å’Œå…¶ä»–åˆ†å¼€ï¼

    ä¸ç¨³å®šè¡¨é¢çœ‹æ˜¯ç”±äº new å®ä¾‹åŒ–å¯¹è±¡ï¼Œå…¶å®æ˜¯**ç”¨æˆ·çš„è¾“å…¥ï¼ˆå˜åŒ–ï¼‰**å¯¼è‡´éœ€è¦é¢‘ç¹ä¿®æ”¹ new å®ä¾‹åŒ–

    *   é…ç½®æ–‡ä»¶çš„**é›†ä¸­æ€§**
    *   é…ç½®æ–‡ä»¶**æ¸…æ™°ï¼ˆä½†æ˜¯å¤šäº†åä¹Ÿä¸æ¸…æ™°ï¼‰ï¼Œæ²¡æœ‰ä¸šåŠ¡é€»è¾‘**

* ä½¿ç”¨**ç®€å•å·¥å‚æ¨¡å¼**åï¼Œè¯¥å·¥å‚è·å– Bean çš„æ–¹æ³•æ˜¯é™æ€çš„ï¼Œè™½ç„¶çœ‹èµ·æ¥æ²¡æœ‰ new å¯¹è±¡ï¼Œä½†æ˜¯å…¶å®æ˜¯ä¾èµ–äº†å…·ä½“å®ç°ã€‚ä¸”éœ€è¦ä¸åŒç±»å‹çš„ Bean æ—¶æ€»æ˜¯éœ€è¦æ–°å»ºä¸€ä¸ªå·¥å‚ç±»ï¼ŒåŒä¸€ç±»å‹çš„ä¸åŒ Bean ä¹Ÿéœ€è¦ä¿®æ”¹å·¥å‚ç±»

* æ­¤æ—¶å¯ä»¥ä½¿ç”¨**æŠ½è±¡å·¥å‚æ¨¡å¼**ï¼Œå½“ç„¶å®ƒä¹Ÿæœ‰ç±»ä¼¼çš„é—®é¢˜

* åªæœ‰è¿™ä¸ªå·¥å‚ç‰¹åˆ«å¤§ï¼Œå¯ä»¥è·å¾—æ‰€æœ‰ Bean æ—¶ï¼Œæ‰è®¤ä¸ºå®ƒç›¸å¯¹ç¨³å®šã€‚å¦‚ IoC å®¹å™¨ï¼Œç‰¹åˆ«æ˜¯ Spring çš„ ApplicationContext ç­‰æ¥å£å®¹å™¨

*   ä½†æ˜¯ï¼å·¥å‚æ¨¡å¼ + åå°„å¹¶ä¸æ˜¯ IoC å’Œ DI



## å¦‚ä½•ç†è§£ IoCã€DI ã€DIP ğŸ”¥

### IoC

è¯¥æ¦‚å¿µçš„ç”±æ¥æ˜¯ Java ç¤¾åŒºçš„è½»é‡çº§å®¹å™¨èƒ½å¤Ÿå¸®åŠ©å¼€å‘è€…**å°†æ¥è‡ªä¸åŒé¡¹ç›®çš„ç»„ä»¶ï¼ˆæˆ–æœåŠ¡ï¼Œç†è§£å³å¯ï¼‰è£…é…ï¼ˆç»„åˆï¼‰æˆä¸€ä¸ªå†…èšçš„é¡¹ç›®ï¼ˆåº”ç”¨ï¼‰**ï¼Œè€Œè¿™ç§æ“ä½œå°±æ˜¯ IoCï¼Œå®ƒå†³å®šäº†è¿™äº›å®¹å™¨è¿›è¡Œç»„ä»¶è£…é…çš„æ–¹å¼

IoC çš„ä¸»è¦å®ç°çš„ä½œç”¨å°±æ˜¯**å°†ç»„ä»¶ï¼ˆBeanï¼‰æ³¨å†Œåˆ°åˆ°å®¹å™¨**ä¸­ï¼Œå¹¶èƒ½ç»™ä½¿ç”¨è€…**æä¾›è‡ªåŠ¨æ³¨å…¥**åŠŸèƒ½

æ§åˆ¶åè½¬ï¼Œ**æŠŠåˆ›å»ºå¯¹è±¡çš„æƒåˆ©äº¤ç»™å®¹å™¨ï¼ˆæˆ–å·¥å‚ï¼‰**ã€‚**ä½†å…¶å®éœ€è¦é…åˆæ¥å£ï¼ˆæŠ½è±¡ï¼‰æ‰èƒ½ç®—å°†å…¶ä½¿ç”¨æ›´å¥½**ã€‚

è§£å†³äº†ç¨‹åºå’Œå¯¹è±¡ä¹‹é—´çš„è€¦åˆï¼Œå…¶å…·ä½“å®ç°å°±æ˜¯ DI





### DIï¼ˆDependency Injectionï¼‰

::: tip

[martinfowler åšå®¢](https://martinfowler.com/articles/injection.html)åŠ [ThoughtWork çš„ç¿»è¯‘](https://insights.thoughtworks.cn/injection/)

:::

DIï¼ˆä¾èµ–æ³¨å…¥ï¼‰ çš„ç›®çš„åœ¨äº**å°†ç»„ä»¶çš„é…ç½®ä¸ä½¿ç”¨åˆ†ç¦»å¼€**ã€‚å¦‚ä½•åœ¨**è¿è¡Œæ—¶ï¼ˆä¸æ˜¯ç¼–è¯‘æ—¶ï¼‰**å°†**ç»„ä»¶ï¼ˆæŠ½è±¡çš„å…·ä½“å®ç°å¯èƒ½æœ‰å¤šä¸ªï¼Œæ‰€ä»¥ç¼–è¯‘æ—¶æ— æ³•ç¡®å®šå“ªä¸ªï¼‰åŠ¨æ€è¿å…¥ç¨‹åº**ä¸­ï¼ˆè¿™é‡Œæ˜¯ä¸æ˜¯æƒ³èµ·æ¥å£çš„æ¦‚å¿µäº†ï¼‰

è¿™é‡Œçš„ç»„ä»¶å¯ä»¥æŒ‡ä»£æœåŠ¡ï¼ˆServiceä¹Ÿè¡Œï¼‰

å³è°ƒç”¨ç±»å¯¹æŸä¸€æ¥å£å®ç°ç±»çš„ä¾èµ–å…³ç³»ç”±ç¬¬ä¸‰æ–¹å®¹å™¨æˆ–åä½œç±»æ³¨å…¥ï¼Œç§»é™¤è°ƒç”¨ç±»å¯¹æŸä¸€æ¥å£å®ç°ç±»çš„ä¾èµ–ã€‚

ä¸€èˆ¬å®Œæˆç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘å¯èƒ½ä¼šéœ€è¦å¤šä¸ªç±»ä¹‹é—´è¿›è¡Œåä½œã€‚æŒ‰ä¼ ç»Ÿçš„åšæ³•ï¼Œæ¯ä¸ªå¯¹è±¡è´Ÿè´£ç®¡ç†ä¸è‡ªå·±äº’ç›¸åä½œçš„å¯¹è±¡(å®ƒæ‰€ä¾èµ–çš„å¯¹è±¡)çš„å¼•ç”¨ï¼Œè¿™ä¼šå¯¼è‡´é«˜åº¦è€¦åˆå¹¶éš¾ä»¥æµ‹è¯•çš„ä»£ç ã€‚åˆ©ç”¨ä¾èµ–æ³¨å…¥ï¼Œæ¯ä¸ªå¯¹è±¡å¯ä»¥ç›´æ¥è·å–æ‰€ä¾èµ–çš„å¯¹è±¡

æœ€å¼€å§‹çš„ new å¯¹è±¡ï¼Œå¼ºä¾èµ–ï¼›åæ¥ä½¿ç”¨å·¥å‚ï¼Œè¦å¯¹è±¡ï¼Œå¼±ä¾èµ–ï¼›æœ€åä½¿ç”¨ IoC å’Œ DIï¼ŒIoC å®¹å™¨æ³¨å…¥å¯¹è±¡ï¼ˆè¢«åŠ¨ï¼‰ã€‚âš™ï¸

*   å±æ€§æ³¨å…¥ï¼ˆsetï¼‰
*   æ„é€ æ³¨å…¥
*   æ¥å£æ³¨å…¥





### DIPï¼ˆDependency Inversion Principleï¼‰

ä¾èµ–å€’ç½®åŸåˆ™

*   é«˜å±‚æ¨¡å—ï¼ˆæŠ½è±¡ï¼‰ä¸è¯¥ä¾èµ–ä½å±‚æ¨¡å—ï¼ˆå®ç°ï¼‰ï¼Œä¸¤è€…éƒ½åº”è¯¥**ä¾èµ–æŠ½è±¡**
*   æŠ½è±¡ä¸åº”è¯¥ä¾èµ–ç»†èŠ‚
*   ç»†èŠ‚åº”è¯¥ä¾èµ–æŠ½è±¡

æ€»ä¹‹å°±æ˜¯è¯´è¦**ä¾èµ–æŠ½è±¡**ã€‚æ¯”å¦‚**ä¾èµ–çš„ Service ä¸åº”è¯¥æ˜¯å…·ä½“ç±»ï¼Œè€Œåº”è¯¥æ˜¯æ¥å£ï¼ˆæ³¨å…¥çš„åªèƒ½æ˜¯å…·ä½“ç±»ï¼Œç†è§£å³å¯ï¼‰** 

```java
@Autowired
private UserService userService;
```

æ­¤æ—¶ä½¿ç”¨çš„æ˜¯ç±»å‹æ³¨å…¥ï¼Œä¾èµ–çš„æ˜¯ UserService æ¥å£ï¼ŒIoC å®¹å™¨ä¼šåœ¨è¿è¡Œæ—¶å°†è¯¥ç±»å‹çš„å…·ä½“å¯¹è±¡æ³¨å…¥ï¼







