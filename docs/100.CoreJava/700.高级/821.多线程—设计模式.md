---
title: å¤šçº¿ç¨‹â€”è®¾è®¡æ¨¡å¼
date: 2021-02-13 01:21:20
permalink: /pages/89dd04/
categories:
  - CoreJava
  - é«˜çº§
tags:
  - 
---

# å¤šçº¿ç¨‹â€”è®¾è®¡æ¨¡å¼

## ä¸¤é˜¶æ®µç»ˆæ­¢â€”Two Phase Termination

### ç”¨å¤„

åœ¨ä¸€ä¸ªçº¿ç¨‹ T1 ä¸­å¦‚ä½•â€œä¼˜é›…â€ç»ˆæ­¢çº¿ç¨‹ T2ï¼Ÿè¿™é‡Œçš„ã€ä¼˜é›…ã€‘æŒ‡çš„æ˜¯ç»™ T2 ä¸€ä¸ªæ–™ç†åäº‹çš„æœºä¼šã€‚



### é”™è¯¯æ€è·¯

*   ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„ stop() æ–¹æ³•åœæ­¢çº¿ç¨‹

    stop æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœè¿™æ—¶çº¿ç¨‹**é”**ä½äº†å…±äº«èµ„æºï¼Œé‚£ä¹ˆå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œå…¶å®ƒçº¿ç¨‹å°†æ°¸è¿œæ— æ³•è·å–é”

*   ä½¿ç”¨ System.exit(int) æ–¹æ³•åœæ­¢çº¿ç¨‹

    ç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§åšæ³•ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢



### ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼

```mermaid
graph TD
w("while(true)") --> a
a(æœ‰æ²¡æœ‰è¢«æ‰“æ–­?) -- æ˜¯ --> b(æ–™ç†åäº‹)
b --> c((ç»“æŸå¾ªç¯))
a -- å¦ --> d("ç¡çœ 2s(sleepã€joinã€waitä¸­è¢«æ‰“æ–­çš„ä¼šæŠ›å¼‚å¸¸)")
d -- æ— å¼‚å¸¸ --> e(è®¾ç½®ç›‘æ§è®°å½•)
d -- æœ‰å¼‚å¸¸ --> i(é‡æ–°è®¾ç½®æ‰“æ–­æ ‡è®°)
i --> w
e --> w
```



### interrupt å®ç° ğŸ”¥

```java
@Slf4j(topic = "TwoPhaseTermination")
public class TwoPhaseTermination {


    /* ç›‘æ§çº¿ç¨‹ */
    private Thread monitor;

    /**
     * å¯åŠ¨ç›‘æ§çº¿ç¨‹
     */
    public void start(){
        monitor = new Thread(()->{
            Thread currentThread = Thread.currentThread();
            while (true){
                boolean flag = currentThread.isInterrupted();
                if (flag){
                    log.debug("æ–™ç†åäº‹ï¼Œä¼˜é›…åœæœº");
                    break;
                }

                try {
                    // 1 æ­£å¸¸æƒ…å†µï¼Œè¢«æ‰“æ–­æ— éœ€é¢å¤–å¤„ç†
                    log.debug("æ‰§è¡Œç›‘æ§è®°å½•");
                    // 2 éæ­£å¸¸æƒ…å†µï¼Œåœ¨ sleepã€joinã€wait ä¸­è¢«ä¸­æ–­
                    // æ¯1ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œé‡Šæ”¾CPUï¼Œæ‰€ä»¥sleep
                    TimeUnit.SECONDS.sleep(1);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                    // ç”±äº catch InterruptedException åä¼šæ¸…é™¤ä¸­æ–­æ ‡å¿—ï¼Œæ‰€ä»¥éœ€è¦é‡è®¾ä¸­æ–­æ ‡å¿—
                    currentThread.interrupt();
                }

            }
        });

        monitor.start();
    }

    /**
     * ä¼˜é›…åœæ­¢ç›‘æ§çº¿ç¨‹
     */
    public void stop(){
        monitor.interrupt();
    }


    public static void main(String[] args) throws InterruptedException {
        TwoPhaseTermination tpt = new TwoPhaseTermination();
        tpt.start();
        TimeUnit.SECONDS.sleep(3);
        tpt.stop();
    }
}
```





### volitile å®ç° ğŸ”¥

```java

```

