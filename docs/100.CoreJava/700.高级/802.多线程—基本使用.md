---
title: å¤šçº¿ç¨‹â€”åŸºæœ¬ä½¿ç”¨
date: 2021-02-10 18:24:11
permalink: /pages/59919e/
categories:
  - CoreJava
  - é«˜çº§
tags:
  - 
---

# å¤šçº¿ç¨‹â€”åŸºæœ¬ä½¿ç”¨

## çº¿ç¨‹è°ƒåº¦æ¨¡å‹

- **çº¿ç¨‹è°ƒåº¦æ¨¡å‹**ï¼ˆåº”ç”¨ç¨‹åºçš„æ‰§è¡Œéƒ½æ˜¯**CPU åœ¨å¤šä¸ªçº¿ç¨‹é—´å¿«é€Ÿåˆ‡æ¢**å®Œæˆçš„ï¼‰
    - **åˆ†æ—¶è°ƒåº¦æ¨¡å‹ï¼ˆæ—¶é—´ç‰‡ï¼‰**ï¼šæ‰€æœ‰çº¿ç¨‹è½®æµä½¿ç”¨ CPU çš„ä½¿ç”¨æƒï¼Œå¹³å‡åˆ†é…æ¯ä¸ªçº¿ç¨‹å ç”¨ CPU çš„æ—¶é—´ç‰‡
    - **æŠ¢å å¼è°ƒåº¦æ¨¡å‹**ï¼šä¼˜å…ˆè®©**ä¼˜å…ˆçº§é«˜**çš„çº¿ç¨‹ä½¿ç”¨ CPUï¼Œå¦‚æœçº¿ç¨‹çš„ä¼˜å…ˆçº§ç›¸åŒï¼Œé‚£ä¹ˆä¼šéšæœºé€‰æ‹©ä¸€ä¸ªï¼Œä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹è·å–çš„ CPU æ—¶é—´ç‰‡ç›¸å¯¹å¤šä¸€äº›
- **Java çš„çº¿ç¨‹è°ƒåº¦æ–¹æ³•**
    - **åŒä¼˜å…ˆçº§**çº¿ç¨‹ç»„æˆ**å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—**ï¼ˆå…ˆåˆ°å…ˆæœåŠ¡ï¼‰ï¼Œä½¿ç”¨**æ—¶é—´ç‰‡**ç­–ç•¥
    - å¯¹**é«˜ä¼˜å…ˆçº§**ï¼Œä½¿ç”¨ä¼˜å…ˆè°ƒåº¦çš„**æŠ¢å å¼**ç­–ç•¥



## çº¿ç¨‹çš„åˆ›å»ºå’Œä½¿ç”¨ ğŸ”¥

### Thread æ„é€ æ–¹æ³• ğŸ”¥

- `Thread()`ï¼šåˆ†é…ä¸€ä¸ªæ–°çš„çº¿ç¨‹å¯¹è±¡ã€‚
- `Thread(String name)`ï¼šåˆ†é…ä¸€ä¸ªæŒ‡å®šåå­—çš„æ–°çš„çº¿ç¨‹å¯¹è±¡
- `Thread(Runnable target)`ï¼šåˆ†é…ä¸€ä¸ªå¸¦æœ‰æŒ‡å®šç›®æ ‡æ–°çš„çº¿ç¨‹å¯¹è±¡ï¼Œå®ƒå®ç°äº† Runnable æ¥å£ä¸­çš„`run`æ–¹æ³•
- `Thread(Runnable target,String name)`ï¼šåˆ†é…ä¸€ä¸ªå¸¦æœ‰æŒ‡å®šç›®æ ‡æ–°çš„çº¿ç¨‹å¯¹è±¡å¹¶**æŒ‡å®šåå­—**



### 1. ç»§æ‰¿ Thread ç±»â€”åŒ¿åå†…éƒ¨ç±»

1.  å®šä¹‰å­ç±»ç»§æ‰¿ Thread ç±»ã€‚å¯ä»¥å†™æ— å‚å’Œå¸¦å‚æ„é€ ä»¥ä¾¿ç›´æ¥å®šä¹‰çº¿ç¨‹åç§°ã€‚
2.  å­ç±»ä¸­ Override é‡å†™ Thread ç±»çš„`run()`æ–¹æ³•ï¼Œå°†çº¿ç¨‹çš„ä»»åŠ¡ä»£ç å°è£…åˆ°`run()`æ–¹æ³•ä¸­ã€‚
3.  åˆ›å»º Thread çš„å­ç±»å¯¹è±¡ï¼Œå³åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ã€‚
4.  è°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„**`start()`**ï¼ŒJVM å°†è°ƒç”¨è¯¥çº¿ç¨‹çš„**`run()`**æ–¹æ³•æ‰§è¡Œï¼ˆ**å¤šæ¬¡å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹éæ³•ï¼Œå³ä½¿æ‰§è¡Œå®Œæ¯•**ï¼‰

```java
@Slf4j(topic = "Test1")
public class Test1 {

    public static void main(String[] args) {
        Thread t1 = new Thread("t1") {
            @Override
            public void run() {
                log.debug("running");
            }
        };

        t1.start();

        log.debug("running");
    }
}
```



### 2. å®ç° Runnable æ¥å£

1.  å®šä¹‰ç±»å®ç° Runnable æ¥å£
2.  @Override é‡å†™æ¥å£ä¸­çš„`run()`æ–¹æ³•ï¼Œå°†çº¿ç¨‹çš„ä»»åŠ¡ä»£ç å°è£…åˆ°`run()`æ–¹æ³•ä¸­
3.  é€šè¿‡ Thread ç±»åˆ›å»ºçº¿ç¨‹å¯¹è±¡ï¼Œå¹¶å°† Runnable æ¥å£çš„å­ç±»å¯¹è±¡ä½œä¸º Thread ç±»çš„æ„é€ å‡½æ•°çš„å‚æ•°è¿›è¡Œä¼ é€’ã€‚**çº¿ç¨‹çš„ä»»åŠ¡éƒ½å°è£…åœ¨ Runnable æ¥å£å®ç°ç±»å¯¹è±¡çš„ run æ–¹æ³•ä¸­ï¼Œæ‰€ä»¥è¦åœ¨çº¿ç¨‹å¯¹è±¡åˆ›å»ºæ—¶å°±å¿…é¡»æ˜ç¡®è¦è¿è¡Œçš„ä»»åŠ¡**
4.  è°ƒç”¨**`start()`å¼€å¯çº¿ç¨‹**ï¼ŒJVM è°ƒç”¨è¯¥çº¿ç¨‹çš„**`run()`**æ–¹æ³•æ‰§è¡Œï¼ˆ**å¤šæ¬¡å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹éæ³•ï¼Œå³ä½¿æ‰§è¡Œå®Œæ¯•**ï¼‰

```java
@Slf4j(topic = "Test2")
public class Test2 {
    public static void main(String[] args) {
        // æ™®é€šå®ç°
        Runnable r0 = new Runnable() {
            @Override
            public void run() {
                log.debug("running");
            }
        };

        // lambdaè¡¨è¾¾å¼å®ç°
        r1 = () -> log.debug("running");

        Thread t1 = new Thread(r1, "t1");
        t1.start();

        log.debug("running");

    }
}
```



### 3. å®ç° Callable æ¥å£ + Future

ä¸ä½¿ç”¨ Runnable ç›¸æ¯”ï¼Œ Callable åŠŸèƒ½æ›´å¼ºå¤§äº›ï¼ˆJDK5.0 æ–°å¢ï¼‰ï¼š

- ä½¿ç”¨`FutureTask`ç±»å°è£…å®ç°äº† `Callable` æ¥å£çš„å®ç°ç±»ï¼Œå¹¶ä¼ å…¥ `Thread` çš„æ„é€ æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ `start` æ–¹æ³•

- ç›¸æ¯”`run()`æ–¹æ³•ï¼Œå®ç° Callableæ¥å£éœ€è¦å®ç° `call()` æ–¹æ³•ï¼Œå¯ä»¥æœ‰**è¿”å›å€¼**ï¼ˆæ”¯æŒ**æ³›å‹**ï¼‰ï¼Œå¯ä»¥**æŠ›å‡ºå¼‚å¸¸**

    è°ƒç”¨`FutureTask`çš„`get()`**é˜»å¡ç­‰å¾…ä»»åŠ¡ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œè·å–è¿”å›å€¼**

`Future`æ¥å£ï¼š

- å¯ä»¥å¯¹å…·`Runnable`ã€`Callable`ä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿›è¡Œå–æ¶ˆã€æŸ¥è¯¢æ˜¯å¦å®Œæˆã€è·å–ç»“æœç­‰ã€‚
- `FutrueTask`æ˜¯`Futrue`æ¥å£çš„**å”¯ä¸€çš„å®ç°ç±»**
- `FutureTask`**åŒæ—¶å®ç°äº†`Runnable`,`Future`æ¥å£**ã€‚å®ƒæ—¢å¯ä»¥ä½œä¸º`Runnable`è¢«çº¿ç¨‹æ‰§è¡Œï¼Œåˆå¯ä»¥ä½œä¸º`Future`å¾—åˆ°`Callable`çš„è¿”å›å€¼

```java
@Slf4j(topic = "Test3")
public class Test3 {
    public static void main(String[] args) throws ExecutionException, InterruptedException {

        // æ™®é€šå®ç°
        Callable<Integer> c0 = new Callable<Integer>() {
            @Override
            public Integer call() throws Exception {
                log.debug("Callable ...");
                Thread.sleep(2000);
                return 1 + 1;
            }
        };

        // lambdaè¡¨è¾¾å¼å®ç°
        FutureTask<Integer> c1 = new FutureTask<>(() -> {
            log.debug("Callable ...");
            Thread.sleep(2000);
            return 1 + 1;
        });

        Thread t1 = new Thread(c1, "t1");
        t1.start();

        int value = c1.get();
        log.debug("value: {}", value);
    }
}
```



### çº¿ç¨‹æ± 

- èƒŒæ™¯ï¼šç»å¸¸åˆ›å»ºå’Œé”€æ¯ã€ä½¿ç”¨é‡ç‰¹åˆ«å¤§çš„èµ„æºï¼Œæ¯”å¦‚å¹¶å‘æƒ…å†µä¸‹çš„çº¿ç¨‹ï¼Œ å¯¹æ€§èƒ½å½±å“å¾ˆå¤§ã€‚
- **çº¿ç¨‹æ± **ï¼šå…¶å®å°±æ˜¯ä¸€ä¸ª**å®¹çº³å¤šä¸ªçº¿ç¨‹çš„å®¹å™¨**ï¼Œå…¶ä¸­çš„**çº¿ç¨‹å¯ä»¥åå¤ä½¿ç”¨**ï¼Œä½¿ç”¨å®Œ**è‡ªåŠ¨å½’è¿˜**ï¼Œçœå»äº†é¢‘ç¹åˆ›å»ºçº¿ç¨‹å¯¹è±¡çš„æ“ä½œï¼Œ æ— éœ€åå¤åˆ›å»ºçº¿ç¨‹è€Œæ¶ˆè€—è¿‡å¤šèµ„æºã€‚
- å¥½å¤„ï¼š
    - **é™ä½èµ„æºæ¶ˆè€—**ï¼ˆé‡å¤åˆ©ç”¨çº¿ç¨‹æ± ä¸­çº¿ç¨‹ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½åˆ›å»ºï¼‰
    - **æé«˜å“åº”é€Ÿåº¦**ï¼ˆå‡å°‘äº†åˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶é—´ï¼‰
    - **ä¾¿äºçº¿ç¨‹ç®¡ç†**
- **JDK 5.0 èµ·**æä¾›äº†çº¿ç¨‹æ± çš„é¡¶çº§**æ¥å£**æ˜¯ `java.util.concurrent.Executor`ï¼Œä½†æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šè®²å®ƒåªæ˜¯ä¸€ä¸ª**æ‰§è¡Œçº¿ç¨‹çš„å·¥å…·**ã€‚**çœŸæ­£çš„çº¿ç¨‹æ± æ¥å£æ˜¯ `java.util.concurrent.ExecutorService`** ï¼ˆå®˜æ–¹å»ºè®®**ä½¿ç”¨`java.util.concurrent.Executors`çº¿ç¨‹æ± å·¥å‚ç±»**æ¥åˆ›å»ºçº¿ç¨‹æ± å¯¹è±¡ï¼‰ï¼š
    - `void execute(Runnable command)`ï¼šæ‰§è¡Œä»»åŠ¡/å‘½ä»¤ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼Œä¸€èˆ¬ç”¨æ¥æ‰§è¡Œ `Runnable`
    - `<T> Future<T> submit(Callable<T> task)`ï¼šæ‰§è¡Œä»»åŠ¡ï¼Œæœ‰è¿”å›å€¼ï¼Œä¸€èˆ¬åˆæ¥æ‰§è¡Œ `Callable`
    - `void shutdown()`ï¼šå…³é—­çº¿ç¨‹æ± ï¼Œä¸å»ºè®®æ‰§è¡Œ
- å¸¸è§`ExecutorService`çº¿ç¨‹æ± å¯¹è±¡æœ‰ï¼š
    - `ExecutorService static newCachedThreadPool()`ï¼šå¯æ ¹æ®éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹çš„çº¿ç¨‹æ± 
    - `ExecutorService static newFixedThreadPool(int maxThreads)`ï¼šå¯é‡ç”¨å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± 
    - `ExecutorService static newSingleThreadExecutor()`ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 
    - `ExecutorService static newScheduledThreadPool(n)`ï¼šå¯å®‰æ’åœ¨ç»™å®šå»¶è¿Ÿåè¿è¡Œå‘½ä»¤æˆ–è€…å®šæœŸåœ°æ‰§è¡Œ
- å‚æ•°ï¼ˆå¸¸è€ƒï¼‰ï¼š
    - corePoolSizeï¼šæ ¸å¿ƒæ± çš„å¤§å°
    - maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°
    - keepAliveTimeï¼šçº¿ç¨‹æ²¡æœ‰ä»»åŠ¡æ—¶æœ€å¤šä¿æŒå¤šé•¿æ—¶é—´åä¼šç»ˆæ­¢
    - setRejectedExecutionHandler
    - setThreadFactory

```java
ExecutorService service = Executors.newFixedThreadPool(10);
ThreadPoolExecutor service1 = (ThreadPoolExecutor) service;
// è®¾ç½®çº¿ç¨‹æ± çš„å±æ€§
// System.out.println(service.getClass());
// service1.setCorePoolSize(15);
// service1.setKeepAliveTime();
service.execute(new NumberThread());//é€‚åˆé€‚ç”¨äºRunnable
service.execute(new NumberThread1());//é€‚åˆé€‚ç”¨äºRunnable
service.submit(Callable callable);//é€‚åˆä½¿ç”¨äºCallable
//å…³é—­è¿æ¥æ± 
service.shutdown();
```





## åŸºæœ¬æ–¹æ³•

- `static Thread currentThread()`ï¼šè·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œåœ¨ Thread å­ç±»ä¸­å°±æ˜¯ thisï¼Œé€šå¸¸ç”¨äºä¸»çº¿ç¨‹å’Œ Runnable å®ç°ç±»
- `String getName()`ï¼š**è·å–å½“å‰çº¿ç¨‹åç§°**
- `void setName()`ï¼š**è®¾ç½®å½“å‰çº¿ç¨‹åç§°**ï¼Œæˆ–é€šè¿‡çº¿ç¨‹**ç±»çš„æœ‰å‚æ„é€ è®¾ç½®**
- `getId()`ï¼šè·å–çº¿ç¨‹é•¿æ•´å‹çš„ idï¼ˆå”¯ä¸€ï¼‰



## å¸¸ç”¨æ–¹æ³•â€”start & run ğŸ”¥

### start

`void start()`ï¼š**å¯åŠ¨çº¿ç¨‹ï¼ŒJVM æ‰§è¡Œæ­¤çº¿ç¨‹å¯¹è±¡çš„`run()`æ–¹æ³•**

è¯¥æ–¹æ³•åªæ˜¯è®©çº¿ç¨‹è¿›å…¥**å°±ç»ª**çŠ¶æ€ï¼Œé‡Œé¢ä»£ç ä¸ä¸€å®šç«‹åˆ»è¿è¡Œï¼ˆCPU çš„æ—¶é—´ç‰‡è¿˜æ²¡åˆ†ç»™å®ƒï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹å¯¹è±¡çš„`start`æ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœè°ƒç”¨äº†å¤šæ¬¡ä¼šå‡ºç° `IllegalThreadStateException`



### run

`void run()`ï¼š**çº¿ç¨‹åœ¨è¢«è°ƒåº¦æ—¶æ‰§è¡Œåº•å±‚çš„æ“ä½œ**ã€‚ç›´æ¥è°ƒç”¨åˆ™æ²¡æœ‰å¤šçº¿ç¨‹æ•ˆæœï¼Œä»…ä»…æ˜¯mainçº¿ç¨‹ä¸­è°ƒç”¨ä¸‹è¯¥ä»»åŠ¡

å¦‚æœåœ¨æ„é€  Thread å¯¹è±¡æ—¶ä¼ é€’äº† Runnable å‚æ•°ï¼Œåˆ™çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨ Runnable ä¸­çš„ run æ–¹æ³•ï¼Œå¦åˆ™é»˜è®¤ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ä½†å¯ä»¥åˆ›å»º Thread çš„å­ç±»å¯¹è±¡ï¼Œæ¥è¦†ç›–é»˜è®¤è¡Œä¸º





## å¸¸ç”¨é™æ€æ–¹æ³•â€”sleep & yield ğŸ”¥

### sleep

`static void sleep(long millis)` **æœ€ç»ˆè¿›å…¥é˜»å¡çŠ¶æ€**

**çº¿ç¨‹ç¡çœ **ã€‚ä½¿**å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹**ä»¥æŒ‡å®šçš„æ¯«ç§’æ•°**ç¡çœ **ï¼Œ**ä¸é‡Šæ”¾é”**

*   è°ƒç”¨ sleep ä¼šè®©å½“å‰çº¿ç¨‹**ä» *Running* è¿›å…¥ *Timed Waiting* çŠ¶æ€ï¼ˆæœ€ç»ˆè¿›å…¥é˜»å¡çŠ¶æ€ï¼‰**

*   å…¶å®ƒçº¿ç¨‹å¯ä»¥ä½¿ç”¨ interrupt æ–¹æ³•**æ‰“æ–­**æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œè¿™æ—¶ sleep æ–¹æ³•ä¼šæŠ›å‡º InterruptedException

*   ç¡çœ ç»“æŸåçš„çº¿ç¨‹**æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œ**

*   **å»ºè®®ç”¨ `TimeUnit` çš„ `sleep` ä»£æ›¿ Thread çš„ sleep æ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§**

```java
@Slf4j(topic = "SleepTest")
public class SleepTest {
    public static void main(String[] args) {
        Thread t1 = new Thread(() -> {
            try {
                // Thread.sleep(2000);
                TimeUnit.SECONDS.sleep(2);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "t1");

        t1.start();
        log.debug("t1 state: {}", t1.getState());// RUNNABLE

        try {
            // å¯èƒ½mainçº¿ç¨‹å¿«æ‰§è¡Œå®Œäº†ï¼Œæ‰æ‰§è¡Œt1ï¼Œæ‰€ä»¥è®©mainçº¿ç¨‹ä¼‘çœ ä¸‹
            TimeUnit.MILLISECONDS.sleep(500);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("t1 state: {}", t1.getState());// TIMED_WAITING
    }
}
```

```java
@Slf4j(topic = "interruptTest")
public class InterruptTest {
    public static void main(String[] args) throws InterruptedException {
        Thread t1 = new Thread(() -> {
            try {
                log.debug("enter sleep...");
                TimeUnit.SECONDS.sleep(2);
                log.debug("what's the fuck!!!");// ä¸ä¼šæ‰§è¡Œï¼ï¼ï¼interrupt ä¸æ˜¯ notify
            } catch (InterruptedException e) {
                log.debug("be interrupt...");
                e.printStackTrace();
            }
        }, "t1");

        t1.start();
        TimeUnit.SECONDS.sleep(1);
        log.debug("interrupt...");
        t1.interrupt();

        // 22:11:31.589 [t1] DEBUG interruptTest - enter sleep...
        // 22:11:32.589 [main] DEBUG interruptTest - interrupt...
        // 22:11:32.589 [t1] DEBUG interruptTest - be interrupt...
    }
}
```



### yield

`static void yield()` **ä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€**

**çº¿ç¨‹è®©æ­¥**ã€‚**æš‚åœ**å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼ˆç³»ç»ŸæŒ‡å®šçš„æ¯«ç§’æ•°ï¼‰ï¼ŒæŠŠæ‰§è¡Œæœºä¼šè®©ç»™ä¼˜å…ˆçº§ç›¸åŒæˆ–æ›´é«˜çš„çº¿ç¨‹ï¼Œå¹¶æ‰§è¡Œå…¶ä»–çº¿ç¨‹ã€‚è‹¥é˜Ÿåˆ—ä¸­æ²¡æœ‰åŒä¼˜å…ˆçº§çš„çº¿ç¨‹ï¼Œå¿½ç•¥æ­¤æ–¹æ³•ã€‚**è½¬ä¸º RUNNABLE çš„å°±ç»ªçŠ¶æ€ï¼ˆä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼‰**ï¼Œè¯¥çº¿ç¨‹ä¸ä¼šå¤±å»ä»»ä½•ç›‘è§†å™¨çš„æ‰€æœ‰æƒï¼ˆ**ä¸é‡Šæ”¾é”**ï¼‰ã€‚**ä¸ç¡®ä¿çœŸæ­£è®©å‡ºï¼Œå…·ä½“å®ç°ä¾èµ–æ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨ï¼Œå¾ˆå°‘ç”¨ï¼Œä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯•å’Œè°ƒè¯•**ã€‚

```java
@Slf4j(topic = "yieldTest")
public class YieldTest {

    public static void main(String[] args) {

        Runnable task1 = () -> {
            int count = 0;
            for (; ; ) {
                System.out.println("=====> task1 " + count++);
            }
        };

        Runnable task2 = () -> {
            int count = 0;
            for (; ; ) {
                // 1 æµ‹è¯• yieldï¼ˆè¿™ä¸ªå¾ˆæ˜æ˜¾ï¼‰
                Thread.yield();
                System.out.println("            =====> task2 " + count++);
            }
        };

        Thread t1 = new Thread(task1, "t1");
        Thread t2 = new Thread(task2, "t2");
        // 2 æµ‹è¯•ä¼˜å…ˆçº§ï¼ˆçœ‹CPUç©ºé—²æ ¸å¿ƒæ•°å§ï¼Œå¯èƒ½éƒ½å¹¶è¡Œæ‰§è¡Œäº†ï¼‰
        // t1.setPriority(Thread.MIN_PRIORITY);
        // t2.setPriority(Thread.MAX_PRIORITY);
        t1.start();
        t2.start();
    }
}
```



### çº¿ç¨‹ä¼˜å…ˆçº§ ğŸ”¥

- çº¿ç¨‹çš„ä¼˜å…ˆçº§ç­‰çº§ï¼ˆé€šè¿‡ Thread çš„é™æ€å¸¸é‡ï¼‰
    - `Thread.MAX_PRIORITY`ï¼š10
    - `Thread.MIN _PRIORITY`ï¼š1
    - `Thread.NORM_PRIORITY`ï¼š5ï¼Œé»˜è®¤
- æ–¹æ³•
    - `getPriority()`ï¼šè¿”å›çº¿ç¨‹ä¼˜å…ˆçº§
    - `setPriority(int newPriority)`ï¼šæ”¹å˜çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œéœ€åœ¨ start å‰è®¾ç½®
- è¯´æ˜
    - **çº¿ç¨‹åˆ›å»ºæ—¶ç»§æ‰¿çˆ¶çº¿ç¨‹çš„ä¼˜å…ˆçº§**
    - çº¿ç¨‹ä¼˜å…ˆçº§ä»…ä»…ä¼šæç¤ºï¼ˆhintï¼‰è°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥å®ƒã€‚è‹¥**CPUæ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡**ï¼Œä½†**CPUé—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ä½œç”¨**ã€‚**ä½ä¼˜å…ˆçº§åªæ˜¯è·å¾—è°ƒåº¦çš„æ¦‚ç‡ä½**ï¼Œå¹¶éä¸€å®šæ˜¯åœ¨é«˜ä¼˜å…ˆçº§çº¿ç¨‹ä¹‹åæ‰è¢«è°ƒç”¨ã€‚çœ‹ä¸Šé¢ yield çš„ä»£ç æµ‹è¯•ã€‚





## å¸¸ç”¨æ–¹æ³•â€”join ğŸ”¥

### join

`join([long n])`ï¼š**çº¿ç¨‹æ’é˜Ÿ**ã€‚**åº•å±‚å°±æ˜¯ wait**

å½“**æŸä¸ªç¨‹åºæ‰§è¡Œæµä¸­è°ƒç”¨**å…¶ä»–çº¿ç¨‹çš„`join()`æ–¹æ³•æ—¶ï¼Œ**æ‰§è¡Œæµçº¿ç¨‹**å°†è¿›å…¥**WAITING æˆ– TIMED_WAITING**ï¼Œç›´åˆ°`join()`æ–¹æ³•åŠ å…¥çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼ˆæˆ–**æœ€å¤šç­‰å¾…næ¯«ç§’**ï¼‰ï¼Œ**æ‰§è¡Œæµçº¿ç¨‹**æ‰è¿›å…¥**RUNNABLEçŠ¶æ€**ã€‚



### ä¸ºä»€ä¹ˆéœ€è¦ joinï¼Ÿ

ä¸‹é¢çš„ä»£ç æ‰§è¡Œï¼Œæ‰“å° r æ˜¯ä»€ä¹ˆï¼Ÿ

```java
@Slf4j(topic = "testJoin")
public class TestJoin {
    static int r = 0;

    public static void main(String[] args) {
        test1();
    }

    private static void test1() {
        log.debug("å¼€å§‹");
        Thread t1 = new Thread(() -> {
            try {
                log.debug("å¼€å§‹");
                TimeUnit.SECONDS.sleep(1);
                log.debug("ç»“æŸ");
                r = 10;
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

        }, "t1");
        t1.start();
        log.debug("ç»“æœä¸º:{}", r);
        log.debug("ç»“æŸ");
    }
}
```

åˆ†æ

*   å› ä¸ºä¸»çº¿ç¨‹å’Œçº¿ç¨‹ t1 æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œt1 çº¿ç¨‹éœ€è¦ 1 ç§’ä¹‹åæ‰èƒ½ç®—å‡º r=10

*   è€Œä¸»çº¿ç¨‹ä¸€å¼€å§‹å°±è¦æ‰“å° r çš„ç»“æœï¼Œæ‰€ä»¥åªèƒ½æ‰“å°å‡º r=0

è§£å†³æ–¹æ³•

*   ç”¨ sleep è¡Œä¸è¡Œï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

    ä¸è¡Œï¼Œä¸çŸ¥é“t1çº¿ç¨‹ç©¶ç«Ÿè¦æ‰§è¡Œå¤šä¹…ï¼Œæ‰€ä»¥mainçº¿ç¨‹æ— æ³•æ§åˆ¶sleepçš„æ—¶é—´

*   ç”¨ joinï¼ŒåŠ åœ¨ t1.start() ä¹‹åå³å¯ã€‚ç›®å‰å¯ä»¥ã€‚ä½†æ˜¯å¯ä»¥ä½¿ç”¨æ›´å¥½çš„ Callable è§£å†³

```java
@Slf4j(topic = "testJoin")
public class TestJoin {

    static int r = 0;

    public static void main(String[] args) throws InterruptedException {
        test1();
    }

    private static void test1() throws InterruptedException {
        log.debug("å¼€å§‹");
        Thread t1 = new Thread(() -> {
            try {
                log.debug("å¼€å§‹");
                TimeUnit.SECONDS.sleep(1);
                log.debug("ç»“æŸ");
                r = 10;
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

        }, "t1");
        t1.start();
        t1.join();
        log.debug("ç»“æœä¸º:{}", r);
        log.debug("ç»“æŸ");
    }
}
```



### ç­‰å¾…å¤šä¸ªç»“æœ

é—®ï¼Œä¸‹é¢ä»£ç ï¼ˆä¼ªä»£ç ï¼‰ cost å¤§çº¦å¤šå°‘ç§’ï¼Ÿ

```java
static int r1 = 0;
static int r2 = 0;
public static void main(String[] args) throws InterruptedException {
    test2();
}

private static void test2() throws InterruptedException {
    Thread t1 = new Thread(() -> {
        sleep(1);
        r1 = 10;
    });
    Thread t2 = new Thread(() -> {
        sleep(2);
        r2 = 20;
    });
    long start = System.currentTimeMillis();
    t1.start();
    t2.start();
    t1.join();
    t2.join();
    long end = System.currentTimeMillis();
    log.debug("r1: {} r2: {} cost: {}", r1, r2, end - start);
}
```

åˆ†æå¦‚ä¸‹

*   ç¬¬ä¸€ä¸ª joinï¼šç­‰å¾… t1 æ—¶ï¼Œt2 å¹¶æ²¡æœ‰åœæ­¢ï¼Œæ­£åœ¨è¿è¡Œ

*   ç¬¬äºŒä¸ª joinï¼š1s åï¼Œæ‰§è¡Œåˆ°æ­¤ï¼Œt2 ä¹Ÿè¿è¡Œäº† 1sï¼Œå› æ­¤ä¹Ÿåªéœ€å†ç­‰å¾… 1sã€‚å³æ€»å…± cost 2ç§’

å¦‚æœé¢ å€’ä¸¤ä¸ª join å‘¢ï¼Ÿä¸€æ ·ï¼





## å¸¸ç”¨æ–¹æ³•â€”interrupt ğŸ”¥

### interruptâ€”ä¸­æ–­çº¿ç¨‹ ğŸ”¥

**è¯·æ±‚ç»ˆæ­¢çº¿ç¨‹**ï¼Œä»…è®¾ç½®äº†ä¸€ä¸ªæ ‡å¿—ä½ï¼Œä¸­æ–­ä¸€ä¸ªä¸åœ¨æ´»åŠ¨çŠ¶æ€ï¼ˆé˜»å¡ï¼‰çš„çº¿ç¨‹**æ²¡æ„ä¹‰å¹¶ä¼šæŠ›å¼‚å¸¸**

*   å¦‚æœ**è¢«æ‰“æ–­çš„çº¿ç¨‹æ­£åœ¨ sleepï¼Œjoinï¼Œwait** ä¼šå¯¼è‡´è¢«æ‰“æ–­çš„çº¿ç¨‹æŠ›å‡º InterruptedExceptionï¼Œå¹¶**æ¸…é™¤æ‰“æ–­æ ‡è®°ï¼ˆç½®ä¸ºfalseï¼‰** 
*   å¦‚æœ**æ‰“æ–­çš„æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹**ï¼Œåˆ™ä¼š**è®¾ç½®æ‰“æ–­æ ‡è®°ï¼ˆç½®ä¸ºtrueï¼‰** ï¼›
*   **park çš„çº¿ç¨‹è¢«æ‰“æ–­**ï¼Œä¹Ÿä¼š**è®¾ç½®æ‰“æ–­æ ‡è®°ï¼ˆç½®ä¸ºtrueï¼‰**



### æ™®é€šæ–¹æ³• isInterruptedâ€”çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ ğŸ”¥

**ä¸ä¼šæ¸…é™¤ä¸­æ–­æ ‡å¿—ä½**



### é™æ€æ–¹æ³• interruptedâ€”çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­

**ä¼šæ¸…é™¤ä¸­æ–­æ ‡å¿—ä½ï¼ï¼ï¼**



### æ‰“æ–­çº¿ç¨‹æ­£åœ¨ sleepï¼Œjoinï¼Œwait çš„çº¿ç¨‹â€”æ²¡æ„ä¹‰

```java
@Slf4j(topic = "testInterrupt1")
public class TestInterrupt1 {
    public static void main(String[] args) throws InterruptedException {
        test1();
    }


    private static void test1() throws InterruptedException {
        Runnable task1 = () -> {
            try {
                log.debug("sleep...");
                TimeUnit.SECONDS.sleep(5);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        };

        Thread t1 = new Thread(task1, "t1");
        t1.start();

        TimeUnit.SECONDS.sleep(1);// 
        log.debug("interrupt...");
        t1.interrupt();
        TimeUnit.MILLISECONDS.sleep(50);// æ‰“å°å‰å¿…é¡»å†ç­‰å¾…ä¸‹ï¼Œå› ä¸ºä¸­æ–­æ ‡è®°æ¸…é™¤æ¯”è¾ƒæ…¢ï¼
        log.debug("ä¸­æ–­æ ‡è®°ï¼š{}", t1.isInterrupted());// false
    }
}
```



### æ‰“æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹

```java
@Slf4j(topic = "testInterrupt1")
public class TestInterrupt1 {
    public static void main(String[] args) throws InterruptedException {
        test2();
    }

    private static void test2() throws InterruptedException {
        Runnable task1 = () -> {
            log.debug("running...");
            // è¿™é‡Œè¦æ˜¯æ”¹ä¸º sleep ï¼Œåˆ™ä¸­æ–­æ ‡è®°å°†è¢«ç½®ä¸º false
            while (true) {
                // å¿…é¡»æ‰‹åŠ¨é€€å‡ºï¼Œå¦åˆ™ä¸€ç›´æ‰§è¡Œã€‚å¯ä»¥ç”¨äºä¼˜é›…åœæ­¢ï¼ 
                boolean flag = Thread.currentThread().isInterrupted();
                if (flag){
                    log.debug("è¢«æ‰“æ–­äº†ï¼Œæˆ‘ä¸»åŠ¨é€€å‡º");
                    break;
                }
            }
        };

        Thread t1 = new Thread(task1, "t1");
        t1.start();

        TimeUnit.SECONDS.sleep(1);// main çº¿ç¨‹ç¡1ç§’ï¼Œé˜²æ­¢t1çº¿ç¨‹è¿˜æœªæ‰§è¡Œ
        log.debug("interrupt...");
        t1.interrupt();
        TimeUnit.MILLISECONDS.sleep(50);// æ‰“å°å‰å¿…é¡»å†ç­‰å¾…ä¸‹ï¼Œå› ä¸ºä¸­æ–­æ ‡è®°æ¸…é™¤æ¯”è¾ƒæ…¢ï¼
        log.debug("ä¸­æ–­æ ‡è®°ï¼š{}", t1.isInterrupted());// true
    }
}
```















## å…¶ä»–æ–¹æ³•

- `boolean isAlive()`ï¼šåˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¿˜**å­˜æ´»**ï¼Œè¿˜æ²¡æœ‰è¿è¡Œå®Œæ¯•

- ~~`th.stop()`ï¼š`@Deprecated(since="1.2")`~~

- `Enum getState()`ï¼šè·å–çº¿ç¨‹çŠ¶æ€

    Java ä¸­çº¿ç¨‹çŠ¶æ€æ˜¯ç”¨ 6 ä¸ª enum è¡¨ç¤ºï¼Œåˆ†åˆ«ä¸ºï¼šNEW, RUNNABLE, BLOCKED, WAITING, TIMED_WAITING, TERMINATEDã€‚è¯¦ç»†è§çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ





## çº¿ç¨‹çš„åˆ†ç±» ğŸ”¥

å®ˆæŠ¤çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹åœ¨å‡ ä¹æ¯ä¸ªæ–¹é¢éƒ½æ˜¯ç›¸åŒçš„ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯**åˆ¤æ–­ JVM ä½•æ—¶ç¦»å¼€**

- å®ˆæŠ¤çº¿ç¨‹ï¼ˆåå°çº¿ç¨‹ï¼Œå¦‚å¦å…‹å¤§æˆ˜ï¼‰
    - **å®ˆæŠ¤çº¿ç¨‹æ˜¯ç”¨æ¥æœåŠ¡ç”¨æˆ·çº¿ç¨‹çš„**ï¼Œé€šè¿‡åœ¨`start()`æ–¹æ³•å‰è°ƒç”¨`th.setDaemon(true)`å¯ä»¥æŠŠä¸€ä¸ªç”¨æˆ·çº¿ç¨‹å˜æˆä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹
    - **Java åƒåœ¾å›æ”¶**å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„å®ˆæŠ¤çº¿ç¨‹
    - **è‹¥ JVM ä¸­éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œå½“å‰ JVM å°†é€€å‡º**
- ç”¨æˆ·çº¿ç¨‹











## çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ ğŸ”¥

å½“çº¿ç¨‹è¢«åˆ›å»ºå¹¶å¯åŠ¨ä»¥åï¼Œå®ƒæ—¢ä¸æ˜¯ä¸€å¯åŠ¨å°±è¿›å…¥äº†æ‰§è¡ŒçŠ¶æ€ï¼Œä¹Ÿä¸æ˜¯ä¸€ç›´å¤„äºæ‰§è¡ŒçŠ¶æ€ã€‚åœ¨çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œ æœ‰å‡ ç§çŠ¶æ€å‘¢ï¼Ÿåœ¨ API ä¸­ **`java.lang.Thread`** **ä¸­çš„`State`å†…éƒ¨æšä¸¾ç±»ä¸­ç»™å‡ºäº†å…­ç§çº¿ç¨‹çŠ¶æ€**ï¼š

- **æ–°å»º**ï¼šå½“ä¸€ä¸ª Thread ç±»æˆ–å…¶å­ç±»çš„å¯¹è±¡è¢«å£°æ˜å¹¶åˆ›å»ºæ—¶ï¼Œä½†æ˜¯å¹¶æœªå¯åŠ¨å³è°ƒç”¨ `start()`ï¼Œæ–°ç”Ÿçš„çº¿ç¨‹å¯¹è±¡å¤„äºæ–°å»ºçŠ¶æ€

    > **NEW**ï¼šThread state for a thread which has not yet started.

- **å¯è¿è¡Œ**ï¼šå¤„äºæ–°å»ºçŠ¶æ€çš„çº¿ç¨‹è¢«`start()`åï¼Œå¯èƒ½æ­£åœ¨ JVM ä¸­æ‰§è¡Œï¼Œä¹Ÿå¯èƒ½æ­£åœ¨ç­‰å¾…æ¥è‡ªæ“ä½œç³»ç»Ÿçš„å…¶ä»–èµ„æºå¦‚å¤„ç†å™¨

    > **RUNNABLE**ï¼šstate for a runnable thread. A thread in the runnable state is executing in the Java virtual machine but it may be waiting for other resources from the operating system such as processor.

- **é˜»å¡**ï¼šå½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è·å–ä¸€ä¸ªå¯¹è±¡é”ï¼Œè€Œè¯¥å¯¹è±¡é”è¢«å…¶ä»–çš„çº¿ç¨‹æŒæœ‰ï¼Œåˆ™è¯¥çº¿ç¨‹è¿›å…¥ Blocked çŠ¶æ€ï¼›å½“è¯¥çº¿ç¨‹æŒæœ‰é”æ—¶ï¼Œè¯¥çº¿ç¨‹å°†å˜æˆ Runnable çŠ¶æ€ã€‚

    > **BLOCKED**ï¼šThread state for a thread blocked waiting for a monitor lock.A thread in the blocked state is waiting for a monitor lock to enter a synchronized block/method or reenter a synchronized block/method after calling `Object.wait`.

- **æ— é™ç­‰å¾…**ï¼šä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸€ä¸ªï¼ˆå”¤é†’ï¼‰åŠ¨ä½œæ—¶ï¼Œè¯¥çº¿ç¨‹è¿›å…¥ Waiting çŠ¶æ€ã€‚è¿™ä¸ªçŠ¶æ€åæ˜¯ä¸èƒ½è‡ªåŠ¨å”¤é†’çš„

    > **WAITING**ï¼šstate for a waiting thread.A thread is in the waiting state due to calling one of the following methods:
    >
    > - `Object.wait` with no timeout
    >
    > - `th.join` with no timeout
    >
    > - `LockSupport.park`
    >
    >     A thread in the waiting state is waiting for another thread to perform a particular action.
    >
    > For example, a thread that has called `Object.wait()` on an object is waiting for another thread to call `Object.notify()` or `Object.notifyAll()` on that object. A thread that has called `th.join()` is waiting for a specified thread to terminate.

- **è®¡æ—¶ç­‰å¾…**ï¼šåŒ waiting çŠ¶æ€ï¼Œæœ‰å‡ ä¸ªæ–¹æ³•æœ‰è¶…æ—¶å‚æ•°ï¼Œè°ƒç”¨ä»–ä»¬å°†è¿›å…¥ Timed Waiting çŠ¶æ€ã€‚è¿™ä¸€çŠ¶æ€å°†ä¸€ç›´ä¿æŒåˆ°è¶…æ—¶æœŸæ»¡æˆ–è€…æ¥æ”¶åˆ°å”¤é†’é€šçŸ¥ã€‚

    > **TIMED_WAITING**ï¼šThread state for a waiting thread with a specified waiting time. A thread is in the timed waiting state due to calling one of the following methods with a specified positive waiting time:
    >
    > - `Thread.sleep`must with timeout
    > - `Object.wait` with timeout
    > - `th.join` with timeout
    > - `LockSupport.parkNanos`
    > - `LockSupport.parkUntil`

- **è¢«ç»ˆæ­¢**ï¼šå› ä¸º`run`æ–¹æ³•æ­£å¸¸é€€å‡ºè€Œç»ˆæ­¢ï¼ˆå®Œæˆå…¨éƒ¨å·¥ä½œï¼‰ï¼Œæˆ–è€…å› ä¸ºæ²¡æœ‰æ•è·çš„å¼‚å¸¸ç»ˆæ­¢äº†`run`æ–¹æ³•è€Œæ­»äº¡ï¼Œæˆ–è€…æˆ–çº¿ç¨‹è¢«æå‰å¼ºåˆ¶æ€§åœ°ä¸­æ­¢ã€‚

    > TERMINATEDï¼šThread state for a terminated thread. The thread has completed execution.

<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:645px;" src="https://www.processon.com/embed/60267a51f346fb64f5655b6a"></iframe>



é‡Šæ”¾é”å’Œä¸é‡Šæ”¾é”çš„æ“ä½œï¼ˆæœªå®Œï¼‰

é‡Šæ”¾é”çš„æ“ä½œ

- å½“å‰çº¿ç¨‹çš„åŒæ­¥æ–¹æ³•ã€åŒæ­¥ä»£ç å—**æ‰§è¡Œç»“æŸ**ã€‚
- å½“å‰çº¿ç¨‹åœ¨åŒæ­¥ä»£ç å—ã€åŒæ­¥æ–¹æ³•ä¸­é‡åˆ°**breakã€return ç»ˆæ­¢**äº†è¯¥ä»£ç å—ã€è¯¥æ–¹æ³•çš„ç»§ç»­æ‰§è¡Œã€‚
- å½“å‰çº¿ç¨‹åœ¨åŒæ­¥ä»£ç å—ã€åŒæ­¥æ–¹æ³•ä¸­å‡ºç°äº†**æœªå¤„ç†çš„ Error æˆ– Exceptionï¼Œå¯¼è‡´å¼‚å¸¸ç»“æŸ**ã€‚
- å½“å‰çº¿ç¨‹åœ¨åŒæ­¥ä»£ç å—ã€åŒæ­¥æ–¹æ³•ä¸­æ‰§è¡Œäº†çº¿ç¨‹å¯¹è±¡çš„**`wait()`æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹æš‚åœï¼Œå¹¶é‡Šæ”¾é”**ã€‚

ä¸é‡Šæ”¾é”çš„æ“ä½œ

- çº¿ç¨‹æ‰§è¡ŒåŒæ­¥ä»£ç å—æˆ–åŒæ­¥æ–¹æ³•æ—¶ï¼Œç¨‹åºè°ƒç”¨`Thread.sleep()`ã€`Thread.yield()`æ–¹æ³•æš‚åœå½“å‰çº¿ç¨‹çš„æ‰§è¡Œ

- çº¿ç¨‹æ‰§è¡ŒåŒæ­¥ä»£ç å—æ—¶ï¼Œå…¶ä»–çº¿ç¨‹è°ƒç”¨äº†è¯¥çº¿ç¨‹çš„`suspend()`æ–¹æ³•å°†è¯¥çº¿ç¨‹ æŒ‚èµ·ï¼Œè¯¥çº¿ç¨‹ä¸ä¼šé‡Šæ”¾é”(åŒæ­¥ç›‘è§†å™¨)

    åº”å°½é‡é¿å…ä½¿ç”¨`suspend()`å’Œ`resume()`æ¥æ§åˆ¶çº¿ç¨‹





## OS ä¸­æŸ¥çœ‹çº¿ç¨‹è¿›ç¨‹çš„æ–¹å¼

### Windows

*   ä»»åŠ¡ç®¡ç†å™¨å¯ä»¥æŸ¥çœ‹è¿›ç¨‹å’Œçº¿ç¨‹æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ€æ­»è¿›ç¨‹

*   `tasklist` æŸ¥çœ‹è¿›ç¨‹

    `tasklist | findstr java`

*   `taskkill` æ€æ­»è¿›ç¨‹



### Linux

*   `ps -ef` æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹
*   `ps -fT -p <PID>` æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹
*   `kill` æ€æ­»è¿›ç¨‹
*   `top` æŒ‰å¤§å†™ H åˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºçº¿ç¨‹
*   `top -H -p <PID>` æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹ï¼Ÿ





### Java

*   `jps` å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹

    `jps | grep Test`

*   `jstack <PID>` æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ï¼ˆPIDï¼‰æŸä¸€åˆ»çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€ï¼ˆå¿«ç…§ï¼‰

*   `jconsole` æ¥æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼ˆå›¾å½¢ç•Œé¢ï¼‰

    éœ€è¦ä»¥å¦‚ä¸‹æ–¹å¼è¿è¡Œä½ çš„ java ç±»

    ```bash
    java -Djava.rmi.server.hostname=`ipåœ°å€` -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=`è¿æ¥ç«¯å£` -Dcom.sun.management.jmxremote.ssl=æ˜¯å¦å®‰å…¨è¿æ¥ -Dcom.sun.management.jmxremote.authenticate=æ˜¯å¦è®¤è¯ javaç±»
    ```

    ä¿®æ”¹ /etc/hosts æ–‡ä»¶å°† 127.0.0.1 æ˜ å°„è‡³ä¸»æœºå

    å¦‚æœè¦è®¤è¯è®¿é—®ï¼Œè¿˜éœ€è¦åšå¦‚ä¸‹æ­¥éª¤

    *   å¤åˆ¶ jmxremote.password æ–‡ä»¶
    *   ä¿®æ”¹ jmxremote.password å’Œ jmxremote.access æ–‡ä»¶çš„æƒé™ä¸º 600 å³æ–‡ä»¶æ‰€æœ‰è€…å¯è¯»å†™
    *   è¿æ¥æ—¶å¡«å…¥ controlRoleï¼ˆç”¨æˆ·åï¼‰ï¼ŒR&Dï¼ˆå¯†ç ï¼‰





## çº¿ç¨‹è¿è¡ŒåŸç† ğŸ”¥

### Java Virtual Machine

JVM ç”±å †ã€æ–¹æ³•åŒºã€è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆã€ç¨‹åºè®¡æ•°å™¨æ‰€ç»„æˆï¼Œå…¶ä¸­æ ˆå†…å­˜æ˜¯ç»™è°ç”¨çš„å‘¢ï¼Ÿå…¶å®å°±æ˜¯çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯åŠ¨åï¼Œè™šæ‹Ÿæœºå°±ä¼šä¸ºå…¶åˆ†é…ä¸€å—æ ˆå†…å­˜ã€‚

*   **æ¯ä¸ªæ ˆ**ç”±å¤šä¸ª**æ ˆå¸§ï¼ˆFrameï¼‰**ç»„æˆï¼Œå¯¹åº”ç€**æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜**ã€‚
*   **æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§**ï¼Œå¯¹åº”ç€å½“å‰**æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•**ã€‚

ç”»ä¸ªå›¾å°±å¾ˆå¥½ç†è§£äº†ï¼ˆå…·ä½“è¿˜éœ€è¦å­¦ä¹ JVMï¼‰

<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:545px;" src="https://www.processon.com/embed/602623c4e0b34d208a7f6e4b"></iframe>

å¤šä¸ªçº¿ç¨‹ debug æ—¶å¯ä»¥å¯¹è¦æŸ¥çœ‹çš„å¤šä¸ªçº¿ç¨‹éƒ½è®¾ç½® suspendï¼ˆæŒ‚èµ·ï¼‰ä¸º Threadï¼Œæ‰èƒ½è®©çº¿ç¨‹åˆ†åˆ«æŒ‚èµ·ï¼Œåˆ†åˆ«è°ƒè¯•

![image-20210212164420036](../images/image-20210212164420036.png)



### çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢

Thread Context Switch

å› ä¸ºä»¥ä¸‹ä¸€äº›åŸå› å¯¼è‡´ cpu ä¸å†æ‰§è¡Œå½“å‰çš„çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç 

*   çº¿ç¨‹çš„ cpu æ—¶é—´ç‰‡ç”¨å®Œ
*   åƒåœ¾å›æ”¶
*   æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ
*   çº¿ç¨‹è‡ªå·±è°ƒç”¨äº† sleepã€yieldã€waitã€joinã€parkã€synchronizedã€lock ç­‰æ–¹æ³•

å½“ Context Switch å‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿ**ä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€**ï¼Œå¹¶**æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€**ï¼ŒJava ä¸­å¯¹åº”çš„æ¦‚å¿µå°±æ˜¯**ç¨‹åºè®¡æ•°å™¨**ï¼ˆProgram Counter Registerï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯**è®°ä½ä¸‹ä¸€æ¡ jvm æŒ‡ä»¤çš„æ‰§è¡Œåœ°å€**ï¼Œæ˜¯**çº¿ç¨‹ç§æœ‰**çš„

*   çŠ¶æ€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰

*   Context Switch é¢‘ç¹å‘ç”Ÿä¼šå½±å“æ€§èƒ½





### Java å¤šçº¿ç¨‹çš„è¿è¡Œè¿‡ç¨‹ ğŸ”¥

**Java ç¨‹åºè¿è¡ŒåŸç†ï¼ˆå¤šçº¿ç¨‹ï¼‰**ï¼šç”± Java å‘½ä»¤å¯åŠ¨ JVMï¼ˆç›¸å½“äºå¯åŠ¨äº†ä¸€ä¸ªè¿›ç¨‹ï¼‰ï¼Œæ¥ç€ç”±è¯¥è¿›ç¨‹åˆ›å»ºå¯åŠ¨å¤šä¸ªçº¿ç¨‹ï¼Œè‡³å°‘ä¸‰ä¸ªçº¿ç¨‹å¯ä»¥åˆ†æå‡ºæ¥ï¼š**æ‰§è¡Œ main()å‡½æ•°çš„ä¸»çº¿ç¨‹**ï¼Œè¯¥çº¿ç¨‹çš„ä»»åŠ¡ä»£ç éƒ½å®šä¹‰åœ¨ main å‡½æ•°ä¸­ï¼Œ**è´Ÿè´£åƒåœ¾å›æ”¶çš„ GC çº¿ç¨‹**ï¼Œä»¥åŠ**å¼‚å¸¸å¤„ç†çº¿ç¨‹**

- å¤šçº¿ç¨‹æ‰§è¡Œæ—¶ï¼Œå…¶å®**æ¯ä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹**éƒ½æœ‰ä¸€ç‰‡è‡ªå·±**æ‰€å±çš„æ ˆå†…å­˜**ç©ºé—´ï¼ˆè¿˜æœ‰ PCï¼‰ã€‚è¿›è¡Œ**æ–¹æ³•çš„å‹æ ˆå’Œå¼¹æ ˆ**ã€‚

![](../images/stack.png)





- 

## 7.4 çº¿ç¨‹å®‰å…¨å’ŒåŒæ­¥

### çº¿ç¨‹å®‰å…¨é—®é¢˜

- **å–ç¥¨é—®é¢˜**

    - ç›¸åŒçš„ç¥¨å‡ºç°å¤šæ¬¡ï¼šCPU çš„ä¸€æ¬¡æ“ä½œå¿…é¡»æ˜¯åŸå­æ€§çš„ï¼ˆä½†æ˜¯è¾“å‡ºè¯­å¥ä¸æ˜¯åŸå­çš„ï¼‰
    - å‡ºç°è´Ÿæ•°çš„ç¥¨ï¼šéšæœºæ€§å’Œå»¶è¿Ÿå¯¼è‡´

- **çº¿ç¨‹å®‰å…¨é—®é¢˜äº§ç”ŸåŸå› **

    - å¤šä¸ªçº¿ç¨‹åœ¨æ“ä½œå…±äº«æ•°æ®

    - æ“ä½œå…±äº«æ•°æ®çš„ä»£ç æœ‰å¤šæ¡

        **å½“ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œæ“ä½œå…±äº«æ•°æ®çš„å¤šæ¡ä»£ç ï¼ˆéåŸå­æ“ä½œï¼‰è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–çº¿ç¨‹å‚ä¸äº†è¿ç®—ï¼Œå°±ä¼šå¯¼è‡´**

### çº¿ç¨‹åŒæ­¥

è¦è§£å†³ä¸Šè¿°å¤šçº¿ç¨‹å¹¶å‘è®¿é—®ä¸€ä¸ªèµ„æºçš„å®‰å…¨æ€§é—®é¢˜ï¼šä¹Ÿå°±æ˜¯è§£å†³é‡å¤ç¥¨ä¸ä¸å­˜åœ¨ç¥¨é—®é¢˜ï¼ŒJava ä¸­æä¾›äº†**åŒæ­¥æœºåˆ¶ (synchronized)**æ¥è§£å†³ã€‚æœ‰ä¸‰ç§æ–¹å¼å®ŒæˆåŒæ­¥æ“ä½œï¼š**åŒæ­¥ä»£ç å—**ã€**åŒæ­¥æ–¹æ³•**ã€**Lock é”æœºåˆ¶**ã€‚

- **åŒæ­¥çš„ä¼˜ç¼ºç‚¹ï¼š**
    - **å¥½å¤„**ï¼šè§£å†³çº¿ç¨‹çš„å®‰å…¨é—®é¢˜
    - **å¼Šç«¯**ï¼šç›¸å¯¹**é™ä½æ•ˆç‡**ï¼Œå› ä¸ºåŒæ­¥å¤–çš„çº¿ç¨‹éƒ½ä¼šåˆ¤æ–­åŒæ­¥é”ï¼›è‹¥æœ‰**åŒæ­¥åµŒå¥—å®¹æ˜“äº§ç”Ÿæ­»é”**

#### åŒæ­¥ä»£ç å—

- `synchronized`å…³é”®å­—å¯ä»¥ç”¨äº**æ–¹æ³•ä¸­çš„æŸä¸ªåŒºå—ä¸­**ï¼Œè¡¨ç¤ºåªå¯¹è¿™ä¸ªåŒºå—çš„**èµ„æºå®è¡Œäº’æ–¥è®¿é—®**

    - **åŒæ­¥é”**ï¼šä¹Ÿç§°**å¯¹è±¡é”**æˆ–å¯¹è±¡**ç›‘è§†å™¨**
        - é”å¯¹è±¡å¯ä»¥æ˜¯**ä»»æ„ç±»å‹**
        - å¤šä¸ªçº¿ç¨‹å¯¹è±¡è¦ä½¿ç”¨**åŒä¸€æŠŠé”**

    ```java
    public class Ticket implements Runnable {
    
        private int ticketCount = 100;
    	private static final Object monitorLock = new Object();
    
        @Override
        public void run() {
            // å–ç¥¨çª—å£ä¸€ç›´å¼€ç€ï¼Œä¸èƒ½åœ¨åŒæ­¥ä¸­ï¼Œå¦åˆ™å°±ä¼šè¢«ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œ
            while (true) {
                // synchronized éœ€åœ¨å†…éƒ¨å†™ï¼Œå¦åˆ™å…¶ä»–çº¿ç¨‹ä¼šè¿›ä¸å»ã€‚ç±»ä¼¼è¿›å…¥å•æ‰€ç„¶åé”é—¨ã€‚éœ€è¦åŒ…è£¹æ“ä½œå…±äº«èµ„æºçš„ä»£ç ã€‚
                // è¿˜å¯ä»¥å†™ thisï¼ˆæ³¨æ„å”¯ä¸€æ€§ï¼‰ã€Ticket.class
                synchronized (monitorLock) {
                    if (ticketCount > 0) {
                        try {
                            // è¿›å…¥time waitingï¼Œæé«˜é”™ç¥¨å‡ ç‡
                            Thread.sleep(10);
                        } catch (Exception e) {
                            e.printStackTrace();
                        }
                        System.out.println(Thread.currentThread().getName() + "å–ç¥¨ï¼Œç¥¨å·ï¼š" + ticketCount);
                        ticketCount--;
                    } else {
                        break;
                    }
                }
            }
        }
    }
    ```

#### åŒæ­¥æ–¹æ³•

- ä½¿ç”¨`synchronized`ä¿®é¥°çš„æ–¹æ³•å°±å«åšåŒæ­¥æ–¹æ³•ï¼Œä¿è¯ A çº¿ç¨‹æ‰§è¡Œè¯¥æ–¹æ³•çš„æ—¶å€™å…¶ä»–çº¿ç¨‹åªèƒ½åœ¨æ–¹æ³•å¤–ç­‰ç€ã€‚

    - **åŒæ­¥é”æ˜¯è°**?

        - å¯¹äº**é static æ–¹æ³•**ï¼ŒåŒæ­¥é”å°±æ˜¯**this**ï¼Œæ­¤æ—¶ä»£è¡¨è°ƒç”¨ run æ–¹æ³•çš„å¯¹è±¡

        - å¯¹äº**static æ–¹æ³•**ï¼Œæˆ‘ä»¬ä½¿ç”¨å½“å‰æ–¹æ³•æ‰€åœ¨ç±»çš„å­—èŠ‚ç å¯¹è±¡(**ç±»å.class**)

            ä½¿ç”¨ç»§æ‰¿ Thread ç±»å’ŒåŒæ­¥æ–¹æ³•å®ç°æ—¶ï¼Œéœ€è¦å†™ `static synchronized`

    ```java
    public /*static*/ synchronized void sellTicket(){
         // TODO
    }
    ```

#### Lock é”

- ä» JDK 5.0 å¼€å§‹ï¼ŒJava æä¾›äº†æ›´å¼ºå¤§çš„çº¿ç¨‹åŒæ­¥æœºåˆ¶â€”â€”é€šè¿‡**æ˜¾å¼å®šä¹‰åŒæ­¥é”å¯¹è±¡**æ¥å®ç°åŒæ­¥ã€‚`java.util.concurrent.locks.Lock` **æ¥å£**æœºåˆ¶æä¾›äº†æ¯”`synchronized`ä»£ç å—å’Œ`synchronized`æ–¹æ³•æ›´å¹¿æ³›çš„é”å®šæ“ä½œï¼ŒåŒæ­¥ä»£ç å—/åŒæ­¥æ–¹æ³•å…·æœ‰çš„åŠŸèƒ½ Lock éƒ½æœ‰ï¼Œé™¤æ­¤ä¹‹å¤–æ›´å¼ºå¤§ï¼Œæ›´ä½“ç°é¢å‘å¯¹è±¡ã€‚

- **Lock æ¥å£çš„å®ç°ç±»`ReentrantLock`**ã€‚å¯åœ¨æ„é€ æ–¹æ³•ä¸­è®¾ç½®æ˜¯å¦ä¸º**å…¬å¹³é”**ï¼ˆæŒ‰ FIFO é˜Ÿåˆ—ï¼‰ï¼Œä½†æ˜¯æ•ˆç‡å¯èƒ½ä¼šå˜ä½ã€‚

- **Lock é”ä¹Ÿç§°åŒæ­¥é”**ï¼ŒåŠ é”ä¸é‡Šæ”¾é”æ–¹æ³•åŒ–äº†ï¼Œå¦‚ä¸‹ï¼š

    - `void lock()`ï¼š**åŠ åŒæ­¥é”**

    - `void unlock()`ï¼š**é‡Šæ”¾åŒæ­¥é”**

        ```java
        public class Ticket implements Runnable {
        
            private int count = 100;
            private Lock lock = new ReentrantLock();
        
            @Override
            public void run() {
                while (true) {
                    try {
                        // åŠ åŒæ­¥é”
                        lock.lock();
                        if (count > 0) {
                            try {
                                Thread.sleep(10);
                                System.out.println(Thread.currentThread().getName() + "-->æ­£åœ¨å–ç¬¬" + count + "å¼ ç¥¨");
                                count--;
                            } catch (InterruptedException e) {
                                e.printStackTrace();
                            }
                        } else {
                            break;
                        }
                    } finally {
                        // é‡Šæ”¾åŒæ­¥é”
                        lock.unlock();
                    }
                }
            }
        
            public static void main(String[] args) {
                Ticket ticket = new Ticket();
                new Thread(ticket, "çª—å£1").start();
                new Thread(ticket, "çª—å£2").start();
                new Thread(ticket, "çª—å£3").start();
            }
        }
        ```

### æ­»é”é—®é¢˜(å“²å­¦å®¶å°±é¤)

- æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„çº¿ç¨‹åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå› **äº‰å¤ºèµ„æº**äº§ç”Ÿçš„ä¸€ç§**äº’ç›¸ç­‰å¾…**ç°è±¡

    ä¸è¦ä½¿ç”¨ String æ¥åšé”ã€‚å¦‚ï¼šString s1 = "Hello" å’Œ String s2 = "Hello" å…¶å®æ˜¯åŒä¸€æŠŠé”ï¼›è¿˜ä¼šå¯èƒ½ä¸å…¶ä»–ç±»åº“å‘ç”Ÿæ­»é”ã€‚

    ```java
    public class DeadLock {
        private static Object lock1 = new Object();
        private static Object lock2 = new Object();
    
        public static void main(String[] args) {
            new Thread(() -> {
                synchronized (lock1) {
                    System.out.println("t1 get lock1");
                    // å¯åœ¨æ­¤å¤„sleepæé«˜æ­»é”æ¦‚ç‡
                    synchronized (lock2) {
                        System.out.println("t1 get lock2");
                    }
                }
            }, "t1").start();
    
            new Thread(() -> {
                synchronized (lock2) {
                    System.out.println("t2 get lock2");
                    // å¯åœ¨æ­¤å¤„sleepæé«˜æ­»é”æ¦‚ç‡
                    synchronized (lock1) {
                        System.out.println("t2 get lock1");
                    }
                }
            }, "t2").start();
        }
    }
    // å¯èƒ½å‡ºç°çš„ç»“æœæœ‰ï¼š
    // 1
    t1 get lock1
    t1 get lock2
    t2 get lock2
    t2 get lock1
    // 2
    t2 get lock2
    t2 get lock1
    t1 get lock1
    t1 get lock2
    // 3
    t1 get lock1
    t2 get lock2
    // 4
    t2 get lock2
    t1 get lock1
    ```

## 7.5 çº¿ç¨‹é—´é€šä¿¡

**å¤šä¸ªçº¿ç¨‹åœ¨å¤„ç†åŒä¸€ä¸ªèµ„æºï¼Œä½†æ˜¯å¤„ç†çš„åŠ¨ä½œï¼ˆçº¿ç¨‹çš„ä»»åŠ¡ï¼‰å´ä¸ç›¸åŒ**ã€‚

å¤šä¸ªçº¿ç¨‹åœ¨å¤„ç†åŒä¸€ä¸ªèµ„æºï¼Œå¹¶ä¸”ä»»åŠ¡ä¸åŒæ—¶ï¼Œéœ€è¦çº¿ç¨‹é€šä¿¡æ¥å¸®åŠ©è§£å†³çº¿ç¨‹ä¹‹é—´å¯¹åŒä¸€ä¸ªå˜é‡çš„ä½¿ç”¨æˆ–æ“ä½œã€‚ å°±æ˜¯å¤šä¸ªçº¿ç¨‹åœ¨æ“ä½œåŒä¸€ä»½æ•°æ®æ—¶ï¼Œ é¿å…å¯¹åŒä¸€å…±äº«å˜é‡çš„äº‰å¤ºã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€å®šçš„æ‰‹æ®µä½¿å„ä¸ªçº¿ç¨‹èƒ½æœ‰æ•ˆçš„åˆ©ç”¨èµ„æºã€‚è€Œè¿™ç§æ‰‹æ®µå³â€”â€” ç­‰å¾…å”¤é†’æœºåˆ¶ã€‚

### ç­‰å¾…å”¤é†’æœºåˆ¶

å°±æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œäº†è§„å®šæ“ä½œåï¼Œå°±è¿›å…¥ç­‰å¾…çŠ¶æ€`wait()`ï¼Œ ç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œä»–ä»¬çš„æŒ‡å®šä»£ç è¿‡å å†å°†å…¶å”¤é†’`notify()`ï¼›åœ¨æœ‰å¤šä¸ªçº¿ç¨‹è¿›è¡Œç­‰å¾…æ—¶ï¼Œ å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä½¿ç”¨ `notifyAll()`æ¥å”¤é†’æ‰€æœ‰çš„ç­‰å¾…çº¿ç¨‹ã€‚ wait/notify å°±æ˜¯çº¿ç¨‹é—´çš„ä¸€ç§åä½œæœºåˆ¶ã€‚

- **`Object`ç±»**ï¼ˆä»»æ„é”ï¼‰ä¸­æä¾›äº†ä¸‰ä¸ªæ–¹æ³•ã€‚è¿™äº›æ–¹æ³•å¿…é¡»é€šè¿‡**åŒä¸€ä¸ªé”å¯¹è±¡ï¼ˆthis è°ƒç”¨æˆ–å…¶ä»–åŒä¸€å¯¹è±¡è°ƒç”¨ï¼‰åœ¨åŒæ­¥ä¸­ï¼ˆåŒæ­¥ä»£ç å—ã€åŒæ­¥æ–¹æ³•ï¼‰è°ƒç”¨ï¼Œå¦åˆ™æŠ¥`IllegalMonitorStateException`é”™ã€‚**Lock æœ‰å…¶è‡ªå·±çš„æ–¹æ³•ã€‚
    - `wait([long timeout])`ï¼š**ç­‰å¾…**å¹¶ç«‹å³**é‡Šæ”¾é”**ï¼Œçº¿ç¨‹è¿›å…¥ WAITINGã€‚**è¢«å”¤é†’è‹¥è·å¾—é”åä»æ–­ç‚¹å¤„æ‰§è¡Œåç»­ä»£ç **
    - `notify()`ï¼šå”¤é†’æ­£åœ¨æ’é˜Ÿç­‰å¾…åŒæ­¥èµ„æºçš„çº¿ç¨‹ä¸­ä¼˜å…ˆçº§æœ€é«˜è€…ç»“æŸç­‰å¾…ï¼Œä½†**ä¸é‡Šæ”¾é”**ï¼Œè¢«é€šçŸ¥çº¿ç¨‹ä¸èƒ½ç«‹å³æ¢å¤æ‰§è¡Œçº¿ç¨‹ï¼Œ**éœ€é‡æ–°è¯·æ±‚åŒæ­¥é”**
    - `notifyAll()`ï¼šå”¤é†’æ­£åœ¨æ’é˜Ÿç­‰å¾…èµ„æºçš„æ‰€æœ‰çº¿ç¨‹ç»“æŸç­‰å¾…

> å“ªæ€•åªé€šçŸ¥äº†ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ï¼Œè¢«é€šçŸ¥çº¿ç¨‹ä¹Ÿä¸èƒ½ç«‹å³æ¢å¤æ‰§è¡Œï¼Œå› ä¸ºå®ƒå½“åˆä¸­æ–­çš„åœ°æ–¹æ˜¯åœ¨åŒæ­¥å—å†…ï¼Œè€Œæ­¤åˆ»å®ƒå·²ç»ä¸æŒæœ‰é”ï¼Œæ‰€ä»¥å¥¹éœ€è¦å†æ¬¡å°è¯•å»è·å–é”ï¼ˆå¾ˆå¯èƒ½é¢ä¸´å…¶å®ƒçº¿ç¨‹çš„ç«äº‰ï¼‰ï¼ŒæˆåŠŸåæ‰èƒ½åœ¨å½“åˆè°ƒ ç”¨ wait æ–¹æ³•ä¹‹åçš„åœ°æ–¹æ¢å¤æ‰§è¡Œã€‚
> æ€»ç»“å¦‚ä¸‹ï¼š
> å¦‚æœèƒ½è·å–é”ï¼Œçº¿ç¨‹å°±ä» WAITING çŠ¶æ€å˜æˆ RUNNABLE çŠ¶æ€ï¼› å¦åˆ™ï¼Œä» wait set å‡ºæ¥ï¼Œåˆè¿›å…¥ entry setï¼Œçº¿ç¨‹å°±ä» WAITING çŠ¶æ€åˆå˜æˆ BLOCKED çŠ¶æ€ã€‚

### ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜

> ç”Ÿäº§è€…ï¼ˆProductorï¼‰å°†äº§å“äº¤ç»™åº—å‘˜ï¼ˆClerkï¼‰ï¼Œè€Œæ¶ˆè´¹è€…ï¼ˆï¼‰ä»åº—å‘˜å¤„å–èµ°äº§å“ï¼Œåº—å‘˜ä¸€æ¬¡åªèƒ½æŒæœ‰å›ºå®šæ•°é‡çš„äº§å“ï¼ˆæ¯”å¦‚ 20ï¼‰ï¼Œå¦‚æœç”Ÿäº§è€…è¯•å›¾ç”Ÿäº§æ›´å¤šçš„äº§å“ï¼Œåº—å‘˜ä¼šå«ç”Ÿäº§è€…åœä¸€ä¸‹ï¼Œå¦‚æœåº—ä¸­æœ‰ç©ºä½æ”¾äº§å“äº†å†é€šçŸ¥ç”Ÿäº§è€…ç»§ç»­ç”Ÿäº§ï¼›å¦‚æœåº—ä¸­æ²¡æœ‰äº§å“äº†ï¼Œåº—å‘˜ä¼šå‘Šè¯‰æ¶ˆè´¹è€…ç­‰ä¸€ä¸‹ï¼Œå¦‚æœåº—ä¸­æœ‰äº§å“äº†å†é€šçŸ¥æ¶ˆè´¹è€…æ¥å–èµ°äº§å“ã€‚
>
> åˆ†æï¼š
>
> 1.  æ˜¯å¦æ˜¯å¤šçº¿ç¨‹é—®é¢˜ï¼Ÿæ˜¯ï¼Œç”Ÿäº§è€…çº¿ç¨‹ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹
>
> 2.  æ˜¯å¦æœ‰å…±äº«æ•°æ®ï¼Ÿæ˜¯ï¼Œåº—å‘˜ï¼ˆæˆ–äº§å“ï¼‰
>
> 3.  æ˜¯å¦æ¶‰åŠçº¿ç¨‹çš„é€šä¿¡ï¼Ÿæ˜¯

#### åŒæ­¥ä»£ç å—ç‰ˆæœ¬

```java
class Productor implements Runnable {

    private final Product product;

    public Productor(Product product) {
        this.product = product;
    }

    @Override
    public void run() {
        while (true) {
            synchronized (product) {
                // while å’Œ wait ä¸€èµ·ä½¿ç”¨ï¼›ä¸èƒ½å•ç‹¬ä½¿ç”¨ ifï¼Œå¯èƒ½ä¼šç¼ºå°‘ä¸€æ¬¡åˆ¤æ–­
                // ä¸èƒ½ä½¿ç”¨ if...elseï¼Œä¼šå¯¼è‡´ wait å”¤é†’åå³ä½¿æ»¡è¶³æ¡ä»¶ä¹Ÿä¸èƒ½ç”Ÿäº§æˆ–æ¶ˆè´¹ï¼Œæµªè´¹äº† OS èµ„æº
                while (product.productNum >= 20) {
                    try {
                        product.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }

                product.productNum++;
                System.out.println(Thread.currentThread().getName() + "ï¼šç”Ÿäº§ç¬¬" + product.productNum + "ä¸ªäº§å“");

                product.notifyAll();
            }
            try {
                // æ”¾åœ¨åŒæ­¥å¤–æ›´åˆç†ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥æ­¤æ—¶æŠ¢å èµ„æº
                Thread.sleep(100);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}


class Consumer implements Runnable {

    private final Product product;

    public Consumer(Product product) {
        this.product = product;
    }

    @Override
    public void run() {
        while (true) {
            synchronized (product) {
                // while å’Œ wait ä¸€èµ·ä½¿ç”¨ï¼›ä¸èƒ½å•ç‹¬ä½¿ç”¨ ifï¼Œå¯èƒ½ä¼šç¼ºå°‘ä¸€æ¬¡åˆ¤æ–­
                // ä¸èƒ½ä½¿ç”¨ if...elseï¼Œä¼šå¯¼è‡´ wait å”¤é†’åå³ä½¿æ»¡è¶³æ¡ä»¶ä¹Ÿä¸èƒ½ç”Ÿäº§æˆ–æ¶ˆè´¹ï¼Œæµªè´¹äº† OS èµ„æº
                while (product.productNum <= 0) {
                    try {
                        product.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }

                System.out.println(Thread.currentThread().getName() + "ï¼šæ¶ˆè´¹ç¬¬" + product.productNum + "ä¸ªäº§å“");
                product.productNum--;

                product.notifyAll();
            }
            // æ”¾åœ¨åŒæ­¥å¤–æ›´åˆç†ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥æ­¤æ—¶æŠ¢å èµ„æº
            try {
                Thread.sleep(200);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

class Product {
    // äº§å“æ•°é‡
    int productNum = 0;
}


public class PCTest {
    public static void main(String[] args) {
        Product product = new Product();
        new Thread(new Productor(product), "ç”Ÿäº§è€…1").start();
        new Thread(new Productor(product), "ç”Ÿäº§è€…2").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…1").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…2").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…3").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…4").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…5").start();
    }
}
```

#### Lock ç‰ˆæœ¬

```java
class Productor implements Runnable {

    private final Product product;

    public Productor(Product product) {
        this.product = product;
    }

    @Override
    public void run() {
        while (true) {

            try {
                product.lock.lock();
                // while å’Œ wait ä¸€èµ·ä½¿ç”¨ï¼›ä¸èƒ½å•ç‹¬ä½¿ç”¨ ifï¼Œå¯èƒ½ä¼šç¼ºå°‘ä¸€æ¬¡åˆ¤æ–­
                // ä¸èƒ½ä½¿ç”¨ if...elseï¼Œä¼šå¯¼è‡´ wait å”¤é†’åå³ä½¿æ»¡è¶³æ¡ä»¶ä¹Ÿä¸èƒ½ç”Ÿäº§æˆ–æ¶ˆè´¹ï¼Œæµªè´¹äº† OS èµ„æº
                while (product.productNum >= 20) {
                    try {
                        product.productor.await();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }

                product.productNum++;
                System.out.println(Thread.currentThread().getName() + "ï¼šç”Ÿäº§ç¬¬" + product.productNum + "ä¸ªäº§å“");

                product.consumer.signalAll();
            } finally {
                product.lock.unlock();
            }


            try {
                // æ”¾åœ¨åŒæ­¥å¤–æ›´åˆç†ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥æ­¤æ—¶æŠ¢å èµ„æº
                Thread.sleep(100);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}


class Consumer implements Runnable {

    private final Product product;

    public Consumer(Product product) {
        this.product = product;
    }

    @Override
    public void run() {
        while (true) {

            try {
                product.lock.lock();
                // while å’Œ wait ä¸€èµ·ä½¿ç”¨ï¼›ä¸èƒ½å•ç‹¬ä½¿ç”¨ ifï¼Œå¯èƒ½ä¼šç¼ºå°‘ä¸€æ¬¡åˆ¤æ–­
                // ä¸èƒ½ä½¿ç”¨ if...elseï¼Œä¼šå¯¼è‡´ wait å”¤é†’åå³ä½¿æ»¡è¶³æ¡ä»¶ä¹Ÿä¸èƒ½ç”Ÿäº§æˆ–æ¶ˆè´¹ï¼Œæµªè´¹äº† OS èµ„æº
                while (product.productNum <= 0) {
                    try {
                        product.consumer.await();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }

                System.out.println(Thread.currentThread().getName() + "ï¼šæ¶ˆè´¹ç¬¬" + product.productNum + "ä¸ªäº§å“");
                product.productNum--;

                product.productor.signalAll();
            } finally {
                product.lock.unlock();
            }

            // æ”¾åœ¨åŒæ­¥å¤–æ›´åˆç†ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥æ­¤æ—¶æŠ¢å èµ„æº
            try {
                Thread.sleep(200);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

class Product {
    // äº§å“æ•°é‡
    int productNum = 0;

    Lock lock = new ReentrantLock();
    Condition productor = lock.newCondition();
    Condition consumer = lock.newCondition();
}


public class PCTest {
    public static void main(String[] args) {
        Product product = new Product();
        new Thread(new Productor(product), "ç”Ÿäº§è€…1").start();
        new Thread(new Productor(product), "ç”Ÿäº§è€…2").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…1").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…2").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…3").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…4").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…5").start();
    }
}
```

#### JUC ç‰ˆæœ¬

## ä¹ é¢˜

### å®ç° Runnable æ¥å£çš„å¥½å¤„ ğŸ”¥

**å…¶å® Thread ç±»ä¹Ÿæ˜¯å®ç°äº† Runnable æ¥å£**ã€‚start å¯åŠ¨çº¿ç¨‹ä¸­å†…éƒ¨è°ƒç”¨ run æ–¹æ³•æ—¶ï¼Œè‹¥æ˜¯ target æœ‰å€¼ï¼ˆRunnableå¯¹è±¡ï¼‰åˆ™è°ƒç”¨è¯¥ Runnable å¯¹è±¡çš„ run æ–¹æ³•ï¼Œæ— å€¼åˆ™è°ƒç”¨ Thread é‡å†™çš„ run æ–¹æ³•ã€‚

æ„é€ æ–¹æ³•åˆå§‹åŒ–æ—¶ä¼šæœ‰

```java
// Thread.java
this.target = target;// è¿™ä¸ªå³æ˜¯ä¼ å…¥çš„ Runnable å¯¹è±¡ã€‚Thread åŒ¿åå†…éƒ¨ç±»å¯¹è±¡ä¸ä¼šä¼ å…¥æ„é€ æ–¹æ³•çš„
```

è°ƒç”¨ start æ–¹å¼æ—¶ä¼šè°ƒç”¨

```java
// Thread.java
@Override
public void run() {
    if (target != null) {
        target.run();
    }
}
```

*   é¿å…äº† Java ç±»**å•ç»§æ‰¿çš„å±€é™æ€§**
*   å¤šä¸ªçº¿ç¨‹å¯ä»¥å…±äº«åŒä¸€ä¸ªæ¥å£å®ç°ç±»çš„å¯¹è±¡ï¼Œéå¸¸é€‚åˆå¤šä¸ªç›¸åŒçº¿ç¨‹æ¥**å¤„ç†åŒä¸€ä¸ªèµ„æº**ï¼Œå¢åŠ ç¨‹åºçš„å¥å£®æ€§ï¼Œå®ç°**è§£è€¦**æ“ä½œï¼Œ**ä»»åŠ¡**ä»£ç å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œ**ä»»åŠ¡ä»£ç å’Œçº¿ç¨‹ç‹¬ç«‹**

*   **çº¿ç¨‹æ± **åªèƒ½æ”¾å…¥å®ç° Runable æˆ– Callable ç±»çº¿ç¨‹ï¼Œä¸èƒ½ç›´æ¥æ”¾å…¥ç»§æ‰¿ Thread ç±»çš„çº¿ç¨‹





### `run()`å’Œ`start()`çš„åŒºåˆ« ğŸ”¥

- `run()`ï¼šä»…ä»…æ˜¯å°è£…è¢«çº¿ç¨‹æ‰§è¡Œçš„ä»£ç ï¼Œç›´æ¥è°ƒç”¨æ˜¯æ™®é€šæ–¹æ³•ã€‚
- `start()`ï¼šé¦–å…ˆå¯åŠ¨äº†çº¿ç¨‹ï¼Œç„¶åå†ç”± jvm å»è°ƒç”¨è¯¥çº¿ç¨‹çš„ run()æ–¹æ³•ã€‚

### synchronized å’Œ Lock åŒºåˆ«

- syn æ˜¯å…³é”®å­—å±äº **JVM å±‚é¢**çš„ï¼ˆåœ¨åŒæ­¥ä¸­å—ä¸­æ‰èƒ½è°ƒç”¨ wait/notifyï¼‰ï¼›Lock æ˜¯æ¥å£ï¼Œæ˜¯ **Api å±‚é¢**çš„ï¼ŒJVM å°†èŠ±è´¹è¾ƒå°‘çš„æ—¶é—´æ¥è°ƒåº¦çº¿ç¨‹ï¼Œæ€§èƒ½æ›´å¥½ã€‚å¹¶ä¸”å…·æœ‰æ›´å¥½çš„æ‰©å±•æ€§ï¼ˆæä¾›æ›´å¤šçš„å­ç±»ï¼‰
- syn æ˜¯**éšå¼é”**ï¼Œ**å‡ºäº†ä½œç”¨åŸŸ æˆ– æŠ›å¼‚å¸¸ä¼šè‡ªåŠ¨é‡Šæ”¾**ï¼›Lock æ˜¯**æ˜¾å¼é”**ï¼ˆ**æ‰‹åŠ¨å¼€å¯å’Œå…³é—­é”**ï¼Œåˆ«å¿˜è®°å…³é—­é”ï¼‰
- syn æœ‰ä»£ç å—é”å’Œæ–¹æ³•é”ï¼›Lock åªæœ‰ä»£ç å—é”
- **syn ä¸å¯ä¸­æ–­**ï¼›**Lock å¯ä¸­æ–­**ï¼ˆtryLock è®¾ç½®è¶…æ—¶æ–¹æ³•ï¼ŒlockInterruptibly()æ–¹ä»£ç å—ä¸­ï¼Œç”¨ interrupt()æ–¹æ³•ä¸­æ–­ï¼‰
- ä½¿ç”¨ Lock çš„ Condition å¯ä»¥**ç²¾ç¡®å”¤é†’**

ä¼˜å…ˆä½¿ç”¨é¡ºåºï¼šLock â€”> åŒæ­¥ä»£ç å—(å·²ç»è¿›å…¥äº†æ–¹æ³•ä½“ï¼Œåˆ†é…äº†ç›¸åº”èµ„æº) â€”> åŒæ­¥æ–¹æ³• (åœ¨æ–¹æ³•ä½“ä¹‹å¤–)

### sleep å’Œ wait å¼‚åŒ

- sleep æ˜¯ Thread çš„æ–¹æ³•ï¼Œå¯ä»¥åœ¨ä»»ä½•åœºæ™¯ä¸‹è°ƒç”¨ï¼›wait æ˜¯ Object çš„æ–¹æ³•ï¼Œå¿…é¡»åœ¨åŒæ­¥ä¸­è°ƒç”¨ï¼ˆåŒæ­¥ä»£ç å—ã€åŒæ­¥æ–¹æ³•ï¼‰
- è‹¥ä¿©æ–¹æ³•éƒ½åœ¨åŒæ­¥ä¸­è°ƒç”¨ï¼Œéƒ½ä¼šä½¿çº¿ç¨‹è¿›å…¥ TIME/ WAITING çŠ¶æ€ã€‚ä½† sleep **ä¸ä¼šé‡Šæ”¾é”**ï¼Œä¼‘çœ ç»“æŸå›åˆ°å°±ç»ªçŠ¶æ€ï¼›wait **ç­‰å¾…**å¹¶ç«‹å³**é‡Šæ”¾é”**ï¼Œ**è¢«å”¤é†’åè‹¥è·å¾—é”åˆ™ä»è¿™é‡Œæ‰§è¡Œåç»­ä»£ç **

### 2 ä¸ªçº¿ç¨‹å‘è´¦æˆ·å­˜é’±å¹¶æ‰“å°

é“¶è¡Œæœ‰ä¸€ä¸ªè´¦æˆ·ï¼Œæœ‰ä¸¤ä¸ªå‚¨æˆ·åˆ†åˆ«å‘åŒä¸€ä¸ªè´¦æˆ·å­˜ 3000 å…ƒï¼Œæ¯æ¬¡å­˜ 1000ï¼Œå­˜ 3 æ¬¡ã€‚æ¯æ¬¡å­˜å®Œæ‰“å°è´¦æˆ·ä½™é¢ã€‚

é—®é¢˜:è¯¥ç¨‹åºæ˜¯å¦æœ‰å®‰å…¨é—®é¢˜ï¼Œå¦‚æœæœ‰ï¼Œå¦‚ä½•è§£å†³ï¼Ÿæ­¤å¤„é‡‡ç”¨ç»§æ‰¿ Thread ç±»æ¥å®ç°ï¼ˆå®ç° Runnable æ¥å£ç¨ç®€å•ï¼‰

```java
class Account {
    private double balance;

    public Account(double balance) {
        this.balance = balance;
    }

    //å­˜é’±
    public synchronized void deposit(double amt) {
        if (amt > 0) {
            balance += amt;
            System.out.println(Thread.currentThread().getName() + ":å­˜é’±æˆåŠŸã€‚ä½™é¢ä¸ºï¼š" + balance);
        }
    }
}

class Customer extends Thread {

    private Account acct;

    public Customer(Account acct, String name) {
        super(name);
        this.acct = acct;
    }

    @Override
    public void run() {

        for (int i = 0; i < 3; i++) {
            acct.deposit(1000);

            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

public class AccountTest {

    public static void main(String[] args) {
        Account acct = new Account(0);
        new Customer(acct, "ç”²").start();
        new Customer(acct, "ä¹™").start();
    }
}
```

### 2 ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å° 1-100

åŒæ­¥ä»£ç å—ã€åŒæ­¥æ–¹æ³•

```java
class PrintThread implements Runnable{

    private int count = 1;

    @Override
    public void run() {
        while (true) {
            // waitã€notify å¿…é¡»åœ¨åŒæ­¥ä¸­ã€‚ä¸”è°ƒç”¨çš„å¯¹è±¡ä¸é”å¯¹è±¡å¿…é¡»ç›¸åŒ
            synchronized (this) {
                // å”¤é†’
                this.notifyAll();
                if (count <= 100) {
                    /*try {
                        // ä¸åŠ é”æ—¶ï¼Œå¢åŠ çº¿ç¨‹å®‰å…¨é—®é¢˜å‘ç”Ÿçš„æ¦‚ç‡
                        Thread.sleep(100);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }*/
                    System.out.println(Thread.currentThread().getName()+":"+count++);

                    try {
                        // ç­‰å¾…å¹¶ç«‹å³é‡Šæ”¾é”ï¼Œå”¤é†’åè¿˜æ˜¯ä»è¿™é‡Œç»§ç»­ï¼Œä½†æ˜¯éœ€è¦è·å–åˆ°é”ï¼Œæ‰€ä»¥å¤–å±‚éœ€è¦ä½¿ç”¨ while
                        this.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                } else {
                    break;
                }
            }
        }
    }
}

public class PrintTest {

    public static void main(String[] args) {
        PrintThread printThread = new PrintThread();
        // ä¹Ÿå¯ä»¥å°† run æ–¹æ³•å†…å®¹å†™å…¥æ™®é€šæ–¹æ³•ä¸­ï¼Œé‡‡ç”¨æ–¹æ³•å¼•ç”¨æ¥æ“ä½œ
        new Thread(printThread,"A").start();
        new Thread(printThread,"B").start();
    }
}
```

Lock æ–¹å¼æš‚æ—¶æ²¡æƒ³åˆ°å¥½ç‚¹çš„æ–¹æ³•

### ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜

è§ç¬”è®°

### åˆ›å»ºå¤šçº¿ç¨‹çš„ 4 ç§æ–¹å¼

è§ç¬”è®°





## JMH åŸºå‡†æµ‹è¯•

*   åŸºå‡†æµ‹è¯•å·¥å…·é€‰æ‹©ï¼Œä½¿ç”¨äº†æ¯”è¾ƒé è°±çš„ JMHï¼Œå®ƒä¼šæ‰§è¡Œç¨‹åºé¢„çƒ­ï¼Œæ‰§è¡Œå¤šæ¬¡æµ‹è¯•å¹¶å¹³å‡
*   cpu æ ¸æ•°é™åˆ¶ï¼Œæœ‰ä¸¤ç§æ€è·¯
    *   ä½¿ç”¨è™šæ‹Ÿæœºï¼Œåˆ†é…åˆé€‚çš„æ ¸
    *   ä½¿ç”¨ msconfifigï¼Œåˆ†é…åˆé€‚çš„æ ¸ï¼Œéœ€è¦é‡å¯æ¯”è¾ƒéº»çƒ¦
*   å¹¶è¡Œè®¡ç®—æ–¹å¼çš„é€‰æ‹©
    *   æœ€åˆæƒ³ç›´æ¥ä½¿ç”¨ parallel streamï¼Œåæ¥å‘ç°å®ƒæœ‰è‡ªå·±çš„é—®é¢˜
    *   æ”¹ä¸ºäº†è‡ªå·±æ‰‹åŠ¨æ§åˆ¶ threadï¼Œå®ç°ç®€å•çš„å¹¶è¡Œè®¡ç®—

ä½¿ç”¨ archetype åˆ›å»º Maven é¡¹ç›®

```
mvn archetype:generate -DinteractiveMode=false -DarchetypeGroupId=org.openjdk.jmh -DarchetypeArtifactId=jmh-java-benchmark-archetype -DgroupId=org.sample -DartifactId=test -Dversion=1.0
```

è¿›å…¥è¯¥ test é¡¹ç›®ï¼Œä¿®æ”¹æµ‹è¯•ä»£ç 

```java
@Fork(1)
@BenchmarkMode(Mode.AverageTime)
@Warmup(iterations=3)
@Measurement(iterations=5)
public class MyBenchmark {

    static int[] ARRAY = new int[1000_000_00];
    static {
        Arrays.fill(ARRAY, 1);
    }


    @Benchmark
    public int c() throws Exception{
        int[] array = ARRAY;
        FutureTask<Integer> t1 = new FutureTask<>(()->{
            int sum = 0;
            for(int i = 0; i < 250_000_00;i++) {
                sum += array[i];
            }
            return sum;
        });
        FutureTask<Integer> t2 = new FutureTask<>(()->{
            int sum = 0;
            for(int i = 0; i < 250_000_00;i++) {
                sum += array[250_000_00+i];
            }
            return sum;
        });
        FutureTask<Integer> t3 = new FutureTask<>(()->{
            int sum = 0;
            for(int i = 0; i < 250_000_00;i++) {
                sum += array[500_000_00+i];
            }
            return sum;
        });
        FutureTask<Integer> t4 = new FutureTask<>(()->{
            int sum = 0;
            for(int i = 0; i < 250_000_00;i++) {
                sum += array[750_000_00+i];
            }
            return sum;
        });
        new Thread(t1).start();
        new Thread(t2).start();
        new Thread(t3).start();
        new Thread(t4).start();
        return t1.get() + t2.get() + t3.get()+ t4.get();
    }


    @Benchmark
    public int d() throws Exception {
        int[] array = ARRAY;
        FutureTask<Integer> t1 = new FutureTask<>(()->{
            int sum = 0;
            for(int i = 0; i < 1000_000_00;i++) {
                sum += array[i];
            }
            return sum;
        });
        new Thread(t1).start();
        return t1.get();
    }
}
```

æ‰“åŒ…ååœ¨ test ç›®å½•ä¸‹æ‰§è¡Œ `java -jar [-Xmx2G] target/benchmarks.jar` æµ‹è¯•ï¼š

*   å¯ä»¥çœ‹åˆ°å¤šæ ¸ä¸‹ï¼Œæ•ˆç‡æå‡è¿˜æ˜¯å¾ˆæ˜æ˜¾çš„
*   å•æ ¸ä¸‹ï¼Œæ€§èƒ½å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œç”šè‡³å¤šçº¿ç¨‹ä»£ç è¿˜æ…¢äº†ä¸€ç‚¹