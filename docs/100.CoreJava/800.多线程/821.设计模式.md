---
title: è®¾è®¡æ¨¡å¼
date: 2021-02-13 01:21:20
permalink: /pages/89dd04/
categories:
  - CoreJava
  - é«˜çº§
tags:
  - 
---

# å¤šçº¿ç¨‹â€”è®¾è®¡æ¨¡å¼

## ä¸¤é˜¶æ®µç»ˆæ­¢â€”Two Phase Termination

### ç”¨å¤„

åœ¨ä¸€ä¸ªçº¿ç¨‹ T1 ä¸­å¦‚ä½•â€œä¼˜é›…â€ç»ˆæ­¢çº¿ç¨‹ T2ï¼Ÿè¿™é‡Œçš„ã€ä¼˜é›…ã€‘æŒ‡çš„æ˜¯ç»™ T2 ä¸€ä¸ªæ–™ç†åäº‹çš„æœºä¼šã€‚



### é”™è¯¯æ€è·¯

*   ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„ stop() æ–¹æ³•åœæ­¢çº¿ç¨‹

    stop æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœè¿™æ—¶çº¿ç¨‹**é”**ä½äº†å…±äº«èµ„æºï¼Œé‚£ä¹ˆå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œå…¶å®ƒçº¿ç¨‹å°†æ°¸è¿œæ— æ³•è·å–é”

*   ä½¿ç”¨ System.exit(int) æ–¹æ³•åœæ­¢çº¿ç¨‹

    ç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§åšæ³•ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢



### ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼

```mermaid
graph TD
w("while(true)") --> a
a(æœ‰æ²¡æœ‰è¢«æ‰“æ–­?) -- æ˜¯ --> b(æ–™ç†åäº‹)
b --> c((ç»“æŸå¾ªç¯))
a -- å¦ --> d("ç¡çœ 2s(sleepã€joinã€waitä¸­è¢«æ‰“æ–­çš„ä¼šæŠ›å¼‚å¸¸)")
d -- æ— å¼‚å¸¸ --> e(è®¾ç½®ç›‘æ§è®°å½•)
d -- æœ‰å¼‚å¸¸ --> i(é‡æ–°è®¾ç½®æ‰“æ–­æ ‡è®°)
i --> w
e --> w
```



### interrupt å®ç° ğŸ”¥

```java
@Slf4j(topic = "TwoPhaseTermination")
public class TwoPhaseTermination {


    /* ç›‘æ§çº¿ç¨‹ */
    private Thread monitor;

    /**
     * å¯åŠ¨ç›‘æ§çº¿ç¨‹
     */
    public void start(){
        monitor = new Thread(()->{
            Thread currentThread = Thread.currentThread();
            while (true){
                boolean flag = currentThread.isInterrupted();
                if (flag){
                    log.debug("æ–™ç†åäº‹ï¼Œä¼˜é›…åœæœº");
                    break;
                }

                try {
                    // 1 æ­£å¸¸æƒ…å†µï¼Œè¢«æ‰“æ–­æ— éœ€é¢å¤–å¤„ç†
                    log.debug("æ‰§è¡Œç›‘æ§è®°å½•");
                    // 2 éæ­£å¸¸æƒ…å†µï¼Œåœ¨ sleepã€joinã€wait ä¸­è¢«ä¸­æ–­
                    // æ¯1ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œé‡Šæ”¾CPUï¼Œæ‰€ä»¥sleep
                    TimeUnit.SECONDS.sleep(1);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                    // ç”±äº catch InterruptedException åä¼šæ¸…é™¤ä¸­æ–­æ ‡å¿—ï¼Œæ‰€ä»¥éœ€è¦é‡è®¾ä¸­æ–­æ ‡å¿—
                    currentThread.interrupt();
                }

            }
        });

        monitor.start();
    }

    /**
     * ä¼˜é›…åœæ­¢ç›‘æ§çº¿ç¨‹
     */
    public void stop(){
        monitor.interrupt();
    }


    public static void main(String[] args) throws InterruptedException {
        TwoPhaseTermination tpt = new TwoPhaseTermination();
        tpt.start();
        TimeUnit.SECONDS.sleep(3);
        tpt.stop();
    }
}
```





### volitile å®ç° ğŸ”¥

```java

```









## åŒæ­¥æ¨¡å¼â€”ä¿æŠ¤ï¼ˆç›‘æ§ï¼‰æ€§æš‚åœâ€”Guarded Suspension

### å®šä¹‰

å³ Guardedï¼ˆç›‘æ§ï¼‰ Suspensionï¼ˆæš‚åœï¼‰ï¼Œç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœ

è¦ç‚¹ï¼š

*   æœ‰ä¸€ä¸ª**ç»“æœéœ€è¦ä»ä¸€ä¸ªçº¿ç¨‹ä¼ é€’åˆ°å¦ä¸€ä¸ªçº¿ç¨‹**ï¼Œè®©ä»–ä»¬å…³è”åŒä¸€ä¸ª **Guardedï¼ˆç›‘æ§ï¼‰** Object
*   å¦‚æœæœ‰ç»“æœ**ä¸æ–­**ä»ä¸€ä¸ªçº¿ç¨‹åˆ°å¦ä¸€ä¸ªçº¿ç¨‹é‚£ä¹ˆå¯ä»¥ä½¿ç”¨**æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè§ç”Ÿäº§è€…/æ¶ˆè´¹è€…ï¼‰**
*   JDK ä¸­ï¼Œ**join çš„å®ç°ã€Future çš„å®ç°ï¼Œé‡‡ç”¨çš„å°±æ˜¯æ­¤æ¨¡å¼**
*   å› ä¸ºè¦**ç­‰å¾…**å¦ä¸€æ–¹çš„ç»“æœï¼Œå› æ­¤å½’ç±»åˆ°**åŒæ­¥æ¨¡å¼**

**å¯¹æ¯” join å®ç°å¥½å¤„**

*   **ä¸‹è½½çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åè¿˜å¯ä»¥åšå…¶ä»–äº‹ï¼Œå› ä¸ºå·²ç»æœ‰notifyAllé€šçŸ¥äº†**ï¼›è€Œ**joinåˆ™å¿…é¡»ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•**ï¼

```mermaid
graph TD
	subgraph "Guarded Object"
    go[response]
    end
    t1 --wait response æœ‰å€¼--> go
    t2 --"ä»»åŠ¡å®Œæˆï¼Œä¸ºresponseèµ‹å€¼ï¼Œé€šçŸ¥t1"--> go
```



### å®ç°â€”ç®€å• ğŸ”¥

```java
@Slf4j(topic = "GuardedObject")
public class GuardedObject {

    // ç»“æœ
    private Object response;

    /**
     * è·å–ç»“æœ
     *
     * @return response
     */
    public Object get() {
        synchronized (this) {
            while (response == null) {
                try {
                    this.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            return response;
        }
    }

    /**
     * äº§ç”Ÿç»“æœ
     *
     * @param response response
     */
    public void complete(Object response) {
        synchronized (this) {
            // ç»™ç»“æœæˆå‘˜å˜é‡èµ‹å€¼ï¼Œå¹¶å”¤é†’ç­‰å¾…çº¿ç¨‹
            this.response = response;
            this.notifyAll();
        }
    }


    public static void main(String[] args) {
        test1();
    }

    private static void test1(){
        // // æ¨¡æ‹Ÿçº¿ç¨‹1ç­‰å¾…çº¿ç¨‹2ä¸‹è½½ç»“æœ
        GuardedObject guardedObject = new GuardedObject();

        new Thread(() -> {
            // å­çº¿ç¨‹ä¸‹è½½
            try {
                List<String> download = Downloader.download();
                log.debug("download complete...");
                guardedObject.complete(download);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }, "download-thread").start();

        log.debug("waiting...");
        // ä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…
        Object response = guardedObject.get();
        log.debug("get response: [{}] lines", ((List<String>) response).size());
    }
}
```

ä¸‹è½½å·¥å…·ç±»ï¼š

```java
public class Downloader {

    public static List<String> download() throws IOException {
        URL url = new URL("https://www.qq.com/");
        URLConnection conn = url.openConnection();

        ArrayList<String> lines = new ArrayList<>();
        try (
                BufferedReader br = new BufferedReader(new InputStreamReader(conn.getInputStream(), StandardCharsets.UTF_8))
        ) {
            String line;
            while ((line = br.readLine()) != null) {
                lines.add(line);
            }
        }
        return lines;
    }
}
```

æ‰§è¡Œç»“æœï¼š

```
17:03:36.977 [main] DEBUG GuardedObject - waiting...
17:03:37.473 [download-thread] DEBUG GuardedObject - download complete...
17:03:37.473 [main] DEBUG GuardedObject - get response: [1805] lines
```





### å®ç°â€”è¶…æ—¶ ğŸ”¥

```java
@Slf4j(topic = "GuardedObject")
public class GuardedObject {

    // ç»“æœ
    private Object response;

    /**
     * è·å–ç»“æœ
     *
     * @param timeout ç­‰å¾…æ¯«ç§’
     * @return response
     */
    public Object get(long timeout) {
        synchronized (this) {
            // å¼€å§‹æ—¶é—´
            long beginTime = System.currentTimeMillis();
            // ç»å†æ—¶é—´
            long passTime = 0;
            while (response == null) {
                // è¿™ä¸€è½®å¾ªç¯å®é™…è¿˜éœ€è¦ç­‰å¾…çš„æ—¶é—´
                long waitTime = timeout - passTime;
                // ç»å†æ—¶é—´è¶…è¿‡äº†è®¾ç½®çš„ç­‰å¾…æœ€å¤§æ—¶é—´ï¼Œåˆ™é€€å‡ºå¾ªç¯ã€‚ä¼˜åŒ–ä¸ºè¿˜éœ€ç­‰å¾…çš„æ—¶é—´æ˜¯å¦å°äºç­‰äº0
                if (waitTime <= 0) {
                    break;
                }
                try {
                    // è¿™é‡Œåªæ˜¯ç­‰å¾…timeoutæ—¶é—´ï¼Œç­‰å¾…å®Œååˆæ‰§è¡Œå¾ªç¯ï¼Œéœ€å¤„ç†
                    // å¹¶ä¸”è‹¥æ˜¯è™šå‡æå‰å”¤é†’ï¼Œåˆ™æ­¤æ—¶åº”è¯¥å†ç­‰çš„æ—¶é•¿åº”è¯¥å°‘äºtimeoutï¼ï¼ï¼ç”¨timeoutå‡å»å·²ç»costçš„æ—¶é•¿
                    this.wait(waitTime);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                passTime = System.currentTimeMillis() - beginTime;// è®¡ç®—ç»å†æ—¶é—´
            }
            return response;
        }
    }

    /**
     * äº§ç”Ÿç»“æœ
     *
     * @param response response
     */
    public void complete(Object response) {
        synchronized (this) {
            // ç»™ç»“æœæˆå‘˜å˜é‡èµ‹å€¼ï¼Œå¹¶å”¤é†’ç­‰å¾…çº¿ç¨‹
            this.response = response;
            this.notifyAll();
        }
    }


    public static void main(String[] args) {
        test2();
    }

    private static void test2(){
        // // æ¨¡æ‹Ÿçº¿ç¨‹1ç­‰å¾…çº¿ç¨‹2ä¸‹è½½ç»“æœ
        GuardedObject guardedObject = new GuardedObject();

        new Thread(() -> {
            // å­çº¿ç¨‹ä¸‹è½½
            try {
                TimeUnit.SECONDS.sleep(5);// æ¨¡æ‹Ÿä¸‹è½½æ—¶é—´è¿‡é•¿ï¼Œè¶…æ—¶äº†
                List<String> download = Downloader.download();
                log.debug("download complete...");
                guardedObject.complete(download);// è¿™é‡Œå¦‚æœä¼ å€¼ä¸ºnullï¼Œä¸”ä¸å¤„ç†waitTimeï¼Œåˆ™ä¼šå¤šç­‰ä¸€ä¼š
            } catch (IOException | InterruptedException e) {
                e.printStackTrace();
            }
        }, "download-thread").start();

        log.debug("waiting...");
        // ä¸»çº¿ç¨‹é˜»å¡ç­‰å¾…
        Object response = guardedObject.get(2000);
        log.debug("get response: {}", response);
    }
}
```

æ‰§è¡Œç»“æœï¼š

```
17:46:32.233 [main] DEBUG GuardedObject - waiting...
17:46:34.237 [main] DEBUG GuardedObject - get response: null
17:46:37.608 [download-thread] DEBUG GuardedObject - download complete...
```



### å®ç°â€”å¤šä»»åŠ¡ç‰ˆï¼ˆå®ä¾‹ä¸å¤ªæ°å½“ï¼‰ ğŸ”¥

è¿˜æ˜¯ä¸€å¯¹ä¸€å…³ç³»ï¼Œä¸æ˜¯ç”Ÿäº§è€…æ¶ˆè´¹è€…çš„å¤šå¯¹å¤š

å›¾ä¸­ Futures å°±å¥½æ¯”å±…æ°‘æ¥¼ä¸€å±‚çš„ä¿¡ç®±ï¼ˆæ¯ä¸ªä¿¡ç®±æœ‰æˆ¿é—´ç¼–å·ï¼‰ï¼Œå·¦ä¾§çš„ t0ï¼Œt2ï¼Œt4 å°±å¥½æ¯”ç­‰å¾…é‚®ä»¶çš„å±…æ°‘ï¼Œå³ä¾§çš„ t1ï¼Œt3ï¼Œt5 å°±å¥½æ¯”é‚®é€’å‘˜ã€‚

å¦‚æœéœ€è¦åœ¨å¤šä¸ªç±»ä¹‹é—´ä½¿ç”¨ GuardedObject å¯¹è±¡ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œå› æ­¤è®¾è®¡ä¸€ä¸ªç”¨æ¥è§£è€¦çš„ä¸­é—´ç±»ï¼Œè¿™æ ·ä¸ä»…èƒ½å¤Ÿè§£è€¦ã€ç»“æœç­‰å¾…è€…ã€‘å’Œã€ç»“æœç”Ÿäº§è€…ã€‘ï¼Œè¿˜èƒ½å¤ŸåŒæ—¶æ”¯æŒå¤šä¸ªä»»åŠ¡çš„ç®¡ç†ã€‚

![image-20210221213713212](../images/image-20210221213713212.png)

å¦‚ä¸‹ç”¨é‚®ç®±çš„ä¾‹å­ä¸æ˜¯ç‰¹åˆ«æ°å½“ï¼Œ**å› ä¸ºå®é™…ä¸­ä¸æ˜¯ä¸€å¯¹ä¸€**ï¼Œåº”è¯¥é‚®é€’å‘˜å°‘ï¼Œå¹¶ä¸”ç”¨æˆ·å®é™…æ˜¯åœ¨ä¸æ–­ç­‰å¾…ä¿¡ä»¶çš„

```java
@Slf4j(topic = "GuardedObject")
public class GuardedObject {

    // æ ‡è¯† guarded object
    private int id;

    // ç»“æœ
    private Object response;

    public GuardedObject() { }

    public GuardedObject(int id) {
        this.id = id;
    }

    public int getId() {
        return id;
    }

    /**
     * è·å–ç»“æœ
     *
     * @return response
     */
    public Object get() {
        synchronized (this) {
            while (response == null) {
                try {
                    this.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            return response;
        }
    }

    /**
     * è·å–ç»“æœ
     *
     * @param timeout ç­‰å¾…æ¯«ç§’
     * @return response
     */
    public Object get(long timeout) {
        synchronized (this) {
            // å¼€å§‹æ—¶é—´
            long beginTime = System.currentTimeMillis();
            // ç»å†æ—¶é—´
            long passTime = 0;
            while (response == null) {
                // è¿™ä¸€è½®å¾ªç¯å®é™…è¿˜éœ€è¦ç­‰å¾…çš„æ—¶é—´
                long waitTime = timeout - passTime;
                // ç»å†æ—¶é—´è¶…è¿‡äº†è®¾ç½®çš„ç­‰å¾…æœ€å¤§æ—¶é—´ï¼Œåˆ™é€€å‡ºå¾ªç¯ã€‚ä¼˜åŒ–ä¸ºè¿˜éœ€ç­‰å¾…çš„æ—¶é—´æ˜¯å¦å°äºç­‰äº0
                if (waitTime <= 0) {
                    break;
                }
                try {
                    // è¿™é‡Œåªæ˜¯ç­‰å¾…timeoutæ—¶é—´ï¼Œç­‰å¾…å®Œååˆæ‰§è¡Œå¾ªç¯ï¼Œéœ€å¤„ç†
                    // å¹¶ä¸”è‹¥æ˜¯è™šå‡æå‰å”¤é†’ï¼Œåˆ™æ­¤æ—¶åº”è¯¥å†ç­‰çš„æ—¶é•¿åº”è¯¥å°‘äºtimeoutï¼ï¼ï¼ç”¨timeoutå‡å»å·²ç»costçš„æ—¶é•¿
                    this.wait(waitTime);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                passTime = System.currentTimeMillis() - beginTime;// è®¡ç®—ç»å†æ—¶é—´
            }
            return response;
        }
    }

    /**
     * äº§ç”Ÿç»“æœ
     *
     * @param response response
     */
    public void complete(Object response) {
        synchronized (this) {
            // ç»™ç»“æœæˆå‘˜å˜é‡èµ‹å€¼ï¼Œå¹¶å”¤é†’ç­‰å¾…çº¿ç¨‹
            this.response = response;
            this.notifyAll();
        }
    }

}
```

```java
public class Mailboxes {

    // åˆå§‹åŒ–é‚®ç®±ï¼ˆå¤šå°‘æˆ·è®¢é˜…ï¼Œç¬¬ä¸€ä¸ªè®¢é˜…çš„idä¸º1ï¼Œç±»æ¨ï¼‰
    public Mailboxes(int capacity) {
        this.createGuardedObjects(capacity);
    }

    // äº§ç”Ÿå”¯ä¸€idï¼ˆåœ¨è¿™é‡Œé˜²æ­¢Personã€Postmanåˆ›å»ºé‡å¤ï¼‰
    private static int i = 1;
    private static synchronized int generateId(){
        return i++;
    }


    // å¯¹ GuardedObject çš„åˆ›å»ºã€åˆ é™¤
    private static Map<Integer, GuardedObject> boxes = new Hashtable<>();


    /**
     * åˆå§‹åŒ–æ€»è®¢é˜…
     */
    private void createGuardedObjects(int capacity){
        for (int i1 = 0; i1 < capacity; i1++) {
            GuardedObject guardedObject = new GuardedObject(generateId());
            boxes.put(guardedObject.getId(), guardedObject);
        }
    }

    public static GuardedObject getGuardedObject(int id){
        // é€’é€å®Œå°±é”€æ¯ï¼Œä½†æ˜¯ä¸èƒ½è°ƒç”¨ removeï¼Œä¼šæœ‰ ConcurrentModificationException
        return boxes.get(id);
    }
}
```

```java
@Slf4j(topic = "TestMailboxes")
public class TestMailboxes {

    public static void main(String[] args) throws InterruptedException {

        // é‚®å±€

        // 5æˆ·äººå®¶éœ€è¦è®¢é˜…é‚®ç®±
        final int CAPACITY = 5;
        new Mailboxes(CAPACITY);

        // 5æˆ·äººå®¶éœ€è¦æ”¶ä¿¡
        for (int i = 1; i <= CAPACITY; i++) {
            // ç»™ç”¨æˆ·åˆ†é…idï¼Œå¹¶è®©ä»–ä»¬ç­‰ç€æ”¶ä¿¡å°±å®Œäº‹äº†
            new Person(i).start();
        }

        TimeUnit.SECONDS.sleep(1);

        // ç”Ÿäº§ä¿¡ï¼Œæ´¾é€ï¼ˆç›®å‰æ˜¯é‚®é€’å‘˜å’Œç”¨æˆ·ä¸€ä¸€å¯¹åº”ï¼‰
        for (int i = 1; i <= CAPACITY; i++) {
            new Postman(i, "å†…å®¹" + i).start();
        }
    }
}

@Slf4j(topic = "Person")
class Person extends Thread {

    // åˆ†é…çš„ guardedObject id
    private final int guardedObjectId;

    public Person(int guardedObjectId) {
        this.guardedObjectId = guardedObjectId;
    }

    @Override
    public void run() {
        // æ”¶ä¿¡ã€‚æ”¶ä¿¡äººæœ‰é—¨å£é‚®ç®±å·
        log.debug("ç­‰å¾…ä¿¡ä»¶ id:{}", guardedObjectId);
        GuardedObject guardedObject = Mailboxes.getGuardedObject(guardedObjectId);

        // ä¸æ–­ç­‰ç€æ”¶ä¿¡å°±å®Œäº‹äº†
        Object mail = guardedObject.get(5000);
        log.debug("æ”¶åˆ°ä¿¡ id:{}, å†…å®¹:{}", guardedObjectId, mail);
    }
}


/**
 * é‚®å±€è°ƒç”¨é‚®é€’å‘˜æ¥æ´¾é€é‚®ä»¶
 */
@Slf4j(topic = "Postman")
class Postman extends Thread {

    // ä¿¡ä»¶ä¸Šé¢éƒ½æœ‰ç›®çš„åœ°ï¼ˆè¿™é‡Œç”¨ guardedObject çš„ id è¡¨ç¤ºï¼‰ã€ä¿¡ä»¶å†…å®¹
    private int id;
    private String mail;

    public Postman(int id, String mail) {
        this.id = id;
        this.mail = mail;
    }

    @Override
    public void run() {
        GuardedObject guardedObject = Mailboxes.getGuardedObject(id);
        log.debug("é€ä¿¡ id:{}, å†…å®¹:{}", id, mail);
        guardedObject.complete(mail);
    }
}
```

ç»“æœå¦‚ä¸‹ï¼š

```
23:14:37.927 [Thread-3] DEBUG Person - ç­‰å¾…ä¿¡ä»¶ id:4
23:14:37.927 [Thread-0] DEBUG Person - ç­‰å¾…ä¿¡ä»¶ id:1
23:14:37.927 [Thread-1] DEBUG Person - ç­‰å¾…ä¿¡ä»¶ id:2
23:14:37.927 [Thread-4] DEBUG Person - ç­‰å¾…ä¿¡ä»¶ id:5
23:14:37.927 [Thread-2] DEBUG Person - ç­‰å¾…ä¿¡ä»¶ id:3
23:14:38.929 [Thread-6] DEBUG Postman - é€ä¿¡ id:2, å†…å®¹:å†…å®¹2
23:14:38.929 [Thread-5] DEBUG Postman - é€ä¿¡ id:1, å†…å®¹:å†…å®¹1
23:14:38.929 [Thread-7] DEBUG Postman - é€ä¿¡ id:3, å†…å®¹:å†…å®¹3
23:14:38.929 [Thread-0] DEBUG Person - æ”¶åˆ°ä¿¡ id:1, å†…å®¹:å†…å®¹1
23:14:38.929 [Thread-1] DEBUG Person - æ”¶åˆ°ä¿¡ id:2, å†…å®¹:å†…å®¹2
23:14:38.929 [Thread-2] DEBUG Person - æ”¶åˆ°ä¿¡ id:3, å†…å®¹:å†…å®¹3
23:14:38.929 [Thread-8] DEBUG Postman - é€ä¿¡ id:4, å†…å®¹:å†…å®¹4
23:14:38.929 [Thread-9] DEBUG Postman - é€ä¿¡ id:5, å†…å®¹:å†…å®¹5
23:14:38.929 [Thread-3] DEBUG Person - æ”¶åˆ°ä¿¡ id:4, å†…å®¹:å†…å®¹4
23:14:38.930 [Thread-4] DEBUG Person - æ”¶åˆ°ä¿¡ id:5, å†…å®¹:å†…å®¹5
```





## å¼‚æ­¥æ¨¡å¼â€”ç”Ÿäº§è€…æ¶ˆè´¹è€… ğŸ”¥

### å®šä¹‰

*   ä¸å‰é¢çš„ä¿æŠ¤æ€§æš‚åœä¸­çš„ GuardObject ä¸åŒï¼Œ**ä¸éœ€è¦äº§ç”Ÿç»“æœå’Œæ¶ˆè´¹ç»“æœçš„çº¿ç¨‹ä¸€ä¸€å¯¹åº”**

*   æ¶ˆè´¹é˜Ÿåˆ—å¯ä»¥ç”¨æ¥**å¹³è¡¡ç”Ÿäº§å’Œæ¶ˆè´¹çš„çº¿ç¨‹èµ„æº**

*   ç”Ÿäº§è€…ä»…è´Ÿè´£äº§ç”Ÿç»“æœæ•°æ®ï¼Œä¸å…³å¿ƒæ•°æ®è¯¥å¦‚ä½•å¤„ç†ï¼Œè€Œæ¶ˆè´¹è€…ä¸“å¿ƒå¤„ç†ç»“æœæ•°æ®

*   æ¶ˆæ¯é˜Ÿåˆ—æ˜¯**æœ‰å®¹é‡é™åˆ¶**çš„ï¼Œ**æ»¡æ—¶ä¸ä¼šå†åŠ å…¥æ•°æ®ï¼Œç©ºæ—¶ä¸ä¼šå†æ¶ˆè€—æ•°æ®**

*   JDK ä¸­å„ç§**é˜»å¡é˜Ÿåˆ—**ï¼Œé‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ¨¡å¼

![image-20210221232338159](../images/image-20210221232338159.png)



### å®ç°â€”æ¶ˆæ¯é˜Ÿåˆ—â€”syncç‰ˆ ğŸ”¥

```java
/**
 * æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸åŒäºMQã€‚æœ¬ç±»æ˜¯çº¿ç¨‹é—´çš„ï¼ŒMQæ˜¯è¿›ç¨‹é—´çš„
 */
@Slf4j(topic = "MessageQueue")
public class MessageQueue {

    // æ¶ˆæ¯é˜Ÿåˆ—å®¹å™¨
    private final LinkedList<Message> messages = new LinkedList<>();

    // æ¶ˆæ¯é˜Ÿåˆ—å®¹é‡
    private int capacity;

    public MessageQueue(int capacity) {
        this.capacity = capacity;
    }

    /**
     * ç”Ÿäº§å­˜å…¥æ¶ˆæ¯
     */
    public void put(Message message){
        // ä¸æ–­ç”Ÿäº§æ¶ˆæ¯
        while (true) {
            synchronized (messages) {
                // æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦æ»¡äº†
                while (messages.size() == capacity) {
                    try {
                        log.debug("é˜Ÿåˆ—å·²æ»¡ï¼Œç”Ÿäº§è€…çº¿ç¨‹ç­‰å¾…");
                        messages.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                messages.addLast(message);
                log.debug("å·²ç”Ÿäº§æ¶ˆæ¯, {},", message);
                messages.notifyAll();// æœ‰æ¶ˆæ¯äº†ï¼Œå”¤é†’ç­‰å¾…çš„æ¶ˆè´¹çº¿ç¨‹
            }

            try {
                // ç”Ÿäº§å®Œä¸€ä¸ªä¼‘æ¯ä¸€ä¸‹
                TimeUnit.SECONDS.sleep(1);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }


    /**
     * æ¶ˆè´¹æ¶ˆæ¯
     *
     * @return
     */
    public Message take() {

        synchronized (messages) {
            // æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
            while (messages.isEmpty()) {
                try {
                    log.debug("é˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…");
                    messages.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            Message message = messages.removeFirst();
            log.debug("å·²æ¶ˆè´¹æ¶ˆæ¯, {},", message);
            messages.notifyAll();// å·²ç»è¢«æ¶ˆè´¹äº†ï¼Œå”¤é†’ç­‰å¾…çš„ç”Ÿäº§è€…çº¿ç¨‹
            return message;
        }
    }

}


class Message {
    // ç›®å‰idæ²¡å•¥æ„ä¹‰
    private int id;

    private Object value;

    public Message(int id, Object value) {
        this.id = id;
        this.value = value;
    }

    public int getId() {
        return id;
    }

    public Object getValue() {
        return value;
    }

    @Override
    public String toString() {
        return "Message{" +
                "id=" + id +
                ", value=" + value +
                '}';
    }
}


class TestMessageQueue {
    public static void main(String[] args) {


        MessageQueue messageQueue = new MessageQueue(5);

        for (int i = 0; i < 2; i++) {
            int finalI = i;
            new Thread(() -> {
                messageQueue.put(new Message(finalI, "å€¼" + finalI));
            }, "ç”Ÿäº§è€…" + i).start();
        }

        // ä¸€å¤©å°±5ä¸ªäººæ¥æ¶ˆè´¹
        for (int i = 0; i < 5; i++) {
            new Thread(() -> {
                try {
                    TimeUnit.SECONDS.sleep(1);
                    Message message = messageQueue.take();

                } catch (InterruptedException e) {
                    e.printStackTrace();
                }

            }, "æ¶ˆè´¹è€…" + i).start();
        }
    }
}
```

ç»“æœå¦‚ä¸‹ï¼š

```
00:09:17.234 [ç”Ÿäº§è€…0] DEBUG MessageQueue - å·²ç”Ÿäº§æ¶ˆæ¯, Message{id=0, value=å€¼0},
00:09:17.238 [ç”Ÿäº§è€…1] DEBUG MessageQueue - å·²ç”Ÿäº§æ¶ˆæ¯, Message{id=1, value=å€¼1},
00:09:18.236 [æ¶ˆè´¹è€…4] DEBUG MessageQueue - å·²æ¶ˆè´¹æ¶ˆæ¯, Message{id=0, value=å€¼0},
00:09:18.237 [æ¶ˆè´¹è€…1] DEBUG MessageQueue - å·²æ¶ˆè´¹æ¶ˆæ¯, Message{id=1, value=å€¼1},
00:09:18.237 [æ¶ˆè´¹è€…2] DEBUG MessageQueue - é˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…
00:09:18.237 [æ¶ˆè´¹è€…0] DEBUG MessageQueue - é˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…
00:09:18.237 [æ¶ˆè´¹è€…3] DEBUG MessageQueue - é˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…
00:09:18.240 [ç”Ÿäº§è€…0] DEBUG MessageQueue - å·²ç”Ÿäº§æ¶ˆæ¯, Message{id=0, value=å€¼0},
00:09:18.240 [æ¶ˆè´¹è€…3] DEBUG MessageQueue - å·²æ¶ˆè´¹æ¶ˆæ¯, Message{id=0, value=å€¼0},
00:09:18.240 [æ¶ˆè´¹è€…0] DEBUG MessageQueue - é˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…
00:09:18.240 [æ¶ˆè´¹è€…2] DEBUG MessageQueue - é˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…
00:09:18.241 [ç”Ÿäº§è€…1] DEBUG MessageQueue - å·²ç”Ÿäº§æ¶ˆæ¯, Message{id=1, value=å€¼1},
00:09:18.241 [æ¶ˆè´¹è€…2] DEBUG MessageQueue - å·²æ¶ˆè´¹æ¶ˆæ¯, Message{id=1, value=å€¼1},
00:09:18.241 [æ¶ˆè´¹è€…0] DEBUG MessageQueue - é˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…
00:09:19.245 [ç”Ÿäº§è€…0] DEBUG MessageQueue - å·²ç”Ÿäº§æ¶ˆæ¯, Message{id=0, value=å€¼0},
00:09:19.245 [æ¶ˆè´¹è€…0] DEBUG MessageQueue - å·²æ¶ˆè´¹æ¶ˆæ¯, Message{id=0, value=å€¼0},
00:09:19.245 [ç”Ÿäº§è€…1] DEBUG MessageQueue - å·²ç”Ÿäº§æ¶ˆæ¯, Message{id=1, value=å€¼1},
00:09:20.246 [ç”Ÿäº§è€…1] DEBUG MessageQueue - å·²ç”Ÿäº§æ¶ˆæ¯, Message{id=1, value=å€¼1},
00:09:20.247 [ç”Ÿäº§è€…0] DEBUG MessageQueue - å·²ç”Ÿäº§æ¶ˆæ¯, Message{id=0, value=å€¼0},
00:09:21.247 [ç”Ÿäº§è€…1] DEBUG MessageQueue - å·²ç”Ÿäº§æ¶ˆæ¯, Message{id=1, value=å€¼1},
00:09:21.247 [ç”Ÿäº§è€…0] DEBUG MessageQueue - å·²ç”Ÿäº§æ¶ˆæ¯, Message{id=0, value=å€¼0},
00:09:22.247 [ç”Ÿäº§è€…1] DEBUG MessageQueue - é˜Ÿåˆ—å·²æ»¡ï¼Œç”Ÿäº§è€…çº¿ç¨‹ç­‰å¾…
00:09:22.247 [ç”Ÿäº§è€…0] DEBUG MessageQueue - é˜Ÿåˆ—å·²æ»¡ï¼Œç”Ÿäº§è€…çº¿ç¨‹ç­‰å¾…
```



### å®ç°â€”ç”Ÿäº§æ¶ˆè´¹ ğŸ”¥

ç”Ÿäº§è€…ï¼ˆProductorï¼‰å°†äº§å“äº¤ç»™åº—å‘˜ï¼ˆClerkï¼‰ï¼Œè€Œæ¶ˆè´¹è€…ï¼ˆConsumerï¼‰ä»åº—å‘˜å¤„å–èµ°äº§å“ï¼Œåº—å‘˜ä¸€æ¬¡åªèƒ½æŒæœ‰å›ºå®šæ•°é‡çš„äº§å“ï¼ˆæ¯”å¦‚20ï¼‰ï¼Œå¦‚æœç”Ÿäº§è€…è¯•å›¾ç”Ÿäº§æ›´å¤šçš„äº§å“ï¼Œåº—å‘˜ä¼šå«ç”Ÿäº§è€…åœä¸€ä¸‹ï¼Œå¦‚æœåº—ä¸­æœ‰ç©ºä½æ”¾äº§å“äº†å†é€šçŸ¥ç”Ÿäº§è€…ç»§ç»­ç”Ÿäº§ï¼›å¦‚æœåº—ä¸­æ²¡æœ‰äº§å“äº†ï¼Œåº—å‘˜ä¼šå‘Šè¯‰æ¶ˆè´¹è€…ç­‰ä¸€ä¸‹ï¼Œå¦‚æœåº—ä¸­æœ‰äº§å“äº†å†é€šçŸ¥æ¶ˆè´¹è€…æ¥å–èµ°äº§å“ã€‚

åˆ†æï¼š

1.  æ˜¯å¦æ˜¯å¤šçº¿ç¨‹é—®é¢˜ï¼Ÿæ˜¯ï¼Œç”Ÿäº§è€…çº¿ç¨‹ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹

2.  æ˜¯å¦æœ‰å…±äº«æ•°æ®ï¼Ÿæ˜¯ï¼Œåº—å‘˜ï¼ˆæˆ–äº§å“ï¼‰

3.  æ˜¯å¦æ¶‰åŠçº¿ç¨‹çš„é€šä¿¡ï¼Ÿæ˜¯



#### sync ç‰ˆ

```java
class Productor implements Runnable {

    private final Product product;

    public Productor(Product product) {
        this.product = product;
    }

    @Override
    public void run() {
        while (true) {
            synchronized (product) {
                // while å’Œ wait ä¸€èµ·ä½¿ç”¨ï¼›ä¸èƒ½å•ç‹¬ä½¿ç”¨ ifï¼Œå¯èƒ½ä¼šç¼ºå°‘ä¸€æ¬¡åˆ¤æ–­
                // ä¸èƒ½ä½¿ç”¨ if...elseï¼Œä¼šå¯¼è‡´ wait å”¤é†’åå³ä½¿æ»¡è¶³æ¡ä»¶ä¹Ÿä¸èƒ½ç”Ÿäº§æˆ–æ¶ˆè´¹ï¼Œæµªè´¹äº† OS èµ„æº
                while (product.productNum >= 20) {
                    try {
                        product.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }

                product.productNum++;
                System.out.println(Thread.currentThread().getName() + "ï¼šç”Ÿäº§ç¬¬" + product.productNum + "ä¸ªäº§å“");

                product.notifyAll();
            }
            try {
                // æ”¾åœ¨åŒæ­¥å¤–æ›´åˆç†ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥æ­¤æ—¶æŠ¢å èµ„æº
                Thread.sleep(100);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}


class Consumer implements Runnable {

    private final Product product;

    public Consumer(Product product) {
        this.product = product;
    }

    @Override
    public void run() {
        while (true) {
            synchronized (product) {
                // while å’Œ wait ä¸€èµ·ä½¿ç”¨ï¼›ä¸èƒ½å•ç‹¬ä½¿ç”¨ ifï¼Œå¯èƒ½ä¼šç¼ºå°‘ä¸€æ¬¡åˆ¤æ–­
                // ä¸èƒ½ä½¿ç”¨ if...elseï¼Œä¼šå¯¼è‡´ wait å”¤é†’åå³ä½¿æ»¡è¶³æ¡ä»¶ä¹Ÿä¸èƒ½ç”Ÿäº§æˆ–æ¶ˆè´¹ï¼Œæµªè´¹äº† OS èµ„æº
                while (product.productNum <= 0) {
                    try {
                        product.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }

                System.out.println(Thread.currentThread().getName() + "ï¼šæ¶ˆè´¹ç¬¬" + product.productNum + "ä¸ªäº§å“");
                product.productNum--;

                product.notifyAll();
            }
            // æ”¾åœ¨åŒæ­¥å¤–æ›´åˆç†ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥æ­¤æ—¶æŠ¢å èµ„æº
            try {
                Thread.sleep(200);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

class Product {
    // äº§å“æ•°é‡
    int productNum = 0;
}


public class PCTest {
    public static void main(String[] args) {
        Product product = new Product();
        new Thread(new Productor(product), "ç”Ÿäº§è€…1").start();
        new Thread(new Productor(product), "ç”Ÿäº§è€…2").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…1").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…2").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…3").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…4").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…5").start();
    }
}
```



#### Lock ç‰ˆæœ¬

```java
class Productor implements Runnable {

    private final Product product;

    public Productor(Product product) {
        this.product = product;
    }

    @Override
    public void run() {
        while (true) {

            try {
                product.lock.lock();
                // while å’Œ wait ä¸€èµ·ä½¿ç”¨ï¼›ä¸èƒ½å•ç‹¬ä½¿ç”¨ ifï¼Œå¯èƒ½ä¼šç¼ºå°‘ä¸€æ¬¡åˆ¤æ–­
                // ä¸èƒ½ä½¿ç”¨ if...elseï¼Œä¼šå¯¼è‡´ wait å”¤é†’åå³ä½¿æ»¡è¶³æ¡ä»¶ä¹Ÿä¸èƒ½ç”Ÿäº§æˆ–æ¶ˆè´¹ï¼Œæµªè´¹äº† OS èµ„æº
                while (product.productNum >= 20) {
                    try {
                        product.productor.await();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }

                product.productNum++;
                System.out.println(Thread.currentThread().getName() + "ï¼šç”Ÿäº§ç¬¬" + product.productNum + "ä¸ªäº§å“");

                product.consumer.signalAll();
            } finally {
                product.lock.unlock();
            }


            try {
                // æ”¾åœ¨åŒæ­¥å¤–æ›´åˆç†ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥æ­¤æ—¶æŠ¢å èµ„æº
                Thread.sleep(100);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}


class Consumer implements Runnable {

    private final Product product;

    public Consumer(Product product) {
        this.product = product;
    }

    @Override
    public void run() {
        while (true) {

            try {
                product.lock.lock();
                // while å’Œ wait ä¸€èµ·ä½¿ç”¨ï¼›ä¸èƒ½å•ç‹¬ä½¿ç”¨ ifï¼Œå¯èƒ½ä¼šç¼ºå°‘ä¸€æ¬¡åˆ¤æ–­
                // ä¸èƒ½ä½¿ç”¨ if...elseï¼Œä¼šå¯¼è‡´ wait å”¤é†’åå³ä½¿æ»¡è¶³æ¡ä»¶ä¹Ÿä¸èƒ½ç”Ÿäº§æˆ–æ¶ˆè´¹ï¼Œæµªè´¹äº† OS èµ„æº
                while (product.productNum <= 0) {
                    try {
                        product.consumer.await();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }

                System.out.println(Thread.currentThread().getName() + "ï¼šæ¶ˆè´¹ç¬¬" + product.productNum + "ä¸ªäº§å“");
                product.productNum--;

                product.productor.signalAll();
            } finally {
                product.lock.unlock();
            }

            // æ”¾åœ¨åŒæ­¥å¤–æ›´åˆç†ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥æ­¤æ—¶æŠ¢å èµ„æº
            try {
                Thread.sleep(200);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

class Product {
    // äº§å“æ•°é‡
    int productNum = 0;

    Lock lock = new ReentrantLock();
    Condition productor = lock.newCondition();
    Condition consumer = lock.newCondition();
}


public class PCTest {
    public static void main(String[] args) {
        Product product = new Product();
        new Thread(new Productor(product), "ç”Ÿäº§è€…1").start();
        new Thread(new Productor(product), "ç”Ÿäº§è€…2").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…1").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…2").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…3").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…4").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…5").start();
    }
}
```

#### JUC ç‰ˆæœ¬

