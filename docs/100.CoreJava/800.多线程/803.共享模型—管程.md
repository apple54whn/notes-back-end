---
title: å…±äº«æ¨¡å‹â€”ç®¡ç¨‹ï¼ˆæ‚²è§‚é”ï¼Œé˜»å¡ï¼‰
date: 2021-02-16 15:51:34
permalink: /pages/72c98e/
categories:
  - CoreJava
  - é«˜çº§
tags:
  -
---

# å¤šçº¿ç¨‹â€”å…±äº«æ¨¡å‹â€”ç®¡ç¨‹ï¼ˆæ‚²è§‚é”ï¼Œé˜»å¡ï¼‰

## å…±äº«å¸¦æ¥çš„çº¿ç¨‹å®‰å…¨é—®é¢˜

åœ¨ Java ä¸­çš„ä½“ç°

### å–ç¥¨é—®é¢˜

```java
@Slf4j(topic = "TestSafe")
public class TestSafe {
    public static void main(String[] args) throws InterruptedException {

        Runnable task = new Ticket();

        Thread t1 = new Thread(task, "çª—å£1");
        Thread t2 = new Thread(task, "çª—å£2");
        Thread t3 = new Thread(task, "çª—å£3");
        Thread t4 = new Thread(task, "çª—å£4");

        t1.start();
        t2.start();
        t3.start();
        t4.start();
    }
}

@Slf4j(topic = "Ticket")
class Ticket implements Runnable {
    private static int count = 1_000;// çº¿ç¨‹ç«äº‰ä¸æ˜æ˜¾å¯ä»¥å¢å¤§ç¥¨æ•°

    @Override
    public void run() {
        while (true) {
            if (count <= 0) {
                log.debug("{}è¯´: ç¥¨å·²ç»å–å®Œäº†", Thread.currentThread().getName());
                break;
            }
            try {
                // è¿›å…¥time waitingï¼Œæé«˜çº¿ç¨‹åˆ‡æ¢æ¦‚ç‡ï¼Œé”™ç¥¨å‡ ç‡
                TimeUnit.MILLISECONDS.sleep(10);
                log.debug("{}å–äº†ç¬¬{}å¼ ç¥¨", Thread.currentThread().getName(), count--);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}
```

é—®é¢˜ï¼š

*   ç›¸åŒçš„ç¥¨å‡ºç°å¤šæ¬¡ï¼šCPU çš„ä¸€æ¬¡æ“ä½œå¿…é¡»æ˜¯åŸå­æ€§çš„ï¼ˆä½†æ˜¯è¾“å‡ºè¯­å¥ä¸æ˜¯åŸå­çš„ï¼‰
*   å‡ºç°è´Ÿæ•°çš„ç¥¨ï¼šéšæœºæ€§å’Œå»¶è¿Ÿå¯¼è‡´



### è‡ªå¢è‡ªå‡é—®é¢˜

ä¸¤ä¸ªçº¿ç¨‹å¯¹åˆå§‹å€¼ä¸º 0 çš„**é™æ€å˜é‡ï¼ˆå±€éƒ¨å˜é‡å°±ä¸ä¸€æ ·äº†ï¼‰**ä¸€ä¸ªåšè‡ªå¢ï¼Œä¸€ä¸ªåšè‡ªå‡ï¼Œå„åš 5000 æ¬¡ï¼Œç»“æœæ˜¯ 0 å—ï¼Ÿ

```java
@Slf4j(topic = "TestCount")
public class TestCount {

    static int counter = 0;

    public static void main(String[] args) throws InterruptedException {
        test1();
    }
    
    public static void test1() throws InterruptedException {
        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                counter++;
            }
        }, "t1");
        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                counter--;
            }
        }, "t2");
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        log.debug("{}", counter);
    }
}
```



### é—®é¢˜åˆ†æ

ä»¥ä¸Šçš„ç»“æœå¯èƒ½æ˜¯æ­£æ•°ã€è´Ÿæ•°ã€é›¶ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º Java ä¸­å¯¹**é™æ€å˜é‡ï¼ˆå±€éƒ¨å˜é‡å°±ä¸ä¸€æ ·äº†ï¼‰**çš„è‡ªå¢ï¼Œè‡ªå‡å¹¶ä¸æ˜¯åŸå­æ“ä½œï¼Œè¦å½»åº•ç†è§£ï¼Œå¿…é¡»ä»å­—èŠ‚ç æ¥è¿›è¡Œåˆ†æã€‚ä¾‹å¦‚å¯¹äº i++ è€Œè¨€ï¼ˆi ä¸ºé™æ€å˜é‡ï¼‰ï¼Œå®é™…ä¼šäº§ç”Ÿå¦‚ä¸‹çš„ JVM å­—èŠ‚ç æŒ‡ä»¤ï¼š

```
getstatic i // è·å–é™æ€å˜é‡içš„å€¼
iconst_1 // å‡†å¤‡å¸¸é‡1
iadd // è‡ªå¢
putstatic i // å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i
```

è€Œå¯¹åº” i-- ä¹Ÿæ˜¯ç±»ä¼¼ï¼š

```
getstatic i // è·å–é™æ€å˜é‡içš„å€¼
iconst_1 // å‡†å¤‡å¸¸é‡1
isub // è‡ªå‡
putstatic i // å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i
```

è€Œ Java çš„å†…å­˜æ¨¡å‹å¦‚ä¸‹ï¼Œå®Œæˆé™æ€å˜é‡çš„è‡ªå¢ï¼Œè‡ªå‡éœ€è¦**åœ¨ä¸»å­˜å’Œå·¥ä½œå†…å­˜ä¸­è¿›è¡Œæ•°æ®äº¤æ¢**ï¼š

![image-20210216174313171](../images/image-20210216174313171.png)

å¦‚æœæ˜¯å•çº¿ç¨‹ä»¥ä¸Š 8 è¡Œä»£ç æ˜¯é¡ºåºæ‰§è¡Œï¼ˆä¸ä¼šäº¤é”™ï¼‰æ²¡æœ‰é—®é¢˜ï¼š

```mermaid
sequenceDiagram
participant t1 as çº¿ç¨‹1
participant i as static i
i ->> t1 : getstatic i è¯»å– 0
t1 ->> t1 : iconst_1 å‡†å¤‡å¸¸æ•° 1
t1 ->> t1 : iadd åŠ æ³•ï¼Œçº¿ç¨‹å†… i = 1
t1 ->> i : putstatic i å†™å…¥ 1

i ->> t1 : getstatic i è¯»å– 0
t1 ->> t1 : iconst_1 å‡†å¤‡å¸¸æ•° 1
t1 ->> t1 : isub å‡å»ï¼Œçº¿ç¨‹å†… i = -1
t1 ->> i : putstatic i å†™å…¥ 1
```

ä½†å¤šçº¿ç¨‹ä¸‹è¿™ 8 è¡Œä»£ç å¯èƒ½**äº¤é”™è¿è¡Œ**

ä¼šå‡ºç°è´Ÿæ•°çš„æƒ…å†µï¼š

```mermaid
sequenceDiagram
participant t1 as çº¿ç¨‹1
participant t2 as çº¿ç¨‹2
participant i as static i
	i ->> t1 : getstatic i è¯»å– 0
	t2 ->> t2 : iconst_1 å‡†å¤‡å¸¸æ•° 1
	t2 ->> t2 : isub å‡å»ï¼Œçº¿ç¨‹å†… i = -1
	t2 -->> t1 : ä¸Šä¸‹æ–‡åˆ‡æ¢
	
	i ->> t1 : getstatic i è¯»å– 0
	t1 ->> t1 : iconst_1 å‡†å¤‡å¸¸æ•° 1
	t1 ->> t1 : iadd åŠ æ³•ï¼Œçº¿ç¨‹å†… i = 1
	t1 ->> i : putstatic i å†™å…¥ 1
	
	t1 -->> t2 : ä¸Šä¸‹æ–‡åˆ‡æ¢
	t2 ->> i : putstatic i å†™å…¥ -1
```

å‡ºç°æ­£æ•°çš„æƒ…å†µï¼š

```mermaid
sequenceDiagram
participant t1 as çº¿ç¨‹1
participant t2 as çº¿ç¨‹2
participant i as static i
	i ->> t1 : getstatic i è¯»å– 0
	t1 ->> t1 : iconst_1 å‡†å¤‡å¸¸æ•° 1
	t1 ->> t1 : iadd åŠ æ³•ï¼Œçº¿ç¨‹å†… i = 1
	t1 -->> t2 : ä¸Šä¸‹æ–‡åˆ‡æ¢
	
	i ->> t2 : getstatic i è¯»å– 0
	t2 ->> t2 : iconst_1 å‡†å¤‡å¸¸æ•° 1
	t2 ->> t2 : isub å‡æ³•ï¼Œçº¿ç¨‹å†… i = -1
	t2 ->> i : putstatic i å†™å…¥ -1
	
	t2 -->> t1 : ä¸Šä¸‹æ–‡åˆ‡æ¢
	t1 ->> i : putstatic i å†™å…¥ 1
```





### çº¿ç¨‹å®‰å…¨é—®é¢˜æ€»ç»“ ğŸ”¥

åˆ†æ—¶ç³»ç»Ÿï¼Œçº¿ç¨‹åˆ‡æ¢æ—¶ï¼Œå¯¹ä¸´ç•ŒåŒºæ•°æ®è¯»å†™çš„éåŸå­æ€§ï¼Œä»¥åŠç¼“å­˜å¯¼è‡´æœ€ç»ˆå¯èƒ½å‘ç”Ÿ**çº¿ç¨‹å®‰å…¨é—®é¢˜**ã€‚å‡ºç°è¯¥é—®é¢˜çš„åŸå› ï¼š

*   **å¤šä¸ªçº¿ç¨‹åœ¨æ“ä½œå…±äº«èµ„æº**

*   **æ“ä½œå…±äº«èµ„æºçš„ä»£ç æœ‰å¤šæ¡ï¼ˆå¯èƒ½æ˜¯éåŸå­æ“ä½œï¼‰**

    å³å½“ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œæ“ä½œå…±äº«èµ„æºçš„å¤šæ¡ä»£ç ï¼ˆå¯èƒ½æ˜¯éåŸå­æ“ä½œï¼‰è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–çº¿ç¨‹å‚ä¸äº†è¿ç®—ï¼Œå°±ä¼šå¯¼è‡´

    OSçš„åˆ†æ—¶æ“ä½œï¼Œçº¿ç¨‹åˆ‡æ¢ï¼Œç¼“å­˜



### ä¸´ç•ŒåŒº Critical Section

*   ä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„

*   é—®é¢˜å‡ºåœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®**å…±äº«èµ„æº**

    *   å¤šä¸ªçº¿ç¨‹è¯»**å…±äº«èµ„æº**å…¶å®ä¹Ÿæ²¡æœ‰é—®é¢˜

    *   åœ¨å¤šä¸ªçº¿ç¨‹å¯¹**å…±äº«èµ„æº**è¯»å†™æ“ä½œæ—¶å‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜

ä¸´ç•ŒåŒº(critical section)æ˜¯æŒ‡è®¿é—®æŸä¸€å…±äº«èµ„æºçš„**ä»£ç ç‰‡æ®µ**ï¼Œå¹¶ä¸”è¿™æ®µä»£ç çš„æ‰§è¡Œ**åº”ä¸ºåŸå­(atomic) æ“ä½œ**ï¼Œ**å³ä¸´ç•ŒåŒºå†…çš„ä»£ç å¿…é¡»å¯¹å¤–æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œä¸ä¼šè¢«çº¿ç¨‹åˆ‡æ¢æ‰€æ‰“æ–­**

ä¾‹å¦‚ï¼Œä¸‹é¢ä»£ç ä¸­çš„ä¸´ç•ŒåŒºï¼ˆå¿…é¡»æœ‰synchronizedï¼Œå¦åˆ™æ— æ³•ä¿è¯ä¸´ç•ŒåŒºä»£ç çš„åŸå­æ“ä½œï¼‰

```java
static int counter = 0;
synchronized static void increment() { 
    // ä¸´ç•ŒåŒº
    counter++; 
}
synchronized static void decrement() { 
    // ä¸´ç•ŒåŒº
    counter--; 
}
```





### ç«æ€æ¡ä»¶ Race Condition

ç«äº‰æ¡ä»¶æ˜¯æŒ‡å¤šä¸ªä»»åŠ¡ä»¥**éäº’æ–¥**çš„æ–¹å¼åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¤§å®¶å¯¹å…¬å…±èµ„æºçš„è®¿é—®æ˜¯ä»¥ç«äº‰çš„æ–¹å¼å¹¶è¡Œè¿›è¡Œçš„ï¼Œå› æ­¤å…¬å…±èµ„æºçš„æœ€ç»ˆçŠ¶æ€ä¾èµ–äºè¿™äº›ä»»åŠ¡çš„ä¸´ç•ŒåŒºä¸­çš„å¾®æ“ä½œ**æ‰§è¡Œæ¬¡åº**ã€‚

å¤šä¸ªçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºå†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„**æ‰§è¡Œåºåˆ—ä¸åŒ**è€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œç§°ä¹‹ä¸ºå‘ç”Ÿäº†**ç«æ€æ¡ä»¶**







## è§£å†³æ–¹æ¡ˆæ€»è§ˆ ğŸ”¥

ä¸ºäº†**é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿ**ï¼Œæœ‰å¤šç§æ‰‹æ®µå¯ä»¥è¾¾åˆ°ç›®çš„ã€‚

*   **é˜»å¡å¼**çš„è§£å†³æ–¹æ¡ˆï¼š
    *   åŒæ­¥é”æœºåˆ¶ï¼š**synchronized**ï¼ˆåŒæ­¥ä»£ç å—ã€åŒæ­¥æ–¹æ³•ï¼‰
    *   Locké”æœºåˆ¶ï¼š**Lock**

*   **éé˜»å¡å¼**çš„è§£å†³æ–¹æ¡ˆ
    *   **åŸå­å˜é‡**







## synchronized å…³é”®å­— ğŸ”¥

### ä»‹ç»

`synchronized`å…³é”®å­—å¯ä»¥ç”¨äº**æ–¹æ³•ä¸­çš„æŸä¸ªåŒºå—ä¸­**ï¼Œè¡¨ç¤ºåªå¯¹è¿™ä¸ªåŒºå—çš„**èµ„æºå®è¡Œäº’æ–¥è®¿é—®**ã€‚è®©åŒä¸€æ—¶åˆ»è‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰ã€åŒæ­¥é”/å¯¹è±¡é”/å¯¹è±¡ç›‘è§†å™¨ã€‘ï¼Œå…¶å®ƒçº¿ç¨‹å†æƒ³è·å–è¿™ä¸ªã€åŒæ­¥é”/å¯¹è±¡é”/å¯¹è±¡ç›‘è§†å™¨ã€‘æ—¶å°±ä¼š**é˜»å¡**ä½ã€‚è¿™æ ·å°±èƒ½ä¿è¯æ‹¥æœ‰é”çš„çº¿ç¨‹å¯ä»¥å®‰å…¨çš„æ‰§è¡Œä¸´ç•ŒåŒºå†…çš„ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢

**æ³¨æ„**ï¼Œè™½ç„¶ java ä¸­äº’æ–¥å’ŒåŒæ­¥éƒ½å¯ä»¥é‡‡ç”¨ synchronized å…³é”®å­—æ¥å®Œæˆï¼Œä½†å®ƒä»¬è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼š

*   **äº’æ–¥**æ˜¯ä¿è¯ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸´ç•ŒåŒºä»£ç 

*   **åŒæ­¥**æ˜¯ç”±äºçº¿ç¨‹æ‰§è¡Œçš„å…ˆåã€é¡ºåºä¸åŒã€éœ€è¦ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶å®ƒçº¿ç¨‹è¿è¡Œåˆ°æŸä¸ªç‚¹

**synchronized çš„ä¼˜ç¼ºç‚¹ï¼š**

- **å¥½å¤„**ï¼šè§£å†³çº¿ç¨‹çš„å®‰å…¨é—®é¢˜ï¼ˆäº’æ–¥ï¼‰
- **å¼Šç«¯**ï¼šç›¸å¯¹**é™ä½æ•ˆç‡**ï¼ˆåŒæ­¥ï¼‰ï¼Œå› ä¸ºåŒæ­¥å¤–çš„çº¿ç¨‹éƒ½ä¼šåˆ¤æ–­åŒæ­¥é”ï¼›è‹¥æœ‰**åŒæ­¥åµŒå¥—å®¹æ˜“äº§ç”Ÿæ­»é”**

**åŒæ­¥é”/å¯¹è±¡é”/å¯¹è±¡ç›‘è§†å™¨**

- é”å¯¹è±¡å¯ä»¥æ˜¯**ä»»æ„ç±»å‹**
- å¤šä¸ªçº¿ç¨‹å¯¹è±¡è¦ä½¿ç”¨**åŒä¸€æŠŠé”**



### è¯­æ³•1â€”åŒæ­¥ä»£ç å—

é”çš„ç›®æ ‡æ˜¯å¯¹è±¡ï¼

```java
synchronized(å¯¹è±¡){// çº¿ç¨‹1è¿›å…¥åï¼Œçº¿ç¨‹2åˆ°è¿™é‡Œå°±è¢« blocked
    // ä¸´ç•ŒåŒº
}
```





### å–ç¥¨é—®é¢˜è§£å†³

```java
@Slf4j(topic = "SafeTicket")
class SafeTicket implements Runnable {
    private static int count = 1_000;// çº¿ç¨‹ç«äº‰ä¸æ˜æ˜¾å¯ä»¥å¢å¤§ç¥¨æ•°

    // final Object lock = new Object();

    @Override
    public void run() {
        // å–ç¥¨çª—å£ä¸€ç›´å¼€ç€ï¼Œä¸èƒ½åœ¨åŒæ­¥ä¸­ï¼Œå¦åˆ™å°±ä¼šè¢«ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œ
        while (true) {
            // synchronized éœ€åœ¨å†…éƒ¨å†™ï¼Œå¦åˆ™å…¶ä»–çº¿ç¨‹ä¼šè¿›ä¸å»ã€‚ç±»ä¼¼è¿›å…¥å•æ‰€ç„¶åé”é—¨ã€‚éœ€è¦åŒ…è£¹æ“ä½œå…±äº«èµ„æºçš„ä»£ç ã€‚
            // è¿˜å¯ä»¥å†™ thisï¼ˆæ³¨æ„å”¯ä¸€æ€§ï¼‰ã€SafeTicket.classã€ä¸Šé¢çš„å¯¹è±¡ lock
            synchronized (this) {
                if (count <= 0) {
                    log.debug("{}è¯´: ç¥¨å·²ç»å–å®Œäº†", Thread.currentThread().getName());
                    break;
                }
                try {
                    // è¿›å…¥time waitingï¼Œæé«˜çº¿ç¨‹åˆ‡æ¢æ¦‚ç‡ï¼Œé”™ç¥¨å‡ ç‡
                    TimeUnit.MILLISECONDS.sleep(10);
                    log.debug("{}å–äº†ç¬¬{}å¼ ç¥¨", Thread.currentThread().getName(), count--);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }
}

@Slf4j(topic = "TestSafe")
public class TestSafe {
    public static void main(String[] args) throws InterruptedException {

        Runnable task = new Ticket();

        Thread t1 = new Thread(task, "çª—å£1");
        Thread t2 = new Thread(task, "çª—å£2");
        Thread t3 = new Thread(task, "çª—å£3");
        Thread t4 = new Thread(task, "çª—å£4");

        t1.start();
        t2.start();
        t3.start();
        t4.start();
    }
}
```



### è‡ªå¢è‡ªå‡é—®é¢˜è§£å†³

```java
@Slf4j(topic = "TestCount")
public class TestCount {

    static int counter = 0;

    static final Object room = new Object();

    public static void main(String[] args) throws InterruptedException {
        // test1();
        test2();
    }

    /**
     * åŒæ­¥ä»£ç å—
     */
    public static void test2() throws InterruptedException {
        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                synchronized (room) {
                    counter++;
                }
            }
        }, "t1");
        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                synchronized (room) {
                    counter--;
                }
            }
        }, "t2");
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        log.debug("{}", counter);
    }
}
```



### åŸç† ğŸ”¥

ç±»æ¯”ï¼š

*   synchronized(å¯¹è±¡) ä¸­çš„å¯¹è±¡ï¼Œå¯ä»¥æƒ³è±¡ä¸ºä¸€ä¸ªæˆ¿é—´ï¼ˆroomï¼‰ï¼Œæœ‰å”¯ä¸€å…¥å£ï¼ˆé—¨ï¼‰æˆ¿é—´åªèƒ½ä¸€æ¬¡è¿›å…¥ä¸€äººè¿›è¡Œè®¡ç®—ï¼Œçº¿ç¨‹ t1ï¼Œt2 æƒ³è±¡æˆä¸¤ä¸ªäºº

*   å½“çº¿ç¨‹ t1 æ‰§è¡Œåˆ° synchronized(room) æ—¶å°±å¥½æ¯” t1 è¿›å…¥äº†è¿™ä¸ªæˆ¿é—´ï¼Œå¹¶é”ä½äº†é—¨æ‹¿èµ°äº†é’¥åŒ™ï¼Œåœ¨é—¨å†…æ‰§è¡Œcount++ ä»£ç 

*   è¿™æ—¶å€™å¦‚æœ t2 ä¹Ÿè¿è¡Œåˆ°äº† synchronized(room) æ—¶ï¼Œå®ƒå‘ç°é—¨è¢«é”ä½äº†ï¼Œåªèƒ½åœ¨é—¨å¤–ç­‰å¾…ï¼Œå‘ç”Ÿäº†ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œé˜»å¡ä½äº†

*   è¿™ä¸­é—´**å³ä½¿ t1 çš„ cpu æ—¶é—´ç‰‡ä¸å¹¸ç”¨å®Œï¼Œè¢«è¸¢å‡ºäº†é—¨å¤–**ï¼ˆä¸è¦é”™è¯¯ç†è§£ä¸ºé”ä½äº†å¯¹è±¡å°±èƒ½ä¸€ç›´æ‰§è¡Œä¸‹å»å“¦ï¼‰ï¼Œè¿™æ—¶**é—¨è¿˜æ˜¯é”ä½çš„ï¼Œt1 ä»æ‹¿ç€é’¥åŒ™ï¼Œt2 çº¿ç¨‹è¿˜åœ¨é˜»å¡çŠ¶æ€è¿›ä¸æ¥**ï¼Œåªæœ‰**ä¸‹æ¬¡è½®åˆ° t1 è‡ªå·±å†æ¬¡è·å¾—æ—¶é—´ç‰‡æ—¶æ‰èƒ½å¼€é—¨è¿›å…¥**
*   **å½“ t1 æ‰§è¡Œå®Œ synchronized{} å—å†…çš„ä»£ç ï¼Œè¿™æ—¶å€™æ‰ä¼šä» obj æˆ¿é—´å‡ºæ¥å¹¶è§£å¼€é—¨ä¸Šçš„é”ï¼Œå”¤é†’ t2 çº¿ç¨‹æŠŠé’¥åŒ™ç»™ä»–**ã€‚t2 çº¿ç¨‹è¿™æ—¶æ‰å¯ä»¥è¿›å…¥ obj æˆ¿é—´ï¼Œé”ä½äº†é—¨æ‹¿ä¸Šé’¥åŒ™ï¼Œæ‰§è¡Œå®ƒçš„ count-- ä»£ç 

ç”¨å›¾è¡¨ç¤ºï¼š

```mermaid
sequenceDiagram
participant t1 as çº¿ç¨‹1
participant t2 as çº¿ç¨‹2
participant i as static i
participant lock as é”å¯¹è±¡
	t2 ->> lock : å°è¯•è·å–é”
	note over t2,lock: æ‹¥æœ‰é”
	i ->> t1 : getstatic i è¯»å– 0
	t2 ->> t2 : iconst_1 å‡†å¤‡å¸¸æ•° 1
	t2 ->> t2 : isub å‡å»ï¼Œçº¿ç¨‹å†… i = -1
	t2 -->> t1 : ä¸Šä¸‹æ–‡åˆ‡æ¢
	
	t1 -x lock : å°è¯•è·å–é”ï¼Œè¢«é˜»å¡ï¼ˆBLOCKEDï¼‰
	
	t1 -->> t2 : ä¸Šä¸‹æ–‡åˆ‡æ¢
	t2 ->> i : putstatic i å†™å…¥ -1
	note over t2,lock: æ‹¥æœ‰é”
	t2 ->> lock : é‡Šæ”¾é”ï¼Œå¹¶å”¤é†’é˜»å¡çš„çº¿ç¨‹
	
	note over t1,lock: æ‹¥æœ‰é”
	i ->> t1 : getstatic i è¯»å– 0
	t1 ->> t1 : iconst_1 å‡†å¤‡å¸¸æ•° 1
	t1 ->> t1 : iadd åŠ æ³•ï¼Œçº¿ç¨‹å†… i = 1
	t1 ->> i : putstatic i å†™å…¥ 1
	note over t1,lock: æ‹¥æœ‰é”
	t1 ->> lock : é‡Šæ”¾é”ï¼Œå¹¶å”¤é†’é˜»å¡çš„çº¿ç¨‹
```



### æ€è€ƒ

synchronized å®é™…æ˜¯ç”¨**å¯¹è±¡é”**ä¿è¯äº†**ä¸´ç•ŒåŒºå†…ä»£ç çš„åŸå­æ€§ï¼ˆä¸´ç•ŒåŒºå†…çš„ä»£ç å¿…é¡»å¯¹å¤–æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œä¸ä¼šè¢«çº¿ç¨‹åˆ‡æ¢æ‰€æ‰“æ–­ï¼‰**ã€‚ä¸ºäº†åŠ æ·±ç†è§£ï¼Œè¯·æ€è€ƒä¸‹é¢çš„é—®é¢˜ï¼ˆè‡ªå¢è‡ªå‡é—®é¢˜ï¼‰ï¼š

*   å¦‚æœæŠŠ synchronized(obj) æ”¾åœ¨ for å¾ªç¯çš„å¤–é¢ï¼Œå¦‚ä½•ç†è§£ï¼Ÿ-- å¯¹forå¾ªç¯æ•´ä½“ä¿è¯åŸå­æ€§

*   å¦‚æœ t1 synchronized(obj1) è€Œ t2 synchronized(obj2) ä¼šæ€æ ·è¿ä½œï¼Ÿ-- é”å¯¹è±¡ä¸åŒï¼Œæ— æ³•ä¿è¯åŒæ­¥äº’æ–¥

*   å¦‚æœ t1 synchronized(obj) è€Œ t2 æ²¡æœ‰åŠ ä¼šæ€ä¹ˆæ ·ï¼Ÿå¦‚ä½•ç†è§£ï¼Ÿ-- é”å¯¹è±¡ä¸åŒï¼Œä¸€ä¸ªæœ‰ä¸€ä¸ªæ²¡æœ‰ï¼Œåˆ™ä¼šå‘ç”Ÿçº¿ç¨‹å®‰å…¨é—®é¢˜

    åŠ æ³•ä¸åŠ é”åˆ™æ˜¯æ­£æ•°å‡ ç‡å¤§ï¼Œå‡æ³•ä¸åŠ é”åˆ™æ˜¯è´Ÿæ•°å‡ ç‡å¤§ï¼Œä¸ºå•¥äº†ã€‚ã€‚





### è‡ªå¢è‡ªå‡é¢å‘å¯¹è±¡æ”¹è¿›

```java
@Slf4j(topic = "TestCount2")
public class TestCount2 {

    public static void main(String[] args) throws InterruptedException {
        Room room = new Room();

        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                room.increment();
            }
        }, "t1");
        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                room.decrement();
            }
        }, "t2");
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        log.debug("{}", room.getCount());
    }
}

class Room {
    private int count = 0;

    public void increment(){
        synchronized (this){
            count++;
        }
    }

    public void decrement(){
        synchronized (this){
            count--;
        }
    }

    public int getCount(){
        synchronized (this){
            return count;
        }
    }
}
```





### è¯­æ³•2â€”åŒæ­¥æ–¹æ³• & é”å¯¹è±¡ ğŸ”¥

**æ­¤æ—¶åŒæ­¥é”æ˜¯è°ï¼Ÿé”çš„ç›®æ ‡è¿˜æ˜¯å¯¹è±¡**ï¼Œä¸æ˜¯é”æ–¹æ³•ï¼

- å¯¹äº**é static æ–¹æ³•**ï¼ŒåŒæ­¥é”å°±æ˜¯**this**ï¼Œæ­¤æ—¶ä»£è¡¨è°ƒç”¨ run æ–¹æ³•çš„å¯¹è±¡

- å¯¹äº**static æ–¹æ³•**ï¼ŒåŒæ­¥é”å½“å‰æ–¹æ³•æ‰€åœ¨ç±»çš„å­—èŠ‚ç å¯¹è±¡(**ç±»å.class**)ï¼Œ**ä¸æ–¹æ³•è°ƒç”¨è€…æ— å…³**ï¼ï¼ï¼

    ä½¿ç”¨ç»§æ‰¿ Thread ç±»å’ŒåŒæ­¥æ–¹æ³•å®ç°æ—¶ï¼Œéœ€è¦å†™ `static synchronized`

```java
class Test {
    public synchronized void test(){
        // ä¸´ç•ŒåŒº
    }
}

// ç­‰ä»·äºï¼ˆè‡ªåŠ¨è½¬æ¢ï¼‰
class Test {
    public void test(){
        synchronized(this){
            // ä¸´ç•ŒåŒº
        }
    }
}
```

```java
class Test {
    public synchronized static void test(){
        // ä¸´ç•ŒåŒº
    }
}

// ç­‰ä»·äºï¼ˆè‡ªåŠ¨è½¬æ¢ï¼‰
class Test {
    public void test(){
        synchronized(Test.class){
            // ä¸´ç•ŒåŒº
        }
    }
}
```

æ”¹è¿›ä»£ç å¦‚ä¸‹ï¼š

```java
@Slf4j(topic = "TestCount2")
public class TestCount2 {

    public static void main(String[] args) throws InterruptedException {
        Room room = new Room();

        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                room.increment();
            }
        }, "t1");
        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                room.decrement();
            }
        }, "t2");
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        log.debug("{}", room.getCount());
    }
}

class Room {
    private int count = 0;

    public synchronized void increment() {
        count++;
    }

    public synchronized void decrement() {
        count--;
    }

    public synchronized int getCount() {
        return count;
    }
}
```





### "çº¿ç¨‹å…«é”" ğŸ”¥

è€ƒå¯Ÿ synchronized é”ä½çš„æ˜¯å“ªä¸ªå¯¹è±¡

#### æƒ…å†µ1

ç»“æœï¼š12 æˆ– 21

é”æ˜¯ this å¯¹è±¡ï¼ˆåº•å±‚æŸ¥çœ‹ n1 å¯¹è±¡å¤´éƒ¨ä¿¡æ¯ï¼‰

```java
public class Test1 {

    public static void main(String[] args) {
        Number n1 = new Number();
        new Thread(n1::a).start();
        new Thread(n1::b).start();
    }
}

@Slf4j(topic = "Number")
class Number{
    public synchronized void a() {
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
}
```



#### æƒ…å†µ2

ç»“æœï¼š1så12ï¼Œæˆ– 2 1så 1

```java
public class Test1 {

    public static void main(String[] args) {
        Number n1 = new Number();
        new Thread(n1::a).start();
        new Thread(n1::b).start();
    }
}

@Slf4j(topic = "Number")
class Number{
    public synchronized void a() {
        try {
            TimeUnit.SECONDS.sleep(1);// sleep ä¸ä¼šé‡Šæ”¾é”ï¼Œä¼šé‡Šæ”¾å¤„ç†æœº
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
}
```



#### æƒ…å†µ3

ç»“æœï¼š3 1s 12 æˆ– 23 1s 1 æˆ– 32 1s 1

*   è‹¥aå…ˆè·å¾—é”ï¼Œåˆ™3å…ˆæ‰“å°ï¼Œ1så1æ‰“å°ï¼Œ2æ‰“å°
*   è‹¥bå…ˆè·å¾—é”ï¼Œåˆ™2æˆ–3å…ˆæ‰“å°ï¼Œ1så1æ‰“å°

```java
public class Test3 {

    public static void main(String[] args) {
        Number3 n1 = new Number3();
        new Thread(n1::a).start();
        new Thread(n1::b).start();
        new Thread(n1::c).start();
    }
}

@Slf4j(topic = "Number")
class Number3{
    public synchronized void a() {
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }

    public void c() {
        log.debug("3");
    }
}
```



#### æƒ…å†µ4

ç»“æœï¼š2 1s å 1

*   é¦–å…ˆé”å¯¹è±¡éƒ½ä¸æ˜¯åŒä¸€ä¸ªäº†ï¼æ‰€ä»¥ä¿©çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œ
*   aéœ€è¦ç­‰1sï¼Œæ‰€ä»¥æ˜¯å…ˆæ‰“å°2ï¼Œ1såæ‰“å°1

```java
public class Test4 {

    public static void main(String[] args) {
        Number4 n1 = new Number4();
        Number4 n2 = new Number4();
        new Thread(n1::a).start();
        new Thread(n2::b).start();
    }
}

@Slf4j(topic = "Number")
class Number4{
    public synchronized void a() {
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
}
```



#### æƒ…å†µ5

ç»“æœï¼š2 1s å 1

*   é¦–å…ˆé”å¯¹è±¡éƒ½ä¸æ˜¯åŒä¸€ä¸ªäº†ï¼**static æ–¹æ³•ä¸æ˜¯çœ‹è°ƒç”¨è€…ï¼Œæ˜¯çœ‹è§„åˆ™**ï¼

    açš„é”æ˜¯Number4.classå¯¹è±¡ï¼Œbçš„é”æ˜¯thiså¯¹è±¡ï¼Œæ‰€ä»¥ä¿©çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œ

*   aéœ€è¦ç­‰1sï¼Œæ‰€ä»¥æ˜¯å…ˆæ‰“å°2ï¼Œ1såæ‰“å°1

```java
public class Test5 {

    public static void main(String[] args) {
        Number5 n1 = new Number5();
        new Thread(() -> n1.a()).start();
        new Thread(() -> n1.b()).start();
    }
}

@Slf4j(topic = "Number")
class Number5{
    public static synchronized void a() {
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
}
```



#### æƒ…å†µ6

ç»“æœï¼š1så12ï¼Œæˆ– 2 1så 1

*   é”å¯¹è±¡éƒ½æ˜¯ Number6.class ï¼Œæ‰€ä»¥åŒæ­¥äº’æ–¥è¿è¡Œ

```java
public class Test6 {

    public static void main(String[] args) {
        new Thread(Number6::a).start();
        new Thread(Number6::b).start();
    }
}

@Slf4j(topic = "Number")
class Number6{
    public static synchronized void a() {
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("1");
    }
    public static synchronized void b() {
        log.debug("2");
    }
}
```



#### æƒ…å†µ7

*   ç»“æœï¼š2 1s å 1
    *   é¦–å…ˆé”å¯¹è±¡éƒ½ä¸æ˜¯åŒä¸€ä¸ªäº†ï¼Œæ‰€ä»¥ä¿©çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œ
    *   aéœ€è¦ç­‰1sï¼Œæ‰€ä»¥æ˜¯å…ˆæ‰“å°2ï¼Œ1såæ‰“å°1

```java
public class Test7 {

    public static void main(String[] args) {
        Number7 n1 = new Number7();
        Number7 n2 = new Number7();
        new Thread(() -> n1.a()).start();
        new Thread(() -> n2.b()).start();
    }
}

@Slf4j(topic = "Number")
class Number7{
    public static synchronized void a() {
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
}
```



#### æƒ…å†µ8

ç»“æœï¼š1så12ï¼Œæˆ– 2 1så 1

*   è™½ç„¶çœ‹ç€æ˜¯newäº†ä¸åŒçš„å¯¹è±¡ï¼Œä½†æ˜¯å®é™…è°ƒç”¨ä¼šè½¬ä¸ºç±»staticè°ƒç”¨ï¼Œæ‰€ä»¥æ˜¯åŒä¸€é”å¯¹è±¡

```java
public class Test8 {

    public static void main(String[] args) {
        Number8 n1 = new Number8();
        Number8 n2 = new Number8();
        new Thread(() -> n1.a()).start();
        new Thread(() -> n2.b()).start();
    }
}

@Slf4j(topic = "Number")
class Number8{
    public static synchronized void a() {
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("1");
    }
    public static synchronized void b() {
        log.debug("2");
    }
}
```





## å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ ğŸ”¥

### æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ

*   å¦‚æœå®ƒä»¬**æ²¡æœ‰å…±äº«ï¼Œåˆ™çº¿ç¨‹å®‰å…¨**
*   å¦‚æœå®ƒä»¬è¢«**å…±äº«**äº†ï¼Œæ ¹æ®å®ƒä»¬çš„çŠ¶æ€æ˜¯å¦èƒ½å¤Ÿæ”¹å˜ï¼Œåˆåˆ†ä¸¤ç§æƒ…å†µ
    *   å¦‚æœ**åªæœ‰è¯»**æ“ä½œï¼Œåˆ™**çº¿ç¨‹å®‰å…¨**
    *   å¦‚æœ**æœ‰è¯»å†™**æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦**è€ƒè™‘çº¿ç¨‹å®‰å…¨**



### å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ

*   **å±€éƒ¨å˜é‡**æ˜¯**çº¿ç¨‹å®‰å…¨**çš„
*   ä½†**å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡åˆ™æœªå¿…**ğŸ”¥
    *   å¦‚æœè¯¥å¯¹è±¡**æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨è®¿é—®**ï¼Œå®ƒæ˜¯**çº¿ç¨‹å®‰å…¨**çš„
    *   å¦‚æœè¯¥å¯¹è±¡**é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´**ï¼Œéœ€è¦**è€ƒè™‘çº¿ç¨‹å®‰å…¨**



### åˆ†æâ€”æˆå‘˜å˜é‡â€”List#add Ã— ğŸ”¥

```java
class Test {
    static final int THREAD_NUMBER = 2;
    static final int LOOP_NUMBER = 200;

    public static void main(String[] args) {
        ThreadUnsafe test = new ThreadUnsafe();
        for (int i = 0; i < THREAD_NUMBER; i++) {
            new Thread(() -> {
                test.method1(LOOP_NUMBER);
            }, "Thread" + i).start();
        }
    }
}

class ThreadUnsafe {

    /* æˆå‘˜å˜é‡ */
    ArrayList<String> list = new ArrayList<>();

    public void method1(int loopNumber) {
        for (int i = 0; i < loopNumber; i++) {
            // ä¸´ç•ŒåŒº, ä¼šäº§ç”Ÿç«æ€æ¡ä»¶
            method2();
            method3();
            // ä¸´ç•ŒåŒº
        }
    }

    private void method2() {
        list.add("1");
    }

    private void method3() {
        list.remove(0);
    }
}
```

è¿™é‡Œé¢æœ¬æ¥method2æ‰§è¡Œå®Œaddåå†æ‰§è¡Œmethod3çš„removeæ˜¯æ— è®ºå¦‚ä½•ä¸ä¼šå‡ºé”™çš„ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸‹ï¼Œ**addæ–¹æ³•ä¸æ˜¯åŸå­æ€§**çš„ï¼š

```java
public boolean add(E e) {
    ensureCapacityInternal(size + 1);  // Increments modCount!!
    elementData[size++] = e;
    return true;
}
```

**æœ‰å¯èƒ½2ä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œaddæ—¶ï¼Œæ‹¿åˆ°äº†åŒä¸€ä¸ªsize**ï¼Œå³**åªæ·»åŠ äº†ä¸€ä¸ªå…ƒç´ **ï¼æ­¤æ—¶è¦æ˜¯è°ƒç”¨ç¬¬äºŒä¸ªremoveå°±ä¼šæŠ›å¦‚ä¸‹å¼‚å¸¸ï¼š

```
Exception in thread "Thread0" java.lang.IndexOutOfBoundsException: Index: 0, Size: 0
	at java.util.ArrayList.rangeCheck(ArrayList.java:657)
	at java.util.ArrayList.remove(ArrayList.java:496)
	at _10_var_safe.ThreadUnsafe.method3(ThreadUnsafe.java:23)
	at _10_var_safe.ThreadUnsafe.method1(ThreadUnsafe.java:14)
	at _10_var_safe.ThreadUnsafe.lambda$main$0(ThreadUnsafe.java:37)
	at java.lang.Thread.run(Thread.java:748)
```

ä¸è‡ªå¢è‡ªå‡ä¸åŒçš„æ˜¯ï¼Œè‡ªå¢è‡ªå‡ä¸­2ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«è¿›è¡Œå¢ã€å‡æ“ä½œï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªçº¿ç¨‹å†…è¿›è¡Œå¢å‡æ“ä½œ

åˆ†æï¼š

*   æ— è®ºå“ªä¸ªçº¿ç¨‹ä¸­çš„ method2 å¼•ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ä¸­çš„ list æˆå‘˜å˜é‡

*   method3 ä¸ method2 åˆ†æç›¸åŒ

![image-20210217160309358](../images/image-20210217160309358.png)





### åˆ†æâ€”å±€éƒ¨æ™®é€šå˜é‡ âœ“

å¦‚ä¸‹ä»£ç ï¼š

```java
public static void test1() {
    int i = 10; 
    i++; 
}
```

æ¯ä¸ªçº¿ç¨‹è°ƒç”¨ test1() æ–¹æ³•æ—¶å±€éƒ¨å˜é‡ iï¼Œä¼šåœ¨æ¯ä¸ªçº¿ç¨‹çš„æ ˆå¸§å†…å­˜ä¸­è¢«åˆ›å»ºå¤šä»½ï¼Œå› æ­¤ä¸å­˜åœ¨å…±äº«

```
public static void test1();

	descriptor: ()V
    flags: ACC_PUBLIC, ACC_STATIC
	Code:
		stack=1, locals=1, args_size=0 
			0: bipush 10
			2: istore_0
			3: iinc 0, 1 
			6: return
		LineNumberTable:
			line 10: 0
			line 11: 3
			line 12: 6
		LocalVariableTable:
			Start Length Slot Name Signature
			3 		4 		0 	i 		I
```

å¦‚å›¾ï¼š

![image-20210217154731430](../images/image-20210217154731430.png)





### åˆ†æâ€”å±€éƒ¨å˜é‡ä¸ºå¼•ç”¨å¯¹è±¡ âœ“

å°† list ä¿®æ”¹ä¸ºå±€éƒ¨å˜é‡

```java
class Test {
    static final int THREAD_NUMBER = 2;
    static final int LOOP_NUMBER = 200;

    public static void main(String[] args) {
        ThreadSafe test = new ThreadSafe();
        for (int i = 0; i < THREAD_NUMBER; i++) {
            new Thread(() -> {
                test.method1(LOOP_NUMBER);
            }, "Thread" + i).start();
        }
    }
}

class ThreadSafe {

    public void method1(int loopNumber) {
        ArrayList<String> list = new ArrayList<>();
        for (int i = 0; i < loopNumber; i++) {
            // ä¸´ç•ŒåŒº, ä¼šäº§ç”Ÿç«æ€æ¡ä»¶
            method2(list);
            method3(list);
            // ä¸´ç•ŒåŒº
        }
    }

    private void method2(ArrayList<String> list) {
        list.add("1");
    }

    private void method3(ArrayList<String> list) {
        list.remove(0);
    }
}
```

é‚£ä¹ˆå°±ä¸ä¼šæœ‰ä¸Šè¿°é—®é¢˜äº†

åˆ†æï¼š

*   list æ˜¯å±€éƒ¨å˜é‡ï¼Œ**æ¯ä¸ªçº¿ç¨‹è°ƒç”¨æ—¶ä¼šåˆ›å»ºå…¶ä¸åŒå®ä¾‹ï¼Œæ²¡æœ‰å…±äº«**

*   è€Œ method2 çš„å‚æ•°æ˜¯ä» method1 ä¸­ä¼ é€’è¿‡æ¥çš„ï¼Œä¸ method1 ä¸­å¼•ç”¨åŒä¸€ä¸ªå¯¹è±¡

*   method3 çš„å‚æ•°åˆ†æä¸ method2 ç›¸åŒ

![image-20210217160523996](../images/image-20210217160523996.png)



### åˆ†æâ€”å±€éƒ¨å˜é‡ä¸ºå¼•ç”¨å¯¹è±¡å¹¶æš´éœ² Ã— 

æ–¹æ³•è®¿é—®ä¿®é¥°ç¬¦å¸¦æ¥çš„æ€è€ƒï¼Œå¦‚æœæŠŠ method2 å’Œ method3 çš„æ–¹æ³•ä¿®æ”¹ä¸º public ä¼šä¸ä¼šä»£ç†çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ

*   æƒ…å†µ1ï¼šæœ‰å…¶å®ƒçº¿ç¨‹è°ƒç”¨ method2 å’Œ method3

    æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºæ“ä½œçš„listå¯¹è±¡è¿˜æ˜¯å„çº¿ç¨‹ç§æœ‰çš„

*   æƒ…å†µ2ï¼šåœ¨ æƒ…å†µ1 çš„åŸºç¡€ä¸Šï¼Œä¸º ThreadSafe ç±»æ·»åŠ å­ç±»ï¼Œå­ç±»è¦†ç›– method2 æˆ– method3 æ–¹æ³•ï¼Œå³

```java
class Test2 {
    static final int THREAD_NUMBER = 2;
    static final int LOOP_NUMBER = 200;

    public static void main(String[] args) {
        ThreadSafe2Sub test = new ThreadSafe2Sub();
        for (int i = 0; i < THREAD_NUMBER; i++) {
            new Thread(() -> test.method1(LOOP_NUMBER), "Thread" + i).start();
        }
    }
}


class ThreadSafe2 {

    public void method1(int loopNumber) {
        ArrayList<String> list = new ArrayList<>();
        for (int i = 0; i < loopNumber; i++) {
            // ä¸´ç•ŒåŒº, ä¼šäº§ç”Ÿç«æ€æ¡ä»¶
            method2(list);
            method3(list);
            // ä¸´ç•ŒåŒº
        }
    }

    public void method2(ArrayList<String> list) {
        list.add("1");
    }

    public void method3(ArrayList<String> list) {
        list.remove(0);
    }
}

class ThreadSafe2Sub extends ThreadSafe2{
    // @Override
    // public void method2(ArrayList<String> list) {
    //     new Thread(()-> list.add("1")).start();
    // }

    @Override
    public void method3(ArrayList<String> list) {
        new Thread(()-> list.remove(0)).start();
    }
}
```

è¿™æ ·å°±å¯¼è‡´å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€èµ„æºè¿›è¡Œæ“ä½œï¼Œä¸”æ“ä½œçš„è¯­å¥æœ‰å¤šæ¡ï¼removeåº•å±‚ï¼š

```java
public E remove(int index) {
    rangeCheck(index);

    modCount++;
    E oldValue = elementData(index);

    int numMoved = size - index - 1;
    if (numMoved > 0)
        System.arraycopy(elementData, index+1, elementData, index,
                         numMoved);
    elementData[--size] = null; // clear to let GC do its work

    return oldValue;
}
```





### å¸¸è§çº¿ç¨‹å®‰å…¨ç±»â€”åŒæ­¥é”

*   StringBuffer
*   Random
*   ~~Vector~~ï¼šä¸æ¨è
*   ~~Hashtable~~ï¼šä¸æ¨è
*   java.util.concurrent åŒ…ä¸‹çš„ç±»

è¿™é‡Œè¯´å®ƒä»¬æ˜¯çº¿ç¨‹å®‰å…¨çš„æ˜¯æŒ‡ï¼Œ**å¤šä¸ªçº¿ç¨‹è°ƒç”¨**å®ƒä»¬**åŒä¸€ä¸ªå®ä¾‹çš„æŸä¸ªæ–¹æ³•æ—¶**ï¼Œæ˜¯**çº¿ç¨‹å®‰å…¨**çš„ã€‚ä¹Ÿå¯ä»¥ç†è§£ä¸º

```java
Hashtable table = new Hashtable();
new Thread(()->{
    table.put("key", "value1");
}).start();
new Thread(()->{
    table.put("key", "value2");
}).start();
```

å®ƒä»¬çš„**æ¯ä¸ªæ–¹æ³•æ˜¯åŸå­**çš„ã€‚ä½†**æ³¨æ„**å®ƒä»¬**å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­**çš„ï¼š

```java
Hashtable table = new Hashtable();
new Thread(()->{
    if(table.get("key")==null){
        table.put("key", "value");
    }
}).start();
```

```mermaid
sequenceDiagram
participant t1 as çº¿ç¨‹1
participant t2 as çº¿ç¨‹2
participant table
t1 ->> table : get("key") == null
t2 ->> table : get("key") == null
t2 ->> table : put("key", "value)
t1 ->> table : put("key", "value)
```

æ¯ä¸ªåŸå­æ“ä½œæ‰§è¡Œå®Œåéƒ½ä¼šé‡Šæ”¾é”ï¼Œå¹¶å”¤é†’å…¶ä»–é˜»å¡çº¿ç¨‹ã€‚è¿™é‡Œçš„getã€putæ–¹æ³•éƒ½æ˜¯åŒä¸€æŠŠé”



### å¸¸è§çº¿ç¨‹å®‰å…¨ç±»â€”ä¸å¯å˜ç±»

*   String
*   Integer

Stringã€Integer ç­‰éƒ½æ˜¯ä¸å¯å˜ç±»ï¼Œå› ä¸ºå…¶å†…éƒ¨çš„çŠ¶æ€ä¸å¯ä»¥æ”¹å˜ï¼Œå› æ­¤å®ƒä»¬çš„æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„

æœ‰åŒå­¦æˆ–è®¸æœ‰ç–‘é—®ï¼ŒString æœ‰ replaceï¼Œsubstring ç­‰æ–¹æ³•ã€å¯ä»¥ã€‘æ”¹å˜å€¼å•Šï¼Œé‚£ä¹ˆè¿™äº›æ–¹æ³•åˆæ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„å‘¢ï¼Ÿ

å› ä¸º**æ²¡æœ‰æ”¹å˜åŸæœ‰çš„å€¼**ï¼Œæ˜¯**é‡æ–°newä¸€ä¸ªå¯¹è±¡å¹¶è¿”å›**çš„ï¼





### å®ä¾‹åˆ†æ ğŸ”¥

**å¦‚ä¸‹å®ä¾‹ä¸­ï¼ŒServlet éƒ½æ˜¯å•ä¾‹çš„ï¼ï¼ï¼æ‰€ä»¥å…¶æ‰€æœ‰ Serviceã€Dao ä¹Ÿéƒ½æ˜¯å•ä¾‹çš„**

[Servletå‚è€ƒåšå®¢](https://www.cnblogs.com/stono/p/14234241.html)



#### ä¾‹1

```java
public class MyServlet extends HttpServlet {
    // æ˜¯å¦å®‰å…¨ï¼Ÿå¦
    Map<String,Object> map = new HashMap<>();
    // æ˜¯å¦å®‰å…¨ï¼Ÿæ˜¯
    String S1 = "...";
    // æ˜¯å¦å®‰å…¨ï¼Ÿæ˜¯
    final String S2 = "...";
    // æ˜¯å¦å®‰å…¨ï¼Ÿå¦
    Date d1 = new Date();
    // æ˜¯å¦å®‰å…¨ï¼Ÿå¦ï¼Œåªæ˜¯ d2 è¿™ä¸ªå¼•ç”¨å€¼ä¸èƒ½å˜ï¼Œå…¶å¯¹è±¡å†…éƒ¨å±æ€§æ˜¯å¯å˜çš„
    final Date d2 = new Date();

    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        // ä½¿ç”¨ä¸Šè¿°å˜é‡
    }
}
```



#### ä¾‹2

```java
// MyServlet åªæœ‰ä¸€ä»½ï¼Œæ¯ä¸ªçº¿ç¨‹è®¿é—®éƒ½ä¼šæœ‰ä¸€ä»½
public class MyServlet extends HttpServlet {
    // æ˜¯å¦å®‰å…¨ï¼Ÿæˆå‘˜å˜é‡ï¼Œå¯èƒ½æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚UserServiceImplä¸­æœ‰æˆå‘˜å˜é‡ï¼Œå¹¶æœ‰å¯¹è¯¥æˆå‘˜å˜é‡çš„ä¿®æ”¹æ“ä½œ
    private UserService userService = new UserServiceImpl();
    
    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        userService.update(...);
    }
}
public class UserServiceImpl implements UserService {
    // è®°å½•è°ƒç”¨æ¬¡æ•°
    // æˆå‘˜å˜é‡ï¼Œå¯èƒ½æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜
    private int count = 0;
    public void update() {
        // ...åŒæ ·
        count++;
    }
}
```



#### ä¾‹3

```java
@Aspect
@Component// Springç»„ä»¶é»˜è®¤å•ä¾‹
public class MyAspect {
    // æ˜¯å¦å®‰å…¨ï¼Ÿæˆå‘˜å˜é‡ï¼Œå¯èƒ½æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜
    private long start = 0L;
    @Before("execution(* *(..))")
    public void before() {
        start = System.nanoTime();
    }
    @After("execution(* *(..))")
    public void after() {
        long end = System.nanoTime();
        System.out.println("cost time:" + (end-start));
    }
}
```

å¯ä»¥ä½¿ç”¨ç¯ç»•é€šçŸ¥ï¼Œå°†å˜é‡æ”¹ä¸ºå±€éƒ¨å˜é‡



#### ä¾‹4

```java
public class MyServlet extends HttpServlet {
    // æ˜¯å¦å®‰å…¨ã€‚æ˜¯ã€‚æ²¡æœ‰å¯¹userServiceè¿›è¡Œä¿®æ”¹çš„æ“ä½œ
    private UserService userService = new UserServiceImpl();
    
    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        userService.update(...);
    }
}
public class UserServiceImpl implements UserService {
    // æ˜¯å¦å®‰å…¨ã€‚æ˜¯ã€‚æ²¡æœ‰å¯¹userDaoè¿›è¡Œä¿®æ”¹çš„æ“ä½œ
    private UserDao userDao = new UserDaoImpl();
    public void update() {
        userDao.update();
    }
}
public class UserDaoImpl implements UserDao { 
    public void update() {
        String sql = "update user set password = ? where username = ?";
        // æ˜¯å¦å®‰å…¨ã€‚æ˜¯ã€‚æ²¡æœ‰æˆå‘˜å˜é‡ï¼Œåªæœ‰å±€éƒ¨å˜é‡ä¸€èˆ¬éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„
        try (Connection conn = DriverManager.getConnection("","","")){
            // ...
        } catch (Exception e) {
            // ...
        }
    }
}
```



#### ä¾‹5

```java
public class MyServlet extends HttpServlet {
    // æ˜¯å¦å®‰å…¨ã€‚æ˜¯ã€‚æ²¡æœ‰å¯¹userServiceè¿›è¡Œä¿®æ”¹çš„æ“ä½œ
    private UserService userService = new UserServiceImpl();
    
    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        userService.update(...);
    }
}
public class UserServiceImpl implements UserService {
    // æ˜¯å¦å®‰å…¨ã€‚æ˜¯ã€‚æ²¡æœ‰å¯¹userDaoè¿›è¡Œä¿®æ”¹çš„æ“ä½œ
    private UserDao userDao = new UserDaoImpl();
    
    public void update() {
        userDao.update();
    }
}
public class UserDaoImpl implements UserDao {
    // æ˜¯å¦å®‰å…¨ã€‚å¦ã€‚æˆå‘˜å˜é‡ï¼Œä¸”æœ‰å¯¹æˆå‘˜å˜é‡çš„ä¿®æ”¹æ“ä½œï¼Œå¦‚close
    private Connection conn = null;
    public void update() throws SQLException {
        String sql = "update user set password = ? where username = ?";
        conn = DriverManager.getConnection("","","");
        // ...
        conn.close();
    }
}
```



#### ä¾‹6

```java
public class MyServlet extends HttpServlet {
    // æ˜¯å¦å®‰å…¨ã€‚æ˜¯
    private UserService userService = new UserServiceImpl();
    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        userService.update(...);
    }
}
public class UserServiceImpl implements UserService { 
    // æ˜¯å¦å®‰å…¨ã€‚æ˜¯
    public void update() {
        UserDao userDao = new UserDaoImpl();
        userDao.update();
    }
}
public class UserDaoImpl implements UserDao {
    // æ˜¯å¦å®‰å…¨ï¼Œæ˜¯ï¼Œæ¯æ¬¡éƒ½ä¼šnew UserDaoImplï¼Œå…¶å®ä¾‹ä¸­çš„æˆå‘˜å˜é‡ä¸å­˜åœ¨å…±äº«
    private Connection conn = null;
    public void update() throws SQLException {
        String sql = "update user set password = ? where username = ?";
        conn = DriverManager.getConnection("","","");
        // ...
        conn.close();
    }
}
```



#### ä¾‹7

```java
public abstract class Test {
    public void bar() {
        // æ˜¯å¦å®‰å…¨ã€‚å¦ã€‚å±€éƒ¨å˜é‡ä¸ºå¼•ç”¨å¯¹è±¡ï¼Œå¹¶æš´éœ²äº†ï¼
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        foo(sdf);
    }
    public abstract foo(SimpleDateFormat sdf);
    public static void main(String[] args) {
        new Test().bar();
    }
}
```

å…¶ä¸­ foo çš„è¡Œä¸ºæ˜¯ä¸ç¡®å®šçš„ï¼Œå¯èƒ½å¯¼è‡´ä¸å®‰å…¨çš„å‘ç”Ÿï¼Œè¢«ç§°ä¹‹ä¸º**å¤–æ˜Ÿæ–¹æ³•**

```java
public void foo(SimpleDateFormat sdf) {
    String dateStr = "1999-10-11 00:00:00";
    for (int i = 0; i < 20; i++) {
        new Thread(() -> {
            try {
                sdf.parse(dateStr);
            } catch (ParseException e) {
                e.printStackTrace();
            }
        }).start();
    }
}
```

è¯·æ¯”è¾ƒ JDK ä¸­ String ç±»çš„å®ç°



#### ä¾‹8

```java
@Slf4j(topic = "Test3")
public class Test3 {

    private static Integer i = 0;
    public static void main(String[] args) throws InterruptedException {
        List<Thread> list = new ArrayList<>();
        for (int j = 0; j < 2; j++) {
            Thread thread = new Thread(() -> {
                for (int k = 0; k < 5000; k++) {
                    synchronized (i) {
                        i++;
                    }
                }
            }, "" + j);
            list.add(thread);
        }

        list.forEach(Thread::start);
        list.forEach(t -> {
            try {
                t.join();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        log.debug("{}", i);// ä¸å¤Ÿ10000
    }
}
```

é”å¯¹è±¡ç”¨çš„æ˜¯æˆè¯­å˜é‡ Integer i ï¼Œä¸€ç›´åœ¨å˜åŒ–ï¼Œæ‰€ä»¥æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜



### ä¹ é¢˜1â€”å–ç¥¨ç»ƒä¹  ğŸ”¥

æµ‹è¯•ä¸‹é¢ä»£ç æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¹¶å°è¯•æ”¹æ­£ã€‚ç›®å‰å·²æ˜¯æ­£ç¡®çš„äº†ï¼

```java
@Slf4j(topic = "TestSell")
public class TestSell {

    // Random ä¸ºçº¿ç¨‹å®‰å…¨
    static Random random = new Random();

    // éšæœº 1~5
    public static int randomAmount() {
        return random.nextInt(5) + 1;
    }


    @RepeatedTest(10)
    void test() {
        // åˆå§‹åŒ–ç¥¨æ•°
        TicketWindow ticketWindow = new TicketWindow(1000);

        // æ–¹ä¾¿ join åŒæ­¥ï¼Œç­‰å¾…éƒ½å®Œæˆå main çº¿ç¨‹æ‰§è¡Œç»Ÿè®¡ã€‚ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œä¸æ¶‰åŠå¤šçº¿ç¨‹
        List<Thread> list = new ArrayList<>();

        // ç”¨æ¥å­˜å‚¨å–å‡ºå»å¤šå°‘å¼ ç¥¨ã€‚å…±äº«èµ„æºï¼Œè‹¥ä½¿ç”¨ List#add å…¶æ–¹æ³•ä¸æ˜¯åŒæ­¥çš„ï¼Œæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜
        List<Integer> sellCount = new Vector<>();
        for (int i = 0; i < 2_000; i++) {
            Thread t = new Thread(() -> {
                try {
                    // å¢åŠ æ—¶é—´ï¼Œä»¥ä¾¿çº¿ç¨‹åˆ‡æ¢å‡ ç‡ï¼Œå¦åˆ™ä»£ç å¤ªå°‘ï¼Œå¾ˆå¿«å°±æ‰§è¡Œå®Œäº†
                    TimeUnit.MILLISECONDS.sleep(randomAmount());
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                // åˆ†æè¿™é‡Œçš„ç«æ€æ¡ä»¶
                // è¯¥æ–¹æ³•ä¸æ˜¯åŸå­çš„ï¼Œéœ€è¦åŒæ­¥çº¦æŸ
                int count = ticketWindow.sell(randomAmount());
                // è¯¥æ–¹æ³•å·²ç»æ˜¯åŒæ­¥çš„äº†ï¼Œä¸”å’Œä¸Šé¢çš„ä¸æ˜¯åŒä¸€å…±äº«èµ„æºï¼Œæ‰€ä»¥æ— éœ€ç»„åˆåŒæ­¥
                sellCount.add(count);
            });
            list.add(t);
            t.start();
        }
        list.forEach(t -> {
            try {
                t.join();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        log.debug("å–å‡ºçš„ç¥¨ :{} \tä½™ç¥¨: {}",
                sellCount.stream().mapToInt(c -> c).sum(),
                ticketWindow.getCount() );
        // å–å‡ºçš„ç¥¨ + ä½™ç¥¨ åº”è¯¥ç­‰äºåˆå§‹ç¥¨æ•°
    }


}


// å”®ç¥¨çª—å£
class TicketWindow {
    private int count;

    public TicketWindow(int count) {
        this.count = count;
    }

    // è·å–ä½™ç¥¨
    public int getCount() {
        return count;
    }

    // å”®ç¥¨ã€‚å¿…é¡»åŠ ä¸Šsynchronizedï¼Œä¿è¯åŸå­æ€§
    public synchronized int sell(int amount) {
        if (this.count >= amount) {
            this.count -= amount;
            return amount;
        } else {
            return 0;
        }
    }
}
```

ä¸åŠ sleepï¼Œä½¿ç”¨è„šæœ¬æµ‹è¯•å¤šæ¬¡ï¼ˆæœ‰å¯èƒ½ç”µè„‘å¤ªå¿«äº†ï¼Œè¿˜å¿…é¡»åŠ sleepï¼‰ã€‚å¦‚ä¸‹ä¸ºcmd

```
for /L %n in (1,1,10) do java -cp ".;C:\Users\manyh\.m2\repository\ch\qos\logback\logback-classic\1.2.3\logback-classic-1.2.3.jar;C:\Users\manyh\.m2\repository\ch\qos\logback\logback-core\1.2.3\logback-core-1.2.3.jar;C:\Users\manyh\.m2\repository\org\slf4j\slf4j-api\1.7.25\slf4j-api-1.7.25.jar" cn.itcast.n4.exercise.ExerciseSell
```

*   -cpï¼šclasspathï¼Œå› ä¸ºåˆ©ç”¨äº†ç¬¬ä¸‰æ–¹åº“



### ä¹ é¢˜2â€”è½¬è´¦ ğŸ”¥

æµ‹è¯•ä¸‹é¢ä»£ç æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¹¶å°è¯•æ”¹æ­£ã€‚ç›®å‰å·²æ˜¯æ­£ç¡®çš„äº†ï¼ä½†æ˜¯**æœ‰å¾ˆå¤§ç¼ºé™·**

```java
@Slf4j(topic = "TestTransfer")
public class TestTransfer {

    // Random ä¸ºçº¿ç¨‹å®‰å…¨
    static Random random = new Random();

    // éšæœº 1~100
    public static int randomAmount() {
        return random.nextInt(100) + 1;
    }


    @RepeatedTest(10)
    void test() throws InterruptedException {
        Account a = new Account(1000);
        Account b = new Account(1000);

        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 1000; i++) {
                a.transfer(b, randomAmount());
            }
        }, "t1");
        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 1000; i++) {
                b.transfer(a, randomAmount());
            }
        }, "t2");

        t1.start();
        t2.start();
        t1.join();
        t2.join();

        log.debug("total:{}", (a.getMoney() + b.getMoney()));
    }

}


class Account {
    private int money;

    public Account(int money) {
        this.money = money;
    }

    public int getMoney() {
        return money;
    }

    public void setMoney(int money) {
        this.money = money;
    }

    // è¿™é‡Œ money å…±äº«èµ„æºå…¶å®æ˜¯æœ‰ 2ä¸ªè´¦æˆ·çš„ï¼Œéœ€è¦éƒ½ä¿æŠ¤èµ·æ¥ã€‚
    // è€Œ synchronized åŒæ­¥æ–¹æ³•é”å¯¹è±¡æ˜¯ thisï¼Œä¸èƒ½éƒ½ä¿æŠ¤ã€‚å³ aè½¬bæ—¶å…¶ä»–aè½¬bçº¿ç¨‹ä¸èƒ½è¿›å…¥ï¼Œä½†æ˜¯bè½¬açº¿ç¨‹å¯ä»¥è¿›å…¥ï¼
    // æ­¤æ—¶éœ€è¦å°†éƒ½ä¿æŠ¤èµ·æ¥ã€‚ä½†æ˜¯ä¸èƒ½ä½¿ç”¨åµŒå¥—åŒæ­¥ä»£ç å—ï¼Œå®¹æ˜“æ­»é”ã€‚æ­¤æ—¶å¯ä»¥é‡‡ç”¨Account.classé”å¯¹è±¡
    // ä½†æ˜¯è¿™æ˜¯åœ¨åŒä¸€æ—¶åˆ»åªèƒ½ä¸€ä¸ªè´¦æˆ·è¿›è¡Œè½¬è´¦äº†ï¼Œæ€§èƒ½ä½ä¸‹ï¼ï¼ï¼
    public void transfer(Account target, int amount) {
        synchronized (Account.class) {
            if (this.money > amount) {
                this.setMoney(this.money - amount);
                target.setMoney(target.getMoney() + amount);
            }
        }
    }
}
```





## Monitorâ€”ç®¡ç¨‹/ç›‘è§†å™¨

### Java å¯¹è±¡å¤´å½¢å¼

::: tip å‚è€ƒ

[ç®€ä¹¦](https://www.jianshu.com/p/3d38cba67f8b)ã€‚ç›¸å…³èµ„æ–™ï¼š

*   [markOop.hpp](https://link.jianshu.com/?t=https%3A%2F%2Fgithub.com%2Fdmlloyd%2Fopenjdk%2Fblob%2Fjdk%2Fjdk%2Fsrc%2Fhotspot%2Fshare%2Foops%2FmarkOop.hpp)
*   [CompressedOops](https://link.jianshu.com/?t=https%3A%2F%2Fwiki.openjdk.java.net%2Fdisplay%2FHotSpot%2FCompressedOops)
*   [JVMä¼˜åŒ–ä¹‹å‹ç¼©æ™®é€šå¯¹è±¡æŒ‡é’ˆ](https://link.jianshu.com/?t=http%3A%2F%2Fwww.iteye.com%2Ftopic%2F470404)
*   [What is in java object header](https://link.jianshu.com/?t=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F26357186%2Fwhat-is-in-java-object-header)

:::

ç”±äºJavaé¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œåœ¨JVMä¸­éœ€è¦å¤§é‡å­˜å‚¨å¯¹è±¡ï¼Œå­˜å‚¨æ—¶ä¸ºäº†å®ç°ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œéœ€è¦åœ¨å¯¹è±¡ä¸­æ·»åŠ ä¸€äº›æ ‡è®°å­—æ®µç”¨äºå¢å¼ºå¯¹è±¡åŠŸèƒ½ï¼Œè¿™äº›æ ‡è®°å­—æ®µç»„æˆäº†å¯¹è±¡å¤´ã€‚q

JVMä¸­å¯¹è±¡å¤´çš„æ–¹å¼æœ‰ä»¥ä¸‹ä¸¤ç§ï¼Œä»¥ 32 ä½è™šæ‹Ÿæœºä¸ºä¾‹

æ™®é€šå¯¹è±¡ï¼ˆåŒ…æ‹¬2ä¸ªéƒ¨åˆ†ï¼‰ï¼š

```
|--------------------------------------------------------------|
|                     Object Header (64 bits)                  |
|------------------------------------|-------------------------|
|        Mark Word (32 bits)         |    Klass Word (32 bits) |
|------------------------------------|-------------------------|
```

ç”±æ­¤å¯å¾—å‡ºï¼Œintå ç”¨4å­—èŠ‚ï¼ŒInteger å ç”¨ 4+8 = 12å­—èŠ‚

æ•°ç»„å¯¹è±¡ï¼ˆåŒ…æ‹¬3ä¸ªéƒ¨åˆ†ï¼‰

```
|---------------------------------------------------------------------------------|
|                                 Object Header (96 bits)                         |
|--------------------------------|-----------------------|------------------------|
|        Mark Word(32bits)       |    Klass Word(32bits) |  array length(32bits)  |
|--------------------------------|-----------------------|------------------------|
```



### Mark Word

è¿™éƒ¨åˆ†ä¸»è¦ç”¨æ¥å­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œå¦‚hashcodeã€gcåˆ†ä»£å¹´é¾„ç­‰ã€‚`mark word`çš„ä½é•¿åº¦ä¸ºJVMçš„ä¸€ä¸ªWordå¤§å°ï¼Œä¹Ÿå°±æ˜¯è¯´32ä½JVMçš„`Mark word`ä¸º32ä½ï¼Œ64ä½JVMä¸º64ä½ã€‚
 ä¸ºäº†è®©ä¸€ä¸ªå­—å¤§å°å­˜å‚¨æ›´å¤šçš„ä¿¡æ¯ï¼ŒJVMå°†å­—çš„æœ€ä½ä¸¤ä¸ªä½è®¾ç½®ä¸ºæ ‡è®°ä½ï¼Œä¸åŒæ ‡è®°ä½ä¸‹çš„Mark Wordç¤ºæ„å¦‚ä¸‹ï¼š

```
|-------------------------------------------------------|--------------------|
|                  Mark Word (32 bits)                  |       State        |
|-------------------------------------------------------|--------------------|
| identity_hashcode:25 | age:4 | biased_lock:1 | lock:2 |       Normal       |
|-------------------------------------------------------|--------------------|
|  thread:23 | epoch:2 | age:4 | biased_lock:1 | lock:2 |       Biased       |
|-------------------------------------------------------|--------------------|
|               ptr_to_lock_record:30          | lock:2 | Lightweight Locked |
|-------------------------------------------------------|--------------------|
|               ptr_to_heavyweight_monitor:30  | lock:2 | Heavyweight Locked |
|-------------------------------------------------------|--------------------|
|                                              | lock:2 |    Marked for GC   |
|-------------------------------------------------------|--------------------|
```

**lock**:2ä½çš„é”çŠ¶æ€æ ‡è®°ä½ï¼Œç”±äºå¸Œæœ›ç”¨å°½å¯èƒ½å°‘çš„äºŒè¿›åˆ¶ä½è¡¨ç¤ºå°½å¯èƒ½å¤šçš„ä¿¡æ¯ï¼Œæ‰€ä»¥è®¾ç½®äº†lockæ ‡è®°ã€‚è¯¥æ ‡è®°çš„å€¼ä¸åŒï¼Œæ•´ä¸ªmark wordè¡¨ç¤ºçš„å«ä¹‰ä¸åŒã€‚

| biased_lock | lock |   çŠ¶æ€   |
| :---------: | :--: | :------: |
|      0      |  01  |   æ— é”   |
|      1      |  01  |  åå‘é”  |
|      0      |  00  | è½»é‡çº§é” |
|      0      |  10  | é‡é‡çº§é” |
|      0      |  11  |  GCæ ‡è®°  |

**biased_lock**ï¼šå¯¹è±¡æ˜¯å¦å¯ç”¨åå‘é”æ ‡è®°ï¼Œåªå 1ä¸ªäºŒè¿›åˆ¶ä½ã€‚ä¸º1æ—¶è¡¨ç¤ºå¯¹è±¡å¯ç”¨åå‘é”ï¼Œä¸º0æ—¶è¡¨ç¤ºå¯¹è±¡æ²¡æœ‰åå‘é”ã€‚
 **age**ï¼š4ä½çš„Javaå¯¹è±¡å¹´é¾„ã€‚åœ¨GCä¸­ï¼Œå¦‚æœå¯¹è±¡åœ¨SurvivoråŒºå¤åˆ¶ä¸€æ¬¡ï¼Œå¹´é¾„å¢åŠ 1ã€‚å½“å¯¹è±¡è¾¾åˆ°è®¾å®šçš„é˜ˆå€¼æ—¶ï¼Œå°†ä¼šæ™‹å‡åˆ°è€å¹´ä»£ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¹¶è¡ŒGCçš„å¹´é¾„é˜ˆå€¼ä¸º15ï¼Œå¹¶å‘GCçš„å¹´é¾„é˜ˆå€¼ä¸º6ã€‚ç”±äºageåªæœ‰4ä½ï¼Œæ‰€ä»¥æœ€å¤§å€¼ä¸º15ï¼Œè¿™å°±æ˜¯`-XX:MaxTenuringThreshold`é€‰é¡¹æœ€å¤§å€¼ä¸º15çš„åŸå› ã€‚
 **identity_hashcode**ï¼š25ä½çš„å¯¹è±¡æ ‡è¯†Hashç ï¼Œé‡‡ç”¨å»¶è¿ŸåŠ è½½æŠ€æœ¯ã€‚è°ƒç”¨æ–¹æ³•`System.identityHashCode()`è®¡ç®—ï¼Œå¹¶ä¼šå°†ç»“æœå†™åˆ°è¯¥å¯¹è±¡å¤´ä¸­ã€‚å½“å¯¹è±¡è¢«é”å®šæ—¶ï¼Œè¯¥å€¼ä¼šç§»åŠ¨åˆ°ç®¡ç¨‹Monitorä¸­ã€‚
 **thread**ï¼šæŒæœ‰åå‘é”çš„çº¿ç¨‹IDã€‚
 **epoch**ï¼šåå‘æ—¶é—´æˆ³ã€‚
 **ptr_to_lock_record**ï¼šæŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆã€‚
 **ptr_to_heavyweight_monitor**ï¼šæŒ‡å‘ç®¡ç¨‹Monitorçš„æŒ‡é’ˆã€‚

64ä½ä¸‹çš„æ ‡è®°å­—ä¸32ä½çš„ç›¸ä¼¼ï¼š

```
|------------------------------------------------------------------------------|--------------------|
|                                  Mark Word (64 bits)                         |       State        |
|------------------------------------------------------------------------------|--------------------|
| unused:25 | identity_hashcode:31 | unused:1 | age:4 | biased_lock:1 | lock:2 |       Normal       |
|------------------------------------------------------------------------------|--------------------|
| thread:54 |       epoch:2        | unused:1 | age:4 | biased_lock:1 | lock:2 |       Biased       |
|------------------------------------------------------------------------------|--------------------|
|                       ptr_to_lock_record:62                         | lock:2 | Lightweight Locked |
|------------------------------------------------------------------------------|--------------------|
|                     ptr_to_heavyweight_monitor:62                   | lock:2 | Heavyweight Locked |
|------------------------------------------------------------------------------|--------------------|
|                                                                     | lock:2 |    Marked for GC   |
|------------------------------------------------------------------------------|--------------------|
```



### Klass Word

è¿™ä¸€éƒ¨åˆ†ç”¨äºå­˜å‚¨å¯¹è±¡çš„ç±»å‹æŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®ï¼ŒJVMé€šè¿‡è¿™ä¸ªæŒ‡é’ˆç¡®å®šå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€‚è¯¥æŒ‡é’ˆçš„ä½é•¿åº¦ä¸ºJVMçš„ä¸€ä¸ªå­—å¤§å°ï¼Œå³32ä½çš„JVMä¸º32ä½ï¼Œ64ä½çš„JVMä¸º64ä½ã€‚
 å¦‚æœåº”ç”¨çš„å¯¹è±¡è¿‡å¤šï¼Œä½¿ç”¨64ä½çš„æŒ‡é’ˆå°†æµªè´¹å¤§é‡å†…å­˜ï¼Œç»Ÿè®¡è€Œè¨€ï¼Œ64ä½çš„JVMå°†ä¼šæ¯”32ä½çš„JVMå¤šè€—è´¹50%çš„å†…å­˜ã€‚ä¸ºäº†èŠ‚çº¦å†…å­˜å¯ä»¥ä½¿ç”¨é€‰é¡¹`+UseCompressedOops`å¼€å¯æŒ‡é’ˆå‹ç¼©ï¼Œå…¶ä¸­ï¼Œoopå³ordinary object pointeræ™®é€šå¯¹è±¡æŒ‡é’ˆã€‚å¼€å¯è¯¥é€‰é¡¹åï¼Œä¸‹åˆ—æŒ‡é’ˆå°†å‹ç¼©è‡³32ä½ï¼š

1.  æ¯ä¸ªClassçš„å±æ€§æŒ‡é’ˆï¼ˆå³é™æ€å˜é‡ï¼‰
2.  æ¯ä¸ªå¯¹è±¡çš„å±æ€§æŒ‡é’ˆï¼ˆå³å¯¹è±¡å˜é‡ï¼‰
3.  æ™®é€šå¯¹è±¡æ•°ç»„çš„æ¯ä¸ªå…ƒç´ æŒ‡é’ˆ

å½“ç„¶ï¼Œä¹Ÿä¸æ˜¯æ‰€æœ‰çš„æŒ‡é’ˆéƒ½ä¼šå‹ç¼©ï¼Œä¸€äº›ç‰¹æ®Šç±»å‹çš„æŒ‡é’ˆJVMä¸ä¼šä¼˜åŒ–ï¼Œæ¯”å¦‚æŒ‡å‘PermGençš„Classå¯¹è±¡æŒ‡é’ˆ(JDK8ä¸­æŒ‡å‘å…ƒç©ºé—´çš„Classå¯¹è±¡æŒ‡é’ˆ)ã€æœ¬åœ°å˜é‡ã€å †æ ˆå…ƒç´ ã€å…¥å‚ã€è¿”å›å€¼å’ŒNULLæŒ‡é’ˆç­‰ã€‚



### array length

å¦‚æœå¯¹è±¡æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé‚£ä¹ˆå¯¹è±¡å¤´è¿˜éœ€è¦æœ‰é¢å¤–çš„ç©ºé—´ç”¨äºå­˜å‚¨æ•°ç»„çš„é•¿åº¦ï¼Œè¿™éƒ¨åˆ†æ•°æ®çš„é•¿åº¦ä¹Ÿéšç€JVMæ¶æ„çš„ä¸åŒè€Œä¸åŒï¼š32ä½çš„JVMä¸Šï¼Œé•¿åº¦ä¸º32ä½ï¼›64ä½JVMåˆ™ä¸º64ä½ã€‚64ä½JVMå¦‚æœå¼€å¯`+UseCompressedOops`é€‰é¡¹ï¼Œ**è¯¥åŒºåŸŸé•¿åº¦ä¹Ÿå°†ç”±64ä½å‹ç¼©è‡³32ä½**ã€‚







## 7.4 çº¿ç¨‹å®‰å…¨å’ŒåŒæ­¥

#### Lock é”

- ä» JDK 5.0 å¼€å§‹ï¼ŒJava æä¾›äº†æ›´å¼ºå¤§çš„çº¿ç¨‹åŒæ­¥æœºåˆ¶â€”â€”é€šè¿‡**æ˜¾å¼å®šä¹‰åŒæ­¥é”å¯¹è±¡**æ¥å®ç°åŒæ­¥ã€‚`java.util.concurrent.locks.Lock` **æ¥å£**æœºåˆ¶æä¾›äº†æ¯”`synchronized`ä»£ç å—å’Œ`synchronized`æ–¹æ³•æ›´å¹¿æ³›çš„é”å®šæ“ä½œï¼ŒåŒæ­¥ä»£ç å—/åŒæ­¥æ–¹æ³•å…·æœ‰çš„åŠŸèƒ½ Lock éƒ½æœ‰ï¼Œé™¤æ­¤ä¹‹å¤–æ›´å¼ºå¤§ï¼Œæ›´ä½“ç°é¢å‘å¯¹è±¡ã€‚

- **Lock æ¥å£çš„å®ç°ç±»`ReentrantLock`**ã€‚å¯åœ¨æ„é€ æ–¹æ³•ä¸­è®¾ç½®æ˜¯å¦ä¸º**å…¬å¹³é”**ï¼ˆæŒ‰ FIFO é˜Ÿåˆ—ï¼‰ï¼Œä½†æ˜¯æ•ˆç‡å¯èƒ½ä¼šå˜ä½ã€‚

- **Lock é”ä¹Ÿç§°åŒæ­¥é”**ï¼ŒåŠ é”ä¸é‡Šæ”¾é”æ–¹æ³•åŒ–äº†ï¼Œå¦‚ä¸‹ï¼š

    - `void lock()`ï¼š**åŠ åŒæ­¥é”**

    - `void unlock()`ï¼š**é‡Šæ”¾åŒæ­¥é”**

        ```java
        public class Ticket implements Runnable {
        
            private int count = 100;
            private Lock lock = new ReentrantLock();
        
            @Override
            public void run() {
                while (true) {
                    try {
                        // åŠ åŒæ­¥é”
                        lock.lock();
                        if (count > 0) {
                            try {
                                Thread.sleep(10);
                                System.out.println(Thread.currentThread().getName() + "-->æ­£åœ¨å–ç¬¬" + count + "å¼ ç¥¨");
                                count--;
                            } catch (InterruptedException e) {
                                e.printStackTrace();
                            }
                        } else {
                            break;
                        }
                    } finally {
                        // é‡Šæ”¾åŒæ­¥é”
                        lock.unlock();
                    }
                }
            }
        
            public static void main(String[] args) {
                Ticket ticket = new Ticket();
                new Thread(ticket, "çª—å£1").start();
                new Thread(ticket, "çª—å£2").start();
                new Thread(ticket, "çª—å£3").start();
            }
        }
        ```

### æ­»é”é—®é¢˜(å“²å­¦å®¶å°±é¤)

- æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„çº¿ç¨‹åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå› **äº‰å¤ºèµ„æº**äº§ç”Ÿçš„ä¸€ç§**äº’ç›¸ç­‰å¾…**ç°è±¡

    ä¸è¦ä½¿ç”¨ String æ¥åšé”ã€‚å¦‚ï¼šString s1 = "Hello" å’Œ String s2 = "Hello" å…¶å®æ˜¯åŒä¸€æŠŠé”ï¼›è¿˜ä¼šå¯èƒ½ä¸å…¶ä»–ç±»åº“å‘ç”Ÿæ­»é”ã€‚

    ```java
    public class DeadLock {
        private static Object lock1 = new Object();
        private static Object lock2 = new Object();
    
        public static void main(String[] args) {
            new Thread(() -> {
                synchronized (lock1) {
                    System.out.println("t1 get lock1");
                    // å¯åœ¨æ­¤å¤„sleepæé«˜æ­»é”æ¦‚ç‡
                    synchronized (lock2) {
                        System.out.println("t1 get lock2");
                    }
                }
            }, "t1").start();
    
            new Thread(() -> {
                synchronized (lock2) {
                    System.out.println("t2 get lock2");
                    // å¯åœ¨æ­¤å¤„sleepæé«˜æ­»é”æ¦‚ç‡
                    synchronized (lock1) {
                        System.out.println("t2 get lock1");
                    }
                }
            }, "t2").start();
        }
    }
    // å¯èƒ½å‡ºç°çš„ç»“æœæœ‰ï¼š
    // 1
    t1 get lock1
    t1 get lock2
    t2 get lock2
    t2 get lock1
    // 2
    t2 get lock2
    t2 get lock1
    t1 get lock1
    t1 get lock2
    // 3
    t1 get lock1
    t2 get lock2
    // 4
    t2 get lock2
    t1 get lock1
    ```

## 7.5 çº¿ç¨‹é—´é€šä¿¡

**å¤šä¸ªçº¿ç¨‹åœ¨å¤„ç†åŒä¸€ä¸ªèµ„æºï¼Œä½†æ˜¯å¤„ç†çš„åŠ¨ä½œï¼ˆçº¿ç¨‹çš„ä»»åŠ¡ï¼‰å´ä¸ç›¸åŒ**ã€‚

å¤šä¸ªçº¿ç¨‹åœ¨å¤„ç†åŒä¸€ä¸ªèµ„æºï¼Œå¹¶ä¸”ä»»åŠ¡ä¸åŒæ—¶ï¼Œéœ€è¦çº¿ç¨‹é€šä¿¡æ¥å¸®åŠ©è§£å†³çº¿ç¨‹ä¹‹é—´å¯¹åŒä¸€ä¸ªå˜é‡çš„ä½¿ç”¨æˆ–æ“ä½œã€‚ å°±æ˜¯å¤šä¸ªçº¿ç¨‹åœ¨æ“ä½œåŒä¸€ä»½æ•°æ®æ—¶ï¼Œ é¿å…å¯¹åŒä¸€å…±äº«å˜é‡çš„äº‰å¤ºã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€å®šçš„æ‰‹æ®µä½¿å„ä¸ªçº¿ç¨‹èƒ½æœ‰æ•ˆçš„åˆ©ç”¨èµ„æºã€‚è€Œè¿™ç§æ‰‹æ®µå³â€”â€” ç­‰å¾…å”¤é†’æœºåˆ¶ã€‚

### ç­‰å¾…å”¤é†’æœºåˆ¶

å°±æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œäº†è§„å®šæ“ä½œåï¼Œå°±è¿›å…¥ç­‰å¾…çŠ¶æ€`wait()`ï¼Œ ç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œä»–ä»¬çš„æŒ‡å®šä»£ç è¿‡å å†å°†å…¶å”¤é†’`notify()`ï¼›åœ¨æœ‰å¤šä¸ªçº¿ç¨‹è¿›è¡Œç­‰å¾…æ—¶ï¼Œ å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä½¿ç”¨ `notifyAll()`æ¥å”¤é†’æ‰€æœ‰çš„ç­‰å¾…çº¿ç¨‹ã€‚ wait/notify å°±æ˜¯çº¿ç¨‹é—´çš„ä¸€ç§åä½œæœºåˆ¶ã€‚

- **`Object`ç±»**ï¼ˆä»»æ„é”ï¼‰ä¸­æä¾›äº†ä¸‰ä¸ªæ–¹æ³•ã€‚è¿™äº›æ–¹æ³•å¿…é¡»é€šè¿‡**åŒä¸€ä¸ªé”å¯¹è±¡ï¼ˆthis è°ƒç”¨æˆ–å…¶ä»–åŒä¸€å¯¹è±¡è°ƒç”¨ï¼‰åœ¨åŒæ­¥ä¸­ï¼ˆåŒæ­¥ä»£ç å—ã€åŒæ­¥æ–¹æ³•ï¼‰è°ƒç”¨ï¼Œå¦åˆ™æŠ¥`IllegalMonitorStateException`é”™ã€‚**Lock æœ‰å…¶è‡ªå·±çš„æ–¹æ³•ã€‚
    - `wait([long timeout])`ï¼š**ç­‰å¾…**å¹¶ç«‹å³**é‡Šæ”¾é”**ï¼Œçº¿ç¨‹è¿›å…¥ WAITINGã€‚**è¢«å”¤é†’è‹¥è·å¾—é”åä»æ–­ç‚¹å¤„æ‰§è¡Œåç»­ä»£ç **
    - `notify()`ï¼šå”¤é†’æ­£åœ¨æ’é˜Ÿç­‰å¾…åŒæ­¥èµ„æºçš„çº¿ç¨‹ä¸­ä¼˜å…ˆçº§æœ€é«˜è€…ç»“æŸç­‰å¾…ï¼Œä½†**ä¸é‡Šæ”¾é”**ï¼Œè¢«é€šçŸ¥çº¿ç¨‹ä¸èƒ½ç«‹å³æ¢å¤æ‰§è¡Œçº¿ç¨‹ï¼Œ**éœ€é‡æ–°è¯·æ±‚åŒæ­¥é”**
    - `notifyAll()`ï¼šå”¤é†’æ­£åœ¨æ’é˜Ÿç­‰å¾…èµ„æºçš„æ‰€æœ‰çº¿ç¨‹ç»“æŸç­‰å¾…

> å“ªæ€•åªé€šçŸ¥äº†ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ï¼Œè¢«é€šçŸ¥çº¿ç¨‹ä¹Ÿä¸èƒ½ç«‹å³æ¢å¤æ‰§è¡Œï¼Œå› ä¸ºå®ƒå½“åˆä¸­æ–­çš„åœ°æ–¹æ˜¯åœ¨åŒæ­¥å—å†…ï¼Œè€Œæ­¤åˆ»å®ƒå·²ç»ä¸æŒæœ‰é”ï¼Œæ‰€ä»¥å¥¹éœ€è¦å†æ¬¡å°è¯•å»è·å–é”ï¼ˆå¾ˆå¯èƒ½é¢ä¸´å…¶å®ƒçº¿ç¨‹çš„ç«äº‰ï¼‰ï¼ŒæˆåŠŸåæ‰èƒ½åœ¨å½“åˆè°ƒ ç”¨ wait æ–¹æ³•ä¹‹åçš„åœ°æ–¹æ¢å¤æ‰§è¡Œã€‚
> æ€»ç»“å¦‚ä¸‹ï¼š
> å¦‚æœèƒ½è·å–é”ï¼Œçº¿ç¨‹å°±ä» WAITING çŠ¶æ€å˜æˆ RUNNABLE çŠ¶æ€ï¼› å¦åˆ™ï¼Œä» wait set å‡ºæ¥ï¼Œåˆè¿›å…¥ entry setï¼Œçº¿ç¨‹å°±ä» WAITING çŠ¶æ€åˆå˜æˆ BLOCKED çŠ¶æ€ã€‚

### ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜

> ç”Ÿäº§è€…ï¼ˆProductorï¼‰å°†äº§å“äº¤ç»™åº—å‘˜ï¼ˆClerkï¼‰ï¼Œè€Œæ¶ˆè´¹è€…ï¼ˆï¼‰ä»åº—å‘˜å¤„å–èµ°äº§å“ï¼Œåº—å‘˜ä¸€æ¬¡åªèƒ½æŒæœ‰å›ºå®šæ•°é‡çš„äº§å“ï¼ˆæ¯”å¦‚ 20ï¼‰ï¼Œå¦‚æœç”Ÿäº§è€…è¯•å›¾ç”Ÿäº§æ›´å¤šçš„äº§å“ï¼Œåº—å‘˜ä¼šå«ç”Ÿäº§è€…åœä¸€ä¸‹ï¼Œå¦‚æœåº—ä¸­æœ‰ç©ºä½æ”¾äº§å“äº†å†é€šçŸ¥ç”Ÿäº§è€…ç»§ç»­ç”Ÿäº§ï¼›å¦‚æœåº—ä¸­æ²¡æœ‰äº§å“äº†ï¼Œåº—å‘˜ä¼šå‘Šè¯‰æ¶ˆè´¹è€…ç­‰ä¸€ä¸‹ï¼Œå¦‚æœåº—ä¸­æœ‰äº§å“äº†å†é€šçŸ¥æ¶ˆè´¹è€…æ¥å–èµ°äº§å“ã€‚
>
> åˆ†æï¼š
>
> 1.  æ˜¯å¦æ˜¯å¤šçº¿ç¨‹é—®é¢˜ï¼Ÿæ˜¯ï¼Œç”Ÿäº§è€…çº¿ç¨‹ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹
>
> 2.  æ˜¯å¦æœ‰å…±äº«æ•°æ®ï¼Ÿæ˜¯ï¼Œåº—å‘˜ï¼ˆæˆ–äº§å“ï¼‰
>
> 3.  æ˜¯å¦æ¶‰åŠçº¿ç¨‹çš„é€šä¿¡ï¼Ÿæ˜¯

#### åŒæ­¥ä»£ç å—ç‰ˆæœ¬

```java
class Productor implements Runnable {

    private final Product product;

    public Productor(Product product) {
        this.product = product;
    }

    @Override
    public void run() {
        while (true) {
            synchronized (product) {
                // while å’Œ wait ä¸€èµ·ä½¿ç”¨ï¼›ä¸èƒ½å•ç‹¬ä½¿ç”¨ ifï¼Œå¯èƒ½ä¼šç¼ºå°‘ä¸€æ¬¡åˆ¤æ–­
                // ä¸èƒ½ä½¿ç”¨ if...elseï¼Œä¼šå¯¼è‡´ wait å”¤é†’åå³ä½¿æ»¡è¶³æ¡ä»¶ä¹Ÿä¸èƒ½ç”Ÿäº§æˆ–æ¶ˆè´¹ï¼Œæµªè´¹äº† OS èµ„æº
                while (product.productNum >= 20) {
                    try {
                        product.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }

                product.productNum++;
                System.out.println(Thread.currentThread().getName() + "ï¼šç”Ÿäº§ç¬¬" + product.productNum + "ä¸ªäº§å“");

                product.notifyAll();
            }
            try {
                // æ”¾åœ¨åŒæ­¥å¤–æ›´åˆç†ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥æ­¤æ—¶æŠ¢å èµ„æº
                Thread.sleep(100);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}


class Consumer implements Runnable {

    private final Product product;

    public Consumer(Product product) {
        this.product = product;
    }

    @Override
    public void run() {
        while (true) {
            synchronized (product) {
                // while å’Œ wait ä¸€èµ·ä½¿ç”¨ï¼›ä¸èƒ½å•ç‹¬ä½¿ç”¨ ifï¼Œå¯èƒ½ä¼šç¼ºå°‘ä¸€æ¬¡åˆ¤æ–­
                // ä¸èƒ½ä½¿ç”¨ if...elseï¼Œä¼šå¯¼è‡´ wait å”¤é†’åå³ä½¿æ»¡è¶³æ¡ä»¶ä¹Ÿä¸èƒ½ç”Ÿäº§æˆ–æ¶ˆè´¹ï¼Œæµªè´¹äº† OS èµ„æº
                while (product.productNum <= 0) {
                    try {
                        product.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }

                System.out.println(Thread.currentThread().getName() + "ï¼šæ¶ˆè´¹ç¬¬" + product.productNum + "ä¸ªäº§å“");
                product.productNum--;

                product.notifyAll();
            }
            // æ”¾åœ¨åŒæ­¥å¤–æ›´åˆç†ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥æ­¤æ—¶æŠ¢å èµ„æº
            try {
                Thread.sleep(200);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

class Product {
    // äº§å“æ•°é‡
    int productNum = 0;
}


public class PCTest {
    public static void main(String[] args) {
        Product product = new Product();
        new Thread(new Productor(product), "ç”Ÿäº§è€…1").start();
        new Thread(new Productor(product), "ç”Ÿäº§è€…2").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…1").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…2").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…3").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…4").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…5").start();
    }
}
```

#### Lock ç‰ˆæœ¬

```java
class Productor implements Runnable {

    private final Product product;

    public Productor(Product product) {
        this.product = product;
    }

    @Override
    public void run() {
        while (true) {

            try {
                product.lock.lock();
                // while å’Œ wait ä¸€èµ·ä½¿ç”¨ï¼›ä¸èƒ½å•ç‹¬ä½¿ç”¨ ifï¼Œå¯èƒ½ä¼šç¼ºå°‘ä¸€æ¬¡åˆ¤æ–­
                // ä¸èƒ½ä½¿ç”¨ if...elseï¼Œä¼šå¯¼è‡´ wait å”¤é†’åå³ä½¿æ»¡è¶³æ¡ä»¶ä¹Ÿä¸èƒ½ç”Ÿäº§æˆ–æ¶ˆè´¹ï¼Œæµªè´¹äº† OS èµ„æº
                while (product.productNum >= 20) {
                    try {
                        product.productor.await();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }

                product.productNum++;
                System.out.println(Thread.currentThread().getName() + "ï¼šç”Ÿäº§ç¬¬" + product.productNum + "ä¸ªäº§å“");

                product.consumer.signalAll();
            } finally {
                product.lock.unlock();
            }


            try {
                // æ”¾åœ¨åŒæ­¥å¤–æ›´åˆç†ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥æ­¤æ—¶æŠ¢å èµ„æº
                Thread.sleep(100);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}


class Consumer implements Runnable {

    private final Product product;

    public Consumer(Product product) {
        this.product = product;
    }

    @Override
    public void run() {
        while (true) {

            try {
                product.lock.lock();
                // while å’Œ wait ä¸€èµ·ä½¿ç”¨ï¼›ä¸èƒ½å•ç‹¬ä½¿ç”¨ ifï¼Œå¯èƒ½ä¼šç¼ºå°‘ä¸€æ¬¡åˆ¤æ–­
                // ä¸èƒ½ä½¿ç”¨ if...elseï¼Œä¼šå¯¼è‡´ wait å”¤é†’åå³ä½¿æ»¡è¶³æ¡ä»¶ä¹Ÿä¸èƒ½ç”Ÿäº§æˆ–æ¶ˆè´¹ï¼Œæµªè´¹äº† OS èµ„æº
                while (product.productNum <= 0) {
                    try {
                        product.consumer.await();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }

                System.out.println(Thread.currentThread().getName() + "ï¼šæ¶ˆè´¹ç¬¬" + product.productNum + "ä¸ªäº§å“");
                product.productNum--;

                product.productor.signalAll();
            } finally {
                product.lock.unlock();
            }

            // æ”¾åœ¨åŒæ­¥å¤–æ›´åˆç†ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥æ­¤æ—¶æŠ¢å èµ„æº
            try {
                Thread.sleep(200);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

class Product {
    // äº§å“æ•°é‡
    int productNum = 0;

    Lock lock = new ReentrantLock();
    Condition productor = lock.newCondition();
    Condition consumer = lock.newCondition();
}


public class PCTest {
    public static void main(String[] args) {
        Product product = new Product();
        new Thread(new Productor(product), "ç”Ÿäº§è€…1").start();
        new Thread(new Productor(product), "ç”Ÿäº§è€…2").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…1").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…2").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…3").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…4").start();
        new Thread(new Consumer(product), "æ¶ˆè´¹è€…5").start();
    }
}
```

#### JUC ç‰ˆæœ¬

## ä¹ é¢˜

### å®ç° Runnable æ¥å£çš„å¥½å¤„ ğŸ”¥

**å…¶å® Thread ç±»ä¹Ÿæ˜¯å®ç°äº† Runnable æ¥å£**ã€‚start å¯åŠ¨çº¿ç¨‹ä¸­å†…éƒ¨è°ƒç”¨ run æ–¹æ³•æ—¶ï¼Œè‹¥æ˜¯ target æœ‰å€¼ï¼ˆRunnableå¯¹è±¡ï¼‰åˆ™è°ƒç”¨è¯¥ Runnable å¯¹è±¡çš„ run æ–¹æ³•ï¼Œæ— å€¼åˆ™è°ƒç”¨ Thread é‡å†™çš„ run æ–¹æ³•ã€‚

æ„é€ æ–¹æ³•åˆå§‹åŒ–æ—¶ä¼šæœ‰

```java
// Thread.java
this.target = target;// è¿™ä¸ªå³æ˜¯ä¼ å…¥çš„ Runnable å¯¹è±¡ã€‚Thread åŒ¿åå†…éƒ¨ç±»å¯¹è±¡ä¸ä¼šä¼ å…¥æ„é€ æ–¹æ³•çš„
```

è°ƒç”¨ start æ–¹å¼æ—¶ä¼šè°ƒç”¨

```java
// Thread.java
@Override
public void run() {
    if (target != null) {
        target.run();
    }
}
```

*   é¿å…äº† Java ç±»**å•ç»§æ‰¿çš„å±€é™æ€§**
*   å¤šä¸ªçº¿ç¨‹å¯ä»¥å…±äº«åŒä¸€ä¸ªæ¥å£å®ç°ç±»çš„å¯¹è±¡ï¼Œéå¸¸é€‚åˆå¤šä¸ªç›¸åŒçº¿ç¨‹æ¥**å¤„ç†åŒä¸€ä¸ªèµ„æº**ï¼Œå¢åŠ ç¨‹åºçš„å¥å£®æ€§ï¼Œå®ç°**è§£è€¦**æ“ä½œï¼Œ**ä»»åŠ¡**ä»£ç å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œ**ä»»åŠ¡ä»£ç å’Œçº¿ç¨‹ç‹¬ç«‹**

*   **çº¿ç¨‹æ± **åªèƒ½æ”¾å…¥å®ç° Runable æˆ– Callable ç±»çº¿ç¨‹ï¼Œä¸èƒ½ç›´æ¥æ”¾å…¥ç»§æ‰¿ Thread ç±»çš„çº¿ç¨‹





### `run()`å’Œ`start()`çš„åŒºåˆ« ğŸ”¥

- `run()`ï¼šä»…ä»…æ˜¯å°è£…è¢«çº¿ç¨‹æ‰§è¡Œçš„ä»£ç ï¼Œç›´æ¥è°ƒç”¨æ˜¯æ™®é€šæ–¹æ³•ã€‚
- `start()`ï¼šé¦–å…ˆå¯åŠ¨äº†çº¿ç¨‹ï¼Œç„¶åå†ç”± jvm å»è°ƒç”¨è¯¥çº¿ç¨‹çš„ run()æ–¹æ³•ã€‚

### synchronized å’Œ Lock åŒºåˆ«

- syn æ˜¯å…³é”®å­—å±äº **JVM å±‚é¢**çš„ï¼ˆåœ¨åŒæ­¥ä¸­å—ä¸­æ‰èƒ½è°ƒç”¨ wait/notifyï¼‰ï¼›Lock æ˜¯æ¥å£ï¼Œæ˜¯ **Api å±‚é¢**çš„ï¼ŒJVM å°†èŠ±è´¹è¾ƒå°‘çš„æ—¶é—´æ¥è°ƒåº¦çº¿ç¨‹ï¼Œæ€§èƒ½æ›´å¥½ã€‚å¹¶ä¸”å…·æœ‰æ›´å¥½çš„æ‰©å±•æ€§ï¼ˆæä¾›æ›´å¤šçš„å­ç±»ï¼‰
- syn æ˜¯**éšå¼é”**ï¼Œ**å‡ºäº†ä½œç”¨åŸŸ æˆ– æŠ›å¼‚å¸¸ä¼šè‡ªåŠ¨é‡Šæ”¾**ï¼›Lock æ˜¯**æ˜¾å¼é”**ï¼ˆ**æ‰‹åŠ¨å¼€å¯å’Œå…³é—­é”**ï¼Œåˆ«å¿˜è®°å…³é—­é”ï¼‰
- syn æœ‰ä»£ç å—é”å’Œæ–¹æ³•é”ï¼›Lock åªæœ‰ä»£ç å—é”
- **syn ä¸å¯ä¸­æ–­**ï¼›**Lock å¯ä¸­æ–­**ï¼ˆtryLock è®¾ç½®è¶…æ—¶æ–¹æ³•ï¼ŒlockInterruptibly()æ–¹ä»£ç å—ä¸­ï¼Œç”¨ interrupt()æ–¹æ³•ä¸­æ–­ï¼‰
- ä½¿ç”¨ Lock çš„ Condition å¯ä»¥**ç²¾ç¡®å”¤é†’**

ä¼˜å…ˆä½¿ç”¨é¡ºåºï¼šLock â€”> åŒæ­¥ä»£ç å—(å·²ç»è¿›å…¥äº†æ–¹æ³•ä½“ï¼Œåˆ†é…äº†ç›¸åº”èµ„æº) â€”> åŒæ­¥æ–¹æ³• (åœ¨æ–¹æ³•ä½“ä¹‹å¤–)

### sleep å’Œ wait å¼‚åŒ

- sleep æ˜¯ Thread çš„æ–¹æ³•ï¼Œå¯ä»¥åœ¨ä»»ä½•åœºæ™¯ä¸‹è°ƒç”¨ï¼›wait æ˜¯ Object çš„æ–¹æ³•ï¼Œå¿…é¡»åœ¨åŒæ­¥ä¸­è°ƒç”¨ï¼ˆåŒæ­¥ä»£ç å—ã€åŒæ­¥æ–¹æ³•ï¼‰
- è‹¥ä¿©æ–¹æ³•éƒ½åœ¨åŒæ­¥ä¸­è°ƒç”¨ï¼Œéƒ½ä¼šä½¿çº¿ç¨‹è¿›å…¥ TIME/ WAITING çŠ¶æ€ã€‚ä½† sleep **ä¸ä¼šé‡Šæ”¾é”**ï¼Œä¼‘çœ ç»“æŸå›åˆ°å°±ç»ªçŠ¶æ€ï¼›wait **ç­‰å¾…**å¹¶ç«‹å³**é‡Šæ”¾é”**ï¼Œ**è¢«å”¤é†’åè‹¥è·å¾—é”åˆ™ä»è¿™é‡Œæ‰§è¡Œåç»­ä»£ç **

### 2 ä¸ªçº¿ç¨‹å‘è´¦æˆ·å­˜é’±å¹¶æ‰“å°

é“¶è¡Œæœ‰ä¸€ä¸ªè´¦æˆ·ï¼Œæœ‰ä¸¤ä¸ªå‚¨æˆ·åˆ†åˆ«å‘åŒä¸€ä¸ªè´¦æˆ·å­˜ 3000 å…ƒï¼Œæ¯æ¬¡å­˜ 1000ï¼Œå­˜ 3 æ¬¡ã€‚æ¯æ¬¡å­˜å®Œæ‰“å°è´¦æˆ·ä½™é¢ã€‚

é—®é¢˜:è¯¥ç¨‹åºæ˜¯å¦æœ‰å®‰å…¨é—®é¢˜ï¼Œå¦‚æœæœ‰ï¼Œå¦‚ä½•è§£å†³ï¼Ÿæ­¤å¤„é‡‡ç”¨ç»§æ‰¿ Thread ç±»æ¥å®ç°ï¼ˆå®ç° Runnable æ¥å£ç¨ç®€å•ï¼‰

```java
class Account {
    private double balance;

    public Account(double balance) {
        this.balance = balance;
    }

    //å­˜é’±
    public synchronized void deposit(double amt) {
        if (amt > 0) {
            balance += amt;
            System.out.println(Thread.currentThread().getName() + ":å­˜é’±æˆåŠŸã€‚ä½™é¢ä¸ºï¼š" + balance);
        }
    }
}

class Customer extends Thread {

    private Account acct;

    public Customer(Account acct, String name) {
        super(name);
        this.acct = acct;
    }

    @Override
    public void run() {

        for (int i = 0; i < 3; i++) {
            acct.deposit(1000);

            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

public class AccountTest {

    public static void main(String[] args) {
        Account acct = new Account(0);
        new Customer(acct, "ç”²").start();
        new Customer(acct, "ä¹™").start();
    }
}
```

### 2 ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å° 1-100

åŒæ­¥ä»£ç å—ã€åŒæ­¥æ–¹æ³•

```java
class PrintThread implements Runnable{

    private int count = 1;

    @Override
    public void run() {
        while (true) {
            // waitã€notify å¿…é¡»åœ¨åŒæ­¥ä¸­ã€‚ä¸”è°ƒç”¨çš„å¯¹è±¡ä¸é”å¯¹è±¡å¿…é¡»ç›¸åŒ
            synchronized (this) {
                // å”¤é†’
                this.notifyAll();
                if (count <= 100) {
                    /*try {
                        // ä¸åŠ é”æ—¶ï¼Œå¢åŠ çº¿ç¨‹å®‰å…¨é—®é¢˜å‘ç”Ÿçš„æ¦‚ç‡
                        Thread.sleep(100);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }*/
                    System.out.println(Thread.currentThread().getName()+":"+count++);

                    try {
                        // ç­‰å¾…å¹¶ç«‹å³é‡Šæ”¾é”ï¼Œå”¤é†’åè¿˜æ˜¯ä»è¿™é‡Œç»§ç»­ï¼Œä½†æ˜¯éœ€è¦è·å–åˆ°é”ï¼Œæ‰€ä»¥å¤–å±‚éœ€è¦ä½¿ç”¨ while
                        this.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                } else {
                    break;
                }
            }
        }
    }
}

public class PrintTest {

    public static void main(String[] args) {
        PrintThread printThread = new PrintThread();
        // ä¹Ÿå¯ä»¥å°† run æ–¹æ³•å†…å®¹å†™å…¥æ™®é€šæ–¹æ³•ä¸­ï¼Œé‡‡ç”¨æ–¹æ³•å¼•ç”¨æ¥æ“ä½œ
        new Thread(printThread,"A").start();
        new Thread(printThread,"B").start();
    }
}
```

Lock æ–¹å¼æš‚æ—¶æ²¡æƒ³åˆ°å¥½ç‚¹çš„æ–¹æ³•

### ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜

è§ç¬”è®°

### åˆ›å»ºå¤šçº¿ç¨‹çš„ 4 ç§æ–¹å¼

è§ç¬”è®°







