---
title: Monitor & synchronized åŸç†
date: 2021-02-19 23:20:57
permalink: /pages/55e20e/
categories:
  - CoreJava
  - å¤šçº¿ç¨‹
tags:
  -
---

# Monitor & synchronized åŸç†

## Monitorâ€”ç®¡ç¨‹/ç›‘è§†å™¨ ğŸ”¥

### Java å¯¹è±¡å¤´å½¢å¼ ğŸ”¥

::: tip å‚è€ƒèµ„æ–™

- [ç®€ä¹¦](https://www.jianshu.com/p/3d38cba67f8b)

- [markOop.hpp](https://link.jianshu.com/?t=https%3A%2F%2Fgithub.com%2Fdmlloyd%2Fopenjdk%2Fblob%2Fjdk%2Fjdk%2Fsrc%2Fhotspot%2Fshare%2Foops%2FmarkOop.hpp)
- [CompressedOops](https://link.jianshu.com/?t=https%3A%2F%2Fwiki.openjdk.java.net%2Fdisplay%2FHotSpot%2FCompressedOops)
- [JVM ä¼˜åŒ–ä¹‹å‹ç¼©æ™®é€šå¯¹è±¡æŒ‡é’ˆ](https://link.jianshu.com/?t=http%3A%2F%2Fwww.iteye.com%2Ftopic%2F470404)
- [What is in java object header](https://link.jianshu.com/?t=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F26357186%2Fwhat-is-in-java-object-header)

:::

ç”±äº Java é¢å‘å¯¹è±¡çš„æ€æƒ³ï¼Œåœ¨ JVM ä¸­éœ€è¦å¤§é‡å­˜å‚¨å¯¹è±¡ï¼Œå­˜å‚¨æ—¶ä¸ºäº†å®ç°ä¸€äº›é¢å¤–çš„åŠŸèƒ½ï¼Œéœ€è¦åœ¨å¯¹è±¡ä¸­æ·»åŠ ä¸€äº›æ ‡è®°å­—æ®µç”¨äºå¢å¼ºå¯¹è±¡åŠŸèƒ½ï¼Œè¿™äº›æ ‡è®°å­—æ®µç»„æˆäº†å¯¹è±¡å¤´ã€‚

JVM ä¸­å¯¹è±¡å¤´çš„æ–¹å¼æœ‰ä»¥ä¸‹ä¸¤ç§ï¼Œä»¥ 32 ä½è™šæ‹Ÿæœºä¸ºä¾‹

æ™®é€šå¯¹è±¡ï¼ˆåŒ…æ‹¬ 2 ä¸ªéƒ¨åˆ†ï¼‰ï¼š

```
|--------------------------------------------------------------|
|                     Object Header (64 bits)                  |
|------------------------------------|-------------------------|
|        Mark Word (32 bits)         |    Klass Word (32 bits) |
|------------------------------------|-------------------------|
```

ç”±æ­¤å¯å¾—å‡ºï¼Œint å ç”¨ 4 å­—èŠ‚ï¼ŒInteger å ç”¨ 4+8 = 12 å­—èŠ‚

æ•°ç»„å¯¹è±¡ï¼ˆåŒ…æ‹¬ 3 ä¸ªéƒ¨åˆ†ï¼‰

```
|---------------------------------------------------------------------------------|
|                                 Object Header (96 bits)                         |
|--------------------------------|-----------------------|------------------------|
|        Mark Word(32bits)       |    Klass Word(32bits) |  array length(32bits)  |
|--------------------------------|-----------------------|------------------------|
```

#### Mark Word ğŸ”¥

è¿™éƒ¨åˆ†ä¸»è¦ç”¨æ¥å­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œå¦‚ hashcodeã€gc åˆ†ä»£å¹´é¾„ç­‰ã€‚`mark word`çš„ä½é•¿åº¦ä¸º JVM çš„ä¸€ä¸ª Word å¤§å°ï¼Œä¹Ÿå°±æ˜¯è¯´ 32 ä½ JVM çš„`Mark word`ä¸º 32 ä½ï¼Œ64 ä½ JVM ä¸º 64 ä½ã€‚
ä¸ºäº†è®©ä¸€ä¸ªå­—å¤§å°å­˜å‚¨æ›´å¤šçš„ä¿¡æ¯ï¼ŒJVM å°†å­—çš„æœ€ä½ä¸¤ä¸ªä½è®¾ç½®ä¸ºæ ‡è®°ä½ï¼Œä¸åŒæ ‡è®°ä½ä¸‹çš„ Mark Word ç¤ºæ„å¦‚ä¸‹ï¼š

```
|-------------------------------------------------------|--------------------|
|                  Mark Word (32 bits)                  |       State        |
|-------------------------------------------------------|--------------------|
| identity_hashcode:25 | age:4 | biased_lock:1 | lock:2 |       Normal       |
|-------------------------------------------------------|--------------------|
|  thread:23 | epoch:2 | age:4 | biased_lock:1 | lock:2 |       Biased       |
|-------------------------------------------------------|--------------------|
|               ptr_to_lock_record:30          | lock:2 | Lightweight Locked |
|-------------------------------------------------------|--------------------|
|               ptr_to_heavyweight_monitor:30  | lock:2 | Heavyweight Locked |
|-------------------------------------------------------|--------------------|
|                                              | lock:2 |    Marked for GC   |
|-------------------------------------------------------|--------------------|
```

**lock**:2 ä½çš„é”çŠ¶æ€æ ‡è®°ä½ï¼Œç”±äºå¸Œæœ›ç”¨å°½å¯èƒ½å°‘çš„äºŒè¿›åˆ¶ä½è¡¨ç¤ºå°½å¯èƒ½å¤šçš„ä¿¡æ¯ï¼Œæ‰€ä»¥è®¾ç½®äº† lock æ ‡è®°ã€‚è¯¥æ ‡è®°çš„å€¼ä¸åŒï¼Œæ•´ä¸ª mark word è¡¨ç¤ºçš„å«ä¹‰ä¸åŒã€‚

| biased_lock | lock |   çŠ¶æ€   |
| :---------: | :--: | :------: |
|      0      |  01  |   æ— é”   |
|      1      |  01  |  åå‘é”  |
|      0      |  00  | è½»é‡çº§é” |
|      0      |  10  | é‡é‡çº§é” |
|      0      |  11  | GC æ ‡è®°  |

**biased_lock**ï¼šå¯¹è±¡æ˜¯å¦å¯ç”¨åå‘é”æ ‡è®°ï¼Œåªå  1 ä¸ªäºŒè¿›åˆ¶ä½ã€‚ä¸º 1 æ—¶è¡¨ç¤ºå¯¹è±¡å¯ç”¨åå‘é”ï¼Œä¸º 0 æ—¶è¡¨ç¤ºå¯¹è±¡æ²¡æœ‰åå‘é”ã€‚
**age**ï¼š4 ä½çš„ Java å¯¹è±¡å¹´é¾„ã€‚åœ¨ GC ä¸­ï¼Œå¦‚æœå¯¹è±¡åœ¨ Survivor åŒºå¤åˆ¶ä¸€æ¬¡ï¼Œå¹´é¾„å¢åŠ  1ã€‚å½“å¯¹è±¡è¾¾åˆ°è®¾å®šçš„é˜ˆå€¼æ—¶ï¼Œå°†ä¼šæ™‹å‡åˆ°è€å¹´ä»£ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¹¶è¡Œ GC çš„å¹´é¾„é˜ˆå€¼ä¸º 15ï¼Œå¹¶å‘ GC çš„å¹´é¾„é˜ˆå€¼ä¸º 6ã€‚ç”±äº age åªæœ‰ 4 ä½ï¼Œæ‰€ä»¥æœ€å¤§å€¼ä¸º 15ï¼Œè¿™å°±æ˜¯`-XX:MaxTenuringThreshold`é€‰é¡¹æœ€å¤§å€¼ä¸º 15 çš„åŸå› ã€‚
**identity_hashcode**ï¼š25 ä½çš„å¯¹è±¡æ ‡è¯† Hash ç ï¼Œé‡‡ç”¨å»¶è¿ŸåŠ è½½æŠ€æœ¯ã€‚è°ƒç”¨æ–¹æ³•`System.identityHashCode()`è®¡ç®—ï¼Œå¹¶ä¼šå°†ç»“æœå†™åˆ°è¯¥å¯¹è±¡å¤´ä¸­ã€‚å½“å¯¹è±¡è¢«é”å®šæ—¶ï¼Œè¯¥å€¼ä¼šç§»åŠ¨åˆ°ç®¡ç¨‹ Monitor ä¸­ã€‚
**thread**ï¼šæŒæœ‰åå‘é”çš„çº¿ç¨‹ IDã€‚
**epoch**ï¼šåå‘æ—¶é—´æˆ³ã€‚
**ptr_to_lock_record**ï¼šæŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆã€‚
**ptr_to_heavyweight_monitor**ï¼šæŒ‡å‘ç®¡ç¨‹ Monitor çš„æŒ‡é’ˆã€‚

64 ä½ä¸‹çš„æ ‡è®°å­—ä¸ 32 ä½çš„ç›¸ä¼¼ï¼š

```
|------------------------------------------------------------------------------|--------------------|
|                                  Mark Word (64 bits)                         |       State        |
|------------------------------------------------------------------------------|--------------------|
| unused:25 | identity_hashcode:31 | unused:1 | age:4 | biased_lock:1 | lock:2 |       Normal       |
|------------------------------------------------------------------------------|--------------------|
| thread:54 |       epoch:2        | unused:1 | age:4 | biased_lock:1 | lock:2 |       Biased       |
|------------------------------------------------------------------------------|--------------------|
|                       ptr_to_lock_record:62                         | lock:2 | Lightweight Locked |
|------------------------------------------------------------------------------|--------------------|
|                     ptr_to_heavyweight_monitor:62                   | lock:2 | Heavyweight Locked |
|------------------------------------------------------------------------------|--------------------|
|                                                                     | lock:2 |    Marked for GC   |
|------------------------------------------------------------------------------|--------------------|
```

#### Klass Word

è¿™ä¸€éƒ¨åˆ†ç”¨äº**å­˜å‚¨å¯¹è±¡çš„ç±»å‹æŒ‡é’ˆ**ï¼Œè¯¥æŒ‡é’ˆ**æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®**ï¼Œ**JVM é€šè¿‡è¿™ä¸ªæŒ‡é’ˆç¡®å®šå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹**ã€‚è¯¥æŒ‡é’ˆçš„ä½é•¿åº¦ä¸º JVM çš„ä¸€ä¸ªå­—å¤§å°ï¼Œå³ 32 ä½çš„ JVM ä¸º 32 ä½ï¼Œ64 ä½çš„ JVM ä¸º 64 ä½ã€‚
å¦‚æœåº”ç”¨çš„å¯¹è±¡è¿‡å¤šï¼Œä½¿ç”¨ 64 ä½çš„æŒ‡é’ˆå°†æµªè´¹å¤§é‡å†…å­˜ï¼Œç»Ÿè®¡è€Œè¨€ï¼Œ64 ä½çš„ JVM å°†ä¼šæ¯” 32 ä½çš„ JVM å¤šè€—è´¹ 50%çš„å†…å­˜ã€‚ä¸ºäº†èŠ‚çº¦å†…å­˜å¯ä»¥ä½¿ç”¨é€‰é¡¹`+UseCompressedOops`å¼€å¯æŒ‡é’ˆå‹ç¼©ï¼Œå…¶ä¸­ï¼Œoop å³ ordinary object pointer æ™®é€šå¯¹è±¡æŒ‡é’ˆã€‚å¼€å¯è¯¥é€‰é¡¹åï¼Œä¸‹åˆ—æŒ‡é’ˆå°†å‹ç¼©è‡³ 32 ä½ï¼š

1.  æ¯ä¸ª Class çš„å±æ€§æŒ‡é’ˆï¼ˆå³é™æ€å˜é‡ï¼‰
2.  æ¯ä¸ªå¯¹è±¡çš„å±æ€§æŒ‡é’ˆï¼ˆå³å¯¹è±¡å˜é‡ï¼‰
3.  æ™®é€šå¯¹è±¡æ•°ç»„çš„æ¯ä¸ªå…ƒç´ æŒ‡é’ˆ

å½“ç„¶ï¼Œä¹Ÿä¸æ˜¯æ‰€æœ‰çš„æŒ‡é’ˆéƒ½ä¼šå‹ç¼©ï¼Œä¸€äº›ç‰¹æ®Šç±»å‹çš„æŒ‡é’ˆ JVM ä¸ä¼šä¼˜åŒ–ï¼Œæ¯”å¦‚æŒ‡å‘ PermGen çš„ Class å¯¹è±¡æŒ‡é’ˆ(JDK8 ä¸­æŒ‡å‘å…ƒç©ºé—´çš„ Class å¯¹è±¡æŒ‡é’ˆ)ã€æœ¬åœ°å˜é‡ã€å †æ ˆå…ƒç´ ã€å…¥å‚ã€è¿”å›å€¼å’Œ NULL æŒ‡é’ˆç­‰ã€‚

#### array length

å¦‚æœå¯¹è±¡æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé‚£ä¹ˆå¯¹è±¡å¤´è¿˜éœ€è¦æœ‰é¢å¤–çš„ç©ºé—´ç”¨äºå­˜å‚¨æ•°ç»„çš„é•¿åº¦ï¼Œè¿™éƒ¨åˆ†æ•°æ®çš„é•¿åº¦ä¹Ÿéšç€ JVM æ¶æ„çš„ä¸åŒè€Œä¸åŒï¼š32 ä½çš„ JVM ä¸Šï¼Œé•¿åº¦ä¸º 32 ä½ï¼›64 ä½ JVM åˆ™ä¸º 64 ä½ã€‚64 ä½ JVM å¦‚æœå¼€å¯`+UseCompressedOops`é€‰é¡¹ï¼Œ**è¯¥åŒºåŸŸé•¿åº¦ä¹Ÿå°†ç”± 64 ä½å‹ç¼©è‡³ 32 ä½**ã€‚

### Monitor å·¥ä½œåŸç† ğŸ”¥

Monitor è¢«ç¿»è¯‘ä¸º**ç›‘è§†å™¨**æˆ–**ç®¡ç¨‹**ï¼ŒOS ä¸­çš„æ¦‚å¿µã€‚æ¯ä¸ª Java å¯¹è±¡ï¼ˆæ­¤æ—¶å¯ä»¥ç§°ä¸º**é”å¯¹è±¡**ï¼‰éƒ½å¯ä»¥å…³è”ä¸€ä¸ª Monitor å¯¹è±¡ï¼Œå¦‚æœä½¿ç”¨ synchronized ç»™å¯¹è±¡ä¸Šé”ï¼ˆé‡é‡çº§ï¼‰ä¹‹åï¼Œè¯¥å¯¹è±¡å¤´çš„ Mark Word ä¸­å°±è¢«è®¾ç½®æŒ‡å‘ Monitor å¯¹è±¡çš„æŒ‡é’ˆ

<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:645px;" src="https://www.processon.com/embed/602e422c07912934224cfe8d"></iframe>

- åˆšå¼€å§‹ Monitor ä¸­ Owner ä¸º null
- å½“ Thread-2 æ‰§è¡Œ synchronized(obj) å°±ä¼šå°† Monitor çš„æ‰€æœ‰è€… Owner ç½®ä¸º Thread-2ï¼ŒMonitor ä¸­åªèƒ½æœ‰ä¸€ä¸ª Owner
- åœ¨ Thread-2 ä¸Šé”çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœ Thread-3ï¼ŒThread-4ï¼ŒThread-5 ä¹Ÿæ¥æ‰§è¡Œ synchronized(obj)ï¼Œå°±ä¼šè¿›å…¥ EntryList BLOCKED
- Thread-2 æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—çš„å†…å®¹ï¼Œç„¶åå”¤é†’ EntryList ä¸­ç­‰å¾…çš„çº¿ç¨‹æ¥ç«äº‰é”ï¼Œç«äº‰çš„æ—¶æ˜¯éå…¬å¹³çš„
- å›¾ä¸­ WaitSet ä¸­çš„ Thread-0ï¼ŒThread-1 æ˜¯ä¹‹å‰è·å¾—è¿‡é”ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³è¿›å…¥ WAITING çŠ¶æ€çš„çº¿ç¨‹ï¼Œåé¢è®² wait-notify æ—¶ä¼šåˆ†æ

::: tip æ³¨æ„

- synchronized å¿…é¡»æ˜¯**è¿›å…¥åŒä¸€ä¸ªå¯¹è±¡ï¼ˆåŒä¸€æŠŠé”ï¼‰çš„ monitor** æ‰æœ‰ä¸Šè¿°çš„æ•ˆæœã€‚

- ä¸åŠ  synchronized çš„å¯¹è±¡ä¸ä¼šå…³è”ç›‘è§†å™¨ï¼Œä¸éµä»ä»¥ä¸Šè§„åˆ™

:::

## synchronized å­—èŠ‚ç  ğŸ”¥

```java
public class Test {
    static final Object lock = new Object();
    static int counter = 0;
    public static void main(String[] args) {
        synchronized (lock) {
            counter++;
        }
    }
}
```

å…¶å¯¹åº”çš„å­—èŠ‚ç å¦‚ä¸‹ï¼š

```java
public static void main(java.lang.String[]);
	descriptor: ([Ljava/lang/String;)V
	flags: ACC_PUBLIC, ACC_STATIC
	Code:
		stack=2, locals=3, args_size=1
			0: getstatic #2 // <- lockå¼•ç”¨ ï¼ˆsynchronizedå¼€å§‹ï¼‰
            3: dup // å¤åˆ¶ä¸€ä»½
            4: astore_1 // lockå¼•ç”¨ -> slot 1ã€‚ä¿å­˜åˆ°slot1å˜é‡æ§½ä¸­ï¼Œä¸ºäº†è§£é”
            5: monitorenter // å°† lockå¯¹è±¡ MarkWord ç½®ä¸º Monitor æŒ‡é’ˆï¼Œè¿™é‡Œåº•å±‚æ˜¯cè°ƒç”¨ã€‚è¿™é‡Œå°±æ˜¯synchronizedä»£ç äº†
            6: getstatic #3 // <- i
            9: iconst_1 // å‡†å¤‡å¸¸æ•° 1
            10: iadd // +1
            11: putstatic #3 // -> i
            14: aload_1 // <- lockå¼•ç”¨ã€‚æ‹¿åˆ°è¯¥å¼•ç”¨
            15: monitorexit // å°† lockå¯¹è±¡ MarkWord é‡ç½®, å”¤é†’ EntryList
            16: goto 24
            // é”ä¸­å¼‚å¸¸ï¼Œå°†é”é‡Šæ”¾
            19: astore_2 // e -> slot 2
            20: aload_1 // <- lockå¼•ç”¨
            21: monitorexit // å°† lockå¯¹è±¡ MarkWord é‡ç½®(æœ‰hashcodeç­‰ç­‰), å”¤é†’ EntryList
            22: aload_2 // <- slot 2 (e)
            23: athrow // throw e
            // é”ä¸­å¼‚å¸¸ï¼Œå°†é”é‡Šæ”¾
            24: return
        Exception table:
			from to target type
			6 16 19 any
			19 22 19 any
		LineNumberTable:
			line 8: 0
			line 9: 6
			line 10: 14
			line 11: 24
		LocalVariableTable:
			Start Length Slot Name Signature
			0 25 0 args [Ljava/lang/String;
		StackMapTable: number_of_entries = 2
			frame_type = 255 /* full_frame */
				offset_delta = 19
				locals = [ class "[Ljava/lang/String;", class java/lang/Object ]
				stack = [ class java/lang/Throwable ]
			frame_type = 250 /* chop */
				offset_delta = 4
```

::: tip æ³¨æ„
æ–¹æ³•çº§åˆ«çš„ synchronized ä¸ä¼šåœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­æœ‰æ‰€ä½“ç°

:::

## å°æ•…äº‹

JDK ä» 6 å¼€å§‹å¯¹é”è¿›è¡Œäº†æ”¹è¿›

æ•…äº‹è§’è‰²

- è€ç‹ - JVM

- å°å— - çº¿ç¨‹
- å°å¥³ - çº¿ç¨‹
- æˆ¿é—´ - å¯¹è±¡
- æˆ¿é—´é—¨ä¸Š - é˜²ç›—é” - Monitor
- æˆ¿é—´é—¨ä¸Š - å°å—ä¹¦åŒ… - è½»é‡çº§é”
- æˆ¿é—´é—¨ä¸Š - åˆ»ä¸Šå°å—å¤§å - åå‘é”
- æ‰¹é‡é‡åˆ»å - ä¸€ä¸ªç±»çš„åå‘é”æ’¤é”€åˆ°è¾¾ 20 é˜ˆå€¼
- ä¸èƒ½åˆ»åå­— - æ‰¹é‡æ’¤é”€è¯¥ç±»å¯¹è±¡çš„åå‘é”ï¼Œè®¾ç½®è¯¥ç±»ä¸å¯åå‘

## synchronized åŸç†â€”è½»é‡çº§é” ğŸ”¥

è½»é‡çº§é”çš„**ä½¿ç”¨åœºæ™¯**ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡è™½ç„¶æœ‰å¤šçº¿ç¨‹è¦åŠ é”ï¼Œä½†**åŠ é”çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰ç«äº‰ï¼‰**ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ã€‚

è½»é‡çº§é”å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼Œå³è¯­æ³•ä»ç„¶æ˜¯ synchronized

å‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”

```java
static final Object obj = new Object();
public static void method1() {
    synchronized( obj ) {
        // åŒæ­¥å— A
        method2();
    }
}
public static void method2() {
    synchronized( obj ) {
        // åŒæ­¥å— B
    }
}
```

<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:1545px;" src="https://www.processon.com/embed/602e5a0ef346fb64f569accc"></iframe>

## synchronized åŸç†â€”é”è†¨èƒ€ ğŸ”¥

å¦‚æœåœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCAS æ“ä½œæ— æ³•æˆåŠŸï¼Œè¿™æ—¶ä¸€ç§æƒ…å†µå°±æ˜¯æœ‰å…¶å®ƒçº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”ï¼ˆæœ‰ç«äº‰ï¼‰ï¼Œè¿™æ—¶éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜ä¸ºé‡é‡çº§é”ï¼ˆè®©è§£é”æ“ä½œæ¥ä¸‹æ¥çš„è§£é”æ“ä½œè¿›å…¥åˆ°é‡é‡çº§é”çš„è§£é”ï¼‰ã€‚

```java
public class Test {
    static Object obj = new Object();
    public static void method1() {
        synchronized( obj ) {
            // åŒæ­¥å—
        }
    }
}
```

<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:745px;" src="https://www.processon.com/embed/602e8eaa07912934224d5784"></iframe>

## synchronized åŸç†â€”è‡ªæ—‹ä¼˜åŒ–ï¼ˆä¼˜åŒ–é‡é‡çº§é”ï¼‰ ğŸ”¥

**é‡é‡çº§é”ç«äº‰**çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥è¿›è¡Œä¼˜åŒ–ï¼Œ**å¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸï¼ˆå³è¿™æ—¶å€™æŒé”çº¿ç¨‹å·²ç»é€€å‡ºäº†åŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”ï¼‰ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ï¼Œé¿å…çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢**ã€‚

::: tip çº¿ç¨‹åˆ‡æ¢

çº¿ç¨‹çš„é˜»å¡å”¤é†’éœ€è¦ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œç„¶åå†…æ ¸æ€åˆ‡æ¢ tcbï¼Œåˆ‡åˆ°å¦ä¸€ä¸ªçº¿ç¨‹çš„å†…æ ¸æ€ï¼Œå†ä»å†…æ ¸æ€è¿›å…¥ç”¨æˆ·æ€ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡é‡çº§çš„æ“ä½œ

:::

è‡ªæ—‹é‡è¯•æˆåŠŸçš„æƒ…å†µï¼š

| çº¿ç¨‹ 1ï¼ˆcore1 ä¸Šï¼‰       | å¯¹è±¡ Mark              | çº¿ç¨‹ 2ï¼ˆcore2 ä¸Šï¼‰       |
| ------------------------ | ---------------------- | ------------------------ |
| -                        | 10ï¼ˆé‡é‡é”ï¼‰           | -                        |
| è®¿é—®åŒæ­¥å—ï¼Œè·å– monitor | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | -                        |
| æˆåŠŸï¼ˆåŠ é”ï¼‰             | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | -                        |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | -                        |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | è®¿é—®åŒæ­¥å—ï¼Œè·å– monitor |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | è‡ªæ—‹é‡è¯•                 |
| æ‰§è¡Œå®Œæ¯•                 | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | è‡ªæ—‹é‡è¯•                 |
| æˆåŠŸï¼ˆè§£é”ï¼‰             | 01ï¼ˆæ— é”ï¼‰             | è‡ªæ—‹é‡è¯•                 |
| -                        | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | æˆåŠŸï¼ˆåŠ é”ï¼‰             |
| -                        | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | æ‰§è¡ŒåŒæ­¥å—               |
| -                        | ...                    | ...                      |

è‡ªæ—‹é‡è¯•å¤±è´¥çš„æƒ…å†µï¼š

| çº¿ç¨‹ 1ï¼ˆcore1 ä¸Šï¼‰       | å¯¹è±¡ Mark              | çº¿ç¨‹ 2ï¼ˆcore2 ä¸Šï¼‰       |
| ------------------------ | ---------------------- | ------------------------ |
| -                        | 10ï¼ˆé‡é‡é”ï¼‰           | -                        |
| è®¿é—®åŒæ­¥å—ï¼Œè·å– monitor | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | -                        |
| æˆåŠŸï¼ˆåŠ é”ï¼‰             | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | -                        |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | -                        |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | è®¿é—®åŒæ­¥å—ï¼Œè·å– monitor |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | è‡ªæ—‹é‡è¯•                 |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | è‡ªæ—‹é‡è¯•                 |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | è‡ªæ—‹é‡è¯•                 |
| æ‰§è¡ŒåŒæ­¥å—               | 10ï¼ˆé‡é‡é”ï¼‰é‡é‡é”æŒ‡é’ˆ | é˜»å¡                     |
| -                        | ...                    | ...                      |

- **è‡ªæ—‹ä¼šå ç”¨ CPU æ—¶é—´**ï¼Œå•æ ¸ CPU è‡ªæ—‹å°±æ˜¯æµªè´¹ï¼Œ**å¤šæ ¸ CPU è‡ªæ—‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿**ã€‚
- åœ¨ Java 6 ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚å¯¹è±¡åˆšåˆšçš„ä¸€æ¬¡è‡ªæ—‹æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼šé«˜ï¼Œå°±å¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹ï¼Œå°±å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹ï¼Œæ€»ä¹‹ï¼Œæ¯”è¾ƒæ™ºèƒ½ã€‚
- Java 7 ä¹‹åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½

## synchronized åŸç†â€”åå‘é”ï¼ˆä¼˜åŒ–è½»é‡çº§é” CASï¼‰ ğŸ”¥

### ä¼˜åŒ–è½»é‡çº§é” CAS ğŸ”¥

**è½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶ï¼ˆå°±è‡ªå·±è¿™ä¸ªçº¿ç¨‹ï¼‰ï¼Œæ¯æ¬¡é‡å…¥ä»ç„¶éœ€è¦æ‰§è¡Œ CAS æ“ä½œï¼ˆè¿˜éœ€å†æ¬¡è®°å½• lock recordï¼‰ã€‚**

Java 6 ä¸­å¼•å…¥äº†åå‘é”æ¥åšè¿›ä¸€æ­¥ä¼˜åŒ–ï¼š**åªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨ CAS æ—¶å°±å°†çº¿ç¨‹ ID è®¾ç½®åˆ°å¯¹è±¡çš„ Mark Word å¤´**ï¼Œä¹‹åå‘ç°è¿™ä¸ªçº¿ç¨‹ ID æ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œä¸ç”¨é‡æ–° CASã€‚ä»¥ååªè¦ä¸å‘ç”Ÿç«äº‰ï¼Œè¿™ä¸ªå¯¹è±¡å°±å½’è¯¥çº¿ç¨‹æ‰€æœ‰

ä¾‹å¦‚ï¼š

```java
public class Test {
    static final Object obj = new Object();
    public static void m1() {
        synchronized( obj ) {
            // åŒæ­¥å— A
            m2();
        }
    }
    public static void m2() {
        synchronized( obj ) {
            // åŒæ­¥å— B
            m3();
        }
    }
    public static void m3() {
        synchronized( obj ) {
        }
        // åŒæ­¥å— C
    }
}
```

```mermaid
flowchart TB
    subgraph è½»é‡çº§é”
    m1("m1å†…è°ƒç”¨synchronized(obj)") -.ç”Ÿæˆé”è®°å½•.-> m1
    m1-- ç”¨ é”è®°å½• æ›¿æ¢ Mark Word -->obj(å¯¹è±¡)
    m2("m2å†…è°ƒç”¨synchronized(obj)") -.ç”Ÿæˆé”è®°å½•.-> m2
    m2-- ç”¨ é”è®°å½• æ›¿æ¢ Mark Word -->obj(å¯¹è±¡)
    m3("m3å†…è°ƒç”¨synchronized(obj)") -.ç”Ÿæˆé”è®°å½•.-> m3
    m3-- ç”¨ é”è®°å½• æ›¿æ¢ Mark Word -->obj(å¯¹è±¡)
   	end
```

```mermaid
flowchart TB
    subgraph è½»é‡çº§é”
    m1("m1å†…è°ƒç”¨synchronized(obj)")
    m1-- ç”¨ ThreadId æ›¿æ¢  Mark Word -->obj(å¯¹è±¡)
    m2("m2å†…è°ƒç”¨synchronized(obj)")
    m2-- æ£€æŸ¥ ThreadId æ˜¯å¦æ˜¯è‡ªå·± -->obj(å¯¹è±¡)
    m3("m3å†…è°ƒç”¨synchronized(obj)")
    m3-- æ£€æŸ¥ ThreadId æ˜¯å¦æ˜¯è‡ªå·± -->obj(å¯¹è±¡)
   	end
```

### åå‘çŠ¶æ€

å›å¿†ä¸€ä¸‹å¯¹è±¡å¤´æ ¼å¼

```
|------------------------------------------------------------------------------|--------------------|
|                                  Mark Word (64 bits)                         |       State        |
|------------------------------------------------------------------------------|--------------------|
| unused:25 | identity_hashcode:31 | unused:1 | age:4 | biased_lock:1 | lock:2 |       Normal       |
|------------------------------------------------------------------------------|--------------------|
| thread:54 |       epoch:2        | unused:1 | age:4 | biased_lock:1 | lock:2 |       Biased       |
|------------------------------------------------------------------------------|--------------------|
|                       ptr_to_lock_record:62                         | lock:2 | Lightweight Locked |
|------------------------------------------------------------------------------|--------------------|
|                     ptr_to_heavyweight_monitor:62                   | lock:2 | Heavyweight Locked |
|------------------------------------------------------------------------------|--------------------|
|                                                                     | lock:2 |    Marked for GC   |
|------------------------------------------------------------------------------|--------------------|
```

ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼š

- å¦‚æœå¼€å¯äº†åå‘é”ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼Œé‚£ä¹ˆ**å¯¹è±¡åˆ›å»ºåï¼Œmarkword å€¼ä¸º 0x05 å³æœ€å 3 ä½ä¸º 101**ï¼Œè¿™æ—¶å®ƒçš„ threadã€epochã€age éƒ½ä¸º 0ï¼ŒåŠ é”æ—¶æ‰ä¼šæ”¹å˜

- **åå‘é”æ˜¯é»˜è®¤æ˜¯å»¶è¿Ÿçš„**ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥åŠ  VM å‚æ•°

  `-XX:BiasedLockingStartupDelay=0` æ¥ç¦ç”¨å»¶è¿Ÿ

- å¦‚æœæ²¡æœ‰å¼€å¯åå‘é”ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼ŒMark Word å€¼ä¸º 0x01 å³æœ€å 3 ä½ä¸º 001ï¼Œè¿™æ—¶å®ƒçš„ hashcodeã€age éƒ½ä¸º 0ï¼Œç¬¬ä¸€æ¬¡ç”¨åˆ° hashcode æ—¶æ‰ä¼šèµ‹å€¼

æŸ¥çœ‹ Java å¯¹è±¡å¤´éœ€è¦å€ŸåŠ© openjdk æä¾›çš„å·¥å…·

```xml
<!-- https://mvnrepository.com/artifact/org.openjdk.jol/jol-core -->
<dependency>
    <groupId>org.openjdk.jol</groupId>
    <artifactId>jol-core</artifactId>
    <version>0.14</version>
    <scope>provided</scope>
</dependency>
```

### æµ‹è¯•å»¶è¿Ÿæ€§

```java
@Slf4j(topic = "TestBiasedLock")
public class TestBiasedLock {

    public static void main(String[] args) throws InterruptedException {
        test1();
    }

    /**
     * æµ‹è¯•101
     */
    private static void test1(){
        log.debug(ClassLayout.parseInstance(new Dog()).toPrintable());

        // åå‘é”æ˜¯é»˜è®¤æ˜¯å»¶è¿Ÿçš„ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆã€‚VMå‚æ•°å¯ä»¥è§£å†³-XX:BiasedLockingStartupDelay=0
        // æˆ–ç¡ä¸€ä¼šã€‚TimeUnit.SECONDS.sleep(5);
        log.debug(ClassLayout.parseInstance(new Dog()).toPrintable());
    }
}

class Dog {

}
```

ç»“æœå¦‚ä¸‹ï¼ˆä»å·¦å¾€å³ï¼Œä»ä¸Šåˆ°ä¸‹éƒ½æ˜¯å€’æ’çš„ï¼‰ï¼š

```
21:21:16.604 [main] DEBUG TestBiasedLock - _999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           05 00 00 00 (00000101 00000000 00000000 00000000) (5)
      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4        (object header)                           22 dc 00 f8 (00100010 11011100 00000000 11111000) (-134161374)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total
```

### æµ‹è¯•åŠ é”

```java
@Slf4j(topic = "TestBiasedLock")
public class TestBiasedLock {

    public static void main(String[] args) throws InterruptedException {
        test2();
    }

    private static void test2() {
        Dog d = new Dog();
        ClassLayout classLayout = ClassLayout.parseInstance(d);
        new Thread(() -> {
            log.debug("synchronized åŠ é”å‰\n{}", classLayout.toPrintable());
            synchronized (d) {
                log.debug("synchronized åŠ é”ä¸­\n{}", classLayout.toPrintable());
            }
            log.debug("synchronized åŠ é”å\n{}",classLayout.toPrintable());
        }, "t1").start();
    }
}

class Dog {

}
```

ç»“æœå¦‚ä¸‹ï¼ˆä»å·¦å¾€å³ï¼Œä»ä¸Šåˆ°ä¸‹éƒ½æ˜¯å€’æ’çš„ï¼ŒåŒä¸€å­—èŠ‚ä¸­æ˜¯æŒ‰ç…§æ­£å¸¸é¡ºåºæ’åˆ—ï¼‰ï¼š

```
21:22:16.638 [t1] DEBUG TestBiasedLock - synchronized åŠ é”å‰
_999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           05 00 00 00 (00000101 00000000 00000000 00000000) (5)
      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4        (object header)                           22 dc 00 f8 (00100010 11011100 00000000 11111000) (-134161374)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

21:22:16.643 [t1] DEBUG TestBiasedLock - synchronized åŠ é”ä¸­
_999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           05 b8 19 86 (00000101 10111000 00011001 10000110) (-2045134843)
      4     4        (object header)                           a4 7f 00 00 (10100100 01111111 00000000 00000000) (32676)
      8     4        (object header)                           22 dc 00 f8 (00100010 11011100 00000000 11111000) (-134161374)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

21:22:16.644 [t1] DEBUG TestBiasedLock - synchronized åŠ é”å
_999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           05 b8 19 86 (00000101 10111000 00011001 10000110) (-2045134843)
      4     4        (object header)                           a4 7f 00 00 (10100100 01111111 00000000 00000000) (32676)
      8     4        (object header)                           22 dc 00 f8 (00100010 11011100 00000000 11111000) (-134161374)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total
```

å…¶ä¸­ 00000000 00000000 01111111 10100100 10000110 00011001 100111 æ˜¯çº¿ç¨‹ idï¼ˆOS åˆ†é…çš„ï¼Œå’Œ Java ä¸ä¸€æ ·ï¼‰ã€‚åªæœ‰ç¬¬äºŒæ¬¡åŠä¹‹åæ‰æœ‰ã€‚å¤„äºåå‘é”çš„å¯¹è±¡è§£é”åï¼Œçº¿ç¨‹ id ä»å­˜å‚¨äºå¯¹è±¡å¤´ä¸­

### ç¦ç”¨åå‘é”

åå‘é”é€‚ç”¨äºï¼Œç«äº‰éå¸¸å°‘çš„æƒ…å†µã€‚å½“åº”ç”¨æ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹éå¸¸å¤šçš„ï¼Œæ­¤æ—¶åº”è¯¥ç¦ç”¨æ‰

æ·»åŠ  VM å‚æ•° `-XX:-UseBiasedLocking` ç¦ç”¨åå‘é”ã€‚å› ä¸ºå˜é‡å‰æ˜¯ `-` æ‰€ä»¥å…³é—­äº†ï¼Œè‹¥æ˜¯`+`åˆ™å¼€å¯

ç»“æœå¦‚ä¸‹ï¼ˆä»å·¦å¾€å³ï¼Œä»ä¸Šåˆ°ä¸‹éƒ½æ˜¯å€’æ’çš„ï¼ŒåŒä¸€å­—èŠ‚ä¸­æ˜¯æŒ‰ç…§æ­£å¸¸é¡ºåºæ’åˆ—ï¼‰ï¼š

```
01:57:17.769 [t1] DEBUG TestBiasedLock - synchronized åŠ é”å‰
_999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)
      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4        (object header)                           22 dc 00 f8 (00100010 11011100 00000000 11111000) (-134161374)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

01:57:17.775 [t1] DEBUG TestBiasedLock - synchronized åŠ é”ä¸­
_999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           00 b9 6d 06 (00000000 10111001 01101101 00000110) (107854080)
      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)
      8     4        (object header)                           22 dc 00 f8 (00100010 11011100 00000000 11111000) (-134161374)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

01:57:17.776 [t1] DEBUG TestBiasedLock - synchronized åŠ é”å
_999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           01 00 00 00 (00000001 00000000 00000000 00000000) (1)
      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4        (object header)                           22 dc 00 f8 (00100010 11011100 00000000 11111000) (-134161374)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total
```

å¯ä»¥çœ‹åˆ°ï¼ŒåŠ é”ä¸­æœ€åä¸º`000`å³è½»é‡é”ã€‚åŠ é”å‰åä¸º`001`å³æ— é”ï¼ˆ**é™¤äº†åå‘é”å…¶ä»–é”æ‰§è¡Œå®Œåéƒ½æ˜¯`001`æ— é”çŠ¶æ€**ï¼‰

### æ’¤é”€åå‘é”â€”é”å¯¹è±¡è°ƒç”¨ hashCode

è°ƒç”¨äº†å¯¹è±¡çš„ hashCodeï¼Œä½†**åå‘é”çš„å¯¹è±¡ MarkWord ä¸­å­˜å‚¨çš„æ˜¯çº¿ç¨‹ id**ï¼Œå¦‚æœè°ƒç”¨ hashCode ä¼šå¯¼è‡´åå‘é”è¢«æ’¤é”€ï¼ˆä¸å¤Ÿå­˜çº¿ç¨‹ IDï¼‰ï¼Œ**å‡çº§ä¸ºè½»é‡é”**ã€‚

- **è½»é‡çº§é”çš„ hashCode ä¼šåœ¨æ— é” CAS è½¬ä¸ºè½»é‡é”æ—¶è®°å½•åˆ°é”è®°å½•ä¸­**

- **é‡é‡çº§é”ä¼šåœ¨ Monitor ä¸­è®°å½• hashCode**

æµ‹è¯•åœ¨è°ƒç”¨ hashCode åä½¿ç”¨åå‘é”ï¼Œè®°å¾—å»æ‰ `-XX:-UseBiasedLocking`ï¼ŒåŠ ä¸Š

`-XX:BiasedLockingStartupDelay=0`

```java
@Slf4j(topic = "TestBiasedLock")
public class TestBiasedLock {

    public static void main(String[] args) throws InterruptedException {
        test2();
    }

    private static void test2() {
        Dog d = new Dog();
        d.hashCode();
        ClassLayout classLayout = ClassLayout.parseInstance(d);
        new Thread(() -> {
            log.debug("synchronized åŠ é”å‰\n{}", classLayout.toPrintable());
            synchronized (d) {
                log.debug("synchronized åŠ é”ä¸­\n{}", classLayout.toPrintable());
            }
            log.debug("synchronized åŠ é”å\n{}",classLayout.toPrintable());
        }, "t1").start();
    }
}

class Dog {

}
```

ç»“æœå¦‚ä¸‹ï¼ˆä»å·¦å¾€å³ï¼Œä»ä¸Šåˆ°ä¸‹éƒ½æ˜¯å€’æ’çš„ï¼ŒåŒä¸€å­—èŠ‚ä¸­æ˜¯æŒ‰ç…§æ­£å¸¸é¡ºåºæ’åˆ—ï¼‰ï¼š

```
21:25:59.886 [t1] DEBUG TestBiasedLock - synchronized åŠ é”å‰
_999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           01 18 94 ad (00000001 00011000 10010100 10101101) (-1382803455)
      4     4        (object header)                           20 00 00 00 (00100000 00000000 00000000 00000000) (32)
      8     4        (object header)                           22 de 00 f8 (00100010 11011110 00000000 11111000) (-134160862)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

21:25:59.890 [t1] DEBUG TestBiasedLock - synchronized åŠ é”ä¸­
_999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           00 b9 c5 03 (00000000 10111001 11000101 00000011) (63289600)
      4     4        (object header)                           00 70 00 00 (00000000 01110000 00000000 00000000) (28672)
      8     4        (object header)                           22 de 00 f8 (00100010 11011110 00000000 11111000) (-134160862)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

21:25:59.890 [t1] DEBUG TestBiasedLock - synchronized åŠ é”å
_999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           01 18 94 ad (00000001 00011000 10010100 10101101) (-1382803455)
      4     4        (object header)                           20 00 00 00 (00100000 00000000 00000000 00000000) (32)
      8     4        (object header)                           22 de 00 f8 (00100010 11011110 00000000 11111000) (-134160862)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total
```

åŠ é”å‰åéƒ½æ˜¯`001`å³æ— é”ï¼ŒåŠ é”ä¸­ä¸º`000`è½»é‡é”ï¼Œ**è½»é‡é”æ‰§è¡Œå®Œåéƒ½æ˜¯`001`æ— é”çŠ¶æ€**

### æ’¤é”€åå‘é”â€”é”ç«äº‰â€”å…¶ä»–çº¿ç¨‹ä½¿ç”¨é” ğŸ”¥

å½“æœ‰**å…¶å®ƒçº¿ç¨‹ä½¿ç”¨åå‘é”å¯¹è±¡**æ—¶ï¼Œä¼š**å°†åå‘é”å‡çº§ä¸ºè½»é‡çº§é”**ã€‚å› ä¸ºåå‘é”æœ¬æ¥æ˜¯è®©è¯¥çº¿ç¨‹ä¸€ç›´ä½¿ç”¨çš„ï¼Œä½†æ˜¯å‘ç”Ÿç«äº‰ï¼Œéœ€**å‡çº§ä¸ºè½»é‡é”**

éœ€è¦æ§åˆ¶çº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼

```java
@Slf4j(topic = "TestBiasedLock")
public class TestBiasedLock {

    public static void main(String[] args) {
        test3();
    }

    /**
     * å…¶ä»–çº¿ç¨‹ä½¿ç”¨å¯¹è±¡ æ’¤é”€åå‘é”
     */
    private static void test3() {
        Dog d = new Dog();
        ClassLayout classLayout = ClassLayout.parseInstance(d);
        Thread t1 = new Thread(() -> {
            log.debug("t1 synchronized åŠ é”å‰\n{}", classLayout.toPrintable());
            synchronized (d) {
                log.debug("t1 synchronized åŠ é”ä¸­\n{}", classLayout.toPrintable());
            }
            log.debug("t1 synchronized åŠ é”å\n{}", classLayout.toPrintable());

            // è¿™é‡Œå’Œ waitã€notify æ’¤é”€åå‘é”ä¸ä¸€æ ·å“¦ï¼Œå› ä¸ºé”å¯¹è±¡éƒ½ä¸ä¸€æ ·ï¼
            // t1 æ‰§è¡Œå®Œå†å”¤é†’ t2ï¼ˆç”¨åŒä¸€æŠŠé”ï¼‰ã€‚æ­¤æ—¶waitã€notifyä¸æ˜¯é‡é‡é”
            synchronized (TestBiasedLock.class) {
                TestBiasedLock.class.notify();
            }

        }, "t1");
        t1.start();

        // ç»“æœæ˜¯è¦è®©t2å…ˆæ‰§è¡Œå“¦ï¼Œå¯ä»¥æ”¾åˆ°t1å‰
        Thread t2 = new Thread(() -> {
            // è¿™é‡Œå’Œ waitã€notify æ’¤é”€åå‘é”ä¸ä¸€æ ·å“¦ï¼Œå› ä¸ºé”å¯¹è±¡éƒ½ä¸ä¸€æ ·ï¼
            // ç­‰å¾…å”¤é†’
            synchronized (TestBiasedLock.class) {
                try {
                    TestBiasedLock.class.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }

            log.debug("t2 synchronized åŠ é”å‰\n{}", classLayout.toPrintable());
            synchronized (d) {
                log.debug("t2 synchronized åŠ é”ä¸­\n{}", classLayout.toPrintable());
            }
            log.debug("t2 synchronized åŠ é”å\n{}", classLayout.toPrintable());
        }, "t2");
        t2.start();
    }
}

class Dog {

}
```

ç»“æœå¦‚ä¸‹ï¼ˆä»å·¦å¾€å³ï¼Œä»ä¸Šåˆ°ä¸‹éƒ½æ˜¯å€’æ’çš„ï¼ŒåŒä¸€å­—èŠ‚ä¸­æ˜¯æŒ‰ç…§æ­£å¸¸é¡ºåºæ’åˆ—ï¼‰ï¼š

```
21:20:40.564 [t1] DEBUG TestBiasedLock - t1 synchronized åŠ é”å‰
_999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           05 00 00 00 (00000101 00000000 00000000 00000000) (5)
      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4        (object header)                           22 dc 00 f8 (00100010 11011100 00000000 11111000) (-134161374)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

21:20:40.569 [t1] DEBUG TestBiasedLock - t1 synchronized åŠ é”ä¸­
_999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           05 08 17 cc (00000101 00001000 00010111 11001100) (-870905851)
      4     4        (object header)                           cf 7f 00 00 (11001111 01111111 00000000 00000000) (32719)
      8     4        (object header)                           22 dc 00 f8 (00100010 11011100 00000000 11111000) (-134161374)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

21:20:40.570 [t1] DEBUG TestBiasedLock - t1 synchronized åŠ é”å
_999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           05 08 17 cc (00000101 00001000 00010111 11001100) (-870905851)
      4     4        (object header)                           cf 7f 00 00 (11001111 01111111 00000000 00000000) (32719)
      8     4        (object header)                           22 dc 00 f8 (00100010 11011100 00000000 11111000) (-134161374)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total
```

ç”±ä¸Šé¢çŠ¶æ€ 101ã€101ã€101ã€101ã€000ã€001 æ”¹å˜å¯ä»¥å¾—å‡º t1 çº¿ç¨‹éƒ½æ˜¯åå‘é”ï¼Œt2 çº¿ç¨‹åŠ é”å‰ã€ä¸­ã€ååˆ†åˆ«ä¸ºåå‘é”ã€è½»é‡é”ï¼ˆç«äº‰å¯¼è‡´é”å‡çº§ï¼‰ã€æ— é”ã€‚**è½»é‡é”æ‰§è¡Œå®Œåéƒ½æ˜¯`001`æ— é”çŠ¶æ€**

### æ’¤é”€åå‘é”â€”é”å¯¹è±¡è°ƒç”¨ wait/notify

**wait/notify æœºåˆ¶åªæœ‰é‡é‡çº§é”æ‰æœ‰ï¼åªè¦è°ƒç”¨äº†å°±å˜ä¸ºé‡é‡çº§é”**

```java
@Slf4j(topic = "TestBiasedLock")
public class TestBiasedLock {

    public static void main(String[] args) {
        test4();
    }

    /**
     * æ’¤é”€åå‘é”â€”é”å¯¹è±¡è°ƒç”¨ wait/notify
     */
    private static void test4() {
        Dog d = new Dog();
        ClassLayout classLayout = ClassLayout.parseInstance(d);

        // ç»“æœæ˜¯è¦è®©t1å…ˆæ‰§è¡Œå“¦
        Thread t1 = new Thread(() -> {
            log.debug("t1 synchronized åŠ é”å‰\n{}", classLayout.toPrintable());
            synchronized (d) {
                log.debug("t1 synchronized åŠ é”ä¸­\n{}", classLayout.toPrintable());
                try {
                    // ç­‰å¾…
                    d.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            log.debug("t1 synchronized åŠ é”å\n{}", classLayout.toPrintable());
        }, "t1");
        t1.start();


        Thread t2 = new Thread(() -> {
            try {
                TimeUnit.SECONDS.sleep(5);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

            synchronized (d){
                log.debug("t2 notify");
                d.notify();
            }

        }, "t2");
        t2.start();
    }
}

class Dog {

}
```

ç»“æœå¦‚ä¸‹ï¼ˆä»å·¦å¾€å³ï¼Œä»ä¸Šåˆ°ä¸‹éƒ½æ˜¯å€’æ’çš„ï¼ŒåŒä¸€å­—èŠ‚ä¸­æ˜¯æŒ‰ç…§æ­£å¸¸é¡ºåºæ’åˆ—ï¼‰ï¼š

```
21:48:53.705 [t1] DEBUG TestBiasedLock - t1 synchronized åŠ é”å‰
_999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           05 00 00 00 (00000101 00000000 00000000 00000000) (5)
      4     4        (object header)                           00 00 00 00 (00000000 00000000 00000000 00000000) (0)
      8     4        (object header)                           22 dc 00 f8 (00100010 11011100 00000000 11111000) (-134161374)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

21:48:53.710 [t1] DEBUG TestBiasedLock - t1 synchronized åŠ é”ä¸­
_999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           05 08 83 5e (00000101 00001000 10000011 01011110) (1585645573)
      4     4        (object header)                           f9 7f 00 00 (11111001 01111111 00000000 00000000) (32761)
      8     4        (object header)                           22 dc 00 f8 (00100010 11011100 00000000 11111000) (-134161374)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

21:48:58.703 [t2] DEBUG TestBiasedLock - t2 notify
21:48:58.706 [t1] DEBUG TestBiasedLock - t1 synchronized notify å
_999_demo.Dog object internals:
 OFFSET  SIZE   TYPE DESCRIPTION                               VALUE
      0     4        (object header)                           fa 93 01 5e (11111010 10010011 00000001 01011110) (1577161722)
      4     4        (object header)                           f9 7f 00 00 (11111001 01111111 00000000 00000000) (32761)
      8     4        (object header)                           22 dc 00 f8 (00100010 11011100 00000000 11111000) (-134161374)
     12     4        (loss due to the next object alignment)
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total
```

ä¸Šé¢çš„çŠ¶æ€ï¼šåŠ é”å‰ 101 åå‘é”ã€åŠ é”ä¸­ 101 åå‘é”ã€nofity å 010 é‡é‡çº§é”ï¼ˆé”è†¨èƒ€ï¼‰ï¼Œ**é‡é‡é”ä¸ä¼šæ’¤é”€æ ‡è®°**ã€å› ä¸º**é‡é‡çº§é”æ˜¯æ ¹æ® monitor çš„ owner æ¥åˆ¤æ–­é”çŠ¶æ€çš„**

### æ‰¹é‡é‡åå‘â€”åŒä¸€ç±»çš„å¯¹è±¡æ’¤é”€åç¬¬ 20 æ¬¡

éƒ½æ˜¯**æ’¤é”€**æ“ä½œé˜ˆå€¼

å¦‚æœå¯¹è±¡è™½ç„¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ²¡æœ‰ç«äº‰ï¼Œè¿™æ—¶åå‘äº†çº¿ç¨‹ T1 çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘ T2ï¼Œ**é‡åå‘ä¼šé‡ç½®å¯¹è±¡çš„ Thread ID**ã€‚å½“**æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡ 20 æ¬¡**åï¼Œjvm ä¼šè¿™æ ·è§‰å¾—ï¼Œæˆ‘æ˜¯ä¸æ˜¯åå‘é”™äº†å‘¢ï¼Œäºæ˜¯ä¼šåœ¨ç»™è¿™äº›å¯¹è±¡åŠ é”æ—¶**ä¸ä¼šæ’¤é”€é”è€Œæ˜¯é‡æ–°åå‘è‡³åŠ é”çº¿ç¨‹**ã€‚**æ²¡è¶…è¿‡é˜ˆå€¼å‰ï¼Œç”±äºé”ç«äº‰ä¼šå‡çº§ä¸ºè½»é‡çº§é”ï¼Œæœ€ç»ˆæ‰§è¡Œå®Œåæ¸…ç©º Thread IDï¼Œå¹¶å°†é”çŠ¶æ€ç½®ä¸º`001`å³æ— é”çŠ¶æ€**

```java
@Slf4j(topic = "TestBiasedLock")
public class TestBiasedLock {

    public static void main(String[] args) {
        test5();
    }

    /**
     * æ‰¹é‡é‡åå‘
     */
    private static void test5() {
        Vector<Dog> list = new Vector<>();
        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 30; i++) {
                Dog d = new Dog();
                list.add(d);
                synchronized (d) {
                    log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
                }
            }
            synchronized (list) {
                list.notify();
            }
        }, "t1");
        t1.start();

        Thread t2 = new Thread(() -> {
            synchronized (list) {
                try {
                    list.wait();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
            log.debug("===============> ");
            for (int i = 0; i < 30; i++) {
                Dog d = list.get(i);
                log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
                synchronized (d) {
                    log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
                }
                log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
            }
        }, "t2");
        t2.start();
    }
}

class Dog {

}
```

ç»“æœå¦‚ä¸‹ï¼ˆè€å¸ˆç®€åŒ–åçš„å·¥å…·ç±»ï¼‰

```
[t1] - 0 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 1 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 2 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 3 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 4 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 5 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 6 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 7 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 8 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 9 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 10 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 11 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 12 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 13 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 14 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 15 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 16 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 17 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 18 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t1] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - ===============>
[t2] - 0 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 0 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 0 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 1 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 1 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 1 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 2 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 2 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 2 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 3 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 3 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 3 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 4 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 4 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 4 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 5 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 5 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 5 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 6 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 6 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 6 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 7 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 7 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 7 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 8 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 8 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 8 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 9 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 9 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 9 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 10 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 10 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 10 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 11 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 11 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 11 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 12 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 12 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 12 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 13 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 13 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 13 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 14 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 14 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 14 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 15 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 15 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 15 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 16 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 16 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 16 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 17 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 17 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 17 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 18 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 18 00000000 00000000 00000000 00000000 00100000 01011000 11110111 00000000
[t2] - 18 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000001
[t2] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 19 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 20 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 21 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 22 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 23 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 24 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 25 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 26 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 27 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 28 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11100000 00000101
[t2] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
[t2] - 29 00000000 00000000 00000000 00000000 00011111 11110011 11110001 00000101
```

### æ‰¹é‡æ’¤é”€â€”åŒä¸€ç±»å¯¹è±¡æ’¤é”€åç¬¬ 40 æ¬¡

éƒ½æ˜¯**æ’¤é”€**æ“ä½œé˜ˆå€¼

**å½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡ 40 æ¬¡å**ï¼Œjvm ä¼šè¿™æ ·è§‰å¾—ï¼Œè‡ªå·±ç¡®å®åå‘é”™äº†ï¼Œæ ¹æœ¬å°±ä¸è¯¥åå‘ã€‚äºæ˜¯æ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šå˜ä¸ºä¸å¯åå‘çš„ï¼Œæ–°å»ºçš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯åå‘çš„

```java
@Slf4j(topic = "TestBiasedLock")
public class TestBiasedLock {

    public static void main(String[] args) throws InterruptedException {
        test6();
    }

    static Thread t1, t2, t3;

    /**
     * æ‰¹é‡æ’¤é”€
     */
    private static void test6() throws InterruptedException {

        Vector<Dog> list = new Vector<>();
        int loopNumber = 39;
        t1 = new Thread(() -> {
            for (int i = 0; i < loopNumber; i++) {
                Dog d = new Dog();
                list.add(d);
                synchronized (d) {
                    log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
                }
            }
            LockSupport.unpark(t2);
        }, "t1");
        t1.start();

        t2 = new Thread(() -> {
            LockSupport.park();
            log.debug("===============> ");
            for (int i = 0; i < loopNumber; i++) {
                Dog d = list.get(i);
                log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
                synchronized (d) {
                    log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
                }
                log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
            }
            LockSupport.unpark(t3);
        }, "t2");
        t2.start();

        t3 = new Thread(() -> {
            LockSupport.park();
            log.debug("===============> ");
            for (int i = 0; i < loopNumber; i++) {
                Dog d = list.get(i);
                log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
                synchronized (d) {
                    log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
                }
                log.debug(i + "\t" + ClassLayout.parseInstance(d).toPrintable());
            }
        }, "t3");
        t3.start();

        t3.join();
        log.debug(ClassLayout.parseInstance(new Dog()).toPrintable());

    }
}

class Dog {

}
```

ç»“æœå¦‚ä¸‹ï¼šç•¥

- ç¬¬ä¸€æ¬¡ 39 ä¸ªåŠ  t1 çš„åå‘é”
- ç¬¬äºŒæ¬¡å‰**19**ä¸ªä¼šå‘ç”Ÿé”ç«äº‰ï¼Œæœ€ç»ˆ**æ’¤é”€é”**å˜ä¸ºæ— é”çŠ¶æ€ï¼Œç¬¬ 20 ä¸ªå¼€å§‹å‘ç”Ÿæ‰¹é‡é‡åå‘ï¼Œæœ€ç»ˆé”çŠ¶æ€éƒ½æ˜¯æŒ‡å‘ t2 çš„åå‘é”
- ç¬¬ä¸‰æ¬¡å‰ 19 ä¸ªæ— é”å˜ä¸ºåå‘é”ï¼Œæ²¡å•¥è¯´çš„ã€‚ç¬¬ 20 ä¸ªå¼€å§‹é”ç«äº‰ï¼Œä¼š**æ’¤é”€é”**ï¼Œå³ 20 æ¬¡
- é‚£ä¹ˆè¿™ä¸ªç±»çš„å¯¹è±¡æœ‰äº† 39 æ¬¡é”æ’¤é”€ï¼Œé‚£ä¹ˆç¬¬ 40 æ¬¡ä»¥åŠä¹‹ååˆ›å»ºè¯¥å¯¹è±¡ï¼Œåˆ™è¯¥å¯¹è±¡é»˜è®¤ä¸º**æ— é”çŠ¶æ€**

## synchronized åŸç†â€”é”æ¶ˆé™¤ ğŸ”¥

benchmarks é¡¹ç›®è§å‰é¢ç« èŠ‚

```java
@Fork(1)
@BenchmarkMode(Mode.AverageTime)
@Warmup(iterations=3)
@Measurement(iterations=5)
@OutputTimeUnit(TimeUnit.NANOSECONDS)
public class MyBenchmark {
    static int x = 0;
    @Benchmark
    public void a() throws Exception {
        x++;
    }

    // JITï¼ˆå³æ—¶ç¼–è¯‘å™¨ï¼‰å¯¹Javaå­—èŠ‚ç è¿›è¡Œè¿›ä¸€æ­¥ä¼˜åŒ–
    // å‘ç°é”å¯¹è±¡å°±æ˜¯å±€éƒ¨å˜é‡ï¼Œä¸ä¼šé€ƒç¦»ä½œç”¨èŒƒå›´ï¼Œæ‰€ä»¥å»æ‰è¯¥é”ï¼è¿™é‡Œé¢çš„xå˜é‡ä¹Ÿæ˜¯å±€éƒ¨å˜é‡ï¼Œä¸ä¼šå…±äº«ï¼Œæ‰€ä»¥å»æ‰è¯¥é”ï¼
    @Benchmark
    public void b() throws Exception {
        Object o = new Object();
        synchronized (o) {
            x++;
        }
    }
}
```

```bash
java -jar benchmarks.jar

Benchmark Mode Samples Score Score error Units
c.i.MyBenchmark.a avgt 5 1.542 0.056 ns/op
c.i.MyBenchmark.b avgt 5 1.518 0.091 ns/op
```

ç¦ç”¨é”æ¶ˆé™¤ä¼˜åŒ–

```bash
java -XX:-EliminateLocks -jar benchmarks.jar
Benchmark Mode Samples Score Score error Units
c.i.MyBenchmark.a avgt 5 1.507 0.108 ns/op
c.i.MyBenchmark.b avgt 5 16.976 1.572 ns/op
```

## synchronized åŸç†â€”é”ç²—åŒ–

å¯¹ç›¸åŒå¯¹è±¡å¤šæ¬¡åŠ é”ï¼Œå¯¼è‡´çº¿ç¨‹å‘ç”Ÿå¤šæ¬¡é‡å…¥ï¼Œå¯ä»¥ä½¿ç”¨é”ç²—åŒ–æ–¹å¼æ¥ä¼˜åŒ–ï¼Œè¿™ä¸åŒäºä¹‹å‰è®²çš„ç»†åˆ†é”çš„ç²’åº¦ã€‚
