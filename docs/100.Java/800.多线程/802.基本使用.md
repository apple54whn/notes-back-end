---
title: åŸºæœ¬ä½¿ç”¨
date: 2021-02-10 18:24:11
permalink: /pages/59919e/
categories:
  - CoreJava
  - é«˜çº§
tags:
  - 
---

# å¤šçº¿ç¨‹â€”åŸºæœ¬ä½¿ç”¨

## çº¿ç¨‹è°ƒåº¦æ¨¡å‹

- **çº¿ç¨‹è°ƒåº¦æ¨¡å‹**ï¼ˆåº”ç”¨ç¨‹åºçš„æ‰§è¡Œéƒ½æ˜¯**CPU åœ¨å¤šä¸ªçº¿ç¨‹é—´å¿«é€Ÿåˆ‡æ¢**å®Œæˆçš„ï¼‰
    - **åˆ†æ—¶è°ƒåº¦æ¨¡å‹ï¼ˆæ—¶é—´ç‰‡ï¼‰**ï¼šæ‰€æœ‰çº¿ç¨‹è½®æµä½¿ç”¨ CPU çš„ä½¿ç”¨æƒï¼Œå¹³å‡åˆ†é…æ¯ä¸ªçº¿ç¨‹å ç”¨ CPU çš„æ—¶é—´ç‰‡
    - **æŠ¢å å¼è°ƒåº¦æ¨¡å‹**ï¼šä¼˜å…ˆè®©**ä¼˜å…ˆçº§é«˜**çš„çº¿ç¨‹ä½¿ç”¨ CPUï¼Œå¦‚æœçº¿ç¨‹çš„ä¼˜å…ˆçº§ç›¸åŒï¼Œé‚£ä¹ˆä¼šéšæœºé€‰æ‹©ä¸€ä¸ªï¼Œä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹è·å–çš„ CPU æ—¶é—´ç‰‡ç›¸å¯¹å¤šä¸€äº›
- **Java çš„çº¿ç¨‹è°ƒåº¦æ–¹æ³•**
    - **åŒä¼˜å…ˆçº§**çº¿ç¨‹ç»„æˆ**å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—**ï¼ˆå…ˆåˆ°å…ˆæœåŠ¡ï¼‰ï¼Œä½¿ç”¨**æ—¶é—´ç‰‡**ç­–ç•¥
    - å¯¹**é«˜ä¼˜å…ˆçº§**ï¼Œä½¿ç”¨ä¼˜å…ˆè°ƒåº¦çš„**æŠ¢å å¼**ç­–ç•¥



## çº¿ç¨‹è¿è¡ŒåŸç† ğŸ”¥

### Java Virtual Machine

JVM ç”±å †ã€æ–¹æ³•åŒºã€è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆã€ç¨‹åºè®¡æ•°å™¨æ‰€ç»„æˆï¼Œå…¶ä¸­æ ˆå†…å­˜æ˜¯ç»™è°ç”¨çš„å‘¢ï¼Ÿå…¶å®å°±æ˜¯çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯åŠ¨åï¼Œè™šæ‹Ÿæœºå°±ä¼šä¸ºå…¶åˆ†é…ä¸€å—æ ˆå†…å­˜ã€‚

*   **æ¯ä¸ªæ ˆ**ç”±å¤šä¸ª**æ ˆå¸§ï¼ˆFrameï¼‰**ç»„æˆï¼Œå¯¹åº”ç€**æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜**ã€‚
*   **æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§**ï¼Œå¯¹åº”ç€å½“å‰**æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•**ã€‚

ç”»ä¸ªå›¾å°±å¾ˆå¥½ç†è§£äº†ï¼ˆå…·ä½“è¿˜éœ€è¦å­¦ä¹ JVMï¼‰

<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:545px;" src="https://www.processon.com/embed/602623c4e0b34d208a7f6e4b"></iframe>

å¤šä¸ªçº¿ç¨‹ debug æ—¶å¯ä»¥å¯¹è¦æŸ¥çœ‹çš„å¤šä¸ªçº¿ç¨‹éƒ½è®¾ç½® suspendï¼ˆæŒ‚èµ·ï¼‰ä¸º Threadï¼Œæ‰èƒ½è®©çº¿ç¨‹åˆ†åˆ«æŒ‚èµ·ï¼Œåˆ†åˆ«è°ƒè¯•

![image-20210212164420036](../images/image-20210212164420036.png)



### çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢

Thread Context Switch

å› ä¸ºä»¥ä¸‹ä¸€äº›åŸå› å¯¼è‡´ cpu ä¸å†æ‰§è¡Œå½“å‰çš„çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç 

*   çº¿ç¨‹çš„ cpu æ—¶é—´ç‰‡ç”¨å®Œ
*   åƒåœ¾å›æ”¶
*   æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ
*   çº¿ç¨‹è‡ªå·±è°ƒç”¨äº† sleepã€yieldã€waitã€joinã€parkã€synchronizedã€lock ç­‰æ–¹æ³•

å½“ Context Switch å‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿ**ä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€**ï¼Œå¹¶**æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€**ï¼ŒJava ä¸­å¯¹åº”çš„æ¦‚å¿µå°±æ˜¯**ç¨‹åºè®¡æ•°å™¨**ï¼ˆProgram Counter Registerï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯**è®°ä½ä¸‹ä¸€æ¡ jvm æŒ‡ä»¤çš„æ‰§è¡Œåœ°å€**ï¼Œæ˜¯**çº¿ç¨‹ç§æœ‰**çš„

*   çŠ¶æ€åŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰

*   Context Switch é¢‘ç¹å‘ç”Ÿä¼šå½±å“æ€§èƒ½





### Java å¤šçº¿ç¨‹çš„è¿è¡Œè¿‡ç¨‹ ğŸ”¥

**Java ç¨‹åºè¿è¡ŒåŸç†ï¼ˆå¤šçº¿ç¨‹ï¼‰**ï¼šç”± Java å‘½ä»¤å¯åŠ¨ JVMï¼ˆç›¸å½“äºå¯åŠ¨äº†ä¸€ä¸ªè¿›ç¨‹ï¼‰ï¼Œæ¥ç€ç”±è¯¥è¿›ç¨‹åˆ›å»ºå¯åŠ¨å¤šä¸ªçº¿ç¨‹ï¼Œè‡³å°‘ä¸‰ä¸ªçº¿ç¨‹å¯ä»¥åˆ†æå‡ºæ¥ï¼š**æ‰§è¡Œ main()å‡½æ•°çš„ä¸»çº¿ç¨‹**ï¼Œè¯¥çº¿ç¨‹çš„ä»»åŠ¡ä»£ç éƒ½å®šä¹‰åœ¨ main å‡½æ•°ä¸­ï¼Œ**è´Ÿè´£åƒåœ¾å›æ”¶çš„ GC çº¿ç¨‹**ï¼Œä»¥åŠ**å¼‚å¸¸å¤„ç†çº¿ç¨‹**

- å¤šçº¿ç¨‹æ‰§è¡Œæ—¶ï¼Œå…¶å®**æ¯ä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹**éƒ½æœ‰ä¸€ç‰‡è‡ªå·±**æ‰€å±çš„æ ˆå†…å­˜**ç©ºé—´ï¼ˆè¿˜æœ‰ PCï¼‰ã€‚è¿›è¡Œ**æ–¹æ³•çš„å‹æ ˆå’Œå¼¹æ ˆ**ã€‚

![](../images/stack.png)





## çº¿ç¨‹çš„åˆ›å»ºå’Œä½¿ç”¨ ğŸ”¥

### Thread æ„é€ æ–¹æ³• ğŸ”¥

- `Thread()`ï¼šåˆ†é…ä¸€ä¸ªæ–°çš„çº¿ç¨‹å¯¹è±¡ã€‚
- `Thread(String name)`ï¼šåˆ†é…ä¸€ä¸ªæŒ‡å®šåå­—çš„æ–°çš„çº¿ç¨‹å¯¹è±¡
- `Thread(Runnable target)`ï¼šåˆ†é…ä¸€ä¸ªå¸¦æœ‰æŒ‡å®šç›®æ ‡æ–°çš„çº¿ç¨‹å¯¹è±¡ï¼Œå®ƒå®ç°äº† Runnable æ¥å£ä¸­çš„`run`æ–¹æ³•
- `Thread(Runnable target,String name)`ï¼šåˆ†é…ä¸€ä¸ªå¸¦æœ‰æŒ‡å®šç›®æ ‡æ–°çš„çº¿ç¨‹å¯¹è±¡å¹¶**æŒ‡å®šåå­—**



### 1. ç»§æ‰¿ Thread ç±»â€”åŒ¿åå†…éƒ¨ç±»

1.  å®šä¹‰å­ç±»ç»§æ‰¿ Thread ç±»ã€‚å¯ä»¥å†™æ— å‚å’Œå¸¦å‚æ„é€ ä»¥ä¾¿ç›´æ¥å®šä¹‰çº¿ç¨‹åç§°ã€‚
2.  å­ç±»ä¸­ Override é‡å†™ Thread ç±»çš„`run()`æ–¹æ³•ï¼Œå°†çº¿ç¨‹çš„ä»»åŠ¡ä»£ç å°è£…åˆ°`run()`æ–¹æ³•ä¸­ã€‚
3.  åˆ›å»º Thread çš„å­ç±»å¯¹è±¡ï¼Œå³åˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ã€‚
4.  è°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„**`start()`**ï¼ŒJVM å°†è°ƒç”¨è¯¥çº¿ç¨‹çš„**`run()`**æ–¹æ³•æ‰§è¡Œï¼ˆ**å¤šæ¬¡å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹éæ³•ï¼Œå³ä½¿æ‰§è¡Œå®Œæ¯•**ï¼‰

```java
@Slf4j(topic = "Test1")
public class Test1 {

    public static void main(String[] args) {
        Thread t1 = new Thread("t1") {
            @Override
            public void run() {
                log.debug("running");
            }
        };

        t1.start();

        log.debug("running");
    }
}
```



### 2. å®ç° Runnable æ¥å£

1.  å®šä¹‰ç±»å®ç° Runnable æ¥å£
2.  @Override é‡å†™æ¥å£ä¸­çš„`run()`æ–¹æ³•ï¼Œå°†çº¿ç¨‹çš„ä»»åŠ¡ä»£ç å°è£…åˆ°`run()`æ–¹æ³•ä¸­
3.  é€šè¿‡ Thread ç±»åˆ›å»ºçº¿ç¨‹å¯¹è±¡ï¼Œå¹¶å°† Runnable æ¥å£çš„å­ç±»å¯¹è±¡ä½œä¸º Thread ç±»çš„æ„é€ å‡½æ•°çš„å‚æ•°è¿›è¡Œä¼ é€’ã€‚**çº¿ç¨‹çš„ä»»åŠ¡éƒ½å°è£…åœ¨ Runnable æ¥å£å®ç°ç±»å¯¹è±¡çš„ run æ–¹æ³•ä¸­ï¼Œæ‰€ä»¥è¦åœ¨çº¿ç¨‹å¯¹è±¡åˆ›å»ºæ—¶å°±å¿…é¡»æ˜ç¡®è¦è¿è¡Œçš„ä»»åŠ¡**
4.  è°ƒç”¨**`start()`å¼€å¯çº¿ç¨‹**ï¼ŒJVM è°ƒç”¨è¯¥çº¿ç¨‹çš„**`run()`**æ–¹æ³•æ‰§è¡Œï¼ˆ**å¤šæ¬¡å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹éæ³•ï¼Œå³ä½¿æ‰§è¡Œå®Œæ¯•**ï¼‰

```java
@Slf4j(topic = "Test2")
public class Test2 {
    public static void main(String[] args) {
        // æ™®é€šå®ç°
        Runnable r0 = new Runnable() {
            @Override
            public void run() {
                log.debug("running");
            }
        };

        // lambdaè¡¨è¾¾å¼å®ç°
        r1 = () -> log.debug("running");

        Thread t1 = new Thread(r1, "t1");
        t1.start();

        log.debug("running");

    }
}
```



### 3. å®ç° Callable æ¥å£ + Future

ä¸ä½¿ç”¨ Runnable ç›¸æ¯”ï¼Œ Callable åŠŸèƒ½æ›´å¼ºå¤§äº›ï¼ˆJDK5.0 æ–°å¢ï¼‰ï¼š

- ä½¿ç”¨`FutureTask`ç±»å°è£…å®ç°äº† `Callable` æ¥å£çš„å®ç°ç±»ï¼Œå¹¶ä¼ å…¥ `Thread` çš„æ„é€ æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ `start` æ–¹æ³•

- ç›¸æ¯”`run()`æ–¹æ³•ï¼Œå®ç° Callableæ¥å£éœ€è¦å®ç° `call()` æ–¹æ³•ï¼Œå¯ä»¥æœ‰**è¿”å›å€¼**ï¼ˆæ”¯æŒ**æ³›å‹**ï¼‰ï¼Œå¯ä»¥**æŠ›å‡ºå¼‚å¸¸**

    è°ƒç”¨`FutureTask`çš„`get()`**é˜»å¡ç­‰å¾…ä»»åŠ¡ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œè·å–è¿”å›å€¼**

`Future`æ¥å£ï¼š

- å¯ä»¥å¯¹å…·`Runnable`ã€`Callable`ä»»åŠ¡çš„æ‰§è¡Œç»“æœè¿›è¡Œå–æ¶ˆã€æŸ¥è¯¢æ˜¯å¦å®Œæˆã€è·å–ç»“æœç­‰ã€‚
- `FutrueTask`æ˜¯`Futrue`æ¥å£çš„**å”¯ä¸€çš„å®ç°ç±»**
- `FutureTask`**åŒæ—¶å®ç°äº†`Runnable`,`Future`æ¥å£**ã€‚å®ƒæ—¢å¯ä»¥ä½œä¸º`Runnable`è¢«çº¿ç¨‹æ‰§è¡Œï¼Œåˆå¯ä»¥ä½œä¸º`Future`å¾—åˆ°`Callable`çš„è¿”å›å€¼

```java
@Slf4j(topic = "Test3")
public class Test3 {
    public static void main(String[] args) throws ExecutionException, InterruptedException {

        // æ™®é€šå®ç°
        Callable<Integer> c0 = new Callable<Integer>() {
            @Override
            public Integer call() throws Exception {
                log.debug("Callable ...");
                Thread.sleep(2000);
                return 1 + 1;
            }
        };

        // lambdaè¡¨è¾¾å¼å®ç°
        FutureTask<Integer> c1 = new FutureTask<>(() -> {
            log.debug("Callable ...");
            Thread.sleep(2000);
            return 1 + 1;
        });

        Thread t1 = new Thread(c1, "t1");
        t1.start();

        int value = c1.get();
        log.debug("value: {}", value);
    }
}
```



### çº¿ç¨‹æ± 

- èƒŒæ™¯ï¼šç»å¸¸åˆ›å»ºå’Œé”€æ¯ã€ä½¿ç”¨é‡ç‰¹åˆ«å¤§çš„èµ„æºï¼Œæ¯”å¦‚å¹¶å‘æƒ…å†µä¸‹çš„çº¿ç¨‹ï¼Œ å¯¹æ€§èƒ½å½±å“å¾ˆå¤§ã€‚
- **çº¿ç¨‹æ± **ï¼šå…¶å®å°±æ˜¯ä¸€ä¸ª**å®¹çº³å¤šä¸ªçº¿ç¨‹çš„å®¹å™¨**ï¼Œå…¶ä¸­çš„**çº¿ç¨‹å¯ä»¥åå¤ä½¿ç”¨**ï¼Œä½¿ç”¨å®Œ**è‡ªåŠ¨å½’è¿˜**ï¼Œçœå»äº†é¢‘ç¹åˆ›å»ºçº¿ç¨‹å¯¹è±¡çš„æ“ä½œï¼Œ æ— éœ€åå¤åˆ›å»ºçº¿ç¨‹è€Œæ¶ˆè€—è¿‡å¤šèµ„æºã€‚
- å¥½å¤„ï¼š
    - **é™ä½èµ„æºæ¶ˆè€—**ï¼ˆé‡å¤åˆ©ç”¨çº¿ç¨‹æ± ä¸­çº¿ç¨‹ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½åˆ›å»ºï¼‰
    - **æé«˜å“åº”é€Ÿåº¦**ï¼ˆå‡å°‘äº†åˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶é—´ï¼‰
    - **ä¾¿äºçº¿ç¨‹ç®¡ç†**
- **JDK 5.0 èµ·**æä¾›äº†çº¿ç¨‹æ± çš„é¡¶çº§**æ¥å£**æ˜¯ `java.util.concurrent.Executor`ï¼Œä½†æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šè®²å®ƒåªæ˜¯ä¸€ä¸ª**æ‰§è¡Œçº¿ç¨‹çš„å·¥å…·**ã€‚**çœŸæ­£çš„çº¿ç¨‹æ± æ¥å£æ˜¯ `java.util.concurrent.ExecutorService`** ï¼ˆå®˜æ–¹å»ºè®®**ä½¿ç”¨`java.util.concurrent.Executors`çº¿ç¨‹æ± å·¥å‚ç±»**æ¥åˆ›å»ºçº¿ç¨‹æ± å¯¹è±¡ï¼‰ï¼š
    - `void execute(Runnable command)`ï¼šæ‰§è¡Œä»»åŠ¡/å‘½ä»¤ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼Œä¸€èˆ¬ç”¨æ¥æ‰§è¡Œ `Runnable`
    - `<T> Future<T> submit(Callable<T> task)`ï¼šæ‰§è¡Œä»»åŠ¡ï¼Œæœ‰è¿”å›å€¼ï¼Œä¸€èˆ¬åˆæ¥æ‰§è¡Œ `Callable`
    - `void shutdown()`ï¼šå…³é—­çº¿ç¨‹æ± ï¼Œä¸å»ºè®®æ‰§è¡Œ
- å¸¸è§`ExecutorService`çº¿ç¨‹æ± å¯¹è±¡æœ‰ï¼š
    - `ExecutorService static newCachedThreadPool()`ï¼šå¯æ ¹æ®éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹çš„çº¿ç¨‹æ± 
    - `ExecutorService static newFixedThreadPool(int maxThreads)`ï¼šå¯é‡ç”¨å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± 
    - `ExecutorService static newSingleThreadExecutor()`ï¼šåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 
    - `ExecutorService static newScheduledThreadPool(n)`ï¼šå¯å®‰æ’åœ¨ç»™å®šå»¶è¿Ÿåè¿è¡Œå‘½ä»¤æˆ–è€…å®šæœŸåœ°æ‰§è¡Œ
- å‚æ•°ï¼ˆå¸¸è€ƒï¼‰ï¼š
    - corePoolSizeï¼šæ ¸å¿ƒæ± çš„å¤§å°
    - maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°
    - keepAliveTimeï¼šçº¿ç¨‹æ²¡æœ‰ä»»åŠ¡æ—¶æœ€å¤šä¿æŒå¤šé•¿æ—¶é—´åä¼šç»ˆæ­¢
    - setRejectedExecutionHandler
    - setThreadFactory

```java
ExecutorService service = Executors.newFixedThreadPool(10);
ThreadPoolExecutor service1 = (ThreadPoolExecutor) service;
// è®¾ç½®çº¿ç¨‹æ± çš„å±æ€§
// System.out.println(service.getClass());
// service1.setCorePoolSize(15);
// service1.setKeepAliveTime();
service.execute(new NumberThread());//é€‚åˆé€‚ç”¨äºRunnable
service.execute(new NumberThread1());//é€‚åˆé€‚ç”¨äºRunnable
service.submit(Callable callable);//é€‚åˆä½¿ç”¨äºCallable
//å…³é—­è¿æ¥æ± 
service.shutdown();
```





## çº¿ç¨‹ä¼˜å…ˆçº§ ğŸ”¥

- çº¿ç¨‹çš„ä¼˜å…ˆçº§ç­‰çº§ï¼ˆé€šè¿‡ Thread çš„é™æ€å¸¸é‡ï¼‰
    - `Thread.MAX_PRIORITY`ï¼š10
    - `Thread.MIN _PRIORITY`ï¼š1
    - `Thread.NORM_PRIORITY`ï¼š5ï¼Œé»˜è®¤
- æ–¹æ³•
    - `getPriority()`ï¼šè¿”å›çº¿ç¨‹ä¼˜å…ˆçº§
    - `setPriority(int newPriority)`ï¼šæ”¹å˜çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œéœ€åœ¨ start å‰è®¾ç½®
- è¯´æ˜
    - **çº¿ç¨‹åˆ›å»ºæ—¶ç»§æ‰¿çˆ¶çº¿ç¨‹çš„ä¼˜å…ˆçº§**
    - çº¿ç¨‹ä¼˜å…ˆçº§ä»…ä»…ä¼šæç¤ºï¼ˆhintï¼‰è°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥å®ƒã€‚è‹¥**CPUæ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡**ï¼Œä½†**CPUé—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ä½œç”¨**ã€‚**ä½ä¼˜å…ˆçº§åªæ˜¯è·å¾—è°ƒåº¦çš„æ¦‚ç‡ä½**ï¼Œå¹¶éä¸€å®šæ˜¯åœ¨é«˜ä¼˜å…ˆçº§çº¿ç¨‹ä¹‹åæ‰è¢«è°ƒç”¨ã€‚çœ‹ä¸Šé¢ yield çš„ä»£ç æµ‹è¯•ã€‚





## ä¸»çº¿ç¨‹ & å®ˆæŠ¤çº¿ç¨‹ ğŸ”¥

é»˜è®¤æƒ…å†µä¸‹ï¼ŒJava è¿›ç¨‹éœ€è¦ç­‰å¾…æ‰€æœ‰çº¿ç¨‹éƒ½è¿è¡Œç»“æŸï¼Œæ‰ä¼šç»“æŸã€‚æœ‰ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹å«åšå®ˆæŠ¤çº¿ç¨‹ï¼Œåªè¦å…¶å®ƒéå®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸã€‚

å®ˆæŠ¤çº¿ç¨‹ï¼ˆåå°çº¿ç¨‹ï¼‰å’Œç”¨æˆ·çº¿ç¨‹åœ¨å‡ ä¹æ¯ä¸ªæ–¹é¢éƒ½æ˜¯ç›¸åŒçš„ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯**åˆ¤æ–­ JVM ä½•æ—¶ç¦»å¼€**

**å®ˆæŠ¤çº¿ç¨‹æ˜¯ç”¨æ¥æœåŠ¡ç”¨æˆ·çº¿ç¨‹çš„**ï¼Œåœ¨`start()`æ–¹æ³•å‰è°ƒç”¨`th.setDaemon(true)`å¯ä»¥æŠŠä¸€ä¸ªç”¨æˆ·çº¿ç¨‹å˜æˆä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹

**è‹¥ JVM ä¸­éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œå½“å‰ JVM å°†é€€å‡º**

```java
@Slf4j(topic = "TestDaemon")
public class TestDaemon {

    public static void main(String[] args) throws InterruptedException {

        Thread t1 = new Thread(() -> {

            while (true){
                log.debug("{}æ­£åœ¨è¿è¡Œ...", Thread.currentThread().getName());
                if (Thread.currentThread().isInterrupted()){
                    break;
                }
            }
            log.debug("{}è¿è¡Œç»“æŸ...", Thread.currentThread().getName());// daemonç»“æŸä¸ä¼šæ‰§è¡Œè¯¥è¡Œ

        }, "daemon");
        // è®¾ç½®è¯¥çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹
        t1.setDaemon(true);
        t1.start();
        TimeUnit.SECONDS.sleep(1);
        log.debug("{}è¿è¡Œç»“æŸ...", Thread.currentThread().getName());
    }
}
```

**Java åƒåœ¾å›æ”¶çº¿ç¨‹**å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„å®ˆæŠ¤çº¿ç¨‹

**Tomcat ä¸­çš„ Acceptorï¼ˆæ¥æ”¶è¯·æ±‚ï¼‰ å’Œ Pollerï¼ˆåˆ†å‘è¯·æ±‚ï¼‰ çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹**ï¼Œæ‰€ä»¥ Tomcat æ¥æ”¶åˆ° shutdown å‘½ä»¤åï¼Œä¸ä¼šç­‰å¾…å®ƒä»¬å¤„ç†å®Œå½“å‰è¯·æ±‚





## åŸºæœ¬æ–¹æ³•

- `static Thread currentThread()`ï¼šè·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼Œåœ¨ Thread å­ç±»ä¸­å°±æ˜¯ thisï¼Œé€šå¸¸ç”¨äºä¸»çº¿ç¨‹å’Œ Runnable å®ç°ç±»
- `String getName()`ï¼š**è·å–å½“å‰çº¿ç¨‹åç§°**
- `void setName()`ï¼š**è®¾ç½®å½“å‰çº¿ç¨‹åç§°**ï¼Œæˆ–é€šè¿‡çº¿ç¨‹**ç±»çš„æœ‰å‚æ„é€ è®¾ç½®**
- `getId()`ï¼šè·å–çº¿ç¨‹é•¿æ•´å‹çš„ idï¼ˆå”¯ä¸€ï¼‰



## å¸¸ç”¨æ–¹æ³•â€”start & run ğŸ”¥

### start

`void start()`ï¼š**å¯åŠ¨çº¿ç¨‹ï¼ŒJVM æ‰§è¡Œæ­¤çº¿ç¨‹å¯¹è±¡çš„`run()`æ–¹æ³•**

è¯¥æ–¹æ³•åªæ˜¯è®©çº¿ç¨‹è¿›å…¥**å°±ç»ª**çŠ¶æ€ï¼Œé‡Œé¢ä»£ç ä¸ä¸€å®šç«‹åˆ»è¿è¡Œï¼ˆCPU çš„æ—¶é—´ç‰‡è¿˜æ²¡åˆ†ç»™å®ƒï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹å¯¹è±¡çš„`start`æ–¹æ³•åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œå¦‚æœè°ƒç”¨äº†å¤šæ¬¡ä¼šå‡ºç° `IllegalThreadStateException`



### run

`void run()`ï¼š**çº¿ç¨‹åœ¨è¢«è°ƒåº¦æ—¶æ‰§è¡Œåº•å±‚çš„æ“ä½œ**ã€‚ç›´æ¥è°ƒç”¨åˆ™æ²¡æœ‰å¤šçº¿ç¨‹æ•ˆæœï¼Œä»…ä»…æ˜¯mainçº¿ç¨‹ä¸­è°ƒç”¨ä¸‹è¯¥ä»»åŠ¡

å¦‚æœåœ¨æ„é€  Thread å¯¹è±¡æ—¶ä¼ é€’äº† Runnable å‚æ•°ï¼Œåˆ™çº¿ç¨‹å¯åŠ¨åä¼šè°ƒç”¨ Runnable ä¸­çš„ run æ–¹æ³•ï¼Œå¦åˆ™é»˜è®¤ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚ä½†å¯ä»¥åˆ›å»º Thread çš„å­ç±»å¯¹è±¡ï¼Œæ¥è¦†ç›–é»˜è®¤è¡Œä¸º





## å¸¸ç”¨é™æ€æ–¹æ³•â€”sleep & yield ğŸ”¥

### sleep

`static void sleep(long millis)` 

**çº¿ç¨‹ç¡çœ **ã€‚ä½¿**å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹**ä»¥æŒ‡å®šçš„æ¯«ç§’æ•°**ç¡çœ **ï¼Œ**ä¸é‡Šæ”¾é”**

*   è°ƒç”¨ sleep ä¼šè®©å½“å‰çº¿ç¨‹**ä» *Running* è¿›å…¥ *Timed Waiting* çŠ¶æ€**

*   å…¶å®ƒçº¿ç¨‹å¯ä»¥ä½¿ç”¨ interrupt æ–¹æ³•**æ‰“æ–­**æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œè¿™æ—¶ sleep æ–¹æ³•ä¼šæŠ›å‡º InterruptedException

*   ç¡çœ ç»“æŸåçš„çº¿ç¨‹**æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œ**ï¼Œéœ€è¦å¾—åˆ°å¤„ç†å™¨çš„ç­‰èµ„æº

*   **å»ºè®®ç”¨ `TimeUnit` çš„ `sleep` ä»£æ›¿ Thread çš„ sleep æ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§**

```java
@Slf4j(topic = "SleepTest")
public class SleepTest {
    public static void main(String[] args) {
        Thread t1 = new Thread(() -> {
            try {
                // Thread.sleep(2000);
                TimeUnit.SECONDS.sleep(2);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "t1");

        t1.start();
        log.debug("t1 state: {}", t1.getState());// RUNNABLE

        try {
            // å¯èƒ½mainçº¿ç¨‹å¿«æ‰§è¡Œå®Œäº†ï¼Œæ‰æ‰§è¡Œt1ï¼Œæ‰€ä»¥è®©mainçº¿ç¨‹ä¼‘çœ ä¸‹
            TimeUnit.MILLISECONDS.sleep(500);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("t1 state: {}", t1.getState());// TIMED_WAITING
    }
}
```

```java
@Slf4j(topic = "interruptTest")
public class InterruptTest {
    public static void main(String[] args) throws InterruptedException {
        Thread t1 = new Thread(() -> {
            try {
                log.debug("enter sleep...");
                TimeUnit.SECONDS.sleep(2);
                log.debug("what's the fuck!!!");// ä¸ä¼šæ‰§è¡Œï¼ï¼ï¼interrupt ä¸æ˜¯ notify
            } catch (InterruptedException e) {
                log.debug("be interrupt...");
                e.printStackTrace();
            }
        }, "t1");

        t1.start();
        TimeUnit.SECONDS.sleep(1);
        log.debug("interrupt...");
        t1.interrupt();

        // 22:11:31.589 [t1] DEBUG interruptTest - enter sleep...
        // 22:11:32.589 [main] DEBUG interruptTest - interrupt...
        // 22:11:32.589 [t1] DEBUG interruptTest - be interrupt...
    }
}
```



### yield

`static void yield()` **ä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€**

**çº¿ç¨‹è®©æ­¥**ã€‚**æš‚åœ**å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ï¼ˆç³»ç»ŸæŒ‡å®šçš„æ¯«ç§’æ•°ï¼‰ï¼ŒæŠŠæ‰§è¡Œæœºä¼šè®©ç»™ä¼˜å…ˆçº§ç›¸åŒæˆ–æ›´é«˜çš„çº¿ç¨‹ï¼Œå¹¶æ‰§è¡Œå…¶ä»–çº¿ç¨‹ã€‚è‹¥é˜Ÿåˆ—ä¸­æ²¡æœ‰åŒä¼˜å…ˆçº§çš„çº¿ç¨‹ï¼Œå¿½ç•¥æ­¤æ–¹æ³•ã€‚**è½¬ä¸º RUNNABLE çš„å°±ç»ªçŠ¶æ€ï¼ˆä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼‰**ï¼Œè¯¥çº¿ç¨‹ä¸ä¼šå¤±å»ä»»ä½•ç›‘è§†å™¨çš„æ‰€æœ‰æƒï¼ˆ**ä¸é‡Šæ”¾é”**ï¼‰ã€‚**ä¸ç¡®ä¿çœŸæ­£è®©å‡ºï¼Œå…·ä½“å®ç°ä¾èµ–æ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨ï¼Œå¾ˆå°‘ç”¨ï¼Œä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯•å’Œè°ƒè¯•**ã€‚

```java
@Slf4j(topic = "yieldTest")
public class YieldTest {

    public static void main(String[] args) {

        Runnable task1 = () -> {
            int count = 0;
            for (; ; ) {
                System.out.println("=====> task1 " + count++);
            }
        };

        Runnable task2 = () -> {
            int count = 0;
            for (; ; ) {
                // 1 æµ‹è¯• yieldï¼ˆè¿™ä¸ªå¾ˆæ˜æ˜¾ï¼‰
                Thread.yield();
                System.out.println("            =====> task2 " + count++);
            }
        };

        Thread t1 = new Thread(task1, "t1");
        Thread t2 = new Thread(task2, "t2");
        // 2 æµ‹è¯•ä¼˜å…ˆçº§ï¼ˆçœ‹CPUç©ºé—²æ ¸å¿ƒæ•°å§ï¼Œå¯èƒ½éƒ½å¹¶è¡Œæ‰§è¡Œäº†ï¼‰
        // t1.setPriority(Thread.MIN_PRIORITY);
        // t2.setPriority(Thread.MAX_PRIORITY);
        t1.start();
        t2.start();
    }
}
```







## å¸¸ç”¨æ–¹æ³•â€”join åŒæ­¥ ğŸ”¥

### join

`join([long n])`ï¼š**çº¿ç¨‹æ’é˜Ÿ**ã€‚**åº•å±‚å°±æ˜¯ wait**

å½“**æŸä¸ªç¨‹åºæ‰§è¡Œæµä¸­è°ƒç”¨**å…¶ä»–çº¿ç¨‹çš„`join()`æ–¹æ³•æ—¶ï¼Œ**æ‰§è¡Œæµçº¿ç¨‹**å°†è¿›å…¥**WAITING æˆ– TIMED_WAITING**ï¼Œç›´åˆ°`join()`æ–¹æ³•åŠ å…¥çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼ˆæˆ–**æœ€å¤šç­‰å¾…næ¯«ç§’**ï¼‰ï¼Œ**æ‰§è¡Œæµçº¿ç¨‹**æ‰è¿›å…¥**RUNNABLEçŠ¶æ€**ã€‚



### ä¸ºä»€ä¹ˆéœ€è¦ joinï¼Ÿä¸ºäº†åŒæ­¥ï¼

ä¸‹é¢çš„ä»£ç æ‰§è¡Œï¼Œæ‰“å° r æ˜¯ä»€ä¹ˆï¼Ÿ

```java
@Slf4j(topic = "testJoin")
public class TestJoin {
    static int r = 0;

    public static void main(String[] args) {
        test1();
    }

    private static void test1() {
        log.debug("å¼€å§‹");
        Thread t1 = new Thread(() -> {
            try {
                log.debug("å¼€å§‹");
                TimeUnit.SECONDS.sleep(1);
                log.debug("ç»“æŸ");
                r = 10;
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

        }, "t1");
        t1.start();
        log.debug("ç»“æœä¸º:{}", r);
        log.debug("ç»“æŸ");
    }
}
```

åˆ†æ

*   å› ä¸ºä¸»çº¿ç¨‹å’Œçº¿ç¨‹ t1 æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œt1 çº¿ç¨‹éœ€è¦ 1 ç§’ä¹‹åæ‰èƒ½ç®—å‡º r=10

*   è€Œä¸»çº¿ç¨‹ä¸€å¼€å§‹å°±è¦æ‰“å° r çš„ç»“æœï¼Œæ‰€ä»¥åªèƒ½æ‰“å°å‡º r=0

è§£å†³æ–¹æ³•

*   ç”¨ sleep è¡Œä¸è¡Œï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

    ä¸è¡Œï¼Œä¸çŸ¥é“t1çº¿ç¨‹ç©¶ç«Ÿè¦æ‰§è¡Œå¤šä¹…ï¼Œæ‰€ä»¥mainçº¿ç¨‹æ— æ³•æ§åˆ¶sleepçš„æ—¶é—´

*   ç”¨ joinï¼ŒåŠ åœ¨ t1.start() ä¹‹åå³å¯ã€‚ç›®å‰å¯ä»¥ã€‚ä½†æ˜¯å¯ä»¥ä½¿ç”¨æ›´å¥½çš„ Callable è§£å†³

```java
@Slf4j(topic = "testJoin")
public class TestJoin {

    static int r = 0;

    public static void main(String[] args) throws InterruptedException {
        test1();
    }

    private static void test1() throws InterruptedException {
        log.debug("å¼€å§‹");
        Thread t1 = new Thread(() -> {
            try {
                log.debug("å¼€å§‹");
                TimeUnit.SECONDS.sleep(1);
                log.debug("ç»“æŸ");
                r = 10;
            } catch (InterruptedException e) {
                e.printStackTrace();
            }

        }, "t1");
        t1.start();
        t1.join();
        log.debug("ç»“æœä¸º:{}", r);
        log.debug("ç»“æŸ");
    }
}
```



### ç­‰å¾…å¤šä¸ªç»“æœ

é—®ï¼Œä¸‹é¢ä»£ç ï¼ˆä¼ªä»£ç ï¼‰ cost å¤§çº¦å¤šå°‘ç§’ï¼Ÿ

```java
static int r1 = 0;
static int r2 = 0;
public static void main(String[] args) throws InterruptedException {
    test2();
}

private static void test2() throws InterruptedException {
    Thread t1 = new Thread(() -> {
        sleep(1);
        r1 = 10;
    });
    Thread t2 = new Thread(() -> {
        sleep(2);
        r2 = 20;
    });
    long start = System.currentTimeMillis();
    t1.start();
    t2.start();
    t1.join();
    t2.join();
    long end = System.currentTimeMillis();
    log.debug("r1: {} r2: {} cost: {}", r1, r2, end - start);
}
```

åˆ†æå¦‚ä¸‹

*   ç¬¬ä¸€ä¸ª joinï¼šç­‰å¾… t1 æ—¶ï¼Œt2 å¹¶æ²¡æœ‰åœæ­¢ï¼Œæ­£åœ¨è¿è¡Œ

*   ç¬¬äºŒä¸ª joinï¼š1s åï¼Œæ‰§è¡Œåˆ°æ­¤ï¼Œt2 ä¹Ÿè¿è¡Œäº† 1sï¼Œå› æ­¤ä¹Ÿåªéœ€å†ç­‰å¾… 1sã€‚å³æ€»å…± cost 2ç§’

å¦‚æœé¢ å€’ä¸¤ä¸ª join å‘¢ï¼Ÿä¸€æ ·ï¼å› ä¸ºt2 joinå®Œæ¯•åï¼Œt1åœ¨æ­¤2så†…å·²ç»æ‰§è¡Œå®Œäº†





## å¸¸ç”¨æ–¹æ³•â€”interrupt ğŸ”¥

### interruptâ€”ä¸­æ–­çº¿ç¨‹ ğŸ”¥

**è¯·æ±‚ç»ˆæ­¢çº¿ç¨‹**ï¼Œä»…è®¾ç½®äº†ä¸€ä¸ªæ ‡å¿—ä½ï¼Œä¸­æ–­ä¸€ä¸ªä¸åœ¨æ´»åŠ¨çŠ¶æ€ï¼ˆé˜»å¡ï¼‰çš„çº¿ç¨‹**æ²¡æ„ä¹‰å¹¶ä¼šæŠ›å¼‚å¸¸**

*   å¦‚æœ**è¢«æ‰“æ–­çš„çº¿ç¨‹æ­£åœ¨ sleepï¼Œjoinï¼Œwait** ä¼šå¯¼è‡´è¢«æ‰“æ–­çš„çº¿ç¨‹æŠ›å‡º InterruptedExceptionï¼Œå¹¶**æ¸…é™¤æ‰“æ–­æ ‡è®°ï¼ˆç½®ä¸ºfalseï¼‰** 
*   å¦‚æœ**æ‰“æ–­çš„æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹**ï¼Œåˆ™ä¼š**è®¾ç½®æ‰“æ–­æ ‡è®°ï¼ˆç½®ä¸ºtrueï¼‰** ï¼›
*   **park çš„çº¿ç¨‹è¢«æ‰“æ–­**ï¼Œä¹Ÿä¼š**è®¾ç½®æ‰“æ–­æ ‡è®°ï¼ˆç½®ä¸ºtrueï¼‰**



### æ™®é€šæ–¹æ³• isInterruptedâ€”çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ ğŸ”¥

**ä¸ä¼šæ¸…é™¤ä¸­æ–­æ ‡å¿—ä½**



### é™æ€æ–¹æ³• interruptedâ€”çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­

**ä¼šæ¸…é™¤ä¸­æ–­æ ‡å¿—ä½ï¼ï¼ï¼**



### æ‰“æ–­çº¿ç¨‹æ­£åœ¨ sleepï¼Œjoinï¼Œwait çš„çº¿ç¨‹â€”æ²¡æ„ä¹‰

```java
@Slf4j(topic = "testInterrupt1")
public class TestInterrupt1 {
    public static void main(String[] args) throws InterruptedException {
        test1();
    }

    private static void test1() throws InterruptedException {
        Runnable task1 = () -> {
            try {
                log.debug("sleep...");
                TimeUnit.SECONDS.sleep(5);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        };

        Thread t1 = new Thread(task1, "t1");
        t1.start();

        TimeUnit.SECONDS.sleep(1);// 
        log.debug("interrupt...");
        t1.interrupt();
        TimeUnit.MILLISECONDS.sleep(50);// æ‰“å°å‰å¿…é¡»å†ç­‰å¾…ä¸‹ï¼Œå› ä¸ºä¸­æ–­æ ‡è®°æ¸…é™¤æ¯”è¾ƒæ…¢ï¼
        log.debug("ä¸­æ–­æ ‡è®°ï¼š{}", t1.isInterrupted());// false
    }
}
```



### æ‰“æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹â€”æ­£å¸¸

```java
@Slf4j(topic = "testInterrupt1")
public class TestInterrupt1 {
    public static void main(String[] args) throws InterruptedException {
        test2();
    }

    private static void test2() throws InterruptedException {
        Runnable task1 = () -> {
            log.debug("running...");
            // è¿™é‡Œè¦æ˜¯æ”¹ä¸º sleep ï¼Œåˆ™ä¸­æ–­æ ‡è®°å°†è¢«ç½®ä¸º false
            while (true) {
                // å¿…é¡»æ‰‹åŠ¨é€€å‡ºï¼Œå¦åˆ™ä¸€ç›´æ‰§è¡Œã€‚å¯ä»¥ç”¨äºä¼˜é›…åœæ­¢ï¼ 
                boolean flag = Thread.currentThread().isInterrupted();
                if (flag){
                    log.debug("è¢«æ‰“æ–­äº†ï¼Œæˆ‘ä¸»åŠ¨é€€å‡º");
                    break;
                }
            }
        };

        Thread t1 = new Thread(task1, "t1");
        t1.start();

        TimeUnit.SECONDS.sleep(1);// main çº¿ç¨‹ç¡1ç§’ï¼Œé˜²æ­¢t1çº¿ç¨‹è¿˜æœªæ‰§è¡Œ
        log.debug("interrupt...");
        t1.interrupt();
        TimeUnit.MILLISECONDS.sleep(50);// æ‰“å°å‰å¿…é¡»å†ç­‰å¾…ä¸‹ï¼Œå› ä¸ºä¸­æ–­æ ‡è®°æ¸…é™¤æ¯”è¾ƒæ…¢ï¼
        log.debug("ä¸­æ–­æ ‡è®°ï¼š{}", t1.isInterrupted());// true
    }
}
```



### æ‰“æ–­ park çº¿ç¨‹â€”æ­£å¸¸

```java
@Slf4j(topic = "testInterrupt1")
public class TestInterrupt1 {
    public static void main(String[] args) throws InterruptedException {
        test3();
    }

    private static void test3() throws InterruptedException {
        Thread t1 = new Thread(() -> {
            log.debug("park...");
            LockSupport.park();// è¯¥æ–¹æ³•åé¢çš„ä»£ç ä¸ä¼šæ‰§è¡Œï¼Œé™¤éæ‰“æ–­æ ‡è®°ä¸ºtrue
            log.debug("unpark...");
            log.debug("æ‰“æ–­çŠ¶æ€ï¼š{}", Thread.currentThread().isInterrupted());// ä¸æ¸…é™¤ä¸­æ–­æ ‡è®°
            // log.debug("æ‰“æ–­çŠ¶æ€ï¼š{}", Thread.interrupted());// æ¸…é™¤ä¸­æ–­æ ‡è®°ä¸ºfalse
            // å†æ¬¡æ‰§è¡Œæ— æ•ˆï¼ˆåé¢çš„ä»£ç ä¼šç»§ç»­æ‰§è¡Œï¼‰ï¼Œå› ä¸ºæ‰“æ–­æ ‡è®°å·²ç»ä¸ºtrueï¼Œé™¤éä¿®æ”¹æ‰“æ–­æ ‡è®°ä¸ºfalseï¼Œå¦‚ä½¿ç”¨interruptedé™æ€æ–¹æ³•
            LockSupport.park();
            log.debug("unpark...");
        }, "t1");
        t1.start();
        TimeUnit.SECONDS.sleep(3);
        t1.interrupt();
    }
}
```





### è®¾è®¡æ¨¡å¼â€”ä¸¤é˜¶æ®µç»ˆæ­¢ ğŸ”¥

è§è®¾è®¡æ¨¡å¼









## ~~è¿‡æ—¶æ–¹æ³•~~

è¿˜æœ‰ä¸€äº›ä¸æ¨èä½¿ç”¨çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å·²è¿‡æ—¶ï¼Œ**å®¹æ˜“ç ´ååŒæ­¥ä»£ç å—ï¼Œé€ æˆçº¿ç¨‹æ­»é”**

*   `stop()`ï¼šåœæ­¢çº¿ç¨‹è¿è¡Œï¼Œ@Deprecated(since="1.2")
*   `suspend()`ï¼šæŒ‚èµ·ï¼ˆæš‚åœï¼‰çº¿ç¨‹è¿è¡Œã€‚waitã€notifyä»£æ›¿
*   `resume()`ï¼šæ¢å¤çº¿ç¨‹è¿è¡Œã€‚waitã€notifyä»£æ›¿





















## åº”ç”¨â€”ç»Ÿç­¹åˆ†æ ğŸ”¥

è§åº”ç”¨ç« èŠ‚



## OS ä¸­æŸ¥çœ‹çº¿ç¨‹è¿›ç¨‹çš„æ–¹å¼

### Windows

*   ä»»åŠ¡ç®¡ç†å™¨å¯ä»¥æŸ¥çœ‹è¿›ç¨‹å’Œçº¿ç¨‹æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ€æ­»è¿›ç¨‹

*   `tasklist` æŸ¥çœ‹è¿›ç¨‹

    `tasklist | findstr java`

*   `taskkill` æ€æ­»è¿›ç¨‹



### Linux

*   `ps -ef` æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹
*   `ps -fT -p <PID>` æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹
*   `kill` æ€æ­»è¿›ç¨‹
*   `top` æŒ‰å¤§å†™ H åˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºçº¿ç¨‹
*   `top -H -p <PID>` æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹ï¼Ÿ





### Java

*   `jps` å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹

    `jps | grep Test`

*   `jstack <PID>` æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ï¼ˆPIDï¼‰æŸä¸€åˆ»çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€ï¼ˆå¿«ç…§ï¼‰

*   `jconsole` æ¥æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼ˆå›¾å½¢ç•Œé¢ï¼‰

    éœ€è¦ä»¥å¦‚ä¸‹æ–¹å¼è¿è¡Œä½ çš„ java ç±»

    ```bash
    java -Djava.rmi.server.hostname=`ipåœ°å€` -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=`è¿æ¥ç«¯å£` -Dcom.sun.management.jmxremote.ssl=æ˜¯å¦å®‰å…¨è¿æ¥ -Dcom.sun.management.jmxremote.authenticate=æ˜¯å¦è®¤è¯ javaç±»
    ```

    ä¿®æ”¹ /etc/hosts æ–‡ä»¶å°† 127.0.0.1 æ˜ å°„è‡³ä¸»æœºå

    å¦‚æœè¦è®¤è¯è®¿é—®ï¼Œè¿˜éœ€è¦åšå¦‚ä¸‹æ­¥éª¤

    *   å¤åˆ¶ jmxremote.password æ–‡ä»¶
    *   ä¿®æ”¹ jmxremote.password å’Œ jmxremote.access æ–‡ä»¶çš„æƒé™ä¸º 600 å³æ–‡ä»¶æ‰€æœ‰è€…å¯è¯»å†™
    *   è¿æ¥æ—¶å¡«å…¥ controlRoleï¼ˆç”¨æˆ·åï¼‰ï¼ŒR&Dï¼ˆå¯†ç ï¼‰





## JMH åŸºå‡†æµ‹è¯•

*   åŸºå‡†æµ‹è¯•å·¥å…·é€‰æ‹©ï¼Œä½¿ç”¨äº†æ¯”è¾ƒé è°±çš„ JMHï¼Œå®ƒä¼šæ‰§è¡Œç¨‹åºé¢„çƒ­ï¼Œæ‰§è¡Œå¤šæ¬¡æµ‹è¯•å¹¶å¹³å‡
*   cpu æ ¸æ•°é™åˆ¶ï¼Œæœ‰ä¸¤ç§æ€è·¯
    *   ä½¿ç”¨è™šæ‹Ÿæœºï¼Œåˆ†é…åˆé€‚çš„æ ¸
    *   ä½¿ç”¨ msconfifigï¼Œåˆ†é…åˆé€‚çš„æ ¸ï¼Œéœ€è¦é‡å¯æ¯”è¾ƒéº»çƒ¦
*   å¹¶è¡Œè®¡ç®—æ–¹å¼çš„é€‰æ‹©
    *   æœ€åˆæƒ³ç›´æ¥ä½¿ç”¨ parallel streamï¼Œåæ¥å‘ç°å®ƒæœ‰è‡ªå·±çš„é—®é¢˜
    *   æ”¹ä¸ºäº†è‡ªå·±æ‰‹åŠ¨æ§åˆ¶ threadï¼Œå®ç°ç®€å•çš„å¹¶è¡Œè®¡ç®—

ä½¿ç”¨ archetype åˆ›å»º Maven é¡¹ç›®

```
mvn archetype:generate -DinteractiveMode=false -DarchetypeGroupId=org.openjdk.jmh -DarchetypeArtifactId=jmh-java-benchmark-archetype -DgroupId=org.sample -DartifactId=test -Dversion=1.0
```

è¿›å…¥è¯¥ test é¡¹ç›®ï¼Œä¿®æ”¹æµ‹è¯•ä»£ç 

```java
@Fork(1)
@BenchmarkMode(Mode.AverageTime)
@Warmup(iterations=3)
@Measurement(iterations=5)
public class MyBenchmark {

    static int[] ARRAY = new int[1000_000_00];
    static {
        Arrays.fill(ARRAY, 1);
    }


    @Benchmark
    public int c() throws Exception{
        int[] array = ARRAY;
        FutureTask<Integer> t1 = new FutureTask<>(()->{
            int sum = 0;
            for(int i = 0; i < 250_000_00;i++) {
                sum += array[i];
            }
            return sum;
        });
        FutureTask<Integer> t2 = new FutureTask<>(()->{
            int sum = 0;
            for(int i = 0; i < 250_000_00;i++) {
                sum += array[250_000_00+i];
            }
            return sum;
        });
        FutureTask<Integer> t3 = new FutureTask<>(()->{
            int sum = 0;
            for(int i = 0; i < 250_000_00;i++) {
                sum += array[500_000_00+i];
            }
            return sum;
        });
        FutureTask<Integer> t4 = new FutureTask<>(()->{
            int sum = 0;
            for(int i = 0; i < 250_000_00;i++) {
                sum += array[750_000_00+i];
            }
            return sum;
        });
        new Thread(t1).start();
        new Thread(t2).start();
        new Thread(t3).start();
        new Thread(t4).start();
        return t1.get() + t2.get() + t3.get()+ t4.get();
    }


    @Benchmark
    public int d() throws Exception {
        int[] array = ARRAY;
        FutureTask<Integer> t1 = new FutureTask<>(()->{
            int sum = 0;
            for(int i = 0; i < 1000_000_00;i++) {
                sum += array[i];
            }
            return sum;
        });
        new Thread(t1).start();
        return t1.get();
    }
}
```

æ‰“åŒ…ååœ¨ test ç›®å½•ä¸‹æ‰§è¡Œ `java -jar [-Xmx2G] target/benchmarks.jar` æµ‹è¯•ï¼š

*   å¯ä»¥çœ‹åˆ°å¤šæ ¸ä¸‹ï¼Œæ•ˆç‡æå‡è¿˜æ˜¯å¾ˆæ˜æ˜¾çš„
*   å•æ ¸ä¸‹ï¼Œæ€§èƒ½å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œç”šè‡³å¤šçº¿ç¨‹ä»£ç è¿˜æ…¢äº†ä¸€ç‚¹