---
title: å…±äº«æ¨¡å‹â€”ç®¡ç¨‹ï¼ˆæ‚²è§‚é”ï¼Œé˜»å¡ï¼‰
date: 2021-02-16 15:51:34
permalink: /pages/72c98e/
categories:
  - CoreJava
  - é«˜çº§
tags:
  -
---

# å¤šçº¿ç¨‹â€”å…±äº«æ¨¡å‹â€”ç®¡ç¨‹ï¼ˆæ‚²è§‚é”ï¼Œé˜»å¡ï¼‰

## å…±äº«å¸¦æ¥çš„çº¿ç¨‹å®‰å…¨é—®é¢˜

åœ¨ Java ä¸­çš„ä½“ç°

### å–ç¥¨é—®é¢˜

```java
@Slf4j(topic = "TestSafe")
public class TestSafe {
    public static void main(String[] args) throws InterruptedException {

        Runnable task = new Ticket();

        Thread t1 = new Thread(task, "çª—å£1");
        Thread t2 = new Thread(task, "çª—å£2");
        Thread t3 = new Thread(task, "çª—å£3");
        Thread t4 = new Thread(task, "çª—å£4");

        t1.start();
        t2.start();
        t3.start();
        t4.start();
    }
}

@Slf4j(topic = "Ticket")
class Ticket implements Runnable {
    private static int count = 1_000;// çº¿ç¨‹ç«äº‰ä¸æ˜æ˜¾å¯ä»¥å¢å¤§ç¥¨æ•°

    @Override
    public void run() {
        while (true) {
            if (count <= 0) {
                log.debug("{}è¯´: ç¥¨å·²ç»å–å®Œäº†", Thread.currentThread().getName());
                break;
            }
            try {
                // è¿›å…¥time waitingï¼Œæé«˜çº¿ç¨‹åˆ‡æ¢æ¦‚ç‡ï¼Œé”™ç¥¨å‡ ç‡
                TimeUnit.MILLISECONDS.sleep(10);
                log.debug("{}å–äº†ç¬¬{}å¼ ç¥¨", Thread.currentThread().getName(), count--);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}
```

é—®é¢˜ï¼š

*   ç›¸åŒçš„ç¥¨å‡ºç°å¤šæ¬¡ï¼šCPU çš„ä¸€æ¬¡æ“ä½œå¿…é¡»æ˜¯åŸå­æ€§çš„ï¼ˆä½†æ˜¯è¾“å‡ºè¯­å¥ä¸æ˜¯åŸå­çš„ï¼‰
*   å‡ºç°è´Ÿæ•°çš„ç¥¨ï¼šéšæœºæ€§å’Œå»¶è¿Ÿå¯¼è‡´



### è‡ªå¢è‡ªå‡é—®é¢˜

ä¸¤ä¸ªçº¿ç¨‹å¯¹åˆå§‹å€¼ä¸º 0 çš„**é™æ€å˜é‡ï¼ˆå±€éƒ¨å˜é‡å°±ä¸ä¸€æ ·äº†ï¼‰**ä¸€ä¸ªåšè‡ªå¢ï¼Œä¸€ä¸ªåšè‡ªå‡ï¼Œå„åš 5000 æ¬¡ï¼Œç»“æœæ˜¯ 0 å—ï¼Ÿ

```java
@Slf4j(topic = "TestCount")
public class TestCount {

    static int counter = 0;

    public static void main(String[] args) throws InterruptedException {
        test1();
    }
    
    public static void test1() throws InterruptedException {
        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                counter++;
            }
        }, "t1");
        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                counter--;
            }
        }, "t2");
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        log.debug("{}", counter);
    }
}
```



### é—®é¢˜åˆ†æ

ä»¥ä¸Šçš„ç»“æœå¯èƒ½æ˜¯æ­£æ•°ã€è´Ÿæ•°ã€é›¶ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º Java ä¸­å¯¹**é™æ€å˜é‡ï¼ˆå±€éƒ¨å˜é‡å°±ä¸ä¸€æ ·äº†ï¼‰**çš„è‡ªå¢ï¼Œè‡ªå‡å¹¶ä¸æ˜¯åŸå­æ“ä½œï¼Œè¦å½»åº•ç†è§£ï¼Œå¿…é¡»ä»å­—èŠ‚ç æ¥è¿›è¡Œåˆ†æã€‚ä¾‹å¦‚å¯¹äº i++ è€Œè¨€ï¼ˆi ä¸ºé™æ€å˜é‡ï¼‰ï¼Œå®é™…ä¼šäº§ç”Ÿå¦‚ä¸‹çš„ JVM å­—èŠ‚ç æŒ‡ä»¤ï¼š

```
getstatic i // è·å–é™æ€å˜é‡içš„å€¼
iconst_1 // å‡†å¤‡å¸¸é‡1
iadd // è‡ªå¢
putstatic i // å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i
```

è€Œå¯¹åº” i-- ä¹Ÿæ˜¯ç±»ä¼¼ï¼š

```
getstatic i // è·å–é™æ€å˜é‡içš„å€¼
iconst_1 // å‡†å¤‡å¸¸é‡1
isub // è‡ªå‡
putstatic i // å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i
```

è€Œ Java çš„å†…å­˜æ¨¡å‹å¦‚ä¸‹ï¼Œå®Œæˆé™æ€å˜é‡çš„è‡ªå¢ï¼Œè‡ªå‡éœ€è¦**åœ¨ä¸»å­˜å’Œå·¥ä½œå†…å­˜ä¸­è¿›è¡Œæ•°æ®äº¤æ¢**ï¼š

![image-20210216174313171](../images/image-20210216174313171.png)

å¦‚æœæ˜¯å•çº¿ç¨‹ä»¥ä¸Š 8 è¡Œä»£ç æ˜¯é¡ºåºæ‰§è¡Œï¼ˆä¸ä¼šäº¤é”™ï¼‰æ²¡æœ‰é—®é¢˜ï¼š

```mermaid
sequenceDiagram
participant t1 as çº¿ç¨‹1
participant i as static i
i ->> t1 : getstatic i è¯»å– 0
t1 ->> t1 : iconst_1 å‡†å¤‡å¸¸æ•° 1
t1 ->> t1 : iadd åŠ æ³•ï¼Œçº¿ç¨‹å†… i = 1
t1 ->> i : putstatic i å†™å…¥ 1

i ->> t1 : getstatic i è¯»å– 0
t1 ->> t1 : iconst_1 å‡†å¤‡å¸¸æ•° 1
t1 ->> t1 : isub å‡å»ï¼Œçº¿ç¨‹å†… i = -1
t1 ->> i : putstatic i å†™å…¥ 1
```

ä½†å¤šçº¿ç¨‹ä¸‹è¿™ 8 è¡Œä»£ç å¯èƒ½**äº¤é”™è¿è¡Œ**

ä¼šå‡ºç°è´Ÿæ•°çš„æƒ…å†µï¼š

```mermaid
sequenceDiagram
participant t1 as çº¿ç¨‹1
participant t2 as çº¿ç¨‹2
participant i as static i
	i ->> t1 : getstatic i è¯»å– 0
	t2 ->> t2 : iconst_1 å‡†å¤‡å¸¸æ•° 1
	t2 ->> t2 : isub å‡å»ï¼Œçº¿ç¨‹å†… i = -1
	t2 -->> t1 : ä¸Šä¸‹æ–‡åˆ‡æ¢
	
	i ->> t1 : getstatic i è¯»å– 0
	t1 ->> t1 : iconst_1 å‡†å¤‡å¸¸æ•° 1
	t1 ->> t1 : iadd åŠ æ³•ï¼Œçº¿ç¨‹å†… i = 1
	t1 ->> i : putstatic i å†™å…¥ 1
	
	t1 -->> t2 : ä¸Šä¸‹æ–‡åˆ‡æ¢
	t2 ->> i : putstatic i å†™å…¥ -1
```

å‡ºç°æ­£æ•°çš„æƒ…å†µï¼š

```mermaid
sequenceDiagram
participant t1 as çº¿ç¨‹1
participant t2 as çº¿ç¨‹2
participant i as static i
	i ->> t1 : getstatic i è¯»å– 0
	t1 ->> t1 : iconst_1 å‡†å¤‡å¸¸æ•° 1
	t1 ->> t1 : iadd åŠ æ³•ï¼Œçº¿ç¨‹å†… i = 1
	t1 -->> t2 : ä¸Šä¸‹æ–‡åˆ‡æ¢
	
	i ->> t2 : getstatic i è¯»å– 0
	t2 ->> t2 : iconst_1 å‡†å¤‡å¸¸æ•° 1
	t2 ->> t2 : isub å‡æ³•ï¼Œçº¿ç¨‹å†… i = -1
	t2 ->> i : putstatic i å†™å…¥ -1
	
	t2 -->> t1 : ä¸Šä¸‹æ–‡åˆ‡æ¢
	t1 ->> i : putstatic i å†™å…¥ 1
```





### çº¿ç¨‹å®‰å…¨é—®é¢˜æ€»ç»“ ğŸ”¥

åˆ†æ—¶ç³»ç»Ÿï¼Œçº¿ç¨‹åˆ‡æ¢æ—¶ï¼Œå¯¹ä¸´ç•ŒåŒºæ•°æ®è¯»å†™çš„éåŸå­æ€§ï¼Œä»¥åŠç¼“å­˜å¯¼è‡´æœ€ç»ˆå¯èƒ½å‘ç”Ÿ**çº¿ç¨‹å®‰å…¨é—®é¢˜**ã€‚å‡ºç°è¯¥é—®é¢˜çš„åŸå› ï¼š

*   **å¤šä¸ªçº¿ç¨‹åœ¨æ“ä½œå…±äº«èµ„æº**

*   **æ“ä½œå…±äº«èµ„æºçš„ä»£ç æœ‰å¤šæ¡ï¼ˆå¯èƒ½æ˜¯éåŸå­æ“ä½œï¼‰**

    å³å½“ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œæ“ä½œå…±äº«èµ„æºçš„å¤šæ¡ä»£ç ï¼ˆå¯èƒ½æ˜¯éåŸå­æ“ä½œï¼‰è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–çº¿ç¨‹å‚ä¸äº†è¿ç®—ï¼Œå°±ä¼šå¯¼è‡´

    OSçš„åˆ†æ—¶æ“ä½œï¼Œçº¿ç¨‹åˆ‡æ¢ï¼Œç¼“å­˜



### ä¸´ç•ŒåŒº Critical Section

*   ä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æœ¬èº«æ˜¯æ²¡æœ‰é—®é¢˜çš„

*   é—®é¢˜å‡ºåœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®**å…±äº«èµ„æº**

    *   å¤šä¸ªçº¿ç¨‹è¯»**å…±äº«èµ„æº**å…¶å®ä¹Ÿæ²¡æœ‰é—®é¢˜

    *   åœ¨å¤šä¸ªçº¿ç¨‹å¯¹**å…±äº«èµ„æº**è¯»å†™æ“ä½œæ—¶å‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜

ä¸´ç•ŒåŒº(critical section)æ˜¯æŒ‡è®¿é—®æŸä¸€å…±äº«èµ„æºçš„**ä»£ç ç‰‡æ®µ**ï¼Œå¹¶ä¸”è¿™æ®µä»£ç çš„æ‰§è¡Œ**åº”ä¸ºåŸå­(atomic) æ“ä½œ**ï¼Œ**å³ä¸´ç•ŒåŒºå†…çš„ä»£ç å¿…é¡»å¯¹å¤–æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œä¸ä¼šè¢«çº¿ç¨‹åˆ‡æ¢æ‰€æ‰“æ–­**

ä¾‹å¦‚ï¼Œä¸‹é¢ä»£ç ä¸­çš„ä¸´ç•ŒåŒºï¼ˆå¿…é¡»æœ‰synchronizedï¼Œå¦åˆ™æ— æ³•ä¿è¯ä¸´ç•ŒåŒºä»£ç çš„åŸå­æ“ä½œï¼‰

```java
static int counter = 0;
synchronized static void increment() { 
    // ä¸´ç•ŒåŒº
    counter++; 
}
synchronized static void decrement() { 
    // ä¸´ç•ŒåŒº
    counter--; 
}
```





### ç«æ€æ¡ä»¶ Race Condition

ç«äº‰æ¡ä»¶æ˜¯æŒ‡å¤šä¸ªä»»åŠ¡ä»¥**éäº’æ–¥**çš„æ–¹å¼åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¤§å®¶å¯¹å…¬å…±èµ„æºçš„è®¿é—®æ˜¯ä»¥ç«äº‰çš„æ–¹å¼å¹¶è¡Œè¿›è¡Œçš„ï¼Œå› æ­¤å…¬å…±èµ„æºçš„æœ€ç»ˆçŠ¶æ€ä¾èµ–äºè¿™äº›ä»»åŠ¡çš„ä¸´ç•ŒåŒºä¸­çš„å¾®æ“ä½œ**æ‰§è¡Œæ¬¡åº**ã€‚

å¤šä¸ªçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºå†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„**æ‰§è¡Œåºåˆ—ä¸åŒ**è€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œç§°ä¹‹ä¸ºå‘ç”Ÿäº†**ç«æ€æ¡ä»¶**







### è§£å†³æ–¹æ¡ˆæ€»è§ˆ ğŸ”¥

ä¸ºäº†**é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿ**ï¼Œæœ‰å¤šç§æ‰‹æ®µå¯ä»¥è¾¾åˆ°ç›®çš„ã€‚

*   **é˜»å¡å¼**çš„è§£å†³æ–¹æ¡ˆï¼š
    *   åŒæ­¥é”æœºåˆ¶ï¼š**synchronized**ï¼ˆåŒæ­¥ä»£ç å—ã€åŒæ­¥æ–¹æ³•ï¼‰
    *   Locké”æœºåˆ¶ï¼š**Lock**ï¼ˆJUCä¸­ä»‹ç»ï¼‰

*   **éé˜»å¡å¼**çš„è§£å†³æ–¹æ¡ˆ
    *   **åŸå­å˜é‡**ï¼ˆAutomicï¼‰







## synchronized å…³é”®å­— ğŸ”¥

### ä»‹ç»

`synchronized`å…³é”®å­—å¯ä»¥ç”¨äº**æ–¹æ³•ä¸­çš„æŸä¸ªåŒºå—ä¸­**ï¼Œè¡¨ç¤ºåªå¯¹è¿™ä¸ªåŒºå—çš„**èµ„æºå®è¡Œäº’æ–¥è®¿é—®**ã€‚è®©åŒä¸€æ—¶åˆ»è‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰ã€åŒæ­¥é”/å¯¹è±¡é”/å¯¹è±¡ç›‘è§†å™¨ã€‘ï¼Œå…¶å®ƒçº¿ç¨‹å†æƒ³è·å–è¿™ä¸ªã€åŒæ­¥é”/å¯¹è±¡é”/å¯¹è±¡ç›‘è§†å™¨ã€‘æ—¶å°±ä¼š**é˜»å¡**ä½ã€‚è¿™æ ·å°±èƒ½ä¿è¯æ‹¥æœ‰é”çš„çº¿ç¨‹å¯ä»¥å®‰å…¨çš„æ‰§è¡Œä¸´ç•ŒåŒºå†…çš„ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢

**æ³¨æ„**ï¼Œè™½ç„¶ java ä¸­äº’æ–¥å’ŒåŒæ­¥éƒ½å¯ä»¥é‡‡ç”¨ synchronized å…³é”®å­—æ¥å®Œæˆï¼Œä½†å®ƒä»¬è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼š

*   **äº’æ–¥**æ˜¯ä¿è¯ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸´ç•ŒåŒºä»£ç 

*   **åŒæ­¥**æ˜¯ç”±äºçº¿ç¨‹æ‰§è¡Œçš„å…ˆåã€é¡ºåºä¸åŒã€éœ€è¦ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶å®ƒçº¿ç¨‹è¿è¡Œåˆ°æŸä¸ªç‚¹

**synchronized çš„ä¼˜ç¼ºç‚¹ï¼š**

- **å¥½å¤„**ï¼šè§£å†³çº¿ç¨‹çš„å®‰å…¨é—®é¢˜ï¼ˆäº’æ–¥ï¼‰
- **å¼Šç«¯**ï¼šç›¸å¯¹**é™ä½æ•ˆç‡**ï¼ˆåŒæ­¥ï¼‰ï¼Œå› ä¸ºåŒæ­¥å¤–çš„çº¿ç¨‹éƒ½ä¼šåˆ¤æ–­åŒæ­¥é”ï¼›è‹¥æœ‰**åŒæ­¥åµŒå¥—å®¹æ˜“äº§ç”Ÿæ­»é”**

**åŒæ­¥é”/å¯¹è±¡é”/å¯¹è±¡ç›‘è§†å™¨**

- é”å¯¹è±¡å¯ä»¥æ˜¯**ä»»æ„ç±»å‹**
- å¤šä¸ªçº¿ç¨‹å¯¹è±¡è¦ä½¿ç”¨**åŒä¸€æŠŠé”**



### è¯­æ³•1â€”åŒæ­¥ä»£ç å—

é”çš„ç›®æ ‡æ˜¯å¯¹è±¡ï¼

```java
synchronized(å¯¹è±¡){// çº¿ç¨‹1è¿›å…¥åï¼Œçº¿ç¨‹2åˆ°è¿™é‡Œå°±è¢« blocked
    // ä¸´ç•ŒåŒº
}
```





### å–ç¥¨é—®é¢˜è§£å†³

```java
@Slf4j(topic = "SafeTicket")
class SafeTicket implements Runnable {
    private static int count = 1_000;// çº¿ç¨‹ç«äº‰ä¸æ˜æ˜¾å¯ä»¥å¢å¤§ç¥¨æ•°

    // final Object lock = new Object();

    @Override
    public void run() {
        // å–ç¥¨çª—å£ä¸€ç›´å¼€ç€ï¼Œä¸èƒ½åœ¨åŒæ­¥ä¸­ï¼Œå¦åˆ™å°±ä¼šè¢«ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œ
        while (true) {
            // synchronized éœ€åœ¨å†…éƒ¨å†™ï¼Œå¦åˆ™å…¶ä»–çº¿ç¨‹ä¼šè¿›ä¸å»ã€‚ç±»ä¼¼è¿›å…¥å•æ‰€ç„¶åé”é—¨ã€‚éœ€è¦åŒ…è£¹æ“ä½œå…±äº«èµ„æºçš„ä»£ç ã€‚
            // è¿˜å¯ä»¥å†™ thisï¼ˆæ³¨æ„å”¯ä¸€æ€§ï¼‰ã€SafeTicket.classã€ä¸Šé¢çš„å¯¹è±¡ lock
            synchronized (this) {
                if (count <= 0) {
                    log.debug("{}è¯´: ç¥¨å·²ç»å–å®Œäº†", Thread.currentThread().getName());
                    break;
                }
                try {
                    // è¿›å…¥time waitingï¼Œæé«˜çº¿ç¨‹åˆ‡æ¢æ¦‚ç‡ï¼Œé”™ç¥¨å‡ ç‡
                    TimeUnit.MILLISECONDS.sleep(10);
                    log.debug("{}å–äº†ç¬¬{}å¼ ç¥¨", Thread.currentThread().getName(), count--);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }
}

@Slf4j(topic = "TestSafe")
public class TestSafe {
    public static void main(String[] args) throws InterruptedException {

        Runnable task = new Ticket();

        Thread t1 = new Thread(task, "çª—å£1");
        Thread t2 = new Thread(task, "çª—å£2");
        Thread t3 = new Thread(task, "çª—å£3");
        Thread t4 = new Thread(task, "çª—å£4");

        t1.start();
        t2.start();
        t3.start();
        t4.start();
    }
}
```



### è‡ªå¢è‡ªå‡é—®é¢˜è§£å†³

```java
@Slf4j(topic = "TestCount")
public class TestCount {

    static int counter = 0;

    static final Object room = new Object();

    public static void main(String[] args) throws InterruptedException {
        // test1();
        test2();
    }

    /**
     * åŒæ­¥ä»£ç å—
     */
    public static void test2() throws InterruptedException {
        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                synchronized (room) {
                    counter++;
                }
            }
        }, "t1");
        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                synchronized (room) {
                    counter--;
                }
            }
        }, "t2");
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        log.debug("{}", counter);
    }
}
```



### åŸç† ğŸ”¥

ç±»æ¯”ï¼š

*   synchronized(å¯¹è±¡) ä¸­çš„å¯¹è±¡ï¼Œå¯ä»¥æƒ³è±¡ä¸ºä¸€ä¸ªæˆ¿é—´ï¼ˆroomï¼‰ï¼Œæœ‰å”¯ä¸€å…¥å£ï¼ˆé—¨ï¼‰æˆ¿é—´åªèƒ½ä¸€æ¬¡è¿›å…¥ä¸€äººè¿›è¡Œè®¡ç®—ï¼Œçº¿ç¨‹ t1ï¼Œt2 æƒ³è±¡æˆä¸¤ä¸ªäºº

*   å½“çº¿ç¨‹ t1 æ‰§è¡Œåˆ° synchronized(room) æ—¶å°±å¥½æ¯” t1 è¿›å…¥äº†è¿™ä¸ªæˆ¿é—´ï¼Œå¹¶é”ä½äº†é—¨æ‹¿èµ°äº†é’¥åŒ™ï¼Œåœ¨é—¨å†…æ‰§è¡Œcount++ ä»£ç 

*   è¿™æ—¶å€™å¦‚æœ t2 ä¹Ÿè¿è¡Œåˆ°äº† synchronized(room) æ—¶ï¼Œå®ƒå‘ç°é—¨è¢«é”ä½äº†ï¼Œåªèƒ½åœ¨é—¨å¤–ç­‰å¾…ï¼Œå‘ç”Ÿäº†ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œé˜»å¡ä½äº†

*   è¿™ä¸­é—´**å³ä½¿ t1 çš„ cpu æ—¶é—´ç‰‡ä¸å¹¸ç”¨å®Œï¼Œè¢«è¸¢å‡ºäº†é—¨å¤–**ï¼ˆä¸è¦é”™è¯¯ç†è§£ä¸ºé”ä½äº†å¯¹è±¡å°±èƒ½ä¸€ç›´æ‰§è¡Œä¸‹å»å“¦ï¼‰ï¼Œè¿™æ—¶**é—¨è¿˜æ˜¯é”ä½çš„ï¼Œt1 ä»æ‹¿ç€é’¥åŒ™ï¼Œt2 çº¿ç¨‹è¿˜åœ¨é˜»å¡çŠ¶æ€è¿›ä¸æ¥**ï¼Œåªæœ‰**ä¸‹æ¬¡è½®åˆ° t1 è‡ªå·±å†æ¬¡è·å¾—æ—¶é—´ç‰‡æ—¶æ‰èƒ½å¼€é—¨è¿›å…¥**
*   **å½“ t1 æ‰§è¡Œå®Œ synchronized{} å—å†…çš„ä»£ç ï¼Œè¿™æ—¶å€™æ‰ä¼šä» obj æˆ¿é—´å‡ºæ¥å¹¶è§£å¼€é—¨ä¸Šçš„é”ï¼Œå”¤é†’ t2 çº¿ç¨‹æŠŠé’¥åŒ™ç»™ä»–**ã€‚t2 çº¿ç¨‹è¿™æ—¶æ‰å¯ä»¥è¿›å…¥ obj æˆ¿é—´ï¼Œé”ä½äº†é—¨æ‹¿ä¸Šé’¥åŒ™ï¼Œæ‰§è¡Œå®ƒçš„ count-- ä»£ç 

ç”¨å›¾è¡¨ç¤ºï¼š

```mermaid
sequenceDiagram
participant t1 as çº¿ç¨‹1
participant t2 as çº¿ç¨‹2
participant i as static i
participant lock as é”å¯¹è±¡
	t2 ->> lock : å°è¯•è·å–é”
	note over t2,lock: æ‹¥æœ‰é”
	i ->> t1 : getstatic i è¯»å– 0
	t2 ->> t2 : iconst_1 å‡†å¤‡å¸¸æ•° 1
	t2 ->> t2 : isub å‡å»ï¼Œçº¿ç¨‹å†… i = -1
	t2 -->> t1 : ä¸Šä¸‹æ–‡åˆ‡æ¢
	
	t1 -x lock : å°è¯•è·å–é”ï¼Œè¢«é˜»å¡ï¼ˆBLOCKEDï¼‰
	
	t1 -->> t2 : ä¸Šä¸‹æ–‡åˆ‡æ¢
	t2 ->> i : putstatic i å†™å…¥ -1
	note over t2,lock: æ‹¥æœ‰é”
	t2 ->> lock : é‡Šæ”¾é”ï¼Œå¹¶å”¤é†’é˜»å¡çš„çº¿ç¨‹
	
	note over t1,lock: æ‹¥æœ‰é”
	i ->> t1 : getstatic i è¯»å– 0
	t1 ->> t1 : iconst_1 å‡†å¤‡å¸¸æ•° 1
	t1 ->> t1 : iadd åŠ æ³•ï¼Œçº¿ç¨‹å†… i = 1
	t1 ->> i : putstatic i å†™å…¥ 1
	note over t1,lock: æ‹¥æœ‰é”
	t1 ->> lock : é‡Šæ”¾é”ï¼Œå¹¶å”¤é†’é˜»å¡çš„çº¿ç¨‹
```



### æ€è€ƒ

synchronized å®é™…æ˜¯ç”¨**å¯¹è±¡é”**ä¿è¯äº†**ä¸´ç•ŒåŒºå†…ä»£ç çš„åŸå­æ€§ï¼ˆä¸´ç•ŒåŒºå†…çš„ä»£ç å¿…é¡»å¯¹å¤–æ˜¯ä¸å¯åˆ†å‰²çš„ï¼Œä¸ä¼šè¢«çº¿ç¨‹åˆ‡æ¢æ‰€æ‰“æ–­ï¼‰**ã€‚ä¸ºäº†åŠ æ·±ç†è§£ï¼Œè¯·æ€è€ƒä¸‹é¢çš„é—®é¢˜ï¼ˆè‡ªå¢è‡ªå‡é—®é¢˜ï¼‰ï¼š

*   å¦‚æœæŠŠ synchronized(obj) æ”¾åœ¨ for å¾ªç¯çš„å¤–é¢ï¼Œå¦‚ä½•ç†è§£ï¼Ÿ-- å¯¹forå¾ªç¯æ•´ä½“ä¿è¯åŸå­æ€§

*   å¦‚æœ t1 synchronized(obj1) è€Œ t2 synchronized(obj2) ä¼šæ€æ ·è¿ä½œï¼Ÿ-- é”å¯¹è±¡ä¸åŒï¼Œæ— æ³•ä¿è¯åŒæ­¥äº’æ–¥

*   å¦‚æœ t1 synchronized(obj) è€Œ t2 æ²¡æœ‰åŠ ä¼šæ€ä¹ˆæ ·ï¼Ÿå¦‚ä½•ç†è§£ï¼Ÿ-- é”å¯¹è±¡ä¸åŒï¼Œä¸€ä¸ªæœ‰ä¸€ä¸ªæ²¡æœ‰ï¼Œåˆ™ä¼šå‘ç”Ÿçº¿ç¨‹å®‰å…¨é—®é¢˜

    åŠ æ³•ä¸åŠ é”åˆ™æ˜¯æ­£æ•°å‡ ç‡å¤§ï¼Œå‡æ³•ä¸åŠ é”åˆ™æ˜¯è´Ÿæ•°å‡ ç‡å¤§ï¼Œä¸ºå•¥äº†ã€‚ã€‚





### è‡ªå¢è‡ªå‡é¢å‘å¯¹è±¡æ”¹è¿›

```java
@Slf4j(topic = "TestCount2")
public class TestCount2 {

    public static void main(String[] args) throws InterruptedException {
        Room room = new Room();

        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                room.increment();
            }
        }, "t1");
        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                room.decrement();
            }
        }, "t2");
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        log.debug("{}", room.getCount());
    }
}

class Room {
    private int count = 0;

    public void increment(){
        synchronized (this){
            count++;
        }
    }

    public void decrement(){
        synchronized (this){
            count--;
        }
    }

    public int getCount(){
        synchronized (this){
            return count;
        }
    }
}
```





### è¯­æ³•2â€”åŒæ­¥æ–¹æ³• & é”å¯¹è±¡ ğŸ”¥

**æ­¤æ—¶åŒæ­¥é”æ˜¯è°ï¼Ÿé”çš„ç›®æ ‡è¿˜æ˜¯å¯¹è±¡**ï¼Œä¸æ˜¯é”æ–¹æ³•ï¼

- å¯¹äº**é static æ–¹æ³•**ï¼ŒåŒæ­¥é”å°±æ˜¯**this**ï¼Œæ­¤æ—¶ä»£è¡¨è°ƒç”¨ run æ–¹æ³•çš„å¯¹è±¡

- å¯¹äº**static æ–¹æ³•**ï¼ŒåŒæ­¥é”å½“å‰æ–¹æ³•æ‰€åœ¨ç±»çš„å­—èŠ‚ç å¯¹è±¡(**ç±»å.class**)ï¼Œ**ä¸æ–¹æ³•è°ƒç”¨è€…æ— å…³**ï¼ï¼ï¼

    ä½¿ç”¨ç»§æ‰¿ Thread ç±»å’ŒåŒæ­¥æ–¹æ³•å®ç°æ—¶ï¼Œéœ€è¦å†™ `static synchronized`

```java
class Test {
    public synchronized void test(){
        // ä¸´ç•ŒåŒº
    }
}

// ç­‰ä»·äºï¼ˆè‡ªåŠ¨è½¬æ¢ï¼‰
class Test {
    public void test(){
        synchronized(this){
            // ä¸´ç•ŒåŒº
        }
    }
}
```

```java
class Test {
    public synchronized static void test(){
        // ä¸´ç•ŒåŒº
    }
}

// ç­‰ä»·äºï¼ˆè‡ªåŠ¨è½¬æ¢ï¼‰
class Test {
    public void test(){
        synchronized(Test.class){
            // ä¸´ç•ŒåŒº
        }
    }
}
```

æ”¹è¿›ä»£ç å¦‚ä¸‹ï¼š

```java
@Slf4j(topic = "TestCount2")
public class TestCount2 {

    public static void main(String[] args) throws InterruptedException {
        Room room = new Room();

        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                room.increment();
            }
        }, "t1");
        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 5_000; i++) {
                room.decrement();
            }
        }, "t2");
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        log.debug("{}", room.getCount());
    }
}

class Room {
    private int count = 0;

    public synchronized void increment() {
        count++;
    }

    public synchronized void decrement() {
        count--;
    }

    public synchronized int getCount() {
        return count;
    }
}
```





## "çº¿ç¨‹å…«é”" ğŸ”¥

è€ƒå¯Ÿ synchronized é”ä½çš„æ˜¯å“ªä¸ªå¯¹è±¡

#### æƒ…å†µ1

ç»“æœï¼š12 æˆ– 21

é”æ˜¯ this å¯¹è±¡ï¼ˆåº•å±‚æŸ¥çœ‹ n1 å¯¹è±¡å¤´éƒ¨ä¿¡æ¯ï¼‰

```java
public class Test1 {

    public static void main(String[] args) {
        Number n1 = new Number();
        new Thread(n1::a).start();
        new Thread(n1::b).start();
    }
}

@Slf4j(topic = "Number")
class Number{
    public synchronized void a() {
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
}
```



#### æƒ…å†µ2

ç»“æœï¼š1så12ï¼Œæˆ– 2 1så 1

```java
public class Test1 {

    public static void main(String[] args) {
        Number n1 = new Number();
        new Thread(n1::a).start();
        new Thread(n1::b).start();
    }
}

@Slf4j(topic = "Number")
class Number{
    public synchronized void a() {
        try {
            TimeUnit.SECONDS.sleep(1);// sleep ä¸ä¼šé‡Šæ”¾é”ï¼Œä¼šé‡Šæ”¾å¤„ç†æœº
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
}
```



#### æƒ…å†µ3

ç»“æœï¼š3 1s 12 æˆ– 23 1s 1 æˆ– 32 1s 1

*   è‹¥aå…ˆè·å¾—é”ï¼Œåˆ™3å…ˆæ‰“å°ï¼Œ1så1æ‰“å°ï¼Œ2æ‰“å°
*   è‹¥bå…ˆè·å¾—é”ï¼Œåˆ™2æˆ–3å…ˆæ‰“å°ï¼Œ1så1æ‰“å°

```java
public class Test3 {

    public static void main(String[] args) {
        Number3 n1 = new Number3();
        new Thread(n1::a).start();
        new Thread(n1::b).start();
        new Thread(n1::c).start();
    }
}

@Slf4j(topic = "Number")
class Number3{
    public synchronized void a() {
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }

    public void c() {
        log.debug("3");
    }
}
```



#### æƒ…å†µ4

ç»“æœï¼š2 1s å 1

*   é¦–å…ˆé”å¯¹è±¡éƒ½ä¸æ˜¯åŒä¸€ä¸ªäº†ï¼æ‰€ä»¥ä¿©çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œ
*   aéœ€è¦ç­‰1sï¼Œæ‰€ä»¥æ˜¯å…ˆæ‰“å°2ï¼Œ1såæ‰“å°1

```java
public class Test4 {

    public static void main(String[] args) {
        Number4 n1 = new Number4();
        Number4 n2 = new Number4();
        new Thread(n1::a).start();
        new Thread(n2::b).start();
    }
}

@Slf4j(topic = "Number")
class Number4{
    public synchronized void a() {
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
}
```



#### æƒ…å†µ5

ç»“æœï¼š2 1s å 1

*   é¦–å…ˆé”å¯¹è±¡éƒ½ä¸æ˜¯åŒä¸€ä¸ªäº†ï¼**static æ–¹æ³•ä¸æ˜¯çœ‹è°ƒç”¨è€…ï¼Œæ˜¯çœ‹è§„åˆ™**ï¼

    açš„é”æ˜¯Number4.classå¯¹è±¡ï¼Œbçš„é”æ˜¯thiså¯¹è±¡ï¼Œæ‰€ä»¥ä¿©çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œ

*   aéœ€è¦ç­‰1sï¼Œæ‰€ä»¥æ˜¯å…ˆæ‰“å°2ï¼Œ1såæ‰“å°1

```java
public class Test5 {

    public static void main(String[] args) {
        Number5 n1 = new Number5();
        new Thread(() -> n1.a()).start();
        new Thread(() -> n1.b()).start();
    }
}

@Slf4j(topic = "Number")
class Number5{
    public static synchronized void a() {
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
}
```



#### æƒ…å†µ6

ç»“æœï¼š1så12ï¼Œæˆ– 2 1så 1

*   é”å¯¹è±¡éƒ½æ˜¯ Number6.class ï¼Œæ‰€ä»¥åŒæ­¥äº’æ–¥è¿è¡Œ

```java
public class Test6 {

    public static void main(String[] args) {
        new Thread(Number6::a).start();
        new Thread(Number6::b).start();
    }
}

@Slf4j(topic = "Number")
class Number6{
    public static synchronized void a() {
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("1");
    }
    public static synchronized void b() {
        log.debug("2");
    }
}
```



#### æƒ…å†µ7

*   ç»“æœï¼š2 1s å 1
    *   é¦–å…ˆé”å¯¹è±¡éƒ½ä¸æ˜¯åŒä¸€ä¸ªäº†ï¼Œæ‰€ä»¥ä¿©çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œ
    *   aéœ€è¦ç­‰1sï¼Œæ‰€ä»¥æ˜¯å…ˆæ‰“å°2ï¼Œ1såæ‰“å°1

```java
public class Test7 {

    public static void main(String[] args) {
        Number7 n1 = new Number7();
        Number7 n2 = new Number7();
        new Thread(() -> n1.a()).start();
        new Thread(() -> n2.b()).start();
    }
}

@Slf4j(topic = "Number")
class Number7{
    public static synchronized void a() {
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("1");
    }
    public synchronized void b() {
        log.debug("2");
    }
}
```



#### æƒ…å†µ8

ç»“æœï¼š1så12ï¼Œæˆ– 2 1så 1

*   è™½ç„¶çœ‹ç€æ˜¯newäº†ä¸åŒçš„å¯¹è±¡ï¼Œä½†æ˜¯å®é™…è°ƒç”¨ä¼šè½¬ä¸ºç±»staticè°ƒç”¨ï¼Œæ‰€ä»¥æ˜¯åŒä¸€é”å¯¹è±¡

```java
public class Test8 {

    public static void main(String[] args) {
        Number8 n1 = new Number8();
        Number8 n2 = new Number8();
        new Thread(() -> n1.a()).start();
        new Thread(() -> n2.b()).start();
    }
}

@Slf4j(topic = "Number")
class Number8{
    public static synchronized void a() {
        try {
            TimeUnit.SECONDS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        log.debug("1");
    }
    public static synchronized void b() {
        log.debug("2");
    }
}
```





## å˜é‡çš„çº¿ç¨‹å®‰å…¨åˆ†æ ğŸ”¥

### æˆå‘˜å˜é‡å’Œé™æ€å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ

*   å¦‚æœå®ƒä»¬**æ²¡æœ‰å…±äº«ï¼Œåˆ™çº¿ç¨‹å®‰å…¨**
*   å¦‚æœå®ƒä»¬è¢«**å…±äº«**äº†ï¼Œæ ¹æ®å®ƒä»¬çš„çŠ¶æ€æ˜¯å¦èƒ½å¤Ÿæ”¹å˜ï¼Œåˆåˆ†ä¸¤ç§æƒ…å†µ
    *   å¦‚æœ**åªæœ‰è¯»**æ“ä½œï¼Œåˆ™**çº¿ç¨‹å®‰å…¨**
    *   å¦‚æœ**æœ‰è¯»å†™**æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦**è€ƒè™‘çº¿ç¨‹å®‰å…¨**



### å±€éƒ¨å˜é‡æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ

*   **å±€éƒ¨å˜é‡**æ˜¯**çº¿ç¨‹å®‰å…¨**çš„
*   ä½†**å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡åˆ™æœªå¿…**ğŸ”¥
    *   å¦‚æœè¯¥å¯¹è±¡**æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨è®¿é—®**ï¼Œå®ƒæ˜¯**çº¿ç¨‹å®‰å…¨**çš„
    *   å¦‚æœè¯¥å¯¹è±¡**é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´**ï¼Œéœ€è¦**è€ƒè™‘çº¿ç¨‹å®‰å…¨**



### åˆ†æâ€”æˆå‘˜å˜é‡â€”List#add Ã— ğŸ”¥

```java
class Test {
    static final int THREAD_NUMBER = 2;
    static final int LOOP_NUMBER = 200;

    public static void main(String[] args) {
        ThreadUnsafe test = new ThreadUnsafe();
        for (int i = 0; i < THREAD_NUMBER; i++) {
            new Thread(() -> {
                test.method1(LOOP_NUMBER);
            }, "Thread" + i).start();
        }
    }
}

class ThreadUnsafe {

    /* æˆå‘˜å˜é‡ */
    ArrayList<String> list = new ArrayList<>();

    public void method1(int loopNumber) {
        for (int i = 0; i < loopNumber; i++) {
            // ä¸´ç•ŒåŒº, ä¼šäº§ç”Ÿç«æ€æ¡ä»¶
            method2();
            method3();
            // ä¸´ç•ŒåŒº
        }
    }

    private void method2() {
        list.add("1");
    }

    private void method3() {
        list.remove(0);
    }
}
```

è¿™é‡Œé¢æœ¬æ¥method2æ‰§è¡Œå®Œaddåå†æ‰§è¡Œmethod3çš„removeæ˜¯æ— è®ºå¦‚ä½•ä¸ä¼šå‡ºé”™çš„ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸‹ï¼Œ**addæ–¹æ³•ä¸æ˜¯åŸå­æ€§**çš„ï¼š

```java
public boolean add(E e) {
    ensureCapacityInternal(size + 1);  // Increments modCount!!
    elementData[size++] = e;
    return true;
}
```

**æœ‰å¯èƒ½2ä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œaddæ—¶ï¼Œæ‹¿åˆ°äº†åŒä¸€ä¸ªsize**ï¼Œå³**åªæ·»åŠ äº†ä¸€ä¸ªå…ƒç´ **ï¼æ­¤æ—¶è¦æ˜¯è°ƒç”¨ç¬¬äºŒä¸ªremoveå°±ä¼šæŠ›å¦‚ä¸‹å¼‚å¸¸ï¼š

```
Exception in thread "Thread0" java.lang.IndexOutOfBoundsException: Index: 0, Size: 0
	at java.util.ArrayList.rangeCheck(ArrayList.java:657)
	at java.util.ArrayList.remove(ArrayList.java:496)
	at _10_var_safe.ThreadUnsafe.method3(ThreadUnsafe.java:23)
	at _10_var_safe.ThreadUnsafe.method1(ThreadUnsafe.java:14)
	at _10_var_safe.ThreadUnsafe.lambda$main$0(ThreadUnsafe.java:37)
	at java.lang.Thread.run(Thread.java:748)
```

ä¸è‡ªå¢è‡ªå‡ä¸åŒçš„æ˜¯ï¼Œè‡ªå¢è‡ªå‡ä¸­2ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«è¿›è¡Œå¢ã€å‡æ“ä½œï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªçº¿ç¨‹å†…è¿›è¡Œå¢å‡æ“ä½œ

åˆ†æï¼š

*   æ— è®ºå“ªä¸ªçº¿ç¨‹ä¸­çš„ method2 å¼•ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡ä¸­çš„ list æˆå‘˜å˜é‡

*   method3 ä¸ method2 åˆ†æç›¸åŒ

![image-20210217160309358](../images/image-20210217160309358.png)





### åˆ†æâ€”å±€éƒ¨æ™®é€šå˜é‡ âœ“

å¦‚ä¸‹ä»£ç ï¼š

```java
public static void test1() {
    int i = 10; 
    i++; 
}
```

æ¯ä¸ªçº¿ç¨‹è°ƒç”¨ test1() æ–¹æ³•æ—¶å±€éƒ¨å˜é‡ iï¼Œä¼šåœ¨æ¯ä¸ªçº¿ç¨‹çš„æ ˆå¸§å†…å­˜ä¸­è¢«åˆ›å»ºå¤šä»½ï¼Œå› æ­¤ä¸å­˜åœ¨å…±äº«

```
public static void test1();

	descriptor: ()V
    flags: ACC_PUBLIC, ACC_STATIC
	Code:
		stack=1, locals=1, args_size=0 
			0: bipush 10
			2: istore_0
			3: iinc 0, 1 
			6: return
		LineNumberTable:
			line 10: 0
			line 11: 3
			line 12: 6
		LocalVariableTable:
			Start Length Slot Name Signature
			3 		4 		0 	i 		I
```

å¦‚å›¾ï¼š

![image-20210217154731430](../images/image-20210217154731430.png)





### åˆ†æâ€”å±€éƒ¨å˜é‡ä¸ºå¼•ç”¨å¯¹è±¡ âœ“

å°† list ä¿®æ”¹ä¸ºå±€éƒ¨å˜é‡

```java
class Test {
    static final int THREAD_NUMBER = 2;
    static final int LOOP_NUMBER = 200;

    public static void main(String[] args) {
        ThreadSafe test = new ThreadSafe();
        for (int i = 0; i < THREAD_NUMBER; i++) {
            new Thread(() -> {
                test.method1(LOOP_NUMBER);
            }, "Thread" + i).start();
        }
    }
}

class ThreadSafe {

    public void method1(int loopNumber) {
        ArrayList<String> list = new ArrayList<>();
        for (int i = 0; i < loopNumber; i++) {
            // ä¸´ç•ŒåŒº, ä¼šäº§ç”Ÿç«æ€æ¡ä»¶
            method2(list);
            method3(list);
            // ä¸´ç•ŒåŒº
        }
    }

    private void method2(ArrayList<String> list) {
        list.add("1");
    }

    private void method3(ArrayList<String> list) {
        list.remove(0);
    }
}
```

é‚£ä¹ˆå°±ä¸ä¼šæœ‰ä¸Šè¿°é—®é¢˜äº†

åˆ†æï¼š

*   list æ˜¯å±€éƒ¨å˜é‡ï¼Œ**æ¯ä¸ªçº¿ç¨‹è°ƒç”¨æ—¶ä¼šåˆ›å»ºå…¶ä¸åŒå®ä¾‹ï¼Œæ²¡æœ‰å…±äº«**

*   è€Œ method2 çš„å‚æ•°æ˜¯ä» method1 ä¸­ä¼ é€’è¿‡æ¥çš„ï¼Œä¸ method1 ä¸­å¼•ç”¨åŒä¸€ä¸ªå¯¹è±¡

*   method3 çš„å‚æ•°åˆ†æä¸ method2 ç›¸åŒ

![image-20210217160523996](../images/image-20210217160523996.png)



### åˆ†æâ€”å±€éƒ¨å˜é‡ä¸ºå¼•ç”¨å¯¹è±¡å¹¶æš´éœ² Ã— 

æ–¹æ³•è®¿é—®ä¿®é¥°ç¬¦å¸¦æ¥çš„æ€è€ƒï¼Œå¦‚æœæŠŠ method2 å’Œ method3 çš„æ–¹æ³•ä¿®æ”¹ä¸º public ä¼šä¸ä¼šä»£ç†çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ

*   æƒ…å†µ1ï¼šæœ‰å…¶å®ƒçº¿ç¨‹è°ƒç”¨ method2 å’Œ method3

    æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºæ“ä½œçš„listå¯¹è±¡è¿˜æ˜¯å„çº¿ç¨‹ç§æœ‰çš„

*   æƒ…å†µ2ï¼šåœ¨ æƒ…å†µ1 çš„åŸºç¡€ä¸Šï¼Œä¸º ThreadSafe ç±»æ·»åŠ å­ç±»ï¼Œå­ç±»è¦†ç›– method2 æˆ– method3 æ–¹æ³•ï¼Œå³

```java
class Test2 {
    static final int THREAD_NUMBER = 2;
    static final int LOOP_NUMBER = 200;

    public static void main(String[] args) {
        ThreadSafe2Sub test = new ThreadSafe2Sub();
        for (int i = 0; i < THREAD_NUMBER; i++) {
            new Thread(() -> test.method1(LOOP_NUMBER), "Thread" + i).start();
        }
    }
}


class ThreadSafe2 {

    public void method1(int loopNumber) {
        ArrayList<String> list = new ArrayList<>();
        for (int i = 0; i < loopNumber; i++) {
            // ä¸´ç•ŒåŒº, ä¼šäº§ç”Ÿç«æ€æ¡ä»¶
            method2(list);
            method3(list);
            // ä¸´ç•ŒåŒº
        }
    }

    public void method2(ArrayList<String> list) {
        list.add("1");
    }

    public void method3(ArrayList<String> list) {
        list.remove(0);
    }
}

class ThreadSafe2Sub extends ThreadSafe2{
    // @Override
    // public void method2(ArrayList<String> list) {
    //     new Thread(()-> list.add("1")).start();
    // }

    @Override
    public void method3(ArrayList<String> list) {
        new Thread(()-> list.remove(0)).start();
    }
}
```

è¿™æ ·å°±å¯¼è‡´å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€èµ„æºè¿›è¡Œæ“ä½œï¼Œä¸”æ“ä½œçš„è¯­å¥æœ‰å¤šæ¡ï¼removeåº•å±‚ï¼š

```java
public E remove(int index) {
    rangeCheck(index);

    modCount++;
    E oldValue = elementData(index);

    int numMoved = size - index - 1;
    if (numMoved > 0)
        System.arraycopy(elementData, index+1, elementData, index,
                         numMoved);
    elementData[--size] = null; // clear to let GC do its work

    return oldValue;
}
```





### å¸¸è§çº¿ç¨‹å®‰å…¨ç±»â€”åŒæ­¥é”

*   StringBuffer
*   Random
*   ~~Vector~~ï¼šä¸æ¨è
*   ~~Hashtable~~ï¼šä¸æ¨è
*   java.util.concurrent åŒ…ä¸‹çš„ç±»

è¿™é‡Œè¯´å®ƒä»¬æ˜¯çº¿ç¨‹å®‰å…¨çš„æ˜¯æŒ‡ï¼Œ**å¤šä¸ªçº¿ç¨‹è°ƒç”¨**å®ƒä»¬**åŒä¸€ä¸ªå®ä¾‹çš„æŸä¸ªæ–¹æ³•æ—¶**ï¼Œæ˜¯**çº¿ç¨‹å®‰å…¨**çš„ã€‚ä¹Ÿå¯ä»¥ç†è§£ä¸º

```java
Hashtable table = new Hashtable();
new Thread(()->{
    table.put("key", "value1");
}).start();
new Thread(()->{
    table.put("key", "value2");
}).start();
```

å®ƒä»¬çš„**æ¯ä¸ªæ–¹æ³•æ˜¯åŸå­**çš„ã€‚ä½†**æ³¨æ„**å®ƒä»¬**å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­**çš„ï¼š

```java
Hashtable table = new Hashtable();
new Thread(()->{
    if(table.get("key")==null){
        table.put("key", "value");
    }
}).start();
```

```mermaid
sequenceDiagram
participant t1 as çº¿ç¨‹1
participant t2 as çº¿ç¨‹2
participant table
t1 ->> table : get("key") == null
t2 ->> table : get("key") == null
t2 ->> table : put("key", "value)
t1 ->> table : put("key", "value)
```

æ¯ä¸ªåŸå­æ“ä½œæ‰§è¡Œå®Œåéƒ½ä¼šé‡Šæ”¾é”ï¼Œå¹¶å”¤é†’å…¶ä»–é˜»å¡çº¿ç¨‹ã€‚è¿™é‡Œçš„getã€putæ–¹æ³•éƒ½æ˜¯åŒä¸€æŠŠé”



### å¸¸è§çº¿ç¨‹å®‰å…¨ç±»â€”ä¸å¯å˜ç±»

*   String
*   Integer

Stringã€Integer ç­‰éƒ½æ˜¯ä¸å¯å˜ç±»ï¼Œå› ä¸ºå…¶å†…éƒ¨çš„çŠ¶æ€ä¸å¯ä»¥æ”¹å˜ï¼Œå› æ­¤å®ƒä»¬çš„æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„

æœ‰åŒå­¦æˆ–è®¸æœ‰ç–‘é—®ï¼ŒString æœ‰ replaceï¼Œsubstring ç­‰æ–¹æ³•ã€å¯ä»¥ã€‘æ”¹å˜å€¼å•Šï¼Œé‚£ä¹ˆè¿™äº›æ–¹æ³•åˆæ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„å‘¢ï¼Ÿ

å› ä¸º**æ²¡æœ‰æ”¹å˜åŸæœ‰çš„å€¼**ï¼Œæ˜¯**é‡æ–°newä¸€ä¸ªå¯¹è±¡å¹¶è¿”å›**çš„ï¼





### å®ä¾‹åˆ†æ ğŸ”¥

**å¦‚ä¸‹å®ä¾‹ä¸­ï¼ŒServlet éƒ½æ˜¯å•ä¾‹çš„ï¼ï¼ï¼æ‰€ä»¥å…¶æ‰€æœ‰ Serviceã€Dao ä¹Ÿéƒ½æ˜¯å•ä¾‹çš„**

[Servletå‚è€ƒåšå®¢](https://www.cnblogs.com/stono/p/14234241.html)



#### ä¾‹1

```java
public class MyServlet extends HttpServlet {
    // æ˜¯å¦å®‰å…¨ï¼Ÿå¦
    Map<String,Object> map = new HashMap<>();
    // æ˜¯å¦å®‰å…¨ï¼Ÿæ˜¯
    String S1 = "...";
    // æ˜¯å¦å®‰å…¨ï¼Ÿæ˜¯
    final String S2 = "...";
    // æ˜¯å¦å®‰å…¨ï¼Ÿå¦
    Date d1 = new Date();
    // æ˜¯å¦å®‰å…¨ï¼Ÿå¦ï¼Œåªæ˜¯ d2 è¿™ä¸ªå¼•ç”¨å€¼ä¸èƒ½å˜ï¼Œå…¶å¯¹è±¡å†…éƒ¨å±æ€§æ˜¯å¯å˜çš„
    final Date d2 = new Date();

    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        // ä½¿ç”¨ä¸Šè¿°å˜é‡
    }
}
```



#### ä¾‹2

```java
// MyServlet åªæœ‰ä¸€ä»½ï¼Œæ¯ä¸ªçº¿ç¨‹è®¿é—®éƒ½ä¼šæœ‰ä¸€ä»½
public class MyServlet extends HttpServlet {
    // æ˜¯å¦å®‰å…¨ï¼Ÿæˆå‘˜å˜é‡ï¼Œå¯èƒ½æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚UserServiceImplä¸­æœ‰æˆå‘˜å˜é‡ï¼Œå¹¶æœ‰å¯¹è¯¥æˆå‘˜å˜é‡çš„ä¿®æ”¹æ“ä½œ
    private UserService userService = new UserServiceImpl();
    
    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        userService.update(...);
    }
}
public class UserServiceImpl implements UserService {
    // è®°å½•è°ƒç”¨æ¬¡æ•°
    // æˆå‘˜å˜é‡ï¼Œå¯èƒ½æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜
    private int count = 0;
    public void update() {
        // ...åŒæ ·
        count++;
    }
}
```



#### ä¾‹3

```java
@Aspect
@Component// Springç»„ä»¶é»˜è®¤å•ä¾‹
public class MyAspect {
    // æ˜¯å¦å®‰å…¨ï¼Ÿæˆå‘˜å˜é‡ï¼Œå¯èƒ½æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜
    private long start = 0L;
    @Before("execution(* *(..))")
    public void before() {
        start = System.nanoTime();
    }
    @After("execution(* *(..))")
    public void after() {
        long end = System.nanoTime();
        System.out.println("cost time:" + (end-start));
    }
}
```

å¯ä»¥ä½¿ç”¨ç¯ç»•é€šçŸ¥ï¼Œå°†å˜é‡æ”¹ä¸ºå±€éƒ¨å˜é‡



#### ä¾‹4

```java
public class MyServlet extends HttpServlet {
    // æ˜¯å¦å®‰å…¨ã€‚æ˜¯ã€‚æ²¡æœ‰å¯¹userServiceè¿›è¡Œä¿®æ”¹çš„æ“ä½œ
    private UserService userService = new UserServiceImpl();
    
    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        userService.update(...);
    }
}
public class UserServiceImpl implements UserService {
    // æ˜¯å¦å®‰å…¨ã€‚æ˜¯ã€‚æ²¡æœ‰å¯¹userDaoè¿›è¡Œä¿®æ”¹çš„æ“ä½œ
    private UserDao userDao = new UserDaoImpl();
    public void update() {
        userDao.update();
    }
}
public class UserDaoImpl implements UserDao { 
    public void update() {
        String sql = "update user set password = ? where username = ?";
        // æ˜¯å¦å®‰å…¨ã€‚æ˜¯ã€‚æ²¡æœ‰æˆå‘˜å˜é‡ï¼Œåªæœ‰å±€éƒ¨å˜é‡ä¸€èˆ¬éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„
        try (Connection conn = DriverManager.getConnection("","","")){
            // ...
        } catch (Exception e) {
            // ...
        }
    }
}
```



#### ä¾‹5

```java
public class MyServlet extends HttpServlet {
    // æ˜¯å¦å®‰å…¨ã€‚æ˜¯ã€‚æ²¡æœ‰å¯¹userServiceè¿›è¡Œä¿®æ”¹çš„æ“ä½œ
    private UserService userService = new UserServiceImpl();
    
    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        userService.update(...);
    }
}
public class UserServiceImpl implements UserService {
    // æ˜¯å¦å®‰å…¨ã€‚æ˜¯ã€‚æ²¡æœ‰å¯¹userDaoè¿›è¡Œä¿®æ”¹çš„æ“ä½œ
    private UserDao userDao = new UserDaoImpl();
    
    public void update() {
        userDao.update();
    }
}
public class UserDaoImpl implements UserDao {
    // æ˜¯å¦å®‰å…¨ã€‚å¦ã€‚æˆå‘˜å˜é‡ï¼Œä¸”æœ‰å¯¹æˆå‘˜å˜é‡çš„ä¿®æ”¹æ“ä½œï¼Œå¦‚close
    private Connection conn = null;
    public void update() throws SQLException {
        String sql = "update user set password = ? where username = ?";
        conn = DriverManager.getConnection("","","");
        // ...
        conn.close();
    }
}
```



#### ä¾‹6

```java
public class MyServlet extends HttpServlet {
    // æ˜¯å¦å®‰å…¨ã€‚æ˜¯
    private UserService userService = new UserServiceImpl();
    public void doGet(HttpServletRequest request, HttpServletResponse response) {
        userService.update(...);
    }
}
public class UserServiceImpl implements UserService { 
    // æ˜¯å¦å®‰å…¨ã€‚æ˜¯
    public void update() {
        UserDao userDao = new UserDaoImpl();
        userDao.update();
    }
}
public class UserDaoImpl implements UserDao {
    // æ˜¯å¦å®‰å…¨ï¼Œæ˜¯ï¼Œæ¯æ¬¡éƒ½ä¼šnew UserDaoImplï¼Œå…¶å®ä¾‹ä¸­çš„æˆå‘˜å˜é‡ä¸å­˜åœ¨å…±äº«
    private Connection conn = null;
    public void update() throws SQLException {
        String sql = "update user set password = ? where username = ?";
        conn = DriverManager.getConnection("","","");
        // ...
        conn.close();
    }
}
```



#### ä¾‹7

```java
public abstract class Test {
    public void bar() {
        // æ˜¯å¦å®‰å…¨ã€‚å¦ã€‚å±€éƒ¨å˜é‡ä¸ºå¼•ç”¨å¯¹è±¡ï¼Œå¹¶æš´éœ²äº†ï¼
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        foo(sdf);
    }
    public abstract foo(SimpleDateFormat sdf);
    public static void main(String[] args) {
        new Test().bar();
    }
}
```

å…¶ä¸­ foo çš„è¡Œä¸ºæ˜¯ä¸ç¡®å®šçš„ï¼Œå¯èƒ½å¯¼è‡´ä¸å®‰å…¨çš„å‘ç”Ÿï¼Œè¢«ç§°ä¹‹ä¸º**å¤–æ˜Ÿæ–¹æ³•**

```java
public void foo(SimpleDateFormat sdf) {
    String dateStr = "1999-10-11 00:00:00";
    for (int i = 0; i < 20; i++) {
        new Thread(() -> {
            try {
                sdf.parse(dateStr);
            } catch (ParseException e) {
                e.printStackTrace();
            }
        }).start();
    }
}
```

è¯·æ¯”è¾ƒ JDK ä¸­ String ç±»çš„å®ç°



#### ä¾‹8

```java
@Slf4j(topic = "Test3")
public class Test3 {

    private static Integer i = 0;
    public static void main(String[] args) throws InterruptedException {
        List<Thread> list = new ArrayList<>();
        for (int j = 0; j < 2; j++) {
            Thread thread = new Thread(() -> {
                for (int k = 0; k < 5000; k++) {
                    synchronized (i) {
                        i++;
                    }
                }
            }, "" + j);
            list.add(thread);
        }

        list.forEach(Thread::start);
        list.forEach(t -> {
            try {
                t.join();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        log.debug("{}", i);// ä¸å¤Ÿ10000
    }
}
```

é”å¯¹è±¡ç”¨çš„æ˜¯æˆè¯­å˜é‡ Integer i ï¼Œä¸€ç›´åœ¨å˜åŒ–ï¼Œæ‰€ä»¥æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜



### ä¹ é¢˜1â€”å–ç¥¨ç»ƒä¹  ğŸ”¥

æµ‹è¯•ä¸‹é¢ä»£ç æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¹¶å°è¯•æ”¹æ­£ã€‚ç›®å‰å·²æ˜¯æ­£ç¡®çš„äº†ï¼

```java
@Slf4j(topic = "TestSell")
public class TestSell {

    // Random ä¸ºçº¿ç¨‹å®‰å…¨
    static Random random = new Random();

    // éšæœº 1~5
    public static int randomAmount() {
        return random.nextInt(5) + 1;
    }


    @RepeatedTest(10)
    void test() {
        // åˆå§‹åŒ–ç¥¨æ•°
        TicketWindow ticketWindow = new TicketWindow(1000);

        // æ–¹ä¾¿ join åŒæ­¥ï¼Œç­‰å¾…éƒ½å®Œæˆå main çº¿ç¨‹æ‰§è¡Œç»Ÿè®¡ã€‚ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œä¸æ¶‰åŠå¤šçº¿ç¨‹
        List<Thread> list = new ArrayList<>();

        // ç”¨æ¥å­˜å‚¨å–å‡ºå»å¤šå°‘å¼ ç¥¨ã€‚å…±äº«èµ„æºï¼Œè‹¥ä½¿ç”¨ List#add å…¶æ–¹æ³•ä¸æ˜¯åŒæ­¥çš„ï¼Œæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜
        List<Integer> sellCount = new Vector<>();
        for (int i = 0; i < 2_000; i++) {
            Thread t = new Thread(() -> {
                try {
                    // å¢åŠ æ—¶é—´ï¼Œä»¥ä¾¿çº¿ç¨‹åˆ‡æ¢å‡ ç‡ï¼Œå¦åˆ™ä»£ç å¤ªå°‘ï¼Œå¾ˆå¿«å°±æ‰§è¡Œå®Œäº†
                    TimeUnit.MILLISECONDS.sleep(randomAmount());
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                // åˆ†æè¿™é‡Œçš„ç«æ€æ¡ä»¶
                // è¯¥æ–¹æ³•ä¸æ˜¯åŸå­çš„ï¼Œéœ€è¦åŒæ­¥çº¦æŸ
                int count = ticketWindow.sell(randomAmount());
                // è¯¥æ–¹æ³•å·²ç»æ˜¯åŒæ­¥çš„äº†ï¼Œä¸”å’Œä¸Šé¢çš„ä¸æ˜¯åŒä¸€å…±äº«èµ„æºï¼Œæ‰€ä»¥æ— éœ€ç»„åˆåŒæ­¥
                sellCount.add(count);
            });
            list.add(t);
            t.start();
        }
        list.forEach(t -> {
            try {
                t.join();
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
        log.debug("å–å‡ºçš„ç¥¨ :{} \tä½™ç¥¨: {}",
                sellCount.stream().mapToInt(c -> c).sum(),
                ticketWindow.getCount() );
        // å–å‡ºçš„ç¥¨ + ä½™ç¥¨ åº”è¯¥ç­‰äºåˆå§‹ç¥¨æ•°
    }


}


// å”®ç¥¨çª—å£
class TicketWindow {
    private int count;

    public TicketWindow(int count) {
        this.count = count;
    }

    // è·å–ä½™ç¥¨
    public int getCount() {
        return count;
    }

    // å”®ç¥¨ã€‚å¿…é¡»åŠ ä¸Šsynchronizedï¼Œä¿è¯åŸå­æ€§
    public synchronized int sell(int amount) {
        if (this.count >= amount) {
            this.count -= amount;
            return amount;
        } else {
            return 0;
        }
    }
}
```

ä¸åŠ sleepï¼Œä½¿ç”¨è„šæœ¬æµ‹è¯•å¤šæ¬¡ï¼ˆæœ‰å¯èƒ½ç”µè„‘å¤ªå¿«äº†ï¼Œè¿˜å¿…é¡»åŠ sleepï¼‰ã€‚å¦‚ä¸‹ä¸ºcmd

```
for /L %n in (1,1,10) do java -cp ".;C:\Users\manyh\.m2\repository\ch\qos\logback\logback-classic\1.2.3\logback-classic-1.2.3.jar;C:\Users\manyh\.m2\repository\ch\qos\logback\logback-core\1.2.3\logback-core-1.2.3.jar;C:\Users\manyh\.m2\repository\org\slf4j\slf4j-api\1.7.25\slf4j-api-1.7.25.jar" cn.itcast.n4.exercise.ExerciseSell
```

*   -cpï¼šclasspathï¼Œå› ä¸ºåˆ©ç”¨äº†ç¬¬ä¸‰æ–¹åº“



### ä¹ é¢˜2â€”è½¬è´¦ ğŸ”¥

æµ‹è¯•ä¸‹é¢ä»£ç æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¹¶å°è¯•æ”¹æ­£ã€‚ç›®å‰å·²æ˜¯æ­£ç¡®çš„äº†ï¼ä½†æ˜¯**æœ‰å¾ˆå¤§ç¼ºé™·**

```java
@Slf4j(topic = "TestTransfer")
public class TestTransfer {

    // Random ä¸ºçº¿ç¨‹å®‰å…¨
    static Random random = new Random();

    // éšæœº 1~100
    public static int randomAmount() {
        return random.nextInt(100) + 1;
    }


    @RepeatedTest(10)
    void test() throws InterruptedException {
        Account a = new Account(1000);
        Account b = new Account(1000);

        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 1000; i++) {
                a.transfer(b, randomAmount());
            }
        }, "t1");
        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 1000; i++) {
                b.transfer(a, randomAmount());
            }
        }, "t2");

        t1.start();
        t2.start();
        t1.join();
        t2.join();

        log.debug("total:{}", (a.getMoney() + b.getMoney()));
    }

}


class Account {
    private int money;

    public Account(int money) {
        this.money = money;
    }

    public int getMoney() {
        return money;
    }

    public void setMoney(int money) {
        this.money = money;
    }

    // è¿™é‡Œ money å…±äº«èµ„æºå…¶å®æ˜¯æœ‰ 2ä¸ªè´¦æˆ·çš„ï¼Œéœ€è¦éƒ½ä¿æŠ¤èµ·æ¥ã€‚
    // è€Œ synchronized åŒæ­¥æ–¹æ³•é”å¯¹è±¡æ˜¯ thisï¼Œä¸èƒ½éƒ½ä¿æŠ¤ã€‚å³ aè½¬bæ—¶å…¶ä»–aè½¬bçº¿ç¨‹ä¸èƒ½è¿›å…¥ï¼Œä½†æ˜¯bè½¬açº¿ç¨‹å¯ä»¥è¿›å…¥ï¼
    // æ­¤æ—¶éœ€è¦å°†éƒ½ä¿æŠ¤èµ·æ¥ã€‚ä½†æ˜¯ä¸èƒ½ä½¿ç”¨åµŒå¥—åŒæ­¥ä»£ç å—ï¼Œå®¹æ˜“æ­»é”ã€‚æ­¤æ—¶å¯ä»¥é‡‡ç”¨Account.classé”å¯¹è±¡
    // ä½†æ˜¯è¿™æ˜¯åœ¨åŒä¸€æ—¶åˆ»åªèƒ½ä¸€ä¸ªè´¦æˆ·è¿›è¡Œè½¬è´¦äº†ï¼Œæ€§èƒ½ä½ä¸‹ï¼ï¼ï¼
    public void transfer(Account target, int amount) {
        synchronized (Account.class) {
            if (this.money > amount) {
                this.setMoney(this.money - amount);
                target.setMoney(target.getMoney() + amount);
            }
        }
    }
}
```







## çº¿ç¨‹é—´é€šä¿¡â€”waitã€notify ç­‰å¾…å”¤é†’æœºåˆ¶ ğŸ”¥

### çº¿ç¨‹é—´é€šä¿¡ ğŸ”¥

**å¤šä¸ªçº¿ç¨‹åœ¨å¤„ç†åŒä¸€ä¸ªèµ„æºï¼Œä½†æ˜¯å¤„ç†çš„åŠ¨ä½œï¼ˆçº¿ç¨‹çš„ä»»åŠ¡ï¼‰å´ä¸ç›¸åŒ**ï¼Œéœ€è¦çº¿ç¨‹é€šä¿¡æ¥å¸®åŠ©è§£å†³çº¿ç¨‹ä¹‹é—´å¯¹åŒä¸€ä¸ªå˜é‡çš„ä½¿ç”¨æˆ–æ“ä½œã€‚ å°±æ˜¯å¤šä¸ªçº¿ç¨‹åœ¨æ“ä½œåŒä¸€ä»½æ•°æ®æ—¶ï¼Œ é¿å…å¯¹åŒä¸€å…±äº«å˜é‡çš„äº‰å¤ºã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€å®šçš„æ‰‹æ®µä½¿å„ä¸ªçº¿ç¨‹èƒ½æœ‰æ•ˆçš„åˆ©ç”¨èµ„æºã€‚è€Œè¿™ç§æ‰‹æ®µå³â€”â€” **ç­‰å¾…å”¤é†’æœºåˆ¶**ã€‚



### å°æ•…äº‹

*   ç”±äºæ¡ä»¶ä¸æ»¡è¶³ï¼Œå°å—ä¸èƒ½ç»§ç»­è¿›è¡Œè®¡ç®—

*   ä½†å°å—å¦‚æœä¸€ç›´å ç”¨ç€é”ï¼Œå…¶å®ƒäººå°±å¾—ä¸€ç›´é˜»å¡ï¼Œæ•ˆç‡å¤ªä½

    ![image-20210219233020753](../images/image-20210219233020753.png)

*   äºæ˜¯è€ç‹å•å¼€äº†ä¸€é—´ä¼‘æ¯å®¤ï¼ˆè°ƒç”¨ wait æ–¹æ³•ï¼‰ï¼Œè®©å°å—åˆ°ä¼‘æ¯å®¤ï¼ˆWaitSetï¼‰ç­‰ç€å»äº†ï¼Œä½†è¿™æ—¶é”é‡Šæ”¾å¼€ï¼Œå…¶å®ƒäººå¯ä»¥ç”±è€ç‹éšæœºå®‰æ’è¿›å±‹

*   ç›´åˆ°å°Må°†çƒŸé€æ¥ï¼Œå¤§å«ä¸€å£° [ ä½ çš„çƒŸåˆ°äº† ] ï¼ˆè°ƒç”¨ notify æ–¹æ³•ï¼‰

    ![image-20210219233050871](../images/image-20210219233050871.png)

*   å°å—äºæ˜¯å¯ä»¥ç¦»å¼€ä¼‘æ¯å®¤ï¼Œé‡æ–°è¿›å…¥ç«äº‰é”çš„é˜Ÿåˆ—

    ![image-20210219233119428](../images/image-20210219233119428.png)



### åŸç†å›¾è§£ ğŸ”¥

<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:100%; height:645px;" src="https://www.processon.com/embed/602e422c07912934224cfe8d"></iframe>

*   Owner çº¿ç¨‹å‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨ wait æ–¹æ³•ï¼Œå³å¯è¿›å…¥ WaitSet å˜ä¸º WAITING çŠ¶æ€

*   BLOCKED å’Œ WAITING çš„çº¿ç¨‹**éƒ½å¤„äºé˜»å¡çŠ¶æ€**ï¼Œ**ä¸å ç”¨ CPU æ—¶é—´ç‰‡**

*   **BLOCKED çº¿ç¨‹ä¼šåœ¨ Owner çº¿ç¨‹é‡Šæ”¾é”æ—¶å”¤é†’**

    **WAITING çº¿ç¨‹ä¼šåœ¨ Owner æ‰€å± Monitor è°ƒç”¨ notify æˆ– notifyAll æ—¶å”¤é†’**ï¼Œä½†å”¤é†’å**å¹¶ä¸æ„å‘³è€…ç«‹åˆ»è·å¾—é”**ï¼Œä»éœ€**è¿›å…¥EntryList é‡æ–°ç«äº‰**



### æ–¹æ³• ğŸ”¥

`Object`ç±»ï¼ˆä»»æ„é”ï¼‰ä¸­æä¾›äº†ä¸‰ä¸ªæ–¹æ³•ï¼Œæ˜¯çº¿ç¨‹ä¹‹é—´è¿›è¡Œåä½œçš„æ‰‹æ®µã€‚è¿™äº›æ–¹æ³•å¿…é¡»é€šè¿‡**åŒä¸€ä¸ªé”å¯¹è±¡ï¼ˆthis è°ƒç”¨æˆ–å…¶ä»–åŒä¸€å¯¹è±¡è°ƒç”¨ï¼‰åœ¨åŒæ­¥ä¸­ï¼ˆåŒæ­¥ä»£ç å—ã€åŒæ­¥æ–¹æ³•ï¼Œå³å¿…é¡»è·å¾—é”ã€æˆä¸º Monitor çš„ Ownerï¼‰è°ƒç”¨**ï¼Œå¦åˆ™æŠ¥`IllegalMonitorStateException`é”™ã€‚Lock æœ‰å…¶è‡ªå·±çš„æ–¹æ³•ã€‚

- `wait([long timeout])`ï¼šè®©è¿›å…¥ obj ç›‘è§†å™¨çš„çº¿ç¨‹åˆ° WaitSet ç­‰å¾…ã€‚

    **ç­‰å¾…**å¹¶ç«‹å³**é‡Šæ”¾é”**ï¼Œçº¿ç¨‹è¿›å…¥ WAITINGï¼Œ**è¢«å”¤é†’è‹¥è·å¾—é”åä»æ–­ç‚¹å¤„æ‰§è¡Œåç»­ä»£ç **ã€‚

    æœ‰æ—¶é™çš„ç­‰å¾…, åˆ° n æ¯«ç§’åç»“æŸç­‰å¾…ç›´æ¥è¿è¡Œåç»­ä»£ç ï¼Œæˆ–æ˜¯è¢« notify

- `wait(long timeout, int nanos)`ä¸ä¼šç²¾ç¡®åˆ°nanosï¼Œåªè¦nanosæœ‰æ­£ç¡®çš„å€¼ï¼Œåˆ™ç»™timeout++

- `notify()`ï¼šåœ¨ obj ä¸Šæ­£åœ¨ WaitSet ç­‰å¾…çš„çº¿ç¨‹ä¸­æŒ‘ä¸€ä¸ªå”¤é†’ã€‚

    å”¤é†’æ­£åœ¨æ’é˜Ÿç­‰å¾…åŒæ­¥èµ„æºçš„çº¿ç¨‹ä¸­ä¼˜å…ˆçº§æœ€é«˜è€…ç»“æŸç­‰å¾…ï¼Œä½†**å®ƒè‡ªå·±ä¸é‡Šæ”¾é”**ï¼Œè¢«é€šçŸ¥çº¿ç¨‹ä¸èƒ½ç«‹å³æ¢å¤æ‰§è¡Œçº¿ç¨‹ï¼Œ**éœ€é‡æ–°è¯·æ±‚åŒæ­¥é”**

- `notifyAll()`ï¼šè®© obj ä¸Šæ­£åœ¨ WaitSet ç­‰å¾…çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’

    å”¤é†’æ­£åœ¨æ’é˜Ÿç­‰å¾…èµ„æºçš„æ‰€æœ‰çº¿ç¨‹ç»“æŸç­‰å¾…

::: tip

å“ªæ€•åªé€šçŸ¥äº†ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ï¼Œè¢«é€šçŸ¥çº¿ç¨‹ä¹Ÿä¸èƒ½ç«‹å³æ¢å¤æ‰§è¡Œï¼Œå› ä¸ºå®ƒå½“åˆä¸­æ–­çš„åœ°æ–¹æ˜¯åœ¨åŒæ­¥å—å†…ï¼Œè€Œæ­¤åˆ»å®ƒå·²ç»ä¸æŒæœ‰é”ï¼Œæ‰€ä»¥å¥¹éœ€è¦å†æ¬¡å°è¯•å»è·å–é”ï¼ˆå¾ˆå¯èƒ½é¢ä¸´å…¶å®ƒçº¿ç¨‹çš„ç«äº‰ï¼‰ï¼ŒæˆåŠŸåæ‰èƒ½åœ¨å½“åˆè°ƒç”¨ wait æ–¹æ³•ä¹‹åçš„åœ°æ–¹æ¢å¤æ‰§è¡Œã€‚
æ€»ç»“å¦‚ä¸‹ï¼š
å¦‚æœèƒ½è·å–é”ï¼Œçº¿ç¨‹å°±ä» WAITING çŠ¶æ€å˜æˆ RUNNABLE çŠ¶æ€ï¼› å¦åˆ™ï¼Œä» WaitSet å‡ºæ¥ï¼Œåˆè¿›å…¥ EntryListï¼Œçº¿ç¨‹å°±ä» WAITING çŠ¶æ€åˆå˜æˆ BLOCKED çŠ¶æ€ã€‚

:::

```java
@Slf4j(topic = "Test1")
public class Test1 {

    final static Object obj = new Object();

    public static void main(String[] args) throws InterruptedException {
        new Thread(() -> {
            synchronized (obj) {
                log.debug("æ‰§è¡Œ....");
                try {
                    obj.wait(); // è®©çº¿ç¨‹åœ¨objä¸Šä¸€ç›´ç­‰å¾…ä¸‹å»
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                log.debug("æ‰§è¡Œåç»­ä»£ç ....");
            }
        }).start();

        new Thread(() -> {
            synchronized (obj) {
                log.debug("æ‰§è¡Œ....");
                try {
                    obj.wait(); // è®©çº¿ç¨‹åœ¨objä¸Šä¸€ç›´ç­‰å¾…ä¸‹å»
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                log.debug("æ‰§è¡Œåç»­ä»£ç ....");
            }
        }).start();

        // ä¸»çº¿ç¨‹ä¸¤ç§’åæ‰§è¡Œ
        TimeUnit.SECONDS.sleep(2);
        log.debug("å”¤é†’ obj ä¸Šå…¶å®ƒçº¿ç¨‹");
        synchronized (obj) {
            obj.notify(); // å”¤é†’objä¸Šä¸€ä¸ªçº¿ç¨‹
            // obj.notifyAll(); // å”¤é†’objä¸Šæ‰€æœ‰ç­‰å¾…çº¿ç¨‹
        }
    }
}
```





### sleep ä¸ wait åŒºåˆ« ğŸ”¥

*   sleep æ˜¯ Thread æ–¹æ³•ï¼Œè€Œ wait æ˜¯ Object çš„æ–¹æ³•
*   sleep ä¸éœ€è¦å¼ºåˆ¶å’Œ synchronized é…åˆä½¿ç”¨ï¼Œä½† wait éœ€è¦å’Œ synchronized ä¸€èµ·ç”¨
*   sleep åœ¨ç¡çœ çš„åŒæ—¶ï¼Œä¸ä¼šé‡Šæ”¾å¯¹è±¡é”çš„ï¼Œä½† wait åœ¨ç­‰å¾…çš„æ—¶å€™ä¼šé‡Šæ”¾å¯¹è±¡é”
*   çŠ¶æ€éƒ½æ˜¯ TIMED_WAITING



### æ­£ç¡®ä½¿ç”¨ waitã€notify æ­¥éª¤ ğŸ”¥

å…ˆæ¥ä¸ª**æ ¼å¼**å§ï¼š

```java
synchronized(lock) {
    while(æ¡ä»¶ä¸æˆç«‹) {
        lock.wait();
    }
    // å¹²æ´»
}

synchronized(lock) {
	lock.notifyAll();
}
```

è¢«å”¤é†’åè‹¥è·å¾—é”åˆ™ä»waitåç»§ç»­æ‰§è¡Œï¼Œè¿™é‡Œç”±äºæ˜¯whileï¼Œåº”è¯¥ç»§ç»­æ‰§è¡Œwhileæ¡ä»¶åˆ¤æ–­

å…·ä½“æ€è·¯å¦‚ä¸‹





#### sleep æ–¹å¼

æ€è€ƒä¸‹é¢çš„è§£å†³æ–¹æ¡ˆå¥½ä¸å¥½ï¼Œä¸ºä»€ä¹ˆï¼Ÿ

```java
@Slf4j(topic = "TestWaitNotify")
public class TestWaitNotify {

    static final Object room = new Object();
    static boolean hasCigarette = false;// æœ‰çƒŸå—

    public static void main(String[] args) throws InterruptedException {
        step1();
    }


    private static void step1() throws InterruptedException {
        new Thread(() -> {
            synchronized (room) {
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                if (!hasCigarette) {
                    log.debug("æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼");
                    try {
                        sleep(2);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                if (hasCigarette) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                }
            }
        }, "å°å—").start();
        
        for (int i = 0; i < 5; i++) {
            new Thread(() -> {
                synchronized (room) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                }
            }, "å…¶å®ƒäºº").start();
        }
        
        sleep(1);
        new Thread(() -> {
            // è¿™é‡Œèƒ½ä¸èƒ½åŠ  synchronized (room)ï¼Ÿä¸èƒ½ï¼ŒåŠ äº†ååœ¨å°å—çº¿ç¨‹sleepæ—¶ï¼ˆä¸é‡Šæ”¾é”ï¼‰ä¸»çº¿ç¨‹è¿™é‡Œæ— æ³•è·å–é”
            hasCigarette = true;
            log.debug("çƒŸåˆ°äº†å™¢ï¼");
        }, "é€çƒŸçš„").start();
    }
}
```

ç»“æœå¦‚ä¸‹ï¼š

```
15:42:08.224 [å°å—] DEBUG TestWaitNotify - æœ‰çƒŸæ²¡ï¼Ÿ[false]
15:42:08.227 [å°å—] DEBUG TestWaitNotify - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼
15:42:09.226 [é€çƒŸçš„] DEBUG TestWaitNotify - çƒŸåˆ°äº†å™¢ï¼
15:42:10.231 [å°å—] DEBUG TestWaitNotify - æœ‰çƒŸæ²¡ï¼Ÿ[true]
15:42:10.232 [å°å—] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
15:42:10.232 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
15:42:10.232 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
15:42:10.233 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
15:42:10.233 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
15:42:10.233 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
```

é—®é¢˜å¦‚ä¸‹ï¼š

* å°å—çº¿ç¨‹æœªæ‰§è¡Œå®Œæ¯•æ—¶ï¼ˆåŒ…æ‹¬sleepä¸­ï¼‰å…¶å®ƒå¹²æ´»çš„çº¿ç¨‹ï¼Œéƒ½è¦ä¸€ç›´é˜»å¡ï¼Œæ•ˆç‡å¤ªä½
* å°å—çº¿ç¨‹å¿…é¡»ç¡è¶³ 2s åæ‰èƒ½é†’æ¥ï¼Œå°±ç®—çƒŸæå‰é€åˆ°ï¼Œä¹Ÿæ— æ³•ç«‹åˆ»é†’æ¥
* åŠ äº† synchronized (room) åï¼Œå°±å¥½æ¯”å°å—åœ¨é‡Œé¢åé”äº†é—¨ç¡è§‰ï¼ŒçƒŸæ ¹æœ¬æ²¡æ³•é€è¿›é—¨ï¼Œmain æ²¡åŠ  synchronized å°±å¥½åƒ main çº¿ç¨‹æ˜¯ç¿»çª—æˆ·è¿›æ¥çš„
* è§£å†³æ–¹æ³•ï¼Œä½¿ç”¨ wait - notify æœºåˆ¶



#### wait + notify æ”¹è¿›

æ€è€ƒä¸‹é¢çš„å®ç°è¡Œå—ï¼Œä¸ºä»€ä¹ˆï¼Ÿ

```java
@Slf4j(topic = "TestWaitNotify")
public class TestWaitNotify {

    static final Object room = new Object();
    static boolean hasCigarette = false;// æœ‰çƒŸå—

    public static void main(String[] args) throws InterruptedException {
        step2();
    }

    /**
     * waitã€notify æ–¹å¼
     */
    private static void step2() throws InterruptedException {
        new Thread(() -> {
            synchronized (room) {
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                if (!hasCigarette) {
                    log.debug("æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼");
                    try {
                        room.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                if (hasCigarette) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                }
            }
        }, "å°å—").start();

        for (int i = 0; i < 5; i++) {
            new Thread(() -> {
                synchronized (room) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                }
            }, "å…¶å®ƒäºº").start();
        }

        TimeUnit.SECONDS.sleep(1);
        new Thread(() -> {
            // è¿™é‡Œèƒ½ä¸èƒ½åŠ  synchronized (room)ï¼Ÿä¸èƒ½ï¼ŒåŠ äº†ååœ¨å°å—çº¿ç¨‹sleepæ—¶ï¼ˆä¸é‡Šæ”¾é”ï¼‰ä¸»çº¿ç¨‹è¿™é‡Œæ— æ³•è·å–é”
            synchronized (room) {
                hasCigarette = true;
                log.debug("çƒŸåˆ°äº†å™¢ï¼");
                room.notify();
            }
        }, "é€çƒŸçš„").start();
    }
}
```

ç»“æœå¦‚ä¸‹ï¼š

```
15:46:57.337 [å°å—] DEBUG TestWaitNotify - æœ‰çƒŸæ²¡ï¼Ÿ[false]
15:46:57.344 [å°å—] DEBUG TestWaitNotify - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼
15:46:57.344 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
15:46:57.344 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
15:46:57.344 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
15:46:57.344 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
15:46:57.344 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
15:46:58.344 [é€çƒŸçš„] DEBUG TestWaitNotify - çƒŸåˆ°äº†å™¢ï¼
15:46:58.344 [å°å—] DEBUG TestWaitNotify - æœ‰çƒŸæ²¡ï¼Ÿ[true]
15:46:58.344 [å°å—] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
```

é—®é¢˜å¦‚ä¸‹ï¼š

* è§£å†³äº†å…¶å®ƒå¹²æ´»çš„çº¿ç¨‹é˜»å¡çš„é—®é¢˜ï¼Œä½†å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…æ¡ä»¶å‘¢ï¼Ÿä¼šä¸ä¼šå«é†’äº†å…¶ä»–çº¿ç¨‹ï¼Ÿ



#### notify è™šå‡å”¤é†’ + notifyAll

```java
@Slf4j(topic = "TestWaitNotify")
public class TestWaitNotify {

    static final Object room = new Object();
    static boolean hasCigarette = false;// æœ‰çƒŸå—
    static boolean hasTakeout = false;// æœ‰å¤–å–å—


    public static void main(String[] args) throws InterruptedException {
        // step1();
        // step2();
        step3();
    }

    private static void step3() throws InterruptedException {
        new Thread(() -> {
            synchronized (room) {
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                if (!hasCigarette) {
                    log.debug("æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼");
                    try {
                        room.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                if (hasCigarette) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                }
            }
        }, "å°å—").start();

        new Thread(() -> {
            synchronized (room) {
                Thread thread = Thread.currentThread();
                log.debug("å¤–å–é€åˆ°æ²¡ï¼Ÿ[{}]", hasTakeout);
                if (!hasTakeout) {
                    log.debug("æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼");
                    try {
                        room.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                log.debug("å¤–å–é€åˆ°æ²¡ï¼Ÿ[{}]", hasTakeout);
                if (hasTakeout) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                } else {
                    log.debug("æ²¡å¹²æˆæ´»...");
                }
            }
        }, "å°å¥³").start();

        for (int i = 0; i < 5; i++) {
            new Thread(() -> {
                synchronized (room) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                }
            }, "å…¶å®ƒäºº").start();
        }

        TimeUnit.SECONDS.sleep(1);
        // é€å¤–å–çš„æŠŠå°å—çº¿ç¨‹å”¤é†’äº†ï¼ï¼ï¼æ²¡å”¤é†’å°å¥³çº¿ç¨‹
        new Thread(() -> {
            synchronized (room) {
                hasTakeout = true;
                log.debug("å¤–å–åˆ°äº†å™¢ï¼");
                room.notify();
            }
        }, "é€å¤–å–çš„").start();
    }

}
```

ç»“æœå¦‚ä¸‹ï¼š

```
15:55:04.411 [å°å—] DEBUG TestWaitNotify - æœ‰çƒŸæ²¡ï¼Ÿ[false]
15:55:04.414 [å°å—] DEBUG TestWaitNotify - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼
15:55:04.414 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
15:55:04.414 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
15:55:04.414 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
15:55:04.414 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
15:55:04.415 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
15:55:04.415 [å°å¥³] DEBUG TestWaitNotify - å¤–å–é€åˆ°æ²¡ï¼Ÿ[false]
15:55:04.415 [å°å¥³] DEBUG TestWaitNotify - æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼
15:55:05.411 [é€å¤–å–çš„] DEBUG TestWaitNotify - å¤–å–åˆ°äº†å™¢ï¼
15:55:05.411 [å°å—] DEBUG TestWaitNotify - æœ‰çƒŸæ²¡ï¼Ÿ[false]
```

é—®é¢˜å¦‚ä¸‹ï¼š

*   notify åªèƒ½éšæœºå”¤é†’ä¸€ä¸ª WaitSet ä¸­çš„çº¿ç¨‹ï¼Œè¿™æ—¶å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå°±å¯èƒ½å”¤é†’ä¸äº†æ­£ç¡®çš„çº¿ç¨‹ï¼Œç§°ä¹‹ä¸ºã€è™šå‡å”¤é†’ã€‘
*   è§£å†³æ–¹æ³•ï¼Œæ”¹ä¸º notifyAllã€‚ç»“æœå¦‚ä¸‹ï¼š

```
16:04:01.018 [å°å—] DEBUG TestWaitNotify - æœ‰çƒŸæ²¡ï¼Ÿ[false]
16:04:01.022 [å°å—] DEBUG TestWaitNotify - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼
16:04:01.022 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
16:04:01.022 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
16:04:01.023 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
16:04:01.023 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
16:04:01.023 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
16:04:01.023 [å°å¥³] DEBUG TestWaitNotify - å¤–å–é€åˆ°æ²¡ï¼Ÿ[false]
16:04:01.023 [å°å¥³] DEBUG TestWaitNotify - æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼
16:04:02.019 [é€å¤–å–çš„] DEBUG TestWaitNotify - å¤–å–åˆ°äº†å™¢ï¼
16:04:02.020 [å°å¥³] DEBUG TestWaitNotify - å¤–å–é€åˆ°æ²¡ï¼Ÿ[true]
16:04:02.020 [å°å¥³] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
16:04:02.020 [å°å—] DEBUG TestWaitNotify - æœ‰çƒŸæ²¡ï¼Ÿ[false]
```

é—®é¢˜å¦‚ä¸‹ï¼š

* ç”¨ notifyAll ä»…è§£å†³æŸä¸ªçº¿ç¨‹çš„å”¤é†’é—®é¢˜ï¼Œä½†ä½¿ç”¨ if + wait åˆ¤æ–­ä»…æœ‰ä¸€æ¬¡æœºä¼šï¼Œä¸€æ—¦æ¡ä»¶ä¸æˆç«‹ï¼Œå°±æ²¡æœ‰é‡æ–°åˆ¤æ–­çš„æœºä¼šäº†
* è§£å†³æ–¹æ³•ï¼Œ**ç”¨ while + waitï¼Œå½“æ¡ä»¶ä¸æˆç«‹ï¼Œå†æ¬¡ wait**



#### while + wait + notifyAll ğŸ”¥

```java
@Slf4j(topic = "TestWaitNotify")
public class TestWaitNotify {

    static final Object room = new Object();
    static boolean hasCigarette = false;// æœ‰çƒŸå—
    static boolean hasTakeout = false;// æœ‰å¤–å–å—

    public static void main(String[] args) throws InterruptedException {
        step4();
    }

    /**
     * whileã€waitã€notifyAll æ–¹å¼
     */
    private static void step4() throws InterruptedException {
        new Thread(() -> {
            synchronized (room) {
                log.debug("æœ‰çƒŸæ²¡ï¼Ÿ[{}]", hasCigarette);
                while (!hasCigarette) {
                    log.debug("æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼");
                    try {
                        room.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                log.debug("æœ‰çƒŸäº†ï¼Œå¯ä»¥å¼€å§‹å¹²æ´»äº†");
            }
        }, "å°å—").start();

        new Thread(() -> {
            synchronized (room) {
                Thread thread = Thread.currentThread();
                log.debug("å¤–å–é€åˆ°æ²¡ï¼Ÿ[{}]", hasTakeout);
                while (!hasTakeout) {
                    log.debug("æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼");
                    try {
                        room.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                log.debug("æœ‰å¤–å–äº†ï¼Œå¯ä»¥å¼€å§‹å¹²æ´»äº†");
            }
        }, "å°å¥³").start();

        for (int i = 0; i < 5; i++) {
            new Thread(() -> {
                synchronized (room) {
                    log.debug("å¯ä»¥å¼€å§‹å¹²æ´»äº†");
                }
            }, "å…¶å®ƒäºº").start();
        }

        TimeUnit.SECONDS.sleep(1);
        // é€å¤–å–çš„æŠŠå°å—çº¿ç¨‹å”¤é†’äº†ï¼ï¼ï¼æ²¡å”¤é†’å°å¥³çº¿ç¨‹
        new Thread(() -> {
            synchronized (room) {
                hasTakeout = true;
                log.debug("å¤–å–åˆ°äº†å™¢ï¼");
                room.notifyAll();
            }
        }, "é€å¤–å–çš„").start();
    }

}
```





ç»“æœå¦‚ä¸‹ï¼š

```
16:12:11.012 [å°å—] DEBUG TestWaitNotify - æœ‰çƒŸæ²¡ï¼Ÿ[false]
16:12:11.015 [å°å—] DEBUG TestWaitNotify - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼
16:12:11.015 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
16:12:11.015 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
16:12:11.015 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
16:12:11.015 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
16:12:11.016 [å…¶å®ƒäºº] DEBUG TestWaitNotify - å¯ä»¥å¼€å§‹å¹²æ´»äº†
16:12:11.016 [å°å¥³] DEBUG TestWaitNotify - å¤–å–é€åˆ°æ²¡ï¼Ÿ[false]
16:12:11.016 [å°å¥³] DEBUG TestWaitNotify - æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼
16:12:12.012 [é€å¤–å–çš„] DEBUG TestWaitNotify - å¤–å–åˆ°äº†å™¢ï¼
16:12:12.013 [å°å¥³] DEBUG TestWaitNotify - æœ‰å¤–å–äº†ï¼Œå¯ä»¥å¼€å§‹å¹²æ´»äº†
16:12:12.013 [å°å—] DEBUG TestWaitNotify - æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼
```







### è®¾è®¡æ¨¡å¼â€”ä¿æŠ¤æ€§æš‚åœ ğŸ”¥

è§è®¾è®¡æ¨¡å¼



### join åŸç†â€”æºç 

```java
public final void join() throws InterruptedException {
    join(0);
}

public final synchronized void join(long millis)
    throws InterruptedException {
    long base = System.currentTimeMillis();
    long now = 0;

    if (millis < 0) {
        throw new IllegalArgumentException("timeout value is negative");
    }

    if (millis == 0) {
        while (isAlive()) {
            wait(0);
        }
    } else {
        while (isAlive()) {
            long delay = millis - now;
            if (delay <= 0) {
                break;
            }
            wait(delay);
            now = System.currentTimeMillis() - base;
        }
    }
}
```

join ä½“ç°çš„æ˜¯ã€ä¿æŠ¤æ€§æš‚åœã€‘æ¨¡å¼ï¼Œè¯·å‚è€ƒä¹‹



### è®¾è®¡æ¨¡å¼â€”ç”Ÿäº§è€…æ¶ˆè´¹è€… ğŸ”¥

è§è®¾è®¡æ¨¡å¼



## parkã€unpark ğŸ”¥

### åŸºæœ¬ä½¿ç”¨

å®ƒä»¬æ˜¯ LockSupport ç±»ä¸­çš„æ–¹æ³•

```java
// æš‚åœå½“å‰çº¿ç¨‹
LockSupport.park(); 
// æ¢å¤æŸä¸ªçº¿ç¨‹çš„è¿è¡Œ
LockSupport.unpark(æš‚åœçº¿ç¨‹å¯¹è±¡)
```

å…ˆ park å† unpark

```java
Thread t1 = new Thread(() -> {
    log.debug("start...");
    sleep(1);
    log.debug("park...");
    LockSupport.park();
    log.debug("resume...");
},"t1");
t1.start();

sleep(2);

log.debug("unpark...");
LockSupport.unpark(t1);
```

è¾“å‡º

```
18:42:52.585 c.TestParkUnpark [t1] - start... 
18:42:53.589 c.TestParkUnpark [t1] - park... 
18:42:54.583 c.TestParkUnpark [main] - unpark... 
18:42:54.583 c.TestParkUnpark [t1] - resume...
```

**å…ˆ unpark å† park**

```java
Thread t1 = new Thread(() -> {
    log.debug("start...");
    sleep(2);
    log.debug("park...");
    LockSupport.park();
    log.debug("resume...");
}, "t1");
t1.start();

sleep(1);

log.debug("unpark...");
LockSupport.unpark(t1);
```

è¾“å‡º

```
18:43:50.765 c.TestParkUnpark [t1] - start... 
18:43:51.764 c.TestParkUnpark [main] - unpark... 
18:43:52.769 c.TestParkUnpark [t1] - park... 
18:43:52.769 c.TestParkUnpark [t1] - resume...
```



### ç‰¹ç‚¹ ğŸ”¥

ä¸ Object çš„ wait & notify ç›¸æ¯”

*   **waitï¼Œnotify å’Œ notifyAll å¿…é¡»é…åˆ Object Monitor** ï¼ˆsyncï¼‰ä¸€èµ·ä½¿ç”¨ï¼Œ**è€Œ parkï¼Œunpark ä¸å¿…**
*   **park & unpark æ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½æ¥ã€é˜»å¡ã€‘å’Œã€å”¤é†’ã€‘çº¿ç¨‹**ï¼Œè€Œ notify åªèƒ½éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ŒnotifyAll æ˜¯å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œå°±ä¸é‚£ä¹ˆã€**ç²¾ç¡®**ã€‘
*   **park & unpark å¯ä»¥å…ˆ unparkï¼Œè€Œ wait & notify ä¸èƒ½å…ˆ notify**
*   parkåçº¿ç¨‹çŠ¶æ€æ˜¯ WAITING





### åº•å±‚åŸç† ğŸ”¥

æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ª Parker å¯¹è±¡ï¼ˆåº•å±‚Cå®ç°ï¼‰ï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆ `_counter` ï¼Œ `_cond` å’Œ `_mutex` æ‰“ä¸ªæ¯”å–»

*   çº¿ç¨‹å°±åƒä¸€ä¸ªæ—…äººï¼ŒParker å°±åƒä»–éšèº«æºå¸¦çš„èƒŒåŒ…ï¼Œ`_cond` æ¡ä»¶å˜é‡å°±å¥½æ¯”èƒŒåŒ…ä¸­çš„å¸ç¯·ã€‚`_counter` å°±å¥½æ¯”èƒŒåŒ…ä¸­çš„å¤‡ç”¨å¹²ç²®ï¼ˆ0 ä¸ºè€—å°½ï¼Œ1 ä¸ºå……è¶³ï¼‰
*   **è°ƒç”¨ park å°±æ˜¯è¦çœ‹éœ€ä¸éœ€è¦åœä¸‹æ¥æ­‡æ¯**
    *   å¦‚æœå¤‡ç”¨å¹²ç²®è€—å°½ï¼Œé‚£ä¹ˆé’»è¿›å¸ç¯·æ­‡æ¯
    *   å¦‚æœå¤‡ç”¨å¹²ç²®å……è¶³ï¼Œé‚£ä¹ˆä¸éœ€åœç•™ï¼Œç»§ç»­å‰è¿›
*   **è°ƒç”¨ unparkï¼Œå°±å¥½æ¯”ä»¤å¹²ç²®å……è¶³**
    *   å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨å¸ç¯·ï¼Œå°±å”¤é†’è®©ä»–ç»§ç»­å‰è¿›
    *   å¦‚æœè¿™æ—¶çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆä¸‹æ¬¡ä»–è°ƒç”¨ park æ—¶ï¼Œä»…æ˜¯æ¶ˆè€—æ‰å¤‡ç”¨å¹²ç²®ï¼Œä¸éœ€åœç•™ç»§ç»­å‰è¿›
        *   å› ä¸ºèƒŒåŒ…ç©ºé—´æœ‰é™ï¼Œå¤šæ¬¡è°ƒç”¨ unpark ä»…ä¼šè¡¥å……ä¸€ä»½å¤‡ç”¨å¹²ç²®

æµç¨‹å¦‚ä¸‹ï¼š

![image-20210222003332613](../images/image-20210222003332613.png)

1.  å½“å‰çº¿ç¨‹è°ƒç”¨ Unsafe.park() æ–¹æ³•

2.  æ£€æŸ¥ _counter ï¼Œæœ¬æƒ…å†µä¸º 0ï¼Œè¿™æ—¶ï¼Œè·å¾— _mutex äº’æ–¥é”
3.  çº¿ç¨‹è¿›å…¥ _cond æ¡ä»¶å˜é‡é˜»å¡
4.  è®¾ç½® _counter = 0ï¼ï¼ï¼æœ¬æ¥å°±æ˜¯0

![image-20210222003428179](../images/image-20210222003428179.png)

1.   è°ƒç”¨ Unsafe.unpark(Thread_0) æ–¹æ³•ï¼Œè®¾ç½® _counter ä¸º 1
2.  å”¤é†’ _cond æ¡ä»¶å˜é‡ä¸­çš„ Thread_0
3.  Thread_0 æ¢å¤è¿è¡Œ
4.  è®¾ç½® _counter ä¸º 0ï¼ï¼ï¼å› ä¸ºè¿è¡Œäº†æ¶ˆè€—æ‰€ä»¥åˆæ”¹ä¸º0

![image-20210222003456287](../images/image-20210222003456287.png)

1.  è°ƒç”¨ Unsafe.unpark(Thread_0) æ–¹æ³•ï¼Œè®¾ç½® _counter ä¸º 1
2.  å½“å‰çº¿ç¨‹è°ƒç”¨ Unsafe.park() æ–¹æ³•
3.  æ£€æŸ¥ _counter ï¼Œæœ¬æƒ…å†µä¸º 1ï¼Œè¿™æ—¶çº¿ç¨‹**æ— éœ€é˜»å¡ï¼Œç»§ç»­è¿è¡Œ**
4.  è®¾ç½® _counter ä¸º 0ï¼ï¼ï¼å› ä¸ºè¿è¡Œäº†æ¶ˆè€—æ‰€ä»¥åˆæ”¹ä¸º0







## å¤šæŠŠé”â€”é”ç²’åº¦ ğŸ”¥

ä¸€é—´å¤§å±‹å­æœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼šç¡è§‰ã€å­¦ä¹ ï¼Œäº’ä¸ç›¸å¹²ã€‚ç°åœ¨å°å—è¦å­¦ä¹ ï¼Œå°å¥³è¦ç¡è§‰ï¼Œä½†å¦‚æœåªç”¨ä¸€é—´å±‹å­ï¼ˆä¸€ä¸ªå¯¹è±¡é”ï¼‰çš„è¯ï¼Œé‚£ä¹ˆå¹¶å‘åº¦å¾ˆä½ã€‚è§£å†³æ–¹æ³•æ˜¯å‡†å¤‡å¤šä¸ªæˆ¿é—´ï¼ˆå¤šä¸ªå¯¹è±¡é”ï¼‰

ä¾‹å¦‚ï¼š

```java
class BigRoom {
    public void sleep() {
        synchronized (this) {
            log.debug("sleeping 2 å°æ—¶");
            Sleeper.sleep(2);
        }
    }
    public void study() {
        synchronized (this) {
            log.debug("study 1 å°æ—¶");
            Sleeper.sleep(1);
        }
    }
}

public class Test {
    public static void main(String[] args) {
        BigRoom bigRoom = new BigRoom();
        
        new Thread(() -> {
            bigRoom.compute();
        },"å°å—").start();
        
        new Thread(() -> {
            bigRoom.sleep();
        },"å°å¥³").start();
    }
}
```

æŸæ¬¡ç»“æœ

```
12:13:54.471 [å°å—] c.BigRoom - study 1 å°æ—¶
12:13:55.476 [å°å¥³] c.BigRoom - sleeping 2 å°æ—¶
```

æ”¹è¿›

```java
class BigRoom {
    private final Object studyRoom = new Object();
    private final Object bedRoom = new Object();
    
    public void sleep() {
        synchronized (bedRoom) {
            log.debug("sleeping 2 å°æ—¶");
            Sleeper.sleep(2);
        }
    }
    
    public void study() {
        synchronized (studyRoom) {
            log.debug("study 1 å°æ—¶");
            Sleeper.sleep(1);
        }
    }
}
public class Test {
    public static void main(String[] args) {
        BigRoom bigRoom = new BigRoom();
        
        new Thread(() -> {
            bigRoom.compute();
        },"å°å—").start();
        
        new Thread(() -> {
            bigRoom.sleep();
        },"å°å¥³").start();
    }
}
```

æŸæ¬¡æ‰§è¡Œç»“æœ

```
12:15:35.069 [å°å—] c.BigRoom - study 1 å°æ—¶
12:15:35.069 [å°å¥³] c.BigRoom - sleeping 2 å°æ—¶
```

å°†**é”çš„ç²’åº¦ç»†åˆ†**ï¼ˆä¸šåŠ¡èµ„æºæ˜¯æ²¡æœ‰å…³è”çš„ï¼Œå¦åˆ™æ— æ³•ç»†åˆ†ï¼‰

*   å¥½å¤„ï¼Œæ˜¯å¯ä»¥**å¢å¼ºå¹¶å‘åº¦**

*   åå¤„ï¼Œ**å¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œå°±å®¹æ˜“å‘ç”Ÿæ­»é”**





## çº¿ç¨‹æ´»è·ƒæ€§ ğŸ”¥

### æ­»é” ğŸ”¥

æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„çº¿ç¨‹åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå› **äº‰å¤ºèµ„æº**äº§ç”Ÿçš„ä¸€ç§**äº’ç›¸ç­‰å¾…**ç°è±¡ã€‚ä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å–å¤šæŠŠé”ï¼Œè¿™æ—¶å°±å®¹æ˜“å‘ç”Ÿæ­»é”

ä¸è¦ä½¿ç”¨ String æ¥åšé”ã€‚å¦‚ï¼šString s1 = "Hello" å’Œ String s2 = "Hello" å…¶å®æ˜¯åŒä¸€æŠŠé”ï¼›è¿˜ä¼šå¯èƒ½ä¸å…¶ä»–ç±»åº“å‘ç”Ÿæ­»é”ã€‚

t1 çº¿ç¨‹ è·å¾— Aå¯¹è±¡ é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å– Bå¯¹è±¡ çš„é” t2 çº¿ç¨‹ è·å¾— Bå¯¹è±¡ é”ï¼Œæ¥ä¸‹æ¥æƒ³è·å– Aå¯¹è±¡çš„é”ã€‚ä¾‹ï¼š

```java
public class DeadLock {
    private static final Object lock1 = new Object();
    private static final Object lock2 = new Object();

    public static void main(String[] args) {
        new Thread(() -> {
            synchronized (lock1) {
                System.out.println("t1 get lock1");
                // å¯åœ¨æ­¤å¤„sleepæé«˜æ­»é”æ¦‚ç‡
                synchronized (lock2) {
                    System.out.println("t1 get lock2");
                }
            }
        }, "t1").start();

        new Thread(() -> {
            synchronized (lock2) {
                System.out.println("t2 get lock2");
                // å¯åœ¨æ­¤å¤„sleepæé«˜æ­»é”æ¦‚ç‡
                synchronized (lock1) {
                    System.out.println("t2 get lock1");
                }
            }
        }, "t2").start();
    }
}
```

å¯èƒ½å‡ºç°çš„ç»“æœæœ‰ï¼š

```
// 1 æ­£å¸¸
t1 get lock1
t1 get lock2
t2 get lock2
t2 get lock1

// 2 æ­£å¸¸
t2 get lock2
t2 get lock1
t1 get lock1
t1 get lock2

// 3 æ­»é”
t1 get lock1
t2 get lock2

// 4 æ­»é”
t2 get lock2
t1 get lock1
```



### å®šä½æ­»é”â€”jps jstack sconsole ğŸ”¥

 `jps` æ‰§è¡Œå

```
51203 RemoteMavenServer36
51204 RemoteMavenServer36
26357
51205 RemoteMavenServer36
95943 DeadLock
95942 Launcher
96462 Jps
```

 `jstack 95943`æŸ¥çœ‹ 95943 DeadLock

```
2021-02-23 21:51:28
Full thread dump OpenJDK 64-Bit Server VM (25.232-b09 mixed mode):

"Attach Listener" #14 daemon prio=9 os_prio=31 tid=0x00007fba44086800 nid=0xa203 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"DestroyJavaVM" #13 prio=5 os_prio=31 tid=0x00007fba4604e800 nid=0xe03 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"t2" #12 prio=5 os_prio=31 tid=0x00007fba4604d800 nid=0x5b03 waiting for monitor entry [0x00007000111df000]
   java.lang.Thread.State: BLOCKED (on object monitor)
	at _12_deadlock.DeadLock.lambda$main$1(DeadLock.java:30)
	- waiting to lock <0x000000076ac2dc88> (a java.lang.Object)
	- locked <0x000000076ac2dc98> (a java.lang.Object)
	at _12_deadlock.DeadLock$$Lambda$2/764977973.run(Unknown Source)
	at java.lang.Thread.run(Thread.java:748)

"t1" #11 prio=5 os_prio=31 tid=0x00007fba4604d000 nid=0x5903 waiting for monitor entry [0x00007000110dc000]
   java.lang.Thread.State: BLOCKED (on object monitor)
	at _12_deadlock.DeadLock.lambda$main$0(DeadLock.java:20)
	- waiting to lock <0x000000076ac2dc98> (a java.lang.Object)
	- locked <0x000000076ac2dc88> (a java.lang.Object)
	at _12_deadlock.DeadLock$$Lambda$1/1452126962.run(Unknown Source)
	at java.lang.Thread.run(Thread.java:748)

"Service Thread" #10 daemon prio=9 os_prio=31 tid=0x00007fba44828800 nid=0xa603 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"C1 CompilerThread3" #9 daemon prio=9 os_prio=31 tid=0x00007fba45032800 nid=0x5703 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"C2 CompilerThread2" #8 daemon prio=9 os_prio=31 tid=0x00007fba45032000 nid=0xa703 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"C2 CompilerThread1" #7 daemon prio=9 os_prio=31 tid=0x00007fba45031000 nid=0xa903 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"C2 CompilerThread0" #6 daemon prio=9 os_prio=31 tid=0x00007fba49821800 nid=0x4203 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"Monitor Ctrl-Break" #5 daemon prio=5 os_prio=31 tid=0x00007fba4981f800 nid=0x4103 runnable [0x00007000109c7000]
   java.lang.Thread.State: RUNNABLE
	at java.net.SocketInputStream.socketRead0(Native Method)
	at java.net.SocketInputStream.socketRead(SocketInputStream.java:116)
	at java.net.SocketInputStream.read(SocketInputStream.java:171)
	at java.net.SocketInputStream.read(SocketInputStream.java:141)
	at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:284)
	at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:326)
	at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:178)
	- locked <0x000000076ac7af78> (a java.io.InputStreamReader)
	at java.io.InputStreamReader.read(InputStreamReader.java:184)
	at java.io.BufferedReader.fill(BufferedReader.java:161)
	at java.io.BufferedReader.readLine(BufferedReader.java:324)
	- locked <0x000000076ac7af78> (a java.io.InputStreamReader)
	at java.io.BufferedReader.readLine(BufferedReader.java:389)
	at com.intellij.rt.execution.application.AppMainV2$1.run(AppMainV2.java:61)

"Signal Dispatcher" #4 daemon prio=9 os_prio=31 tid=0x00007fba4a00b000 nid=0x3f07 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"Finalizer" #3 daemon prio=8 os_prio=31 tid=0x00007fba4a008800 nid=0x3403 in Object.wait() [0x0000700010638000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	- waiting on <0x000000076ab08ed8> (a java.lang.ref.ReferenceQueue$Lock)
	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:144)
	- locked <0x000000076ab08ed8> (a java.lang.ref.ReferenceQueue$Lock)
	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:165)
	at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:216)

"Reference Handler" #2 daemon prio=10 os_prio=31 tid=0x00007fba4481d800 nid=0x4d03 in Object.wait() [0x0000700010535000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	- waiting on <0x000000076ab06c00> (a java.lang.ref.Reference$Lock)
	at java.lang.Object.wait(Object.java:502)
	at java.lang.ref.Reference.tryHandlePending(Reference.java:191)
	- locked <0x000000076ab06c00> (a java.lang.ref.Reference$Lock)
	at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:153)

"VM Thread" os_prio=31 tid=0x00007fba44016800 nid=0x4f03 runnable

"GC task thread#0 (ParallelGC)" os_prio=31 tid=0x00007fba4480e800 nid=0x1c07 runnable

"GC task thread#1 (ParallelGC)" os_prio=31 tid=0x00007fba4480f000 nid=0x2003 runnable

"GC task thread#2 (ParallelGC)" os_prio=31 tid=0x00007fba4400c000 nid=0x1e03 runnable

"GC task thread#3 (ParallelGC)" os_prio=31 tid=0x00007fba4400c800 nid=0x2a03 runnable

"GC task thread#4 (ParallelGC)" os_prio=31 tid=0x00007fba4481a800 nid=0x5303 runnable

"GC task thread#5 (ParallelGC)" os_prio=31 tid=0x00007fba4400d000 nid=0x5103 runnable

"GC task thread#6 (ParallelGC)" os_prio=31 tid=0x00007fba4400d800 nid=0x2c03 runnable

"GC task thread#7 (ParallelGC)" os_prio=31 tid=0x00007fba4400e800 nid=0x2e03 runnable

"GC task thread#8 (ParallelGC)" os_prio=31 tid=0x00007fba46008800 nid=0x2f03 runnable

"GC task thread#9 (ParallelGC)" os_prio=31 tid=0x00007fba46009000 nid=0x3103 runnable

"VM Periodic Task Thread" os_prio=31 tid=0x00007fba4604c000 nid=0xa403 waiting on condition

JNI global references: 320


Found one Java-level deadlock:
=============================
"t2":
  waiting to lock monitor 0x00007fba4603deb8 (object 0x000000076ac2dc88, a java.lang.Object),
  which is held by "t1"
"t1":
  waiting to lock monitor 0x00007fba4603f2a8 (object 0x000000076ac2dc98, a java.lang.Object),
  which is held by "t2"

Java stack information for the threads listed above:
===================================================
"t2":
	at _12_deadlock.DeadLock.lambda$main$1(DeadLock.java:30)
	- waiting to lock <0x000000076ac2dc88> (a java.lang.Object)
	- locked <0x000000076ac2dc98> (a java.lang.Object)
	at _12_deadlock.DeadLock$$Lambda$2/764977973.run(Unknown Source)
	at java.lang.Thread.run(Thread.java:748)
"t1":
	at _12_deadlock.DeadLock.lambda$main$0(DeadLock.java:20)
	- waiting to lock <0x000000076ac2dc98> (a java.lang.Object)
	- locked <0x000000076ac2dc88> (a java.lang.Object)
	at _12_deadlock.DeadLock$$Lambda$1/1452126962.run(Unknown Source)
	at java.lang.Thread.run(Thread.java:748)

Found 1 deadlock.
```

çœ‹ Found one Java-level deadlock: å³å¯çŸ¥é“ï¼št2çº¿ç¨‹æ‹¥æœ‰98çš„é”ï¼Œç­‰å¾…88çš„é”ï¼Œt1çº¿ç¨‹ç›¸å

 `jconsole`ä¸“é—¨æœ‰æ£€æµ‹æ­»é”æŒ‰é’®



### å“²å­¦å®¶å°±é¤é—®é¢˜ ğŸ”¥

![image-20210223220035029](../images/image-20210223220035029.png)

æœ‰äº”ä½å“²å­¦å®¶ï¼Œå›´ååœ¨åœ†æ¡Œæ—ã€‚

* ä»–ä»¬åªåšä¸¤ä»¶äº‹ï¼Œæ€è€ƒå’Œåƒé¥­ï¼Œæ€è€ƒä¸€ä¼šåƒå£é¥­ï¼Œåƒå®Œé¥­åæ¥ç€æ€è€ƒã€‚

*   åƒé¥­æ—¶è¦ç”¨ä¸¤æ ¹ç­·å­åƒï¼Œæ¡Œä¸Šå…±æœ‰ 5 æ ¹ç­·å­ï¼Œæ¯ä½å“²å­¦å®¶å·¦å³æ‰‹è¾¹å„æœ‰ä¸€æ ¹ç­·å­ã€‚

*   å¦‚æœç­·å­è¢«èº«è¾¹çš„äººæ‹¿ç€ï¼Œè‡ªå·±å°±å¾—ç­‰å¾…

```java
/**
 * ç­·å­
 */
class Chopstick {

    String name;

    public Chopstick(String name) {
        this.name = name;
    }

    @Override
    public String toString() {
        return "ç­·å­{" + name + '}';
    }
}


/**
 * å“²å­¦å®¶
 */
@Slf4j(topic = "Philosopher")
class Philosopher extends Thread {

    // ç­·å­å……å½“é”
    final Chopstick left;
    final Chopstick right;

    public Philosopher(String name, Chopstick left, Chopstick right) {
        super(name);
        this.left = left;
        this.right = right;
    }

    @Override
    public void run() {
        while (true) {
            // è·å¾—å·¦æ‰‹ç­·å­
            synchronized (left) {
                // è·å¾—å³æ‰‹ç­·å­
                synchronized (right) {
                    try {
                        // åƒé¥­
                        log.debug("eating...");
                        TimeUnit.SECONDS.sleep(1);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                // æ”¾ä¸‹å³æ‰‹ç­·å­
            }
            // æ”¾ä¸‹å·¦æ‰‹ç­·å­
        }
    }
}


public class TestPhilosopher {

    public static void main(String[] args) {

        Chopstick c1 = new Chopstick("ç­·å­1");
        Chopstick c2 = new Chopstick("ç­·å­2");
        Chopstick c3 = new Chopstick("ç­·å­3");
        Chopstick c4 = new Chopstick("ç­·å­4");
        Chopstick c5 = new Chopstick("ç­·å­5");
        new Philosopher("è‹æ ¼æ‹‰åº•", c1, c2).start();
        new Philosopher("æŸæ‹‰å›¾", c2, c3).start();
        new Philosopher("äºšé‡Œå£«å¤šå¾·", c3, c4).start();
        new Philosopher("èµ«æ‹‰å…‹åˆ©ç‰¹", c4, c5).start();
        new Philosopher("é˜¿åŸºç±³å¾·", c5, c1).start();
    }
}
```

æ‰§è¡Œä¸å¤šä¼šï¼Œå°±æ‰§è¡Œä¸ä¸‹å»äº†

```
22:07:22.593 [äºšé‡Œå£«å¤šå¾·] DEBUG Philosopher - eating...
22:07:23.594 [äºšé‡Œå£«å¤šå¾·] DEBUG Philosopher - eating...
```

ä½¿ç”¨`jstack`æ£€æŸ¥æ­»é”

```
2021-02-23 22:08:26
Full thread dump OpenJDK 64-Bit Server VM (25.232-b09 mixed mode):

"Attach Listener" #17 daemon prio=9 os_prio=31 tid=0x00007fc28d117800 nid=0x9c03 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"DestroyJavaVM" #16 prio=5 os_prio=31 tid=0x00007fc28c85a000 nid=0x1203 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"é˜¿åŸºç±³å¾·" #15 prio=5 os_prio=31 tid=0x00007fc28d81d800 nid=0x9d03 waiting for monitor entry [0x0000700004070000]
   java.lang.Thread.State: BLOCKED (on object monitor)
	at _12_deadlock.Philosopher.run(TestPhilosopher.java:51)
	- waiting to lock <0x000000076ac2fd40> (a _12_deadlock.Chopstick)
	- locked <0x000000076ac2fe40> (a _12_deadlock.Chopstick)

"èµ«æ‹‰å…‹ï¿½ï¿½ç‰¹" #14 prio=5 os_prio=31 tid=0x00007fc293808800 nid=0x5b03 waiting for monitor entry [0x0000700003f6d000]
   java.lang.Thread.State: BLOCKED (on object monitor)
	at _12_deadlock.Philosopher.run(TestPhilosopher.java:51)
	- waiting to lock <0x000000076ac2fe40> (a _12_deadlock.Chopstick)
	- locked <0x000000076ac2fe00> (a _12_deadlock.Chopstick)

"äºšé‡Œå£«å¤šå¾·" #13 prio=5 os_prio=31 tid=0x00007fc292018800 nid=0xa003 waiting for monitor entry [0x0000700003e6a000]
   java.lang.Thread.State: BLOCKED (on object monitor)
	at _12_deadlock.Philosopher.run(TestPhilosopher.java:51)
	- waiting to lock <0x000000076ac2fe00> (a _12_deadlock.Chopstick)
	- locked <0x000000076ac2fdc0> (a _12_deadlock.Chopstick)

"æŸæ‹‰å›¾" #12 prio=5 os_prio=31 tid=0x00007fc28d113000 nid=0x5a03 waiting for monitor entry [0x0000700003d67000]
   java.lang.Thread.State: BLOCKED (on object monitor)
	at _12_deadlock.Philosopher.run(TestPhilosopher.java:51)
	- waiting to lock <0x000000076ac2fdc0> (a _12_deadlock.Chopstick)
	- locked <0x000000076ac2fd80> (a _12_deadlock.Chopstick)

"è‹æ ¼æ‹‰åº•" #11 prio=5 os_prio=31 tid=0x00007fc28b86c000 nid=0xa303 waiting for monitor entry [0x0000700003c64000]
   java.lang.Thread.State: BLOCKED (on object monitor)
	at _12_deadlock.Philosopher.run(TestPhilosopher.java:51)
	- waiting to lock <0x000000076ac2fd80> (a _12_deadlock.Chopstick)
	- locked <0x000000076ac2fd40> (a _12_deadlock.Chopstick)

"Service Thread" #10 daemon prio=9 os_prio=31 tid=0x00007fc29282d800 nid=0x5803 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"C1 CompilerThread3" #9 daemon prio=9 os_prio=31 tid=0x00007fc29281d000 nid=0x5703 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"C2 CompilerThread2" #8 daemon prio=9 os_prio=31 tid=0x00007fc292814000 nid=0x5603 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"C2 CompilerThread1" #7 daemon prio=9 os_prio=31 tid=0x00007fc292813800 nid=0xa903 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"C2 CompilerThread0" #6 daemon prio=9 os_prio=31 tid=0x00007fc28d089800 nid=0x3f03 waiting on condition [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"Monitor Ctrl-Break" #5 daemon prio=5 os_prio=31 tid=0x00007fc28d05a000 nid=0x4003 runnable [0x000070000354f000]
   java.lang.Thread.State: RUNNABLE
	at java.net.SocketInputStream.socketRead0(Native Method)
	at java.net.SocketInputStream.socketRead(SocketInputStream.java:116)
	at java.net.SocketInputStream.read(SocketInputStream.java:171)
	at java.net.SocketInputStream.read(SocketInputStream.java:141)
	at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:284)
	at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:326)
	at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:178)
	- locked <0x000000076ac7ac70> (a java.io.InputStreamReader)
	at java.io.InputStreamReader.read(InputStreamReader.java:184)
	at java.io.BufferedReader.fill(BufferedReader.java:161)
	at java.io.BufferedReader.readLine(BufferedReader.java:324)
	- locked <0x000000076ac7ac70> (a java.io.InputStreamReader)
	at java.io.BufferedReader.readLine(BufferedReader.java:389)
	at com.intellij.rt.execution.application.AppMainV2$1.run(AppMainV2.java:61)

"Signal Dispatcher" #4 daemon prio=9 os_prio=31 tid=0x00007fc28c80e000 nid=0x4207 runnable [0x0000000000000000]
   java.lang.Thread.State: RUNNABLE

"Finalizer" #3 daemon prio=8 os_prio=31 tid=0x00007fc291808800 nid=0x3303 in Object.wait() [0x00007000031c0000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	- waiting on <0x000000076ab08ed8> (a java.lang.ref.ReferenceQueue$Lock)
	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:144)
	- locked <0x000000076ab08ed8> (a java.lang.ref.ReferenceQueue$Lock)
	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:165)
	at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:216)

"Reference Handler" #2 daemon prio=10 os_prio=31 tid=0x00007fc28b818800 nid=0x4d03 in Object.wait() [0x00007000030bd000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	- waiting on <0x000000076ab06c00> (a java.lang.ref.Reference$Lock)
	at java.lang.Object.wait(Object.java:502)
	at java.lang.ref.Reference.tryHandlePending(Reference.java:191)
	- locked <0x000000076ab06c00> (a java.lang.ref.Reference$Lock)
	at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:153)

"VM Thread" os_prio=31 tid=0x00007fc28d04f000 nid=0x4f03 runnable

"GC task thread#0 (ParallelGC)" os_prio=31 tid=0x00007fc28b816000 nid=0x2007 runnable

"GC task thread#1 (ParallelGC)" os_prio=31 tid=0x00007fc28d808800 nid=0x1b03 runnable

"GC task thread#2 (ParallelGC)" os_prio=31 tid=0x00007fc28e008800 nid=0x1c03 runnable

"GC task thread#3 (ParallelGC)" os_prio=31 tid=0x00007fc28d809000 nid=0x2a03 runnable

"GC task thread#4 (ParallelGC)" os_prio=31 tid=0x00007fc28e009000 nid=0x2b03 runnable

"GC task thread#5 (ParallelGC)" os_prio=31 tid=0x00007fc28e808800 nid=0x2c03 runnable

"GC task thread#6 (ParallelGC)" os_prio=31 tid=0x00007fc28e009800 nid=0x2e03 runnable

"GC task thread#7 (ParallelGC)" os_prio=31 tid=0x00007fc28d809800 nid=0x3003 runnable

"GC task thread#8 (ParallelGC)" os_prio=31 tid=0x00007fc28d80a000 nid=0x5103 runnable

"GC task thread#9 (ParallelGC)" os_prio=31 tid=0x00007fc28d00b000 nid=0x3203 runnable

"VM Periodic Task Thread" os_prio=31 tid=0x00007fc28b820000 nid=0xa403 waiting on condition

JNI global references: 15


Found one Java-level deadlock:
=============================
"é˜¿åŸºç±³å¾·":
  waiting to lock monitor 0x00007fc28b8708b8 (object 0x000000076ac2fd40, a _12_deadlock.Chopstick),
  which is held by "è‹æ ¼æ‹‰åº•"
"è‹æ ¼æ‹‰åº•":
  waiting to lock monitor 0x00007fc28b86dc08 (object 0x000000076ac2fd80, a _12_deadlock.Chopstick),
  which is held by "ï¿½ï¿½æ‹‰å›¾"
"æŸæ‹‰å›¾":
  waiting to lock monitor 0x00007fc28b86db58 (object 0x000000076ac2fdc0, a _12_deadlock.Chopstick),
  which is held by "äºšé‡Œå£«å¤šå¾·"
"äºšé‡Œå£«å¤šå¾·":
  waiting to lock monitor 0x00007fc28b870808 (object 0x000000076ac2fe00, a _12_deadlock.Chopstick),
  which is held by "èµ«æ‹‰å…‹åˆ©ç‰¹"
"èµ«æ‹‰å…‹åˆ©ç‰¹":
  waiting to lock monitor 0x00007fc28b870758 (object 0x000000076ac2fe40, a _12_deadlock.Chopstick),
  which is held by "é˜¿åŸºç±³å¾·"

Java stack information for the threads listed above:
===================================================
"é˜¿åŸºç±³å¾·":
	at _12_deadlock.Philosopher.run(TestPhilosopher.java:51)
	- waiting to lock <0x000000076ac2fd40> (a _12_deadlock.Chopstick)
	- locked <0x000000076ac2fe40> (a _12_deadlock.Chopstick)
"è‹æ ¼æ‹‰åº•":
	at _12_deadlock.Philosopher.run(TestPhilosopher.java:51)
	- waiting to lock <0x000000076ac2fd80> (a _12_deadlock.Chopstick)
	- locked <0x000000076ac2fd40> (a _12_deadlock.Chopstick)
"æŸæ‹‰å›¾":
	at _12_deadlock.Philosopher.run(TestPhilosopher.java:51)
	- waiting to lock <0x000000076ac2fdc0> (a _12_deadlock.Chopstick)
	- locked <0x000000076ac2fd80> (a _12_deadlock.Chopstick)
"äºšé‡Œå£«å¤šå¾·":
	at _12_deadlock.Philosopher.run(TestPhilosopher.java:51)
	- waiting to lock <0x000000076ac2fe00> (a _12_deadlock.Chopstick)
	- locked <0x000000076ac2fdc0> (a _12_deadlock.Chopstick)
"èµ«æ‹‰å…‹åˆ©ç‰¹":
	at _12_deadlock.Philosopher.run(TestPhilosopher.java:51)
	- waiting to lock <0x000000076ac2fe40> (a _12_deadlock.Chopstick)
	- locked <0x000000076ac2fe00> (a _12_deadlock.Chopstick)

Found 1 deadlock.
```

è¿™ç§çº¿ç¨‹æ²¡æœ‰æŒ‰é¢„æœŸç»“æŸï¼Œæ‰§è¡Œä¸ä¸‹å»çš„æƒ…å†µï¼Œå½’ç±»ä¸ºã€æ´»è·ƒæ€§ã€‘é—®é¢˜ï¼Œé™¤äº†æ­»é”ä»¥å¤–ï¼Œè¿˜æœ‰æ´»é”å’Œé¥¥é¥¿è€…ä¸¤ç§æƒ…å†µ



### æ´»é” ğŸ”¥

æ´»é”å‡ºç°åœ¨ä¸¤ä¸ªçº¿ç¨‹**äº’ç›¸æ”¹å˜å¯¹æ–¹çš„ç»“æŸæ¡ä»¶**ï¼Œæœ€åè°ä¹Ÿæ— æ³•ç»“æŸï¼Œä¾‹å¦‚

```java
@Slf4j(topic = "LiveLock")
public class LiveLock {

    static volatile int count = 10;

    static final Object lock = new Object();

    public static void main(String[] args) {

        new Thread(() -> {
            // æœŸæœ›å‡åˆ° 0 é€€å‡ºå¾ªç¯
            while (count > 0) {
                try {
                    TimeUnit.MILLISECONDS.sleep(200);
                    count--;
                    log.debug("count: {}", count);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }

            }
        }, "t1").start();
        new Thread(() -> {
            // æœŸæœ›è¶…è¿‡ 20 é€€å‡ºå¾ªç¯
            while (count < 20) {
                try {
                    TimeUnit.MILLISECONDS.sleep(200);
                    count++;
                    log.debug("count: {}", count);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "t2").start();
    }
}
```

è§£å†³ï¼š

*   å¯ä»¥è®©çº¿ç¨‹äº¤é”™å¼€ï¼ŒåŒæ­¥æ‰§è¡Œï¼›
*   å¢åŠ éšæœºç¡çœ æ—¶é—´æ¥é¿å…



### é¥¥é¥¿â€”reentrantlockè§£å†³ ğŸ”¥

å¾ˆå¤šæ•™ç¨‹ä¸­æŠŠé¥¥é¥¿å®šä¹‰ä¸ºï¼Œä¸€ä¸ªçº¿ç¨‹ç”±äº**ä¼˜å…ˆçº§å¤ªä½**ï¼Œ**å§‹ç»ˆå¾—ä¸åˆ° CPU è°ƒåº¦æ‰§è¡Œ**ï¼Œ**ä¹Ÿä¸èƒ½å¤Ÿç»“æŸ**ï¼Œé¥¥é¥¿çš„æƒ…å†µä¸æ˜“æ¼”ç¤ºï¼Œè®²**è¯»å†™é”**æ—¶ä¼šæ¶‰åŠé¥¥é¥¿é—®é¢˜

ä¸‹é¢æˆ‘è®²ä¸€ä¸‹æˆ‘é‡åˆ°çš„ä¸€ä¸ªçº¿ç¨‹é¥¥é¥¿çš„ä¾‹å­ï¼Œå…ˆæ¥çœ‹çœ‹ä½¿ç”¨**é¡ºåºåŠ é”**çš„æ–¹å¼è§£å†³ä¹‹å‰çš„æ­»é”é—®é¢˜

```mermaid
sequenceDiagram
participant t1 as çº¿ç¨‹1
participant t2 as çº¿ç¨‹2
participant o1 as å¯¹è±¡1
participant o2 as å¯¹è±¡2
	t1 ->> o1: å°è¯•è·å–é”
	note over t1,o1: æ‹¥æœ‰é”
	
	t2 ->> o2: å°è¯•è·å–é”
	note over t2,o2: æ‹¥æœ‰é”
	
	t1 -x o2 : å°è¯•è·å–é”ï¼Œè¢«é˜»å¡ï¼ˆBLOCKEDï¼‰
	t2 -x o1 : å°è¯•è·å–é”ï¼Œè¢«é˜»å¡ï¼ˆBLOCKEDï¼‰
```

é¡ºåºåŠ é”çš„è§£å†³æ–¹æ¡ˆ

```mermaid
sequenceDiagram
participant t1 as çº¿ç¨‹1
participant t2 as çº¿ç¨‹2
participant o1 as å¯¹è±¡1
participant o2 as å¯¹è±¡2
	t1 ->> o1: å°è¯•è·å–é”
	note over t1,o1: æ‹¥æœ‰é”
	
	t2 -x o1 : å°è¯•è·å–é”ï¼Œè¢«é˜»å¡ï¼ˆBLOCKEDï¼‰
	
	t1 ->> o2: å°è¯•è·å–é”
	note over t1,o2: æ‹¥æœ‰é”	
```

ä½†æ˜¯é¡ºåºåŠ é”å®¹æ˜“å‡ºç°é¥¥é¥¿é—®é¢˜ï¼š

```java
/**
 * ç­·å­
 */
class Chopstick {

    String name;

    public Chopstick(String name) {
        this.name = name;
    }

    @Override
    public String toString() {
        return "ç­·å­{" + name + '}';
    }
}


/**
 * å“²å­¦å®¶
 */
@Slf4j(topic = "Philosopher")
class Philosopher extends Thread {

    // ç­·å­å……å½“é”
    final Chopstick left;
    final Chopstick right;

    public Philosopher(String name, Chopstick left, Chopstick right) {
        super(name);
        this.left = left;
        this.right = right;
    }

    @Override
    public void run() {
        while (true) {
            // è·å¾—å·¦æ‰‹ç­·å­
            synchronized (left) {
                // è·å¾—å³æ‰‹ç­·å­
                synchronized (right) {
                    try {
                        // åƒé¥­
                        log.debug("eating...");
                        TimeUnit.SECONDS.sleep(1);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
                // æ”¾ä¸‹å³æ‰‹ç­·å­
            }
            // æ”¾ä¸‹å·¦æ‰‹ç­·å­
        }
    }
}


public class TestPhilosopher {

    public static void main(String[] args) {

        Chopstick c1 = new Chopstick("1");
        Chopstick c2 = new Chopstick("2");
        Chopstick c3 = new Chopstick("3");
        Chopstick c4 = new Chopstick("4");
        Chopstick c5 = new Chopstick("5");
        new Philosopher("è‹æ ¼æ‹‰åº•", c1, c2).start();
        new Philosopher("æŸæ‹‰å›¾", c2, c3).start();
        new Philosopher("äºšé‡Œå£«å¤šå¾·", c3, c4).start();
        new Philosopher("èµ«æ‹‰å…‹åˆ©ç‰¹", c4, c5).start();
        // æœ¬æ¥ c5, c1 æ”¹å˜é¡ºåºï¼Œå³å¯å‘ç°é¥¥é¥¿é—®é¢˜ï¼Œé˜¿åŸºç±³å¾·ä¸€ç›´å¾—ä¸åˆ°æ‰§è¡Œï¼Œèµ«æ‹‰å…‹åˆ©ç‰¹æ‰§è¡Œæœ€å¤š
        new Philosopher("é˜¿åŸºç±³å¾·", c1, c5).start();
    }
}
```

ç¬¬ä¸€è½®äº‰å¤ºå·¦ç­·å­æ—¶ï¼Œè‹å’Œé˜¿åŒæ—¶äº‰å¤ºc1ï¼Œæ‰€ä»¥åªæœ‰ä¸€ä¸ªèƒ½äº‰åˆ°ä¸”è‹å…ˆè¿è¡Œåˆ™è‹è·å–åˆ°

ç¬¬äºŒè½®äº‰å¤ºå³ç­·å­æ—¶ï¼Œc5æ²¡äººå’Œèµ«äº‰ï¼ˆé˜¿å·²ç»é˜»å¡ï¼‰æ‰€ä»¥èµ«æ‰§è¡Œæœ€å¤š





## ReentrantLock ğŸ”¥

ç›¸å¯¹äº synchronized å®ƒå…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹

*   ä¸ synchronized ä¸€æ ·ï¼Œ**éƒ½æ”¯æŒå¯é‡å…¥**

*   **å¯ä¸­æ–­**

*   å¯ä»¥è®¾ç½®**è¶…æ—¶æ—¶é—´**

*   å¯ä»¥è®¾ç½®ä¸º**å…¬å¹³é”**ï¼ˆè§£å†³æ­»é”ã€é¥¥é¥¿ï¼‰

*   æ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼ˆ**ä¸æ»¡è¶³æ¡ä»¶è°ƒç”¨ wait å¯åœ¨å¤šä¸ª WaitSet é‡Œç­‰å¾…**ï¼‰



### å¯é‡å…¥





## 7.4 çº¿ç¨‹å®‰å…¨å’ŒåŒæ­¥

#### Lock é”

- ä» JDK 5.0 å¼€å§‹ï¼ŒJava æä¾›äº†æ›´å¼ºå¤§çš„çº¿ç¨‹åŒæ­¥æœºåˆ¶â€”â€”é€šè¿‡**æ˜¾å¼å®šä¹‰åŒæ­¥é”å¯¹è±¡**æ¥å®ç°åŒæ­¥ã€‚`java.util.concurrent.locks.Lock` **æ¥å£**æœºåˆ¶æä¾›äº†æ¯”`synchronized`ä»£ç å—å’Œ`synchronized`æ–¹æ³•æ›´å¹¿æ³›çš„é”å®šæ“ä½œï¼ŒåŒæ­¥ä»£ç å—/åŒæ­¥æ–¹æ³•å…·æœ‰çš„åŠŸèƒ½ Lock éƒ½æœ‰ï¼Œé™¤æ­¤ä¹‹å¤–æ›´å¼ºå¤§ï¼Œæ›´ä½“ç°é¢å‘å¯¹è±¡ã€‚

- **Lock æ¥å£çš„å®ç°ç±»`ReentrantLock`**ã€‚å¯åœ¨æ„é€ æ–¹æ³•ä¸­è®¾ç½®æ˜¯å¦ä¸º**å…¬å¹³é”**ï¼ˆæŒ‰ FIFO é˜Ÿåˆ—ï¼‰ï¼Œä½†æ˜¯æ•ˆç‡å¯èƒ½ä¼šå˜ä½ã€‚

- **Lock é”ä¹Ÿç§°åŒæ­¥é”**ï¼ŒåŠ é”ä¸é‡Šæ”¾é”æ–¹æ³•åŒ–äº†ï¼Œå¦‚ä¸‹ï¼š

    - `void lock()`ï¼š**åŠ åŒæ­¥é”**

    - `void unlock()`ï¼š**é‡Šæ”¾åŒæ­¥é”**

        ```java
        public class Ticket implements Runnable {
        
            private int count = 100;
            private Lock lock = new ReentrantLock();
        
            @Override
            public void run() {
                while (true) {
                    try {
                        // åŠ åŒæ­¥é”
                        lock.lock();
                        if (count > 0) {
                            try {
                                Thread.sleep(10);
                                System.out.println(Thread.currentThread().getName() + "-->æ­£åœ¨å–ç¬¬" + count + "å¼ ç¥¨");
                                count--;
                            } catch (InterruptedException e) {
                                e.printStackTrace();
                            }
                        } else {
                            break;
                        }
                    } finally {
                        // é‡Šæ”¾åŒæ­¥é”
                        lock.unlock();
                    }
                }
            }
        
            public static void main(String[] args) {
                Ticket ticket = new Ticket();
                new Thread(ticket, "çª—å£1").start();
                new Thread(ticket, "çª—å£2").start();
                new Thread(ticket, "çª—å£3").start();
            }
        }
        ```

#### 

## ä¹ é¢˜

### å®ç° Runnable æ¥å£çš„å¥½å¤„ ğŸ”¥

**å…¶å® Thread ç±»ä¹Ÿæ˜¯å®ç°äº† Runnable æ¥å£**ã€‚start å¯åŠ¨çº¿ç¨‹ä¸­å†…éƒ¨è°ƒç”¨ run æ–¹æ³•æ—¶ï¼Œè‹¥æ˜¯ target æœ‰å€¼ï¼ˆRunnableå¯¹è±¡ï¼‰åˆ™è°ƒç”¨è¯¥ Runnable å¯¹è±¡çš„ run æ–¹æ³•ï¼Œæ— å€¼åˆ™è°ƒç”¨ Thread é‡å†™çš„ run æ–¹æ³•ã€‚

æ„é€ æ–¹æ³•åˆå§‹åŒ–æ—¶ä¼šæœ‰

```java
// Thread.java
this.target = target;// è¿™ä¸ªå³æ˜¯ä¼ å…¥çš„ Runnable å¯¹è±¡ã€‚Thread åŒ¿åå†…éƒ¨ç±»å¯¹è±¡ä¸ä¼šä¼ å…¥æ„é€ æ–¹æ³•çš„
```

è°ƒç”¨ start æ–¹å¼æ—¶ä¼šè°ƒç”¨

```java
// Thread.java
@Override
public void run() {
    if (target != null) {
        target.run();
    }
}
```

*   é¿å…äº† Java ç±»**å•ç»§æ‰¿çš„å±€é™æ€§**
*   å¤šä¸ªçº¿ç¨‹å¯ä»¥å…±äº«åŒä¸€ä¸ªæ¥å£å®ç°ç±»çš„å¯¹è±¡ï¼Œéå¸¸é€‚åˆå¤šä¸ªç›¸åŒçº¿ç¨‹æ¥**å¤„ç†åŒä¸€ä¸ªèµ„æº**ï¼Œå¢åŠ ç¨‹åºçš„å¥å£®æ€§ï¼Œå®ç°**è§£è€¦**æ“ä½œï¼Œ**ä»»åŠ¡**ä»£ç å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œ**ä»»åŠ¡ä»£ç å’Œçº¿ç¨‹ç‹¬ç«‹**

*   **çº¿ç¨‹æ± **åªèƒ½æ”¾å…¥å®ç° Runable æˆ– Callable ç±»çº¿ç¨‹ï¼Œä¸èƒ½ç›´æ¥æ”¾å…¥ç»§æ‰¿ Thread ç±»çš„çº¿ç¨‹





### `run()`å’Œ`start()`çš„åŒºåˆ« ğŸ”¥

- `run()`ï¼šä»…ä»…æ˜¯å°è£…è¢«çº¿ç¨‹æ‰§è¡Œçš„ä»£ç ï¼Œç›´æ¥è°ƒç”¨æ˜¯æ™®é€šæ–¹æ³•ã€‚
- `start()`ï¼šé¦–å…ˆå¯åŠ¨äº†çº¿ç¨‹ï¼Œç„¶åå†ç”± jvm å»è°ƒç”¨è¯¥çº¿ç¨‹çš„ run()æ–¹æ³•ã€‚

### synchronized å’Œ Lock åŒºåˆ«

- syn æ˜¯å…³é”®å­—å±äº **JVM å±‚é¢**çš„ï¼ˆåœ¨åŒæ­¥ä¸­å—ä¸­æ‰èƒ½è°ƒç”¨ wait/notifyï¼‰ï¼›Lock æ˜¯æ¥å£ï¼Œæ˜¯ **Api å±‚é¢**çš„ï¼ŒJVM å°†èŠ±è´¹è¾ƒå°‘çš„æ—¶é—´æ¥è°ƒåº¦çº¿ç¨‹ï¼Œæ€§èƒ½æ›´å¥½ã€‚å¹¶ä¸”å…·æœ‰æ›´å¥½çš„æ‰©å±•æ€§ï¼ˆæä¾›æ›´å¤šçš„å­ç±»ï¼‰
- syn æ˜¯**éšå¼é”**ï¼Œ**å‡ºäº†ä½œç”¨åŸŸ æˆ– æŠ›å¼‚å¸¸ä¼šè‡ªåŠ¨é‡Šæ”¾**ï¼›Lock æ˜¯**æ˜¾å¼é”**ï¼ˆ**æ‰‹åŠ¨å¼€å¯å’Œå…³é—­é”**ï¼Œåˆ«å¿˜è®°å…³é—­é”ï¼‰
- syn æœ‰ä»£ç å—é”å’Œæ–¹æ³•é”ï¼›Lock åªæœ‰ä»£ç å—é”
- **syn ä¸å¯ä¸­æ–­**ï¼›**Lock å¯ä¸­æ–­**ï¼ˆtryLock è®¾ç½®è¶…æ—¶æ–¹æ³•ï¼ŒlockInterruptibly()æ–¹ä»£ç å—ä¸­ï¼Œç”¨ interrupt()æ–¹æ³•ä¸­æ–­ï¼‰
- ä½¿ç”¨ Lock çš„ Condition å¯ä»¥**ç²¾ç¡®å”¤é†’**

ä¼˜å…ˆä½¿ç”¨é¡ºåºï¼šLock â€”> åŒæ­¥ä»£ç å—(å·²ç»è¿›å…¥äº†æ–¹æ³•ä½“ï¼Œåˆ†é…äº†ç›¸åº”èµ„æº) â€”> åŒæ­¥æ–¹æ³• (åœ¨æ–¹æ³•ä½“ä¹‹å¤–)

### sleep å’Œ wait å¼‚åŒ

- sleep æ˜¯ Thread çš„æ–¹æ³•ï¼Œå¯ä»¥åœ¨ä»»ä½•åœºæ™¯ä¸‹è°ƒç”¨ï¼›wait æ˜¯ Object çš„æ–¹æ³•ï¼Œå¿…é¡»åœ¨åŒæ­¥ä¸­è°ƒç”¨ï¼ˆåŒæ­¥ä»£ç å—ã€åŒæ­¥æ–¹æ³•ï¼‰
- è‹¥ä¿©æ–¹æ³•éƒ½åœ¨åŒæ­¥ä¸­è°ƒç”¨ï¼Œéƒ½ä¼šä½¿çº¿ç¨‹è¿›å…¥ TIME/ WAITING çŠ¶æ€ã€‚ä½† sleep **ä¸ä¼šé‡Šæ”¾é”**ï¼Œä¼‘çœ ç»“æŸå›åˆ°å°±ç»ªçŠ¶æ€ï¼›wait **ç­‰å¾…**å¹¶ç«‹å³**é‡Šæ”¾é”**ï¼Œ**è¢«å”¤é†’åè‹¥è·å¾—é”åˆ™ä»è¿™é‡Œæ‰§è¡Œåç»­ä»£ç **

### 2 ä¸ªçº¿ç¨‹å‘è´¦æˆ·å­˜é’±å¹¶æ‰“å°

é“¶è¡Œæœ‰ä¸€ä¸ªè´¦æˆ·ï¼Œæœ‰ä¸¤ä¸ªå‚¨æˆ·åˆ†åˆ«å‘åŒä¸€ä¸ªè´¦æˆ·å­˜ 3000 å…ƒï¼Œæ¯æ¬¡å­˜ 1000ï¼Œå­˜ 3 æ¬¡ã€‚æ¯æ¬¡å­˜å®Œæ‰“å°è´¦æˆ·ä½™é¢ã€‚

é—®é¢˜:è¯¥ç¨‹åºæ˜¯å¦æœ‰å®‰å…¨é—®é¢˜ï¼Œå¦‚æœæœ‰ï¼Œå¦‚ä½•è§£å†³ï¼Ÿæ­¤å¤„é‡‡ç”¨ç»§æ‰¿ Thread ç±»æ¥å®ç°ï¼ˆå®ç° Runnable æ¥å£ç¨ç®€å•ï¼‰

```java
class Account {
    private double balance;

    public Account(double balance) {
        this.balance = balance;
    }

    //å­˜é’±
    public synchronized void deposit(double amt) {
        if (amt > 0) {
            balance += amt;
            System.out.println(Thread.currentThread().getName() + ":å­˜é’±æˆåŠŸã€‚ä½™é¢ä¸ºï¼š" + balance);
        }
    }
}

class Customer extends Thread {

    private Account acct;

    public Customer(Account acct, String name) {
        super(name);
        this.acct = acct;
    }

    @Override
    public void run() {

        for (int i = 0; i < 3; i++) {
            acct.deposit(1000);

            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
    }
}

public class AccountTest {

    public static void main(String[] args) {
        Account acct = new Account(0);
        new Customer(acct, "ç”²").start();
        new Customer(acct, "ä¹™").start();
    }
}
```

### 2 ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å° 1-100

åŒæ­¥ä»£ç å—ã€åŒæ­¥æ–¹æ³•

```java
class PrintThread implements Runnable{

    private int count = 1;

    @Override
    public void run() {
        while (true) {
            // waitã€notify å¿…é¡»åœ¨åŒæ­¥ä¸­ã€‚ä¸”è°ƒç”¨çš„å¯¹è±¡ä¸é”å¯¹è±¡å¿…é¡»ç›¸åŒ
            synchronized (this) {
                // å”¤é†’
                this.notifyAll();
                if (count <= 100) {
                    /*try {
                        // ä¸åŠ é”æ—¶ï¼Œå¢åŠ çº¿ç¨‹å®‰å…¨é—®é¢˜å‘ç”Ÿçš„æ¦‚ç‡
                        Thread.sleep(100);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }*/
                    System.out.println(Thread.currentThread().getName()+":"+count++);

                    try {
                        // ç­‰å¾…å¹¶ç«‹å³é‡Šæ”¾é”ï¼Œå”¤é†’åè¿˜æ˜¯ä»è¿™é‡Œç»§ç»­ï¼Œä½†æ˜¯éœ€è¦è·å–åˆ°é”ï¼Œæ‰€ä»¥å¤–å±‚éœ€è¦ä½¿ç”¨ while
                        this.wait();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                } else {
                    break;
                }
            }
        }
    }
}

public class PrintTest {

    public static void main(String[] args) {
        PrintThread printThread = new PrintThread();
        // ä¹Ÿå¯ä»¥å°† run æ–¹æ³•å†…å®¹å†™å…¥æ™®é€šæ–¹æ³•ä¸­ï¼Œé‡‡ç”¨æ–¹æ³•å¼•ç”¨æ¥æ“ä½œ
        new Thread(printThread,"A").start();
        new Thread(printThread,"B").start();
    }
}
```

Lock æ–¹å¼æš‚æ—¶æ²¡æƒ³åˆ°å¥½ç‚¹çš„æ–¹æ³•

### ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜

è§ç¬”è®°

### åˆ›å»ºå¤šçº¿ç¨‹çš„ 4 ç§æ–¹å¼

è§ç¬”è®°







