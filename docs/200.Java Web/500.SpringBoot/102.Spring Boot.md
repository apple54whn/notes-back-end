---
title: Spring Boot
date: 2021-06-21 21:21:03
permalink: /pages/bede88/
categories:
  - Java Web
  - SpringBoot
tags:
  - 
---
# Spring Boot

## Spring Boot å‡ºä¸–

éšç€åŠ¨æ€è¯­è¨€çš„æµè¡Œ (Rubyã€Groovyã€Scalaã€Node.js)ï¼ŒJava çš„å¼€å‘æ˜¾å¾—æ ¼å¤–çš„ç¬¨é‡ï¼šJ2EEç¬¨é‡çš„å¼€å‘ã€**ç¹å¤šçš„é…ç½®**ã€**ä¾èµ–ç®¡ç†çš„è€—æ—¶è€—åŠ›**ã€ä½ä¸‹çš„å¼€å‘æ•ˆç‡ã€å¤æ‚çš„éƒ¨ç½²æµç¨‹ä»¥åŠç¬¬ä¸‰æ–¹æŠ€æœ¯é›†æˆéš¾åº¦å¤§ã€‚

åœ¨ä¸Šè¿°ç¯å¢ƒä¸‹ï¼ŒSpring Boot åº”è¿è€Œç”Ÿã€‚å®ƒä½¿ç”¨ â€œ**çº¦å®šå¤§äºé…ç½®**â€ ï¼ˆé¡¹ç›®ä¸­å­˜åœ¨å¤§é‡çš„é…ç½®ï¼Œæ­¤å¤–è¿˜å†…ç½®äº†ä¸€ä¸ªä¹ æƒ¯æ€§çš„é…ç½®ï¼Œè®©ä½ æ— éœ€æ‰‹åŠ¨è¿›è¡Œé…ç½®ï¼‰çš„ç†å¿µè®©ä½ çš„é¡¹ç›®å¿«é€Ÿçš„è¿è¡Œèµ·æ¥ã€‚ä½¿ç”¨ Spring Boot å¾ˆå®¹æ˜“åˆ›å»ºä¸€ä¸ªç‹¬ç«‹è¿è¡Œï¼ˆè¿è¡Œ Jarï¼Œå†…åµŒ Servlet å®¹å™¨ï¼‰å‡†ç”Ÿäº§çº§åˆ«çš„åŸºäº Spring æ¡†æ¶çš„é¡¹ç›®ï¼Œä½¿ç”¨ Spring Boot ä½ å¯ä»¥ä¸ç”¨æˆ–è€…åªéœ€å¾ˆå°‘çš„ Spring é…ç½®ã€‚Spring Boot å¯ä»¥ç§°ä¹‹ä¸º **æ–°ä¸€ä»£ Jakarta EE å¼€å‘æ ‡å‡†**

### ä¼˜ç‚¹

- å¿«é€Ÿæ„å»ºé¡¹ç›®ï¼šSpringBootä¸æ˜¯å¯¹SpringåŠŸèƒ½ä¸Šçš„å¢å¼ºï¼Œè€Œæ˜¯æä¾›äº†ä¸€ç§å¿«é€Ÿä½¿ç”¨Springçš„æ–¹å¼
- å¯¹ä¸»æµå¼€å‘æ¡†æ¶çš„æ— é…ç½®é›†æˆ
- é¡¹ç›®å¯ç‹¬ç«‹è¿è¡Œï¼Œæ— éœ€å¤–éƒ¨ä¾èµ– Servlet å®¹å™¨
- æä¾›è¿è¡Œæ—¶çš„åº”ç”¨ç›‘æ§
- æå¤§åœ°æé«˜äº†å¼€å‘ã€éƒ¨ç½²æ•ˆç‡
- ä¸äº‘è®¡ç®—çš„å¤©ç„¶é›†æˆ

### æ ¸å¿ƒä¼˜åŠ¿ ğŸ”¥

- **èµ·æ­¥ä¾èµ–ï¼ˆstarter-*ï¼‰**

  èµ·æ­¥ä¾èµ–æœ¬è´¨æ˜¯ä¸€ä¸ªMavené¡¹ç›®å¯¹è±¡æ¨¡å‹ï¼ˆPOMï¼‰ï¼Œå®šä¹‰äº†å¯¹å…¶ä»–åº“çš„ä¼ é€’ä¾èµ–ï¼Œè¿™äº›ä¸œè¥¿åŠ åœ¨ä¸€èµ·å³æ”¯æŒæŸé¡¹åŠŸèƒ½ã€‚
- è‡ªåŠ¨é…ç½®ï¼ˆé…ç½®å“ªäº†ï¼Ÿ**å°±æ˜¯é…ç½® Beanï¼ŒåŠ å…¥å®¹å™¨**ï¼‰

  å°†ä¹‹å‰å›ºå®šçš„é…ç½®é‡‡ç”¨è¿è¡Œæ—¶ Spring Boot **è‡ªåŠ¨é…ç½®**æ–¹å¼å®ç°ï¼Œ**å‡å°‘äº†ç¹ççš„é…ç½®è¿‡ç¨‹**ï¼Œ**å…¶å®å°±æ˜¯ IoC ä¸­æœ€é‡è¦ä¸€ç‚¹ï¼Œå°†éœ€è¦çš„ Bean è‡ªåŠ¨åŠ å…¥å®¹å™¨ä¸­**

  Spring Bootçš„è‡ªåŠ¨é…ç½®æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶ï¼ˆæ›´å‡†ç¡®åœ°è¯´ï¼Œæ˜¯åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼‰çš„è¿‡ç¨‹ï¼Œè€ƒè™‘äº†ä¼—å¤šå› ç´ ï¼Œæ‰å†³å®šSpringé…ç½®åº”è¯¥ç”¨å“ªä¸ªï¼Œä¸è¯¥ç”¨å“ªä¸ªã€‚è¯¥è¿‡ç¨‹æ˜¯Springè‡ªåŠ¨å®Œæˆçš„ã€‚

### ä¸ Springï¼ˆMVCï¼‰ç­‰åŒºåˆ«

Spring MVC æ˜¯ä¸€ä¸ªåŸºäº**Java**å®ç°çš„MVCè®¾è®¡æ¨¡å‹çš„**è¯·æ±‚é©±åŠ¨**ç±»å‹çš„**è½»é‡çº§WEBæ¡†æ¶**

Spring ç‹­ä¹‰ä¸ŠæŒ‡çš„æ˜¯ IoCã€DIã€AOP ç­‰ Spring Framework åŠŸèƒ½çš„é›†åˆï¼Œä½†æ˜¯å¹¿ä¹‰ä¸Šå®ƒæ˜¯æŒ‡æ‰€æœ‰ Spring äº§å“ï¼Œå¦‚ Spring MVCã€Spring Bootã€Spring Cloud ç­‰ç­‰

Spring Boot æ˜¯åŸºäº Spring Framework å¼€å‘çš„è®©åˆ›å»º Spring åº”ç”¨æ›´æ–¹ä¾¿çš„**å·¥å…·**ï¼Œå¯ä»¥åˆ©ç”¨å®ƒçš„ç‰¹æ€§æ¥æ›´æ–¹ä¾¿çš„ä½¿ç”¨ Spring MVC ç­‰ Spring Framework

## Hello World

### POM

ä½¿ç”¨ Spring Initializr åˆå§‹åŒ– Spring Boot é¡¹ç›®ï¼š https://start.spring.io/ï¼ŒIDEAä¸­è‡ªå¸¦ã€‚æ ¹æ®éœ€æ±‚é€‰æ‹©éœ€è¦çš„ä¾èµ–ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>
  <!--æ‰€æœ‰çš„springbootå·¥ç¨‹éƒ½å¿…é¡»ç»§æ‰¿spring-boot-starter-parentï¼Œä¹Ÿå¯ä»¥å»æ‰å¹¶è‡ªå®šä¹‰-->
	<parent>
		<groupId>org.springframework.boot</groupId>
		<artifactId>spring-boot-starter-parent</artifactId>
		<version>2.2.2.RELEASE</version>
		<relativePath/> <!-- lookup parent from repository -->
	</parent>
  
  <!--è¯¥é¡¹ç›®çš„Mavenåæ ‡-->
	<groupId>top.conanan</groupId>
	<artifactId>study-spring-boot</artifactId>
	<version>1.0.0-SNAPSHOT</version>
  
	<name>study-spring-boot</name>
	<description>Demo project for Spring Boot</description>

  <!--é€‰æ‹©JDKç‰ˆæœ¬åè‡ªåŠ¨é…ç½®-->
	<properties>
		<java.version>11</java.version> <!--Java8 è¿™é‡Œæ˜¾ç¤ºä¸º1.8-->
	</properties>

  <!--ä¾èµ–-->
	<dependencies>
    <!--webåŠŸèƒ½çš„èµ·æ­¥ä¾èµ–ï¼Œè‹¥æ˜¯ä¸ªæ™®é€šJavaå·¥ç¨‹ï¼Œåˆ™ä¼šæ˜¯spring-boot-starter-->
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <!--è‡ªåŠ¨æ·»åŠ çš„æµ‹è¯•é…ç½®ã€‚Spring Boot 2.2.2ç›®å‰ä½¿ç”¨çš„æ˜¯ JUnit5-->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
			<exclusions>
				<exclusion>
					<groupId>org.junit.vintage</groupId>
					<artifactId>junit-vintage-engine</artifactId>
				</exclusion>
			</exclusions>
		</dependency>
   
    <!--Spring Boot DevToolsæä¾›å¿«é€Ÿåº”ç”¨ç¨‹åºé‡å¯ï¼ŒLiveReloadå’Œé…ç½®ï¼Œä»¥å¢å¼ºå¼€å‘ä½“éªŒã€‚-->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-devtools</artifactId>
			<scope>runtime</scope>
			<optional>true</optional>
		</dependency>
    <!--Lombok Javaæ³¨é‡Šåº“ï¼Œæœ‰åŠ©äºå‡å°‘æ ·æ¿ä»£ç ã€‚-->
		<dependency>
			<groupId>org.projectlombok</groupId>
			<artifactId>lombok</artifactId>
			<optional>true</optional>
		</dependency>
    <!--Springé…ç½®å¤„ç†å™¨ä¸ºå¼€å‘äººå‘˜ç”Ÿæˆå…ƒæ•°æ®ï¼Œä»¥ä¾¿åœ¨ä½¿ç”¨è‡ªå®šä¹‰é…ç½®é”®æ—¶æä¾›ä¸Šä¸‹æ–‡å¸®åŠ©å’Œâ€œä»£ç å®Œæˆâ€ï¼ˆex.application.propertiesï¼‰-->
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-configuration-processor</artifactId>
			<optional>true</optional>
		</dependency>
  
    <!--Spring Boot Actuatoræ”¯æŒå†…ç½®ï¼ˆæˆ–è‡ªå®šä¹‰ï¼‰ç«¯ç‚¹ï¼Œå¯ä»¥ç›‘æ§å’Œç®¡ç†åº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚åº”ç”¨ç¨‹åºè¿è¡ŒçŠ¶å†µï¼ŒæŒ‡æ ‡ï¼Œä¼šè¯ç­‰ã€‚ç”¨äº Ops -->
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
	</dependencies>

  <!--è‡ªåŠ¨æ·»åŠ çš„mavenæ’ä»¶ï¼Œè¿™ä¸ªæ’ä»¶å¯å°†åº”ç”¨æ‰“åŒ…æˆå¯æ‰§è¡Œçš„jaråŒ…ã€‚å¯ä»¥é€šè¿‡java -jar åŒ…åæ¥è¿è¡Œåº”ç”¨-->
	<build>
		<plugins>
			<plugin>
				<groupId>org.springframework.boot</groupId>
				<artifactId>spring-boot-maven-plugin</artifactId>
			</plugin>
		</plugins>
	</build>
</project>
```

### Application

* é»˜è®¤ç”Ÿæˆçš„ Spring Boot é¡¹ç›®ã€‚ä¸»ç¨‹åºå·²ç»ç”Ÿæˆå¥½äº†ï¼Œæˆ‘ä»¬åªéœ€è¦æˆ‘ä»¬è‡ªå·±çš„é€»è¾‘

  ```java
  //å£°æ˜è¯¥ç±»æ˜¯ä¸€ä¸ªSpringBootå¼•å¯¼ç±»
  @SpringBootApplication
  public class StudySpringBootApplication {
  	//mainæ˜¯javaç¨‹åºçš„å…¥å£
  	public static void main(String[] args) {
      //runæ–¹æ³• è¡¨ç¤ºè¿è¡ŒSpringBootçš„å¼•å¯¼ç±»  runå‚æ•°å°±æ˜¯SpringBootå¼•å¯¼ç±»çš„å­—èŠ‚ç å¯¹è±¡
  		SpringApplication.run(StudySpringBootApplication.class, args);
  	}
  }
  ```

### resources

ç›®å½•ç»“æ„

- `static`ï¼šä¿å­˜æ‰€æœ‰çš„é™æ€èµ„æºï¼› jsã€cssã€imagesç­‰
- `templates`ï¼šä¿å­˜æ‰€æœ‰çš„æ¨¡æ¿é¡µé¢ï¼›ï¼ˆSpring Booté»˜è®¤jaråŒ…ä½¿ç”¨åµŒå…¥å¼çš„Tomcatï¼Œé»˜è®¤ä¸æ”¯æŒJSPé¡µé¢ï¼‰ï¼›å¯ä»¥ä½¿ç”¨æ¨¡æ¿å¼•æ“å¦‚`freemarker`ã€`thymeleaf`
- `application.properties`ï¼šSpring Bootåº”ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥ä¿®æ”¹ä¸€äº›é»˜è®¤è®¾ç½®
- å¯ä»¥æ‰‹åŠ¨æ–°å»ºç›®å½•ï¼Œå¦‚`mapper`

### HelloController

å¿…é¡»åœ¨å¼•å¯¼ç±»`StudySpringBootApplication`**åŒçº§åŒ…æˆ–è€…å­çº§åŒ…**ä¸­åˆ›å»ºï¼Œæ‰èƒ½è¢«æ‰«æåˆ°

```java
@RestController
public class HelloController {

    @GetMapping("/hello")
    public String hello(){
        return "study spring boot";
    }
}
```

run åå¯ä½¿ç”¨ Terminal æµ‹è¯•ï¼š`curl http://localhost:8080/hello`

ä¸Šè¿°POMä¸­æœ‰actuatorç”¨äºæ£€æŸ¥åº”ç”¨çŠ¶æ€ï¼Œ`curl http://localhost:8080/actuator/health`ï¼Œè¿”å›å¦‚ä¸‹ï¼Œæ³¨æ„åªèƒ½ç”¨äº run æ¨¡å¼è¿è¡Œçš„åº”ç”¨ï¼Œdebug æ¨¡å¼ä¸èµ·ä½œç”¨

```json
{"status":"UP"}
```

### Test

```java
// Spring Boot 2.2.2ç›®å‰ä½¿ç”¨çš„æ˜¯ JUnit5ã€‚å¾ˆå¤šå¤„å’Œ JUnit4 ä¸ä¸€æ ·ã€‚å¦‚ä¸éœ€è¦æ·»åŠ æ³¨è§£ @RunWith(SpringRunner.class)
// ä½¿ç”¨webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORTåï¼Œæ¯æ¬¡å¯åŠ¨æµ‹è¯•éƒ½ä¼šéšæœºç”Ÿæˆä¸€ä¸ª port
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
class StudySpringBootApplicationTests {

	@Autowired
	private HelloController helloController;

	@LocalServerPort
	private int port;

  // Test ç‰¹æœ‰çš„ï¼Œåªéœ€æ³¨å…¥å³å¯
	@Autowired
	private TestRestTemplate restTemplate;

	@Test
	void hello() {
		System.out.println("hello");
		System.out.println(helloController);
	}

	@Test
	public void greetingShouldReturnDefaultMessage() throws Exception {
		String s = restTemplate.getForObject("http://localhost:" + port + "/hello", String.class);
		System.out.println(s);
	}
}
```

`@SpringBootTest`annotation tells Spring Boot to go and look for a main configuration class (one with `@SpringBootApplication` for instance), and use that to start a Spring application context. You can run this test in your IDE or on the command line (`mvn test` or `gradle test`) and it should pass.

- Mavenæ‰“åŒ…ï¼š`mvn clean package -Dmaven.test.skip`

  å¯ä»¥çœ‹åˆ°å¸¦æœ‰`.original`çš„ä¸ºåŸå§‹åŒ…ï¼Œå’Œå¸¦æœ‰æ‰€æœ‰ä¾èµ–ï¼ˆå¦‚ Tomcat ç­‰ï¼‰çš„ uber`jar`åŒ…ï¼Œå¯ä»¥æ‰§è¡Œ`java -jar`å¯åŠ¨ï¼Œ`java -jar springboot.jar --spring.profiles.active=prod`

## èµ·æ­¥ä¾èµ– â€” starter ğŸ”¥

æŒ‰ä½Ctrlç‚¹å‡»pom.xmlä¸­çš„spring-boot-starter-parentï¼Œè·³è½¬åˆ°äº†spring-boot-starter-parentçš„pom.xmlï¼Œxmlé…ç½®å¦‚ä¸‹ï¼ˆé…ç½®äº†é…ç½®æ–‡ä»¶åç§°ä½ç½®ç­‰ä¿¡æ¯ï¼‰ï¼š

```xml
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-dependencies</artifactId>
    <version>2.1.2.RELEASE</version>
    <relativePath>../../spring-boot-dependencies</relativePath>
</parent>
```

æŒ‰ä½Ctrlç‚¹å‡»pom.xmlä¸­çš„spring-boot-dependenciesï¼Œè·³è½¬åˆ°äº†spring-boot-dependenciesçš„pom.xmlï¼Œxmlé…ç½®å¦‚ä¸‹ï¼š

```xml
<properties>
    <activemq.version>5.15.8</activemq.version>
    <antlr2.version>2.7.7</antlr2.version>
    <appengine-sdk.version>1.9.71</appengine-sdk.version>
    <artemis.version>2.6.3</artemis.version>
    <aspectj.version>1.9.2</aspectj.version>
    ......
</properties>
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot</artifactId>
            <version>2.1.2.RELEASE</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-test</artifactId>
            <version>2.1.2.RELEASE</version>
        </dependency>
        ......
    </dependencies>
</dependencyManagement>
<build>
    <pluginManagement>
        <plugins>
            <plugin>
                <groupId>org.apache.johnzon</groupId>
                <artifactId>johnzon-maven-plugin</artifactId>
                <version>${johnzon.version}</version>
            </plugin>
            ......
        </plugins>
    </pluginManagement>
</build>
```

ä»ä¸Šé¢çš„spring-boot-dependenciesçš„pom.xmlä¸­æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œä¸€éƒ¨åˆ†åæ ‡çš„**ç‰ˆæœ¬ã€ä¾èµ–ç®¡ç†ã€æ’ä»¶ç®¡ç†**å·²ç»å®šä¹‰å¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„SpringBootå·¥ç¨‹ç»§æ‰¿spring-boot-starter-parentåå·²ç»å…·å¤‡**ç‰ˆæœ¬é”å®š**ç­‰é…ç½®äº†ã€‚æ‰€ä»¥èµ·æ­¥ä¾èµ–ä½œç”¨å°±æ˜¯è¿›è¡Œ**ä¾èµ–çš„ä¼ é€’**ã€‚

åŒç†spring-boot-starter-webå°±æ˜¯å°†webå¼€å‘è¦ä½¿ç”¨çš„spring-webã€spring-webmvcç­‰åæ ‡è¿›è¡Œäº†â€œæ‰“åŒ…â€ï¼Œè¿™æ ·æˆ‘ä»¬çš„å·¥ç¨‹åªè¦å¼•å…¥spring-boot-starter-webèµ·æ­¥ä¾èµ–çš„åæ ‡å°±å¯ä»¥è¿›è¡Œwebå¼€å‘äº†ï¼ŒåŒæ ·ä½“ç°äº†ä¾èµ–ä¼ é€’çš„ä½œç”¨ã€‚

## è‡ªåŠ¨é…ç½® â€” @SpringBootApplication ğŸ”¥

æŒ‰ä½Ctrlç‚¹å‡»æŸ¥çœ‹å¯åŠ¨ç±»MySpringBootApplicationä¸Šçš„æ³¨è§£@SpringBootApplicationï¼Œæºç å¦‚ä¸‹ï¼š

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@SpringBootConfiguration
@EnableAutoConfiguration
@ComponentScan(excludeFilters = {
		@Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),
		@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) })
public @interface SpringBootApplication {

	/**
	 * Exclude specific auto-configuration classes such that they will never be applied.
	 * @return the classes to exclude
	 */
	@AliasFor(annotation = EnableAutoConfiguration.class)
	Class<?>[] exclude() default {};

	... ... ...

}
```

### @SpringBootConfiguration

ç­‰åŒä¸`@Configuration`ï¼Œæ—¢æ ‡æ³¨è¯¥ç±»æ˜¯Springçš„ä¸€ä¸ªé…ç½®ç±»

### @EnableAutoConfiguration

SpringBoot è‡ªåŠ¨é…ç½®åŠŸèƒ½å¼€å¯ã€‚ä¸æ˜¯ç”¨äºè‡ªå·±å†™çš„ Beanï¼Œè€Œæ˜¯**é…ç½®ä¸‰æ–¹åº“ä¸­çš„ Bean**

æŒ‰ä½Ctrlç‚¹å‡»æŸ¥çœ‹è¯¥æ³¨è§£

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@AutoConfigurationPackage
@Import(AutoConfigurationImportSelector.class)
public @interface EnableAutoConfiguration {
	... ... ...
}
```

#### @AutoConfigurationPackage

è‡ªåŠ¨é…ç½®åŒ…**ï¼Œ**å¦‚ä¸‹æ³¨è§£çš„ç®€å†™

```java
@Import(AutoConfigurationPackages.Registrar.class)
```

#### @Import

Springåº•å±‚æ³¨è§£`@Import`ï¼Œç»™å®¹å™¨ä¸­å¯¼å…¥ä¸€ä¸ªç»„ä»¶ï¼›å¯¼å…¥çš„ç»„ä»¶ç”±`AutoConfigurationImportSelector.class`æŒ‡å®šï¼Œè¿™ä¸ªç±»æœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œé€šè¿‡æ³¨è§£metadataï¼Œå°†ä¸»é…ç½®ç±»ï¼ˆ`@SpringBootApplication`ï¼‰æ‰€åœ¨åŒ…åŠä¸‹é¢æ‰€æœ‰å­åŒ…é‡Œé¢çš„æ‰€æœ‰ç»„ä»¶æ‰«æåˆ°Springå®¹å™¨

æŒ‰ä½Ctrlç‚¹å‡»æŸ¥çœ‹`AutoConfigurationImportSelector`æºç 

```java
public String[] selectImports(AnnotationMetadata annotationMetadata) {
    ... ... ...
        List<String> configurations = getCandidateConfigurations(annotationMetadata,
                                                                 attributes);
    configurations = removeDuplicates(configurations);
    Set<String> exclusions = getExclusions(annotationMetadata, attributes);
    checkExcludedClasses(configurations, exclusions);
    configurations.removeAll(exclusions);
    configurations = filter(configurations, autoConfigurationMetadata);
    fireAutoConfigurationImportEvents(configurations, exclusions);
    return StringUtils.toStringArray(configurations);
}


protected List<String> getCandidateConfigurations(AnnotationMetadata metadata,
                                                  AnnotationAttributes attributes) {
    List<String> configurations = SpringFactoriesLoader.loadFactoryNames(
        getSpringFactoriesLoaderFactoryClass(), getBeanClassLoader());

    return configurations;
}
```

å…¶ä¸­ï¼Œ`SpringFactoriesLoader.loadFactoryNames` æ–¹æ³•çš„ä½œç”¨å°±æ˜¯ä»`META-INF/spring.factories`æ–‡ä»¶ä¸­è¯»å–æŒ‡å®šç±»å¯¹åº”çš„**å…¨ç±»å**çš„åˆ—è¡¨ï¼Œå¦‚xxxAutoConfiguration

![1550170881470](../images/1550170881470.png)

`spring-autoconfigure-metadata.properties` æ–‡ä»¶ä¸­æœ‰å…³è‡ªåŠ¨é…ç½®çš„é…ç½®ä¿¡æ¯å¦‚ä¸‹ï¼š

```
org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration,\
org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration,\
org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration,\
org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration,\
org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration,\
org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration,\
......
```

ä¸Šé¢é…ç½®æ–‡ä»¶å­˜åœ¨å¤§é‡çš„ä»¥Configurationä¸ºç»“å°¾çš„ç±»åç§°ï¼Œè¿™äº›ç±»å°±æ˜¯å­˜æœ‰è‡ªåŠ¨é…ç½®ä¿¡æ¯çš„ç±»ï¼Œè€ŒSpringApplicationåœ¨è·å–è¿™äº›ç±»ååå†åŠ è½½

æˆ‘ä»¬ä»¥`ServletWebServerFactoryAutoConfiguration`ä¸ºä¾‹æ¥åˆ†ææºç ï¼š

```java
@Configuration
@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE)
@ConditionalOnClass(ServletRequest.class)
@ConditionalOnWebApplication(type = Type.SERVLET)
@EnableConfigurationProperties(ServerProperties.class)
@Import({ ServletWebServerFactoryAutoConfiguration.BeanPostProcessorsRegistrar.class,
		ServletWebServerFactoryConfiguration.EmbeddedTomcat.class,
		ServletWebServerFactoryConfiguration.EmbeddedJetty.class,
		ServletWebServerFactoryConfiguration.EmbeddedUndertow.class })
public class ServletWebServerFactoryAutoConfiguration {
	......
}

```

å…¶ä¸­ï¼Œ`@EnableConfigurationProperties(ServerProperties.class) `ä»£è¡¨åŠ è½½`ServerProperties`æœåŠ¡å™¨é…ç½®å±æ€§ç±»

è¿›å…¥ServerProperties.classæºç å¦‚ä¸‹ï¼š

```java
@ConfigurationProperties(prefix = "server", ignoreUnknownFields = true)
public class ServerProperties {
    /**
	 * Server HTTP port.
	 */
    private Integer port;
    /**
	 * Network address to which the server should bind.
	 */
    private InetAddress address;
	......
}

```

å…¶ä¸­ï¼Œ`prefix = "server"` è¡¨ç¤ºSpringBooté…ç½®æ–‡ä»¶ä¸­çš„å‰ç¼€ï¼ŒSpringBootä¼šå°†é…ç½®æ–‡ä»¶ä¸­ä»¥serverå¼€å§‹çš„å±æ€§æ˜ å°„åˆ°è¯¥ç±»çš„å­—æ®µä¸­ã€‚å¦‚åœ¨`application.properties`ä¸­é…ç½®`server.port=80`å³å¯æ”¹å˜å½“å‰æœåŠ¡å™¨çš„HTTPç«¯å£å·

**è‡ªåŠ¨é…ç½®æ€»ç»“**

- **SpringBootå¯åŠ¨ä¼šåŠ è½½å¤§é‡çš„è‡ªåŠ¨é…ç½®ç±»**
- **æˆ‘ä»¬çœ‹æˆ‘ä»¬éœ€è¦çš„åŠŸèƒ½æœ‰æ²¡æœ‰SpringBooté»˜è®¤å†™å¥½çš„è‡ªåŠ¨é…ç½®ç±»ï¼›**
- **æˆ‘ä»¬å†æ¥çœ‹è¿™ä¸ªè‡ªåŠ¨é…ç½®ç±»ä¸­åˆ°åº•é…ç½®äº†å“ªäº›ç»„ä»¶ï¼›ï¼ˆåªè¦æˆ‘ä»¬è¦ç”¨çš„ç»„ä»¶æœ‰ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦å†æ¥é…ç½®äº†ï¼‰**
- **ç»™å®¹å™¨ä¸­è‡ªåŠ¨é…ç½®ç±»æ·»åŠ ç»„ä»¶çš„æ—¶å€™ï¼Œä¼šä»propertiesç±»ä¸­è·å–æŸäº›å±æ€§ã€‚æˆ‘ä»¬å°±å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šè¿™äº›å±æ€§çš„å€¼ï¼›**
- **è‡ªåŠ¨é…ç½®ç±»å¯¹åº”å±æ€§ç±»**

  - xxxxAutoConfigurartionï¼šè‡ªåŠ¨é…ç½®ç±»ï¼›ç»™å®¹å™¨ä¸­æ·»åŠ ç»„ä»¶
  - xxxxProperties:å°è£…é…ç½®æ–‡ä»¶ä¸­ç›¸å…³å±æ€§ï¼›

### SPI æœºåˆ¶åº”ç”¨ ğŸ”¥

Service Provider Interfaceï¼Œåº”å¯¹å˜åŒ–çš„è§£å†³æ–¹æ¡ˆã€‚åŸºäº Interface æ¥å£ + ç­–ç•¥æ¨¡å¼ + é…ç½®æ–‡ä»¶

ä¹‹å‰è®²è¿‡çš„ @Primary å’Œ @Conditionxx ä¹Ÿå¯ä»¥è§£å†³ï¼Œä½†æ˜¯å…³æ³¨çš„ç²’åº¦æ˜¯**å…·ä½“**ç±»ã€å¯¹è±¡

è€Œ SPI å…³æ³¨çš„æ˜¯**æ•´ä½“è§£å†³æ–¹æ¡ˆ**ï¼Œå…³æ³¨è®¸å¤šç±»ï¼Œå¯¹è±¡çš„æ•´ä½“ï¼

### @ComponentScan

ç»„ä»¶æ‰«æï¼Œä½†æ˜¯ä»…æ‰«ææ³¨è§£äº†`@SpringBootApplication`ç±»æ‰€åœ¨çš„åŒçº§åŒ…å’Œå­çº§åŒ…

### é…ç½®ä¿¡æ¯çš„æŸ¥è¯¢

SpringBootçš„é…ç½®æ–‡ä»¶ï¼Œä¸»è¦çš„ç›®çš„å°±æ˜¯å¯¹é…ç½®ä¿¡æ¯è¿›è¡Œä¿®æ”¹çš„ï¼Œä½†åœ¨é…ç½®æ—¶çš„keyä»å“ªé‡Œå»æŸ¥è¯¢å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥æŸ¥é˜…[å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-boot/docs/2.1.2.RELEASE/reference/htmlsingle/#common-application-properties)

å¸¸ç”¨çš„é…ç½®æ‘˜æŠ„å¦‚ä¸‹ï¼š

```properties
# QUARTZ SCHEDULER (QuartzProperties)
spring.quartz.jdbc.initialize-schema=embedded # Database schema initialization mode.
spring.quartz.jdbc.schema=classpath:org/quartz/impl/jdbcjobstore/tables_@@platform@@.sql # Path to the SQL file to use to initialize the database schema.
spring.quartz.job-store-type=memory # Quartz job store type.
spring.quartz.properties.*= # Additional Quartz Scheduler properties.

# ----------------------------------------
# WEB PROPERTIES
# ----------------------------------------

# EMBEDDED SERVER CONFIGURATION (ServerProperties)
server.port=8080 # Server HTTP port.
server.servlet.context-path= # Context path of the application.
server.servlet.path=/ # Path of the main dispatcher servlet.

# HTTP encoding (HttpEncodingProperties)
spring.http.encoding.charset=UTF-8 # Charset of HTTP requests and responses. Added to the "Content-Type" header if not set explicitly.

# JACKSON (JacksonProperties)
spring.jackson.date-format= # Date format string or a fully-qualified date format class name. For instance, `yyyy-MM-dd HH:mm:ss`.

# SPRING MVC (WebMvcProperties)
spring.mvc.servlet.load-on-startup=-1 # Load on startup priority of the dispatcher servlet.
spring.mvc.static-path-pattern=/** # Path pattern used for static resources.
spring.mvc.view.prefix= # Spring MVC view prefix.
spring.mvc.view.suffix= # Spring MVC view suffix.

# DATASOURCE (DataSourceAutoConfiguration & DataSourceProperties)
spring.datasource.driver-class-name= # Fully qualified name of the JDBC driver. Auto-detected based on the URL by default.
spring.datasource.password= # Login password of the database.
spring.datasource.url= # JDBC URL of the database.
spring.datasource.username= # Login username of the database.

# JEST (Elasticsearch HTTP client) (JestProperties)
spring.elasticsearch.jest.password= # Login password.
spring.elasticsearch.jest.proxy.host= # Proxy host the HTTP client should use.
spring.elasticsearch.jest.proxy.port= # Proxy port the HTTP client should use.
spring.elasticsearch.jest.read-timeout=3s # Read timeout.
spring.elasticsearch.jest.username= # Login username.
```

- æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨**é…ç½®æ–‡ä»¶ä¸­å¯ç”¨ debug=trueå±æ€§ï¼›æ¥è®©æ§åˆ¶å°æ‰“å°è‡ªåŠ¨é…ç½®æŠ¥å‘Š**ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„çŸ¥é“å“ªäº›è‡ªåŠ¨é…ç½®ç±»ç”Ÿæ•ˆï¼›

  ```java
  =========================
  AUTO-CONFIGURATION REPORT
  =========================

  Positive matches:ï¼ˆè‡ªåŠ¨é…ç½®ç±»å¯ç”¨çš„ï¼‰
  -----------------

     DispatcherServletAutoConfiguration matched:
        - @ConditionalOnClass found required class 'org.springframework.web.servlet.DispatcherServlet'; @ConditionalOnMissingClass did not find unwanted class (OnClassCondition)
        - @ConditionalOnWebApplication (required) found StandardServletEnvironment (OnWebApplicationCondition)


  Negative matches:ï¼ˆæ²¡æœ‰å¯åŠ¨ï¼Œæ²¡æœ‰åŒ¹é…æˆåŠŸçš„è‡ªåŠ¨é…ç½®ç±»ï¼‰
  -----------------

     ActiveMQAutoConfiguration:
        Did not match:
           - @ConditionalOnClass did not find required classes 'javax.jms.ConnectionFactory', 'org.apache.activemq.ActiveMQConnectionFactory' (OnClassCondition)    
  ```

## ç‰ˆæœ¬å·

å¦‚`2.2.1.RELEASE`ï¼ŒMaven ä¸­æ˜¾ç¤ºçš„ç‰ˆæœ¬å·ï¼Œæ–‡æ¡£ä¸­ä¸ä¸€å®šè¿™æ ·æ˜¾ç¤º

* 2ï¼šä¸»ç‰ˆæœ¬ã€‚ææœ‰å¯èƒ½åº•å±‚æ”¹å˜ï¼Œæ— æ³•å…¼å®¹æ—§ç‰ˆæœ¬
* 2ï¼šæ¬¡ç‰ˆæœ¬ã€‚å‘å¸ƒæ–°ç‰¹æ€§ï¼ŒåŸºæœ¬éœ€è¦ä¿è¯å…¼å®¹
* 1ï¼šå¢é‡ç‰ˆæœ¬ã€‚ä¿®å¤ bugï¼Œä¿è¯å…¼å®¹ï¼ˆä¹Ÿä¸ç¡®å®šï¼‰
* RELEASEï¼šé‡Œç¨‹ç¢‘ã€‚ç‰ˆæœ¬çš„å‘å¸ƒè®¡åˆ’ã€çŠ¶æ€

  * GAï¼ˆGeneral Availabilityï¼‰ï¼šSpring Boot ä¼˜å…ˆé€‰æ‹©
  * RCï¼šåŸºæœ¬å’Œ GA ç­‰åŒ
  * SNAPSHOTï¼šå¿«ç…§
  * Alpha
  * Beta