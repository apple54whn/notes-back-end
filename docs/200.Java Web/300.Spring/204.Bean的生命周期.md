---
title: Beançš„ç”Ÿå‘½å‘¨æœŸ
date: 2021-06-21 21:21:03
permalink: /pages/d9cb59/
categories:
  - Java Web
  - Spring
tags:
  - 
---
# Bean's Lifecycle

## ç®€ä»‹

* Bean çš„ç”Ÿå‘½å‘¨æœŸå³æ˜¯å®¹å™¨ç®¡ç† **Bean çš„åˆ›å»ºï¼ˆèµ‹å€¼ï¼‰ã€åˆå§‹åŒ–ã€é”€æ¯çš„è¿‡ç¨‹**
* å¯ä»¥**è‡ªå®šä¹‰åˆå§‹åŒ–ã€é”€æ¯æ–¹æ³•**ã€‚å®¹å™¨åœ¨ Bean è¿›è¡Œåˆ°å½“å‰ç”Ÿå‘½å‘¨æœŸæ—¶è°ƒç”¨å®šä¹‰çš„æ–¹æ³•

## initMethod & destroyMethod ğŸ”¥

æ³¨æ„ scope ä¸åŒæ—¶åŒºåˆ«

* æ„é€ æ–¹æ³•

  * å•å®ä¾‹ï¼šå®¹å™¨å¯åŠ¨æ—¶åˆ›å»ºå¯¹è±¡è§¦å‘
  * å¤šå®ä¾‹ï¼šæ¯æ¬¡è·å–æ—¶åˆ›å»ºå¯¹è±¡è§¦å‘
* initMethod

  * å•å®ä¾‹ï¼šå®¹å™¨å¯åŠ¨ï¼Œåˆ›å»ºå¯¹è±¡å¹¶èµ‹å€¼åè§¦å‘
  * å¤šå®ä¾‹ï¼šæ¯æ¬¡è·å–å¯¹è±¡ï¼Œåˆ›å»ºå¯¹è±¡å¹¶èµ‹å€¼åè§¦å‘
* destroyMethod

  * å•å®ä¾‹ï¼šå…³é—­å®¹å™¨æ—¶
  * å¤šå®ä¾‹ï¼šå®¹å™¨ä¸ä¼šç®¡ç†ï¼Œéœ€é”€æ¯åˆ™ç­‰åˆ°GCå³å¯ï¼ˆæ²¡æ‰¾åˆ°ã€‚ã€‚ã€‚ï¼‰

```java
public class Car {

    /**
     * å•å®ä¾‹ï¼šå®¹å™¨å¯åŠ¨æ—¶åˆ›å»ºå¯¹è±¡è§¦å‘
     * å¤šå®ä¾‹ï¼šæ¯æ¬¡è·å–æ—¶åˆ›å»ºå¯¹è±¡è§¦å‘
     */
    public Car(){
        System.out.println("Car Constructor...");
    }

    /**
     * å•å®ä¾‹ï¼šå®¹å™¨å¯åŠ¨ï¼Œåˆ›å»ºå¯¹è±¡å¹¶èµ‹å€¼åè§¦å‘
     * å¤šå®ä¾‹ï¼šæ¯æ¬¡è·å–å¯¹è±¡ï¼Œåˆ›å»ºå¯¹è±¡å¹¶èµ‹å€¼åè§¦å‘
     */
    public void init(){
        System.out.println("Car init...");
    }

    /**
     * å•å®ä¾‹ï¼šå…³é—­å®¹å™¨æ—¶
     * å¤šå®ä¾‹ï¼šå®¹å™¨ä¸ä¼šç®¡ç†ï¼Œéœ€é”€æ¯åˆ™ç­‰åˆ°GCå³å¯
     */
    public void destroy(){
        System.out.println("Car destroy...");
    }
}
```

```java
public class Train {

    public Train(){
        System.out.println("Train Constructor...");
    }

    public void init(){
        System.out.println("Train init...");
    }

    public void destroy(){
        System.out.println("Train destroy...");
    }
}
```

```java
@Configuration
public class LifeCycleConfig1 {

    @Bean(initMethod = "init",destroyMethod = "destroy")
    public Car car(){
        return new Car();
    }

    @Bean(initMethod = "init",destroyMethod = "destroy")
    @Scope("prototype")
    public Train train(){
        return new Train();
    }
}
```

```java
public class LifeCycleConfig1Test {

    private AnnotationConfigApplicationContext context;


    @BeforeEach
    public void init(){
        context = new AnnotationConfigApplicationContext(LifeCycleConfig1.class);
        System.out.println("å®¹å™¨åˆ›å»ºå®Œæˆ");
    }

    @Test
    public void test(){

        Train train = context.getBean(Train.class);

    }

    @AfterEach
    public void destroy(){
        context.close();
    }
}
```

> ä½œç”¨å’Œxmlé…ç½®æ–‡ä»¶ä¸­çš„`<bean>`æ ‡ç­¾ç¼–å†™`<init-method>`å’Œ`<destroy-method>`æ ‡ç­¾å®ç°åŠŸèƒ½ä¸€è‡´
>
> ä¸€ä¸ªæ˜¯Beanåˆ›å»ºå¹¶èµ‹å€¼å®Œæˆåè°ƒç”¨ï¼Œä¸€ä¸ªæ˜¯å®¹å™¨å…³é—­ï¼ˆå•ä¾‹ï¼‰æˆ–GCï¼ˆå¤šä¾‹ï¼‰
>

## InitializingBean & DisposableBean ğŸ”¥

* é€šè¿‡è®©Beanå®ç°`InitializingBean`æ¥å£ï¼Œé‡å†™åˆå§‹åŒ–æ–¹æ³•`afterPropertiesSet`ã€‚è¯¥æ–¹æ³•åœ¨å®¹å™¨`BeanFactory`åˆå§‹åŒ–å®Œ Bean æ‰€æœ‰å±æ€§ï¼Œå¹¶æ»¡è¶³`BeanFactoryAware`å’Œ`ApplicationContextAware`åè°ƒç”¨
* å®ç°`DisposableBean`æ¥å£ï¼Œé‡å†™é”€æ¯æ–¹æ³•`destroy`ã€‚è¯¥æ–¹æ³•åœ¨å®¹å™¨`BeanFactory`é”€æ¯ä¸€ä¸ª Bean æ—¶è°ƒç”¨

```java
public class Cat implements InitializingBean, DisposableBean {

    public Cat(){
        System.out.println("Cat Constructor...");
    }

    @Override
    public void afterPropertiesSet() throws Exception {
        System.out.println("Cat afterPropertiesSet...");
    }

    @Override
    public void destroy() throws Exception {
        System.out.println("Cat destroy...");
    }
}
```

```java
/**
 * InitializingBean & DisposableBean
 */
@Configuration
public class LifeCycleConfig2 {

    @Bean// ä¸ºäº†æ§åˆ¶ bean çš„æ•°é‡ï¼Œä¸ä½¿ç”¨åŒ…æ‰«ææœºåˆ¶
    public Cat cat(){
        return new Cat();
    }
}
```

```java
/**
 * InitializingBean & DisposableBean
 */
public class LifeCycleConfig2Test {

    private AnnotationConfigApplicationContext context;


    @BeforeEach
    public void init(){
        context = new AnnotationConfigApplicationContext(LifeCycleConfig2.class);
        System.out.println("å®¹å™¨åˆ›å»ºå®Œæˆ");
    }

    @Test
    public void test(){

    }

    @AfterEach
    public void destroy(){
        context.close();
    }
}
```

## @PostConstruct & @PreDestroy ğŸ”¥

**JSR250**å®šä¹‰çš„æ³¨è§£ï¼Œ**åªèƒ½å®šä¹‰åœ¨æ–¹æ³•ä¸Š**

- `@PostConstruct`ï¼šåœ¨ **bean åˆ›å»ºå®Œæˆå¹¶ä¸”èµ‹å€¼å®Œå**æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•
- `@PreDestroy`ï¼šåœ¨**é”€æ¯beanå‰**é€šçŸ¥æˆ‘ä»¬è¿›è¡Œæ¸…ç†å·¥ä½œã€‚å•ä¾‹ä¸­éœ€è¦å…³é—­å®¹å™¨ï¼ˆä½¿ç”¨å®ç°ç±»çš„æ–¹æ³•ï¼Œå¦‚closeï¼‰

```java
public class Dog {

    public Dog(){
        System.out.println("Dog Constructor...");
    }

    @PostConstruct
    public void init(){
        System.out.println("Dog init...");
    }

    @PreDestroy
    public void destroy(){
        System.out.println("Dog destroy...");
    }

}
```

```java
/**
 * @PostConstruct & @PreDestroy
 */
@Configuration
public class LifeCycleConfig3 {

    @Bean// ä¸ºäº†æ§åˆ¶ bean çš„æ•°é‡ï¼Œä¸ä½¿ç”¨åŒ…æ‰«ææœºåˆ¶
    public Dog dog(){
        return new Dog();
    }
}
```

```java
/**
 * @PostConstruct & @PreDestroy
 */
public class LifeCycleConfig3Test {

    private AnnotationConfigApplicationContext context;


    @BeforeEach
    public void init(){
        context = new AnnotationConfigApplicationContext(LifeCycleConfig3.class);
        System.out.println("å®¹å™¨åˆ›å»ºå®Œæˆ");
    }

    @Test
    public void test(){


    }

    @AfterEach
    public void destroy(){
        context.close();
    }
}
```

## BeanPostProcessor åç½®å¤„ç†å™¨ ğŸ”¥

### ç®€ä»‹

Spring æä¾›çš„`BeanPostProcessor`æ¥å£ï¼šBean çš„åç½®å¤„ç†å™¨ï¼Œåœ¨**æ‰€æœ‰ Bean çš„åˆå§‹åŒ–å‰å**è¿›è¡Œä¸€äº›å¤„ç†å·¥ä½œï¼Œå¦‚`init-method`ã€`afterPropertiesSet`ã€`@PostConstruct`å‰å

* `postProcessBeforeInitialization`ï¼šåœ¨**åˆå§‹åŒ–ä¹‹å‰**å·¥ä½œ
* `postProcessAfterInitialization`ï¼šåœ¨**åˆå§‹åŒ–ä¹‹å**å·¥ä½œ

```java
@Component// å¿…é¡»ä½¿ç”¨@Componentï¼Œä¸èƒ½ä½¿ç”¨@Beanï¼Œå¦åˆ™çˆ†çº¢ï¼ˆä¸æ˜¯è‡ªåŠ¨ä»£ç†çš„ï¼‰
public class MyBeanPostProcessor implements BeanPostProcessor {
    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
        System.out.println("postProcessBeforeInitialization => beanName: " 
                           + beanName + ", beanType: " 
                           + bean.getClass());
        return bean;
    }

    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
        System.out.println("postProcessAfterInitialization => beanName: " 
                           + beanName + ", beanType: " 
                           + bean.getClass());
        return bean;
    }
}
```

```java
/**
 * BeanPostProcessor
 * ä¸‰ç§ä¸åŒç±»å‹çš„ Beanï¼Œä½¿ç”¨äº†ä¸åŒçš„åˆå§‹åŒ–æ–¹æ³•
 */
@Configuration
@ComponentScan(basePackageClasses = {top.conanan.processor.MyBeanPostProcessor.class})
// @ComponentScan({"top.conanan.processor"}) // å¯ä»¥ä½¿ç”¨ basePackage æˆ– basePackageClassesï¼ˆç±»å‹å®‰å…¨ï¼‰
@Import({Cat.class, Dog.class})
public class LifeCycleConfig4 {
  
    @Bean(initMethod = "init",destroyMethod = "destroy")
    public Car car(){
        return new Car();
    }

}
```

```java
/**
 * BeanPostProcessor
 */
public class LifeCycleConfig4Test {

    private AnnotationConfigApplicationContext context;


    @BeforeEach
    public void init(){
        context = new AnnotationConfigApplicationContext(LifeCycleConfig4.class);
        System.out.println("å®¹å™¨åˆ›å»ºå®Œæˆ");
    }

    @Test
    public void test(){


    }

    @AfterEach
    public void destroy(){
        context.close();
    }
}
```

### å·¥ä½œåŸç†

**DEBUG æŸ¥çœ‹è°ƒç”¨æ ˆ**å³å¯æŸ¥çœ‹æµç¨‹

* populateBean(beanName, mbd, instanceWrapper)ï¼šç»™ bean è¿›è¡Œ**å±æ€§èµ‹å€¼**ï¼Œè°ƒç”¨ getterã€setter ç­‰
* initializeBeanï¼š

  * applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName)ï¼š**åˆå§‹åŒ–å‰**

    **éå†å¾—åˆ°å®¹å™¨ä¸­æ‰€æœ‰çš„ BeanPostProcessor**ï¼›æŒ¨ä¸ªæ‰§è¡Œ postProcessBeforeInitializationï¼Œä¸€ä½†è¿”å› null åˆ™ return è·³å‡º for å¾ªç¯ï¼Œä¸ä¼šæ‰§è¡Œåé¢ BeanPostProcessor çš„ postProcessorsBeforeInitialization
  * invokeInitMethods(beanName, wrappedBean, mbd)ï¼š**æ‰§è¡Œè‡ªå®šä¹‰åˆå§‹åŒ–**ï¼Œå¯¹è±¡åˆ›å»ºå¥½ï¼Œå¹¶èµ‹å€¼å¥½åï¼Œè°ƒç”¨åˆå§‹åŒ–æ–¹æ³•
  * applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName)ï¼š**åˆå§‹åŒ–å**

### åº”ç”¨

Spring åº•å±‚å¯¹ BeanPostProcessor çš„ä½¿ç”¨

* bean èµ‹å€¼
* bean æ ¡éªŒï¼šBeanValidationPostProcessor
* æ³¨å…¥å…¶ä»–ç»„ä»¶
* @Autowiredï¼šAutowiredAnnotationBeanPostProcessor
* ç”Ÿå‘½å‘¨æœŸæ³¨è§£åŠŸèƒ½ï¼ˆJSR250 é‚£ä¸ªï¼‰ï¼šInitDestroyAnnotationBeanPostProcessor
* @Async
* æ³¨å…¥ IoC å®¹å™¨ï¼šApplicationContextAwareProcessor

  ```java
  public class Car implements ApplicationContextAware {

      private ApplicationContext context;

      /**
       * å•å®ä¾‹ï¼šå®¹å™¨å¯åŠ¨æ—¶åˆ›å»ºå¯¹è±¡è§¦å‘
       * å¤šå®ä¾‹ï¼šæ¯æ¬¡è·å–æ—¶åˆ›å»ºå¯¹è±¡è§¦å‘
       */
      public Car(){
          System.out.println("Car Constructor...");
      }

      /**
       * å•å®ä¾‹ï¼šå®¹å™¨å¯åŠ¨ï¼Œåˆ›å»ºå¯¹è±¡å¹¶èµ‹å€¼åè§¦å‘
       * å¤šå®ä¾‹ï¼šæ¯æ¬¡è·å–å¯¹è±¡ï¼Œåˆ›å»ºå¯¹è±¡å¹¶èµ‹å€¼åè§¦å‘
       */
      public void init(){
          System.out.println("Car init...");
      }

      /**
       * å•å®ä¾‹ï¼šå…³é—­å®¹å™¨æ—¶
       * å¤šå®ä¾‹ï¼šå®¹å™¨ä¸ä¼šç®¡ç†ï¼Œéœ€é”€æ¯åˆ™ç­‰åˆ°GCå³å¯
       */
      public void destroy(){
          System.out.println("Car destroy...");
      }

      @Override
      public void setApplicationContext(ApplicationContext applicationContext) throws BeansException {
          this.context = applicationContext;
      }
  }
  ```

## Bean çš„ç”Ÿå‘½å‘¨æœŸæ§åˆ¶ ğŸ”¥

Bean çš„ç”Ÿå‘½å‘¨æœŸé¡ºåºå¦‚ä¸‹ï¼Œè¦†ç›–äº†æ‰€æœ‰å‰å‰åå

* æ„é€ å™¨ï¼ˆå¯¹è±¡åˆ›å»ºï¼‰ï¼šè‡ªå®šä¹‰æ— å‚æ„é€ å™¨

  * å•å®ä¾‹ï¼šå®¹å™¨å¯åŠ¨æ—¶åˆ›å»ºå¯¹è±¡
  * å¤šå®ä¾‹ï¼šæ¯æ¬¡è·å–æ—¶åˆ›å»ºå¯¹è±¡
* BeanPostProcessor.postProcessBeforeInitializationï¼šåˆå§‹åŒ–å‰
* invokeInitMethods(beanName, wrappedBean, mbd)ï¼šæ‰§è¡Œåˆå§‹åŒ–ï¼Œå¯¹è±¡åˆ›å»ºå¥½ï¼Œå¹¶èµ‹å€¼å¥½åï¼Œè°ƒç”¨åˆå§‹åŒ–æ–¹æ³•
* BeanPostProcessor.postProcessAfterInitializationï¼šåˆå§‹åŒ–å
* é”€æ¯

  * å•å®ä¾‹ï¼šå®¹å™¨å…³é—­ï¼ˆå®ç°ç±»æ–¹æ³•ä¸­æœ‰ï¼‰
  * å¤šå®ä¾‹ï¼šå®¹å™¨ä¸ä¼šç®¡ç†è¿™ä¸ª Beanï¼Œå®¹å™¨ä¸ä¼šä¸»åŠ¨è°ƒç”¨é”€æ¯æ–¹æ³•ï¼Œéœ€GC

## å‚è€ƒ

* [Spring Beançš„ç”Ÿå‘½å‘¨æœŸï¼ˆéå¸¸è¯¦ç»†ï¼‰](https://www.cnblogs.com/zrtqsk/p/3735273.html)