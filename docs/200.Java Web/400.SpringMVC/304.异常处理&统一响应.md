---
title: å¼‚å¸¸å¤„ç†&ç»Ÿä¸€å“åº”
date: 2021-06-21 21:21:03
permalink: /pages/002c11/
categories:
  - Java Web
  - SpringMVC
tags:
  - 
---
# å¼‚å¸¸å¤„ç† & ç»Ÿä¸€é”™è¯¯å“åº”

## ä¸ºä»€ä¹ˆéœ€è¦å¼‚å¸¸å¤„ç†ï¼ŸğŸ”¥

* å¼‚å¸¸æ—¶æŠŠ**æ‰€æœ‰ä¿¡æ¯**éƒ½è¿”å›ç»™å®¢æˆ·ç«¯å—ï¼Ÿè®¸å¤šè€ç³»ç»Ÿä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œç›´æ¥**æš´éœ²å‡ºæ•°æ®åº“ç­‰å„ç§é”™è¯¯ï¼Œæå…¶ä¸å®‰å…¨**ï¼ï¼ï¼

* å¼‚å¸¸æ—¶è¿”å›ç»™å®¢æˆ·ç«¯**ç®€å•çš„ä¿¡æ¯**å—ï¼Ÿå¦‚`é”™è¯¯ä»£ç ï¼š11111ï¼Œå¤±è´¥ä¿¡æ¯ï¼šæ“ä½œå¤±è´¥`ï¼Œ**æ— æ³•åŒºåˆ«å…·ä½“çš„é”™è¯¯ä¿¡æ¯**ã€‚
* **Service å±‚æ–¹æ³•åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸è¯¥ä¸è¯¥æ•è·**ï¼Ÿå¦‚æœè¯¥ï¼Œåˆ™ Service å±‚ä¸­ä¼šæœ‰å¤ªå¤šçš„ tryã€catch ä»£ç ï¼Œä»£ç å†—ä½™ä¸æ˜“ç»´æŠ¤ï¼›å¦‚æœä¸è¯¥ï¼Œåˆ™æŠ›åˆ° Controller å±‚ï¼Œé‚£æ— è®ºå¦‚ä½•è¿˜å¾—æ•è·ï¼Œå¦åˆ™ç›´æ¥æš´éœ²ç»™ JVMï¼Œåˆ™è¿˜æ˜¯ä¼šå‡ºç°ç¬¬ä¸€ç§æƒ…å†µï¼

æ‰€ä»¥ï¼Œéœ€è¦ä¸€ä¸ªèƒ½åŒä¸€å¤„ç†å¼‚å¸¸çš„åœ°æ–¹ï¼

* æ— éœ€ Serviceã€Controller æ¥æ•è·å¼‚å¸¸ï¼Œç›´æ¥**åœ¨ç»Ÿä¸€å¼‚å¸¸å¤„ç†ç±»ä¸­å»æ•è·ï¼Œå¹¶è®°å½•æ—¥å¿—**ï¼Œæœ€åç»Ÿä¸€å‘ç”¨æˆ·è¿”å›**è§„èŒƒçš„å“åº”ä¿¡æ¯**ï¼
* æ­¤æ—¶åœ¨ Service ä¸­çš„æ–¹æ³•åœ¨ç¼–ç æ—¶å°±å¯ä»¥**å…ˆæ ¡éªŒåˆ¤æ–­**ï¼Œæœ‰é—®é¢˜**ç›´æ¥æŠ›å‡º**å…·ä½“çš„å¼‚å¸¸ä¿¡æ¯ï¼Œ**ç„¶åæ‰§è¡Œå…·ä½“ä¸šåŠ¡é€»è¾‘**ï¼Œ**æœ€åè¿”å›æˆåŠŸçš„ä¿¡æ¯**ï¼



## ä½¿ç”¨ HTTP åè®®çŠ¶æ€ç  & å…¨éƒ¨è¿”å› 200 ï¼ŸğŸ”¥

è¿™ä¸ªæ— æ³•ç»™å‡ºå…·ä½“ç­”æ¡ˆã€‚

* æˆ‘è®¤ä¸ºåœ¨è‡ªå·±çš„ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œå¯ä»¥ä½¿ç”¨ HTTP çš„çŠ¶æ€ç æ¥è¡¨ç¤ºï¼Œå‰ç«¯å¼‚å¸¸å¤„ç†å°±å¯ä»¥åœ¨ error ä¸­æ•è·äº†ï¼Œæ— éœ€åœ¨ success ä¸­åˆ¤æ–­ code ç ï¼
* å¯¹äºå›½å†…è¿è¥å•†æ¥è¯´ï¼Œæœ‰äº› HTTP çŠ¶æ€ç ä¼šè¢«è¿‡æ»¤äº†ã€‚

æ€»å¾—æ¥è¯´ï¼Œæ ¹æ®éœ€è¦å§ï¼Œåæ­£ä¹Ÿä¸éœ€è¦ä½¿ç”¨å¤ªå¤šçš„ä¸å¸¸ç”¨ HTTP çŠ¶æ€ç ï¼Œåº”è¯¥æ²¡æœ‰é—®é¢˜ï¼

è¯¥ç« èŠ‚æ¼”ç¤ºHTTP åè®®çŠ¶æ€ç çš„ä½¿ç”¨ï¼Œå…¨éƒ¨è¿”å› 200 æ›´ç®€å•ï¼Œä¿®æ”¹ä¸€ä¸‹å³å¯ï¼



## UnifyResponse ç»Ÿä¸€é”™è¯¯å“åº” ğŸ”¥

```java
@Builder
@Data
public class UnifyResponse {

    private int code;
    private String message;
    private String request;
}
```

config/code-message.properties

```properties
# ========== ä¸å¯é¢„çŸ¥å¼‚å¸¸ start ==========
lin.codes[9999] = ğŸ˜³æœåŠ¡å™¨æœªçŸ¥å¼‚å¸¸
lin.codes[9998] = ğŸ˜³éæ³•å‚æ•°å¼‚å¸¸
# ========== ä¸å¯é¢„çŸ¥å¼‚å¸¸ end ==========


lin.codes[10000] = é€šç”¨å¼‚å¸¸

lin.codes[30003] = å•†å“ä¿¡æ¯ä¸å­˜åœ¨
lin.codes[30005] = Bannerç±»èµ„æºä¸å­˜åœ¨
```

```java
/**
 * è¯¥ç±»ç”¨äºå…³è” code-message.properties é…ç½®æ–‡ä»¶
 */
@PropertySource("classpath:config/code-message.properties")
@ConfigurationProperties(prefix = "lin")
@Configuration
public class CodeConfiguration {


    /** codes å±æ€§å¯¹åº”é…ç½®æ–‡ä»¶ä¸­çš„ codes */
    private Map<Integer, String> codes = new HashMap<>();

    /** å¿…é¡»æä¾› setter æ–¹æ³•ï¼Œ ä»¥ä¾¿ Spring Boot è‡ªåŠ¨æ˜ å°„é…ç½®æ–‡ä»¶åˆ°å±æ€§ */
    public void setCodes(Map<Integer, String> codes) {
        this.codes = codes;
    }

    public String getMessage(int code){
        return codes.get(code);
    }
}
```

è¿”å›å€¼å¦‚ä¸‹ï¼š

```json
{
    "code": 10000,
    "message": "hello",
    "body": null,
    "request": url
}
```

å…¶ä¸­ code å’Œ message å¯ä»¥ä½¿ç”¨é”™è¯¯ä¿¡æ¯æ¸…å•é…ç½®æ–‡ä»¶é›†ä¸­ç®¡ç†ï¼Œä¹Ÿæ–¹ä¾¿ i18nã€‚

å½“ç„¶ä½¿ç”¨æšä¸¾ä¹Ÿè¡Œï¼Œåªæ˜¯ä¸çŸ¥é“å¦‚ä½• i18nã€‚


## é”™è¯¯ä¿¡æ¯æ¸…å• & æšä¸¾ ï¼ŸğŸ”¥

* é”™è¯¯ä¿¡æ¯æ¸…å•å¯ä»¥æ›´å¥½çš„è¿›è¡Œå›½é™…åŒ–ã€‚æšä¸¾å°±ä¸çŸ¥é“å¦‚ä½•æ“ä½œäº†ã€‚
* è¯¥ç« èŠ‚æ¼”ç¤ºé”™è¯¯ä¿¡æ¯æ¸…å•çš„ä½¿ç”¨ã€‚æšä¸¾å…¶å®æ›´ç®€å•ã€‚



## é”™è¯¯ä¿¡æ¯æ¸…å•ä½¿ç”¨æ­¥éª¤ ğŸ”¥


### 1 è‡ªå®šä¹‰å¼‚å¸¸ç±»â€”å¯é¢„çŸ¥å¼‚å¸¸

ç”±äºæ˜¯ç¨‹åºå‘˜æŠ›å‡ºçš„å¼‚å¸¸ï¼Œé€šå¸¸å¼‚å¸¸ä¿¡æ¯æ¯”è¾ƒé½å…¨ï¼Œç¨‹åºå‘˜åœ¨æŠ›å‡ºæ—¶ä¼šæŒ‡å®šé”™è¯¯ä»£ç åŠé”™è¯¯ä¿¡æ¯ï¼Œè·å–å¼‚å¸¸ä¿¡æ¯ä¹Ÿæ¯”è¾ƒæ–¹ä¾¿ã€‚

```java
@EqualsAndHashCode(callSuper = true)
@Data
public class HttpException extends RuntimeException{

    /** ä¸šåŠ¡çŠ¶æ€ç  */
    private int code;

    /** HTTP çŠ¶æ€ */
    private HttpStatus httpStatus;


    /**
     * é€šç”¨æ„é€ ç±»
     * @param code code
     * @param httpStatus httpStatus
     */
    public HttpException(int code, HttpStatus httpStatus){
        this.code = code;
        this.httpStatus = httpStatus;
    }


    /**
     * 500
     * @param code code
     */
    public HttpException(int code){
        this.code = code;
        this.httpStatus = HttpStatus.INTERNAL_SERVER_ERROR;
    }

}
```

```java
public class NotFoundException extends HttpException {

    public NotFoundException(int code){
        super(code, HttpStatus.NOT_FOUND); // 404
    }
}
```

```java
public class ForbiddenException extends HttpException {

    public ForbiddenException(int code){
        super(code, HttpStatus.FORBIDDEN); // 403
    }
}
```


### 2 ä¸å¯é¢„çŸ¥å¼‚å¸¸

ä¸å¯é¢„çŸ¥å¼‚å¸¸é€šå¸¸æ˜¯ç”±äºç³»ç»Ÿå‡ºç°bugã€æˆ–ä¸€äº›ä¸è¦æŠ—æ‹’çš„é”™è¯¯ï¼ˆæ¯”å¦‚ç½‘ç»œä¸­æ–­ã€æœåŠ¡å™¨å®•æœºç­‰ï¼‰ï¼Œå¼‚å¸¸ç±»å‹ä¸º RuntimeExceptionç±»å‹ï¼ˆè¿è¡Œæ—¶å¼‚å¸¸ï¼‰

å¦‚ä½¿ç”¨ Postman æµ‹è¯•æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š`org.springframework.http.converter.HttpMessageNotReadableException`ï¼Œæ­¤å¼‚å¸¸æ˜¯ SpringMVC åœ¨è¿›è¡Œå‚æ•°è½¬æ¢æ—¶æŠ¥çš„é”™è¯¯ã€‚

é’ˆå¯¹ä¸å¯é¢„çŸ¥å¼‚å¸¸é—®é¢˜å…¶è§£å†³æ–¹æ¡ˆæ˜¯ï¼š

1. æˆ‘ä»¬åœ¨mapä¸­é…ç½®HttpMessageNotReadableExceptionå’Œé”™è¯¯ä»£ç ã€‚
2. åœ¨å¼‚å¸¸æ•è·ç±»ä¸­å¯¹Exceptionå¼‚å¸¸è¿›è¡Œæ•è·ï¼Œå¹¶ä»mapä¸­è·å–å¼‚å¸¸ç±»å‹å¯¹åº”çš„é”™è¯¯ä»£ç ï¼Œå¦‚æœå­˜åœ¨é”™è¯¯ä»£ç åˆ™è¿”å›æ­¤é”™è¯¯ï¼Œå¦åˆ™ç»Ÿä¸€è¿”å›9999é”™è¯¯ã€‚



### 3 å…¨å±€å¼‚å¸¸æ•è·â€”å¤„ç†ï¼ˆä¸ï¼‰å¯é¢„çŸ¥å¼‚å¸¸

```java
/**
 * å…¨å±€å¼‚å¸¸å¤„ç†
 */
@RestControllerAdvice
@Slf4j
public class GlobalExceptionAdvice {

    @Autowired
    private CodeConfiguration codeConfiguration;


    // è¿™ä¸ªä¸å¯é¢„çŸ¥å¼‚å¸¸å®Œå…¨å¯ä»¥ç›´æ¥æŠ›å‡º9999ç±»ä¼¼çš„æœåŠ¡å™¨å¼‚å¸¸ï¼Œæ— éœ€å†™è¿™äº›
    //ä½¿ç”¨EXCEPTIONSå­˜æ”¾å¼‚å¸¸ç±»å‹å’Œé”™è¯¯ä»£ç çš„æ˜ å°„ï¼ŒImmutableMapçš„ç‰¹ç‚¹çš„ä¸€æ—¦åˆ›å»ºä¸å¯æ”¹å˜ï¼Œå¹¶ä¸”çº¿ç¨‹å®‰å…¨
    private static ImmutableMap<Class<? extends Throwable>, Integer> EXCEPTIONS;
    //ä½¿ç”¨builderæ¥æ„å»ºä¸€ä¸ªå¼‚å¸¸ç±»å‹å’Œé”™è¯¯ä»£ç çš„å¼‚å¸¸
    protected static ImmutableMap.Builder<Class<? extends Throwable>, Integer> builder = ImmutableMap.builder();

    //åœ¨è¿™é‡ŒåŠ å…¥ä¸€äº›åŸºç¡€çš„å¼‚å¸¸ç±»å‹åˆ¤æ–­ã€‚è¿™é‡Œåªæ·»åŠ äº†ä¸€ä¸ªç¤ºä¾‹
    static {
        builder.put(HttpMessageNotReadableException.class, 9998);
    }


    /**
     * å¯é¢„çŸ¥å¼‚å¸¸ï¼ˆè‡ªå®šä¹‰å¼‚å¸¸ç±»å‹ï¼‰
     */
    @ExceptionHandler(HttpException.class)
    public HttpEntity<UnifyResponse> handleHttpException(HttpException exception,
                                                         HttpServletRequest request,
                                                         HandlerMethod handlerMethod,
                                                         HttpMethod httpMethod) {
        UnifyResponse unifyResponse = UnifyResponse.builder()
                .code(exception.getCode())
                .message(codeConfiguration.getMessage(exception.getCode()))
                .request(httpMethod + " " + request.getRequestURI())
                .build();
        log.warn("{}, æ–¹æ³•ä¸ºï¼š{}, å¼‚å¸¸ä¸ºï¼š{}", codeConfiguration.getMessage(exception.getCode()), handlerMethod, exception);
        // ResponseEntity ç»§æ‰¿äº† HttpEntity
        return new ResponseEntity<>(unifyResponse, exception.getHttpStatus());
    }


    /**
     * ä¸å¯é¢„çŸ¥å¼‚å¸¸
     * å·²ç»ä½¿ç”¨äº† @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR) æ‰€ä»¥æ— éœ€è¿”å› HttpEntity
     */
    @ExceptionHandler(Exception.class)
    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
    public UnifyResponse handleException(Exception exception,
                                         HttpServletRequest request,
                                         HandlerMethod handlerMethod,
                                         HttpMethod httpMethod) {
        if (EXCEPTIONS == null) {
            EXCEPTIONS = builder.build();
        }

        Integer code = EXCEPTIONS.get(exception.getClass());
        UnifyResponse unifyResponse;
        if (Objects.nonNull(code)){
            unifyResponse = new UnifyResponse(code, codeConfiguration.getMessage(code), httpMethod + " " + request.getRequestURI());
        } else {
            unifyResponse = new UnifyResponse(9999, codeConfiguration.getMessage(9999), httpMethod + " " + request.getRequestURI());
        }


        log.warn("ç³»ç»ŸæœªçŸ¥å¼‚å¸¸, æ–¹æ³•ä¸ºï¼š{}, å¼‚å¸¸ä¸ºï¼š{}", handlerMethod, exception);
        return unifyResponse;
    }

  
    // ====================åé¢è¿™äº›æ˜¯å‚æ•°æ ¡éªŒæ—¶ä½¿ç”¨======================

    /**
     * å‚æ•°æ ¡éªŒå¼‚å¸¸ ï¼ˆJSON æ ¼å¼ï¼‰
     * å·²ç»ä½¿ç”¨äº† @ResponseStatus(HttpStatus.BAD_REQUEST) æ‰€ä»¥æ— éœ€è¿”å› HttpEntity
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public UnifyResponse handleMethodArgumentNotValidException(MethodArgumentNotValidException exception,
                                                               HttpServletRequest request,
                                                               HandlerMethod handlerMethod,
                                                               HttpMethod httpMethod) {

        // æ—¥ï¼è¿™è·å–åˆ°çš„ error è¿˜æ˜¯éšæœºé¡ºåº ...
        List<ObjectError> allErrors = exception.getBindingResult().getAllErrors();
        String message = formatAllErrorsMessage(allErrors);

        UnifyResponse unifyResponse = new UnifyResponse(10001, message, httpMethod + " " + request.getRequestURI());
        log.warn("ç³»ç»ŸæœªçŸ¥å¼‚å¸¸, æ–¹æ³•ä¸ºï¼š{}, å¼‚å¸¸ä¸ºï¼š{}", handlerMethod, exception);
        // ResponseEntity ç»§æ‰¿äº† HttpEntity
        return unifyResponse;
    }

    /**
     * å‚æ•°æ ¡éªŒå¼‚å¸¸ URL åŠæŸ¥è¯¢å‚æ•°ï¼ˆJSON æ ¼å¼ï¼‰
     * å·²ç»ä½¿ç”¨äº† @ResponseStatus(HttpStatus.BAD_REQUEST) æ‰€ä»¥æ— éœ€è¿”å› HttpEntity
     */
    @ExceptionHandler(ConstraintViolationException.class)
    @ResponseStatus(HttpStatus.BAD_REQUEST)
    public UnifyResponse handleConstraintViolationException(ConstraintViolationException exception,
                                                            HttpServletRequest request,
                                                            HandlerMethod handlerMethod,
                                                            HttpMethod httpMethod) {

        Set<ConstraintViolation<?>> constraintViolations = exception.getConstraintViolations();
        String message = formatAllErrorsMessage(constraintViolations);
        // String message = formatAllErrorsMessage(allErrors);

        UnifyResponse unifyResponse = new UnifyResponse(10001, message, httpMethod + " " + request.getRequestURI());
        log.warn("ç³»ç»ŸæœªçŸ¥å¼‚å¸¸, æ–¹æ³•ä¸ºï¼š{}, å¼‚å¸¸ä¸ºï¼š{}", handlerMethod, exception);
        // ResponseEntity ç»§æ‰¿äº† HttpEntity
        return unifyResponse;
    }


    /**
     * æ ¼å¼åŒ–å‚æ•°æ ¡éªŒé”™è¯¯ä¿¡æ¯
     */
    private String formatAllErrorsMessage(List<ObjectError> allErrors) {
        StringJoiner stringJoiner = new StringJoiner(";");
        allErrors.forEach(error -> stringJoiner.add(error.getDefaultMessage()));
        return stringJoiner.toString();
    }


    /**
     * æ ¼å¼åŒ–å‚æ•°æ ¡éªŒé”™è¯¯ä¿¡æ¯
     */
    private String formatAllErrorsMessage(Set<ConstraintViolation<?>> constraintViolations) {
        StringJoiner stringJoiner = new StringJoiner(";");
        constraintViolations.forEach(error -> {
            String format = String.format("['%s'æ— æ³•é€šè¿‡æ ¡éªŒ, %s]", error.getInvalidValue(), error.getMessage());
            stringJoiner.add(format.toString());
        });
        return stringJoiner.toString();
    }


    // TODO è¡¨å•æäº¤ org.springframework.validation.BindException: org.springframework.validation.BeanPropertyBindingResult: 1 errors

}
```





## æšä¸¾ & å…¨200çŠ¶æ€ç ä½¿ç”¨æ­¥éª¤

### 1 è‡ªå®šä¹‰å¼‚å¸¸ç±»â€”å¯é¢„çŸ¥å¼‚å¸¸

```java
@NoArgsConstructor
@AllArgsConstructor// ç”±æ„é€ æ–¹æ³•ä¼ å…¥
@Getter// æä¾›getæ–¹æ³•è·å–å…·ä½“ä¿¡æ¯
public class CustomException extends RuntimeException {

    private IStatusCode iStatusCode;

}
```


### 2 ä¸å¯é¢„çŸ¥å¼‚å¸¸

ä½¿ç”¨ Postman æµ‹è¯•æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š`org.springframework.http.converter.HttpMessageNotReadableException`ï¼Œæ­¤å¼‚å¸¸æ˜¯ SpringMVC åœ¨è¿›è¡Œå‚æ•°è½¬æ¢æ—¶æŠ¥çš„é”™è¯¯ã€‚

é’ˆå¯¹ä¸å¯é¢„çŸ¥å¼‚å¸¸é—®é¢˜å…¶è§£å†³æ–¹æ¡ˆæ˜¯ï¼š

1. æˆ‘ä»¬åœ¨mapä¸­é…ç½®HttpMessageNotReadableExceptionå’Œé”™è¯¯ä»£ç ã€‚
2. åœ¨å¼‚å¸¸æ•è·ç±»ä¸­å¯¹Exceptionå¼‚å¸¸è¿›è¡Œæ•è·ï¼Œå¹¶ä»mapä¸­è·å–å¼‚å¸¸ç±»å‹å¯¹åº”çš„é”™è¯¯ä»£ç ï¼Œå¦‚æœå­˜åœ¨é”™è¯¯ä»£ç åˆ™è¿”å›æ­¤é”™è¯¯ï¼Œå¦åˆ™ç»Ÿä¸€è¿”å›9999é”™è¯¯ã€‚



### 3 å…¨å±€å¼‚å¸¸æ•è·â€”å¤„ç†ï¼ˆä¸ï¼‰å¯é¢„çŸ¥å¼‚å¸¸

æ­¤å¤„ä»£ç ç†è§£å³å¯

```java
@ControllerAdvice//æ§åˆ¶å™¨å¢å¼º
public class ExceptionCatch {

    private static final Logger LOGGER = LoggerFactory.getLogger(ExceptionCatch.class);

    //ä½¿ç”¨EXCEPTIONSå­˜æ”¾å¼‚å¸¸ç±»å‹å’Œé”™è¯¯ä»£ç çš„æ˜ å°„ï¼ŒImmutableMapçš„ç‰¹ç‚¹çš„ä¸€æ—¦åˆ›å»ºä¸å¯æ”¹å˜ï¼Œå¹¶ä¸”çº¿ç¨‹å®‰å…¨
    private static ImmutableMap<Class<? extends Throwable>, ResultCode> EXCEPTIONS;
    //ä½¿ç”¨builderæ¥æ„å»ºä¸€ä¸ªå¼‚å¸¸ç±»å‹å’Œé”™è¯¯ä»£ç çš„å¼‚å¸¸
    protected static ImmutableMap.Builder<Class<? extends Throwable>, ResultCode> builder =
        ImmutableMap.builder();

    //åœ¨è¿™é‡ŒåŠ å…¥ä¸€äº›åŸºç¡€çš„å¼‚å¸¸ç±»å‹åˆ¤æ–­ã€‚è¿™é‡Œåªæ·»åŠ äº†ä¸€ä¸ªç¤ºä¾‹
    static {
        builder.put(HttpMessageNotReadableException.class, CommonCode.INVALID_PARAM);
    }

    @ExceptionHandler(CustomException.class)//æ•è· CustomExceptionå¼‚å¸¸
    @ResponseBody//è¿”å›JSONæ•°æ®
    public ResponseResult customException(CustomException e) {
        LOGGER.error("catch exception:\n" + e.getMessage(), e);//catchåˆ°å¼‚å¸¸è®°å½•æ—¥å¿—
        return new ResponseResult(e.getResultCode());
    }

    @ExceptionHandler(Exception.class)//æ•è· Exceptionå¼‚å¸¸
    @ResponseBody//è¿”å›JSONæ•°æ®
    public ResponseResult exception(Exception e) {
        LOGGER.error("catch exception:\n" + e.getMessage(), e);//catchåˆ°å¼‚å¸¸è®°å½•æ—¥å¿—
        if (EXCEPTIONS == null) {
            EXCEPTIONS = builder.build();
        }
        ResponseResult responseResult;
        ResultCode resultCode = EXCEPTIONS.get(e.getClass());
        if (resultCode != null) {
            responseResult = new ResponseResult(resultCode);
        } else {
            responseResult = new ResponseResult(CommonCode.SERVER_ERROR);//99999å¼‚å¸¸
        }
        return responseResult;
    }
}
```

è¿˜éœ€å†å¯åŠ¨ç±»ä¸Šæ³¨è§£è¦æ‰«æå¼‚å¸¸ç±»æ‰€åœ¨åŒ…

```java
@ComponentScan("top.conanan.framework")
```

æˆ–ä½¿ç”¨ @Componet æ³¨è§£æ³¨å†Œè¯¥Bean




### å¼‚å¸¸çš„æŠ›å‡ºåŠå¤„ç†æµç¨‹æ€»ç»“ ğŸ”¥

![](../images/1550681223850.png)

1. åœ¨**Controllerã€Serviceã€Daoä¸­ç¨‹åºå‘˜æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸**ï¼›**SpringMVC ç­‰æ¡†æ¶æŠ›å‡ºæ¡†æ¶å¼‚å¸¸ç±»å‹**ã€‚ç»Ÿä¸€ç”±**å¼‚å¸¸æ•è·ç±»æ•è·å¼‚å¸¸**ï¼Œå¹¶è¿›è¡Œå¤„ç†
2. æ•è·åˆ°**è‡ªå®šä¹‰å¼‚å¸¸åˆ™ç›´æ¥å–å‡ºé”™è¯¯ä»£ç åŠé”™è¯¯ä¿¡æ¯**
3. æ•è·åˆ°**éè‡ªå®šä¹‰å¼‚å¸¸ç±»å‹é¦–å…ˆä»Mapä¸­æ‰¾**è¯¥å¼‚å¸¸ç±»å‹æ˜¯å¦å¯¹åº”å…·ä½“çš„é”™è¯¯ä»£ç ï¼Œå¦‚æœæœ‰åˆ™å–å‡ºé”™è¯¯ä»£ç å’Œé”™è¯¯ä¿¡æ¯å¹¶å“åº”ç»™ç”¨æˆ·ï¼Œå¦‚æœä»Mapä¸­æ‰¾ä¸åˆ°å¼‚å¸¸ç±»å‹æ‰€å¯¹åº”çš„é”™è¯¯ä»£ç åˆ™ç»Ÿä¸€ä¸º99999é”™è¯¯ä»£ç 
4. å°†**é”™è¯¯ä»£ç åŠé”™è¯¯ä¿¡æ¯ä»¥JSONæ ¼å¼å“åº”ç»™ç”¨æˆ·**



## ResponseBodyAdvice å¯¹å…¨ 200 çŠ¶æ€ç å¢å¼º ğŸ”¥

å‚è€ƒæŒºå“¥çš„[è¯­é›€](https://www.yuque.com/bravo1988/java/iodh7z)

### ResponseBodyAdvice ç®€ä»‹

* Springæä¾›çš„ä¸€ä¸ªæ¥å£ï¼Œå’ŒAOPä¸€æ ·çš„ï¼ŒXxxAdviceéƒ½æ˜¯ç”¨æ¥å¢å¼ºçš„
* é…åˆ@RestControllerAdviceæ³¨è§£ï¼Œå¯ä»¥â€œæ‹¦æˆªâ€è¿”å›å€¼
* é€šè¿‡supports()æ–¹æ³•åˆ¤æ–­æ˜¯å¦éœ€è¦â€œæ‹¦æˆªâ€

```java
@RestControllerAdvice
public class CommonResponseDataAdvice implements ResponseBodyAdvice<Object> {


    @Override
    public boolean supports(MethodParameter methodParameter, Class<? extends HttpMessageConverter<?>> aClass) {
        // å¯¹æ‰€æœ‰è¿”å›å€¼èµ·ä½œç”¨
        return true;
    }

    @Override
    public Object beforeBodyWrite(Object o,
                                  MethodParameter methodParameter,
                                  MediaType mediaType,
                                  Class<? extends HttpMessageConverter<?>> aClass,
                                  ServerHttpRequest serverHttpRequest,
                                  ServerHttpResponse serverHttpResponse) {
		// æ”¹ä¸€è¡Œä»£ç å³å¯ï¼šæŠŠObjectè¿”å›å€¼ç”¨Resultå°è£…
        return Result.success(o);
    }
}
```


### å®šä¹‰@CosmoController

```java
@RestController
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE})
public @interface CosmoController {
}
```



### ResponseBodyAdviceç»Ÿä¸€ç»“æœå°è£…

ç›®æ ‡æ˜¯ï¼š

* å¦‚æœä½¿ç”¨äº†@CosmoControllerï¼Œå°±åœ¨CommonResponseDataAdviceä¸­ä½¿ç”¨Resultå°è£…ç»“æœ
* å¦‚æœä½¿ç”¨äº†åŸç”Ÿçš„@RestControllerï¼Œå°±åŸæ ·è¿”å›ï¼Œä¸åšä»»ä½•å¤„ç†

ä¸”éœ€è¦è€ƒè™‘åˆ°ï¼š

* å¦‚æœControllerè¿”å›å€¼å·²ç»ç”¨Resultå°è£…è¿‡äº†å‘¢ï¼Œæ­¤æ—¶ä¼šé€ æˆé‡å¤åµŒå¥—ï¼
* æ ‡æ³¨äº†@CosmoControlleråï¼Œå†…éƒ¨ä¸ªåˆ«æ–¹æ³•ä¸å¸Œæœ›ç”¨Resultå°è£…è¯¥æ€ä¹ˆåšï¼Ÿå¯ä»¥å•ç‹¬å†å®šä¸€ä¸ªæ³¨è§£

  ```java
  @Retention(RetentionPolicy.RUNTIME)
  @Target({ElementType.TYPE, ElementType.METHOD})
  public @interface IgnoreCosmoResult {
  }
  ```
* è¯¸å¦‚å‚æ•°æ ¡éªŒå¤±è´¥ç­‰æƒ…å†µæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ

æœ€ç»ˆä»£ç å¦‚ä¸‹ï¼š

```java
@RestControllerAdvice
public class CommonResponseDataAdvice implements ResponseBodyAdvice<Object> {


    @Override
    public boolean supports(MethodParameter methodParameter, Class<? extends HttpMessageConverter<?>> aClass) {
        // æ ‡æ³¨äº†@CosmoControllerï¼Œä¸”ç±»åŠæ–¹æ³•ä¸Šéƒ½æ²¡æœ‰æ ‡æ³¨@IgnoreCosmoResultçš„æ–¹æ³•æ‰è¿›è¡ŒåŒ…è£…
        return methodParameter.getDeclaringClass().isAnnotationPresent(CosmoController.class)
                && !methodParameter.getDeclaringClass().isAnnotationPresent(IgnoreCosmoResult.class)
                && !methodParameter.getMethod().isAnnotationPresent(IgnoreCosmoResult.class);
    }

    @Override
    public Object beforeBodyWrite(Object o,
                                  MethodParameter methodParameter,
                                  MediaType mediaType,
                                  Class<? extends HttpMessageConverter<?>> aClass,
                                  ServerHttpRequest serverHttpRequest,
                                  ServerHttpResponse serverHttpResponse) {
		// å·²ç»åŒ…è£…è¿‡çš„ï¼Œä¸å†é‡å¤åŒ…è£…
        if (o instanceof Result) {
            return o;
        }

        return Result.success(o);
    }
}
```





## SSMâ€”éå‰ååˆ†ç¦»ç‰ˆ

- SpringMVCåœ¨å¤„ç†è¯·æ±‚è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ä¿¡æ¯äº¤ç”±å¼‚å¸¸å¤„ç†å™¨è¿›è¡Œå¤„ç†ï¼Œè‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨å¯ä»¥å®ç°ä¸€ä¸ªç³»ç»Ÿçš„å¼‚å¸¸å¤„ç†é€»è¾‘
- æ€è·¯ï¼š

  - ç³»ç»Ÿä¸­å¼‚å¸¸åŒ…æ‹¬ä¸¤ç±»ï¼š**é¢„æœŸå¼‚å¸¸**å’Œè¿è¡Œæ—¶å¼‚å¸¸**RuntimeException**ï¼Œå‰è€…é€šè¿‡æ•è·å¼‚å¸¸ä»è€Œè·å–å¼‚å¸¸ä¿¡æ¯ï¼Œåè€…ä¸»è¦é€šè¿‡è§„èŒƒä»£ç å¼€å‘ã€æµ‹è¯•é€šè¿‡æ‰‹æ®µå‡å°‘è¿è¡Œæ—¶å¼‚å¸¸çš„å‘ç”Ÿ
  - ç³»ç»Ÿçš„daoã€serviceã€controllerå‡ºç°éƒ½é€šè¿‡throws Exceptionå‘ä¸ŠæŠ›å‡ºï¼Œæœ€åç”±SpringMVC**å‰ç«¯æ§åˆ¶å™¨äº¤ç”±å¼‚å¸¸å¤„ç†å™¨**è¿›è¡Œå¼‚å¸¸å¤„ç†
- **è‡ªå®šä¹‰å¼‚å¸¸ç±»(ç»§æ‰¿Exceptionæˆ–RuntimeException)**ï¼šä¸ºäº†åŒºåˆ«ä¸åŒçš„å¼‚å¸¸,é€šå¸¸æ ¹æ®å¼‚å¸¸ç±»å‹è¿›è¡ŒåŒºåˆ†

  ```java
  public class MyException{
      public MyException(){};
      public MyException(String msg){
          super(msg);
      };
  }
  ```
- **è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨(å®ç°HandlerExceptionResolver)**ï¼Œå¹¶**åœ¨`spring-config.xml`ä¸­é…ç½®æˆ–ä½¿ç”¨`@Component`**

  ```java
  @Component
  public class CustomExceptionResolver implements HandlerExceptionResolver {
     	//handler:å¼‚å¸¸å¤„ç†å™¨å¯¹è±¡ã€‚å‘ç”Ÿå¼‚å¸¸çš„åœ°æ–¹ï¼ŒåŒ…å+ç±»å+æ–¹æ³•å(å½¢å‚)çš„å­—ç¬¦ä¸²ï¼Œç”¨äºæ—¥å¿—
      @Override
      public ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, Object handler,Exception exception) {

          ModelAndView modelAndView = new ModelAndView();
          // å®šä¹‰å¼‚å¸¸ä¿¡æ¯
          String msg = "";

          // åˆ¤æ–­å¼‚å¸¸ç±»å‹
          if (exception instanceof MyException) {
              // å¦‚æœæ˜¯è‡ªå®šä¹‰å¼‚å¸¸ï¼Œè¯»å–å¼‚å¸¸ä¿¡æ¯
              msg = exception.getMessage();
          } else {
              //ç®€å†™
              msg = "æœåŠ¡å™¨è®¿é—®é‡è¿‡å¤§ï¼Œè¯·æ‚¨ç¨å..."
              //æˆ– å¦‚æœæ˜¯è¿è¡Œæ—¶å¼‚å¸¸ï¼Œåˆ™å–é”™è¯¯å †æ ˆï¼Œä»å †æ ˆä¸­è·å–å¼‚å¸¸ä¿¡æ¯
              //Writer out = new StringWriter();
              //PrintWriter s = new PrintWriter(out);
              //exception.printStackTrace(s);
              //msg = out.toString();

          }
          // æŠŠé”™è¯¯ä¿¡æ¯å‘ç»™ç›¸å…³äººå‘˜,é‚®ä»¶,çŸ­ä¿¡ç­‰æ–¹å¼
          // è¿”å›é”™è¯¯é¡µé¢ï¼Œç»™ç”¨æˆ·å‹å¥½é¡µé¢æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

          modelAndView.addObject("msg", msg);
          modelAndView.setViewName("error");

          return modelAndView;
      }
  }
  ```