(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{592:function(s,a,v){s.exports=v.p+"assets/img/image-20210325222944032.d00a78f0.png"},593:function(s,a,v){s.exports=v.p+"assets/img/image-20210325224248706.a8face4c.png"},594:function(s,a,v){s.exports=v.p+"assets/img/image-20210325230250557.0dbb8a91.png"},595:function(s,a,v){s.exports=v.p+"assets/img/image-20210325231720445.3b7f242a.png"},596:function(s,a,v){s.exports=v.p+"assets/img/image-20210325233839851.173111d5.png"},597:function(s,a,v){s.exports=v.p+"assets/img/image-20210325234659502.6c06f0ad.png"},598:function(s,a,v){s.exports=v.p+"assets/img/image-20210325235745239.0e816e7f.png"},758:function(s,a,v){"use strict";v.r(a);var e=v(11),t=Object(e.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"主从复制-高可用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主从复制-高可用"}},[s._v("#")]),s._v(" 主从复制—高可用")]),s._v(" "),e("h2",{attrs:{id:"问题-解决方案"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题-解决方案"}},[s._v("#")]),s._v(" 问题 & 解决方案")]),s._v(" "),e("h3",{attrs:{id:"单机-redis-的风险与问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#单机-redis-的风险与问题"}},[s._v("#")]),s._v(" 单机 Redis 的风险与问题")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("机器故障")]),s._v(" "),e("ul",[e("li",[s._v("现象：硬盘故障、系统崩溃")]),s._v(" "),e("li",[s._v("本质：数据丢失，很可能对业务造成灾难性打击")])])]),s._v(" "),e("li",[e("p",[s._v("容量瓶颈")]),s._v(" "),e("ul",[e("li",[s._v("现象：内存不足，从 16G 升级到 64G，从 64G 升级到 128G，无限升级内存")]),s._v(" "),e("li",[s._v("本质：穷，硬件条件跟不上")])])]),s._v(" "),e("li",[e("p",[s._v("结论")]),s._v(" "),e("p",[s._v("为了避免单点 Redis 服务器故障，准备多台服务器，互相连通。将数据"),e("strong",[s._v("复制多个副本保存在不同的服务器上")]),s._v("，"),e("strong",[s._v("连接在一起")]),s._v("，并保证数据是"),e("strong",[s._v("同步")]),s._v("的。即使有其中一台服务器宕机，其他服务器依然可以继续 提供服务，实现 Redis 的高可用，同时实现数据"),e("strong",[s._v("冗余备份")]),s._v("。")])])]),s._v(" "),e("h3",{attrs:{id:"多台服务器连接方案"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#多台服务器连接方案"}},[s._v("#")]),s._v(" 多台服务器连接方案")]),s._v(" "),e("ul",[e("li",[s._v("master：提供数据方，主服务器，主节点，主库，主客户端")]),s._v(" "),e("li",[s._v("slave：接收数据方，从服务器，从节点，从库，从客户端")]),s._v(" "),e("li",[s._v("需要解决的问题：数据同步")]),s._v(" "),e("li",[s._v("核心工作："),e("strong",[s._v("master 的数据复制到 slave 中")])])]),s._v(" "),e("h2",{attrs:{id:"主从复制"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主从复制"}},[s._v("#")]),s._v(" 主从复制")]),s._v(" "),e("h3",{attrs:{id:"简介"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[s._v("#")]),s._v(" 简介")]),s._v(" "),e("p",[s._v("主从复制即"),e("strong",[s._v("将 master 中的数据即时、有效的复制到 slave 中")])]),s._v(" "),e("p",[s._v("一个 master 可以拥有多个 slave，一个 slave 只对应一个 master。一对多。")]),s._v(" "),e("p",[s._v("master 职责：")]),s._v(" "),e("ul",[e("li",[e("strong",[s._v("写数据")])]),s._v(" "),e("li",[s._v("执行"),e("strong",[s._v("写操作时")]),s._v("，将"),e("strong",[s._v("出现变化的数据自动同步到 slave")])]),s._v(" "),e("li",[s._v("读数据（可忽略）")])]),s._v(" "),e("p",[s._v("slave 职责：")]),s._v(" "),e("ul",[e("li",[e("strong",[s._v("读数据")])]),s._v(" "),e("li",[s._v("写数据（禁止）")])]),s._v(" "),e("h3",{attrs:{id:"作用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#作用"}},[s._v("#")]),s._v(" 作用")]),s._v(" "),e("ul",[e("li",[e("strong",[s._v("读写分离")]),s._v("：master 写、slave 读，提高服务器的读写负载能力")]),s._v(" "),e("li",[e("strong",[s._v("负载均衡")]),s._v("：基于主从结构，配合读写分离，由 slave 分担 master 负载，并根据需求的变化，改变 slave 的数量，通过多个从节点分担数据读取负载，大大提高 Redis 服务器并发量与数据吞吐量")]),s._v(" "),e("li",[e("strong",[s._v("故障恢复")]),s._v("：当 master 出现问题时，由 slave 提供服务，实现快速的故障恢复")]),s._v(" "),e("li",[e("strong",[s._v("数据冗余")]),s._v("：实现"),e("strong",[s._v("数据热备份")]),s._v("，是持久化之外的一种数据冗余方式")]),s._v(" "),e("li",[e("strong",[s._v("高可用基石")]),s._v("：基于主从复制，构建哨兵模式与集群，实现 Redis 的高可用方案")])]),s._v(" "),e("h3",{attrs:{id:"流程总述-🔥"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#流程总述-🔥"}},[s._v("#")]),s._v(" 流程总述 🔥")]),s._v(" "),e("p",[s._v("主从复制过程大体可以分为 3 个阶段：")]),s._v(" "),e("ul",[e("li",[s._v("建立连接阶段（即准备阶段）："),e("strong",[s._v("slave 连接 master")])]),s._v(" "),e("li",[s._v("数据同步阶段：同步")]),s._v(" "),e("li",[s._v("命令传播阶段：反复同步")])]),s._v(" "),e("img",{staticStyle:{},attrs:{src:v(592),alt:"image-20210325222944032"}}),s._v(" "),e("h2",{attrs:{id:"主从复制流程-建立连接"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主从复制流程-建立连接"}},[s._v("#")]),s._v(" 主从复制流程—建立连接")]),s._v(" "),e("h3",{attrs:{id:"流程介绍"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#流程介绍"}},[s._v("#")]),s._v(" 流程介绍")]),s._v(" "),e("p",[e("strong",[s._v("建立 slave 到 master 的连接")]),s._v("，使 master 能够识别 slave，并"),e("strong",[s._v("保存 slave 的端口号")])]),s._v(" "),e("img",{staticStyle:{},attrs:{src:v(593),alt:"image-20210325224248706"}}),s._v(" "),e("ol",[e("li",[e("strong",[s._v("设置 master 的地址和端口，并保存 master 的各种信息")])]),s._v(" "),e("li",[e("strong",[s._v("建立 socket 连接")])]),s._v(" "),e("li",[s._v("发送 ping 命令(定时器任务)")]),s._v(" "),e("li",[s._v("身份验证（由于 Redis 一般不对外开放，所以可以不设置外网访问以及身份认证）")]),s._v(" "),e("li",[e("strong",[s._v("master 保存 slave 的端口号")])])]),s._v(" "),e("h3",{attrs:{id:"实践"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实践"}},[s._v("#")]),s._v(" 实践")]),s._v(" "),e("p",[s._v("可以使用如下配置，关掉日志，并前台运行，方便查看")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('daemonize no\n#logfile "6379.log"\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[e("strong",[s._v("slave 连接 master")]),s._v("（如下操作都是在 slave 客户端或服务器进行）：")]),s._v(" "),e("p",[s._v("方式 1：客户端发送命令")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("slaveof <masterip> <masterport>\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("方式 2：启动服务器参数")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("redis-server -slaveof <masterip> <masterport>\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("方式 3："),e("strong",[s._v("服务器配置")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("slaveof <masterip> <masterport>\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("最后可以通过"),e("code",[s._v("info")]),s._v("指令查看信息")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# slave\n\nmaster_link_down_since_seconds\nmasterhost\nmasterport\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("# master\n\nslave_listening_port(多个)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("主动断开连接（客户端发送命令）：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("slaveof no one\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("注意：slave 断开连接后，"),e("strong",[s._v("不会删除已有数据")]),s._v("，只是"),e("strong",[s._v("不再接受 master 发送的数据")])]),s._v(" "),e("h3",{attrs:{id:"授权访问"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#授权访问"}},[s._v("#")]),s._v(" 授权访问")]),s._v(" "),e("p",[s._v("服务端：")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("master 客户端发送命令设置密码")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("requirepass <password>\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[e("strong",[s._v("master 配置文件设置密码")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("config set requirepass <password>\nconfig get requirepass\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])])])]),s._v(" "),e("p",[s._v("客户端：")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("slave 客户端发送命令设置密码")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("auth <password>\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("slave 启动服务器设置密码")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("redis-server –a <password>\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[e("strong",[s._v("slave 配置文件设置密码")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("masterauth <password>\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])])]),s._v(" "),e("h2",{attrs:{id:"主从复制流程-数据同步"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主从复制流程-数据同步"}},[s._v("#")]),s._v(" 主从复制流程—数据同步")]),s._v(" "),e("h3",{attrs:{id:"流程介绍-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#流程介绍-2"}},[s._v("#")]),s._v(" 流程介绍")]),s._v(" "),e("p",[s._v("在 slave 初次连接 master 后，复制 master 中的所有数据到 slave。并将 slave 的数据库状态更新成 master 当前的数据库状态。")]),s._v(" "),e("img",{staticStyle:{},attrs:{src:v(594),alt:"image-20210325230250557"}}),s._v(" "),e("ol",[e("li",[s._v("请求同步数据")]),s._v(" "),e("li",[s._v("创建 RDB 同步数据")]),s._v(" "),e("li",[s._v("恢复 RDB 同步数据")]),s._v(" "),e("li",[s._v("请求部分同步数据")]),s._v(" "),e("li",[s._v("恢复部分同步数据。至此，数据同步工作完成!")])]),s._v(" "),e("p",[s._v("此时状态：")]),s._v(" "),e("ul",[e("li",[s._v("slave：具有 master 端全部数据，包含 RDB 过程接收的数据")]),s._v(" "),e("li",[s._v("master："),e("strong",[s._v("保存 slave 当前数据同步的位置")])])]),s._v(" "),e("h3",{attrs:{id:"数据同步阶段-master-说明"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#数据同步阶段-master-说明"}},[s._v("#")]),s._v(" 数据同步阶段 master 说明")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("如果 master 数据量巨大，数据同步阶段应"),e("strong",[s._v("避开流量高峰期")]),s._v("，避免造成 master 阻塞，影响业务正常执行。如新增 slave 节点")])]),s._v(" "),e("li",[e("p",[s._v("复制缓冲区大小设定不合理，会导致数据溢出。如进行全量复制周期太长，进行部分复制时发现数据已经存在丢失的情况，必须进行第二次全量复制，致使 slave 陷入死循环状态。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("repl-backlog-size 1mb\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("master 单机内存占用主机内存的比例不应过大，建议使用 50%-70%的内存，留下 30%-50%的内存用于执 行 bgsave 命令和创建复制缓冲区")]),s._v(" "),e("img",{staticStyle:{},attrs:{src:v(595),alt:"image-20210325231720445"}})])]),s._v(" "),e("h3",{attrs:{id:"数据同步阶段-slave-说明"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#数据同步阶段-slave-说明"}},[s._v("#")]),s._v(" 数据同步阶段 slave 说明")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("为避免 slave 进行全量复制、部分复制时服务器响应阻塞或数据不同步，建议关闭此期间的对外服务")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("slave-serve-stale-data yes|no\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("数据同步阶段，master 发送给 slave 信息可以理解 master 是 slave 的一个客户端，主动向 slave 发送命令")])]),s._v(" "),e("li",[e("p",[s._v("多个 slave 同时对 master 请求数据同步，master 发送的 RDB 文件增多，会对带宽造成巨大冲击，如果 master 带宽不足，因此数据同步需要根据业务需求，适量错峰")])]),s._v(" "),e("li",[e("p",[s._v("slave 过多时，建议调整拓扑结构，由一主多从结构变为树状结构，中间的节点既是 master，也是 slave。注意使用树状结构时，由于层级深度，导致深度越高的 slave 与最顶层 master 间数据同步延迟 较大，数据一致性变差，应谨慎选择")])])]),s._v(" "),e("h2",{attrs:{id:"主从复制流程-命令传播阶段"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主从复制流程-命令传播阶段"}},[s._v("#")]),s._v(" 主从复制流程—命令传播阶段")]),s._v(" "),e("h3",{attrs:{id:"简介-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#简介-2"}},[s._v("#")]),s._v(" 简介")]),s._v(" "),e("ul",[e("li",[s._v("当 master 数据库状态被修改后，导致主从服务器数据库状态不一致，此时需要让主从数据同步到一致的状态，同步的动作称为命令传播")]),s._v(" "),e("li",[s._v("master 将接收到的数据变更命令发送给 slave，slave 接收命令后执行命令")])]),s._v(" "),e("h3",{attrs:{id:"命令传播阶段的部分复制"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#命令传播阶段的部分复制"}},[s._v("#")]),s._v(" 命令传播阶段的部分复制")]),s._v(" "),e("p",[s._v("命令传播阶段出现了断网现象：")]),s._v(" "),e("ul",[e("li",[s._v("网络闪断闪连 忽略")]),s._v(" "),e("li",[e("strong",[s._v("短时间")]),s._v("网络中断 "),e("strong",[s._v("部分复制")])]),s._v(" "),e("li",[e("strong",[s._v("长时间")]),s._v("网络中断 "),e("strong",[s._v("全量复制")])])]),s._v(" "),e("p",[s._v("部分复制的三个核心要素：")]),s._v(" "),e("ul",[e("li",[s._v("服务器的运行 id（"),e("strong",[s._v("run id")]),s._v("）")]),s._v(" "),e("li",[s._v("主服务器的"),e("strong",[s._v("复制积压缓冲区")])]),s._v(" "),e("li",[s._v("主从服务器的"),e("strong",[s._v("复制偏移量")])])]),s._v(" "),e("h3",{attrs:{id:"服务器运行-id-runid"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#服务器运行-id-runid"}},[s._v("#")]),s._v(" 服务器运行 ID—runid")]),s._v(" "),e("ul",[e("li",[s._v("概念：服务器运行 ID 是每一台服务器每次运行的身份识别码，一台服务器多次运行可以生成多个运行 id")]),s._v(" "),e("li",[s._v("组成：运行 id 由"),e("strong",[s._v("40 位字符")]),s._v("组成，是一个"),e("strong",[s._v("随机的十六进制字符")]),s._v("。如：fdc9ff13b9bbaab28db42b3d50f852bb5e3fcdce")]),s._v(" "),e("li",[s._v("作用：运行 id 被用于在服务器间进行传输，"),e("strong",[s._v("识别身份")]),s._v("。如果想两次操作均对同一台服务器进行，必须每次操作携带对应的运行 id，用于对方识别")]),s._v(" "),e("li",[s._v("实现方式：运行 id 在每台"),e("strong",[s._v("服务器启动时自动生成")]),s._v("的，"),e("strong",[s._v("master")]),s._v("在"),e("strong",[s._v("首次连接 slave")]),s._v("时，会将自己的运行 ID"),e("strong",[s._v("发送")]),s._v("给 slave，"),e("strong",[s._v("slave 保存此 ID")]),s._v("，通过 info Server 命令，可以查看节点的 runid")])]),s._v(" "),e("h3",{attrs:{id:"复制缓冲区"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#复制缓冲区"}},[s._v("#")]),s._v(" 复制缓冲区")]),s._v(" "),e("p",[s._v("介绍：")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("复制缓冲区，又名复制积压缓冲区，是一个先进先出("),e("strong",[s._v("FIFO")]),s._v(")的队列，用于存储服务器执行过的命令，每次传播命令，master 都会将传播的命令记录下来，并存储在复制缓冲区。"),e("strong",[s._v("对应 slave 有多少则该缓冲区有多少个")]),s._v("！")]),s._v(" "),e("p",[s._v("复制缓冲区默认数据存储空间大小是"),e("strong",[s._v("1M")]),s._v("，由于存储空间大小是固定的，当入队元素的数量大于队列长度时，最先入队的元素会"),e("strong",[s._v("被弹出")]),s._v("，而新元素会被放入队列")])]),s._v(" "),e("li",[e("p",[s._v("由来：每台服务器启动时，如果开启有 AOF 或被连接成为 master 节点，即创建复制缓冲区")])]),s._v(" "),e("li",[e("p",[s._v("作用：用于保存 master 收到的所有指令(仅影响数据变更的指令，例如 set，select)")])]),s._v(" "),e("li",[e("p",[s._v("数据来源：当 master 接收到主客户端的指令时，除了将指令执行，会将该指令存储到缓冲区中")])])]),s._v(" "),e("p",[e("img",{attrs:{src:v(596),alt:"image-20210325233839851"}})]),s._v(" "),e("h3",{attrs:{id:"主从服务器复制偏移量-offset"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主从服务器复制偏移量-offset"}},[s._v("#")]),s._v(" 主从服务器复制偏移量—offset")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("概念：一个数字，描述复制缓冲区中的指令字节位置")])]),s._v(" "),e("li",[e("p",[s._v("分类：")]),s._v(" "),e("ul",[e("li",[s._v("master 复制偏移量：记录发送给所有 slave 的指令字节对应的位置（多个）")]),s._v(" "),e("li",[s._v("slave 复制偏移量：记录 slave 接收 master 发送过来的指令字节对应的位置（一个）")])])]),s._v(" "),e("li",[e("p",[s._v("数据来源")]),s._v(" "),e("ul",[e("li",[s._v("master 端：发送一次记录一次")]),s._v(" "),e("li",[s._v("slave 端：接收一次记录一次")])])]),s._v(" "),e("li",[e("p",[s._v("作用：同步信息，比对 master 与 slave 的差异，当 slave 断线后，恢复数据使用")])])]),s._v(" "),e("h2",{attrs:{id:"数据同步-命令传播阶段工作流程-🔥"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#数据同步-命令传播阶段工作流程-🔥"}},[s._v("#")]),s._v(" 数据同步+命令传播阶段工作流程 🔥")]),s._v(" "),e("p",[e("img",{attrs:{src:v(597),alt:"image-20210325234659502"}})]),s._v(" "),e("h2",{attrs:{id:"心跳机制-🔥"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#心跳机制-🔥"}},[s._v("#")]),s._v(" 心跳机制 🔥")]),s._v(" "),e("h3",{attrs:{id:"简介-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#简介-3"}},[s._v("#")]),s._v(" 简介")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("进入命令传播阶段候，master 与 slave 间需要进行信息交换，使用心跳机制进行维护，实现双方连接保持在线")])]),s._v(" "),e("li",[e("p",[s._v("master 心跳：")]),s._v(" "),e("ul",[e("li",[s._v("指令：PING")]),s._v(" "),e("li",[s._v("周期：由"),e("code",[s._v("repl-ping-slave-period")]),s._v("决定，默认 10 秒")]),s._v(" "),e("li",[s._v("作用：判断 slave 是否在线")]),s._v(" "),e("li",[s._v("查询：INFO replication 获取 slave 最后一次"),e("strong",[s._v("连接时间间隔")]),s._v("，lag 项维持在 0 或 1 视为正常")])])]),s._v(" "),e("li",[e("p",[s._v("slave 心跳任务：")]),s._v(" "),e("ul",[e("li",[s._v("指令："),e("code",[s._v("REPLCONF ACK {offset}")])]),s._v(" "),e("li",[s._v("周期：1 秒")]),s._v(" "),e("li",[s._v("作用 1：汇报 slave 自己的复制偏移量，获取最新的数据变更指令")]),s._v(" "),e("li",[s._v("作用 2：判断 master 是否在线")])])])]),s._v(" "),e("h3",{attrs:{id:"注意"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#注意"}},[s._v("#")]),s._v(" 注意")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("当 slave 多数掉线，或延迟过高时，master 为保障数据稳定性，将拒绝所有信息同步操作")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("min-slaves-to-write 2\nmin-slaves-max-lag 10\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[e("strong",[s._v("slave 数量少于 2 个")]),s._v("，或者"),e("strong",[s._v("所有 slave 的延迟都大于等于 10 秒")]),s._v("时，强制关闭 master 写功能，停止数据同步（写没意义）")])]),s._v(" "),e("li",[e("p",[s._v("slave 数量由 slave 发送 REPLCONF ACK 命令做确认")])]),s._v(" "),e("li",[e("p",[s._v("slave 延迟由 slave 发送 REPLCONF ACK 命令做确认")])])]),s._v(" "),e("h2",{attrs:{id:"主从复制工作流程（完整）🔥"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主从复制工作流程（完整）🔥"}},[s._v("#")]),s._v(" 主从复制工作流程（完整）🔥")]),s._v(" "),e("p",[s._v("建立连接+数据同步见上面的")]),s._v(" "),e("p",[e("img",{attrs:{src:v(598),alt:"image-20210325235745239"}})]),s._v(" "),e("p",[s._v("注意，① 发送的命令在数据同步和命令传播阶段不同")]),s._v(" "),e("h2",{attrs:{id:"常见问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#常见问题"}},[s._v("#")]),s._v(" 常见问题")]),s._v(" "),e("h3",{attrs:{id:"频繁的全量复制1"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#频繁的全量复制1"}},[s._v("#")]),s._v(" 频繁的全量复制1")]),s._v(" "),e("p",[s._v("伴随着系统的运行，master的数据量会越来越大，一旦"),e("strong",[s._v("master重启，runid将发生变化")]),s._v("，会"),e("strong",[s._v("导致全部slave的全量复制")]),s._v("操作")]),s._v(" "),e("p",[s._v("内部优化调整方案：")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("master内部创建"),e("code",[s._v("master_replid")]),s._v("变量，使用runid相同的策略生成，长度41位，并发送给所有slave")])]),s._v(" "),e("li",[e("p",[s._v("在master关闭时执行命令 shutdown save，进行RDB持久化，"),e("strong",[s._v("将runid与offset保存到RDB文件中")])]),s._v(" "),e("ul",[e("li",[s._v("repl-id repl-offset")]),s._v(" "),e("li",[s._v("通过redis-check-rdb dump.rdb命令可以查看该信息")])])]),s._v(" "),e("li",[e("p",[s._v("master重启后加载RDB文件，恢复数据。重启后，将RDB文件中保存的repl-id与repl-offset加载到内存中")]),s._v(" "),e("ul",[e("li",[s._v("master_repl_id = repl master_repl_offset = repl-offset")]),s._v(" "),e("li",[s._v("通过info命令可以查看该信息")])])])]),s._v(" "),e("p",[s._v("作用："),e("strong",[s._v("本机保存上次runid")]),s._v("，重启后恢复该值，使所有slave认为还是之前的master")]),s._v(" "),e("h3",{attrs:{id:"频繁的全量复制2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#频繁的全量复制2"}},[s._v("#")]),s._v(" 频繁的全量复制2")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("问题现象\n网络环境不佳，出现网络中断，slave不提供服务")])]),s._v(" "),e("li",[e("p",[s._v("问题原因")]),s._v(" "),e("p",[s._v("复制缓冲区过小，断网后slave的offset越界，触发全量复制")])]),s._v(" "),e("li",[e("p",[s._v("最终结果")]),s._v(" "),e("p",[s._v("slave反复进行全量复制")])]),s._v(" "),e("li",[e("p",[s._v("解决方案\n修改复制缓冲区大小")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("repl-backlog-size\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("建议设置如下")]),s._v(" "),e("ul",[e("li",[s._v("测算从master到slave的重连平均时长second")]),s._v(" "),e("li",[s._v("获取master平均每秒产生写命令数据总量write_size_per_second")]),s._v(" "),e("li",[s._v("最优复制缓冲区空间 = 2 * second * write_size_per_second")])])])]),s._v(" "),e("h3",{attrs:{id:"频繁的网络中断1"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#频繁的网络中断1"}},[s._v("#")]),s._v(" 频繁的网络中断1")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("问题现象\nmaster的CPU占用过高 或 slave频繁断开连接")])]),s._v(" "),e("li",[e("p",[s._v("问题原因")]),s._v(" "),e("ul",[e("li",[s._v("slave每1秒发送REPLCONF ACK命令到master")]),s._v(" "),e("li",[s._v("当slave接到了慢查询时(keys * ，hgetall等)，会大量占用CPU性能")]),s._v(" "),e("li",[s._v("master每1秒调用复制定时函数replicationCron()，比对slave发现长时间没有进行响应")])])]),s._v(" "),e("li",[e("p",[s._v("最终结果\nmaster各种资源(输出缓冲区、带宽、连接等)被严重占用")])]),s._v(" "),e("li",[e("p",[s._v("解决方案\n通过设置合理的超时时间，确认是否释放slave")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("repl-timeout\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("该参数定义了超时时间的阈值(默认60秒)，超过该值，释放slave")])])]),s._v(" "),e("h3",{attrs:{id:"频繁的网络中断2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#频繁的网络中断2"}},[s._v("#")]),s._v(" 频繁的网络中断2")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("问题现象")]),s._v(" "),e("p",[s._v("slave与master连接断开")])]),s._v(" "),e("li",[e("p",[s._v("问题原因")]),s._v(" "),e("ul",[e("li",[s._v("master发送ping指令频度较低")]),s._v(" "),e("li",[s._v("master设定超时时间较短")]),s._v(" "),e("li",[s._v("ping指令在网络中存在丢包")])])]),s._v(" "),e("li",[e("p",[s._v("解决方案")]),s._v(" "),e("p",[s._v("提高ping指令发送的频度")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("repl-ping-slave-period\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("strong",[s._v("超时时间repl-time的时间至少是ping指令频度的5到10倍，否则slave很容易判定超时")])])])]),s._v(" "),e("h3",{attrs:{id:"数据不一致"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#数据不一致"}},[s._v("#")]),s._v(" 数据不一致")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("问题现象")]),s._v(" "),e("p",[s._v("多个slave获取相同数据不同步")])]),s._v(" "),e("li",[e("p",[s._v("问题原因")]),s._v(" "),e("p",[s._v("网络信息不同步，数据发送有延迟")])]),s._v(" "),e("li",[e("p",[s._v("解决方案")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("优化主从间的网络环境，通常放置在同一个机房部署，如使用阿里云等云服务器时要注意此现象")])]),s._v(" "),e("li",[e("p",[s._v("监控主从节点延迟(通过offset)判断，如果slave延迟过大，暂时屏蔽程序对该slave的数据访问")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("slave-serve-stale-data yes|no\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("开启后仅响应info、slaveof等少数命令(慎用，除非对数据一致性要求很高)")])])])])])])}),[],!1,null,null,null);a.default=t.exports}}]);